import{_ as t}from"./plugin-vue_export-helper.21dcd24c.js";import{o,c as p,a as n,b as e,d as s,e as i,r as l}from"./app.3b603edd.js";var c="/book/assets/202205120932971.c1ba65b9.png",u="/book/assets/202205120959782.d8f17540.png";const r={},d=n("h1",{id:"kotlin-kcp\u7684\u5E94\u7528-\u7B2C\u4E8C\u7BC7",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#kotlin-kcp\u7684\u5E94\u7528-\u7B2C\u4E8C\u7BC7","aria-hidden":"true"},"#"),s(" Kotlin-KCP\u7684\u5E94\u7528-\u7B2C\u4E8C\u7BC7")],-1),k=n("h2",{id:"\u524D\u8A00",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u524D\u8A00","aria-hidden":"true"},"#"),s(" \u524D\u8A00")],-1),v=s("\u63A5"),m={href:"https://juejin.cn/post/7095248182912745502",target:"_blank",rel:"noopener noreferrer"},g=s("Kotlin-KCP\u7684\u5E94\u7528-\u7B2C\u4E00\u7BC7"),b=s("\uFF0C\u672C\u6587\u662F\u7B2C\u4E8C\u7BC7\uFF0C\u4EE5\u4E0B\u662F\u672C\u6587\u7684\u76EE\u6807\uFF1A"),h=n("ol",null,[n("li",null,"\u8BB0\u5F55\u5982\u4F55\u7B80\u5355\u642D\u5EFA KCP \u5F00\u53D1\u73AF\u5883"),n("li",null,"\u4F7F\u7528 KCP \u89E3\u51B3\u7B2C\u4E00\u7BC7\u4E2D\u7684\u95EE\u9898")],-1),f=n("h2",{id:"\u4F55\u4E3Akcp-\u4E3A\u4F55\u4E0D\u4F7F\u7528ksp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u4F55\u4E3Akcp-\u4E3A\u4F55\u4E0D\u4F7F\u7528ksp","aria-hidden":"true"},"#"),s(" \u4F55\u4E3AKCP\uFF1F\u4E3A\u4F55\u4E0D\u4F7F\u7528KSP\uFF1F")],-1),C=n("h3",{id:"ksp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ksp","aria-hidden":"true"},"#"),s(" KSP")],-1),y=n("code",null,"KSP",-1),q=s(" \u5373 "),w={href:"https://github.com/google/ksp",target:"_blank",rel:"noopener noreferrer"},x=n("code",null,"Kotlin Symbol Processing(Kotlin\u7B26\u53F7\u5904\u7406\u5668)",-1),_=s("\uFF0CKSP \u76EE\u524D\u53EA\u80FD\u751F\u6210\u4EE3\u7801\uFF0C\u4E0D\u80FD\u4FEE\u6539\u5B57\u8282\u7801\uFF0C\u7B2C\u4E00\u7BC7\u4E2D\u7684\u95EE\u9898\u9700\u8981\u4FEE\u6539\u5B57\u8282\u7801\uFF0C\u56E0\u6B64 KSP \u4E0D\u80FD\u6EE1\u8DB3\u9700\u6C42"),I=i('<h3 id="kcp" tabindex="-1"><a class="header-anchor" href="#kcp" aria-hidden="true">#</a> KCP</h3><p><code>KCP</code> \u5373 <code>Kotlin Compiler Plugin(Kotlin\u7F16\u8BD1\u5668\u63D2\u4EF6)</code>\uFF0C\u5728 <code>kotlinc </code> \u8FC7\u7A0B\u4E2D\u63D0\u4F9B hook \u65F6\u673A\uFF0C\u5728\u6B64\u671F\u95F4\u53EF\u4EE5\u751F\u6210\u4EE3\u7801\u3001\u4FEE\u6539\u5B57\u8282\u7801\u7B49</p><p>\u6807\u51C6\u7684 KCP \u67B6\u6784\u5982\u4E0B<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>\uFF1A</p><p><img src="'+c+'" alt="KCP\u67B6\u6784"></p><h3 id="plugin" tabindex="-1"><a class="header-anchor" href="#plugin" aria-hidden="true">#</a> Plugin</h3><ul><li>Gradle \u63D2\u4EF6\uFF0C\u4E0E Kotlin \u65E0\u5173\uFF0C\u5728 build.gradle \u811A\u672C\u4E2D\u63D0\u4F9B\u4E00\u4E2A\u5165\u53E3</li><li>\u901A\u8FC7 Gradle \u6269\u5C55\u8BBE\u7F6E\u914D\u7F6E\u4FE1\u606F</li></ul><h3 id="subplugin" tabindex="-1"><a class="header-anchor" href="#subplugin" aria-hidden="true">#</a> Subplugin</h3><ul><li>\u4ECB\u4E8E Gradle \u548C Kotlin \u76F4\u63A5\u7684 APIs \u63A5\u53E3</li><li>\u8BFB\u53D6 Gradle \u6269\u5C55\u914D\u7F6E\u4FE1\u606F\u5E76\u5199\u5165 <code>SubpluginOptions</code></li><li>\u5B9A\u4E49\u7F16\u8BD1\u5668\u63D2\u4EF6\u7684\u552F\u4E00<code>ID</code></li><li>\u5B9A\u4E49 Kotlin \u63D2\u4EF6\u7684 Maven \u5750\u6807\u4FE1\u606F\uFF0C\u4FBF\u4E8E\u7F16\u8BD1\u5668\u4E0B\u8F7D\u5B83</li></ul><h3 id="commandlinprocessor" tabindex="-1"><a class="header-anchor" href="#commandlinprocessor" aria-hidden="true">#</a> CommandLinProcessor</h3><ul><li>\u8BBE\u7F6E Kotlin \u63D2\u4EF6\u552F\u4E00 ID</li><li>\u8BFB\u53D6 kotlinc -Xplugin \u53C2\u6570</li><li>\u8BFB\u53D6 <code>SubpluginOptions</code> \u914D\u7F6E\u4FE1\u606F\uFF0C\u5E76\u5199\u5165 <code>CompilerConfigurationKeys</code></li></ul><h3 id="componentregistrar" tabindex="-1"><a class="header-anchor" href="#componentregistrar" aria-hidden="true">#</a> ComponentRegistrar</h3><ul><li>\u8BFB\u53D6 <code>CompilerConfigurationKeys</code></li><li>\u6CE8\u518C <code>Extension</code> \u5230\u5404\u7F16\u8BD1\u6D41\u7A0B</li></ul><h3 id="extension" tabindex="-1"><a class="header-anchor" href="#extension" aria-hidden="true">#</a> Extension</h3><ul><li>\u751F\u6210\u4EE3\u7801</li><li>\u4FEE\u6539\u5B57\u8282\u7801</li><li>\u591A\u79CD\u7C7B\u578B\u7684\u6269\u5C55\uFF0C\u6BD4\u5982 <ul><li>ExpressionCodegenExtension</li><li>ClassBuilderInterceptorExtension</li><li>StorageComponentContainerContributor</li><li>IrGenerationExtension</li></ul></li></ul><h2 id="\u5B9E\u73B0kcp" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0kcp" aria-hidden="true">#</a> \u5B9E\u73B0KCP</h2><h3 id="\u76EE\u6807" tabindex="-1"><a class="header-anchor" href="#\u76EE\u6807" aria-hidden="true">#</a> \u76EE\u6807</h3><p>\u6839\u636E KCP \u7684\u67B6\u6784\uFF0C\u4E0B\u9762\u4E00\u4E00\u8FDB\u884C\u5B9E\u73B0</p><p><img src="'+u+`" alt="\u9879\u76EE\u67B6\u6784"></p><p>\u4E0A\u56FE\u662F\u672C\u4ED3\u5E93\u67B6\u6784\uFF0C\u65E8\u5728\u901A\u8FC7 KCP \u5728 Java \u5B57\u8282\u7801\u4E2D <code>@Hide</code> \u6CE8\u89E3\u76EE\u6807\u4E0A\u8BBE\u7F6E <code>ACC_SYNTHETIC</code> \u6807\u8BC6\uFF0C\u4F7F\u5176\u5728 Java \u4E2D\u4E0D\u80FD\u6B63\u5E38\u8C03\u7528\uFF0C\u8FBE\u5230\u9690\u85CF API \u7684\u6548\u679C</p><h3 id="build-gradle-project-level" tabindex="-1"><a class="header-anchor" href="#build-gradle-project-level" aria-hidden="true">#</a> build.gradle - project level</h3><p>\u5728\u9879\u76EE\u7EA7\u522B\u7684 build.gradle \u811A\u672C\u4E2D\u914D\u7F6E\u63D2\u4EF6\u4F9D\u8D56</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>buildscript <span class="token punctuation">{</span>
    <span class="token comment">// \u914D\u7F6E Kotlin \u63D2\u4EF6\u552F\u4E00ID</span>
    ext<span class="token punctuation">.</span>kotlin_plugin_id <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;com.guodong.android.mask.kcp&quot;</span></span>
    
    <span class="token comment">// \u914D\u7F6E Kotlin \u63D2\u4EF6\u7248\u672C</span>
    ext<span class="token punctuation">.</span>plugin_version <span class="token operator">=</span> <span class="token string">&#39;x.x.x&#39;</span>
<span class="token punctuation">}</span>

plugins <span class="token punctuation">{</span>
    <span class="token comment">// \u914D\u7F6E Gradle \u53D1\u5E03\u63D2\u4EF6\uFF0C\u53EF\u4EE5\u4E0D\u518D\u5199 META-INF</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;com.gradle.plugin-publish&quot;</span></span><span class="token punctuation">)</span> version <span class="token interpolation-string"><span class="token string">&quot;0.16.0&quot;</span></span> apply <span class="token boolean">false</span>
    
    <span class="token comment">// \u914D\u7F6E\u751F\u6210 BuildConfig \u63D2\u4EF6</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span> version <span class="token interpolation-string"><span class="token string">&quot;3.0.3&quot;</span></span> apply <span class="token boolean">false</span>
    id <span class="token string">&#39;org.jetbrains.kotlin.jvm&#39;</span> version <span class="token string">&#39;1.6.10&#39;</span> apply <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="plugin-gradle" tabindex="-1"><a class="header-anchor" href="#plugin-gradle" aria-hidden="true">#</a> plugin-gradle</h3><p>\u63A5\u4E0B\u6765\u7F16\u5199 Gradle \u63D2\u4EF6\uFF0C\u6B64\u63D2\u4EF6\u5BF9\u5E94 KCP \u67B6\u6784\u4E2D\u7684 <code>Plugin</code> \u548C <code>Subplugin</code></p><p>\u9996\u5148\u914D\u7F6E\u4E0B build.gradle.kts \u811A\u672C</p><h4 id="build-gradle-kts-module-level" tabindex="-1"><a class="header-anchor" href="#build-gradle-kts-module-level" aria-hidden="true">#</a> build.gradle.kts - module level</h4><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>plugins <span class="token punctuation">{</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;java-gradle-plugin&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;jvm&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;gradle-plugin-api&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

buildConfig <span class="token punctuation">{</span>
    <span class="token comment">// \u914D\u7F6E BuildConfig \u7684\u5305\u540D</span>
    <span class="token function">packageName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.gradle&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u8BBE\u7F6E Kotlin \u63D2\u4EF6\u552F\u4E00 ID</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_ID&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u8BBE\u7F6E Kotlin \u63D2\u4EF6 GroupId</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_GROUP&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;com.guodong.android\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u8BBE\u7F6E Kotlin \u63D2\u4EF6 ArtifactId</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_NAME&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;mask-kcp-kotlin-plugin\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u8BBE\u7F6E Kotlin \u63D2\u4EF6 Version</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_VERSION&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;PLUGIN_VERSION&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

gradlePlugin <span class="token punctuation">{</span>
    plugins <span class="token punctuation">{</span>
        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Mask&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span> String <span class="token comment">// \`apply plugin: &quot;com.guodong.android.mask.kcp&quot;\`</span>
            displayName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;Mask Kcp&quot;</span></span>
            description <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;Mask Kcp&quot;</span></span>
            implementationClass <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.gradle.MaskGradlePlugin&quot;</span></span> <span class="token comment">// \u63D2\u4EF6\u5165\u53E3\u7C7B</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

tasks<span class="token punctuation">.</span>withType<span class="token operator">&lt;</span>KotlinCompile<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    kotlinOptions<span class="token punctuation">.</span>jvmTarget <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;1.8&quot;</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="maskgradleplugin" tabindex="-1"><a class="header-anchor" href="#maskgradleplugin" aria-hidden="true">#</a> MaskGradlePlugin</h4><p>\u521B\u5EFA <code>MaskGradlePlugin</code> \u5B9E\u73B0 <code>KotlinCompilerPluginSupportPlugin</code> \u63A5\u53E3</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> MaskGradlePlugin <span class="token operator">:</span> KotlinCompilerPluginSupportPlugin <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token operator">:</span> Project<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">with</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Welcome to guodongAndroid mask kcp gradle plugin.&quot;</span></span><span class="token punctuation">)</span>
        
        <span class="token comment">// \u6B64\u5904\u53EF\u4EE5\u914D\u7F6E Gradle \u63D2\u4EF6\u6269\u5C55</span>
        <span class="token comment">// \u672C\u63D2\u4EF6\u6CA1\u6709\u914D\u7F6E\u9879, \u65E0\u9700\u914D\u7F6E\u6269\u5C55</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u662F\u5426\u9002\u7528, \u9ED8\u8BA4True</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isApplicable</span><span class="token punctuation">(</span>kotlinCompilation<span class="token operator">:</span> KotlinCompilation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// \u83B7\u53D6 Kotlin \u63D2\u4EF6\u552F\u4E00ID</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getCompilerPluginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_ID

    <span class="token comment">// \u83B7\u53D6 Kotlin \u63D2\u4EF6 Maven \u5750\u6807\u4FE1\u606F</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getPluginArtifact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SubpluginArtifact <span class="token operator">=</span> <span class="token function">SubpluginArtifact</span><span class="token punctuation">(</span>
        groupId <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_GROUP<span class="token punctuation">,</span>
        artifactId <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_NAME<span class="token punctuation">,</span>
        version <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_VERSION<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// \u8BFB\u53D6 Gradle \u63D2\u4EF6\u6269\u5C55\u4FE1\u606F\u5E76\u5199\u5165 SubpluginOption</span>
    <span class="token comment">// \u672C\u63D2\u4EF6\u6CA1\u6709\u6269\u5C55\u4FE1\u606F\uFF0C\u6240\u4EE5\u8FD4\u56DE\u7A7A\u96C6\u5408</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">applyToCompilation</span><span class="token punctuation">(</span>kotlinCompilation<span class="token operator">:</span> KotlinCompilation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Provider<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>SubpluginOption<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> project <span class="token operator">=</span> kotlinCompilation<span class="token punctuation">.</span>target<span class="token punctuation">.</span>project
        <span class="token keyword">return</span> project<span class="token punctuation">.</span><span class="token function">provider</span> <span class="token punctuation">{</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u81F3\u6B64 Gradle \u63D2\u4EF6\u7F16\u5199\u5B8C\u6210\uFF0C\u662F\u4E0D\u662F\u5F88\u7B80\u5355\u{1F604}</p><h3 id="plugin-kotlin" tabindex="-1"><a class="header-anchor" href="#plugin-kotlin" aria-hidden="true">#</a> plugin-kotlin</h3><p>\u63A5\u4E0B\u6765\u7F16\u5199 Kotlin \u7F16\u8BD1\u5668\u63D2\u4EF6\uFF0C\u6B64\u63D2\u4EF6\u5BF9\u5E94 KCP \u67B6\u6784\u4E2D\u7684 <code>CommandLineProcessor</code> \u3001 <code>ComponentRegistrar</code> \u548C <code>Extension</code></p><p>\u9996\u5148\u914D\u7F6E\u4E0B build.gradle.kts \u811A\u672C</p><h4 id="build-gradle-kts-module-level-1" tabindex="-1"><a class="header-anchor" href="#build-gradle-kts-module-level-1" aria-hidden="true">#</a> build.gradle.kts - module level</h4><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>plugins <span class="token punctuation">{</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;jvm&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;kapt&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token comment">// \u4F9D\u8D56 Kotlin \u7F16\u8BD1\u5668\u5E93</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;org.jetbrains.kotlin:kotlin-compiler-embeddable&quot;</span></span><span class="token punctuation">)</span>

    <span class="token comment">// \u4F9D\u8D56 Google auto service</span>
    <span class="token function">kapt</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.google.auto.service:auto-service:1.0&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.google.auto.service:auto-service-annotations:1.0&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

buildConfig <span class="token punctuation">{</span>
    <span class="token comment">// \u914D\u7F6E BuildConfig \u7684\u5305\u540D</span>
    <span class="token function">packageName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.kotlin&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u8BBE\u7F6E Kotlin \u63D2\u4EF6\u552F\u4E00 ID</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_ID&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

tasks<span class="token punctuation">.</span>withType<span class="token operator">&lt;</span>KotlinCompile<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    kotlinOptions<span class="token punctuation">.</span>jvmTarget <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;1.8&quot;</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6839\u636E KCP \u67B6\u6784\uFF0C\u4E0B\u9762\u5B9E\u73B0 <code>CommandLineProcessor</code></p><h4 id="maskcommandlineprocessor" tabindex="-1"><a class="header-anchor" href="#maskcommandlineprocessor" aria-hidden="true">#</a> MaskCommandLineProcessor</h4><p>\u521B\u5EFA <code>MaskCommandLineProcessor</code> \u5B9E\u73B0 <code>CommandLineProcessor</code> \u63A5\u53E3</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@AutoService</span><span class="token punctuation">(</span>CommandLineProcessor<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> MaskCommandLineProcessor <span class="token operator">:</span> CommandLineProcessor <span class="token punctuation">{</span>

    <span class="token comment">// \u914D\u7F6E Kotlin \u63D2\u4EF6\u552F\u4E00 ID</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> pluginId<span class="token operator">:</span> String <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_ID

    <span class="token comment">// \u8BFB\u53D6 \`SubpluginOptions\` \u53C2\u6570\uFF0C\u5E76\u5199\u5165 \`CliOption\`</span>
    <span class="token comment">// \u672C\u63D2\u4EF6\u6CA1\u6709\u914D\u7F6E\u4FE1\u606F\uFF0C\u8FD4\u56DE\u7A7A\u96C6\u5408</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> pluginOptions<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>AbstractCliOption<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// \u5904\u7406 \`CliOption\` \u5199\u5165 \`CompilerConfiguration\`</span>
    <span class="token comment">// \u672C\u63D2\u4EF6\u6CA1\u6709\u914D\u7F6E\u4FE1\u606F\uFF0C\u6B64\u5904\u6CA1\u6709\u5B9E\u73B0</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">processOption</span><span class="token punctuation">(</span>
        option<span class="token operator">:</span> AbstractCliOption<span class="token punctuation">,</span>
        value<span class="token operator">:</span> String<span class="token punctuation">,</span>
        configuration<span class="token operator">:</span> CompilerConfiguration
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">processOption</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> value<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CommandLineProcessor</code> \u7F16\u5199\u5B8C\u6210</p><p>\u63A5\u4E0B\u6765\u5B9E\u73B0 <code>ComponentRegistrar</code></p><h4 id="maskcomponentregistrar" tabindex="-1"><a class="header-anchor" href="#maskcomponentregistrar" aria-hidden="true">#</a> MaskComponentRegistrar</h4><p>\u521B\u5EFA <code>MaskComponentRegistrar</code> \u5B9E\u73B0 <code>ComponentRegistrar</code> \u63A5\u53E3</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@AutoService</span><span class="token punctuation">(</span>ComponentRegistrar<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> MaskComponentRegistrar <span class="token operator">:</span> ComponentRegistrar <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">registerProjectComponents</span><span class="token punctuation">(</span>
        project<span class="token operator">:</span> MockProject<span class="token punctuation">,</span>
        configuration<span class="token operator">:</span> CompilerConfiguration
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u83B7\u53D6\u65E5\u5FD7\u6536\u96C6\u5668</span>
        <span class="token keyword">val</span> messageCollector <span class="token operator">=</span>
            configuration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CLIConfigurationKeys<span class="token punctuation">.</span>MESSAGE_COLLECTOR_KEY<span class="token punctuation">,</span> MessageCollector<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>

        <span class="token comment">// \u8F93\u51FA\u65E5\u5FD7\uFF0C\u67E5\u770B\u662F\u5426\u6267\u884C</span>
        <span class="token comment">// CompilerMessageSeverity.INFO - \u6CA1\u6709\u770B\u5230\u65E5\u5FD7\u8F93\u51FA</span>
        <span class="token comment">// CompilerMessageSeverity.ERROR - \u7F16\u8BD1\u8FC7\u7A0B\u505C\u6B62\u6267\u884C</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Welcome to guodongAndroid mask kcp kotlin plugin&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// \u6B64\u5904\u5728 \`ClassBuilderInterceptorExtension\` \u4E2D\u6CE8\u518C\u6269\u5C55</span>
        ClassBuilderInterceptorExtension<span class="token punctuation">.</span><span class="token function">registerExtension</span><span class="token punctuation">(</span>
            project<span class="token punctuation">,</span>
            <span class="token function">MaskClassGenerationInterceptor</span><span class="token punctuation">(</span>messageCollector<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\u5B9E\u73B0 <code>Extension</code></p><h4 id="maskclassgenerationinterceptor" tabindex="-1"><a class="header-anchor" href="#maskclassgenerationinterceptor" aria-hidden="true">#</a> MaskClassGenerationInterceptor</h4><p>\u521B\u5EFA <code>MaskClassGenerationInterceptor</code> \u5B9E\u73B0 <code>ClassBuilderInterceptorExtension</code> \u63A5\u53E3</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassGenerationInterceptor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> ClassBuilderInterceptorExtension <span class="token punctuation">{</span>

    <span class="token comment">// \u62E6\u622A ClassBuilderFactory</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">interceptClassBuilderFactory</span><span class="token punctuation">(</span>
        interceptedFactory<span class="token operator">:</span> ClassBuilderFactory<span class="token punctuation">,</span>
        bindingContext<span class="token operator">:</span> BindingContext<span class="token punctuation">,</span>
        diagnostics<span class="token operator">:</span> DiagnosticSink
        <span class="token comment">// \u81EA\u5B9A\u4E49 ClassBuilderFactory \u59D4\u6258\u7ED9 \u6E90ClassBuilderFactory</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilderFactory <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ClassBuilderFactory <span class="token keyword">by</span> interceptedFactory <span class="token punctuation">{</span>
        
        <span class="token comment">// \u590D\u5199 newClassBuilder\uFF0C\u81EA\u5B9A\u4E49 ClassBuilder</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newClassBuilder</span><span class="token punctuation">(</span>origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilder <span class="token punctuation">{</span>
            <span class="token comment">// \u4F20\u5165\u6E90ClassBuilder</span>
            <span class="token keyword">return</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>messageCollector<span class="token punctuation">,</span> interceptedFactory<span class="token punctuation">.</span><span class="token function">newClassBuilder</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="maskclassbuilder" tabindex="-1"><a class="header-anchor" href="#maskclassbuilder" aria-hidden="true">#</a> MaskClassBuilder</h4><p>\u521B\u5EFA <code>MaskClassBuilder</code> \u7EE7\u627F <code>DelegatingClassBuilder</code>\uFF0C\u5B9E\u73B0 <code>getDelegate</code> \u65B9\u6CD5\uFF0C\u590D\u5199 <code>newField</code> \u548C <code>newMethod</code> \u65B9\u6CD5</p><h6 id="getdelegate" tabindex="-1"><a class="header-anchor" href="#getdelegate" aria-hidden="true">#</a> getDelegate</h6><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> delegate<span class="token operator">:</span> ClassBuilder
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">DelegatingClassBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// @Hide\u6CE8\u89E3\u7684\u5B8C\u5168\u9650\u5B9A\u540D(fully qualified name)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> annotations<span class="token operator">:</span> List<span class="token operator">&lt;</span>FqName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.Hide&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// \u8FD4\u56DE\u4EE3\u7406</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilder <span class="token operator">=</span> delegate
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="newfield" tabindex="-1"><a class="header-anchor" href="#newfield" aria-hidden="true">#</a> newField</h6><p>\u5904\u7406 <code>@Hide</code> \u6CE8\u89E3\u76EE\u6807\u4E3A\u5B57\u6BB5</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> delegate<span class="token operator">:</span> ClassBuilder
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">DelegatingClassBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// @Hide\u6CE8\u89E3\u7684\u5B8C\u5168\u9650\u5B9A\u540D(fully qualified name)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> annotations<span class="token operator">:</span> List<span class="token operator">&lt;</span>FqName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.Hide&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newField</span><span class="token punctuation">(</span>
        origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">,</span>
        access<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        name<span class="token operator">:</span> String<span class="token punctuation">,</span>
        desc<span class="token operator">:</span> String<span class="token punctuation">,</span>
        signature<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> Any<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> FieldVisitor <span class="token punctuation">{</span>
        <span class="token comment">// \u5224\u65AD\u63CF\u8FF0\u7B26\u662F\u5426\u662F\u5B57\u6BB5</span>
        <span class="token keyword">val</span> field <span class="token operator">=</span> origin<span class="token punctuation">.</span>descriptor <span class="token keyword">as</span><span class="token operator">?</span> FieldDescriptor
        	<span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

        <span class="token comment">// \u5224\u65AD\u5B57\u6BB5\u4E0A\u662F\u5426\u6709\`@Hide\`\u6CE8\u89E3</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotations<span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> field<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u8F93\u51FA\u5B57\u6BB5\u6E90\u8BBF\u95EE\u6807\u5FD7</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, fieldName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, originalAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">access</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// \u589E\u52A0\`ACC_SYNTHETIC\`\u6807\u8BC6</span>
        <span class="token keyword">val</span> maskAccess <span class="token operator">=</span> access <span class="token operator">+</span> Opcodes<span class="token punctuation">.</span>ACC_SYNTHETIC

        <span class="token comment">// \u8F93\u51FA\u5B57\u6BB5Mask\u540E\u8BBF\u95EE\u6807\u5FD7</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, fieldName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, maskAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">maskAccess</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// \u4F20\u5165Mask\u540E\u8BBF\u95EE\u6807\u5FD7</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> maskAccess<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="newmethod" tabindex="-1"><a class="header-anchor" href="#newmethod" aria-hidden="true">#</a> newMethod</h6><p>\u5904\u7406 <code>@Hide</code> \u6CE8\u89E3\u76EE\u6807\u4E3A\u65B9\u6CD5/\u51FD\u6570\uFF0C\u5904\u7406\u903B\u8F91\u4E0E\u5B57\u6BB5\u7C7B\u4F3C</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newMethod</span><span class="token punctuation">(</span>
    origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">,</span>
    access<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    desc<span class="token operator">:</span> String<span class="token punctuation">,</span>
    signature<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    exceptions<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">out</span> String<span class="token operator">&gt;</span><span class="token operator">?</span>
<span class="token punctuation">)</span><span class="token operator">:</span> MethodVisitor <span class="token punctuation">{</span>
    <span class="token comment">// \u5224\u65AD\u662F\u5426\u662F\u65B9\u6CD5/\u51FD\u6570\u63CF\u8FF0\u7B26</span>
    <span class="token keyword">val</span> function <span class="token operator">=</span> origin<span class="token punctuation">.</span>descriptor <span class="token keyword">as</span><span class="token operator">?</span> FunctionDescriptor
    	<span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>

    <span class="token comment">// \u5224\u65AD\u65B9\u6CD5/\u51FD\u6570\u4E0A\u662F\u5426\u6709\`@Hide\`\u6CE8\u89E3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotations<span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> function<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u8F93\u51FA\u65B9\u6CD5/\u51FD\u6570\u6E90\u8BBF\u95EE\u6807\u5FD7</span>
    messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
        CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
        <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, methodName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, originalAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">access</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">)</span>

    <span class="token comment">// \u589E\u52A0\`ACC_SYNTHETIC\`\u6807\u8BC6</span>
    <span class="token keyword">val</span> maskAccess <span class="token operator">=</span> access <span class="token operator">+</span> Opcodes<span class="token punctuation">.</span>ACC_SYNTHETIC

    <span class="token comment">// \u8F93\u51FA\u65B9\u6CD5/\u51FD\u6570Mask\u540E\u8BBF\u95EE\u6807\u5FD7</span>
    messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
        CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
        <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, methodName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, maskAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">maskAccess</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">)</span>

    <span class="token comment">// \u4F20\u5165Mask\u540E\u8BBF\u95EE\u6807\u5FD7</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> maskAccess<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u81F3\u6B64 Kotlin \u7F16\u8BD1\u5668\u63D2\u4EF6\u5B8C\u6210:happy:</p><h2 id="\u5E94\u7528kcp" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528kcp" aria-hidden="true">#</a> \u5E94\u7528KCP</h2><h3 id="build-gradle-project-level-1" tabindex="-1"><a class="header-anchor" href="#build-gradle-project-level-1" aria-hidden="true">#</a> build.gradle - project level</h3><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>buildscript <span class="token punctuation">{</span>
    ext<span class="token punctuation">.</span>plugin_version <span class="token operator">=</span> <span class="token string">&#39;x.x.x&#39;</span>
    dependencies <span class="token punctuation">{</span>
        classpath <span class="token interpolation-string"><span class="token string">&quot;com.guodong.android:mask-kcp-gradle-plugin:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">plugin_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lib-kotlin-build-gradle-module-level" tabindex="-1"><a class="header-anchor" href="#lib-kotlin-build-gradle-module-level" aria-hidden="true">#</a> lib-kotlin/build.gradle - module level</h3><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code># lib<span class="token operator">-</span>kotlin
plugins <span class="token punctuation">{</span>
    id <span class="token string">&#39;com.android.library&#39;</span>
    id <span class="token string">&#39;kotlin-android&#39;</span>
    id <span class="token string">&#39;kotlin-kapt&#39;</span>
    id <span class="token string">&#39;maven-publish&#39;</span>
    <span class="token comment">// id &#39;com.guodong.android.mask&#39; // use kcp</span>
    id <span class="token string">&#39;com.guodong.android.mask.kcp&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lib-kotlin" tabindex="-1"><a class="header-anchor" href="#lib-kotlin" aria-hidden="true">#</a> lib-kotlin</h3><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">interface</span> InterfaceTest <span class="token punctuation">{</span>

    <span class="token comment">// \u4F7F\u7528api-kt\u4E2D\u7684\u6CE8\u89E3</span>
    <span class="token annotation builtin">@Hide</span>
    <span class="token keyword">fun</span> <span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">KotlinTest</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> InterfaceTest <span class="token punctuation">{</span>

    <span class="token comment">// \u4F7F\u7528api-kt\u4E2D\u7684\u6CE8\u89E3</span>
    <span class="token annotation builtin">@Hide</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>

        <span class="token annotation builtin">@JvmStatic</span>
        <span class="token keyword">fun</span> <span class="token function">newKotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">KotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> binding<span class="token operator">:</span> LayoutKotlinTestBinding<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// \u4F7F\u7528api-kt\u4E2D\u7684\u6CE8\u89E3</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> a
        <span class="token annotation builtin">@Hide</span> <span class="token keyword">get</span>
        <span class="token annotation builtin">@Hide</span> <span class="token keyword">set</span>

    <span class="token keyword">fun</span> <span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Interface function test&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="app" tabindex="-1"><a class="header-anchor" href="#app" aria-hidden="true">#</a> app</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code># <span class="token class-name">MainActivity</span><span class="token punctuation">.</span>java

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testKotlinLib</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u521B\u5EFA\u5BF9\u8C61\u65F6\u4E0D\u80FD\u8BBF\u95EE\u65E0\u53C2\u6784\u9020\u65B9\u6CD5\uFF0C\u53EF\u4EE5\u8BBF\u95EE\u6709\u53C2\u6784\u9020\u65B9\u6CD5\u6216\u8BBF\u95EE\u9759\u6001\u5DE5\u5382\u65B9\u6CD5</span>
    <span class="token class-name">KotlinTest</span> test <span class="token operator">=</span> <span class="token class-name">KotlinTest</span><span class="token punctuation">.</span><span class="token function">newKotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u8C03\u7528\u65F6\u4E0D\u80FD\u8BBF\u95EE\`test.getA()\`\u65B9\u6CD5\uFF0C\u4EC5\u80FD\u8BBF\u95EE\`getA1()\u65B9\u6CD5</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;testKotlinLib: before --&gt; &quot;</span> <span class="token operator">+</span> test<span class="token punctuation">.</span><span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;testKotlinLib: after --&gt; &quot;</span> <span class="token operator">+</span> test<span class="token punctuation">.</span><span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    test<span class="token punctuation">.</span><span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">InterfaceTest</span> interfaceTest <span class="token operator">=</span> test<span class="token punctuation">;</span>
    <span class="token comment">// Error - cannot resolve method &#39;testInterface&#39; in &#39;InterfaceTest&#39;</span>
    interfaceTest<span class="token punctuation">.</span><span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>happy:happy:</p><h2 id="\u53C2\u8003\u6587\u732E" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u732E" aria-hidden="true">#</a> \u53C2\u8003\u6587\u732E</h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p>[Writing Your First Kotlin Compiler Plugin (jetbrains.com)](https://resources.jetbrains.com/storage/products/kotlinconf2018/slides/5_Writing Your First Kotlin Compiler Plugin.pdf) <a href="#footnote-ref1" class="footnote-backref">\u21A9\uFE0E</a></p></li></ol></section>`,74);function K(P,N){const a=l("ExternalLinkIcon");return o(),p("div",null,[d,k,n("p",null,[v,n("a",m,[g,e(a)]),b]),h,f,C,n("p",null,[y,q,n("a",w,[x,e(a)]),_]),I])}var A=t(r,[["render",K],["__file","Kotlin-KCP\u7684\u5E94\u7528-\u7B2C\u4E8C\u7BC7.html.vue"]]);export{A as default};
