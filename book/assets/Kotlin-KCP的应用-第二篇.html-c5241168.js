import{_ as t,Y as o,Z as p,$ as n,a0 as s,a1 as e,a3 as i,E as l}from"./framework-3d290349.js";const c="/book/assets/202205120932971-c1ba65b9.png",u="/book/assets/202205120959782-d8f17540.png",r={},d=n("h1",{id:"kotlin-kcpçš„åº”ç”¨-ç¬¬äºŒç¯‡",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#kotlin-kcpçš„åº”ç”¨-ç¬¬äºŒç¯‡","aria-hidden":"true"},"#"),s(" Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡")],-1),k=n("h2",{id:"å‰è¨€",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#å‰è¨€","aria-hidden":"true"},"#"),s(" å‰è¨€")],-1),v={href:"https://juejin.cn/post/7095248182912745502",target:"_blank",rel:"noopener noreferrer"},m=n("ol",null,[n("li",null,"è®°å½•å¦‚ä½•ç®€å•æ­å»º KCP å¼€å‘ç¯å¢ƒ"),n("li",null,"ä½¿ç”¨ KCP è§£å†³ç¬¬ä¸€ç¯‡ä¸­çš„é—®é¢˜")],-1),g=n("h2",{id:"ä½•ä¸ºkcp-ä¸ºä½•ä¸ä½¿ç”¨ksp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ä½•ä¸ºkcp-ä¸ºä½•ä¸ä½¿ç”¨ksp","aria-hidden":"true"},"#"),s(" ä½•ä¸ºKCPï¼Ÿä¸ºä½•ä¸ä½¿ç”¨KSPï¼Ÿ")],-1),b=n("h3",{id:"ksp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ksp","aria-hidden":"true"},"#"),s(" KSP")],-1),h=n("code",null,"KSP",-1),f={href:"https://github.com/google/ksp",target:"_blank",rel:"noopener noreferrer"},C=n("code",null,"Kotlin Symbol Processing(Kotlinç¬¦å·å¤„ç†å™¨)",-1),y=i('<h3 id="kcp" tabindex="-1"><a class="header-anchor" href="#kcp" aria-hidden="true">#</a> KCP</h3><p><code>KCP</code> å³ <code>Kotlin Compiler Plugin(Kotlinç¼–è¯‘å™¨æ’ä»¶)</code>ï¼Œåœ¨ <code>kotlinc </code> è¿‡ç¨‹ä¸­æä¾› hook æ—¶æœºï¼Œåœ¨æ­¤æœŸé—´å¯ä»¥ç”Ÿæˆä»£ç ã€ä¿®æ”¹å­—èŠ‚ç ç­‰</p><p>æ ‡å‡†çš„ KCP æ¶æ„å¦‚ä¸‹<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>ï¼š</p><p><img src="'+c+'" alt="KCPæ¶æ„" loading="lazy"></p><h3 id="plugin" tabindex="-1"><a class="header-anchor" href="#plugin" aria-hidden="true">#</a> Plugin</h3><ul><li>Gradle æ’ä»¶ï¼Œä¸ Kotlin æ— å…³ï¼Œåœ¨ build.gradle è„šæœ¬ä¸­æä¾›ä¸€ä¸ªå…¥å£</li><li>é€šè¿‡ Gradle æ‰©å±•è®¾ç½®é…ç½®ä¿¡æ¯</li></ul><h3 id="subplugin" tabindex="-1"><a class="header-anchor" href="#subplugin" aria-hidden="true">#</a> Subplugin</h3><ul><li>ä»‹äº Gradle å’Œ Kotlin ç›´æ¥çš„ APIs æ¥å£</li><li>è¯»å– Gradle æ‰©å±•é…ç½®ä¿¡æ¯å¹¶å†™å…¥ <code>SubpluginOptions</code></li><li>å®šä¹‰ç¼–è¯‘å™¨æ’ä»¶çš„å”¯ä¸€<code>ID</code></li><li>å®šä¹‰ Kotlin æ’ä»¶çš„ Maven åæ ‡ä¿¡æ¯ï¼Œä¾¿äºç¼–è¯‘å™¨ä¸‹è½½å®ƒ</li></ul><h3 id="commandlinprocessor" tabindex="-1"><a class="header-anchor" href="#commandlinprocessor" aria-hidden="true">#</a> CommandLinProcessor</h3><ul><li>è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</li><li>è¯»å– kotlinc -Xplugin å‚æ•°</li><li>è¯»å– <code>SubpluginOptions</code> é…ç½®ä¿¡æ¯ï¼Œå¹¶å†™å…¥ <code>CompilerConfigurationKeys</code></li></ul><h3 id="componentregistrar" tabindex="-1"><a class="header-anchor" href="#componentregistrar" aria-hidden="true">#</a> ComponentRegistrar</h3><ul><li>è¯»å– <code>CompilerConfigurationKeys</code></li><li>æ³¨å†Œ <code>Extension</code> åˆ°å„ç¼–è¯‘æµç¨‹</li></ul><h3 id="extension" tabindex="-1"><a class="header-anchor" href="#extension" aria-hidden="true">#</a> Extension</h3><ul><li>ç”Ÿæˆä»£ç </li><li>ä¿®æ”¹å­—èŠ‚ç </li><li>å¤šç§ç±»å‹çš„æ‰©å±•ï¼Œæ¯”å¦‚ <ul><li>ExpressionCodegenExtension</li><li>ClassBuilderInterceptorExtension</li><li>StorageComponentContainerContributor</li><li>IrGenerationExtension</li></ul></li></ul><h2 id="å®ç°kcp" tabindex="-1"><a class="header-anchor" href="#å®ç°kcp" aria-hidden="true">#</a> å®ç°KCP</h2><h3 id="ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ç›®æ ‡" aria-hidden="true">#</a> ç›®æ ‡</h3><p>æ ¹æ® KCP çš„æ¶æ„ï¼Œä¸‹é¢ä¸€ä¸€è¿›è¡Œå®ç°</p><p><img src="'+u+`" alt="é¡¹ç›®æ¶æ„" loading="lazy"></p><p>ä¸Šå›¾æ˜¯æœ¬ä»“åº“æ¶æ„ï¼Œæ—¨åœ¨é€šè¿‡ KCP åœ¨ Java å­—èŠ‚ç ä¸­ <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸Šè®¾ç½® <code>ACC_SYNTHETIC</code> æ ‡è¯†ï¼Œä½¿å…¶åœ¨ Java ä¸­ä¸èƒ½æ­£å¸¸è°ƒç”¨ï¼Œè¾¾åˆ°éšè— API çš„æ•ˆæœ</p><h3 id="build-gradle-project-level" tabindex="-1"><a class="header-anchor" href="#build-gradle-project-level" aria-hidden="true">#</a> build.gradle - project level</h3><p>åœ¨é¡¹ç›®çº§åˆ«çš„ build.gradle è„šæœ¬ä¸­é…ç½®æ’ä»¶ä¾èµ–</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code>buildscript <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ID</span>
    ext<span class="token punctuation">.</span>kotlin_plugin_id <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;com.guodong.android.mask.kcp&quot;</span></span>
    
    <span class="token comment">// é…ç½® Kotlin æ’ä»¶ç‰ˆæœ¬</span>
    ext<span class="token punctuation">.</span>plugin_version <span class="token operator">=</span> <span class="token string">&#39;x.x.x&#39;</span>
<span class="token punctuation">}</span>

plugins <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® Gradle å‘å¸ƒæ’ä»¶ï¼Œå¯ä»¥ä¸å†å†™ META-INF</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;com.gradle.plugin-publish&quot;</span></span><span class="token punctuation">)</span> version <span class="token interpolation-string"><span class="token string">&quot;0.16.0&quot;</span></span> apply <span class="token boolean">false</span>
    
    <span class="token comment">// é…ç½®ç”Ÿæˆ BuildConfig æ’ä»¶</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span> version <span class="token interpolation-string"><span class="token string">&quot;3.0.3&quot;</span></span> apply <span class="token boolean">false</span>
    id <span class="token string">&#39;org.jetbrains.kotlin.jvm&#39;</span> version <span class="token string">&#39;1.6.10&#39;</span> apply <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="plugin-gradle" tabindex="-1"><a class="header-anchor" href="#plugin-gradle" aria-hidden="true">#</a> plugin-gradle</h3><p>æ¥ä¸‹æ¥ç¼–å†™ Gradle æ’ä»¶ï¼Œæ­¤æ’ä»¶å¯¹åº” KCP æ¶æ„ä¸­çš„ <code>Plugin</code> å’Œ <code>Subplugin</code></p><p>é¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p><h4 id="build-gradle-kts-module-level" tabindex="-1"><a class="header-anchor" href="#build-gradle-kts-module-level" aria-hidden="true">#</a> build.gradle.kts - module level</h4><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>plugins <span class="token punctuation">{</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;java-gradle-plugin&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;jvm&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;gradle-plugin-api&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

buildConfig <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BuildConfig çš„åŒ…å</span>
    <span class="token function">packageName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.gradle&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_ID&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// è®¾ç½® Kotlin æ’ä»¶ GroupId</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_GROUP&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;com.guodong.android\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// è®¾ç½® Kotlin æ’ä»¶ ArtifactId</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_NAME&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;mask-kcp-kotlin-plugin\\&quot;&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// è®¾ç½® Kotlin æ’ä»¶ Version</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_VERSION&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;PLUGIN_VERSION&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

gradlePlugin <span class="token punctuation">{</span>
    plugins <span class="token punctuation">{</span>
        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Mask&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span> String <span class="token comment">// \`apply plugin: &quot;com.guodong.android.mask.kcp&quot;\`</span>
            displayName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;Mask Kcp&quot;</span></span>
            description <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;Mask Kcp&quot;</span></span>
            implementationClass <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.gradle.MaskGradlePlugin&quot;</span></span> <span class="token comment">// æ’ä»¶å…¥å£ç±»</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

tasks<span class="token punctuation">.</span>withType<span class="token operator">&lt;</span>KotlinCompile<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    kotlinOptions<span class="token punctuation">.</span>jvmTarget <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;1.8&quot;</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="maskgradleplugin" tabindex="-1"><a class="header-anchor" href="#maskgradleplugin" aria-hidden="true">#</a> MaskGradlePlugin</h4><p>åˆ›å»º <code>MaskGradlePlugin</code> å®ç° <code>KotlinCompilerPluginSupportPlugin</code> æ¥å£</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> MaskGradlePlugin <span class="token operator">:</span> KotlinCompilerPluginSupportPlugin <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token operator">:</span> Project<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">with</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Welcome to guodongAndroid mask kcp gradle plugin.&quot;</span></span><span class="token punctuation">)</span>
        
        <span class="token comment">// æ­¤å¤„å¯ä»¥é…ç½® Gradle æ’ä»¶æ‰©å±•</span>
        <span class="token comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®é¡¹, æ— éœ€é…ç½®æ‰©å±•</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ˜¯å¦é€‚ç”¨, é»˜è®¤True</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isApplicable</span><span class="token punctuation">(</span>kotlinCompilation<span class="token operator">:</span> KotlinCompilation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// è·å– Kotlin æ’ä»¶å”¯ä¸€ID</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getCompilerPluginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_ID

    <span class="token comment">// è·å– Kotlin æ’ä»¶ Maven åæ ‡ä¿¡æ¯</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getPluginArtifact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SubpluginArtifact <span class="token operator">=</span> <span class="token function">SubpluginArtifact</span><span class="token punctuation">(</span>
        groupId <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_GROUP<span class="token punctuation">,</span>
        artifactId <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_NAME<span class="token punctuation">,</span>
        version <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_VERSION<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// è¯»å– Gradle æ’ä»¶æ‰©å±•ä¿¡æ¯å¹¶å†™å…¥ SubpluginOption</span>
    <span class="token comment">// æœ¬æ’ä»¶æ²¡æœ‰æ‰©å±•ä¿¡æ¯ï¼Œæ‰€ä»¥è¿”å›ç©ºé›†åˆ</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">applyToCompilation</span><span class="token punctuation">(</span>kotlinCompilation<span class="token operator">:</span> KotlinCompilation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Provider<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>SubpluginOption<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> project <span class="token operator">=</span> kotlinCompilation<span class="token punctuation">.</span>target<span class="token punctuation">.</span>project
        <span class="token keyword">return</span> project<span class="token punctuation">.</span><span class="token function">provider</span> <span class="token punctuation">{</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ Gradle æ’ä»¶ç¼–å†™å®Œæˆï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ğŸ˜„</p><h3 id="plugin-kotlin" tabindex="-1"><a class="header-anchor" href="#plugin-kotlin" aria-hidden="true">#</a> plugin-kotlin</h3><p>æ¥ä¸‹æ¥ç¼–å†™ Kotlin ç¼–è¯‘å™¨æ’ä»¶ï¼Œæ­¤æ’ä»¶å¯¹åº” KCP æ¶æ„ä¸­çš„ <code>CommandLineProcessor</code> ã€ <code>ComponentRegistrar</code> å’Œ <code>Extension</code></p><p>é¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p><h4 id="build-gradle-kts-module-level-1" tabindex="-1"><a class="header-anchor" href="#build-gradle-kts-module-level-1" aria-hidden="true">#</a> build.gradle.kts - module level</h4><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>plugins <span class="token punctuation">{</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;jvm&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;kapt&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.github.gmazzo.buildconfig&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token comment">// ä¾èµ– Kotlin ç¼–è¯‘å™¨åº“</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;org.jetbrains.kotlin:kotlin-compiler-embeddable&quot;</span></span><span class="token punctuation">)</span>

    <span class="token comment">// ä¾èµ– Google auto service</span>
    <span class="token function">kapt</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.google.auto.service:auto-service:1.0&quot;</span></span><span class="token punctuation">)</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.google.auto.service:auto-service-annotations:1.0&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

buildConfig <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BuildConfig çš„åŒ…å</span>
    <span class="token function">packageName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.kcp.kotlin&quot;</span></span><span class="token punctuation">)</span>
    
    <span class="token comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span>
    <span class="token function">buildConfigField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;String&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;KOTLIN_PLUGIN_ID&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;\\&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">rootProject<span class="token punctuation">.</span>extra<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">&quot;kotlin_plugin_id&quot;</span></span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\&quot;&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

tasks<span class="token punctuation">.</span>withType<span class="token operator">&lt;</span>KotlinCompile<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    kotlinOptions<span class="token punctuation">.</span>jvmTarget <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;1.8&quot;</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ® KCP æ¶æ„ï¼Œä¸‹é¢å®ç° <code>CommandLineProcessor</code></p><h4 id="maskcommandlineprocessor" tabindex="-1"><a class="header-anchor" href="#maskcommandlineprocessor" aria-hidden="true">#</a> MaskCommandLineProcessor</h4><p>åˆ›å»º <code>MaskCommandLineProcessor</code> å®ç° <code>CommandLineProcessor</code> æ¥å£</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token annotation builtin">@AutoService</span><span class="token punctuation">(</span>CommandLineProcessor<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> MaskCommandLineProcessor <span class="token operator">:</span> CommandLineProcessor <span class="token punctuation">{</span>

    <span class="token comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> pluginId<span class="token operator">:</span> String <span class="token operator">=</span> BuildConfig<span class="token punctuation">.</span>KOTLIN_PLUGIN_ID

    <span class="token comment">// è¯»å– \`SubpluginOptions\` å‚æ•°ï¼Œå¹¶å†™å…¥ \`CliOption\`</span>
    <span class="token comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®ä¿¡æ¯ï¼Œè¿”å›ç©ºé›†åˆ</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> pluginOptions<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>AbstractCliOption<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// å¤„ç† \`CliOption\` å†™å…¥ \`CompilerConfiguration\`</span>
    <span class="token comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®ä¿¡æ¯ï¼Œæ­¤å¤„æ²¡æœ‰å®ç°</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">processOption</span><span class="token punctuation">(</span>
        option<span class="token operator">:</span> AbstractCliOption<span class="token punctuation">,</span>
        value<span class="token operator">:</span> String<span class="token punctuation">,</span>
        configuration<span class="token operator">:</span> CompilerConfiguration
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">processOption</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> value<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CommandLineProcessor</code> ç¼–å†™å®Œæˆ</p><p>æ¥ä¸‹æ¥å®ç° <code>ComponentRegistrar</code></p><h4 id="maskcomponentregistrar" tabindex="-1"><a class="header-anchor" href="#maskcomponentregistrar" aria-hidden="true">#</a> MaskComponentRegistrar</h4><p>åˆ›å»º <code>MaskComponentRegistrar</code> å®ç° <code>ComponentRegistrar</code> æ¥å£</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token annotation builtin">@AutoService</span><span class="token punctuation">(</span>ComponentRegistrar<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> MaskComponentRegistrar <span class="token operator">:</span> ComponentRegistrar <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">registerProjectComponents</span><span class="token punctuation">(</span>
        project<span class="token operator">:</span> MockProject<span class="token punctuation">,</span>
        configuration<span class="token operator">:</span> CompilerConfiguration
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æ—¥å¿—æ”¶é›†å™¨</span>
        <span class="token keyword">val</span> messageCollector <span class="token operator">=</span>
            configuration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CLIConfigurationKeys<span class="token punctuation">.</span>MESSAGE_COLLECTOR_KEY<span class="token punctuation">,</span> MessageCollector<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>

        <span class="token comment">// è¾“å‡ºæ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æ‰§è¡Œ</span>
        <span class="token comment">// CompilerMessageSeverity.INFO - æ²¡æœ‰çœ‹åˆ°æ—¥å¿—è¾“å‡º</span>
        <span class="token comment">// CompilerMessageSeverity.ERROR - ç¼–è¯‘è¿‡ç¨‹åœæ­¢æ‰§è¡Œ</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Welcome to guodongAndroid mask kcp kotlin plugin&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// æ­¤å¤„åœ¨ \`ClassBuilderInterceptorExtension\` ä¸­æ³¨å†Œæ‰©å±•</span>
        ClassBuilderInterceptorExtension<span class="token punctuation">.</span><span class="token function">registerExtension</span><span class="token punctuation">(</span>
            project<span class="token punctuation">,</span>
            <span class="token function">MaskClassGenerationInterceptor</span><span class="token punctuation">(</span>messageCollector<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åå®ç° <code>Extension</code></p><h4 id="maskclassgenerationinterceptor" tabindex="-1"><a class="header-anchor" href="#maskclassgenerationinterceptor" aria-hidden="true">#</a> MaskClassGenerationInterceptor</h4><p>åˆ›å»º <code>MaskClassGenerationInterceptor</code> å®ç° <code>ClassBuilderInterceptorExtension</code> æ¥å£</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassGenerationInterceptor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> ClassBuilderInterceptorExtension <span class="token punctuation">{</span>

    <span class="token comment">// æ‹¦æˆª ClassBuilderFactory</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">interceptClassBuilderFactory</span><span class="token punctuation">(</span>
        interceptedFactory<span class="token operator">:</span> ClassBuilderFactory<span class="token punctuation">,</span>
        bindingContext<span class="token operator">:</span> BindingContext<span class="token punctuation">,</span>
        diagnostics<span class="token operator">:</span> DiagnosticSink
        <span class="token comment">// è‡ªå®šä¹‰ ClassBuilderFactory å§”æ‰˜ç»™ æºClassBuilderFactory</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilderFactory <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ClassBuilderFactory <span class="token keyword">by</span> interceptedFactory <span class="token punctuation">{</span>
        
        <span class="token comment">// å¤å†™ newClassBuilderï¼Œè‡ªå®šä¹‰ ClassBuilder</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newClassBuilder</span><span class="token punctuation">(</span>origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilder <span class="token punctuation">{</span>
            <span class="token comment">// ä¼ å…¥æºClassBuilder</span>
            <span class="token keyword">return</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>messageCollector<span class="token punctuation">,</span> interceptedFactory<span class="token punctuation">.</span><span class="token function">newClassBuilder</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="maskclassbuilder" tabindex="-1"><a class="header-anchor" href="#maskclassbuilder" aria-hidden="true">#</a> MaskClassBuilder</h4><p>åˆ›å»º <code>MaskClassBuilder</code> ç»§æ‰¿ <code>DelegatingClassBuilder</code>ï¼Œå®ç° <code>getDelegate</code> æ–¹æ³•ï¼Œå¤å†™ <code>newField</code> å’Œ <code>newMethod</code> æ–¹æ³•</p><h6 id="getdelegate" tabindex="-1"><a class="header-anchor" href="#getdelegate" aria-hidden="true">#</a> getDelegate</h6><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> delegate<span class="token operator">:</span> ClassBuilder
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">DelegatingClassBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// @Hideæ³¨è§£çš„å®Œå…¨é™å®šå(fully qualified name)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> annotations<span class="token operator">:</span> List<span class="token operator">&lt;</span>FqName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.Hide&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// è¿”å›ä»£ç†</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ClassBuilder <span class="token operator">=</span> delegate
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="newfield" tabindex="-1"><a class="header-anchor" href="#newfield" aria-hidden="true">#</a> newField</h6><p>å¤„ç† <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸ºå­—æ®µ</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">MaskClassBuilder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> messageCollector<span class="token operator">:</span> MessageCollector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> delegate<span class="token operator">:</span> ClassBuilder
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">DelegatingClassBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// @Hideæ³¨è§£çš„å®Œå…¨é™å®šå(fully qualified name)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> annotations<span class="token operator">:</span> List<span class="token operator">&lt;</span>FqName<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">FqName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.guodong.android.mask.api.Hide&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newField</span><span class="token punctuation">(</span>
        origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">,</span>
        access<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        name<span class="token operator">:</span> String<span class="token punctuation">,</span>
        desc<span class="token operator">:</span> String<span class="token punctuation">,</span>
        signature<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> Any<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> FieldVisitor <span class="token punctuation">{</span>
        <span class="token comment">// åˆ¤æ–­æè¿°ç¬¦æ˜¯å¦æ˜¯å­—æ®µ</span>
        <span class="token keyword">val</span> field <span class="token operator">=</span> origin<span class="token punctuation">.</span>descriptor <span class="token keyword">as</span><span class="token operator">?</span> FieldDescriptor
        	<span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

        <span class="token comment">// åˆ¤æ–­å­—æ®µä¸Šæ˜¯å¦æœ‰\`@Hide\`æ³¨è§£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotations<span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> field<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¾“å‡ºå­—æ®µæºè®¿é—®æ ‡å¿—</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, fieldName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, originalAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">access</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// å¢åŠ \`ACC_SYNTHETIC\`æ ‡è¯†</span>
        <span class="token keyword">val</span> maskAccess <span class="token operator">=</span> access <span class="token operator">+</span> Opcodes<span class="token punctuation">.</span>ACC_SYNTHETIC

        <span class="token comment">// è¾“å‡ºå­—æ®µMaskåè®¿é—®æ ‡å¿—</span>
        messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
            CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, fieldName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, maskAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">maskAccess</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">)</span>

        <span class="token comment">// ä¼ å…¥Maskåè®¿é—®æ ‡å¿—</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newField</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> maskAccess<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="newmethod" tabindex="-1"><a class="header-anchor" href="#newmethod" aria-hidden="true">#</a> newMethod</h6><p>å¤„ç† <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸ºæ–¹æ³•/å‡½æ•°ï¼Œå¤„ç†é€»è¾‘ä¸å­—æ®µç±»ä¼¼</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newMethod</span><span class="token punctuation">(</span>
    origin<span class="token operator">:</span> JvmDeclarationOrigin<span class="token punctuation">,</span>
    access<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    desc<span class="token operator">:</span> String<span class="token punctuation">,</span>
    signature<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    exceptions<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">out</span> String<span class="token operator">&gt;</span><span class="token operator">?</span>
<span class="token punctuation">)</span><span class="token operator">:</span> MethodVisitor <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ–¹æ³•/å‡½æ•°æè¿°ç¬¦</span>
    <span class="token keyword">val</span> function <span class="token operator">=</span> origin<span class="token punctuation">.</span>descriptor <span class="token keyword">as</span><span class="token operator">?</span> FunctionDescriptor
    	<span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>

    <span class="token comment">// åˆ¤æ–­æ–¹æ³•/å‡½æ•°ä¸Šæ˜¯å¦æœ‰\`@Hide\`æ³¨è§£</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotations<span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> function<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¾“å‡ºæ–¹æ³•/å‡½æ•°æºè®¿é—®æ ‡å¿—</span>
    messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
        CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
        <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, methodName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, originalAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">access</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">)</span>

    <span class="token comment">// å¢åŠ \`ACC_SYNTHETIC\`æ ‡è¯†</span>
    <span class="token keyword">val</span> maskAccess <span class="token operator">=</span> access <span class="token operator">+</span> Opcodes<span class="token punctuation">.</span>ACC_SYNTHETIC

    <span class="token comment">// è¾“å‡ºæ–¹æ³•/å‡½æ•°Maskåè®¿é—®æ ‡å¿—</span>
    messageCollector<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>
        CompilerMessageSeverity<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>
        <span class="token string-literal singleline"><span class="token string">&quot;Mask Class = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">delegate<span class="token punctuation">.</span>thisName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, methodName = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">, maskAccess = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">maskAccess</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">)</span>

    <span class="token comment">// ä¼ å…¥Maskåè®¿é—®æ ‡å¿—</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> maskAccess<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ Kotlin ç¼–è¯‘å™¨æ’ä»¶å®Œæˆ:happy:</p><h2 id="åº”ç”¨kcp" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨kcp" aria-hidden="true">#</a> åº”ç”¨KCP</h2><h3 id="build-gradle-project-level-1" tabindex="-1"><a class="header-anchor" href="#build-gradle-project-level-1" aria-hidden="true">#</a> build.gradle - project level</h3><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code>buildscript <span class="token punctuation">{</span>
    ext<span class="token punctuation">.</span>plugin_version <span class="token operator">=</span> <span class="token string">&#39;x.x.x&#39;</span>
    dependencies <span class="token punctuation">{</span>
        classpath <span class="token interpolation-string"><span class="token string">&quot;com.guodong.android:mask-kcp-gradle-plugin:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">plugin_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lib-kotlin-build-gradle-module-level" tabindex="-1"><a class="header-anchor" href="#lib-kotlin-build-gradle-module-level" aria-hidden="true">#</a> lib-kotlin/build.gradle - module level</h3><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code># lib<span class="token operator">-</span>kotlin
plugins <span class="token punctuation">{</span>
    id <span class="token string">&#39;com.android.library&#39;</span>
    id <span class="token string">&#39;kotlin-android&#39;</span>
    id <span class="token string">&#39;kotlin-kapt&#39;</span>
    id <span class="token string">&#39;maven-publish&#39;</span>
    <span class="token comment">// id &#39;com.guodong.android.mask&#39; // use kcp</span>
    id <span class="token string">&#39;com.guodong.android.mask.kcp&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lib-kotlin" tabindex="-1"><a class="header-anchor" href="#lib-kotlin" aria-hidden="true">#</a> lib-kotlin</h3><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">interface</span> InterfaceTest <span class="token punctuation">{</span>

    <span class="token comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span>
    <span class="token annotation builtin">@Hide</span>
    <span class="token keyword">fun</span> <span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">KotlinTest</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> InterfaceTest <span class="token punctuation">{</span>

    <span class="token comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span>
    <span class="token annotation builtin">@Hide</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>

        <span class="token annotation builtin">@JvmStatic</span>
        <span class="token keyword">fun</span> <span class="token function">newKotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">KotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> binding<span class="token operator">:</span> LayoutKotlinTestBinding<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> a
        <span class="token annotation builtin">@Hide</span> <span class="token keyword">get</span>
        <span class="token annotation builtin">@Hide</span> <span class="token keyword">set</span>

    <span class="token keyword">fun</span> <span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Interface function test&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="app" tabindex="-1"><a class="header-anchor" href="#app" aria-hidden="true">#</a> app</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code># <span class="token class-name">MainActivity</span><span class="token punctuation">.</span>java

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testKotlinLib</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºå¯¹è±¡æ—¶ä¸èƒ½è®¿é—®æ— å‚æ„é€ æ–¹æ³•ï¼Œå¯ä»¥è®¿é—®æœ‰å‚æ„é€ æ–¹æ³•æˆ–è®¿é—®é™æ€å·¥å‚æ–¹æ³•</span>
    <span class="token class-name">KotlinTest</span> test <span class="token operator">=</span> <span class="token class-name">KotlinTest</span><span class="token punctuation">.</span><span class="token function">newKotlinTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨æ—¶ä¸èƒ½è®¿é—®\`test.getA()\`æ–¹æ³•ï¼Œä»…èƒ½è®¿é—®\`getA1()æ–¹æ³•</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;testKotlinLib: before --&gt; &quot;</span> <span class="token operator">+</span> test<span class="token punctuation">.</span><span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;testKotlinLib: after --&gt; &quot;</span> <span class="token operator">+</span> test<span class="token punctuation">.</span><span class="token function">getA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    test<span class="token punctuation">.</span><span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">InterfaceTest</span> interfaceTest <span class="token operator">=</span> test<span class="token punctuation">;</span>
    <span class="token comment">// Error - cannot resolve method &#39;testInterface&#39; in &#39;InterfaceTest&#39;</span>
    interfaceTest<span class="token punctuation">.</span><span class="token function">testInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>happy:happy:</p><h2 id="å‚è€ƒæ–‡çŒ®" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒæ–‡çŒ®" aria-hidden="true">#</a> å‚è€ƒæ–‡çŒ®</h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p>[Writing Your First Kotlin Compiler Plugin (jetbrains.com)](https://resources.jetbrains.com/storage/products/kotlinconf2018/slides/5_Writing Your First Kotlin Compiler Plugin.pdf) <a href="#footnote-ref1" class="footnote-backref">â†©ï¸</a></p></li></ol></section>`,74);function q(w,x){const a=l("ExternalLinkIcon");return o(),p("div",null,[d,k,n("p",null,[s("æ¥"),n("a",v,[s("Kotlin-KCPçš„åº”ç”¨-ç¬¬ä¸€ç¯‡"),e(a)]),s("ï¼Œæœ¬æ–‡æ˜¯ç¬¬äºŒç¯‡ï¼Œä»¥ä¸‹æ˜¯æœ¬æ–‡çš„ç›®æ ‡ï¼š")]),m,g,b,n("p",null,[h,s(" å³ "),n("a",f,[C,e(a)]),s("ï¼ŒKSP ç›®å‰åªèƒ½ç”Ÿæˆä»£ç ï¼Œä¸èƒ½ä¿®æ”¹å­—èŠ‚ç ï¼Œç¬¬ä¸€ç¯‡ä¸­çš„é—®é¢˜éœ€è¦ä¿®æ”¹å­—èŠ‚ç ï¼Œå› æ­¤ KSP ä¸èƒ½æ»¡è¶³éœ€æ±‚")]),y])}const I=t(r,[["render",q],["__file","Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡.html.vue"]]);export{I as default};
