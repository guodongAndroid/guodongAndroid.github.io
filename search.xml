<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Androidä¸­å…³äºscrollByçš„ä¸€ç‚¹ç‚¹å¿ƒå¾—</title>
    <url>/2016/06/01/Android%E4%B8%AD%E5%85%B3%E4%BA%8EscrollBy%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E5%BF%83%E5%BE%97/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br />
<a href="http://blog.csdn.net/guodongandroid/article/details/51558131">http://blog.csdn.net/guodongandroid/article/details/51558131</a><br />
æœ¬æ–‡æ¥è‡ª<a href="http://www.sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h3 id="ä¸€-æ¦‚è¿°"><a class="markdownIt-Anchor" href="#ä¸€-æ¦‚è¿°"></a> ä¸€ã€æ¦‚è¿°</h3>
<p>æœ€è¿‘å¯¹è‡ªå®šä¹‰Viewå’ŒåŠ¨ç”»è¿›è¡Œäº†ç ”ç©¶å­¦ä¹ ï¼ŒåŒæ—¶ä¹‹å‰ä¸å¤ªæ˜ç™½çš„åœ°æ–¹ä¹Ÿè±ç„¶å¼€æœ—ã€‚å­¦ä¹ ä¸æ˜¯ä¸€ä¸‹å­å°±å­¦ä¼šçš„ï¼Œä¸æ‡‚çš„åœ°æ–¹ï¼Œåœ¨åç»­çš„å­¦ä¹ è¿‡ç¨‹ä¸­ä¼šæ…¢æ…¢çš„ç†è§£ï¼Œæœ‰ç§æ‹¨äº‘è§æ—¥çš„æ„Ÿè§‰ã€‚<br />
scrollBy(int dx, int dy)ä¸»è¦ç”¨äºæ»‘å±æ“ä½œï¼Œç¬¬ä¸€ä¸ªå‚æ•°dxä»£è¡¨æ»‘å±åä¸æ»‘å±å‰çš„xåæ ‡ä¹‹å·®ï¼Œç¬¬äºŒä¸ªå‚æ•°dyåŒç†ã€‚é‚£ä¸‹é¢æˆ‘ä»¬æ¥è¯•è¯•å§ã€‚</p>
<h3 id="äºŒ-è‡ªå®šä¹‰viewä½¿ç”¨scrollby"><a class="markdownIt-Anchor" href="#äºŒ-è‡ªå®šä¹‰viewä½¿ç”¨scrollby"></a> äºŒã€è‡ªå®šä¹‰Viewï¼Œä½¿ç”¨scrollBy</h3>
<p>é¦–å…ˆæˆ‘ä»¬æ–°å»ºäº†ç±»DragViewç»§æ‰¿è‡ªButton</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DragView</span> <span class="keyword">extends</span> <span class="title class_">Button</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownX;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DragView</span><span class="params">(Context context)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DragView</span><span class="params">(Context context, AttributeSet attrs)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DragView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        setBackgroundColor(<span class="number">0x88FF0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getAction())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                mDownX = (<span class="type">int</span>) event.getX();</span><br><span class="line">                mDownY = (<span class="type">int</span>) event.getY();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="type">int</span> <span class="variable">mX</span> <span class="operator">=</span> (<span class="type">int</span>) event.getX();</span><br><span class="line">                <span class="type">int</span> <span class="variable">mY</span> <span class="operator">=</span> (<span class="type">int</span>) event.getY();</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">dX</span> <span class="operator">=</span> mX - mDownX;</span><br><span class="line">                <span class="type">int</span> <span class="variable">dY</span> <span class="operator">=</span> mY - mDownY;</span><br><span class="line"></span><br><span class="line">                scrollBy(dX, dY);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è®¾ç½®äº†æµ…çº¢è‰²çš„èƒŒæ™¯ï¼Œå£°æ˜äº†ä¸¤ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶é‡å†™äº†onTouchEventæ–¹æ³•ï¼Œé‡Œé¢åˆ¤æ–­äº†å•å‡»å’Œæ»‘åŠ¨äº‹ä»¶ï¼Œå•å‡»æ—¶è®°å½•xå’Œyçš„åæ ‡ï¼Œèµ‹å€¼ç»™mDownXå’ŒmDownYï¼Œæ»‘åŠ¨çš„æ—¶å€™ä¹Ÿè·å–xå’Œyçš„åæ ‡ï¼Œå’Œå•å‡»æ—¶çš„åæ ‡ç›¸å‡å–å¾—åç§»é‡ï¼Œè°ƒç”¨scrollByæ–¹æ³•ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬åœ¨å¸ƒå±€ä¸­ä½¿ç”¨ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.androidqyz.DragView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;100dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;100dp&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¾ˆç®€å•å§ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š</p>
<p><img data-src="http://img.blog.csdn.net/20160601180554090" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å’¦ï¼Œå’‹æ»‘ä¸åŠ¨å‘¢ï¼Ÿï¼ˆæˆ‘æ˜¯çœŸçš„æ»‘äº†ï¼Œä¸æ˜¯åœ¨æ»‘åŠ¨é¼ æ ‡ï¼‰å…ˆä¸ç®¡ä¸ºå•¥æ‹–ä¸åŠ¨ã€‚æˆ‘ä»¬åœ¨å¸ƒå±€ä¸­æ·»åŠ å‡ ä¸ªå±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.androidqyz.DragView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;100dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;100dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;@string/app_name&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºè‡ªå®šä¹‰çš„Viewå¢åŠ äº†android:textå±æ€§ï¼Œé‡æ–°è¿è¡Œç¨‹åºï¼Œçœ‹çœ‹æ•ˆæœå¦‚ä½•ï¼š</p>
<p><img data-src="http://img.blog.csdn.net/20160601181009530" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å“ˆï¼Œç°åœ¨æ˜¯ä¸æ˜¯å¯ä»¥çœ‹åˆ°æ»‘åŠ¨çš„æ•ˆæœäº†å‘¢ï¼Ÿä¸å¯¹å•Šï¼Œæˆ‘ä»¬æ˜æ˜è‡ªå®šä¹‰çš„Viewï¼Œç°åœ¨ä¸ºå•¥æ‹–åŠ¨çš„ä¸æ˜¯Viewè€Œæ˜¯Viewé‡Œé¢çš„å­—å‘¢ï¼Œå•¥å­æƒ…å†µå“¦ï¼Ÿ</p>
<p>å…¶å®å‘¢ï¼Œåœ¨è‡ªå®šä¹‰Viewä¸­ç›´æ¥è°ƒç”¨scrollByæ»‘åŠ¨çš„æ˜¯Viewçš„Contentå†…å®¹ï¼Œå¯¹äºButtonï¼Œå®ƒçš„Contentå°±æ˜¯æ–‡æœ¬ï¼ŒImageViewå°±æ˜¯drawableäº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸çŸ¥ä½ ä»¬å‘ç°æ²¡æœ‰ï¼Ÿå¼€å§‹æ»‘åŠ¨æ—¶ï¼Œå¯ä»¥çœ‹åˆ°é¼ æ ‡æ˜¯å‘ä¸Šæ»‘åŠ¨çš„ï¼ŒæŒ‰ç…§äººä»¬çš„æ­£å¸¸æ€ç»´ï¼Œé‚£â€œAndroidQYZâ€è¿™å‡ ä¸ªå­—æ¯ä¹Ÿåº”è¯¥å‘ä¸Šæ»‘åŠ¨æ‰å¯¹ï¼Œè€Œç°åœ¨æ˜¯å‘ä¸‹æ»‘åŠ¨ã€‚</p>
<p>è¿™ä¸ªå°±ä¸å¤ªå¥½ç†è§£äº†ã€‚åšiOSå¼€å‘çš„åŒå­¦è‚¯å®šç”¨è¿‡UIScrolViewï¼Œæ²¡é”™ï¼Œçœ‹åˆ°è¿™æˆ‘æ‰æ˜ç™½Androidå’ŒiOSè¿™ä¹ˆç›¸ä¼¼ã€‚å…¶å®æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæˆ‘ä»¬å°±è¦çŸ¥é“å¸ƒå±€æ˜¯æ²¡æœ‰è¾¹ç•Œçš„ï¼Œå°±åƒå¾ˆå¤§ä¸€å—ç”»å¸ƒï¼Œè€Œæ‰‹æœºå±å¹•å°±åƒæ˜¯ä¸€ä¸ªæ”¾å¤§é•œï¼Œæ”¾å¤§äº†ç”»å¸ƒä¸Šçš„ä¸€å°éƒ¨åˆ†å†…å®¹ï¼Œå½“æˆ‘ä»¬æ»‘åŠ¨å±å¹•æ—¶ï¼Œç”»å¸ƒæ˜¯æ²¡æœ‰æ»‘åŠ¨çš„ï¼Œæ»‘åŠ¨çš„æ˜¯æ”¾å¤§é•œï¼Œå°±æ˜¯æˆ‘ä»¬çš„å±å¹•ï¼Œå¯ä»¥è¿™ä¹Ÿè¯´ï¼Œå½“æ”¾å¤§é•œå‘ä¸Šæ»‘åŠ¨æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç”»å¸ƒåœ¨å‘ä¸‹æ»‘åŠ¨ï¼Œè¿™å°±æ˜¯ä¸ºå•¥é¼ æ ‡æ˜æ˜å‘ä¸Šæ»‘åŠ¨ï¼Œè€Œâ€œAndroidQYZâ€è¿™å‡ ä¸ªå­—æ¯å´å‘ä¸‹æ»‘åŠ¨çš„åŸå› äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†ä¸ºå•¥ï¼Œé‚£æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆä¿®æ”¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">scroll<span class="constructor">By(-<span class="params">dX</span>, -<span class="params">dY</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>so easyï¼Œæ²¡é”™ï¼Œæˆ‘ä»¬å–äº†è´Ÿå€¼å°±å¯ä»¥äº†ï¼Œä¸ä¿¡ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img data-src="http://img.blog.csdn.net/20160601182849991" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œâ€œAndroidQYZâ€è¿™å‡ ä¸ªå­—æ¯å·²ç»è·Ÿéšé¼ æ ‡çš„ç§»åŠ¨è€Œç§»åŠ¨äº†ï¼Œå¯è¿˜æ˜¯æ²¡æœ‰è®©è‡ªå®šä¹‰Viewæ»‘åŠ¨å‘€ï¼Œä½ è¿™ä¸æ˜¯éª—äººå˜›ï¼Ÿä¸ç€æ€¥ï¼Œä¹‹å‰è¯´ç›´æ¥è°ƒç”¨scrollByæ»‘åŠ¨çš„æ˜¯Contentï¼Œè¿™å°±ç®€å•äº†ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨è‡ªå®šä¹‰Viewçš„çˆ¶Viewçš„scrollByä¸å°±å¥½äº†å˜›ï¼Œçœ‹ä¸‹é¢ï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">((View) get<span class="constructor">Parent()</span>).scroll<span class="constructor">By(-<span class="params">dX</span>, -<span class="params">dY</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>getParent()æ–¹æ³•è·å–æ­¤Viewçš„ViewParentå¹¶å¼ºè½¬ä¸ºViewï¼Œå†è°ƒç”¨scrollByæ–¹æ³•ï¼Œè¦ä¸è¦çœ‹çœ‹æ•ˆæœå‘¢ï¼Ÿå°±æ€•ä½ ä»¬ä¸ä¿¡ã€‚</p>
<p><img data-src="http://img.blog.csdn.net/20160601183447763" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å“ˆå“ˆï¼Œæ€ä¹ˆæ ·ï¼Œå¯ä»¥æ»‘åŠ¨äº†å§ã€‚å½“ç„¶è¿˜æœ‰scrollToæ–¹æ³•ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»è¯•è¯•ã€‚</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>scrollBy</tag>
      </tags>
  </entry>
  <entry>
    <title>AndroidStudioä¸­ä½¿ç”¨Aliyun Maven</title>
    <url>/2017/07/06/AndroidStudio%E4%B8%AD%E4%BD%BF%E7%94%A8Aliyun%20Maven/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br />
<a href="http://blog.csdn.net/guodongAndroid/article/details/74598095">http://blog.csdn.net/guodongAndroid/article/details/74598095</a><br />
æœ¬æ–‡æ¥è‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="androidstudioä¸­ä½¿ç”¨aliyun-maven"><a class="markdownIt-Anchor" href="#androidstudioä¸­ä½¿ç”¨aliyun-maven"></a> AndroidStudioä¸­ä½¿ç”¨Aliyun Maven</h2>
<p>Aliyun Mavenåœ°å€ï¼š<a href="http://maven.aliyun.com">http://maven.aliyun.com</a></p>
<p>åœ¨é¡¹ç›®çº§åˆ«çš„build.gradleä¸­æ·»åŠ å¦‚ä¸‹Mavenåœ°å€ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven&#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/groups/public/&#x27;</span>&#125;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.3.3&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven&#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/groups/public/&#x27;</span>&#125;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>androidstudio</tag>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Androidäº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†çš„ç†è§£</title>
    <url>/2016/06/21/Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E3%80%81%E6%8B%A6%E6%88%AA%E4%B8%8E%E5%A4%84%E7%90%86%E7%9A%84%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br />
<a href="http://blog.csdn.net/guodongAndroid/article/details/51727272">http://blog.csdn.net/guodongAndroid/article/details/51727272</a><br />
æœ¬æ–‡æ¥è‡ª<a href="www.sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="ä¸€-æ¦‚è¿°"><a class="markdownIt-Anchor" href="#ä¸€-æ¦‚è¿°"></a> ä¸€ã€æ¦‚è¿°</h2>
<p>æ˜¨å¤©ï¼ŒæŸä½é»‘åŒå­¦é—®äº†ä¸ªå¾ˆå¥‡è‘©çš„é—®é¢˜ï¼šç¦æ­¢ViewPagerçš„å·¦å³æ»‘åŠ¨ã€‚å¥½å§ï¼Œè¢«é—®åˆ°çš„ä¸€ç¬é—´å°±æƒ³æ˜¯ä¸æ˜¯ä»–å‚»Xã€‚ViewPagerä¸æ»‘åŠ¨ï¼Œå¹²å˜›è¿˜è¦ç”¨ViewPagerï¼Œå”‰ï¼Œæ— è¯­ã€‚æ— è¯­å½’æ— è¯­ï¼Œäº‹æƒ…è¿˜æ˜¯è¦å¹²çš„ã€‚éšæ‰‹ç»™ä»–å†™äº†ä¸ªè‡ªå®šä¹‰çš„ViewPagerã€‚ã€‚ã€‚ã€‚(å¹ç‰›ä¸€ç‚¹éƒ½ä¸å¥½)</p>
<h2 id="äºŒ-äº‹ä»¶åˆ†å‘-æ‹¦æˆªä¸å¤„ç†"><a class="markdownIt-Anchor" href="#äºŒ-äº‹ä»¶åˆ†å‘-æ‹¦æˆªä¸å¤„ç†"></a> äºŒã€äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†</h2>
<p>é¦–å…ˆéœ€è¦çŸ¥é“äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†åˆ†åˆ«å¯¹åº”ç€</p>
<ol>
<li>dispatchTouchEvent(MotionEvent ev)</li>
<li>onInterceptTouchEvent(MotionEvent ev)</li>
<li>onTouchEvent(MotionEvent event)</li>
</ol>
<p>ViewGroupæ¯”Viewå¤šäº†<code>onInterceptTouchEvent(MotionEvent ev)</code>æ–¹æ³•ï¼Œå³äº‹ä»¶æ‹¦æˆªæ–¹æ³•ã€‚å› ä¸ºViewGroupå¯ä»¥åŒ…å«å­Viewï¼Œæ‰€ä»¥ä¸å­Viewçš„äº‹ä»¶æœ‰å†²çªæ—¶å¯ä»¥è¿›è¡Œæ‹¦æˆªã€‚</p>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•é»˜è®¤è¿”å›å€¼éƒ½ä¸ºfalseã€‚</p>
<p>ä¸‹é¢çœ‹ä¸ªä¾‹å­ä¼šæ›´å®¹æ˜“ç†è§£ï¼š<br />
è‡ªå®šä¹‰äº†ä¸¤ä¸ªLinearLayoutå’Œä¸€ä¸ªViewï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p>FirstViewGroup.java</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstViewGroup</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = <span class="string">&quot;FirstViewGroup&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FirstViewGroup</span><span class="params">(Context context)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FirstViewGroup</span><span class="params">(Context context, AttributeSet attrs)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FirstViewGroup</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        setBackgroundColor(<span class="number">0x88FF0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;dispatchTouchEvent:&quot;</span> + ev.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">dispatchTouchEvent</span><span class="params">(ev)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onInterceptTouchEvent:&quot;</span> + ev.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onInterceptTouchEvent</span><span class="params">(ev)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onTouchEvent:&quot;</span> + event.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onTouchEvent</span><span class="params">(event)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SecondViewGroup.java</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondViewGroup</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = <span class="string">&quot;SecondViewGroup&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondViewGroup</span><span class="params">(Context context)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondViewGroup</span><span class="params">(Context context, AttributeSet attrs)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondViewGroup</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        setBackgroundColor(<span class="number">0x88FFFF00</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;dispatchTouchEvent:&quot;</span> + ev.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">dispatchTouchEvent</span><span class="params">(ev)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onInterceptTouchEvent:&quot;</span> + ev.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onInterceptTouchEvent</span><span class="params">(ev)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onTouchEvent:&quot;</span> + event.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onTouchEvent</span><span class="params">(event)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyView.java</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyView</span> <span class="keyword">extends</span> <span class="title">View</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = <span class="string">&quot;MyView&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        setBackgroundColor(<span class="number">0x6600FF00</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;dispatchTouchEvent: &quot;</span> + event.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">dispatchTouchEvent</span><span class="params">(event)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onTouchEvent: &quot;</span> + event.getAction());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onTouchEvent</span><span class="params">(event)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªViewGroupå®ç°äº†äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†ä¸‰ä¸ªæ–¹æ³•ï¼Œå¹¶æ‰“å°äº†Logï¼ŒMyViewå®ç°äº†äº‹ä»¶åˆ†å‘ä¸å¤„ç†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹Ÿæ‰“å°äº†Logã€‚</p>
<p>ä¸‹é¢çœ‹çœ‹å¸ƒå±€æ–‡ä»¶ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">&lt;RelativeLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">              android:orientation=<span class="string">&quot;vertical&quot;</span></span><br><span class="line">              android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">              android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com<span class="selector-class">.sun</span><span class="selector-class">.androidqyz</span><span class="selector-class">.FirstViewGroup</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">padding</span>=<span class="string">&quot;40dp&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;com<span class="selector-class">.sun</span><span class="selector-class">.androidqyz</span><span class="selector-class">.SecondViewGroup</span></span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:<span class="attribute">padding</span>=<span class="string">&quot;60dp&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">            &lt;com<span class="selector-class">.sun</span><span class="selector-class">.androidqyz</span><span class="selector-class">.MyView</span></span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br><span class="line">        &lt;/com<span class="selector-class">.sun</span><span class="selector-class">.androidqyz</span>.SecondViewGroup&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/com<span class="selector-class">.sun</span><span class="selector-class">.androidqyz</span>.FirstViewGroup&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621140248957" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å¯ä»¥çœ‹åˆ°æœ€å¤–å±‚çš„ViewGroupçš„èƒŒæ™¯è‰²æ˜¯æµ…çº¢è‰²ï¼Œç¬¬äºŒå±‚çš„ViewGroupçš„èƒŒæ™¯è‰²æ˜¯æ©™è‰²ï¼Œæœ€é‡Œé¢çš„ViewèƒŒæ™¯è‰²æ˜¯ç»¿è‰²ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ç‚¹å‡»æœ€å¤–å±‚çš„ViewGroupï¼Œçœ‹ä¸‹æ‰“å°çš„Logå¦‚ä¸‹ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621140718608" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å¯ä»¥å‘ç°äº‹ä»¶å¤„ç†çš„é¡ºåºæ˜¯å…ˆè°ƒç”¨äº‹ä»¶åˆ†å‘(dispatchTouchEvent)â€”â€”&gt;äº‹ä»¶æ‹¦æˆª(onInterceptTouchEvent)â€”â€”&gt;äº‹ä»¶å¤„ç†(onTouchEvent)</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç‚¹å‡»ç¬¬äºŒå±‚ViewGroupï¼Œçœ‹ä¸‹æ‰“å°çš„Logå¦‚ä¸‹ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621141112922" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å¯ä»¥å‘ç°ç°åœ¨äº‹ä»¶å¤„ç†çš„é¡ºåºæ˜¯å…ˆè°ƒç”¨FirstViewGroupäº‹ä»¶åˆ†å‘(dispatchTouchEvent)â€”â€”&gt;FirstViewGroupäº‹ä»¶æ‹¦æˆª(onInterceptTouchEvent)â€”â€”&gt;SecondViewGroupäº‹ä»¶åˆ†å‘(dispatchTouchEvent)â€”â€”&gt;SecondViewGroupäº‹ä»¶æ‹¦æˆª(onInterceptTouchEvent)â€”â€”&gt;SecondViewGroupäº‹ä»¶å¤„ç†(onTouchEvent)â€”â€”&gt;FirstViewGroupäº‹ä»¶å¤„ç†(onTouchEvent)</p>
<p>ç›¸ä¿¡çœ‹åˆ°è¿™ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»MyViewçš„æ—¶å€™ï¼Œæ‰“å°çš„Logæ‚¨å·²ç»çŸ¥é“æ˜¯ä»€ä¹ˆäº†ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å§ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621141627195" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>æ˜¯ä¸æ˜¯å’Œä½ æƒ³çš„ä¸€æ ·å‘¢ï¼Ÿäº‹ä»¶çš„åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†å°±åƒç°å®ç”Ÿæ´»ä¸­é¢†å¯¼Aåˆ†å‘ä¸ªä»»åŠ¡ç»™é¢†å¯¼Bï¼Œé¢†å¯¼å†æŠŠä»»åŠ¡åˆ†å‘ç»™ä½ (MyView)ï¼Œä½ å¤„ç†(onTouchEvent)å®Œæ—¶éœ€è¦å‘ä¸Šæ±‡æŠ¥ç»™é¢†å¯¼Bï¼Œé¢†å¯¼Bå¤„ç†(onTouchEvent)å®Œï¼Œå†æ±‡æŠ¥ç»™é¢†å¯¼Aã€‚</p>
<p>åœ¨è‡ªå®šä¹‰æ§ä»¶æ—¶ï¼Œå¾ˆå°‘å»å¤å†™dispatchTouchEventæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªçœ‹äº‹ä»¶æ‹¦æˆª(onInterceptTouchEvent)ã€‚</p>
<p>å¦‚æœé¢†å¯¼Aè§‰å¾—è¿™ä¸ªä»»åŠ¡è‡ªå·±å°±å¯ä»¥å®Œæˆï¼Œå°±ä¸å»æ´¾ç»™é¢†å¯¼Bï¼Œæˆ‘ä»¬å°±æŠŠFirstViewGroupçš„onInterceptTouchEventæ–¹æ³•è¿”å›trueï¼Œå½“æˆ‘ä»¬ç‚¹å‡»SecondViewGroupæˆ–MyViewæ—¶ï¼Œæˆ‘ä»¬çœ‹ä¸‹Logï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621142644803" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>è¯´æ˜æ­¤æ—¶é¢†å¯¼Aå·²ç»æŠŠä»»åŠ¡æ‹¦æˆªä¸‹ï¼Œè‡ªå·±å¤„ç†äº†ï¼Œå¦‚æœé¢†å¯¼Bæ‹¦æˆªäº†ä»»åŠ¡ä¼šæ˜¯æ€æ ·çš„å‘¢ï¼Ÿç‚¹å‡»MyViewæ—¶çš„Logå¦‚ä¸‹ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621142953355" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å¦‚æœä½ (MyView)å—ä¸äº†é¢†å¯¼çš„å‹è¿«ï¼Œè¦åæŠ—ï¼Œå¤„ç†å®Œä»»åŠ¡åè¿”å›äº†trueï¼Œç‚¹å‡»MyViewçš„Logå¦‚ä¸‹ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160621143752257" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>çœ‹æ¥æ˜¯çœŸè¦åæŠ—äº†ï¼Œå¤„ç†å®Œä»»åŠ¡éƒ½ä¸å‘é¢†å¯¼æ±‡æŠ¥äº†ã€‚</p>
<h2 id="ä¸‰-æ€»ç»“"><a class="markdownIt-Anchor" href="#ä¸‰-æ€»ç»“"></a> ä¸‰ã€æ€»ç»“</h2>
<p>Androidäº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†æ˜¯ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­è¿ç”¨çš„åœºæ™¯ä¹Ÿå¾ˆå¤šï¼Œæ˜¯Androidå¼€å‘å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚ç°åœ¨å›è¿‡å¤´æ¥ï¼Œä¸ä»æºç çš„è§’åº¦çœ‹çœ‹Androidçš„äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸å¤„ç†å’Œç°å®ç”Ÿæ´»ä¸­çš„é¢†å¯¼åˆ†æ´¾ä»»åŠ¡åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>äº‹ä»¶åˆ†å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Viewæ»‘åŠ¨å†²çªçš„ä¸¤ç§è§£å†³æ–¹å¼</title>
    <url>/2016/09/13/View%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br />
<a href="http://blog.csdn.net/guodongAndroid/article/details/52530227">http://blog.csdn.net/guodongAndroid/article/details/52530227</a><br />
æœ¬æ–‡æ¥è‡ª<a href="http://www.sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="viewæ»‘åŠ¨å†²çªçš„ä¸¤ç§è§£å†³æ–¹å¼"><a class="markdownIt-Anchor" href="#viewæ»‘åŠ¨å†²çªçš„ä¸¤ç§è§£å†³æ–¹å¼"></a> Viewæ»‘åŠ¨å†²çªçš„ä¸¤ç§è§£å†³æ–¹å¼</h2>
<h3 id="1-å¤–éƒ¨æ‹¦æˆªæ³•"><a class="markdownIt-Anchor" href="#1-å¤–éƒ¨æ‹¦æˆªæ³•"></a> 1ã€å¤–éƒ¨æ‹¦æˆªæ³•</h3>
<p>æ‰€è°“å¤–éƒ¨æ‹¦æˆªæ³•æ˜¯æŒ‡ç‚¹å‡»äº‹ä»¶éƒ½å…ˆç»è¿‡çˆ¶å®¹å™¨çš„æ‹¦æˆªå¤„ç†ï¼Œå¦‚æœçˆ¶å®¹å™¨éœ€è¦æ­¤äº‹ä»¶å°±æ‹¦æˆªï¼Œå¦‚æœä¸éœ€è¦æ­¤äº‹ä»¶å°±ä¸æ‹¦æˆªï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ»‘åŠ¨å†²çªé—®é¢˜ï¼Œè¿™ç§æ–¹æ³•æ¯”è¾ƒç¬¦åˆç‚¹å‡»äº‹ä»¶çš„åˆ†å‘æœºåˆ¶ã€‚å¤–éƒ¨æ‹¦æˆªæ³•éœ€è¦é‡å†™çˆ¶å®¹å™¨çš„onInterceptTouchEventæ–¹æ³•ï¼Œåœ¨å†…éƒ¨åšç›¸åº”çš„æ‹¦æˆªå³å¯ï¼Œè¿™ç§æ–¹æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">bool</span>ean onInterceptTouchEvent(MotionEvent ev)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">bool</span>ean <span class="built_in">int</span>ercepted = <span class="literal">false</span>;</span><br><span class="line">       <span class="built_in">int</span> x = (<span class="built_in">int</span>) ev.getX();</span><br><span class="line">       <span class="built_in">int</span> y = (<span class="built_in">int</span>) ev.getY();</span><br><span class="line">       <span class="built_in">int</span> action = ev.getAction();</span><br><span class="line">       <span class="keyword">switch</span> (action)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">int</span>ercepted = <span class="literal">false</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span> (çˆ¶å®¹å™¨éœ€è¦å½“å‰ç‚¹å‡»äº‹ä»¶)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="built_in">int</span>ercepted = <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="built_in">int</span>ercepted = <span class="literal">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">int</span>ercepted = <span class="literal">false</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mLastXIntercept = x;</span><br><span class="line">       mLastYIntercept = y;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">int</span>ercepted;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç æ˜¯å¤–éƒ¨æ‹¦æˆªæ³•çš„å…¸å‹é€»è¾‘ï¼Œé’ˆå¯¹ä¸åŒçš„æ»‘åŠ¨å†²çªï¼Œåªéœ€è¦ä¿®æ”¹çˆ¶å®¹å™¨éœ€è¦å½“å‰ç‚¹å‡»äº‹ä»¶çš„æ¡ä»¶å³å¯ï¼Œå…¶ä»–å‡ä¸éœ€è¦ä¿®æ”¹è€Œä¸”ä¹Ÿä¸èƒ½ä¿®æ”¹ã€‚åœ¨onInterceptTouchEventæ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯ACTION_DOWNè¿™ä¸ªäº‹ä»¶ï¼Œçˆ¶å®¹å™¨å¿…é¡»è¿”å›falseï¼Œå³ä¸æ‹¦æˆªDOWNäº‹ä»¶ï¼Œè¿™æ˜¯å› ä¸ºä¸€æ—¦çˆ¶å®¹å™¨æ‹¦æˆªäº†DOWNäº‹ä»¶ï¼Œé‚£ä¹ˆåç»­çš„MOVEå’ŒUPäº‹ä»¶éƒ½ä¼šç›´æ¥äº¤ç”±çˆ¶å®¹å™¨å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™äº‹ä»¶æ²¡æ³•å†ä¼ é€’ç»™å­å…ƒç´ äº†ï¼›å…¶æ¬¡æ˜¯ACTION_MOVEäº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶å¯ä»¥æ ¹æ®éœ€æ±‚æ¥å†³å®šæ˜¯å¦æ‹¦æˆªï¼Œå¦‚æœçˆ¶å®¹å™¨éœ€è¦æ‹¦æˆªå°±è¿”å›trueï¼Œå¦åˆ™è¿”å›falseï¼›æœ€åæ˜¯ACTION_UPäº‹ä»¶ï¼Œè¿™é‡Œå¿…é¡»è¿”å›falseã€‚</p>
<h3 id="2-å†…éƒ¨æ‹¦æˆªæ³•"><a class="markdownIt-Anchor" href="#2-å†…éƒ¨æ‹¦æˆªæ³•"></a> 2ã€å†…éƒ¨æ‹¦æˆªæ³•</h3>
<p>å†…éƒ¨æ‹¦æˆªæ³•æ˜¯æŒ‡çˆ¶å®¹å™¨ä¸æ‹¦æˆªä»»ä½•äº‹ä»¶ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½ä¼ é€’ç»™å­å…ƒç´ ï¼Œå¦‚æœå­å…ƒç´ éœ€è¦æ­¤äº‹ä»¶å°±ç›´æ¥æ¶ˆè€—æ‰ï¼Œå¦åˆ™å°±äº¤ç”±çˆ¶å®¹å™¨è¿›è¡Œå¤„ç†ï¼Œè¿™ç§æ–¹æ³•ä¸ç¬¦åˆäº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Œéœ€è¦é…åˆrequstDisallowInterceptTouchEventæ–¹æ³•æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œä½¿ç”¨èµ·æ¥è¾ƒå¤–éƒ¨æ‹¦æˆªæ³•ç¨æ˜¾å¤æ‚ï¼Œéœ€è¦é‡å†™å­å…ƒç´ çš„dispatchTouchEventæ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX();</span><br><span class="line">       <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY();</span><br><span class="line">       <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">switch</span> (action)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">           &#123;</span><br><span class="line">               parentView.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>); <span class="comment">// parentViewä¸ºçˆ¶å®¹å™¨</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">int</span> deltaX = x - mLastDiapatchX;</span><br><span class="line">               <span class="keyword">int</span> deltaY = y - mLastDiapatchY;</span><br><span class="line">               <span class="keyword">if</span> (çˆ¶å®¹å™¨éœ€è¦æ­¤ç‚¹å‡»äº‹ä»¶)</span><br><span class="line">               &#123;</span><br><span class="line">                   parentView.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>); <span class="comment">// parentViewä¸ºçˆ¶å®¹å™¨</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mLastDiapatchX = x;</span><br><span class="line">       mLastDiapatchY = y;</span><br><span class="line">       <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">dispatchTouchEvent</span><span class="params">(ev)</span></span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç æ˜¯å†…éƒ¨æ‹¦æˆªæ³•çš„å…¸å‹ä»£ç ï¼Œå½“é¢å¯¹ä¸åŒçš„æ»‘åŠ¨å†²çªæ—¶åªéœ€è¦ä¿®æ”¹é‡Œé¢çš„æ¡ä»¶å³å¯ï¼Œå…¶ä»–ä¸éœ€è¦æ”¹åŠ¨è€Œä¸”ä¹Ÿä¸èƒ½æ”¹åŠ¨ã€‚é™¤äº†å­å…ƒç´ éœ€è¦åšå¤„ç†ä»¥å¤–ï¼Œçˆ¶å®¹å™¨ä¹Ÿéœ€è¦é»˜è®¤æ‹¦æˆªé™¤äº†ACTION_DOWNä»¥å¤–çš„å…¶ä»–äº‹ä»¶ï¼Œè¿™æ ·å½“å­å…ƒç´ è°ƒç”¨<code>parentView.requestDisallowInterceptTouchEvent(false)</code>æ–¹æ³•æ—¶ï¼Œçˆ¶å®¹å™¨æ‰èƒ½ç»§ç»­æ‹¦æˆªæ‰€éœ€äº‹ä»¶ã€‚çˆ¶å®¹å™¨ä¸ºä»€ä¹ˆä¸æ‹¦æˆªDOWNäº‹ä»¶å·²åœ¨å¤–éƒ¨æ‹¦æˆªæ³•ä¸­å™è¿°ï¼Œçˆ¶å®¹å™¨çš„æ”¹åŠ¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line">       <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN)</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>view</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨Kotlinå¼€å‘Android(ä¸€) Kotlinå¼€å‘ç¯å¢ƒæ­å»º</title>
    <url>/2017/07/11/%E4%BD%BF%E7%94%A8Kotlin%E5%BC%80%E5%8F%91Android(%E4%B8%80)Kotlin%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>
<p><a href="http://sunxiaodou.com/2017/07/11/%E4%BD%BF%E7%94%A8Kotlin%E5%BC%80%E5%8F%91Android(%E4%B8%80)Kotlin%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">http://sunxiaodou.com/2017/07/11/ä½¿ç”¨Kotlinå¼€å‘Android(ä¸€)Kotlinå¼€å‘ç¯å¢ƒæ­å»º/</a></p>
<p>æœ¬æ–‡æ¥è‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>Kotlinï¼š<a href="http://kotlinlang.org">å®˜ç½‘</a><br />
Kotlinè¯­æ³•ï¼š<a href="https://huanglizhuo.gitbooks.io/kotlin-in-chinese/content/GettingStarted/Basic-Syntax.html">åŸºæœ¬è¯­æ³•-ä¸­æ–‡</a></p>
<p>Kotlinæ•™ç¨‹ï¼š<a href="https://www.youtube.com/watch?v=H_oGi8uuDpA">è§†é¢‘æ•™ç¨‹</a></p>
<h2 id="kotlin-for-android"><a class="markdownIt-Anchor" href="#kotlin-for-android"></a> Kotlin for Android</h2>
<h3 id="androidstudioé›†æˆkotlinæ’ä»¶"><a class="markdownIt-Anchor" href="#androidstudioé›†æˆkotlinæ’ä»¶"></a> AndroidStudioé›†æˆKotlinæ’ä»¶</h3>
<ol>
<li>
<p>æ‰“å¼€AndroidStudioçš„Preferencesç•Œé¢ï¼Œé€‰æ‹©Pluginsï¼Œç‚¹å‡»ç®­å¤´æ‰€æŒ‡æŒ‰é’®</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/plugins1.png" alt="Install JetBrains plugins" /></p>
</li>
<li>
<p>è¾“å…¥Kotlinæœç´¢æ’ä»¶</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/plugins2.png" alt="æœç´¢Kotlin" /></p>
</li>
<li>
<p>å› ä¸ºæˆ‘å·²ç»å®‰è£…è¿‡äº†ï¼Œæ‰€ä»¥æ²¡æœ‰äº†InstallæŒ‰é’®ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ æŒ‰ç…§å¦‚ä¸Šæ­¥éª¤å®‰è£…æ’ä»¶ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä¸‹è½½çš„å¾ˆæ…¢ã€‚æ˜¯ä¸æ˜¯å¾ˆå‘çˆ¹ï¼Œæ—¢ç„¶ä¸‹è½½çš„é‚£ä¹ˆæ…¢ï¼Œä½ è¿˜å•°å—¦è¾£ä¹ˆä¹…ï¼ŒğŸ˜†ï¼Œæœ‰äº›äº‹æ€»å¾—è‡ªå·±æ£é¼“æ£é¼“ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ç¦»çº¿å®‰è£…Kotlinæ’ä»¶ã€‚<a href="https://plugins.jetbrains.com/plugin/6954-kotlin">Kotlinæ’ä»¶ä¸‹è½½åœ°å€</a>ã€‚ä¸‹è½½å¸¦æœ‰â€œStudio&quot;å­—æ ·çš„æ–‡ä»¶ï¼Œâ€IJâ€œæ˜¯ç»™IntelliJ IDEAä½¿ç”¨çš„ã€‚</p>
<p>(âŠ™oâŠ™)å“¦ï¼Œè®°å¾—ä½¿ç”¨è¿…é›·ç­‰è½¯ä»¶ä¸‹è½½å“¦ğŸ˜‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/QQ20170711-200501@2x.png" alt="kotlinç¦»çº¿ä¸‹è½½" /></p>
</li>
<li>
<p>æ ¹æ®ä¸‹å›¾ç¦»çº¿å®‰è£…ï¼Œå®‰è£…å®Œæˆé‡å¯AndroidStudioå³å¯ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/pugin%1Cs3.png" alt="Install plugins from disk" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/plugins4.png" alt="é€‰æ‹©kotlinæ’ä»¶" /></p>
</li>
</ol>
<h3 id="hello-kotlin"><a class="markdownIt-Anchor" href="#hello-kotlin"></a> Hello Kotlin</h3>
<p>åƒå¹³å¸¸ä¸€æ ·åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¦‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/QQ20170711-202047@2x.png" alt="MyKoltin" /></p>
<p>ç„¶åç‚¹å‡»Codeï¼Œé€‰æ‹©Convert Java File to Kotlin Fileï¼Œå³å¯æŠŠJavaæ–‡ä»¶æ— ç¼è½¬æ¢ä¸ºKotlinæ–‡ä»¶</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/QQ20170711-202821@2x.png" alt="convert java to kotlin" /></p>
<p>è½¬æ¢åçš„kotlinæ–‡ä»¶</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/koltlin.png" alt="kotlinæ–‡ä»¶" /></p>
<p>ç°åœ¨æˆ‘ä»¬ç‚¹å‡»åŒæ­¥æŒ‰é’®ï¼Œå¹¶é…ç½®Kotlinï¼Œå¦‚ä¸‹å›¾</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/config.png" alt="configure" /></p>
<p>åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©æœ€æ–°æœ€æ–°çš„Kotlinç‰ˆæœ¬ï¼Œç‚¹å‡»OKï¼Œæœ€åç‚¹å‡»å³ä¸Šè§’çš„Sync NowæŒ‰é’®ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/xuanzhe.png" alt="version" /></p>
<p>ç¨ç­‰ç‰‡åˆ»ï¼Œå°±ä¼šè‡ªåŠ¨æ‰“å¼€é¡¹ç›®çº§åˆ«å’ŒModuleçº§åˆ«çš„build.gradleæ–‡ä»¶ã€‚å¦‚ä¸‹å›¾ï¼Œkotliné…ç½®å®Œæˆ</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/mykotlin.png" alt="MyKotlin build.gradle" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/app.png" alt="app build.gradle" /></p>
<p>ä¸å‡ºæ„å¤–çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œçœ‹åˆ°Hello Worldäº†ğŸ˜†</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/MyKotlin-Run.png" alt="hello world" /></p>
<p>è¯´å¥½çš„Hello Kotlinå‘¢ï¼Ÿï¼Ÿï¼Ÿåœ¨appçš„build.gradleåŠ å…¥ä»¥ä¸‹å†…å®¹å¹¶åŒæ­¥é¡¹ç›®ã€‚æ­¤æ‹“å±•å¯ä»¥çœå»findViewById()ï¼Œç›´æ¥ä½¿ç”¨æ§ä»¶çš„idã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;kotlin-android-extensions&#x27;</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ç»™TextViewæ·»åŠ ä¸€ä¸ªid â€”&gt; kotlinã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/id.png" alt="id" /></p>
<p>åœ¨MainActivity.ktæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œæˆ‘ä»¬çš„Hello Kotlinå°±å®Œæˆäº†ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/hello%20kotlin.png" alt="hello kotlin" /></p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>AndroidStudio</tag>
        <tag>Kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaé€šè¿‡ESLè¿æ¥FreeSWITCH</title>
    <url>/2017/08/02/java-esl-freeswitch/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>
<p><a href="http://sunxiaodou.com/2017/08/02/Java%E9%80%9A%E8%BF%87ESL%E8%BF%9E%E6%8E%A5FreeSWITCH/">http://sunxiaodou.com/2017/08/02/Javaé€šè¿‡ESLè¿æ¥FreeSWITCH/</a></p>
<p>æœ¬æ–‡æ¥è‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="javaé€šè¿‡eslè¿æ¥freeswitch"><a class="markdownIt-Anchor" href="#javaé€šè¿‡eslè¿æ¥freeswitch"></a> Javaé€šè¿‡ESLè¿æ¥FreeSWITCH</h2>
<h3 id="åˆ›å»ºgradleé¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºgradleé¡¹ç›®"></a> åˆ›å»ºGradleé¡¹ç›®</h3>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºäºGradleçš„Javaå·¥ç¨‹ï¼Œå¹¶æ·»åŠ FreeSWITCH ESLçš„Javaä¾èµ–ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="string">&#x27;org.freeswitch.esl.client:org.freeswitch.esl.client:0.9.2&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/freeswitch/QQ20170802-152052@2x.png" alt="Project" /></p>
<p>åˆ›å»ºESLTest.javaæ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(ESLTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> <span class="string">&quot;192.168.1.22&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8021</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;ClueCon&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">job_UUID</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        InBound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">InBound</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Client</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.connect(HOST, PORT, PASSWORD, <span class="number">20</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Connect Failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        client.addEventListener(<span class="keyword">new</span> <span class="title class_">IEslEventListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eventReceived</span><span class="params">(EslEvent event)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event.getEventName().equals(<span class="string">&quot;CHANNEL_ANSWER&quot;</span>)) &#123; <span class="comment">//</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;é€šé“åº”ç­”&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getEventName().equals(<span class="string">&quot;HEARTBEAT&quot;</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ”¶åˆ°å¿ƒè·³ --&gt; &quot;</span> + event.getEventBodyLines());</span><br><span class="line">                    job_UUID = client.sendAsyncApiCommand(<span class="string">&quot;status&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Job_UUID --&gt; &quot;</span> + job_UUID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getEventName().equals(<span class="string">&quot;CHANNEL_DESTROY&quot;</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é€šé“é”€æ¯&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getEventName().equals(<span class="string">&quot;CHANNEL_HANGUP_COMPLETE&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">//æŒ‚æ–­</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;é€šé“æŒ‚æ–­å®Œæˆ&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getEventName().equals(<span class="string">&quot;CHANNEL_CREATE&quot;</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é€šé“åˆ›å»º&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundJobResultReceived</span><span class="params">(EslEvent event)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> event.getEventHeaders().get(<span class="string">&quot;Job-UUID&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (job_UUID.equals(uuid)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String s : event.getEventBodyLines()) &#123;</span><br><span class="line">                        System.out.println(s);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        client.setEventSubscriptions(<span class="string">&quot;plain&quot;</span>, <span class="string">&quot;all&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨InBoundæ¨¡å¼ä¸FreeSWITCHè¿›è¡Œè¿æ¥ï¼Œæˆ‘è¿™è¾¹çš„FreeSWITCHè¿è¡Œåœ¨192.168.1.22æœºå™¨ä¸Šï¼ŒInBoundæ¨¡å¼é»˜è®¤æ˜¯8021ç«¯å£ï¼Œå¯†ç é»˜è®¤ä¸ºClueConï¼Œ20ä¸ºè¿æ¥è¶…æ—¶æ—¶é•¿ï¼Œå•ä½ç§’ã€‚</p>
<p>FreeSWITCHæ¯éš”20ç§’ä¼šå‘é€å¿ƒè·³äº‹ä»¶ï¼Œä»£ç ä¸­æ”¶åˆ°å¿ƒè·³äº‹ä»¶ï¼Œä¼šå‘é€ä¸€ä¸ªå¼‚æ­¥APIå»æŸ¥çœ‹FreeSWITCHçš„çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸€ä¸ªJob_UUIDï¼Œå¼‚æ­¥å®Œæˆåé€šè¿‡<code>backgroundJobResultReceived</code>å›è°ƒæ‰§è¡Œç»“æœã€‚</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=5272940&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>FreeSwitch</category>
      </categories>
      <tags>
        <tag>FreeSWITCH</tag>
        <tag>ESL</tag>
        <tag>InBound</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ç§’çº§ç¼–è¯‘æ–¹æ¡ˆ-Freeline</title>
    <url>/2017/01/07/%E4%BD%BF%E7%94%A8%E7%A7%92%E7%BA%A7%E7%BC%96%E8%AF%91%E6%96%B9%E6%A1%88-Freeline/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br />
<a href="http://blog.csdn.net/guodongandroid/article/details/54174776">http://blog.csdn.net/guodongandroid/article/details/54174776</a><br />
æœ¬æ–‡æ¥è‡ª<a href="http://www.sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h1 id="ä½¿ç”¨ç§’çº§ç¼–è¯‘æ–¹æ¡ˆ-freeline"><a class="markdownIt-Anchor" href="#ä½¿ç”¨ç§’çº§ç¼–è¯‘æ–¹æ¡ˆ-freeline"></a> ä½¿ç”¨ç§’çº§ç¼–è¯‘æ–¹æ¡ˆ-Freeline</h1>
<h2 id="ä¸€-å…³äºfreeline"><a class="markdownIt-Anchor" href="#ä¸€-å…³äºfreeline"></a> ä¸€ã€å…³äºFreeline</h2>
<p>Freelineæ˜¯èš‚èšé‡‘æœæ——ä¸‹å¼€å‘çš„ä¸€ä¸ªåŸºäºåŠ¨æ€æ›¿æ¢çš„ç¼–è¯‘æ–¹æ¡ˆï¼Œè¿ç”¨åˆ°é¡¹ç›®åå¯ä»¥æå¤§çš„æé«˜é¡¹ç›®ç¼–è¯‘é€Ÿåº¦ã€‚ç›¸æ¯”è¾ƒç°åœ¨çš„instant-runï¼Œbuckï¼Œlayoutcastç­‰æ–¹æ¡ˆå¿«æ•°å€ã€‚<br />
<a href="https://github.com/alibaba/freeline" title="å¼€æºåœ°å€">GitHubåœ°å€</a><br />
<a href="https://www.freelinebuild.com/">å®˜ç½‘</a></p>
<h2 id="äºŒ-é›†æˆfreeline"><a class="markdownIt-Anchor" href="#äºŒ-é›†æˆfreeline"></a> äºŒã€é›†æˆFreeline</h2>
<p>è¿™é‡Œåªè¯´Windowsä¸‹çš„é›†æˆï¼ŒLinux/Mac è¯·è‡ªè¡Œç™¾åº¦/Googleã€‚ï¼ˆå±Œä¸æ²¡æœ‰MacBookï¼‰</p>
<h3 id="1-é›†æˆå‰çš„å‡†å¤‡"><a class="markdownIt-Anchor" href="#1-é›†æˆå‰çš„å‡†å¤‡"></a> 1ã€é›†æˆå‰çš„å‡†å¤‡</h3>
<p>ä½ éœ€è¦æå‰å®‰è£… Python 2.7+ï¼ˆFreeline æš‚æ—¶è¿˜ä¸æ”¯æŒ Python 3+ï¼‰ï¼Œå®‰è£…å®Œä¹‹åéœ€è¦é‡å¯ä¸€ä¸‹ Android Studioã€‚<br />
<a href="https://www.python.org/downloads/release/python-2713/">Python 2.7.13ä¸‹è½½åœ°å€</a></p>
<h3 id="2-å¦‚ä½•é›†æˆ"><a class="markdownIt-Anchor" href="#2-å¦‚ä½•é›†æˆ"></a> 2ã€å¦‚ä½•é›†æˆ</h3>
<p>æä¾›äº†ä¸¤ç§æ–¹å¼é›†æˆFreelineï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡ Android Studio çš„æ’ä»¶æ¥é›†æˆï¼ˆå®é™…ä¸Šæ˜¯å¯¹å‘½ä»¤è¡Œçš„æ–¹å¼åšäº†å°è£…ï¼Œæä¾›è‡ªåŠ¨åŒ–çš„è§£å†³æ–¹æ¡ˆï¼‰ï¼Œå¦ä¸€ç§åˆ™æ˜¯æ‰‹å·¥é€šè¿‡ä¿®æ”¹é…ç½®ä¸æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥é›†æˆã€‚<br />
<font color="#F00F0">å»ºè®®ä½¿ç”¨æ–¹æ³•äºŒï¼Œè‡ªå·±å…ˆæ£é¼“ä¸€éï¼Œæœ€åä½¿ç”¨æ’ä»¶ã€‚</font><br />
<strong>æ–¹æ³•ä¸€ï¼šAndroid Studio æ’ä»¶</strong><br />
åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Freeline æ’ä»¶ä¸­ï¼Œæä¾›äº†è‡ªåŠ¨åŒ–ä¸€é”®æ¥å…¥çš„æ–¹å¼ï¼Œä¸éœ€è¦åƒä»¥å‰ä¸€æ ·æ‰‹åŠ¨ä¿®æ”¹	<font color="#FF00FF">build.gradle</font>	é…ç½®æ–‡ä»¶äº†.</p>
<p>åœ¨Android Studioä¸­ï¼Œé€šè¿‡ä»¥ä¸‹è·¯å¾„	<font color="#FF00FF">Preferences â†’ Plugins â†’ Browse repositories</font>	ï¼Œæœç´¢â€œfreelineâ€ï¼Œå¹¶å®‰è£…ï¼Œå®‰è£…å®Œæˆé‡å¯ASã€‚</p>
<p><img data-src="http://img.blog.csdn.net/20170107144204312?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Freeline" /></p>
<p>ç›´æ¥ç‚¹å‡»	<font color="#FF00FF">Run Freeline</font> çš„æŒ‰é’®ï¼Œå°±å¯ä»¥äº«å—Freelineå¸¦æ¥çš„å¼€å‘æ•ˆç‡çš„æå‡å•¦ï¼ˆä¼šå…ˆéœ€è¦ä¸€ä¸ªè¾ƒä¸ºè€—æ—¶çš„å…¨é‡ç¼–è¯‘è¿‡ç¨‹ï¼‰ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦å®‰è£…äº† Freelineï¼Œå¦‚æœæ²¡æœ‰å®‰è£…çš„è¯ä¼šå¼¹å‡ºæç¤ºï¼ŒæŒ‰ç…§æç¤ºç‚¹å‡»â€œç¡®å®šâ€ï¼Œæ’ä»¶å°±ä¼šè‡ªåŠ¨ä¸ºä½ ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨å®‰è£… Freeline çš„ä¾èµ–æ–‡ä»¶ã€‚</p>
<p><strong>æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œæ–¹å¼</strong><br />
é…ç½® project-level çš„ build.gradleï¼ŒåŠ å…¥ freeline-gradle çš„ä¾èµ–ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">classpath &#x27;com.antfortune.freeline:gradle:<span class="keyword">x</span>.<span class="keyword">x</span>.<span class="keyword">x</span>&#x27;</span><br></pre></td></tr></table></figure>
<p><img data-src="http://img.blog.csdn.net/20170107144549590?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>ç„¶åï¼Œåœ¨ä½ çš„ä¸» module çš„ build.gradle ä¸­ï¼Œåº”ç”¨ freeline æ’ä»¶çš„ä¾èµ–ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">apply</span> plugin: <span class="string">&#x27;com.antfortune.freeline&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="http://img.blog.csdn.net/20170107144659841?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>æœ€åï¼Œåœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ä¸‹è½½ freeline çš„ python å’ŒäºŒè¿›åˆ¶ä¾èµ–ã€‚</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">Windows<span class="selector-attr">[CMD]</span>: gradlew initFreeline</span><br></pre></td></tr></table></figure>
<p><font color="#F00F0" size = 4>æ³¨æ„ï¼æ³¨æ„ï¼æ³¨æ„ï¼</font></p>
<ul>
<li>åœ¨CMDä¸‹æ‰§è¡Œå‘½ä»¤éœ€è¦CDåˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œåœ¨ASä¸‹çš„Terminalå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚</li>
<li>å¯¹äºå›½å†…çš„åŒå­¦ï¼Œå¦‚æœä½ åœ¨ä¸‹è½½çš„æ—¶å€™é€Ÿåº¦å¾ˆæ…¢ï¼Œä½ ä¹Ÿå¯ä»¥åŠ ä¸Šå‚æ•°ï¼Œæ‰§è¡Œ <font color="#FF00FF">gradlew initFreeline -Pmirror</font>ï¼Œè¿™æ ·å°±ä¼šä»å›½å†…é•œåƒåœ°å€æ¥ä¸‹è½½ã€‚<font color="#F00F0" size = 4>ï¼ˆæ¨èä½¿ç”¨ï¼‰</font></li>
<li>åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œfreelineå¯èƒ½ä¼šä¸‹è½½ä¸€äº›ä¸œè¥¿ï¼Œæœ‰æ—¶å€™å› ä¸ºç½‘ç»œçš„æ ·å­ä¼šä¸‹è½½å¾ˆæ…¢ï¼Œæ¯”å¦‚è¿™æ ·å­çš„ï¼š</li>
</ul>
<p><img data-src="http://img.blog.csdn.net/20170107145754803?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>è¿™æ—¶å€™å¯ä»¥æå‰ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„<a href="https://services.gradle.org/distributions/">gradle</a>ï¼Œç„¶åå°†ä¸‹è½½å¥½çš„zipæ–‡ä»¶æ”¾å…¥è¿™ä¸ªç›®å½•ä¸‹ï¼Œfreelineä¼šè‡ªåŠ¨è§£å‹ï¼š</p>
<p><img data-src="http://img.blog.csdn.net/20170107154826832?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å†æ¬¡æ‰§è¡Œ <font color="#FF00FF">gradlew initFreeline -Pmirror</font>ï¼ŒFreelineä¼šå†ä¸‹è½½ç›¸åº”çš„ä¾èµ–åŒ…ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºé”™äº†ï¼Œç›´åˆ°å‡ºç°è¿™æ­¥æ—¶ï¼Œè€å¿ƒç­‰å¾…ä¸€ä¼šå„¿ã€‚è¿™ä¸ªæ—¶å€™å·²ç»å¼€å§‹äº†å¯¹Freelineçš„åˆå§‹åŒ–ã€‚</p>
<p><img data-src="http://img.blog.csdn.net/20170107150447710?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>åˆå§‹åŒ–æˆåŠŸï¼š</p>
<p><img data-src="http://img.blog.csdn.net/20170107150721089?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ç¬¬ä¸€æ¬¡çš„å…¨é‡ç¼–è¯‘ï¼Œè€å¿ƒç­‰å¾…ç¼–è¯‘å®Œæˆï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡å…¨é‡ç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œä»¥åçš„å¢é‡ç¼–è¯‘éƒ½æ˜¯10sä¹‹å†…çš„ï¼‰ï¼š</p>
<p>æ‰§è¡Œä¸€æ¡	<font color="#FF00FF">python freeline.py</font> å‘½ä»¤å³å¯ã€‚</p>
<p><img data-src="http://img.blog.csdn.net/20170107151313958?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>è¿™æ˜¯ç¬¬ä¸€æ¬¡ç¼–è¯‘çš„æ—¶é—´æ˜¯40ç§’ã€‚ç„¶åæˆ‘ä¿®æ”¹äº†ä¸€ä¸ªæ•°å€¼è¿›è¡Œç¬¬äºŒæ¬¡ç¼–è¯‘ã€‚</p>
<p><img data-src="http://img.blog.csdn.net/20170107151501007?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>0.7ç§’å³ç¼–è¯‘å®Œæˆï¼Œä¸åˆ°ä¸€çœ¨çœ¼çš„åŠŸå¤«ï¼Œ484æƒ³è¯´â€œå§æ§½â€ã€‚</p>
<p><font color="#F00F0" size = 4>æ³¨æ„åˆæ¥äº†ï¼</font></p>
<ul>
<li>
<p>freelineçš„limitationï¼Œç›®å‰è¿˜ä¸æ”¯æŒè¿æ¥å¤šå°è®¾å¤‡ã€‚ç›®å‰æ–¹æ¡ˆå‚è€ƒ <a href="https://github.com/alibaba/freeline/issues/233">Issues233</a>ã€‚</p>
</li>
<li>
<p>åœ¨è‡ªå·±çš„Applicationç±»ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š</p>
<p><code>FreelineCore.init(this);</code></p>
</li>
<li>
<p>æœ‰æ—¶å¢é‡ç¼–è¯‘å®Œæˆåå¹¶ä¸ä¼šè‡ªåŠ¨launch activityï¼Œä½†è¿™æ—¶å·²ç»æŠŠæ›´æ–°éƒ¨ç½²åˆ°è®¾å¤‡ä¸Šäº†ã€‚</p>
</li>
<li>
<p>æœ‰å…¶ä»–é—®é¢˜å¤šå»çœ‹çœ‹<a href="https://github.com/alibaba/freeline/issues">Issues</a>ã€‚</p>
</li>
</ul>
<p><img data-src="http://img.blog.csdn.net/20170107151925468?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VvZG9uZ0FuZHJvaWQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>è‡³æ­¤ï¼ŒFreelineå·²ç»æˆåŠŸçš„é›†æˆåˆ°äº†æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå¦‚æœè§‰å¾—æ¯æ¬¡æ‰§è¡Œå‘½ä»¤è¡Œæ¯”è¾ƒç¹çï¼Œå¯ä»¥æ ¹æ®æ–¹æ³•ä¸€åœ¨ASä¸­å®‰è£…Freelineçš„æ’ä»¶ã€‚</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Freeline</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>Freeline</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨Nexusæ­å»ºæœ¬åœ°Mavenä»“åº“</title>
    <url>/2017/10/17/%E4%BD%BF%E7%94%A8Nexus%E6%90%AD%E5%BB%BA%E6%9C%AC%E5%9C%B0Maven%E4%BB%93%E5%BA%93/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>
<p><a href="http://sunxiaodou.com/2017/08/02/Java%E9%80%9A%E8%BF%87ESL%E8%BF%9E%E6%8E%A5FreeSWITCH/">http://sunxiaodou.com/2017/10/17/ä½¿ç”¨Nexusæ­å»ºæœ¬åœ°Mavenä»“åº“/</a></p>
<p>æœ¬æ–‡å‡ºè‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="ä½¿ç”¨nexusæ­å»ºæœ¬åœ°mavenä»“åº“"><a class="markdownIt-Anchor" href="#ä½¿ç”¨nexusæ­å»ºæœ¬åœ°mavenä»“åº“"></a> ä½¿ç”¨Nexusæ­å»ºæœ¬åœ°Mavenä»“åº“</h2>
<h3 id="å®‰è£…nexus"><a class="markdownIt-Anchor" href="#å®‰è£…nexus"></a> å®‰è£…Nexus</h3>
<p><a href="https://www.sonatype.com/download-oss-sonatype">ä¸‹è½½Nexus</a></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/nexus_download.png" alt="nexus_download" /></p>
<p>ä¸‹è½½Macç‰ˆæœ¬çš„ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸º3.6.0-02ã€‚è§£å‹åæ”¾åœ¨æœ¬åœ°ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/nexus_bin.png" alt="nexus_bin" /></p>
<p>åœ¨ç»ˆç«¯é‡ŒCDè¿›å…¥nexusçš„binç›®å½•ï¼Œè¿è¡Œ<code>./nexus start</code></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/start_nexus.png" alt="start_nexus" /></p>
<p>æ²¡æœ‰é”™è¯¯çš„è¯ï¼Œæ­¤æ—¶nexuså·²ç»å¯åŠ¨ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<code>http://localhost:8081/</code>è¿›è¡Œè®¿é—®ï¼Œnexusé»˜è®¤ç›‘å¬8081ç«¯å£ã€‚å‡ºç°ä»¥ä¸‹ç•Œé¢è¡¨ç¤ºnexuså®‰è£…å®Œæˆã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/nexus_manager.png" alt="nexus_manager" /></p>
<h3 id="åˆ›å»ºæœ¬åœ°ä»“åº“"><a class="markdownIt-Anchor" href="#åˆ›å»ºæœ¬åœ°ä»“åº“"></a> åˆ›å»ºæœ¬åœ°ä»“åº“</h3>
<p>åœ¨æµè§ˆå™¨ä¸­ç‚¹å‡»Sign inæŒ‰é’®ä»¥ç™»å½•nexusï¼Œé»˜è®¤ç”¨æˆ·åadminï¼Œé»˜è®¤å¯†ç admin123ã€‚æ ¹æ®ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä»“åº“ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/create_repository_a.png" alt="create_repository_a" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/select_recipe.png" alt="select_recipe" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/create_repository_b.png" alt="create_repository_b" /></p>
<p>ç‚¹å‡»Create repositoryæŒ‰é’®å³å¯åˆ›å»ºæœ¬åœ°ä»“åº“ã€‚</p>
<h3 id="androidstudioä¸Šä¼ åº“åˆ°æœ¬åœ°ä»“åº“å¹¶å¼•ç”¨"><a class="markdownIt-Anchor" href="#androidstudioä¸Šä¼ åº“åˆ°æœ¬åœ°ä»“åº“å¹¶å¼•ç”¨"></a> AndroidStudioä¸Šä¼ åº“åˆ°æœ¬åœ°ä»“åº“å¹¶å¼•ç”¨</h3>
<h4 id="ä¸Šä¼ "><a class="markdownIt-Anchor" href="#ä¸Šä¼ "></a> ä¸Šä¼ </h4>
<p>åœ¨æˆ‘ä»¬çš„é¡¹ç›®åº“ä¸‹æ–°å»ºnexus_maven.gradleæ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/create_nexus_gradle.png" alt="create_nexus_gradle" /></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;maven&#x27;</span></span><br><span class="line"></span><br><span class="line">task androidJavadocs(<span class="attr">type:</span> Javadoc) &#123;</span><br><span class="line">    source = android.sourceSets.main.java.srcDirs</span><br><span class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task androidJavadocsJar(<span class="attr">type:</span> Jar, <span class="attr">dependsOn:</span> androidJavadocs) &#123;</span><br><span class="line">    classifier = <span class="string">&#x27;javadoc&#x27;</span></span><br><span class="line">    from androidJavadocs.destinationDir</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task androidSourcesJar(<span class="attr">type:</span> Jar) &#123;</span><br><span class="line">    classifier = <span class="string">&#x27;sources&#x27;</span></span><br><span class="line">    from android.sourceSets.main.java.srcDirs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">artifacts &#123;</span><br><span class="line">    archives androidSourcesJar</span><br><span class="line">    archives androidJavadocsJar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            repository(<span class="attr">url:</span> <span class="string">&quot;http://localhost:8081/repository/test/&quot;</span>) &#123; <span class="comment">// æ­¤å¤„çš„testä¸ºæœ¬åœ°ä»“åº“åç§°</span></span><br><span class="line">                authentication(<span class="attr">userName:</span> <span class="string">&quot;admin&quot;</span>, <span class="attr">password:</span> <span class="string">&quot;admin123&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            pom.project &#123;</span><br><span class="line">                name <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">                version <span class="string">&#x27;0.0.1&#x27;</span></span><br><span class="line">                artifactId <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">                groupId <span class="string">&#x27;com.guodongandroid.test&#x27;</span></span><br><span class="line">                packaging <span class="string">&#x27;aar&#x27;</span></span><br><span class="line">                description <span class="string">&#x27;xxx xxx xxx&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æˆ‘ä»¬åº“çš„build.gradleæ–‡ä»¶æœ€åå¼•ç”¨è¿™ä¸ªnexus_maven.gradle</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">&#x27;nexus_maven.gradle&#x27;</span></span><br></pre></td></tr></table></figure>
<p>æœ€åæ‰§è¡Œä¸Šä¼ æ“ä½œã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/nexus_install/uploadArchives.png" alt="uploadArchives" /></p>
<p>æ­¤æ—¶å¯ä»¥åœ¨æœ¬åœ°ä»“åº“testä¸­çœ‹åˆ°åˆšåˆšä¸Šä¼ çš„æ–‡ä»¶ã€‚</p>
<h4 id="å¼•ç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨"></a> å¼•ç”¨</h4>
<p>åœ¨Projectçº§åˆ«çš„build.gradleæ–‡ä»¶çš„allprojectsä¸­æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">maven &#123;</span><br><span class="line">   url <span class="string">&#x27;http://localhost:8081/repository/test/&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Moduleçº§åˆ«çš„build.gradleæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.guodongandroid.test:xxx:0.0.1@aar&#x27;</span></span><br></pre></td></tr></table></figure>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>Nexus</category>
      </categories>
      <tags>
        <tag>Nexus</tag>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨è¿…é›·ä¸‹è½½ç™¾åº¦ç½‘ç›˜æ–‡ä»¶</title>
    <url>/2017/07/16/%E4%BD%BF%E7%94%A8%E8%BF%85%E9%9B%B7%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<Contents>
<h2 id="ä½¿ç”¨è¿…é›·ä¸‹è½½ç™¾åº¦ç½‘ç›˜æ–‡ä»¶"><a class="markdownIt-Anchor" href="#ä½¿ç”¨è¿…é›·ä¸‹è½½ç™¾åº¦ç½‘ç›˜æ–‡ä»¶"></a> ä½¿ç”¨è¿…é›·ä¸‹è½½ç™¾åº¦ç½‘ç›˜æ–‡ä»¶</h2>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼š</p>
<p><a href="http://sunxiaodou.com/2017/07/16/%E4%BD%BF%E7%94%A8%E8%BF%85%E9%9B%B7%E4%B8%8B%E8%BD%BD%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E6%96%87%E4%BB%B6/">http://sunxiaodou.com/2017/07/16/ä½¿ç”¨è¿…é›·ä¸‹è½½ç™¾åº¦ç½‘ç›˜æ–‡ä»¶/</a></p>
<p>æœ¬æ–‡æ¥è‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3>
<ol>
<li>æˆ‘æ˜¯åœ¨Macç‰ˆçš„Chromeè¿›è¡Œçš„å®‰è£…ï¼Œåˆ°æœ€åä¸€åˆ‡å®‰è£…å°±ç»ªï¼Œç‚¹å‡»ä¸‹è½½æ—¶è¿˜æ˜¯å¼¹å‡ºç™¾åº¦ç½‘ç›˜çš„ä¸‹è½½å¯¹è¯æ¡†ã€‚</li>
<li>ç„¶åå°è¯•åœ¨Windowsç‰ˆçš„Chromeå®‰è£…ï¼Œæ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ã€‚</li>
<li>æœ€åçš„ä¸‹è½½æˆªå›¾æ˜¯Windowsç‰ˆçš„QQæµè§ˆå™¨ï¼Œæ­£å¸¸ä½¿ç”¨ã€‚</li>
<li>å…¶ä»–æµè§ˆå™¨è¯·è‡ªè¡Œæµ‹è¯•ã€‚</li>
</ol>
<h3 id="ä¸‹è½½chromeæ’ä»¶-tampermonkeyè„šæœ¬ç®¡ç†å™¨"><a class="markdownIt-Anchor" href="#ä¸‹è½½chromeæ’ä»¶-tampermonkeyè„šæœ¬ç®¡ç†å™¨"></a> ä¸‹è½½Chromeæ’ä»¶ â€” Tampermonkeyè„šæœ¬ç®¡ç†å™¨</h3>
<ol>
<li>å¯ä»¥ç¿»å¢™çš„åŒå­¦ï¼Œåœ¨Chromeçš„ç½‘ä¸Šåº”ç”¨å•†åº—ç›´æ¥æœç´¢Tampermonkeyï¼Œæ·»åŠ åˆ°Chromeæ‰©å±•å³å¯ã€‚</li>
<li>ä¸èƒ½ç¿»å¢™çš„åŒå­¦ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘å·²ç»ä¸‹è½½å¥½çš„æ’ä»¶æ–‡ä»¶æœ¬åœ°å®‰è£…ã€‚é“¾æ¥: <a href="https://pan.baidu.com/s/1nvmfq8D">https://pan.baidu.com/s/1nvmfq8D</a> å¯†ç : i2r4</li>
</ol>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/Chrome.png" alt="Chrome" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/Chrome%20Install.png" alt="Chrome Install" /></p>
<h3 id="å®‰è£…è„šæœ¬-æ‰“å¼€greasy-fork"><a class="markdownIt-Anchor" href="#å®‰è£…è„šæœ¬-æ‰“å¼€greasy-fork"></a> å®‰è£…è„šæœ¬ â€” æ‰“å¼€Greasy Fork</h3>
<p>ç°åœ¨æˆ‘ä»¬æ‰“å¼€<a href="https://greasyfork.org/zh-CN/">Greasy Fork</a>ï¼Œä¸€ä¸ªæä¾›ç”¨æˆ·è„šæœ¬çš„ç½‘ç«™ã€‚å¹¶åœ¨æœç´¢æ¡†å†…è¾“å…¥â€œè§£å†³ç™¾åº¦äº‘â€å…³é”®å­—æœç´¢ã€‚<br />
<img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/search%20baiduyun.png" alt="Greasy Fork" /></p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/search%20rustlt.png" alt="search result" /></p>
<p>æˆ‘ä»¬ç‚¹å‡»ä¸‹é¢é‚£ä¸ªâ€œè·¯äººæ·»åŠ ç‰ˆâ€ï¼Œæ›´æ–°æ—¶é—´æ¯”è¾ƒæ–°ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/install%20script.png" alt="install" /></p>
<p>ç‚¹å‡»å®‰è£…æ­¤è„šæœ¬ï¼Œè¿›å…¥æºç ç•Œé¢ï¼Œç‚¹å‡»å®‰è£…å³å¯ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/install%20script%20again.png" alt="install again" /></p>
<p>è‡³æ­¤ï¼Œæ‰€æœ‰çš„å®‰è£…å·²å®Œæˆã€‚</p>
<h3 id="ä½¿ç”¨è¿…é›·ä¸‹è½½å¤§æ–‡ä»¶"><a class="markdownIt-Anchor" href="#ä½¿ç”¨è¿…é›·ä¸‹è½½å¤§æ–‡ä»¶"></a> ä½¿ç”¨è¿…é›·ä¸‹è½½å¤§æ–‡ä»¶</h3>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰“å¼€ç™¾åº¦ç½‘ç›˜ç½‘é¡µç‰ˆï¼Œå¯ä»¥çœ‹åˆ°è„šæœ¬ç®¡ç†å™¨æç¤ºï¼Œè„šæœ¬å·²åœ¨è¿è¡Œã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/start%20script.png" alt="start" /></p>
<p>æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç”µå½±ã€Š5kz.mp4 â€” æ‚Ÿç©ºä¼ ã€‹ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œå¼¹å‡ºQQæµè§ˆå™¨çš„ä¸‹è½½å¯¹è¯æ¡†ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡»è¿…é›·ä¸‹è½½ã€‚</p>
<p><img data-src="http://om278gsrf.bkt.clouddn.com/baiduyun/download%205kz.png" alt="download" /></p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <tags>
        <tag>è¿…é›·</tag>
        <tag>ç™¾åº¦ç½‘ç›˜</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°å½“TextView.setSingleLine(true)æ—¶ï¼Œæ»‘åŠ¨TextViewçš„åŒºåŸŸï¼Œå¯¼è‡´çš„ViewPagerä¸èƒ½æ»‘åŠ¨çš„é—®é¢˜</title>
    <url>/2017/09/14/%E8%AE%B0%E5%BD%93TextView.setSingleLine(true)%E6%97%B6%EF%BC%8C%E6%BB%91%E5%8A%A8TextView%E7%9A%84%E5%8C%BA%E5%9F%9F%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%9A%84ViewPager%E4%B8%8D%E8%83%BD%E6%BB%91%E5%8A%A8%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼š</p>
<p><a href="http://sunxiaodou.com/2017/09/14/%E8%AE%B0%E5%BD%93TextView.setSingleLine(true)%E6%97%B6%EF%BC%8C%E6%BB%91%E5%8A%A8TextView%E7%9A%84%E5%8C%BA%E5%9F%9F%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%9A%84ViewPager%E4%B8%8D%E8%83%BD%E6%BB%91%E5%8A%A8%E7%9A%84%E9%97%AE%E9%A2%98/">http://sunxiaodou.com/2017/09/14/è®°å½“TextView.setSingleLine(true)æ—¶ï¼Œæ»‘åŠ¨TextViewçš„åŒºåŸŸï¼Œå¯¼è‡´çš„ViewPagerä¸èƒ½æ»‘åŠ¨çš„é—®é¢˜/</a></p>
<p>æœ¬æ–‡æ¥è‡ª<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="æ¦‚è¿°"><a class="markdownIt-Anchor" href="#æ¦‚è¿°"></a> æ¦‚è¿°</h2>
<p>é—®é¢˜èƒŒæ™¯ï¼šåœ¨ViewPagerä¸­åŒ…å«ä¸¤ä¸ªFragmentï¼Œå…¶ä¸­ä¸€ä¸ªFragmentä¸­æœ‰å¤šä¸ªTextViewï¼ŒTextViewéœ€è¦å¼€å¯è·‘é©¬ç¯ï¼Œåœ¨XMLæ–‡ä»¶ä¸­è®¾ç½®äº†:<code>android:singleLine=&quot;true&quot;</code>å¯¼è‡´æ»‘åŠ¨TextViewçš„åŒºåŸŸæ—¶ï¼ŒViewPageræ»‘åŠ¨å¤±æ•ˆã€‚</p>
<h2 id="æ¢ç´¢"><a class="markdownIt-Anchor" href="#æ¢ç´¢"></a> æ¢ç´¢</h2>
<h3 id="æ¢ç´¢ä¸€"><a class="markdownIt-Anchor" href="#æ¢ç´¢ä¸€"></a> æ¢ç´¢ä¸€</h3>
<p>é¦–å…ˆæƒ³åˆ°çš„æ˜¯æ»‘åŠ¨å†²çªï¼Œå»æŸ¥çœ‹äº†<code>TextView.setSingleLine(true)</code>æ—¶æ‰§è¡Œäº†ä»€ä¹ˆåŠ¨ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@android</span>.view.RemotableViewMethod</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSingleLine</span><span class="params">(<span class="type">boolean</span> singleLine)</span> &#123;</span><br><span class="line">    <span class="comment">// Could be used, but may break backward compatibility.</span></span><br><span class="line">    <span class="comment">// if (mSingleLine == singleLine) return;</span></span><br><span class="line">    setInputTypeSingleLine(singleLine);</span><br><span class="line">    applySingleLine(singleLine, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setInputTypeSingleLine</span><span class="params">(<span class="type">boolean</span> singleLine)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEditor != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                (mEditor.mInputType &amp; EditorInfo.TYPE_MASK_CLASS) == EditorInfo.TYPE_CLASS_TEXT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (singleLine) &#123;</span><br><span class="line">                mEditor.mInputType &amp;= ~EditorInfo.TYPE_TEXT_FLAG_MULTI_LINE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mEditor.mInputType |= EditorInfo.TYPE_TEXT_FLAG_MULTI_LINE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applySingleLine</span><span class="params">(<span class="type">boolean</span> singleLine, <span class="type">boolean</span> applyTransformation,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> changeMaxLines)</span> &#123;</span><br><span class="line">        mSingleLine = singleLine;</span><br><span class="line">        <span class="keyword">if</span> (singleLine) &#123;</span><br><span class="line">            setLines(<span class="number">1</span>);</span><br><span class="line">            setHorizontallyScrolling(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (applyTransformation) &#123;</span><br><span class="line">                setTransformationMethod(SingleLineTransformationMethod.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (changeMaxLines) &#123;</span><br><span class="line">                setMaxLines(Integer.MAX_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line">            setHorizontallyScrolling(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (applyTransformation) &#123;</span><br><span class="line">                setTransformationMethod(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHorizontallyScrolling</span><span class="params">(<span class="type">boolean</span> whether)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mHorizontallyScrolling != whether) &#123;</span><br><span class="line">            mHorizontallyScrolling = whether;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mLayout != <span class="literal">null</span>) &#123;</span><br><span class="line">                nullLayouts();</span><br><span class="line">                requestLayout();</span><br><span class="line">                invalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨<code>applySingleLine</code>æ–¹æ³•ä¸­çœ‹åˆ°<code>setLines(1);setHorizontallyScrolling(true);</code>ï¼Œ<code>setHorizontallyScrolling</code>æ–¹æ³•ä¼šè®¾ç½®TextViewæ˜¯å¦å¯ä»¥æ¨ªå‘æ»šåŠ¨ï¼Œå…³é”®æ˜¯æ”¹å˜äº†<code>mHorizontallyScrolling</code>æˆå‘˜å˜é‡çš„å€¼ã€‚</p>
<p>ç„¶åå°±å†™äº†ä¸ªMyViewPager:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewPager</span> <span class="keyword">extends</span> <span class="title class_">ViewPager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mSlop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">         mSlop = ViewConfiguration.get(context).getScaledTouchSlop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">actionMasked</span> <span class="operator">=</span> ev.getActionMasked();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (actionMasked) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                mDownX = (<span class="type">int</span>) ev.getX();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="type">int</span> <span class="variable">dx</span> <span class="operator">=</span> (<span class="type">int</span>) (ev.getX() - mDownX);</span><br><span class="line">                <span class="keyword">if</span> (Math.abs(dx) &gt;= mSlop) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                mDownX = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦†å†™äº†äº‹ä»¶æ‹¦æˆªæ–¹æ³•<code>onInterceptTouchEvent(MotionEvent ev)</code>æ–¹æ³•ï¼Œåœ¨<code>MotionEvent.ACTION_MOVE</code>é‡Œæ ¹æ®æ¨ªå‘æ»‘åŠ¨æ˜¯å¦éœ€è¦æ‹¦æˆªäº‹ä»¶ã€‚</p>
<p>ç„¶è€Œç°å®æ˜¯æ®‹é…·çš„ã€æ— æƒ…çš„ï¼Œå¤±è´¥ã€‚</p>
<h3 id="æ¢ç´¢äºŒ"><a class="markdownIt-Anchor" href="#æ¢ç´¢äºŒ"></a> æ¢ç´¢äºŒ</h3>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒTextViewè¦å®ç°è·‘é©¬ç¯éœ€è¦è·å–åˆ°ç„¦ç‚¹ï¼Œç„¶åçŒœæµ‹æ»‘åŠ¨TextViewåŒºåŸŸçš„æ—¶ViewPagerä¸æ»‘åŠ¨çš„åŸå› æ˜¯å› ä¸ºViewPageræ²¡æœ‰è·å–åˆ°ç„¦ç‚¹æ‰€è‡´ã€‚</p>
<p>æ‰€ä»¥åœ¨æ¢ç´¢ä¸€çš„åŸºç¡€ä¸ŠåŠ äº†ä¸€å¥ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewPager</span> <span class="keyword">extends</span> <span class="title class_">ViewPager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mSlop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewPager</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">         mSlop = ViewConfiguration.get(context).getScaledTouchSlop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">actionMasked</span> <span class="operator">=</span> ev.getActionMasked();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (actionMasked) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                mDownX = (<span class="type">int</span>) ev.getX();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="type">int</span> <span class="variable">dx</span> <span class="operator">=</span> (<span class="type">int</span>) (ev.getX() - mDownX);</span><br><span class="line">                <span class="keyword">if</span> (Math.abs(dx) &gt;= mSlop) &#123;</span><br><span class="line">                	requestFocusFromTouch();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                mDownX = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ç¬¬27è¡Œçš„ä»£ç <code>requestFocusFromTouch();</code>ï¼Œæ‹¦æˆªäº‹ä»¶çš„åŒæ—¶ä½¿ViewPagerè·å–åˆ°ç„¦ç‚¹ã€‚</p>
<p>å¥‡è¿¹å‘ç”Ÿï¼ŒæˆåŠŸã€‚</p>
<p>è¿™ä¸ªé—®é¢˜è™½ç„¶è§£å†³äº†ï¼Œå´ä¹Ÿå¼•å…¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼šå¦ä¸€ä¸ªFragmentä¸­æœ‰ä¸€ä¸ªæ¨ªå‘æ»‘åŠ¨çš„RecyclerViewï¼Œç”±äºViewPagerçš„æ¨ªå‘æ»‘åŠ¨äº‹ä»¶æ‹¦æˆªï¼Œå¯¼è‡´RecyclerViewçš„æ¨ªå‘æ»‘åŠ¨å¤±æ•ˆã€‚</p>
<p>åªå¥½é‡å†™ä¸€ä¸ªMyRecyclerViewï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRecyclerView</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownX;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mDownY;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mSlop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRecyclerView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRecyclerView</span><span class="params">(Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRecyclerView</span><span class="params">(Context context, <span class="meta">@Nullable</span> AttributeSet attrs, <span class="type">int</span> defStyle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyle);</span><br><span class="line">        mSlop = ViewConfiguration.get(context).getScaledTouchSlop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">actionMasked</span> <span class="operator">=</span> ev.getActionMasked();</span><br><span class="line">        <span class="keyword">switch</span> (actionMasked) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                mDownX = (<span class="type">int</span>) ev.getX();</span><br><span class="line">                mDownY = (<span class="type">int</span>) ev.getY();</span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">dx</span> <span class="operator">=</span> (<span class="type">int</span>) (ev.getX() - mDownX);</span><br><span class="line">                <span class="type">int</span> <span class="variable">dy</span> <span class="operator">=</span> (<span class="type">int</span>) (ev.getY() - mDownY);</span><br><span class="line">                <span class="keyword">if</span> (Math.abs(dy) &gt;= mSlop &amp;&amp; Math.abs(dy) &gt; Math.abs(dx)) &#123;</span><br><span class="line">                    getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Adapter</span> <span class="variable">adapter</span> <span class="operator">=</span> getAdapter();</span><br><span class="line">                <span class="keyword">if</span> (adapter == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">LayoutManager</span> <span class="variable">manager</span> <span class="operator">=</span> getLayoutManager();</span><br><span class="line">                <span class="keyword">if</span> (manager == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">itemCount</span> <span class="operator">=</span> adapter.getItemCount();</span><br><span class="line">                <span class="keyword">if</span> (itemCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (manager <span class="keyword">instanceof</span> LinearLayoutManager) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dx &gt; <span class="number">0</span> &amp;&amp; dx &lt;= mSlop) &#123; <span class="comment">// å³æ»‘</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">firstVisiblePosition</span> <span class="operator">=</span> ((LinearLayoutManager) manager).findFirstCompletelyVisibleItemPosition();</span><br><span class="line">                        <span class="keyword">if</span> (firstVisiblePosition == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="type">View</span> <span class="variable">firstView</span> <span class="operator">=</span> manager.findViewByPosition(firstVisiblePosition);</span><br><span class="line">                            <span class="keyword">if</span> (firstView.getLeft() == <span class="number">0</span>) &#123;</span><br><span class="line">                                getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dx &lt; <span class="number">0</span> &amp;&amp; dx &gt;= -mSlop) &#123; <span class="comment">// å·¦æ»‘</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">lastVisiblePosition</span> <span class="operator">=</span> ((LinearLayoutManager) manager).findLastCompletelyVisibleItemPosition();</span><br><span class="line">                        <span class="keyword">if</span> (lastVisiblePosition == itemCount - <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="type">View</span> <span class="variable">lastView</span> <span class="operator">=</span> manager.findViewByPosition(lastVisiblePosition);</span><br><span class="line">                            <span class="keyword">if</span> (lastView.getRight() == <span class="built_in">this</span>.getWidth()) &#123;</span><br><span class="line">                                getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                mDownX = <span class="number">0</span>;</span><br><span class="line">                mDownY = <span class="number">0</span>;</span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¨ªå‘æ»‘åŠ¨çš„RecyclerViewæ˜¯ä½œä¸ºä¸€ä¸ªItemåœ¨ä¸€ä¸ªç«–å‘æ»‘åŠ¨çš„RecyclerViewä¸­ï¼Œæ‰€ä»¥ä»£ç ä¸­åŠ äº†å¯¹ç«–å‘æ»‘åŠ¨çš„å¤„ç†ã€‚</p>
<p>æœ‰å…³æ»‘åŠ¨å†²çªçš„è§£å†³åŠæ³•å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://sunxiaodou.com/2017/07/07/View%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F/">Viewæ»‘åŠ¨å†²çªçš„ä¸¤ç§è§£å†³æ–¹å¼</a></p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=28661549&auto=1&height=66"></iframe>]]></content>
      <tags>
        <tag>ViewPager</tag>
        <tag>TextView</tag>
        <tag>è·‘é©¬ç¯</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°Android Studioè‡ªå®šä¹‰å±æ€§è®¿é—®ä¸äº†çš„é—®é¢˜</title>
    <url>/2016/05/30/%E8%AE%B0Android%20Studio%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E4%B8%8D%E4%BA%86%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<Contents>
<blockquote>
<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„:<br />
<a href="http://blog.csdn.net/guodongAndroid/article/details/51536091">http://blog.csdn.net/guodongAndroid/article/details/51536091</a><br />
æœ¬æ–‡æ¥è‡ª:<a href="http://sunxiaodou.com">ã€å­«å°é€—çš„åšå®¢ã€‘</a></p>
</blockquote>
<h2 id="ä¸€-æ¦‚è¿°"><a class="markdownIt-Anchor" href="#ä¸€-æ¦‚è¿°"></a> ä¸€ã€æ¦‚è¿°</h2>
<p>åœ¨Eclipseä¸­å¯¹äºè‡ªå®šä¹‰å±æ€§çš„å¼•ç”¨æ˜¯åœ¨æ ¹å¸ƒå±€æ–‡ä»¶ä¸­å£°æ˜ä¸€ä¸ªå‘½åç©ºé—´ï¼Œæ¯”å¦‚ï¼šxmlnsï¼šxxx=â€œ<a href="http://schemas.android.com/apk/res/%E9%A1%B9%E7%9B%AE%E5%8C%85%E5%90%8D%E2%80%9D%E3%80%82%E5%85%B6%E4%B8%ADxxx%E6%98%AF%E8%87%AA%E5%B7%B1%E5%AE%9A%E4%B9%89%E7%9A%84%EF%BC%8C%E9%A1%B9%E7%9B%AE%E5%8C%85%E5%90%8D%E5%B0%B1%E6%98%AFManifest%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84package%E3%80%82%E8%80%8C%E5%9C%A8Android">http://schemas.android.com/apk/res/é¡¹ç›®åŒ…åâ€ã€‚å…¶ä¸­xxxæ˜¯è‡ªå·±å®šä¹‰çš„ï¼Œé¡¹ç›®åŒ…åå°±æ˜¯Manifestæ–‡ä»¶ä¸­çš„packageã€‚è€Œåœ¨Android</a> Studioä¸­å£°æ˜å‘½åæ§ä»¶å’Œåœ¨Eclipseä¸­ç±»ä¼¼ï¼Œä¾‹å¦‚ï¼šxmlns:wzq=â€œ<a href="http://schemas.android.com/apk/res-auto">http://schemas.android.com/apk/res-auto</a>â€ï¼Œ<br />
åªæ˜¯resåé¢ä¸åŒã€‚ä½†æ˜¯è¿™æ ·å¸¦æ¥äº†ä¸€ä¸ªéº»çƒ¦ï¼</p>
<h2 id="äºŒ-è§£å†³"><a class="markdownIt-Anchor" href="#äºŒ-è§£å†³"></a> äºŒã€è§£å†³</h2>
<p>ASè¿™æ ·åšä¼šå¸¦æ¥ä»€ä¹ˆéº»çƒ¦å‘¢ï¼Ÿå³ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰å±æ€§å †ç§¯åœ¨ä¸€èµ·ï¼Œå¯¼å…¥çš„æ—¶å€™ï¼Œå°±ä¼šå¾ˆæ··ä¹±ã€‚Googleä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å°†è¦ä½¿ç”¨è‡ªå®šä¹‰Viewæˆ–ViewGroupç±»åä¸å±æ€§æ–‡ä»¶å†…çš„å£°æ˜å‘½åè®¾ç½®å…³è”ï¼Œå¦‚å›¾ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160530101952575" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>æ„æ€æ˜¯ç±»åè¦å’Œè‡ªå®šä¹‰å±æ€§æ–‡ä»¶çš„å‘½åä¸€è‡´ã€‚</p>
<p>å¦‚æœä¸ä¸€è‡´ä¼šå‡ºç°æƒ…å†µå‘¢ï¼Ÿæˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼Œæ›´æ”¹è‡ªå®šä¹‰å±æ€§æ–‡ä»¶çš„å‘½åï¼Œå¦‚å›¾ï¼š<img data-src="http://img.blog.csdn.net/20160530102219469" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å‡ºç°çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160530102257942" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å’¦ï¼Œè‡ªå®šä¹‰å±æ€§æ€ä¹ˆæ²¡æœ‰äº†ï¼Ÿè¿™å°±æ˜¯è‡ªå®šä¹‰Viewæˆ–ViewGroupç±»åä¸å±æ€§æ–‡ä»¶å†…çš„å£°æ˜å‘½åä¸ä¸€è‡´ï¼ŒASæ‰¾ä¸åˆ°å…³è”ã€‚</p>
<p>çŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œæˆ‘ä»¬åœ¨æ”¹å›æ¥è¯•è¯•ï¼Œå¦‚å›¾ï¼š<br />
<img data-src="http://img.blog.csdn.net/20160530102544553" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" /></p>
<p>å“ˆï¼Œå¤ªæ£’äº†ï¼Œè‡ªå®šä¹‰å±æ€§åˆå›æ¥äº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹å“¦ï¼Œåœ¨è‡ªå®šä¹‰Viewæˆ–ViewGroupæ¶‰åŠonSaveInstanceState()æˆ–onRestoreInstanceState()æ—¶ï¼Œå¦‚æœè‡ªå®šä¹‰çš„Viewæˆ–ViewGroupæ²¡æœ‰è®¾ç½®ä¸€ä¸ªidçš„è¯ï¼ŒçŠ¶æ€æ˜¯æ— æ³•æ¢å¤çš„ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„äº”å­æ£‹å°æ¸¸æˆï¼Œæ ¹æ®é¸¿æ´‹å¤§ç¥æ•™ç¨‹æ‰€å†™ã€‚</p>
<p>è°¢è°¢ï¼<br />
<a href="https://github.com/guodongAndroid/GameWuZiQi.git">æºç åœ°å€</a></p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=135768&auto=1&height=66"></iframe>]]></content>
      <categories>
        <category>AndroidStudio</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>androidstudio</tag>
        <tag>è‡ªå®šä¹‰å±æ€§</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaASM-åŸºç¡€-ASMç®€ä»‹</title>
    <url>/2022/07/19/ASM/JavaASM-%E5%9F%BA%E7%A1%80-ASM%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h1 id="javaasm-åŸºç¡€-asmç®€ä»‹"><a class="markdownIt-Anchor" href="#javaasm-åŸºç¡€-asmç®€ä»‹"></a> JavaASM-åŸºç¡€-ASMç®€ä»‹</h1>
<h2 id="1asmæ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#1asmæ˜¯ä»€ä¹ˆ"></a> 1.ASMæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>ç®€å•æ¥è¯´ï¼Œ<strong><a href="https://asm.ow2.io/">ASM</a> æ˜¯ä¸€ä¸ªæ“ä½œ Java å­—èŠ‚ç çš„ç±»åº“</strong>ã€‚å®ƒå¯ä»¥ç”¨äºä¿®æ”¹ç°æœ‰çš„ class æ–‡ä»¶æˆ–åŠ¨æ€ç”Ÿæˆ class æ–‡ä»¶ã€‚</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€ä¸ª <code>.java</code> æºæ–‡ä»¶ç»è¿‡ Java ç¼–è¯‘å™¨(<code>javac</code>) ç¼–è¯‘ä¹‹åä¼šç”Ÿæˆä¸€ä¸ª <code>.class</code> æ–‡ä»¶ã€‚åœ¨ <code>.class</code> æ–‡ä»¶ä¸­å­˜å‚¨ç€ä¸€å®šè§„åˆ™çš„å­—èŠ‚ç æ•°æ®(ByteCode)ï¼ŒASM æ“ä½œçš„å¯¹è±¡å°±æ˜¯å­—èŠ‚ç ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå­—èŠ‚ç éƒ½å­˜åœ¨äº <code>.class</code> æ–‡ä»¶ä¸­ã€‚</p>
<p>ASM é¦–å…ˆè¯»å– <code>.class</code> æ–‡ä»¶ä¸­çš„å­—èŠ‚ç æ•°æ®ï¼ŒæŒ‰ç…§ä¸€å®šè§„åˆ™è§£æå­—èŠ‚ç æ•°æ®ï¼Œåˆ†è§£æˆå¤šä¸ªéƒ¨åˆ†ï¼Œç„¶åå¯¹æŸä¸ªæˆ–å¤šä¸ªéƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œæœ€åå†å°†åˆ†è§£å’Œä¿®æ”¹åçš„éƒ¨åˆ†é‡æ–°æŒ‰ç…§è§„åˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>.class</code> æ–‡ä»¶<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ã€‚</p>
<h2 id="2asmèƒ½åšä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#2asmèƒ½åšä»€ä¹ˆ"></a> 2.ASMèƒ½åšä»€ä¹ˆï¼Ÿ</h2>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li>
<p><a href="https://asm.ow2.io/">ASMå®˜ç½‘</a></p>
</li>
<li>
<p><a href="https://gitlab.ow2.org/asm/asm">ASMæºç </a></p>
</li>
<li>
<p><a href="https://asm.ow2.io/javadoc/index.html">ASM APIæ–‡æ¡£</a></p>
</li>
<li>
<p><a href="https://asm.ow2.io/asm4-guide.pdf">ASMä½¿ç”¨æ‰‹å†Œ</a></p>
</li>
<li></li>
</ul>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/ObjectWeb_ASM">ObjectWeb ASM - Wikipedia</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>ASM</category>
      </categories>
      <tags>
        <tag>asm</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-EventBusä¿®æ”¹çºªå®(ä¸€)-å¿…è¾¾äº‹ä»¶</title>
    <url>/2022/06/01/Android/Android-EventBus%E4%BF%AE%E6%94%B9%E7%BA%AA%E5%AE%9E(%E4%B8%80)-%E5%BF%85%E8%BE%BE%E4%BA%8B%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="android-eventbusä¿®æ”¹çºªå®"><a class="markdownIt-Anchor" href="#android-eventbusä¿®æ”¹çºªå®"></a> Android-EventBusä¿®æ”¹çºªå®</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 3 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>ç¬”è€…åœ¨ä½¿ç”¨ EventBus çš„è¿‡ç¨‹ä¸­å‘ç°æœ‰æ—¶åªèƒ½æ”¶åˆ°æœ€åä¸€æ¬¡çš„é»æ€§ Event ï¼Œå¯¼è‡´ä¸šåŠ¡é€»è¾‘å‡ºç°æ··ä¹±ï¼Œä¸‹é¢æ˜¯ç¬”è€…çš„ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Event.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Event</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Example.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å¤šæ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        EventBus.getDefault().postSticky(<span class="keyword">new</span> <span class="title class_">Event</span>(code));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨å¤šæ¬¡ `test(int code)` åå†æ³¨å†Œè®¢é˜…è€…</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> &#123;</span><br><span class="line">        EventBus.getDefault().register(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, sticky = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘ç°åªèƒ½æ”¶åˆ°æœ€åä¸€æ¬¡çš„é»æ€§äº‹ä»¶</span></span><br><span class="line">        System.out.println(event.getCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å»æŸ¥çœ‹äº† EventBus çš„æºç ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹ EventBus å‘é€é»æ€§äº‹ä»¶çš„æµç¨‹ã€‚</p>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<h3 id="é»æ€§äº‹ä»¶"><a class="markdownIt-Anchor" href="#é»æ€§äº‹ä»¶"></a> é»æ€§äº‹ä»¶</h3>
<blockquote>
<p>ä»¥ä¸‹æºç åŸºäº EventBus 3.3.1 ç‰ˆæœ¬</p>
</blockquote>
<p>ä¸‹é¢æ˜¯å‘é€é»æ€§äº‹ä»¶çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postSticky</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (stickyEvents) &#123;</span><br><span class="line">        stickyEvents.put(event.getClass(), event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Should be posted after it is putted, in case the subscriber wants to remove immediately</span></span><br><span class="line">    post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>postSticky</code> ä»£ç æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆå¯¹ <code>stickyEvents</code> è¿›è¡ŒåŠ é”ï¼Œæ¥ä¸‹æ¥æŠŠ event äº‹ä»¶çš„ Class å¯¹è±¡ä½œä¸º Keyï¼Œevent äº‹ä»¶æœ¬èº«ä½œä¸º value æ”¾è¿› Map ä¸­ï¼Œå…¶ä¸­<code>stickyEvents</code> æ˜¯ Map å¯¹è±¡ï¼Œå®ä¾‹æ˜¯ <code>ConcurrentHashMap</code>, å…¶ Key å’Œ Value çš„æ³›å‹å½¢å‚åˆ†åˆ«æ˜¯ <code>Class&lt;?&gt;</code> å’Œ <code>Object</code>, å®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥å­˜å‚¨é»æ€§äº‹ä»¶ï¼›ç„¶åè°ƒç”¨ <code>post(event)</code> æŠŠé»æ€§äº‹ä»¶å½“ä½œæ™®é€šäº‹ä»¶å‘é€ä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹æœ€åä¸ºä»€ä¹ˆè¦è°ƒç”¨ä¸‹ <code>post(event)</code>ï¼Ÿ</p>
<p>è™½ç„¶ <code>post(evnet)</code> ä¸Šé¢æœ‰æ³¨é‡Šï¼Œç®€å•ç¿»è¯‘ä¸‹ï¼šâ€œåœ¨æ”¾è¿› Map ååº”è¯¥å†å‘é€ä¸€æ¬¡ï¼Œä»¥é˜²æ­¢è®¢é˜…è€…æƒ³ç«‹å³åˆ é™¤æ­¤äº‹ä»¶â€ï¼Œè¯»å®Œæ³¨é‡Šåï¼Œå¯èƒ½è¿˜æ˜¯ä¸å¤ªæ˜ç™½ï¼Œè¿™é‡Œç¬”è€…è®¤ä¸ºï¼šåœ¨å‰é¢å­˜å‚¨å®Œé»æ€§äº‹ä»¶åï¼Œè¿™é‡Œè°ƒç”¨ <code>post</code> æŠŠé»æ€§äº‹ä»¶å½“ä½œæ™®é€šäº‹ä»¶å‘é€å‡ºå»ï¼Œæˆ–è®¸æ˜¯å› ä¸ºç°åœ¨å·²ç»æœ‰æ³¨å†Œçš„é»æ€§äº‹ä»¶è®¢é˜…è€…ï¼Œæ­¤æ—¶æŠŠå·²ç»æ³¨å†Œçš„é»æ€§äº‹ä»¶è®¢é˜…è€…å½“ä½œæ™®é€šäº‹ä»¶çš„è®¢é˜…è€…ï¼Œè¿™æ ·å·²ç»æ³¨å†Œçš„é»æ€§äº‹ä»¶è®¢é˜…è€…å¯ä»¥ç«‹å³æ”¶åˆ°ç›¸åº”çš„äº‹ä»¶ï¼Œåªæ˜¯æ­¤æ—¶äº‹ä»¶ä¸å†æ˜¯é»æ€§çš„ã€‚</p>
<p>åœ¨ <code>postSticky</code> ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°é»æ€§äº‹ä»¶æ˜¯åœ¨å“ªé‡Œå‘é€çš„ï¼Œæƒ³ä¸€æƒ³æˆ‘ä»¬ä½¿ç”¨é»æ€§äº‹ä»¶çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ<strong>å½“æ³¨å†Œè®¢é˜…è€…æ—¶å¯ä»¥æ”¶åˆ°ä¹‹å‰å‘é€çš„äº‹ä»¶</strong>ï¼Œè¿™æ ·æ¥çœ‹ï¼Œé»æ€§äº‹ä»¶çš„å‘é€æ˜¯åœ¨æ³¨å†Œè®¢é˜…è€…æ—¶ï¼Œä¸‹é¢æ˜¯æ³¨å†Œè®¢é˜…è€…çš„æºç ï¼Œåˆ é™¤äº†ä¸€äº›æ— å…³ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object subscriber)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">    </span><br><span class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾è®¢é˜…è€…æ‰€æœ‰çš„Eventæ¥æ”¶æ–¹æ³•</span></span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">            subscribe(subscriber, subscriberMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>register</code> ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆé€šè¿‡è®¢é˜…è€…çš„ Class å¯¹è±¡æŸ¥æ‰¾è®¢é˜…è€…æ‰€æœ‰çš„Eventäº‹ä»¶æ¥æ”¶æ–¹æ³•ï¼Œç„¶åå¯¹ EventBus å¯¹è±¡åŠ é”ï¼Œéå†æ‰€æœ‰çš„Eventäº‹ä»¶æ¥æ”¶æ–¹æ³• <code>subscriberMethods</code> è°ƒç”¨ <code>subscribe</code> æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯ <code>subscribe</code> æ–¹æ³•æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Key ä¸º Event Class å¯¹è±¡ï¼ŒValue ä¸ºå­˜å‚¨ Event çš„è®¢é˜…è€…å’Œæ¥æ”¶ Event æ–¹æ³•å¯¹è±¡çš„é›†åˆ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Key ä¸ºè®¢é˜…è€…å¯¹è±¡ï¼ŒValue ä¸ºè®¢é˜…è€…ä¸­çš„ Event Classå¯¹è±¡é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Must be called in synchronized block</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> &#123;</span><br><span class="line">    <span class="comment">// Event Classå¯¹è±¡</span></span><br><span class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¢é˜…è€…å’Œæ¥æ”¶ Event æ–¹æ³•å¯¹è±¡</span></span><br><span class="line">    <span class="type">Subscription</span> <span class="variable">newSubscription</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Subscription</span>(subscriber, subscriberMethod);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ® Event Classå¯¹è±¡ï¼Œè·å–è®¢é˜…è€…å’Œæ¥æ”¶ Event æ–¹æ³•å¯¹è±¡çš„é›†åˆ</span></span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è®¢é˜…è€…å’Œæ¥æ”¶ Event æ–¹æ³•å¯¹è±¡æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (subscriptions == <span class="literal">null</span>) &#123;</span><br><span class="line">        subscriptions = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">        subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»åŒ…å«äº†æ–°çš„è®¢é˜…è€…å’Œæ¥æ”¶ Event æ–¹æ³•å¯¹è±¡ï¼Œè‹¥æ˜¯åŒ…å«åˆ™è®¤ä¸ºæ˜¯é‡å¤æ³¨å†Œ</span></span><br><span class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Subscriber &quot;</span> + subscriber.getClass() + <span class="string">&quot; already registered to event &quot;</span></span><br><span class="line">                                        + eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯æŒ‰ä¼˜å…ˆçº§æ’åºæ’å…¥åˆ°é›†åˆä¸­</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> subscriptions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">            subscriptions.add(i, newSubscription);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯æŠŠ Event Classå¯¹è±¡æ·»åŠ è¿›å¯¹åº”è®¢é˜…è€…çš„ Event Classå¯¹è±¡é›†åˆä¸­</span></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="literal">null</span>) &#123;</span><br><span class="line">        subscribedEvents = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸Šé¢å·²ç»åˆ¤æ–­äº†æ˜¯å¦é‡å¤æ³¨å†Œï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æ·»åŠ </span></span><br><span class="line">    subscribedEvents.add(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥å°±æ˜¯é»æ€§äº‹ä»¶çš„å‘é€é€»è¾‘äº†</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ Event æ¥æ”¶æ–¹æ³•æ˜¯å¦å¯ä»¥å¤„ç†é»æ€§äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œåˆ¤æ–­æ˜¯å¦è€ƒè™‘ Event äº‹ä»¶ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œé»˜è®¤ä¸º Ture</span></span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></span><br><span class="line">            <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></span><br><span class="line">            <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></span><br><span class="line">            <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„æºç ä¸­ï¼Œå¢åŠ äº†ä¸å°‘æ³¨é‡Šæœ‰åŠ©äºæˆ‘ä»¬è¯»æ‡‚æºç ï¼Œåœ¨æºç çš„æœ€åå°±æ˜¯é»æ€§äº‹ä»¶çš„å‘é€é€»è¾‘äº†ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œå…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ ¹æ® Event äº‹ä»¶çš„ç»§æ‰¿å…³ç³»å‘é€äº‹ä»¶ï¼Œå¦å¤–ä¸€ä¸ªåˆ†æ”¯æ ¹æ®æ¥æ”¶ Event æ–¹æ³•ä¸­çš„ Event Class å¯¹è±¡ä» <code>stickyEvents</code> ä¸­ç›´æ¥æŸ¥æ‰¾é»æ€§äº‹ä»¶ï¼Œæœ€åä¸¤ä¸ªåˆ†æ”¯æ®Šé€”åŒå½’ï¼Œéƒ½è°ƒç”¨äº† <code>checkPostStickyEventToSubscription</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkPostStickyEventToSubscription</span><span class="params">(Subscription newSubscription, Object stickyEvent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stickyEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)</span></span><br><span class="line">        <span class="comment">// --&gt; Strange corner case, which we don&#x27;t take care of here.</span></span><br><span class="line">        postToSubscription(newSubscription, stickyEvent, isMainThread());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>checkPostStickyEventToSubscription</code> æ–¹æ³•å¾ˆç®€å•ï¼Œå¯¹é»æ€§äº‹ä»¶åšä¸‹åˆ¤ç©ºå¤„ç†ï¼Œç»§ç»­è°ƒç”¨ <code>postToSubscription</code> æ–¹æ³•ï¼Œä¼ å…¥è®¢é˜…è€…ä¸æ¥æ”¶ Event æ–¹æ³•å¯¹è±¡ï¼Œé»æ€§äº‹ä»¶å’Œæ˜¯å¦æ˜¯ä¸»çº¿ç¨‹å¸ƒå°”å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="type">boolean</span> isMainThread)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="literal">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;A</span><br><span class="line">                <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unknown thread mode: &quot;</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>postToSubscription</code> æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯æ ¹æ®æ¥æ”¶ Event æ–¹æ³•ä¸Šçš„ <code>@Subscribe</code> æ³¨è§£ä¸­ä¼ å…¥çš„çº¿ç¨‹æ¨¡å‹è¿›è¡Œäº‹ä»¶çš„åˆ†å‘ï¼Œå…·ä½“çš„äº‹ä»¶åˆ†å‘æµç¨‹ï¼Œæœ‰ç©ºå†åˆ†æï¼Œæœ¬æ–‡å°±å…ˆä¸åˆ†æäº†ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€çŸ¥é“æœ€åéƒ½ä¼šè°ƒç”¨ <code>invokeSubscriber(Subscription subscription, Object event)</code> æ–¹æ³•å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åå°„è°ƒç”¨ Event æ¥æ”¶æ–¹æ³•ä¼ å…¥ Event äº‹ä»¶</span></span><br><span class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        handleSubscriberException(subscription, event, e.getCause());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»ˆäºåœ¨ <code>invokeSubscriber</code> æ–¹æ³•ä¸­æ‰¾åˆ°è°ƒç”¨ Event æ¥æ”¶æ–¹æ³•çš„åœ°æ–¹äº†ï¼ŒåŸæ¥ EventBus æœ€åæ˜¯é€šè¿‡åå°„è°ƒç”¨ Event æ¥æ”¶æ–¹æ³•å¹¶ä¼ å…¥ç›¸åº” Event äº‹ä»¶çš„ã€‚</p>
<p>åˆ†æå®Œ Event äº‹ä»¶çš„å‘é€æµç¨‹ï¼Œå¥½åƒæ²¡æœ‰å‘ç°ä¸ºä»€ä¹ˆæœ‰æ—¶æ”¶ä¸åˆ°é»æ€§äº‹ä»¶ã€‚</p>
<p>æˆ‘ä»¬å›è¿‡å¤´æ¥å†çœ‹ä¸‹ç¬”è€…çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œä¸‹é¢è´´å‡ºä½¿ç”¨ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Example.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å¤šæ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        EventBus.getDefault().postSticky(<span class="keyword">new</span> <span class="title class_">Event</span>(code));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨å¤šæ¬¡ `test(int code)` åå†æ³¨å†Œè®¢é˜…è€…</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> &#123;</span><br><span class="line">        EventBus.getDefault().register(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, sticky = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘ç°åªèƒ½æ”¶åˆ°æœ€åä¸€æ¬¡çš„é»æ€§äº‹ä»¶</span></span><br><span class="line">        System.out.println(event.getCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½ç»†å¿ƒçš„è¯»è€…å·²ç»å‘ç° <code>test</code> æ–¹æ³•è°ƒç”¨äº†ï¼Œé—®é¢˜åº”è¯¥å‡ºåœ¨ <code>postSticky</code> æ–¹æ³•ä¸­ï¼Œè®©æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ <code>postSticky</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postSticky</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (stickyEvents) &#123;</span><br><span class="line">        stickyEvents.put(event.getClass(), event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Should be posted after it is putted, in case the subscriber wants to remove immediately</span></span><br><span class="line">    post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å‰é¢åˆ†æ <code>postSticky</code> æ–¹æ³•çš„ç»“æœï¼Œ<code>stickyEvents</code> ç”¨äºå­˜å‚¨é»æ€§äº‹ä»¶ï¼Œå®ƒæ˜¯ä¸ª Map ç»“æ„ï¼Œè€Œ <code>stickyEvents</code> çš„ Key æ­£æ˜¯ Event çš„ Class å¯¹è±¡ï¼Œæ ¹æ® Map ç»“æ„çš„å­˜å‚¨åŸç†ï¼šå¦‚æœå­˜åœ¨ç›¸åŒçš„ Keyï¼Œåˆ™è¦†ç›– Value çš„å€¼ï¼Œè€Œ <code>stickyEvents</code> çš„ Value æ­£æ˜¯ Event æœ¬èº«ã€‚</p>
<p>ç»ˆäºçœŸç›¸å¤§ç™½ï¼Œå¤šæ¬¡è°ƒç”¨ <code>test</code> æ–¹æ³•å‘é€é»æ€§äº‹ä»¶ï¼ŒEventBus åªä¼šå­˜å‚¨æœ€åä¸€æ¬¡çš„é»æ€§äº‹ä»¶ã€‚</p>
<h3 id="å°ç»“"><a class="markdownIt-Anchor" href="#å°ç»“"></a> å°ç»“</h3>
<p><strong>EventBus é’ˆå¯¹åŒä¸€ä¸ªé»æ€§ Event äº‹ä»¶åªä¼šå­˜å‚¨æœ€åä¸€æ¬¡å‘é€çš„é»æ€§äº‹ä»¶ã€‚</strong></p>
<p>EventBus çš„ä¸Šè¿°å®ç°å¯èƒ½æ˜¯å› ä¸ºå¤šæ¬¡å‘é€åŒä¸€ä¸ªé»æ€§äº‹ä»¶ï¼Œåˆ™è®¤ä¸ºä¹‹å‰çš„äº‹ä»¶æ˜¯è¿‡æœŸäº‹ä»¶åº”è¯¥æŠ›å¼ƒï¼Œå› æ­¤åªä¼ é€’æœ€æ–°çš„é»æ€§äº‹ä»¶ã€‚</p>
<p>EventBus çš„è¿™ç§å®ç°æ— æ³•æ»¡è¶³ç¬”è€…çš„ä¸šåŠ¡é€»è¾‘éœ€æ±‚ï¼Œç¬”è€…å¸Œæœ›å¤šæ¬¡å‘é€çš„é»æ€§äº‹ä»¶ï¼Œè®¢é˜…è€…éƒ½èƒ½æ¥æ”¶åˆ°ï¼Œè€Œä¸æ˜¯åªæ¥æ”¶æœ€æ–°çš„é»æ€§äº‹ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºé»æ€§äº‹ä»¶å¿…è¾¾è®¢é˜…è€…ï¼Œä¸‹é¢è®©æˆ‘ä»¬ä¿®æ”¹ EventBus çš„æºç æ¥æ»¡è¶³éœ€æ±‚å§ã€‚</p>
<h2 id="ä¿®æ”¹"><a class="markdownIt-Anchor" href="#ä¿®æ”¹"></a> ä¿®æ”¹</h2>
<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº†é»æ€§äº‹ä»¶çš„å‘é€æµç¨‹ï¼Œä¸ºäº†æ»¡è¶³é»æ€§äº‹ä»¶å¿…è¾¾çš„éœ€æ±‚ï¼ŒåŸºäºç°æœ‰é»æ€§äº‹ä»¶æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»¿ç…§é»æ€§äº‹ä»¶çš„å‘é€æ¥æä¾›ä¸€ä¸ªå‘é€å¿…è¾¾æ¶ˆæ¯çš„æ–¹æ³•ã€‚</p>
<h3 id="subscribe"><a class="markdownIt-Anchor" href="#subscribe"></a> Subscribe</h3>
<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ Event æ¥æ”¶æ–¹æ³•å¯ä»¥æ¥æ”¶é»æ€§äº‹ä»¶æ˜¯åœ¨ <code>@Subscribe</code> ä¸­ <code>sticky = true</code> , æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>Subscribe</code> æ³¨è§£ï¼Œå¢åŠ é»æ€§äº‹ä»¶å¿…è¾¾çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subscribe &#123;</span><br><span class="line">    ThreadMode <span class="title function_">threadMode</span><span class="params">()</span> <span class="keyword">default</span> ThreadMode.POSTING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If true, delivers the most recent sticky event (posted with</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EventBus#postSticky(Object)&#125;) to this subscriber (if event available).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">sticky</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ æ¶ˆæ¯å¿…è¾¾çš„æ–¹æ³•</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">rendezvous</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Subscriber priority to influence the order of event delivery.</span></span><br><span class="line"><span class="comment">     * Within the same delivery thread (&#123;<span class="doctag">@link</span> ThreadMode&#125;), higher priority subscribers will receive events before</span></span><br><span class="line"><span class="comment">     * others with a lower priority. The default priority is 0. Note: the priority does *NOT* affect the order of</span></span><br><span class="line"><span class="comment">     * delivery among subscribers with different &#123;<span class="doctag">@link</span> ThreadMode&#125;s! */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">priority</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>rendezvous</code> ä»¥ä¸ºçº¦ä¼šã€çº¦å®šçš„æ„æ€ï¼Œå¯ä»¥ç†è§£ä¸ºä¸è§ä¸æ•£ï¼Œåœ¨è¿™é‡Œå®ƒæœ‰ä¸¤å±‚ä½œç”¨ï¼Œå…¶ä¸€æ˜¯æ ‡è®°æ–¹æ³•å¯ä»¥æ¥æ”¶é»æ€§äº‹ä»¶ï¼Œå…¶äºŒæ˜¯æ ‡è®°æ–¹æ³•æ¥æ”¶çš„äº‹ä»¶æ˜¯å¿…è¾¾çš„ã€‚</p>
<h3 id="findsubscribermethods"><a class="markdownIt-Anchor" href="#findsubscribermethods"></a> findSubscriberMethods</h3>
<p>æ¥ä¸‹æ¥å°±éœ€è¦è§£æ <code>rendezvous</code> äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ <code>sticky</code> æ˜¯å¦‚ä½•è§£æçš„ï¼Œåœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº† <code>register</code> æ–¹æ³•ï¼Œæ–¹ä¾¿æŸ¥çœ‹ï¼Œä¸‹é¢å†è´´å‡º <code>register</code> æ–¹æ³•æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object subscriber)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">    </span><br><span class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾è®¢é˜…è€…æ‰€æœ‰çš„Eventæ¥æ”¶æ–¹æ³•</span></span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">            subscribe(subscriber, subscriberMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šä¸€èŠ‚åˆ†æä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åˆ†ææŸ¥æ‰¾è®¢é˜…è€…ä¸­æ‰€æœ‰çš„ Event æ¥æ”¶æ–¹æ³• <code>findSubscriberMethods</code> ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹åœ¨ <code>findSubscriberMethods</code> æ–¹æ³•æ˜¯å¦‚ä½•æŸ¥æ‰¾ Event æ¥æ”¶æ–¹æ³•çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;SubscriberMethod&gt; <span class="title function_">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾</span></span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¿½ç•¥ç”Ÿæˆç´¢å¼•ï¼Œé»˜è®¤ä¸ºFalseï¼Œæ‰€ä»¥è¿™é‡Œèµ°elseåˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</span><br><span class="line">        subscriberMethods = findUsingReflection(subscriberClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾Eventæ¥æ”¶æ–¹æ³•</span></span><br><span class="line">        subscriberMethods = findUsingInfo(subscriberClass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœè®¢é˜…è€…å’Œè®¢é˜…è€…çˆ¶ç±»ä¸­æ²¡æœ‰Eventæ¥æ”¶æ–¹æ³•åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Subscriber &quot;</span> + subscriberClass</span><br><span class="line">                                    + <span class="string">&quot; and its super classes have no public methods with the @Subscribe annotation&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ è¿›ç¼“å­˜ä¸­</span></span><br><span class="line">        METHOD_CACHE.put(subscriberClass, subscriberMethods);</span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>findSubscriberMethods</code> æ–¹æ³•éœ€è¦ä¼ å…¥è®¢é˜…è€… Class å¯¹è±¡ï¼Œé€šè¿‡ç¬”è€…åœ¨æºç ä¸­å¢åŠ çš„æ³¨é‡Šåˆ†æå‘ç°é»˜è®¤è°ƒç”¨ <code>findUsingInfo</code> æ–¹æ³•æŸ¥æ‰¾ Event æ¥æ”¶æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ª <code>findUsingInfo</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title function_">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> &#123;</span><br><span class="line">    <span class="comment">// FindStateå¯¹è®¢é˜…è€…Classå¯¹è±¡å’ŒEventæ¥æ”¶æ–¹æ³•è¿›è¡Œäº†ä¸€å±‚å°è£…</span></span><br><span class="line">    <span class="type">FindState</span> <span class="variable">findState</span> <span class="operator">=</span> prepareFindState();</span><br><span class="line">    findState.initForSubscriber(subscriberClass); <span class="comment">// â‘ </span></span><br><span class="line">    <span class="keyword">while</span> (findState.clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾è®¢é˜…è€…ä¿¡æ¯ï¼ŒåŒ…å«è®¢é˜…è€…Classå¯¹è±¡ã€ è®¢é˜…è€…çˆ¶ç±»ã€Eventæ¥æ”¶æ–¹æ³•ç­‰</span></span><br><span class="line">        findState.subscriberInfo = getSubscriberInfo(findState); <span class="comment">// â‘¡</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœ¨ â‘  initForSubscriberä¸­ä¼šæŠŠsubscriberInfoç½®ä¸ºnullï¼Œ</span></span><br><span class="line">        <span class="comment">// åœ¨ â‘¡ getSubscriberInfoä¸­æ²¡æœ‰Indexå¯¹è±¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ç¬¬ä¸€æ¬¡æ—¶è¿™é‡Œä¼šèµ°elseåˆ†æ”¯</span></span><br><span class="line">        <span class="keyword">if</span> (findState.subscriberInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</span><br><span class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</span><br><span class="line">                <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</span><br><span class="line">                    findState.subscriberMethods.add(subscriberMethod);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æŸ¥æ‰¾Eventæ¥æ”¶æ–¹æ³•</span></span><br><span class="line">            findUsingReflectionInSingleClass(findState);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾çˆ¶ç±»çš„Eventæ¥æ”¶æ–¹æ³•</span></span><br><span class="line">        findState.moveToSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šè¿‡findStateè¿”å›Eventæ¥æ”¶æ–¹æ³•ï¼Œå¹¶å›æ”¶findState</span></span><br><span class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ç¬”è€…åœ¨æºç ä¸­çš„æ³¨é‡Šåˆ†æï¼Œåœ¨ <code>findUsingInfo</code> æ–¹æ³•ä¸­ä½¿ç”¨ã€Œäº«å…ƒæ¨¡å¼ã€å¯¹ <code>FindState</code> è¿›è¡Œå›æ”¶åˆ©ç”¨ï¼Œé¿å…åˆ›å»ºå¤§é‡ä¸´æ—¶çš„ <code>FindState</code> å¯¹è±¡å ç”¨å†…å­˜ï¼Œæœ€åå†æ¬¡è°ƒç”¨ <code>findUsingReflectionInSingleClass</code> æ–¹æ³•æŸ¥æ‰¾ Event æ¥æ”¶æ–¹æ³•ï¼Œçœ‹æ–¹æ³•åå­—åº”è¯¥æ˜¯ä½¿ç”¨åå°„æŸ¥æ‰¾ï¼Œ<code>findUsingReflectionInSingleClass</code> æºç è¾ƒé•¿ï¼Œåˆ å‡ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> &#123;</span><br><span class="line">    Method[] methods;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è·å–å½“å‰ç±»ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">        methods = findState.clazz.getDeclaredMethods();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">        <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–æ–¹æ³•çš„ä¿®é¥°ç¬¦</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">modifiers</span> <span class="operator">=</span> method.getModifiers();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ–¹æ³•æ˜¯å¦æ˜¯publicçš„ï¼›æ˜¯å¦æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯é™æ€æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯æ¡¥æ¥æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯åˆæˆæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•çš„å½¢å‚Classå¯¹è±¡æ•°ç»„</span></span><br><span class="line">            Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">            <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è·å–æ–¹æ³•ä¸Šçš„Subscribeæ³¨è§£</span></span><br><span class="line">                <span class="type">Subscribe</span> <span class="variable">subscribeAnnotation</span> <span class="operator">=</span> method.getAnnotation(Subscribe.class);</span><br><span class="line">                <span class="keyword">if</span> (subscribeAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ£€æµ‹æ˜¯å¦å·²ç»æ·»åŠ äº†ç›¸åŒç­¾åçš„æ–¹æ³•ï¼Œè€ƒè™‘å­ç±»å¤å†™çˆ¶ç±»æ–¹æ³•çš„æƒ…å†µ</span></span><br><span class="line">                    <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// è·å–æ³¨è§£çš„å‚æ•°</span></span><br><span class="line">                        <span class="type">ThreadMode</span> <span class="variable">threadMode</span> <span class="operator">=</span> subscribeAnnotation.threadMode();</span><br><span class="line">                        findState.subscriberMethods.add(<span class="keyword">new</span> <span class="title class_">SubscriberMethod</span>(method, eventType, threadMode,</span><br><span class="line">								subscribeAnnotation.priority(), subscribeAnnotation.sticky(),</span><br><span class="line">								</span><br><span class="line">								<span class="comment">// è¿™é‡Œæˆ‘ä»¬æ·»åŠ rendezvouså‚æ•° â‘ </span></span><br><span class="line">								subscribeAnnotation.rendezvous()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>findUsingReflectionInSingleClass</code> æ–¹æ³•ä¸­é€šè¿‡åå°„è·å–è®¢é˜…è€…ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ–¹æ³•ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­æ–¹æ³•çš„ä¿®é¥°ç¬¦æ˜¯å¦ç¬¦åˆï¼Œ</li>
<li>å…¶æ¬¡åˆ¤æ–­æ–¹æ³•æ˜¯å¦åªæœ‰ä¸€ä¸ªå½¢å‚ï¼Œ</li>
<li>å†æ¬¡åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰ <code>Subscribe</code> æ³¨è§£ï¼Œ</li>
<li>ç„¶åæ£€æµ‹æ˜¯å¦å·²ç»æ·»åŠ äº†ç›¸åŒç­¾åçš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯è€ƒè™‘å­ç±»å¤å†™çˆ¶ç±»æ–¹æ³•è¿™ç§æƒ…å†µï¼Œ</li>
<li>æœ€åè·å– <code>Subscribe</code> æ³¨è§£çš„å‚æ•°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è§£æ <code>rendezvous</code>ï¼Œå°è£…è¿› <code>SubscriberMethod</code> ä¸­ã€‚</li>
</ol>
<p>åœ¨ <code>SubscriberMethod</code> ä¸­å¢åŠ  <code>rendezvous</code> å­—æ®µï¼Œåˆ é™¤ä¸å…³å¿ƒçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubscriberMethod</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">final</span> ThreadMode threadMode;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; eventType;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> priority;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> sticky;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ  `rendezvous` å­—æ®µ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> rendezvous;</span><br><span class="line">    <span class="comment">/** Used for efficient comparison */</span></span><br><span class="line">    String methodString;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SubscriberMethod</span><span class="params">(Method method, Class&lt;?&gt; eventType, ThreadMode threadMode, </span></span><br><span class="line"><span class="params">                            <span class="type">int</span> priority, <span class="type">boolean</span> sticky,</span></span><br><span class="line"><span class="params">                            </span></span><br><span class="line"><span class="params">                            // å¢åŠ  `rendezvous` å½¢å‚</span></span><br><span class="line"><span class="params">                            <span class="type">boolean</span> rendezvous)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.method = method;</span><br><span class="line">        <span class="built_in">this</span>.threadMode = threadMode;</span><br><span class="line">        <span class="built_in">this</span>.eventType = eventType;</span><br><span class="line">        <span class="built_in">this</span>.priority = priority;</span><br><span class="line">        <span class="built_in">this</span>.sticky = sticky;</span><br><span class="line">        <span class="built_in">this</span>.rendezvous = rendezvous;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="postrendezvous"><a class="markdownIt-Anchor" href="#postrendezvous"></a> postRendezvous</h3>
<p>å¥½çš„ï¼Œ<code>rendezvous</code> å·²ç»è§£æå‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹å¤–æä¾›å‘é€å¿…è¾¾äº‹ä»¶çš„æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€‰æ‹©Listå­˜å‚¨å¿…è¾¾äº‹ä»¶ï¼Œä½¿ç”¨Pairå°è£…å¿…è¾¾äº‹ä»¶çš„Keyå’ŒValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Class&lt;?&gt;, Object&gt;&gt; rendezvousEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postRendezvous</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (rendezvousEvents) &#123;</span><br><span class="line">        rendezvousEvents.add(Pair.create(event.getClass(), event));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Should be posted after it is putted, in case the subscriber wants to remove immediately</span></span><br><span class="line">    post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬é€šè¿‡ä»¿ç…§ <code>postSticky</code> æ–¹æ³•å®ç°äº† <code>postRendezvous</code> æ–¹æ³•ï¼Œåœ¨ <code>postSticky</code> æ–¹æ³•ä¸­ä½¿ç”¨ Map å­˜å‚¨é»æ€§äº‹ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬åœ¨ <code>postRendezvous</code> æ–¹æ³•ä¸­ä½¿ç”¨ List å­˜å‚¨å¿…è¾¾äº‹ä»¶ï¼Œä¿è¯å¿…è¾¾äº‹ä»¶ä¸ä¼šå› ä¸º Key ç›¸åŒè€Œè¢«è¦†ç›–ä¸¢å¤±ï¼Œæœ€åä¹Ÿæ˜¯è°ƒç”¨ <code>post</code> æ–¹æ³•å°è¯•å…ˆå‘é€ä¸€æ¬¡å¿…è¾¾äº‹ä»¶ã€‚</p>
<h3 id="register"><a class="markdownIt-Anchor" href="#register"></a> register</h3>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬åˆ†æäº†é»æ€§äº‹ä»¶æ˜¯åœ¨ <code>register</code> ä¸­è°ƒç”¨ <code>subscribe</code> æ–¹æ³•è¿›è¡Œå‘é€çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¿ç…§é»æ€§äº‹ä»¶çš„å‘é€é€»è¾‘ï¼Œå®ç°å¿…è¾¾äº‹ä»¶çš„å‘é€é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>subscribe</code> æ–¹æ³•æœ€åå¢åŠ å‘é€å¿…è¾¾äº‹ä»¶çš„é€»è¾‘ï¼Œä»¥ä¸‹æºç çœç•¥äº†ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Class&lt;?&gt;, Object&gt;&gt; rendezvousEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»æ€§äº‹ä»¶å‘é€é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å¢å¿…è¾¾äº‹ä»¶å‘é€é€»è¾‘</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–¹æ³•æ˜¯å¦å¯ä»¥æ¥æ”¶å¿…è¾¾äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.rendezvous) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Pair&lt;Class&lt;?&gt;, Object&gt; next : rendezvousEvents) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = next.first;</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> next.second;</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">rendezvousEvent</span> <span class="operator">=</span> getRendezvousEvent(eventType);</span><br><span class="line">            <span class="keyword">if</span> (rendezvousEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">                checkPostStickyEventToSubscription(newSubscription, rendezvousEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>subscribe</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä»¿ç…§é»æ€§äº‹ä»¶çš„å‘é€é€»è¾‘å¢åŠ äº†å¿…è¾¾äº‹ä»¶çš„å‘é€ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­ Event æ¥æ”¶æ–¹æ³•æ˜¯å¦å¯ä»¥æ¥æ”¶å¿…è¾¾äº‹ä»¶</li>
<li>å…¶æ¬¡è€ƒè™‘ Event å¿…è¾¾äº‹ä»¶çš„ç»§æ‰¿å…³ç³»ï¼Œ</li>
<li>æœ€åä¸¤ä¸ªåˆ†æ”¯éƒ½è°ƒç”¨ <code>checkPostStickyEventToSubscription</code> æ–¹æ³•å‘é€å¿…è¾¾äº‹ä»¶</li>
</ol>
<p>happy~</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œå‘ç°é—®é¢˜ä¸è¦æ…Œå¼ ï¼Œå¸¦ç€é—®é¢˜å»æŸ¥çœ‹æºç æ€»æœ‰ä¸€ç•ªæ”¶è·ï¼Œè¿™ä¹Ÿå‘Šè¯«æˆ‘ä»¬åœ¨ä½¿ç”¨ç¬¬ä¸‰åº“æ—¶æœ€å¥½å…ˆææ˜ç™½å®ƒçš„å®ç°åŸç†ï¼Œé‡åˆ°é—®é¢˜æ—¶ä¸è‡³äºæŸæ‰‹æ— ç­–ã€‚</p>
<p>é€šè¿‡åˆ†æ EventBus çš„æºç ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹æ”¶è·ï¼š</p>
<ol>
<li>æ˜ç™½äº†æˆ‘ä»¬æ³¨å†Œè®¢é˜…è€…æ—¶ EventBus åšäº†å“ªäº›äº‹æƒ…</li>
<li>çŸ¥æ™“äº†æˆ‘ä»¬å‘é€é»æ€§äº‹ä»¶æ—¶ï¼ŒEventBus æ˜¯å¦‚ä½•å¤„ç†åŠä½•æ—¶å‘é€é»æ€§äº‹ä»¶çš„</li>
<li>äº†è§£åˆ° EventBus æ˜¯é€šè¿‡åå°„è°ƒç”¨ Event äº‹ä»¶çš„æ¥æ”¶æ–¹æ³•</li>
<li>å­¦ä¹ äº† EventBus ä¸­çš„ä¸€äº›ä¼˜åŒ–ç‚¹ï¼Œæ¯”å¦‚å¯¹ <code>FindState</code> ä½¿ç”¨ã€Œäº«å…ƒæ¨¡å¼ã€é¿å…åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡å ç”¨å†…å­˜</li>
<li>è¿›ä¸€æ­¥äº†è§£åˆ°å¯¹å¹¶å‘çš„å¤„ç†</li>
</ol>
<p>é€šè¿‡ä»¥ä¸Šæ”¶è·ï¼Œæˆ‘ä»¬æˆåŠŸä¿®æ”¹ EventBus æºç å®ç°äº†æˆ‘ä»¬å¿…è¾¾äº‹ä»¶çš„éœ€æ±‚ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¿…è¾¾äº‹ä»¶çš„å‘é€ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜å‰©ä¸‹è·å–å¿…è¾¾äº‹ä»¶ï¼Œç§»é™¤å¿…è¾¾äº‹ä»¶æ²¡æœ‰å®ç°ï¼Œæœ€å EventBus ä¸­è¿˜æœ‰å•å…ƒæµ‹è¯• moduleï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰é’ˆå¯¹ <code>rendezvous</code> ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¯»è€…æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªå·±è¯•ç€å®ç°ã€‚</p>
<p>å¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ~</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>eventbus</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-EventBusä¿®æ”¹çºªå®(äºŒ)-çº¿ç¨‹æ¨¡å‹</title>
    <url>/2022/06/02/Android/Android-EventBus%E4%BF%AE%E6%94%B9%E7%BA%AA%E5%AE%9E(%E4%BA%8C)-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="android-eventbusä¿®æ”¹çºªå®äºŒ"><a class="markdownIt-Anchor" href="#android-eventbusä¿®æ”¹çºªå®äºŒ"></a> Android-EventBusä¿®æ”¹çºªå®(äºŒ)</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 4 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>åœ¨ä¸Šä¸€ç¯‡ <a href="https://juejin.cn/post/7104107150678917133">Android-EventBusä¿®æ”¹çºªå®</a> ä¸­ç¬”è€…åˆ†æäº† EventBus é»æ€§äº‹ä»¶çš„å‘é€æµç¨‹å¹¶å¯¹ EventBus è¿›è¡Œå¢å¼ºå®ç°äº†å¿…è¾¾äº‹ä»¶çš„æ”¯æŒï¼Œä¸Šä¸€ç¯‡æ–‡ç« æœ€åç¬”è€…æ²¡æœ‰å®ç°ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li>è·å–å¿…è¾¾äº‹ä»¶ï¼Œ</li>
<li>ç§»é™¤å¿…è¾¾äº‹ä»¶ï¼Œ</li>
<li>ç¼–å†™å¿…è¾¾äº‹ä»¶å•å…ƒæµ‹è¯•</li>
</ul>
<p>æœ¬ç¯‡æ–‡ç« è¡¥å…¨ä¸Šä¸€ç¯‡æ–‡ç« æœªå®ç°çš„éƒ¨åˆ†ï¼Œæœ€ååº”ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ˜å‹çš„éœ€æ±‚å¯¹ EventBus çš„çº¿ç¨‹åˆ‡æ¢åšä¸‹åˆ†æã€‚</p>
<h2 id="çºªå®"><a class="markdownIt-Anchor" href="#çºªå®"></a> çºªå®</h2>
<h3 id="getrendezvousevent"><a class="markdownIt-Anchor" href="#getrendezvousevent"></a> getRendezvousEvent</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€‰æ‹©Listå­˜å‚¨å¿…è¾¾äº‹ä»¶ï¼Œä½¿ç”¨Pairå°è£…å¿…è¾¾äº‹ä»¶çš„Keyå’ŒValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Class&lt;?&gt;, Object&gt;&gt; rendezvousEvents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getRendezvousEvent</span><span class="params">(Class&lt;T&gt; eventType)</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹`rendezvousEvents`åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (rendezvousEvents) &#123;</span><br><span class="line">        <span class="comment">// éå†å¿…è¾¾äº‹ä»¶é›†åˆ</span></span><br><span class="line">        <span class="keyword">for</span> (Pair&lt;Class&lt;?&gt;, Object&gt; next : rendezvousEvents) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å–å‡ºKey</span></span><br><span class="line">            Class&lt;?&gt; first = next.first;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä¸å…¥å‚è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (eventType.equals(first)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æŠŠValueè½¬æ¢ä¸ºå…¥å‚çš„ç±»å‹</span></span><br><span class="line">                <span class="keyword">return</span> eventType.cast(next.second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä»¿ç…§ EventBus ä¸­è·å–é»æ€§äº‹ä»¶çš„å®ç°æ¥å†™å‡ºè·å–å¿…è¾¾äº‹ä»¶çš„å®ç°ï¼Œåœ¨æºç å®ç°ä¸­é¦–å…ˆå¯¹å­˜å‚¨å¿…è¾¾äº‹ä»¶çš„é›†åˆ <code>rendezvousEvents</code> è¿›è¡ŒåŠ é”ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹å¿…è¾¾äº‹ä»¶é›†åˆï¼Œå…¶æ¬¡éå†å¿…è¾¾é›†åˆï¼Œå–å‡ºå¿…è¾¾äº‹ä»¶çš„ Keyï¼Œå³å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡ï¼Œä¸å…¥å‚çš„ Class å¯¹è±¡è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å–å‡ºå¿…è¾¾äº‹ä»¶çš„ Valueï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºå…¥å‚ç±»å‹ã€‚</p>
<h3 id="removerendezvousevent"><a class="markdownIt-Anchor" href="#removerendezvousevent"></a> removeRendezvousEvent</h3>
<p>æœ‰ä¸¤ä¸ªç§»é™¤å¿…è¾¾äº‹ä»¶çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ ¹æ®å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡è¿›è¡Œç§»é™¤ï¼Œå¦å¤–ä¸€ä¸ªæ ¹æ®å¿…è¾¾äº‹ä»¶çš„å®ä¾‹è¿›è¡Œç§»é™¤ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€ä¸€å®ç°ï¼š</p>
<h4 id="removerendezvouseventclasst-eventtype"><a class="markdownIt-Anchor" href="#removerendezvouseventclasst-eventtype"></a> removeRendezvousEvent(Class<T> eventType)</h4>
<p>æˆ‘ä»¬å…ˆå®ç°æ ¹æ®å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡è¿›è¡Œç§»é™¤çš„æ–¹æ³•ï¼Œå®ç°æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€‰æ‹©Listå­˜å‚¨å¿…è¾¾äº‹ä»¶ï¼Œä½¿ç”¨Pairå°è£…å¿…è¾¾äº‹ä»¶çš„Keyå’ŒValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Class&lt;?&gt;, Object&gt;&gt; rendezvousEvents;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å‚å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">removeRendezvousEvent</span><span class="params">(Class&lt;T&gt; eventType)</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹`rendezvousEvents`åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (rendezvousEvents) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> rendezvousEvents.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ™®é€šçš„ for å¾ªç¯ï¼Œé¿å…äº§ç”Ÿ ConcurrentModificationException</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            Pair&lt;Class&lt;?&gt;, Object&gt; pair = rendezvousEvents.get(i);</span><br><span class="line">            Class&lt;?&gt; first = pair.first;</span><br><span class="line">            <span class="comment">// æ¯”è¾ƒå¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡ä¸å…¥å‚æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">if</span> (eventType.equals(first)) &#123;</span><br><span class="line">                rendezvousEvents.remove(i);</span><br><span class="line">                <span class="keyword">return</span> eventType.cast(pair.second);</span><br><span class="line">            &#125;</span><br><span class="line">            i--;</span><br><span class="line">            size--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„æºç ä¸­é¦–å…ˆå¯¹ <code>rendezvousEvents</code> è¿›è¡ŒåŠ é”ï¼Œåœ¨ä¸´ç•ŒåŒºå†…ä½¿ç”¨æ™®é€šçš„ for å¾ªç¯ï¼Œè€Œä¸ä½¿ç”¨å¢å¼ºçš„ forEach å¾ªç¯éå† <code>rendezvousEvents</code> æ˜¯é¿å…å‘ç”ŸåŒæ­¥ä¿®æ”¹å¼‚å¸¸ <code>ConcurrentModificationException</code>ï¼Œè™½ç„¶ <code>rendezvousEvents</code> çš„å®ä¾‹æ˜¯ <code>CopyOnWriteArrayList</code>ã€‚</p>
<p>åœ¨å¾ªç¯ä½“å†…ï¼Œå–å‡ºå­˜å‚¨å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡ä¸å…¥å‚æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰å³ç§»é™¤æ­¤å¿…è¾¾äº‹ä»¶ï¼ŒåŒæ—¶è¿”å›å¿…è¾¾äº‹ä»¶çš„å®ä¾‹ã€‚</p>
<p>ä¸çŸ¥è¯»è€…æœ‰æ²¡æœ‰å‘ç°è¿™é‡Œç§»é™¤å¿…è¾¾äº‹ä»¶æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p>æˆ‘ä»¬çš„ <code>rendezvousEvents</code> æ˜¯ List é›†åˆç»“æ„ï¼Œä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åªç§»é™¤äº†ç¬¬ä¸€ä¸ªå¿…è¾¾äº‹ä»¶æ–¹æ³•å°±è¿”å›äº†ï¼Œå¦‚ä½•å®ç°æ ¹æ®å¿…è¾¾äº‹ä»¶çš„ Class å¯¹è±¡ç§»é™¤å¿…è¾¾äº‹ä»¶ç›¸ä¿¡è¯»è€…å¯ä»¥è‡ªè¡Œä¿®æ”¹å®ç°ï¼Œç¬”è€…è¿™é‡Œå°±ä¸å®ç°äº†ã€‚</p>
<h4 id="removerendezvouseventobject-event"><a class="markdownIt-Anchor" href="#removerendezvouseventobject-event"></a> removeRendezvousEvent(Object event)</h4>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°æ ¹æ®å¿…è¾¾äº‹ä»¶çš„å®ä¾‹è¿›è¡Œç§»é™¤ï¼Œå®ç°æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€‰æ‹©Listå­˜å‚¨å¿…è¾¾äº‹ä»¶ï¼Œä½¿ç”¨Pairå°è£…å¿…è¾¾äº‹ä»¶çš„Keyå’ŒValue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Class&lt;?&gt;, Object&gt;&gt; rendezvousEvents;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å‚å¿…è¾¾äº‹ä»¶çš„å®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeRendezvousEvent</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹`rendezvousEvents`åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (rendezvousEvents) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> rendezvousEvents.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ™®é€šçš„ for å¾ªç¯ï¼Œé¿å…äº§ç”Ÿ ConcurrentModificationException</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            Pair&lt;Class&lt;?&gt;, Object&gt; pair = rendezvousEvents.get(i);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">second</span> <span class="operator">=</span> pair.second;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ¯”è¾ƒå¿…è¾¾äº‹ä»¶çš„å®ä¾‹ä¸å…¥å‚æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">if</span> (event.equals(second)) &#123;</span><br><span class="line">                rendezvousEvents.remove(i);</span><br><span class="line">                result = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i--;</span><br><span class="line">            size--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ ¹æ® <code>removeRendezvousEvent(Class&lt;T&gt; eventType)</code> çš„å®ç°ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å®ç°æ ¹æ®å¿…è¾¾äº‹ä»¶çš„å®ä¾‹è¿›è¡Œç§»é™¤çš„é€»è¾‘ï¼Œä¸ <code>removeRendezvousEvent(Class&lt;T&gt; eventType)</code> çš„å®ç°ç±»ä¼¼ï¼Œé¦–å…ˆå¯¹ <code>rendezvousEvents</code> è¿›è¡ŒåŠ é”ï¼Œåœ¨ä¸´ç•ŒåŒºå†…ä½¿ç”¨æ™®é€šçš„ for å¾ªç¯ï¼Œåœ¨å¾ªç¯ä½“å†…ï¼Œå–å‡ºå­˜å‚¨å¿…è¾¾äº‹ä»¶çš„å®ä¾‹ä¸å…¥å‚æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰å³ç§»é™¤æ­¤å¿…è¾¾äº‹ä»¶ï¼ŒåŒæ—¶æŠŠç§»é™¤ç»“æœç½®ä¸º True ï¼Œæœ€åè¿”å›ç§»é™¤ç»“æœã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬ç»ˆäºå®Œæˆäº†å¯¹ EventBus å¢åŠ å¿…è¾¾äº‹ä»¶çš„æ‰€æœ‰é€»è¾‘ã€‚</p>
<h3 id="å•å…ƒæµ‹è¯•"><a class="markdownIt-Anchor" href="#å•å…ƒæµ‹è¯•"></a> å•å…ƒæµ‹è¯•</h3>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ç¼–å†™å•å…ƒæµ‹è¯•é€»è¾‘æ¥æµ‹è¯•æˆ‘ä»¬å¿…è¾¾äº‹ä»¶çš„é€»è¾‘æ­£ç¡®æ€§å§ã€‚</p>
<h4 id="eventbusstickyeventtest"><a class="markdownIt-Anchor" href="#eventbusstickyeventtest"></a> EventBusStickyEventTest</h4>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ EventBus ä¸­å¯¹é»æ€§äº‹ä»¶çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Œç”¨ä¾‹è¾ƒå¤šï¼Œç¬”è€…æŒ‘é€‰å‡ ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBusStickyEventTest</span> <span class="keyword">extends</span> <span class="title class_">AbstractEventBusTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•å‘é€é»æ€§äº‹ä»¶çš„é€»è¾‘</span></span><br><span class="line">    <span class="comment">// å…ˆå‘é€é»æ€§äº‹ä»¶ï¼Œå†æ³¨å†Œè®¢é˜…è€…ï¼Œç„¶åæ–­è¨€æœ€åä¸€ä¸ªäº‹ä»¶ä¸å‘é€çš„é»æ€§äº‹ä»¶ç›¸ç­‰ï¼Œæœ€åæ–­è¨€æœ€åä¸€ä¸ªè®¢é˜…æ–¹æ³•çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostSticky</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postSticky(<span class="string">&quot;Sticky&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Sticky&quot;</span>, lastEvent);</span><br><span class="line">        assertEquals(Thread.currentThread(), lastThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•æ²¡æœ‰é»æ€§äº‹ä»¶è®¢é˜…æ–¹æ³•æ—¶çš„é€»è¾‘</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostNonStickyRegisterSticky</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.post(<span class="string">&quot;NonSticky&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•æ³¨å†Œä¸åæ³¨å†Œè®¢é˜…è€…å¯¹é»æ€§äº‹ä»¶çš„å½±å“</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostStickyWithRegisterAndUnregister</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.postSticky(<span class="string">&quot;Sticky&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Sticky&quot;</span>, lastEvent);</span><br><span class="line"></span><br><span class="line">        eventBus.unregister(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Sticky&quot;</span>, lastEvent);</span><br><span class="line">        assertEquals(<span class="number">2</span>, eventCount.intValue());</span><br><span class="line"></span><br><span class="line">        eventBus.postSticky(<span class="string">&quot;NewSticky&quot;</span>);</span><br><span class="line">        assertEquals(<span class="number">3</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;NewSticky&quot;</span>, lastEvent);</span><br><span class="line"></span><br><span class="line">        eventBus.unregister(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="number">4</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;NewSticky&quot;</span>, lastEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•è·å–é»æ€§äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostStickyAndGet</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postSticky(<span class="string">&quot;Sticky&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Sticky&quot;</span>, eventBus.getStickyEvent(String.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•ç§»é™¤é»æ€§äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostStickyRemoveEvent</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postSticky(<span class="string">&quot;Sticky&quot;</span>);</span><br><span class="line">        assertTrue(eventBus.removeStickyEvent(<span class="string">&quot;Sticky&quot;</span>));</span><br><span class="line">        assertNull(eventBus.getStickyEvent(String.class));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="eventbusrendezvouseventtest"><a class="markdownIt-Anchor" href="#eventbusrendezvouseventtest"></a> EventBusRendezvousEventTest</h4>
<p>æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>EventBusStickyEventTest</code> ç¼–å†™å¿…è¾¾äº‹ä»¶çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥ä¸‹ä¸ºç¬”è€…å®ç°çš„æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBusRendezvousEventTest</span> <span class="keyword">extends</span> <span class="title class_">AbstractEventBusTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRendezvousSticky</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Rendezvous&quot;</span>, lastEvent);</span><br><span class="line">        assertEquals(Thread.currentThread(), lastThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousTwoEvents</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.postRendezvous(<span class="keyword">new</span> <span class="title class_">IntTestEvent</span>(<span class="number">7</span>));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="number">2</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousTwoSubscribers</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.postRendezvous(<span class="keyword">new</span> <span class="title class_">IntTestEvent</span>(<span class="number">7</span>));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">RendezvousIntTestSubscriber</span> <span class="variable">subscriber2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RendezvousIntTestSubscriber</span>();</span><br><span class="line">        eventBus.register(subscriber2);</span><br><span class="line">        assertEquals(<span class="number">3</span>, eventCount.intValue());</span><br><span class="line"></span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        assertEquals(<span class="number">4</span>, eventCount.intValue());</span><br><span class="line"></span><br><span class="line">        eventBus.postRendezvous(<span class="keyword">new</span> <span class="title class_">IntTestEvent</span>(<span class="number">8</span>));</span><br><span class="line">        assertEquals(<span class="number">6</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousRegisterNonRendezvous</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">NonRendezvousSubscriber</span>());</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostNonRendezvousRegisterRendezvous</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.post(<span class="string">&quot;NonRendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousTwice</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;NewRendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="number">2</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;NewRendezvous&quot;</span>, lastEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousThenPostNormal</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.post(<span class="string">&quot;NonRendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="number">1</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;Rendezvous&quot;</span>, lastEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousWithRegisterAndUnregister</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Rendezvous&quot;</span>, lastEvent);</span><br><span class="line"></span><br><span class="line">        eventBus.unregister(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Rendezvous&quot;</span>, lastEvent);</span><br><span class="line">        assertEquals(<span class="number">2</span>, eventCount.intValue());</span><br><span class="line"></span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;NewRendezvous&quot;</span>);</span><br><span class="line">        assertEquals(<span class="number">3</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;NewRendezvous&quot;</span>, lastEvent);</span><br><span class="line"></span><br><span class="line">        eventBus.unregister(<span class="built_in">this</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertEquals(<span class="number">5</span>, eventCount.intValue());</span><br><span class="line">        assertEquals(<span class="string">&quot;NewRendezvous&quot;</span>, lastEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousAndGet</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Rendezvous&quot;</span>, eventBus.getRendezvousEvent(String.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousRemoveClass</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.removeRendezvousEvent(String.class);</span><br><span class="line">        assertNull(eventBus.getRendezvousEvent(String.class));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousRemoveEvent</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        assertTrue(eventBus.removeRendezvousEvent(<span class="string">&quot;Rendezvous&quot;</span>));</span><br><span class="line">        assertNull(eventBus.getRendezvousEvent(String.class));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPostRendezvousRemoveAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.postRendezvous(<span class="keyword">new</span> <span class="title class_">IntTestEvent</span>(<span class="number">77</span>));</span><br><span class="line">        eventBus.removeAllRendezvousEvents();</span><br><span class="line">        assertNull(eventBus.getRendezvousEvent(String.class));</span><br><span class="line">        assertNull(eventBus.getRendezvousEvent(IntTestEvent.class));</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRemoveRendezvousEventInSubscriber</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> <span class="title class_">RendezvousStickySubscriber</span>());</span><br><span class="line">        eventBus.postRendezvous(<span class="string">&quot;Rendezvous&quot;</span>);</span><br><span class="line">        eventBus.register(<span class="built_in">this</span>);</span><br><span class="line">        assertNull(lastEvent);</span><br><span class="line">        assertEquals(<span class="number">0</span>, eventCount.intValue());</span><br><span class="line">        assertNull(eventBus.getRendezvousEvent(String.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe(rendezvous = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(String event)</span> &#123;</span><br><span class="line">        trackEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe(rendezvous = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(IntTestEvent event)</span> &#123;</span><br><span class="line">        trackEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RendezvousStickySubscriber</span> &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">        <span class="meta">@Subscribe(rendezvous = true)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(String event)</span> &#123;</span><br><span class="line">            eventBus.removeRendezvousEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NonRendezvousSubscriber</span> &#123;</span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(String event)</span> &#123;</span><br><span class="line">            trackEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(IntTestEvent event)</span> &#123;</span><br><span class="line">            trackEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RendezvousIntTestSubscriber</span> &#123;</span><br><span class="line">        <span class="meta">@Subscribe(rendezvous = true)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(IntTestEvent event)</span> &#123;</span><br><span class="line">            trackEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹æºç ä¸­ï¼Œç¬”è€…ç¼–å†™äº† 13 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæ¶‰åŠå‘é€ä¸€ä¸ªå¿…è¾¾äº‹ä»¶ï¼Œå‘é€ä¸¤ä¸ªå¿…è¾¾äº‹ä»¶ï¼Œå‘é€å¿…è¾¾äº‹ä»¶ä¸æ™®é€šäº‹ä»¶ï¼Œæ³¨å†Œè®¢é˜…è€…ä¸åæ³¨å†Œå¯¹å¿…è¾¾äº‹ä»¶çš„å½±å“ï¼Œè·å–å’Œç§»é™¤å¿…è¾¾äº‹ä»¶ç­‰ã€‚</p>
<h3 id="çº¿ç¨‹è°ƒåº¦"><a class="markdownIt-Anchor" href="#çº¿ç¨‹è°ƒåº¦"></a> çº¿ç¨‹è°ƒåº¦</h3>
<h4 id="çº¿ç¨‹æ¨¡å‹"><a class="markdownIt-Anchor" href="#çº¿ç¨‹æ¨¡å‹"></a> çº¿ç¨‹æ¨¡å‹</h4>
<p>ç›®å‰ EventBus å¯¹è®¢é˜…æ–¹æ³•æ”¯æŒ 5 ç§çº¿ç¨‹æ¨¡å‹çš„è°ƒåº¦ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li><code>ThreadMode.POSTING</code> // <strong>å¯¹äºæ™®é€šäº‹ä»¶æ¥è¯´åœ¨äº‹ä»¶å‘å¸ƒçº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶</strong></li>
<li><code>ThreadMode.MAIN</code> // åœ¨ä¸»çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œæ ¹æ®æ˜¯å¦åœ¨ Android ä¸Šä½¿ç”¨ï¼Œå¤„ç†é€»è¾‘ä¸åŒ</li>
<li><code>ThreadMode.MAIN_ORDERED</code> // åœ¨ä¸»çº¿ç¨‹æŒ‰é¡ºåºæ¥åˆ†å‘äº‹ä»¶</li>
<li><code>ThreadMode.BACKGROUND</code> // åœ¨åå°çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œæ ¹æ®æ˜¯å¦åœ¨ Android ä¸Šä½¿ç”¨ï¼Œå¤„ç†é€»è¾‘ä¸åŒã€‚ä½¿ç”¨å•çº¿ç¨‹å¤„ç†ï¼Œå°½é‡ä¸è¦è¿›è¡Œè€—æ—¶æ“ä½œä»¥å…é˜»å¡åå°çº¿ç¨‹</li>
<li><code>ThreadMode.ASYNC</code> // åœ¨å¼‚æ­¥çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¤„ç†</li>
</ol>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æé»æ€§äº‹ä»¶å‘é€çš„æµç¨‹æ—¶ï¼Œäº‹ä»¶çš„å‘é€éƒ½ä¼šè°ƒç”¨ <code>postToSubscription</code> æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ <code>invokeSubscriber</code> æ–¹æ³•æ¥åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•ï¼Œä¸‹é¢å†è´´å‡º <code>postToSubscription</code> çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="type">boolean</span> isMainThread)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†POSTING</span></span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            <span class="comment">// ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// å¤„ç†MAIN</span></span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="comment">// æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œåœ¨é Android å¹³å°ä¸Šæ—¶ï¼ŒisMainThread ä¹Ÿæ˜¯ true</span></span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶ mainThreadPoster != nullï¼Œå¯ä»¥è®¤ä¸ºæ˜¯åœ¨ Android å¹³å°ä¸Š</span></span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†MAIN_ORDERED</span></span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="comment">// ä¸ç®¡æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œæ€»æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥å…¥é˜Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="literal">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></span><br><span class="line">                <span class="comment">// å¦åˆ™ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†BACKGROUND</span></span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ä¸»çº¿ç¨‹åˆ™å…¥é˜Ÿï¼ŒbackgroundPosterä½¿ç”¨å•ä¸ªåå°çº¿ç¨‹ä¾æ¬¡åˆ†å‘äº‹ä»¶ï¼Œè®¢é˜…æ–¹æ³•åº”å°½å¿«è¿”å›ä»¥å…é˜»å¡åå°çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// åœ¨é Android å¹³å°ä¸Šæ—¶ï¼ŒisMainThread ä¹Ÿæ˜¯ trueï¼Œå³åœ¨é Android å¹³å°ä¸Šæ—¶ï¼Œå§‹ç»ˆåœ¨åå°çº¿ç¨‹åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†ASYNC</span></span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            <span class="comment">// å§‹ç»ˆå¼‚æ­¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unknown thread mode: &quot;</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="posting"><a class="markdownIt-Anchor" href="#posting"></a> POSTING</h4>
<p>è¿™æ˜¯ <code>@Subscribe</code> æ³¨è§£ä¸­çº¿ç¨‹æ¨¡å‹çš„é»˜è®¤é…ç½®ï¼Œå¯¹äºè¯¥çº¿ç¨‹è°ƒåº¦æ¨¡å‹ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li><strong>å¯¹äºæ™®é€šäº‹ä»¶æ¥è¯´ï¼Œäº‹ä»¶å‘å¸ƒä¸è®¢é˜…æ–¹æ³•å°†åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ˜¯è¯¥çº¿ç¨‹è°ƒåº¦æ¨¡å‹çš„æœ¬æ„</strong></li>
<li><strong>ä½†æ˜¯å¯¹äºé»æ€§äº‹ä»¶å’Œå¿…è¾¾äº‹ä»¶æ¥è¯´ï¼Œäº‹ä»¶å‘å¸ƒä¸è®¢é˜…æ–¹æ³•å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹</strong></li>
</ol>
<p>æ¯”å¦‚ä»¥ä¸‹ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MainActivity.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    </span><br><span class="line">    thread &#123;</span><br><span class="line">        <span class="comment">// åœ¨å­çº¿ç¨‹ä¸­å‘å¸ƒé»æ€§äº‹ä»¶</span></span><br><span class="line">        EventBus.getDefault().postSticky(<span class="string">&quot;Event-1&quot;</span>)</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;onCreate: postSticky-1, ThreadName = <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        runOnUiThread &#123;</span><br><span class="line">            <span class="comment">// åœ¨ä¸»çº¿ç¨‹ä¸­æ³¨å†Œè®¢é˜…è€…</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;onCreate: register, ThreadName = <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">            EventBus.getDefault().register(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å†åœ¨ä¸»çº¿ç¨‹å‘å¸ƒä¸€ä¸ªé»æ€§äº‹ä»¶</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;onCreate: postSticky-2, ThreadName = <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">            EventBus.getDefault().postSticky(<span class="string">&quot;Event-2&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¢é˜…æ–¹æ³• ä½¿ç”¨ POSTING çº¿ç¨‹æ¨¡å‹</span></span><br><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.POSTING, sticky = true)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">eventBusTest</span><span class="params">(event: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;eventBusTest: event = <span class="variable">$event</span>, ThreadName = <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logcat</span></span><br><span class="line">&gt;&gt; onCreate: postSticky-<span class="number">1</span>, ThreadName = Thread-<span class="number">290</span>   â‘ </span><br><span class="line">&gt;&gt; onCreate: register, ThreadName = main             â‘¡</span><br><span class="line">&gt;&gt; eventBusTest: event = Event-<span class="number">1</span>, ThreadName = main  â‘¢</span><br><span class="line">&gt;&gt; onCreate: postSticky-<span class="number">2</span>, ThreadName = main         â‘£</span><br><span class="line">&gt;&gt; eventBusTest: event = Event-<span class="number">2</span>, ThreadName = main  â‘¤</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šè¿°ä»£ç ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹çš„è®¢é˜…æ–¹æ³•ï¼Œæˆ‘ä»¬åˆ†æä¸‹ç¤ºä¾‹ä»£ç ï¼š</p>
<ol>
<li>æˆ‘ä»¬å…ˆåœ¨å­çº¿ç¨‹ä¸­å‘å¸ƒä¸€ä¸ªé»æ€§äº‹ä»¶ <code>Event-1</code>ï¼Œ</li>
<li>ç„¶ååˆ‡æ¢åˆ°ä¸»çº¿ç¨‹å»æ³¨å†Œè®¢é˜…è€…ï¼Œ</li>
<li>æœ€ååœ¨ä¸»çº¿ç¨‹å†å‘å¸ƒä¸€ä¸ªé»æ€§äº‹ä»¶ <code>Event-2</code>ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹ Logcat çš„è¾“å‡ºï¼Œä¸€å…± 5 æ¡æ—¥å¿—è¾“å‡ºï¼Œæˆ‘ä»¬ä¸€ä¸€åˆ†æï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¡æ—¥å¿—æ˜¯åœ¨å­çº¿ç¨‹å‘å¸ƒç¬¬ä¸€ä¸ªé»æ€§äº‹ä»¶æ—¶è¾“å‡ºçš„ï¼Œæ ‡è¯†äº‹ä»¶å‘å¸ƒæ˜¯åœ¨å­çº¿ç¨‹ï¼š<strong>Thread-290</strong></li>
<li>ç¬¬äºŒæ¡æ—¥å¿—æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ³¨å†Œè®¢é˜…è€…æ—¶è¾“å‡ºçš„ï¼Œæ ‡è¯†æ³¨å†Œè®¢é˜…è€…æ˜¯åœ¨ä¸»çº¿ç¨‹</li>
<li>ç¬¬ä¸‰æ¡æ—¥å¿—æ˜¯è®¢é˜…æ–¹æ³•æ”¶åˆ°ç¬¬ä¸€ä¸ªé»æ€§äº‹ä»¶æ—¶è¾“å‡ºçš„ï¼Œæ ‡è¯†è®¢é˜…æ–¹æ³•æ­¤æ—¶æ˜¯åœ¨ä¸»çº¿ç¨‹</li>
<li>ç¬¬å››æ¡æ—¥å¿—æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­å‘å¸ƒç¬¬äºŒä¸ªé»æ€§äº‹ä»¶æ—¶è¾“å‡ºçš„ï¼Œæ ‡è¯†äº‹ä»¶å‘å¸ƒæ˜¯åœ¨ä¸»çº¿ç¨‹</li>
<li>ç¬¬äº”æ¡æ—¥å¿—æ˜¯è®¢é˜…æ–¹æ³•æ”¶åˆ°ç¬¬äºŒä¸ªé»æ€§äº‹ä»¶æ—¶è¾“å‡ºçš„ï¼Œæ ‡è¯†è®¢é˜…æ–¹æ³•æ­¤æ—¶æ˜¯åœ¨ä¸»çº¿ç¨‹</li>
</ol>
<p>æˆ‘ä»¬æ ¹æ® Logcat çš„æ—¥å¿—è¾“å‡ºå‘ç°è®¢é˜…æ–¹æ³•æ”¶åˆ° <code>Event-1</code> é»æ€§äº‹ä»¶æ˜¯åœ¨ <code>main</code> çº¿ç¨‹ï¼Œè¿™ä¸ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹çš„æè¿°ä¸ç¬¦ï¼Œå†å¾€ä¸‹çœ‹æ”¶åˆ° <code>Event-2</code> é»æ€§äº‹ä»¶æ˜¯åœ¨ <code>main</code> çº¿ç¨‹ï¼Œä¸ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹çš„æè¿°ç¬¦åˆã€‚</p>
<p>ä»¥ä¸Šå‘ç°ä¸ä¸Šä¸€ç¯‡ <a href="https://juejin.cn/post/7104107150678917133">Android-EventBusä¿®æ”¹çºªå®</a> ä¸­é»æ€§äº‹ä»¶çš„å‘é€æµç¨‹åˆ†æå»åˆï¼š</p>
<ol>
<li>é»æ€§äº‹ä»¶å‘å¸ƒæ—¶å¦‚æœæ²¡æœ‰è®¢é˜…è€…ï¼Œé‚£ä¹ˆé»æ€§äº‹ä»¶çš„å‘é€å°†åœ¨è®¢é˜…è€… <code>register</code> æ—¶å‘é€</li>
<li>é»æ€§äº‹ä»¶å‘å¸ƒæ—¶æœ‰è®¢é˜…è€…ï¼Œé‚£ä¹ˆå·²æœ‰çš„è®¢é˜…è€…ä¼šæ”¶åˆ°é»æ€§äº‹ä»¶ï¼Œå‘å¸ƒåæ³¨å†Œçš„è®¢é˜…è€…ä¼šåœ¨ <code>register</code> æ—¶æ”¶åˆ°</li>
</ol>
<p>æœ€åå¾—å‡ºç»“è®ºï¼š</p>
<ol>
<li><strong>è°¨æ…æŠŠ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹ç”¨äºé»æ€§äº‹ä»¶å’Œå¿…è¾¾äº‹ä»¶ï¼Œæ­¤æ—¶ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹å°†å¤±æ•ˆï¼Œè®¢é˜…æ–¹æ³•å°†åœ¨è®¢é˜…è€…æ³¨å†Œçš„çº¿ç¨‹ä¸­è°ƒç”¨</strong></li>
<li><strong>å¯¹äºæ™®é€šäº‹ä»¶ï¼Œä½¿ç”¨ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹æ—¶ï¼Œæœ€å¥½ä¸ç”¨è¿›è¡Œè€—æ—¶æ“ä½œï¼Œä»¥å…é˜»å¡äº‹ä»¶å‘å¸ƒçº¿ç¨‹</strong></li>
</ol>
<h4 id="mainå’Œmain_ordered"><a class="markdownIt-Anchor" href="#mainå’Œmain_ordered"></a> MAINå’ŒMAIN_ORDERED</h4>
<p><code>MAIN</code> å’Œ <code>MAIN_ORDERED</code> çº¿ç¨‹æ¨¡å‹éƒ½ä¼šåœ¨ä¸»çº¿ç¨‹åˆ†å‘äº‹ä»¶ï¼Œåè€…æœ‰ä¸ªæ’åºä½œç”¨ï¼š</p>
<ol>
<li><code>MAIN</code> çº¿ç¨‹æ¨¡å‹é¦–å…ˆå°è¯•ç›´æ¥åœ¨ä¸»çº¿ç¨‹åˆ†å‘äº‹ä»¶(è¿™å¯èƒ½ä¼šé˜»å¡äº‹ä»¶å‘å¸ƒçº¿ç¨‹)ï¼Œå¦‚æœä¸è¡Œå†åˆ‡æ¢è‡³ä¸»çº¿ç¨‹åˆ†å‘ï¼Œ</li>
<li><code>MAIN_ORDERED</code> çº¿ç¨‹æ¨¡å‹ä¸ç®¡å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œå§‹ç»ˆä¼šåˆ‡æ¢è‡³ä¸»çº¿ç¨‹ä¾æ¬¡åˆ†å‘ï¼Œè¿™ä¿è¯ä¸ä¼šé˜»å¡äº‹ä»¶å‘å¸ƒçº¿ç¨‹ã€‚</li>
</ol>
<p><strong>ä¸ç®¡ä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹éƒ½ä¸åº”åœ¨è®¢é˜…æ–¹æ³•ä¸­è¿›è¡Œè€—æ—¶æ“ä½œã€‚</strong></p>
<h4 id="background"><a class="markdownIt-Anchor" href="#background"></a> BACKGROUND</h4>
<p><code>BACKGROUND</code> çº¿ç¨‹æ¨¡å¼ä¹Ÿéœ€è¦æ³¨æ„æ™®é€šäº‹ä»¶ä¸é»æ€§äº‹ä»¶å’Œå¿…è¾¾äº‹ä»¶ä¸åŒçš„åˆ†å‘é€»è¾‘ï¼š</p>
<ol>
<li>å¦‚æœæ˜¯æ™®é€šäº‹ä»¶ï¼Œäº‹ä»¶å°†å§‹ç»ˆåœ¨ EventBus çš„å•ä¸ªåå°çº¿ç¨‹ä¸­ä¾æ¬¡åˆ†å‘ï¼Œ</li>
<li>å¦‚æœæ˜¯é»æ€§äº‹ä»¶æˆ–å¿…è¾¾äº‹ä»¶ï¼Œäº‹ä»¶å¯èƒ½ä¸åœ¨ EventBus çš„å•ä¸ªåå°çº¿ç¨‹ä¸­ä¾æ¬¡åˆ†å‘ï¼ŒåŸå› è§ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹ã€‚</li>
</ol>
<h4 id="async"><a class="markdownIt-Anchor" href="#async"></a> ASYNC</h4>
<p><code>ASYNC</code> çº¿ç¨‹æ¨¡å‹éƒ½å°†å¼‚æ­¥çš„åˆ†å‘äº‹ä»¶ï¼Œåœ¨æ­¤çº¿ç¨‹æ¨¡å‹ä¸‹å¯ä»¥æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œä½†ä¹Ÿåº”è¯¥é¿å…è§¦å‘å¤§é‡è€—æ—¶æ“ä½œï¼Œä»¥é™åˆ¶å¹¶å‘çº¿ç¨‹æ•°ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬ç¯‡æ–‡ç« æä¾›äº†ä¸€ç‰ˆåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å¿…è¾¾äº‹ä»¶æœªå®ç°æ–¹æ³•çš„å®ç°ï¼Œå¹¶å¯¹å¿…è¾¾äº‹ä»¶ç¼–å†™äº†å•å…ƒæµ‹è¯•ï¼Œæœ€åé€šè¿‡åˆ†æ EventBus æä¾›çš„ 5 ç§çº¿ç¨‹æ¨¡å‹ï¼Œæ˜ç™½äº† EventBus æ˜¯å¦‚ä½•å®ç°çº¿ç¨‹åˆ‡æ¢çš„ã€‚</p>
<p>EventBus å¯¹å¤–æä¾›äº† 5 ç§çº¿ç¨‹æ¨¡å‹ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…åšäº‹ä»¶çš„çº¿ç¨‹è°ƒåº¦ï¼Œä½†æ— è®ºä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨è®¢é˜…æ–¹æ³•ä¸­éƒ½åº”è¯¥å°½é‡é¿å…è¿›è¡Œè€—æ—¶æ“ä½œã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬æœ€åæ²¡æœ‰åˆ†æçº¿ç¨‹åˆ‡æ¢çš„å…·ä½“æºç ï¼Œä¸‹ç¯‡ä¸€å®š~~</p>
<p>happy~~ï¼Œå¸Œæœ›å¯ä»¥å¸®ä½ æ›´å¥½çš„ä½¿ç”¨ EventBus</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>eventbus</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-EventBusä¿®æ”¹çºªå®(ä¸‰)-çº¿ç¨‹è°ƒåº¦</title>
    <url>/2022/06/03/Android/Android-EventBus%E4%BF%AE%E6%94%B9%E7%BA%AA%E5%AE%9E(%E4%B8%89)-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6/</url>
    <content><![CDATA[<h1 id="android-eventbusä¿®æ”¹çºªå®ä¸‰"><a class="markdownIt-Anchor" href="#android-eventbusä¿®æ”¹çºªå®ä¸‰"></a> Android-EventBusä¿®æ”¹çºªå®(ä¸‰)</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 5 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>åœ¨ä¸Šä¸€ç¯‡ <a href="https://juejin.cn/post/7104536485428199437">Android-EventBusä¿®æ”¹çºªå®(äºŒ)</a> ä¸­ç¬”è€…ç®€å•åˆ†æäº† EventBus æä¾›çš„ 5 ç§çº¿ç¨‹æ¨¡å‹çš„ä½œç”¨åŠå„æ¨¡å‹çš„ä½¿ç”¨åœºæ™¯ä¸æ³¨æ„äº‹é¡¹ï¼Œç‰¹åˆ«æ˜¯åœ¨ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹ä¸‹ï¼Œè¦è°¨æ…çš„ä½¿ç”¨é»æ€§äº‹ä»¶å’Œå¿…è¾¾äº‹ä»¶ã€‚</p>
<p>ä¸Šä¸€ç¯‡ä¸­æœªå¯¹çº¿ç¨‹æ¨¡å‹çš„å…·ä½“å®ç°åšåˆ†æï¼Œæœ¬ç¯‡æ–‡ç« åˆ†æä¸‹çº¿ç¨‹æ¨¡å‹æ˜¯å¦‚ä½•åšçº¿ç¨‹è°ƒåº¦çš„ã€‚</p>
<p><strong>æœ¬ç¯‡æ–‡ç« åªè®¨è®ºå‘å¸ƒæ™®é€šäº‹ä»¶çš„çº¿ç¨‹è°ƒåº¦ï¼Œç²˜æ€§äº‹ä»¶å’Œå¿…è¾¾äº‹ä»¶çš„çº¿ç¨‹è°ƒåº¦ä¸æ™®é€šäº‹ä»¶ç•¥æœ‰ä¸åŒã€‚</strong></p>
<h2 id="çº¿ç¨‹æ¨¡å‹"><a class="markdownIt-Anchor" href="#çº¿ç¨‹æ¨¡å‹"></a> çº¿ç¨‹æ¨¡å‹</h2>
<p>å…ˆç®€å•å›é¡¾ä¸‹ä¸Šç¯‡æ–‡ç« ä¸­å…³äºçº¿ç¨‹æ¨¡å‹çš„åˆ†æï¼š</p>
<ul>
<li>POSTINGï¼šå¯¹äºæ™®é€šäº‹ä»¶æ¥è¯´ï¼Œäº‹ä»¶å‘å¸ƒä¸è®¢é˜…æ–¹æ³•å°†åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ˜¯è¯¥çº¿ç¨‹è°ƒåº¦æ¨¡å‹çš„æœ¬æ„</li>
<li>MAINï¼šåœ¨ä¸»çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œæ ¹æ®æ˜¯å¦åœ¨ Android ä¸Šä½¿ç”¨ï¼Œå¤„ç†é€»è¾‘ä¸åŒ</li>
<li>MAIN_ORDERï¼šåœ¨ä¸»çº¿ç¨‹ä¾æ¬¡åˆ†å‘äº‹ä»¶</li>
<li>BACKGROUNDï¼šåœ¨åå°çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œæ ¹æ®æ˜¯å¦åœ¨ Android ä¸Šä½¿ç”¨ï¼Œå¤„ç†é€»è¾‘ä¸åŒã€‚ä½¿ç”¨å•çº¿ç¨‹å¤„ç†ï¼Œå°½é‡ä¸è¦è¿›è¡Œè€—æ—¶æ“ä½œä»¥å…é˜»å¡åå°çº¿ç¨‹</li>
<li>ASYNCï¼šåœ¨å¼‚æ­¥çº¿ç¨‹æ¥åˆ†å‘äº‹ä»¶ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¤„ç†</li>
</ul>
<h2 id="äº‹ä»¶åˆ†å‘å™¨"><a class="markdownIt-Anchor" href="#äº‹ä»¶åˆ†å‘å™¨"></a> äº‹ä»¶åˆ†å‘å™¨</h2>
<p>EventBus ä½¿ç”¨ <strong>äº‹ä»¶åˆ†å‘å™¨</strong> å¯¹äº‹ä»¶è¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼Œé™¤ <code>POSTING</code> çº¿ç¨‹æ¨¡å‹å¤–ï¼Œå…¶ä»– 4 ç§çº¿ç¨‹æ¨¡å‹éƒ½æœ‰ <strong>äº‹ä»¶åˆ†å‘å™¨</strong> çš„èº«å½±ï¼Œ<strong>äº‹ä»¶åˆ†å‘å™¨</strong> ä¸»è¦åœ¨<code>postToSubscription</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="type">boolean</span> isMainThread)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†POSTING</span></span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            <span class="comment">// ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// å¤„ç†MAIN</span></span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="comment">// æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œåœ¨é Android å¹³å°ä¸Šæ—¶ï¼ŒisMainThread ä¹Ÿæ˜¯ true</span></span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶ mainThreadPoster != nullï¼Œå¯ä»¥è®¤ä¸ºæ˜¯åœ¨ Android å¹³å°ä¸Š</span></span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†MAIN_ORDERED</span></span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="comment">// ä¸ç®¡æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œæ€»æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥å…¥é˜Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="literal">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></span><br><span class="line">                <span class="comment">// å¦åˆ™ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†BACKGROUND</span></span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ä¸»çº¿ç¨‹åˆ™å…¥é˜Ÿï¼ŒbackgroundPosterä½¿ç”¨å•ä¸ªåå°çº¿ç¨‹ä¾æ¬¡åˆ†å‘äº‹ä»¶ï¼Œè®¢é˜…æ–¹æ³•åº”å°½å¿«è¿”å›ä»¥å…é˜»å¡åå°çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// åœ¨é Android å¹³å°ä¸Šæ—¶ï¼ŒisMainThread ä¹Ÿæ˜¯ trueï¼Œå³åœ¨é Android å¹³å°ä¸Šæ—¶ï¼Œå§‹ç»ˆåœ¨åå°çº¿ç¨‹åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™ç›´æ¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¤„ç†ASYNC</span></span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            <span class="comment">// å§‹ç»ˆå¼‚æ­¥åˆ†å‘äº‹ä»¶</span></span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unknown thread mode: &quot;</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>postToSubscription</code> æ–¹æ³•ä¸­å¯ä»¥çœ‹å‡ºå„çº¿ç¨‹æ¨¡å‹å¯¹åº”åˆ†åˆ«å¯¹åº”å“ªç§ <strong>äº‹ä»¶åˆ†å‘å™¨</strong>ï¼š</p>
<ul>
<li>MAINï¼ŒMAIN_ORDEREDï¼šmainThreadPosterï¼Œ<code>mainThreadPoster</code> åœ¨Android å¹³å°ä¸Šçš„ç±»å‹æ˜¯ <code>HandlerPoster</code></li>
<li>BACKGROUNDï¼šbackgroundPosterï¼Œ<code>backgroundPoster</code> çš„ç±»å‹æ˜¯ <code>BackgroundPoster</code></li>
<li>ASYNCï¼šasyncPosterï¼Œ<code>asyncPoster</code> çš„ç±»å‹æ˜¯ <code>AsyncPoster</code></li>
</ul>
<p>ä»¥ä¸Šäº‹ä»¶å‘å¸ƒå™¨éƒ½å®ç°äº† <code>Poster</code> æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Poster</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¾…å‘å¸ƒäº‹ä»¶å…¥é˜Ÿ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscription è®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event        å¾…å‘å¸ƒäº‹ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Subscription subscription, Object event)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Poster</code> æ¥å£æ˜¯å¯¹äº‹ä»¶åˆ†å‘å™¨è¡Œä¸ºçš„æŠ½è±¡ã€‚</p>
<p>ä» <code>Poster</code> æ¥å£ä¸­å”¯ä¸€çš„æ¥å£æ–¹æ³•åç§° <code>enqueue</code> æ¥çœ‹ï¼Œå¯ä»¥å¤§æ¦‚çŒœæµ‹åˆ°äº‹ä»¶åˆ†å‘å™¨çš„å®ç°æ€æƒ³ä¸ºï¼š<strong>äº‹ä»¶å¾ªç¯æœºåˆ¶</strong>ã€‚</p>
<p>æ—¢ç„¶æ˜¯ <strong>äº‹ä»¶å¾ªç¯</strong>ï¼Œæ¥å£æ–¹æ³•åç§°åˆæ˜¯ <code>enqueue</code>ï¼ŒçŒœæµ‹æœ‰é˜Ÿåˆ—ç›¸å…³çš„å®ç°ã€‚</p>
<h2 id="å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—"></a> å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—</h2>
<p>æ¯ä¸ªäº‹ä»¶åˆ†å‘å™¨éƒ½æœ‰ä¸€ä¸ªå¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—ï¼Œå°†å¾…å‘å¸ƒçš„äº‹ä»¶å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—æ˜¯é€šè¿‡ä¸€ç§å…ˆè¿›å…ˆå‡º(FIFO)çš„å•å‘é“¾è¡¨å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PendingPostQueue</span> &#123;</span><br><span class="line">    <span class="comment">// é“¾è¡¨å¤´éƒ¨å…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> PendingPost head; <span class="comment">// çœŸé“¾è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é“¾è¡¨å°¾éƒ¨å…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> PendingPost tail; <span class="comment">// å‡é“¾è¡¨ï¼ŒçœŸé“¾è¡¨å°¾éƒ¨å…ƒç´ çš„å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’å…¥é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(PendingPost pendingPost)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;null cannot be enqueued&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°¾éƒ¨å…ƒç´ ä¸ä¸ºç©ºï¼Œè®¤ä¸ºé“¾è¡¨ä¸­æœ‰æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (tail != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ–°çš„å…ƒç´ æ’å…¥é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">            tail.next = pendingPost;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ›´æ–°å°¾éƒ¨å…ƒç´ å¼•ç”¨</span></span><br><span class="line">            tail = pendingPost;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            head = tail = pendingPost;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Head present, but no tail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œç”¨äº`poll(int)`ä¸­`wait()`</span></span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é“¾è¡¨å¤´éƒ¨å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="keyword">synchronized</span> PendingPost <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (head != <span class="literal">null</span>) &#123;</span><br><span class="line">            head = head.next;</span><br><span class="line">            <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">                tail = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pendingPost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é“¾è¡¨å¤´éƒ¨å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="keyword">synchronized</span> PendingPost <span class="title function_">poll</span><span class="params">(<span class="type">int</span> maxMillisToWait)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            wait(maxMillisToWait);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> poll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼Œå…¶ä¸­ <code>head</code> æ˜¯çœŸé“¾è¡¨ï¼Œæ ‡è¯†é“¾è¡¨çš„å¤´éƒ¨å…ƒç´ ï¼Œ<code>tail</code> æ˜¯å‡é“¾è¡¨ï¼Œå®ƒæ˜¯çœŸé“¾è¡¨å°¾éƒ¨å…ƒç´ çš„å¼•ç”¨ï¼Œæ ‡è¯†é“¾è¡¨çš„å°¾éƒ¨å…ƒç´ ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ–¹ä¾¿åœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œå…ƒç´ æ•°æ®ä¸­æœ‰ <code>next</code> å­—æ®µæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œä¸‹å›¾å±•ç¤ºäº†å…ƒç´ å…¥é˜Ÿæ—¶çœŸå‡é“¾è¡¨çš„å˜åŒ–æƒ…å†µï¼š</p>
<p><strong>ç®­å¤´å‘å³è¡¨ç¤ºå…ƒç´ å…¥é˜Ÿ</strong></p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202206031222025.png" alt="image-20220603122155865" /></p>
<ol>
<li>åˆå§‹æ—¶ï¼Œ<code>head</code> å’Œ <code>tail</code> å‡ä¸º <code>null</code>ï¼Œ</li>
<li>å½“ç¬¬ä¸€ä¸ªå…ƒç´ å…¥é˜Ÿæ—¶ï¼Œ<code>head</code> å’Œ <code>tail</code> å‡ä¸º <code>event1</code>ï¼Œ</li>
<li>å½“ç¬¬äºŒä¸ªå…ƒç´ å…¥é˜Ÿæ—¶ï¼Œ<code>event2</code> æ’å…¥ <code>head</code> çš„å°¾éƒ¨ï¼Œ<code>tail</code> çš„å¼•ç”¨æ›´æ–°ä¸º <code>event2</code></li>
<li>å½“ç¬¬ä¸‰ä¸ªå…ƒç´ å…¥é˜Ÿæ—¶ï¼Œ<code>event3</code> æ’å…¥ <code>head</code> çš„å°¾éƒ¨ï¼Œ<code>tail</code> çš„å¼•ç”¨æ›´æ–°ä¸º <code>event3</code></li>
</ol>
<p>å½“æ’å…¥æ›´å¤šå…ƒç´ æ—¶ä¾æ¬¡ç±»æ¨ï¼Œ<code>head</code> ä¸ºé“¾è¡¨çš„å¤´éƒ¨å…ƒç´ ï¼Œ<code>tail</code> ä¸ºé“¾è¡¨çš„å°¾éƒ¨å…ƒç´ ã€‚</p>
<p>å…ƒç´ å‡ºé˜Ÿçš„æƒ…å†µï¼Œæ­£å¥½ä¸å…ƒç´ å…¥é˜Ÿç›¸åï¼Œä¸‹å›¾å±•ç¤ºäº†å…ƒç´ å‡ºé˜Ÿæ—¶çœŸå‡é“¾è¡¨çš„å˜åŒ–æƒ…å†µï¼š</p>
<p><strong>ç®­å¤´å‘å·¦è¡¨ç¤ºå…ƒç´ å‡ºé˜Ÿ</strong></p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202206031249615.png" alt="image-20220603124949865" /></p>
<ol>
<li>å½“é“¾è¡¨ä¸­æœ‰ä¸‰ä¸ªå…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿä¸€ä¸ªå…ƒç´ ï¼Œå³å–å‡º <code>head</code> å¤´éƒ¨å…ƒç´  <code>event1</code>ï¼Œç„¶åæŠŠ <code>head</code> çš„ <code>next</code> å…ƒç´  <code>event2</code> æŒ‡å‘ä¸º <code>head</code>ï¼Œåˆ¤æ–­ <code>head</code> æ˜¯å¦ä¸º <code>null</code>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¤ä¸ºé“¾è¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°† <code>head</code> å’Œ <code>tail</code> å‡ç½®ä¸º <code>null</code>, å¦åˆ™ <code>tail</code> å°¾éƒ¨å…ƒç´ ä¸å˜</li>
<li>å½“é“¾è¡¨ä¸­æœ‰ä¸¤ä¸ªå…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿä¸€ä¸ªå…ƒç´ ï¼Œå³å–å‡º <code>head</code> å¤´éƒ¨å…ƒç´  <code>event2</code>ï¼Œç„¶åæŠŠ <code>head</code> çš„ <code>next</code> å…ƒç´  <code>event3</code> æŒ‡å‘ä¸º <code>head</code>ï¼Œåˆ¤æ–­ <code>head</code> æ˜¯å¦ä¸º <code>null</code>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¤ä¸ºé“¾è¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°† <code>head</code> å’Œ <code>tail</code> å‡ç½®ä¸º <code>null</code>, å¦åˆ™ <code>tail</code> å°¾éƒ¨å…ƒç´ ä¸å˜</li>
<li>å½“é“¾è¡¨ä¸­æœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿä¸€ä¸ªå…ƒç´ ï¼Œå³å–å‡º <code>head</code> å¤´éƒ¨å…ƒç´  <code>event3</code>ï¼Œç„¶åæŠŠ <code>head</code> çš„ <code>next</code> å…ƒç´  <code>null</code> æŒ‡å‘ä¸º <code>head</code>ï¼Œåˆ¤æ–­ <code>head</code> æ˜¯å¦ä¸º <code>null</code>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¤ä¸ºé“¾è¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°† <code>head</code> å’Œ <code>tail</code> å‡ç½®ä¸º <code>null</code>, å¦åˆ™ <code>tail</code> å°¾éƒ¨å…ƒç´ ä¸å˜</li>
</ol>
<h2 id="å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—å…ƒç´ "><a class="markdownIt-Anchor" href="#å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—å…ƒç´ "></a> å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—å…ƒç´ </h2>
<p>å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—çš„å…ƒç´ æ˜¯ <code>PendingPost</code>ï¼Œå®ƒæ˜¯å•å‘é“¾è¡¨ç»“æ„ï¼Œä¹Ÿæ˜¯è®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•ä¸äº‹ä»¶çš„åŒ…è£…ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PendingPost</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;PendingPost&gt; pendingPostPool = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;PendingPost&gt;();</span><br><span class="line"></span><br><span class="line">    Object event;</span><br><span class="line">    Subscription subscription;</span><br><span class="line">    PendingPost next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§æœ‰æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">PendingPost</span><span class="params">(Object event, Subscription subscription)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.event = event;</span><br><span class="line">        <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">static</span> PendingPost <span class="title function_">obtainPendingPost</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (pendingPostPool) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> pendingPostPool.size();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> pendingPostPool.remove(size - <span class="number">1</span>);</span><br><span class="line">                pendingPost.event = event;</span><br><span class="line">                pendingPost.subscription = subscription;</span><br><span class="line">                pendingPost.next = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span> pendingPost;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PendingPost</span>(event, subscription);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">releasePendingPost</span><span class="params">(PendingPost pendingPost)</span> &#123;</span><br><span class="line">        pendingPost.event = <span class="literal">null</span>;</span><br><span class="line">        pendingPost.subscription = <span class="literal">null</span>;</span><br><span class="line">        pendingPost.next = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (pendingPostPool) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t let the pool grow indefinitely</span></span><br><span class="line">            <span class="keyword">if</span> (pendingPostPool.size() &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">                pendingPostPool.add(pendingPost);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº† <code>PendingPost</code> çš„æºç ï¼Œç¬”è€…æƒ³åˆ°äº† Android ä¸­ <code>Message</code> çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨ Android ä¸­ä½¿ç”¨ Handler å‘æ¶ˆæ¯æ—¶ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿç»å¸¸ä½¿ç”¨ <code>handler.obtainMessage()</code> æˆ–è€…ä½¿ç”¨ <code>Message.obtain()</code> å»è·å–ä¸€ä¸ª Message çš„å®ä¾‹ï¼ŒHandler ä½¿ç”¨å®Œ Message åä¼šè‡ªåŠ¨è°ƒç”¨ <code>Message#recycle()</code> æ–¹æ³•å›æ”¶åˆ©ç”¨è¿™ä¸ª Message å®ä¾‹ï¼Œæ­£å¥½å¯¹åº” <code>PendingPost#releasePendingPost()</code> æ–¹æ³•ã€‚<code>Message</code> ä½¿ç”¨äº†ã€Œäº«å…ƒæ¨¡å¼ã€è¾¾åˆ°å¾ªç¯åˆ©ç”¨å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»ºçš„ç›®çš„ï¼Œçœ‹æ¥ <code>PendingPost</code> ä¹Ÿæ˜¯ä½¿ç”¨äº†ã€Œäº«å…ƒæ¨¡å¼ã€ï¼Œåœ¨ç¬¬ä¸€ç¯‡ <a href="https://juejin.cn/post/7104107150678917133">Android-EventBusä¿®æ”¹çºªå®</a> ä¸­æˆ‘ä»¬ä¹Ÿæåˆ° <code>FindState</code> ä¹Ÿæ˜¯ä½¿ç”¨äº†ã€Œäº«å…ƒæ¨¡å¼ã€ã€‚</p>
<h2 id="handlerposter"><a class="markdownIt-Anchor" href="#handlerposter"></a> HandlerPoster</h2>
<p><code>HandlerPoster</code> ç”¨äº <code>MAIN</code> å’Œ <code>MAIN_ORDERED</code> çº¿ç¨‹æ¨¡å‹ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°ä¸»çº¿ç¨‹å¤„ç†ã€‚</p>
<p><code>HandlerPoster</code> ç»§æ‰¿è‡ª <code>Handler</code> ä¼ å…¥ <code>MainLooper</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandlerPoster</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> <span class="keyword">implements</span> <span class="title class_">Poster</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•è½®æœ€å¤§å¤„ç†æ—¶é•¿ï¼Œé»˜è®¤10æ¯«ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxMillisInsideHandleMessage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦æ´»è·ƒï¼Œå¯ä»¥ç†è§£ä¸ºé˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œå¹¶å‘ä¿®æ”¹ç”± this å®ˆæŠ¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> handlerActive;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HandlerPoster</span><span class="params">(EventBus eventBus, Looper looper, <span class="type">int</span> maxMillisInsideHandleMessage)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper);</span><br><span class="line">        <span class="built_in">this</span>.eventBus = eventBus;</span><br><span class="line">        <span class="built_in">this</span>.maxMillisInsideHandleMessage = maxMillisInsideHandleMessage;</span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">PendingPostQueue</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶å…¥é˜Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—å…ƒç´ (äº‹ä»¶åŒ…è£…ç±»å‹)</span></span><br><span class="line">        <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ƒç´ å…¥é˜Ÿ</span></span><br><span class="line">            queue.enqueue(pendingPost);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä¸æ´»è·ƒæ—¶ï¼Œå‘é€ä¸€ä¸ªç©ºçš„æ¶ˆæ¯ç»™å½“å‰Handler</span></span><br><span class="line">            <span class="keyword">if</span> (!handlerActive) &#123;</span><br><span class="line">                handlerActive = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Could not send handler message&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†å‘äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">rescheduled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–å¤„ç†æ­¤è½®æ¶ˆæ¯çš„å¼€å§‹æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">started</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¸åŠ é”ï¼Œå¿«é€Ÿå–å‡ºå¤´éƒ¨å…ƒç´ ï¼Œç±»ä¼¼ä½¿ç”¨åŒé‡æ ¡éªŒé”è·å–å•ä¾‹</span></span><br><span class="line">                <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">                <span class="keyword">if</span> (pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºç©ºå†åŠ é”è·å–å¤´éƒ¨å…ƒç´ </span></span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                        <span class="comment">// Check again, this time in synchronized</span></span><br><span class="line">                        pendingPost = queue.poll();</span><br><span class="line">                        <span class="keyword">if</span> (pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// è¿˜æ˜¯ä¸ºç©ºï¼Œé‡ç½®æ´»è·ƒçŠ¶æ€ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                            handlerActive = <span class="literal">false</span>;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// åˆ†å‘äº‹ä»¶ï¼Œè°ƒç”¨è®¢é˜…æ–¹æ³•</span></span><br><span class="line">                eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ¯æ¬¡åˆ†å‘äº‹ä»¶åéƒ½åˆ¤æ–­æœ¬è½®äº‹ä»¶åˆ†å‘è€—æ—¶æ˜¯å¦è¶…è¿‡å•è½®æœ€å¤§å¤„ç†æ—¶é•¿ï¼Œé¿å… while æ­»å¾ªç¯é˜»å¡ä¸»çº¿ç¨‹</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">timeInMethod</span> <span class="operator">=</span> SystemClock.uptimeMillis() - started;</span><br><span class="line">                <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123;</span><br><span class="line">                    <span class="comment">// è¶…è¿‡å•è½®æœ€å¤§å¤„ç†æ—¶é•¿ï¼Œé‡æ–°å‘é€ä¸€ä¸ªç©ºçš„æ¶ˆæ¯ç»™å½“å‰Handlerç­‰å¾…è°ƒåº¦</span></span><br><span class="line">                    <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Could not send handler message&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    rescheduled = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            handlerActive = rescheduled;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>HandlerPoster</code> å®ç° <code>Poster</code> æ¥å£ä¸­çš„ <code>enqueue</code> æ–¹æ³•ç”¨äºäº‹ä»¶å…¥é˜Ÿï¼Œåœ¨ <code>handleMessage</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>EventBus#invokeSubscriber</code> æ–¹æ³•ä¼ å…¥å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—å…ƒç´ åˆ†å‘äº‹ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">event</span> <span class="operator">=</span> pendingPost.event;</span><br><span class="line">    <span class="type">Subscription</span> <span class="variable">subscription</span> <span class="operator">=</span> pendingPost.subscription;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­¤å¤„å›æ”¶å…ƒç´ </span></span><br><span class="line">    PendingPost.releasePendingPost(pendingPost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è®¢é˜…å…³ç³»æ˜¯å¦æ´»è·ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (subscription.active) &#123;</span><br><span class="line">        <span class="comment">// åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•</span></span><br><span class="line">        invokeSubscriber(subscription, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>HandlerPoster</code> ä¸ºé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œé»˜è®¤å•è½®äº‹ä»¶åˆ†å‘æœ€å¤šæ‰§è¡Œ <strong>10 æ¯«ç§’</strong>ï¼Œå³ 10 æ¯«ç§’å†…å¯ä»¥åˆ†å‘å¤šä¸ªäº‹ä»¶ï¼Œå¤šä¸ªè®¢é˜…æ–¹æ³•çš„æ‰§è¡Œè€—æ—¶ä¹‹å’Œè¶…æ—¶ 10 æ¯«ç§’åï¼Œå°±ä¼šåœæ­¢æœ¬è½®äº‹ä»¶åˆ†å‘ï¼Œé‡æ–°å‘é€ä¸€ä¸ªç©ºæ¶ˆæ¯ç»™ Handler ç­‰å¾…æ‰§è¡Œä¸‹è½®äº‹ä»¶åˆ†å‘ã€‚è¿™é‡Œçš„å¤„ç†æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´ã€‚</p>
<h2 id="backgroundposter"><a class="markdownIt-Anchor" href="#backgroundposter"></a> BackgroundPoster</h2>
<p><code>BackgroundPoster</code> ç”¨äº <code>BACKGROUND</code> çº¿ç¨‹æ¨¡å‹ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°åå°çº¿ç¨‹ã€‚</p>
<p><code>BackgroundPoster</code> å®ç°äº† <code>Runnable</code> æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BackgroundPoster</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, Poster &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ´»è·ƒï¼Œå¯ä»¥ç†è§£ä¸ºé˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œvolatile ç¦æ­¢é‡æ’åºï¼Œä¿è¯å¤šçº¿ç¨‹å¯è§æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> executorRunning;</span><br><span class="line"></span><br><span class="line">    BackgroundPoster(EventBus eventBus) &#123;</span><br><span class="line">        <span class="built_in">this</span>.eventBus = eventBus;</span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">PendingPostQueue</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶å…¥é˜Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—å…ƒç´ (äº‹ä»¶åŒ…è£…ç±»å‹)</span></span><br><span class="line">        <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å…ƒç´ å…¥é˜Ÿ</span></span><br><span class="line">            queue.enqueue(pendingPost);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä¸æ´»è·ƒæ—¶ï¼Œç”±çº¿ç¨‹æ± æ‰§è¡Œæ­¤ Runnable</span></span><br><span class="line">            <span class="keyword">if</span> (!executorRunning) &#123;</span><br><span class="line">                executorRunning = <span class="literal">true</span>;</span><br><span class="line">                eventBus.getExecutorService().execute(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶åˆ†å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="comment">// æœ€é•¿ç­‰å¾…1000æ¯«ç§’ï¼Œå–å‡ºå¤´éƒ¨å…ƒç´ </span></span><br><span class="line">                    <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> queue.poll(<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">if</span> (pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœä¸ºç©ºå†åŠ é”è·å–å¤´éƒ¨å…ƒç´ </span></span><br><span class="line">                        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                            <span class="comment">// Check again, this time in synchronized</span></span><br><span class="line">                            pendingPost = queue.poll();</span><br><span class="line">                            <span class="keyword">if</span> (pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// è¿˜æ˜¯ä¸ºç©ºï¼Œé‡ç½®æ´»è·ƒçŠ¶æ€ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                                executorRunning = <span class="literal">false</span>;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// åˆ†å‘äº‹ä»¶ï¼Œè°ƒç”¨è®¢é˜…æ–¹æ³•</span></span><br><span class="line">                    eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                eventBus.getLogger().log(Level.WARNING, Thread.currentThread().getName() + <span class="string">&quot; was interruppted&quot;</span>, e);</span><br><span class="line">				<span class="comment">// å¿½ç•¥ä¸­æ–­äº‹ä»¶</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// æ­¤æ—¶å·²é€€å‡º while å¾ªç¯ï¼Œå³è®¤ä¸ºå¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">            executorRunning = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BackgroundPoster</code> åŒæ ·å®ç°äº† <code>Poster</code> æ¥å£ä¸­çš„ <code>enqueue</code> æ–¹æ³•ç”¨äºäº‹ä»¶å…¥é˜Ÿï¼Œä¸è¿‡ <code>BackgroundPoster</code> ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œæ‰€ä»¥åœ¨ <code>run</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>EventBus#invokeSubscriber</code> æ–¹æ³•ä¼ å…¥å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—å…ƒç´ åˆ†å‘äº‹ä»¶ã€‚</p>
<p><code>BackgroundPoster</code> åœ¨å¤„ç†æ—¶é—´åˆ†å‘æ—¶ï¼Œç¬¬ä¸€æ¬¡è·å–å…ƒç´ æ—¶è°ƒç”¨äº† <code>poll(int)</code> æ–¹æ³•ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæœ€é•¿ç­‰å¾…1000æ¯«ç§’åå†æ¬¡å–å¤´éƒ¨å…ƒç´ ï¼Œä¸ºä½•è¦è¿™æ ·å®ç°ï¼Ÿ</p>
<p>è¿™é‡Œç¬”è€…çŒœæµ‹æ˜¯æƒ³æé«˜äº‹ä»¶åˆ†å‘æ•ˆç‡ä¸çº¿ç¨‹åˆ©ç”¨ç‡ï¼Œå› ä¸º <code>BackgroundPoster</code> æ˜¯åœ¨å­çº¿ç¨‹ä¸­åˆ†å‘äº‹ä»¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œå¯ä»¥æ¥æ”¶æœ€é•¿ç­‰å¾…1000æ¯«ç§’åå†æ¬¡å–å¤´éƒ¨å…ƒç´ ï¼Œå‡å°åœ¨ç¬¬äºŒæ¬¡åŠ é”å–å¤´éƒ¨å…ƒç´ è¿˜ä¸ºç©ºçš„å‡ ç‡ï¼ŒåŠå‡å°çº¿ç¨‹åˆ‡æ¢å¯¼è‡´çš„èµ„æºå¼€é”€ï¼Œå……åˆ†åˆ©ç”¨çº¿ç¨‹èµ„æºï¼Œæé«˜äº‹ä»¶åˆ†å‘æ•ˆç‡ã€‚</p>
<p><code>BackgroundPoster</code> é»˜è®¤ä½¿ç”¨ EventBus ä¸­çš„çº¿ç¨‹æ±  <code>CachedThreadPool</code>ï¼Œ<strong>åœ¨äº‹ä»¶åˆ†å‘æ—¶ï¼Œ<code>BackgroundPoster</code> å¿½ç•¥äº† <code>InterruptedException</code> ï¼Œå³æ²¡æœ‰å“åº”çº¿ç¨‹ä¸­æ–­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬åœ¨å¤–è¾¹å…³é—­çº¿ç¨‹æ± åï¼Œè¿™å¯èƒ½å¯¼è‡´äº‹ä»¶åˆ†å‘è¿˜åœ¨ç»§ç»­ã€‚</strong></p>
<p>æœ€åï¼Œ<code>BACKGROUND</code> çº¿ç¨‹æ¨¡å‹æè¿°ä¸­è¯´ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œä¸ºä½•åœ¨ <code>BackgroundPoster</code> ä¸­å´æ˜¯ä½¿ç”¨çš„çº¿ç¨‹æ± å‘¢ï¼Ÿ</p>
<p>å…¶å®è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¾ˆå®¹æ˜“å°±è§£ç­”äº†ã€‚å› ä¸ºåœ¨ <code>BackgroundPoster</code> ä¸­ä½¿ç”¨äº† <code>executorRunning</code> å˜é‡ï¼Œè¿™ä¸ªå˜é‡ä¿è¯æ‰§è¡Œå•è½®äº‹ä»¶åˆ†å‘æ—¶ï¼Œéƒ½ä½¿ç”¨çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå•è½®äº‹ä»¶åˆ†å‘å®Œæˆåï¼Œæ–°çš„ä¸€è½®äº‹ä»¶åˆ†å‘å¯èƒ½å°±ä½¿ç”¨å…¶ä»–çš„çº¿ç¨‹äº†ã€‚</p>
<h2 id="asyncposter"><a class="markdownIt-Anchor" href="#asyncposter"></a> AsyncPoster</h2>
<p><code>AsyncPoster</code> ç”¨äº <code>ASYNC</code> çº¿ç¨‹æ¨¡å‹ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°å¼‚æ­¥çº¿ç¨‹ã€‚</p>
<p><code>AsyncPoster</code> å®ç°äº† <code>Runnable</code> å’Œ <code>Poster</code> æ¥å£ï¼Œä½¿ç”¨çº¿ç¨‹æ± å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncPoster</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, Poster &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾…å‘å¸ƒäº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line"></span><br><span class="line">    AsyncPoster(EventBus eventBus) &#123;</span><br><span class="line">        <span class="built_in">this</span>.eventBus = eventBus;</span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">PendingPostQueue</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶å…¥é˜Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">        <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        queue.enqueue(pendingPost);</span><br><span class="line">        <span class="comment">// ç”±çº¿ç¨‹æ± æ‰§è¡Œæ­¤ Runnable</span></span><br><span class="line">        eventBus.getExecutorService().execute(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶åˆ†å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PendingPost</span> <span class="variable">pendingPost</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">        <span class="keyword">if</span>(pendingPost == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No pending post available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AsyncPoster</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨ <code>enqueue</code> æ–¹æ³•å°†äº‹ä»¶å…¥é˜Ÿå¹¶äº¤ç”±çº¿ç¨‹æ± è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œ<code>run</code> æ–¹æ³•å¤„ç†äº‹ä»¶åˆ†å‘ã€‚</p>
<p><code>AsyncPoster</code> é»˜è®¤ä½¿ç”¨ EventBus ä¸­çš„çº¿ç¨‹æ±  <code>CachedThreadPool</code>ï¼Œ<code>CachedThreadPool</code> æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œå…è®¸åˆ›å»º <code>Integer.MAX_VALUE</code> ä¸ªå·¥ä½œçº¿ç¨‹ä¸”çº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é•¿ä¸º 60 ç§’ï¼Œå¦‚æœå‘å¸ƒå¤šä¸ªè€—æ—¶è¾ƒçŸ­çš„äº‹ä»¶æˆ–å¤šä¸ªè€—æ—¶è¾ƒé•¿çš„æ—¶é—´ï¼Œéƒ½ä¼šå¯¼è‡´åˆ›å»ºå¤šä¸ªå·¥ä½œçº¿ç¨‹è€Œæµªè´¹èµ„æºã€‚</p>
<p>è‡³æ­¤ï¼ŒEventBus çš„çº¿ç¨‹è°ƒåº¦åˆ†æå®Œæˆã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡å¯¹ EventBus çš„çº¿ç¨‹è°ƒåº¦è¿›è¡Œäº†åˆ†æï¼Œæœ€åæˆ‘ä»¬åšä¸‹æ€»ç»“ï¼š</p>
<h3 id="pendingpostqueue"><a class="markdownIt-Anchor" href="#pendingpostqueue"></a> PendingPostQueue</h3>
<p>åœ¨ <code>PendingPostQueue</code> ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¦‚ä½•ä½¿ç”¨å•é“¾è¡¨å®ç°å…ˆè¿›å…ˆå‡º(FIFO)é˜Ÿåˆ—ã€‚</p>
<h3 id="pendingpost"><a class="markdownIt-Anchor" href="#pendingpost"></a> PendingPost</h3>
<p>åœ¨ <code>PendingPost</code> ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ã€Œäº«å…ƒæ¨¡å¼ã€çš„ä½¿ç”¨ä»¥åŠå¦‚ä½•å®šä¹‰å•é“¾è¡¨æ•°æ®ç»“æ„ã€‚</p>
<h3 id="handlerposter-2"><a class="markdownIt-Anchor" href="#handlerposter-2"></a> HandlerPoster</h3>
<p>åœ¨ <code>HandlerPoster</code> ä¸­åˆ¤æ–­å•è½®äº‹ä»¶åˆ†å‘æœ€å¤§å¤„ç†æ—¶é•¿æœºåˆ¶ï¼ŒåŠæ—¶è®©å‡ºä¸»çº¿ç¨‹çš„æ‰§è¡Œæƒï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼›ä¸è¿‡è¿™ä¸ªæœºåˆ¶é€‚ç”¨äºè€—æ—¶çŸ­çš„è®¢é˜…æ–¹æ³•ï¼Œå¦‚æœè®¢é˜…æ–¹æ³•è€—æ—¶è¾ƒé•¿ï¼Œä¸€æ ·ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p>
<h3 id="backgroundposter-2"><a class="markdownIt-Anchor" href="#backgroundposter-2"></a> BackgroundPoster</h3>
<p>åœ¨ <code>BackgroundPoster</code> ä¸­è°ƒç”¨ <code>poll(int)</code> æé«˜äº‹ä»¶åˆ†å‘æ•ˆç‡å’Œçº¿ç¨‹åˆ©ç”¨ç‡ï¼Œä¸è¿‡ <code>BackgroundPoster</code> å¿½ç•¥äº†çº¿ç¨‹ä¸­æ–­å¼‚å¸¸ï¼Œä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶éœ€è¦æ³¨æ„è¿™é‡Œï¼Œæœ€åæˆ‘ä»¬è§£ç­”äº† <code>BACKGROUND</code> çº¿ç¨‹æ¨¡å‹æè¿°ä¸­è¯´ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œè€Œ <code>BackgroundPoster</code> å´æ˜¯ä½¿ç”¨çš„çº¿ç¨‹æ± é—®é¢˜ã€‚</p>
<h3 id="asyncposter-2"><a class="markdownIt-Anchor" href="#asyncposter-2"></a> AsyncPoster</h3>
<p><code>AsyncPoster</code> æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬ç®€å•çš„åœ°æ–¹åè€Œæ„å‘³ç€æ˜¯æ¯”è¾ƒå±é™©çš„ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šçœ‹ä¸åˆ°å®ƒçš„å±é™©æ€§ï¼Œå› ä¸ºæˆ‘ä»¬è®¤ä¸ºå®ƒè¶³å¤Ÿç®€å•ã€‚</p>
<h3 id="poster"><a class="markdownIt-Anchor" href="#poster"></a> Poster</h3>
<p><code>Poster</code> è¯´ä¸€ä¸‹å§ï¼Œè®¾è®¡æ¡†æ¶æ—¶å°½é‡ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»ã€‚</p>
<p>æœ€åï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š<strong>æ— è®ºä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨è®¢é˜…æ–¹æ³•ä¸­éƒ½åº”è¯¥å°½é‡é¿å…è¿›è¡Œè€—æ—¶æ“ä½œã€‚</strong></p>
<p>happy~ï¼Œå¸Œæœ›å¯ä»¥å¸®ä½ æ›´å¥½çš„ä½¿ç”¨ EventBus</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>eventbus</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-TextViewè·‘é©¬ç¯æ¢ç§˜</title>
    <url>/2022/05/05/Android/Android-TextView%E8%B7%91%E9%A9%AC%E7%81%AF%E6%8E%A2%E7%A7%98/</url>
    <content><![CDATA[<h1 id="android-textviewè·‘é©¬ç¯æ¢ç§˜"><a class="markdownIt-Anchor" href="#android-textviewè·‘é©¬ç¯æ¢ç§˜"></a> Android-TextViewè·‘é©¬ç¯æ¢ç§˜</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>è‡ªå®šä¹‰Viewå®ç°çš„è·‘é©¬ç¯ä¸€ç›´æ²¡æœ‰å®ç°ç±»ä¼¼ <code>Android TextView</code> çš„è·‘é©¬ç¯é¦–å°¾ç›¸æ¥çš„æ•ˆæœï¼Œæ‰€ä»¥ä¸€ç›´æƒ³çœ‹çœ‹<code>Android TextView</code> çš„è·‘é©¬ç¯æ˜¯å¦‚ä½•å®ç°</p>
<p>æœ¬æ–‡ä¸»è¦æ¢ç§˜ <code>Android TextView</code> çš„è·‘é©¬ç¯å®ç°åŸç†åŠå®ç°è‡ªä¸‹å¾€ä¸Šæ•ˆæœçš„è·‘é©¬ç¯</p>
<h2 id="æ¢ç§˜"><a class="markdownIt-Anchor" href="#æ¢ç§˜"></a> æ¢ç§˜</h2>
<h3 id="textviewondraw"><a class="markdownIt-Anchor" href="#textviewondraw"></a> TextView#onDraw</h3>
<p>åŸç”Ÿ <code>Android TextView</code> å¦‚ä½•è®¾ç½®å¼€å¯è·‘é©¬ç¯æ•ˆæœï¼Œæ­¤å¤„ä¸å†æè¿°</p>
<p><code>View</code> çš„ç»˜åˆ¶éƒ½åœ¨ <code>onDraw</code> æ–¹æ³•ä¸­ï¼Œè¿™é‡Œç›´æ¥æŸ¥çœ‹ <code>TextView#onDraw()</code> æ–¹æ³•ï¼Œåˆ å‡ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">	<span class="comment">// æ˜¯å¦éœ€è¦é‡æ–°å¯åŠ¨è·‘é©¬ç¯</span></span><br><span class="line">	restartMarqueeIfNeeded();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw the background for this view</span></span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º`mLayout`å¯¹è±¡, æ­¤å¤„ä¸º`StaticLayout`</span></span><br><span class="line">    <span class="keyword">if</span> (mLayout == <span class="literal">null</span>) &#123;</span><br><span class="line">        assumeLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Layout</span> <span class="variable">layout</span> <span class="operator">=</span> mLayout;</span><br><span class="line"></span><br><span class="line">    canvas.save();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">layoutDirection</span> <span class="operator">=</span> getLayoutDirection();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">absoluteGravity</span> <span class="operator">=</span> Gravity.getAbsoluteGravity(mGravity, layoutDirection);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­è·‘é©¬ç¯è®¾ç½®é¡¹æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">	<span class="keyword">if</span> (isMarqueeFadeEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!mSingleLine &amp;&amp; getLineCount() == <span class="number">1</span> &amp;&amp; canMarquee()</span><br><span class="line">              &amp;&amp; (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) != Gravity.LEFT) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> mRight - mLeft;</span><br><span class="line">           <span class="keyword">final</span> <span class="type">int</span> <span class="variable">padding</span> <span class="operator">=</span> getCompoundPaddingLeft() + getCompoundPaddingRight();</span><br><span class="line">           <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> mLayout.getLineRight(<span class="number">0</span>) - (width - padding);</span><br><span class="line">           canvas.translate(layout.getParagraphDirection(<span class="number">0</span>) * dx, <span class="number">0.0f</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­è·‘é©¬ç¯æ˜¯å¦å¯åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.isRunning()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> -mMarquee.getScroll();</span><br><span class="line">            <span class="comment">// ç§»åŠ¨ç”»å¸ƒ</span></span><br><span class="line">            canvas.translate(layout.getParagraphDirection(<span class="number">0</span>) * dx, <span class="number">0.0f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">cursorOffsetVertical</span> <span class="operator">=</span> voffsetCursor - voffsetText;</span><br><span class="line"></span><br><span class="line">    <span class="type">Path</span> <span class="variable">highlight</span> <span class="operator">=</span> getUpdatedHighlightPath();</span><br><span class="line">    <span class="keyword">if</span> (mEditor != <span class="literal">null</span>) &#123;</span><br><span class="line">        mEditor.onDraw(canvas, layout, highlight, mHighlightPaint, cursorOffsetVertical);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶æ–‡æœ¬</span></span><br><span class="line">        layout.draw(canvas, highlight, mHighlightPaint, cursorOffsetVertical);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.shouldDrawGhost()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> mMarquee.getGhostOffset();</span><br><span class="line">        <span class="comment">// ç§»åŠ¨ç”»å¸ƒ</span></span><br><span class="line">        canvas.translate(layout.getParagraphDirection(<span class="number">0</span>) * dx, <span class="number">0.0f</span>);</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬</span></span><br><span class="line">        layout.draw(canvas, highlight, mHighlightPaint, cursorOffsetVertical);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    canvas.restore();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="marquee"><a class="markdownIt-Anchor" href="#marquee"></a> Marquee</h3>
<p>æ ¹æ® <code>onDraw()</code> æ–¹æ³•åˆ†æï¼Œè·‘é©¬ç¯æ•ˆæœçš„å®ç°ä¸»è¦ä¾èµ– <code>mMarquee</code> è¿™ä¸ªå¯¹è±¡æ¥å®ç°ï¼Œå¥½çš„ï¼Œçœ‹ä¸‹ <code>Marquee</code> å§ï¼Œ<code>Marquee</code> ä»£ç è¾ƒå°‘ï¼Œå°±è´´ä¸Šå…¨éƒ¨æºç å§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Marquee</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add an option to configure this</span></span><br><span class="line">    <span class="comment">// ç¼©æ”¾ç›¸å…³ï¼Œä¸å…³å¿ƒæ­¤å­—æ®µ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">MARQUEE_DELTA_MAX</span> <span class="operator">=</span> <span class="number">0.07f</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·‘é©¬ç¯è·‘å®Œä¸€æ¬¡åå¤šä¹…å¼€å§‹ä¸‹ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MARQUEE_DELAY</span> <span class="operator">=</span> <span class="number">1200</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»˜åˆ¶ä¸€æ¬¡è·‘å¤šé•¿è·ç¦»å› å­ï¼Œæ­¤å­—æ®µä¸é€Ÿåº¦ç›¸å…³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MARQUEE_DP_PER_SECOND</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·‘é©¬ç¯çŠ¶æ€å¸¸é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_STOPPED</span> <span class="operator">=</span> <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_STARTING</span> <span class="operator">=</span> <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_RUNNING</span> <span class="operator">=</span> <span class="number">0x2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹TextViewè¿›è¡Œå¼±å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;TextView&gt; mView;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¸§ç‡ç›¸å…³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Choreographer mChoreographer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> <span class="variable">mStatus</span> <span class="operator">=</span> MARQUEE_STOPPED;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»˜åˆ¶ä¸€æ¬¡è·‘å¤šé•¿è·ç¦»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">float</span> mPixelsPerMs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€å¤§æ»šåŠ¨è·ç¦»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mMaxScroll;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ä»¥ç»˜åˆ¶å³é˜´å½±, å³ä¾§æ·¡å…¥æ·¡å‡ºæ•ˆæœ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mMaxFadeScroll;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°¾éƒ¨æ–‡æœ¬ä»€ä¹ˆæ—¶å€™å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mGhostStart;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°¾éƒ¨æ–‡æœ¬ç»˜åˆ¶ä½ç½®åç§»é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mGhostOffset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ä»¥ç»˜åˆ¶å·¦é˜´å½±ï¼Œå·¦ä¾§æ·¡å…¥æ·¡å‡ºæ•ˆæœ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mFadeStop;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å¤é™åˆ¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mRepeatLimit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·‘åŠ¨è·ç¦»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mScroll;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡è·‘åŠ¨æ—¶é—´ï¼Œå•ä½æ¯«ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> mLastAnimationMs;</span><br><span class="line"></span><br><span class="line">    Marquee(TextView v) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">density</span> <span class="operator">=</span> v.getContext().getResources().getDisplayMetrics().density;</span><br><span class="line">        <span class="comment">// è®¡ç®—æ¯æ¬¡è·‘å¤šé•¿è·ç¦»</span></span><br><span class="line">        mPixelsPerMs = MARQUEE_DP_PER_SECOND * density / <span class="number">1000f</span>;</span><br><span class="line">        mView = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;TextView&gt;(v);</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸§ç‡å›è°ƒï¼Œç”¨äºè·‘é©¬ç¯è·‘åŠ¨</span></span><br><span class="line">    <span class="keyword">private</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mTickCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">            tick();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸§ç‡å›è°ƒï¼Œç”¨äºè·‘é©¬ç¯å¼€å§‹è·‘åŠ¨</span></span><br><span class="line">    <span class="keyword">private</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mStartCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">            mStatus = MARQUEE_RUNNING;</span><br><span class="line">            mLastAnimationMs = mChoreographer.getFrameTime();</span><br><span class="line">            tick();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸§ç‡å›è°ƒï¼Œç”¨äºè·‘é©¬ç¯é‡æ–°è·‘åŠ¨</span></span><br><span class="line">    <span class="keyword">private</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mRestartCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStatus == MARQUEE_RUNNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mRepeatLimit &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mRepeatLimit--;</span><br><span class="line">                &#125;</span><br><span class="line">                start(mRepeatLimit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·‘é©¬ç¯è·‘åŠ¨å®ç°</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tick</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatus != MARQUEE_RUNNING) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mChoreographer.removeFrameCallback(mTickCallback);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­TextViewæ˜¯å¦å¤„äºè·å–ç„¦ç‚¹æˆ–é€‰ä¸­çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span> &amp;&amp; (textView.isFocused() || textView.isSelected())) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">currentMs</span> <span class="operator">=</span> mChoreographer.getFrameTime();</span><br><span class="line">            <span class="comment">// è®¡ç®—å½“å‰æ—¶é—´ä¸ä¸Šæ¬¡æ—¶é—´çš„å·®å€¼</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">deltaMs</span> <span class="operator">=</span> currentMs - mLastAnimationMs;</span><br><span class="line">            mLastAnimationMs = currentMs;</span><br><span class="line">            <span class="comment">// æ ¹æ®æ—¶é—´å·®è®¡ç®—æœ¬æ¬¡è·‘åŠ¨çš„è·ç¦»ï¼Œå‡è½»è§†è§‰ä¸Šè·³åŠ¨/å¡é¡¿</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">deltaPx</span> <span class="operator">=</span> deltaMs * mPixelsPerMs;</span><br><span class="line">            <span class="comment">// è®¡ç®—è·‘åŠ¨è·ç¦»</span></span><br><span class="line">            mScroll += deltaPx;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»è·‘å®Œ</span></span><br><span class="line">            <span class="keyword">if</span> (mScroll &gt; mMaxScroll) &#123;</span><br><span class="line">                mScroll = mMaxScroll;</span><br><span class="line">                <span class="comment">// å‘é€é‡æ–°å¼€å§‹è·‘åŠ¨äº‹ä»¶</span></span><br><span class="line">                mChoreographer.postFrameCallbackDelayed(mRestartCallback, MARQUEE_DELAY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€ä¸‹ä¸€æ¬¡è·‘åŠ¨äº‹ä»¶</span></span><br><span class="line">                mChoreographer.postFrameCallback(mTickCallback);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ­¤æ–¹æ³•ä¼šè§¦å‘æ‰§è¡Œ`onDraw`æ–¹æ³•</span></span><br><span class="line">            textView.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢è·‘é©¬ç¯</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        mStatus = MARQUEE_STOPPED;</span><br><span class="line">        mChoreographer.removeFrameCallback(mStartCallback);</span><br><span class="line">        mChoreographer.removeFrameCallback(mRestartCallback);</span><br><span class="line">        mChoreographer.removeFrameCallback(mTickCallback);</span><br><span class="line">        resetScroll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        mScroll = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span>) textView.invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨è·‘é©¬ç¯</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> repeatLimit)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (repeatLimit == <span class="number">0</span>) &#123;</span><br><span class="line">            stop();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mRepeatLimit = repeatLimit;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span> &amp;&amp; textView.mLayout != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®çŠ¶æ€ä¸ºåœ¨è·‘</span></span><br><span class="line">            mStatus = MARQUEE_STARTING;</span><br><span class="line">            <span class="comment">// é‡ç½®è·‘åŠ¨è·ç¦»</span></span><br><span class="line">            mScroll = <span class="number">0.0f</span>;</span><br><span class="line">            <span class="comment">// è®¡ç®—TextViewå®½åº¦</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">textWidth</span> <span class="operator">=</span> textView.getWidth() - textView.getCompoundPaddingLeft()</span><br><span class="line">                - textView.getCompoundPaddingRight();</span><br><span class="line">            <span class="comment">// è·å–æ–‡æœ¬ç¬¬0è¡Œçš„å®½åº¦</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">float</span> <span class="variable">lineWidth</span> <span class="operator">=</span> textView.mLayout.getLineWidth(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// å–TextViewå®½åº¦çš„ä¸‰åˆ†ä¹‹ä¸€</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">float</span> <span class="variable">gap</span> <span class="operator">=</span> textWidth / <span class="number">3.0f</span>;</span><br><span class="line">            <span class="comment">// è®¡ç®—ä»€ä¹ˆæ—¶å€™å¯ä»¥å¼€å§‹ç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬ï¼šé¦–éƒ¨æ–‡æœ¬è·‘åŠ¨åˆ°å“ªé‡Œå¯ä»¥ç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬</span></span><br><span class="line">            mGhostStart = lineWidth - textWidth + gap;</span><br><span class="line">            <span class="comment">// è®¡ç®—æœ€å¤§æ»šåŠ¨è·ç¦»ï¼šä»€ä¹ˆæ—¶å€™è®¤ä¸ºè·‘å®Œä¸€æ¬¡</span></span><br><span class="line">            mMaxScroll = mGhostStart + textWidth;</span><br><span class="line">            <span class="comment">// å°¾éƒ¨æ–‡æœ¬ç»˜åˆ¶åç§»é‡</span></span><br><span class="line">            mGhostOffset = lineWidth + gap;</span><br><span class="line">            <span class="comment">// è·‘åŠ¨åˆ°å“ªé‡Œæ—¶ä¸ç»˜åˆ¶å·¦ä¾§é˜´å½±</span></span><br><span class="line">            mFadeStop = lineWidth + textWidth / <span class="number">6.0f</span>;</span><br><span class="line">            <span class="comment">// è·‘åŠ¨åˆ°å“ªé‡Œæ—¶ä¸ç»˜åˆ¶å³ä¾§é˜´å½±</span></span><br><span class="line">            mMaxFadeScroll = mGhostStart + lineWidth + lineWidth;</span><br><span class="line"></span><br><span class="line">            textView.invalidate();</span><br><span class="line">            <span class="comment">// å¼€å§‹è·‘åŠ¨</span></span><br><span class="line">            mChoreographer.postFrameCallback(mStartCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å°¾éƒ¨æ–‡æœ¬ç»˜åˆ¶ä½ç½®åç§»é‡</span></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getGhostOffset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mGhostOffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ»šåŠ¨è·ç¦»</span></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mScroll;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¯ä»¥å³ä¾§é˜´å½±ç»˜åˆ¶çš„æœ€å¤§è·ç¦»</span></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getMaxFadeScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mMaxFadeScroll;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»˜åˆ¶å·¦ä¾§é˜´å½±</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldDrawLeftFade</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mScroll &lt;= mFadeStop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldDrawGhost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_RUNNING &amp;&amp; mScroll &gt; mGhostStart;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·‘é©¬ç¯æ˜¯å¦åœ¨è·‘</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_RUNNING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·‘é©¬ç¯æ˜¯å¦ä¸è·‘</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isStopped</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_STOPPED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œåˆ†æå®Œ <code>Marquee</code>ï¼Œè·‘é©¬ç¯å®ç°åŸç†è±ç„¶æ˜äº®</p>
<ol>
<li>åœ¨ <code>TextView</code> å¼€å¯è·‘é©¬ç¯æ•ˆæœæ—¶è°ƒç”¨ <code>Marquee#start()</code> æ–¹æ³•</li>
<li>åœ¨ <code>Marquee#start()</code> æ–¹æ³•ä¸­è§¦å‘ <code>TextView</code> é‡ç»˜ï¼Œå¼€å§‹è®¡ç®—è·‘åŠ¨è·ç¦»</li>
<li>åœ¨ <code>TextView#onDraw()</code> æ–¹æ³•ä¸­æ ¹æ®è·‘åŠ¨è·ç¦»ç§»åŠ¨ç”»å¸ƒå¹¶ç»˜åˆ¶é¦–éƒ¨æ–‡æœ¬ï¼Œå†æ ¹æ®è·‘åŠ¨è·ç¦»åˆ¤æ–­æ˜¯å¦å¯ä»¥ç§»åŠ¨ç”»å¸ƒç»˜åˆ¶å°¾éƒ¨æ–‡æœ¬</li>
</ol>
<h3 id="å°ç»“"><a class="markdownIt-Anchor" href="#å°ç»“"></a> å°ç»“</h3>
<p><code>TextView</code> é€šè¿‡ç§»åŠ¨ç”»å¸ƒç»˜åˆ¶ä¸¤æ¬¡æ–‡æœ¬å®ç°è·‘é©¬ç¯æ•ˆæœï¼Œæ ¹æ®ä¸¤å¸§ç»˜åˆ¶çš„æ—¶é—´å·®è®¡ç®—è·‘åŠ¨è·ç¦»ï¼Œæ€ä¸€ä¸ª&quot;å¦™&quot;äº†å¾—</p>
<h2 id="åº”ç”¨"><a class="markdownIt-Anchor" href="#åº”ç”¨"></a> åº”ç”¨</h2>
<p>ä¸Šé¢åˆ†æå®ŒåŸç”Ÿ <code>Android TextView</code> è·‘é©¬ç¯çš„å®ç°åŸç†ï¼Œä½†æ˜¯åŸç”Ÿ <code>Android TextView</code> è·‘é©¬ç¯æœ‰å‡ ç‚¹ä¸è¶³ï¼š</p>
<ol>
<li>æ— æ³•è®¾ç½®è·‘åŠ¨é€Ÿåº¦</li>
<li>æ— æ³•è®¾ç½®é‡è·‘é—´éš”æ—¶é•¿</li>
<li>æ— æ³•å®ç°ä¸Šä¸‹è·‘åŠ¨</li>
</ol>
<p>ä»¥ä¸Šç¬¬1ã€2ç‚¹åœ¨ä¸Šé¢ <code>Marquee</code> åˆ†æä¸­å·²ç»æœ‰è§£å†³æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥æ ¹æ®åŸç”Ÿå®ç°åŸç†å®ç°ç¬¬3ç‚¹ä¸Šä¸‹è·‘åŠ¨</p>
<h3 id="marqueetextview"><a class="markdownIt-Anchor" href="#marqueetextview"></a> MarqueeTextView</h3>
<p>è¿™é‡Œç»™å‡ºå®ç°æ–¹æ¡ˆï¼Œåˆ—å‡ºä¸»è¦å®ç°é€»è¾‘ï¼Œç»§æ‰¿ <code>AppCompatTextView</code>ï¼Œå¤å†™ <code>onDraw()</code> æ–¹æ³•ï¼Œä¸Šä¸‹è·‘åŠ¨ä¸»è¦æ˜¯è®¡ç®—ä¸Šä¸‹è·‘åŠ¨çš„è·ç¦»ï¼Œç„¶åå†æ¬¡é‡ç»˜ <code>TextView</code> ä¸Šä¸‹ç§»åŠ¨ç”»å¸ƒç»˜åˆ¶æ–‡æœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»§æ‰¿AppCompatTextViewï¼Œå¤å†™onDrawæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarqueeTextView</span> <span class="keyword">extends</span> <span class="title class_">AppCompatTextView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_BG_COLOR</span> <span class="operator">=</span> Color.parseColor(<span class="string">&quot;#FFEFEFEF&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IntDef(&#123;HORIZONTAL, VERTICAL&#125;)</span></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> OrientationMode &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HORIZONTAL</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERTICAL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Marquee mMarquee;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mRestartMarquee;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isMarquee;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mOrientation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MarqueeTextView</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MarqueeTextView</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MarqueeTextView</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line"></span><br><span class="line">        <span class="type">TypedArray</span> <span class="variable">ta</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, R.styleable.MarqueeTextView, defStyleAttr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        mOrientation = ta.getInt(R.styleable.MarqueeTextView_orientation, HORIZONTAL);</span><br><span class="line"></span><br><span class="line">        ta.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSizeChanged</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, <span class="type">int</span> oldw, <span class="type">int</span> oldh)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getWidth() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                mRestartMarquee = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getHeight() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                mRestartMarquee = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">restartMarqueeIfNeeded</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRestartMarquee) &#123;</span><br><span class="line">            mRestartMarquee = <span class="literal">false</span>;</span><br><span class="line">            startMarquee();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMarquee</span><span class="params">(<span class="type">boolean</span> marquee)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wasStart</span> <span class="operator">=</span> isMarquee();</span><br><span class="line"></span><br><span class="line">        isMarquee = marquee;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (wasStart != marquee) &#123;</span><br><span class="line">            <span class="keyword">if</span> (marquee) &#123;</span><br><span class="line">                startMarquee();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stopMarquee();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrientation</span><span class="params">(<span class="meta">@OrientationMode</span> <span class="type">int</span> orientation)</span> &#123;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrientation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOrientation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMarquee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isMarquee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMarquee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</span><br><span class="line">            setHorizontalFadingEdgeEnabled(<span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setVerticalFadingEdgeEnabled(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        requestLayout();</span><br><span class="line">        invalidate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; !mMarquee.isStopped()) &#123;</span><br><span class="line">            mMarquee.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMarquee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (canMarquee()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</span><br><span class="line">                setHorizontalFadingEdgeEnabled(<span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setVerticalFadingEdgeEnabled(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMarquee == <span class="literal">null</span>) mMarquee = <span class="keyword">new</span> <span class="title class_">Marquee</span>(<span class="built_in">this</span>);</span><br><span class="line">            mMarquee.start(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canMarquee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">viewWidth</span> <span class="operator">=</span> getWidth() - getCompoundPaddingLeft() -</span><br><span class="line">                getCompoundPaddingRight();</span><br><span class="line">            <span class="type">float</span> <span class="variable">lineWidth</span> <span class="operator">=</span> getLayout().getLineWidth(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> (mMarquee == <span class="literal">null</span> || mMarquee.isStopped())</span><br><span class="line">                &amp;&amp; (isFocused() || isSelected() || isMarquee())</span><br><span class="line">                &amp;&amp; viewWidth &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; lineWidth &gt; viewWidth;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">viewHeight</span> <span class="operator">=</span> getHeight() - getCompoundPaddingTop() -</span><br><span class="line">                getCompoundPaddingBottom();</span><br><span class="line">            <span class="type">float</span> <span class="variable">textHeight</span> <span class="operator">=</span> getLayout().getHeight();</span><br><span class="line">            <span class="keyword">return</span> (mMarquee == <span class="literal">null</span> || mMarquee.isStopped())</span><br><span class="line">                &amp;&amp; (isFocused() || isSelected() || isMarquee())</span><br><span class="line">                &amp;&amp; viewHeight &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; textHeight &gt; viewHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¿ç…§TextView#onDraw()æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        restartMarqueeIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†æ¬¡ç»˜åˆ¶èƒŒæ™¯è‰²ï¼Œè¦†ç›–ä¸‹é¢ç”±TextViewç»˜åˆ¶çš„æ–‡æœ¬ï¼Œè§†æƒ…å†µå¯ä»¥ä¸è°ƒç”¨`super.onDraw(canvas);`</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰èƒŒæ™¯è‰²åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²</span></span><br><span class="line">        <span class="type">Drawable</span> <span class="variable">background</span> <span class="operator">=</span> getBackground();</span><br><span class="line">        <span class="keyword">if</span> (background != <span class="literal">null</span>) &#123;</span><br><span class="line">            background.draw(canvas);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            canvas.drawColor(DEFAULT_BG_COLOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        canvas.save();</span><br><span class="line"></span><br><span class="line">        canvas.translate(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ç°å·¦å³è·‘é©¬ç¯</span></span><br><span class="line">        <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.isRunning()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> -mMarquee.getScroll();</span><br><span class="line">                canvas.translate(dx, <span class="number">0.0F</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            getLayout().draw(canvas, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.shouldDrawGhost()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> mMarquee.getGhostOffset();</span><br><span class="line">                canvas.translate(dx, <span class="number">0.0F</span>);</span><br><span class="line">                getLayout().draw(canvas, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å®ç°ä¸Šä¸‹è·‘é©¬ç¯</span></span><br><span class="line">            <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.isRunning()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dy</span> <span class="operator">=</span> -mMarquee.getScroll();</span><br><span class="line">                canvas.translate(<span class="number">0.0F</span>, dy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            getLayout().draw(canvas, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMarquee != <span class="literal">null</span> &amp;&amp; mMarquee.shouldDrawGhost()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">dy</span> <span class="operator">=</span> mMarquee.getGhostOffset();</span><br><span class="line">                canvas.translate(<span class="number">0.0F</span>, dy);</span><br><span class="line">                getLayout().draw(canvas, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="marquee-2"><a class="markdownIt-Anchor" href="#marquee-2"></a> Marquee</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Marquee</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ­¤å­—æ®µè®¾ç½®é‡è·‘æ—¶é—´é—´éš” - å¯¹åº”ä¸è¶³ç‚¹2</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MARQUEE_DELAY</span> <span class="operator">=</span> <span class="number">1200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ­¤å­—æ®µè®¾ç½®è·‘åŠ¨é€Ÿåº¦ - å¯¹åº”ä¸è¶³ç‚¹1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MARQUEE_DP_PER_SECOND</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_STOPPED</span> <span class="operator">=</span> <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_STARTING</span> <span class="operator">=</span> <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">MARQUEE_RUNNING</span> <span class="operator">=</span> <span class="number">0x2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_GET_FRAME_TIME</span> <span class="operator">=</span> <span class="string">&quot;getFrameTime&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;MarqueeTextView&gt; mView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Choreographer mChoreographer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> <span class="variable">mStatus</span> <span class="operator">=</span> MARQUEE_STOPPED;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">float</span> mPixelsPerSecond;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mMaxScroll;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mMaxFadeScroll;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mGhostStart;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mGhostOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mFadeStop;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mRepeatLimit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> mScroll;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> mLastAnimationMs;</span><br><span class="line"></span><br><span class="line">    Marquee(MarqueeTextView v) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">density</span> <span class="operator">=</span> v.getContext().getResources().getDisplayMetrics().density;</span><br><span class="line">        mPixelsPerSecond = MARQUEE_DP_PER_SECOND * density;</span><br><span class="line">        mView = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(v);</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mTickCallback</span> <span class="operator">=</span> frameTimeNanos -&gt; tick();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mStartCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">            mStatus = MARQUEE_RUNNING;</span><br><span class="line">            mLastAnimationMs = getFrameTime();</span><br><span class="line">            tick();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * `getFrameTime`æ˜¯éšè—apiï¼Œæ­¤å¤„ä½¿ç”¨åå°„è°ƒç”¨ï¼Œé«˜ç³»ç»Ÿç‰ˆæœ¬å¯èƒ½å¤±æ•ˆï¼Œå¯ä½¿ç”¨æŸäº›æ–¹æ¡ˆç»•è¿‡æ­¤é™åˆ¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;PrivateApi&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getFrameTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;? <span class="keyword">extends</span> <span class="title class_">Choreographer</span>&gt; clz = mChoreographer.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getFrameTime</span> <span class="operator">=</span> clz.getDeclaredMethod(METHOD_GET_FRAME_TIME);</span><br><span class="line">            getFrameTime.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">long</span>) getFrameTime.invoke(mChoreographer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mRestartCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStatus == MARQUEE_RUNNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mRepeatLimit &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mRepeatLimit--;</span><br><span class="line">                &#125;</span><br><span class="line">                start(mRepeatLimit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tick</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatus != MARQUEE_RUNNING) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mChoreographer.removeFrameCallback(mTickCallback);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarqueeTextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span> &amp;&amp; (textView.isFocused() || textView.isSelected() || textView.isMarquee())) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">currentMs</span> <span class="operator">=</span> getFrameTime();</span><br><span class="line">            <span class="type">long</span> <span class="variable">deltaMs</span> <span class="operator">=</span> currentMs - mLastAnimationMs;</span><br><span class="line">            mLastAnimationMs = currentMs;</span><br><span class="line">            <span class="type">float</span> <span class="variable">deltaPx</span> <span class="operator">=</span> deltaMs / <span class="number">1000F</span> * mPixelsPerSecond;</span><br><span class="line">            mScroll += deltaPx;</span><br><span class="line">            <span class="keyword">if</span> (mScroll &gt; mMaxScroll) &#123;</span><br><span class="line">                mScroll = mMaxScroll;</span><br><span class="line">                mChoreographer.postFrameCallbackDelayed(mRestartCallback, MARQUEE_DELAY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mChoreographer.postFrameCallback(mTickCallback);</span><br><span class="line">            &#125;</span><br><span class="line">            textView.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        mStatus = MARQUEE_STOPPED;</span><br><span class="line">        mChoreographer.removeFrameCallback(mStartCallback);</span><br><span class="line">        mChoreographer.removeFrameCallback(mRestartCallback);</span><br><span class="line">        mChoreographer.removeFrameCallback(mTickCallback);</span><br><span class="line">        resetScroll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        mScroll = <span class="number">0.0F</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarqueeTextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span>) textView.invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> repeatLimit)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (repeatLimit == <span class="number">0</span>) &#123;</span><br><span class="line">            stop();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mRepeatLimit = repeatLimit;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarqueeTextView</span> <span class="variable">textView</span> <span class="operator">=</span> mView.get();</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span> &amp;&amp; textView.getLayout() != <span class="literal">null</span>) &#123;</span><br><span class="line">            mStatus = MARQUEE_STARTING;</span><br><span class="line">            mScroll = <span class="number">0.0F</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ†åˆ«è®¡ç®—å·¦å³å’Œä¸Šä¸‹è·‘åŠ¨æ‰€éœ€çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (textView.getOrientation() == HORIZONTAL) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">viewWidth</span> <span class="operator">=</span> textView.getWidth() - textView.getCompoundPaddingLeft() -</span><br><span class="line">                    textView.getCompoundPaddingRight();</span><br><span class="line">                <span class="type">float</span> <span class="variable">lineWidth</span> <span class="operator">=</span> textView.getLayout().getLineWidth(<span class="number">0</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">gap</span> <span class="operator">=</span> viewWidth / <span class="number">3.0F</span>;</span><br><span class="line">                mGhostStart = lineWidth - viewWidth + gap;</span><br><span class="line">                mMaxScroll = mGhostStart + viewWidth;</span><br><span class="line">                mGhostOffset = lineWidth + gap;</span><br><span class="line">                mFadeStop = lineWidth + viewWidth / <span class="number">6.0F</span>;</span><br><span class="line">                mMaxFadeScroll = mGhostStart + lineWidth + lineWidth;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">viewHeight</span> <span class="operator">=</span> textView.getHeight() - textView.getCompoundPaddingTop() -</span><br><span class="line">                    textView.getCompoundPaddingBottom();</span><br><span class="line">                <span class="type">float</span> <span class="variable">textHeight</span> <span class="operator">=</span> textView.getLayout().getHeight();</span><br><span class="line">                <span class="type">float</span> <span class="variable">gap</span> <span class="operator">=</span> viewHeight / <span class="number">3.0F</span>;</span><br><span class="line">                mGhostStart = textHeight - viewHeight + gap;</span><br><span class="line">                mMaxScroll = mGhostStart + viewHeight;</span><br><span class="line">                mGhostOffset = textHeight + gap;</span><br><span class="line">                mFadeStop = textHeight + viewHeight / <span class="number">6.0F</span>;</span><br><span class="line">                mMaxFadeScroll = mGhostStart + textHeight + textHeight;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            textView.invalidate();</span><br><span class="line">            mChoreographer.postFrameCallback(mStartCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getGhostOffset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mGhostOffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mScroll;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getMaxFadeScroll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mMaxFadeScroll;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldDrawLeftFade</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mScroll &lt;= mFadeStop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldDrawTopFade</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mScroll &lt;= mFadeStop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldDrawGhost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_RUNNING &amp;&amp; mScroll &gt; mGhostStart;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_RUNNING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isStopped</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatus == MARQUEE_STOPPED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ•ˆæœ"><a class="markdownIt-Anchor" href="#æ•ˆæœ"></a> æ•ˆæœ</h3>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205051857334.png" alt="è·‘é©¬ç¯" /></p>
<p>happy~</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>è·‘é©¬ç¯</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-EventBusä¿®æ”¹çºªå®(å››)-æ³¨è§£å¤„ç†å™¨</title>
    <url>/2022/06/04/Android/Android-EventBus%E4%BF%AE%E6%94%B9%E7%BA%AA%E5%AE%9E(%E5%9B%9B)-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8/</url>
    <content><![CDATA[<h1 id="android-eventbusä¿®æ”¹çºªå®å››-æ³¨è§£å¤„ç†å™¨"><a class="markdownIt-Anchor" href="#android-eventbusä¿®æ”¹çºªå®å››-æ³¨è§£å¤„ç†å™¨"></a> Android-EventBusä¿®æ”¹çºªå®(å››)-æ³¨è§£å¤„ç†å™¨</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 6 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>æœ¬æ–‡æ˜¯ EventBus ä¿®æ”¹çºªå®çš„ç¬¬å››ç¯‡ï¼Œç¬”è€…åœ¨å†™ç¬¬ä¸€ç¯‡æ–‡ç« æ—¶åªæ˜¯æƒ³è®°å½•ä¸‹ä¿®æ”¹ EventBus çš„è¿‡ç¨‹ï¼Œåˆ†äº«è§£å†³é—®é¢˜å’ŒæŸ¥çœ‹æºç çš„æ€è·¯ï¼Œæ²¡æƒ³åˆ°ä¸çŸ¥ä¸è§‰ä¼šå†™è¿™ä¹ˆå¤šï¼Œâ€œå¤©ä¸‹æ— ä¸æ•£ä¹‹ç­µå¸­â€ï¼Œæœ¬æ–‡å°†åˆ†æ EventBus æ³¨è§£å¤„ç†å™¨çš„æµç¨‹ï¼Œä¹Ÿæ˜¯ EventBus ä¿®æ”¹çºªå®çš„æœ€åä¸€ç¯‡æ–‡ç« ã€‚</p>
<h2 id="çºªå®"><a class="markdownIt-Anchor" href="#çºªå®"></a> çºªå®</h2>
<p>EventBus çš„æ³¨è§£å¤„ç†å™¨ç¨‹åºåªæœ‰ä¸€ä¸ªç±» <code>EventBusAnnotationProcessor</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes(&quot;com.yarward.org.greenrobot.eventbus.Subscribe&quot;)</span></span><br><span class="line"><span class="meta">@SupportedOptions(value = &#123;&quot;eventBusIndex&quot;, &quot;verbose&quot;&#125;)</span></span><br><span class="line"><span class="meta">@IncrementalAnnotationProcessor(AGGREGATING)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBusAnnotationProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractProcessor</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EventBusAnnotationProcessor</code> ä¸Šæœ‰ä¸‰ä¸ªæ³¨è§£ï¼Œä¸‹é¢ä¸€ä¸€ä»‹ç»ï¼š</p>
<ul>
<li><code>@SupportedAnnotationTypes</code> æ³¨è§£æ ‡è¯†è¯¥æ³¨è§£å¤„ç†å™¨åªå¤„ç† <code>@Subscribe</code> æ³¨è§£ï¼Œ</li>
<li><code>@SupportedOptions</code> æ³¨è§£æ ‡è¯†æ”¹æ³¨è§£å¤„ç†å™¨å¯ä»¥æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œ<code>eventBusIndex</code> æ ‡è¯†è¦ç”Ÿæˆ Index ç±»çš„å…¨é‡é™å®šåç§°ï¼Œ<code>verbose</code> ä¸»è¦ç”¨äºæ—¥å¿—è¾“å‡º</li>
<li><code>@IncrementalAnnotationProcessor</code> æ³¨è§£æ–¹ä¾¿æ„å»ºå¢é‡æ³¨è§£å¤„ç†å™¨</li>
</ul>
<h3 id="process"><a class="markdownIt-Anchor" href="#process"></a> process</h3>
<p>æ¥ä¸‹æ¥åˆ†æå¤„ç†æµç¨‹ï¼Œå¤„ç†æµç¨‹ä¸»è¦åœ¨ <code>process</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OPTION_EVENT_BUS_INDEX</span> <span class="operator">=</span> <span class="string">&quot;eventBusIndex&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OPTION_VERBOSE</span> <span class="operator">=</span> <span class="string">&quot;verbose&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// annotations æ˜¯ `@Subscribe` æ³¨è§£é›†åˆ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ—¥å¿—è¾“å‡ºå™¨</span></span><br><span class="line">    <span class="type">Messager</span> <span class="variable">messager</span> <span class="operator">=</span> processingEnv.getMessager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å– `eventBusIndex` å‚æ•°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">index</span> <span class="operator">=</span> processingEnv.getOptions().get(OPTION_EVENT_BUS_INDEX);</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="literal">null</span>) &#123;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;No option &quot;</span> + OPTION_EVENT_BUS_INDEX +</span><br><span class="line">                                  <span class="string">&quot; passed to annotation processor&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å– `verbose` å‚æ•°</span></span><br><span class="line">        verbose = Boolean.parseBoolean(processingEnv.getOptions().get(OPTION_VERBOSE));</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastPeriod</span> <span class="operator">=</span> index.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="comment">// è·å– eventBusIndex çš„åŒ…å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">indexPackage</span> <span class="operator">=</span> lastPeriod != -<span class="number">1</span> ? index.substring(<span class="number">0</span>, lastPeriod) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        round++;</span><br><span class="line">        <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">&quot;Processing round &quot;</span> + round + <span class="string">&quot;, new annotations: &quot;</span> +</span><br><span class="line">                                  !annotations.isEmpty() + <span class="string">&quot;, processingOver: &quot;</span> + env.processingOver());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (env.processingOver()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!annotations.isEmpty()) &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.ERROR,</span><br><span class="line">                                      <span class="string">&quot;Unexpected processing state: annotations still available after processing over&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (annotations.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (writerRoundDone) &#123;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.ERROR,</span><br><span class="line">                                  <span class="string">&quot;Unexpected processing state: annotations still available after writing.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ”¶é›†è®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•</span></span><br><span class="line">        collectSubscribers(annotations, env, messager);</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¸ºè®¢é˜…è€…ç”Ÿæˆ Index</span></span><br><span class="line">        checkForSubscribersToSkip(messager, indexPackage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!methodsByClass.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// ç”Ÿæˆ Index æ–‡ä»¶</span></span><br><span class="line">            createInfoIndexFile(index);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.WARNING, <span class="string">&quot;No @Subscribe annotations found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        writerRoundDone = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">// IntelliJ does not handle exceptions nicely, so log and print a message</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;Unexpected error in EventBusAnnotationProcessor: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="collectsubscribers"><a class="markdownIt-Anchor" href="#collectsubscribers"></a> collectSubscribers</h3>
<p>æˆ‘ä»¬é¦–å…ˆåˆ†ææ˜¯å¦‚ä½•æ”¶é›†è®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰é›†åˆï¼Œå®é™…ä¸Šæ˜¯ Map&lt;TypeElement, List&lt;ExecutableElement&gt;&gt;</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ListMap&lt;TypeElement, ExecutableElement&gt; methodsByClass = <span class="keyword">new</span> <span class="title class_">ListMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// annotations æ˜¯ `@Subscribe ` æ³¨è§£é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectSubscribers</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env, Messager messager)</span> &#123;</span><br><span class="line">    <span class="comment">// éå† `@Subscribe` æ³¨è§£é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (TypeElement annotation : annotations) &#123;</span><br><span class="line">        <span class="comment">// è·å–æœ‰ `@Subscribe` æ³¨è§£çš„å…ƒç´ é›†åˆ</span></span><br><span class="line">        Set&lt;? <span class="keyword">extends</span> <span class="title class_">Element</span>&gt; elements = env.getElementsAnnotatedWith(annotation);</span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯å¯æ‰§è¡Œçš„å…ƒç´ ï¼Œä¸€èˆ¬è¡¨ç¤ºæ˜¯ Java æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (element <span class="keyword">instanceof</span> ExecutableElement) &#123;</span><br><span class="line">                <span class="type">ExecutableElement</span> <span class="variable">method</span> <span class="operator">=</span> (ExecutableElement) element;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥æ˜¯å¦æ˜¯è®¢é˜…æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (checkHasNoErrors(method, messager)) &#123;</span><br><span class="line">                    <span class="type">TypeElement</span> <span class="variable">classElement</span> <span class="operator">=</span> (TypeElement) method.getEnclosingElement();</span><br><span class="line">                    <span class="comment">// æ·»åŠ è¿› Map é›†åˆ</span></span><br><span class="line">                    methodsByClass.putElement(classElement, method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;@Subscribe is only valid for methods&quot;</span>, element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆéå† <code>@Subscribe</code> æ³¨è§£é›†åˆï¼Œé€šè¿‡ <code>getElementsAnnotatedWith</code> è·å–æœ‰ <code>@Subscribe</code> æ³¨è§£çš„å…ƒç´ é›†åˆï¼Œç„¶åéå†å…ƒç´ é›†åˆï¼Œåœ¨éå†å…ƒç´ é›†åˆæ—¶åˆ¤æ–­å…ƒç´ æ˜¯å¦æ˜¯ <code>ExecutableElement</code>ï¼Œå³å½“å‰å…ƒç´ æ˜¯ä¸æ˜¯æ–¹æ³•ï¼Œå¦‚ä½•æ˜¯æ–¹æ³•å†é€šè¿‡ <code>checkHasNoErrors</code> æ£€æŸ¥æ­¤æ–¹æ³•æ˜¯å¦ç¬¦åˆè®¢é˜…æ–¹æ³•çš„è§„èŒƒï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkHasNoErrors</span><span class="params">(ExecutableElement element, Messager messager)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯é™æ€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (element.getModifiers().contains(Modifier.STATIC)) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;Subscriber method must not be static&quot;</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å…¬å¼€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (!element.getModifiers().contains(Modifier.PUBLIC)) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;Subscriber method must be public&quot;</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€ä¸ªå…¥å‚</span></span><br><span class="line">    List&lt;? <span class="keyword">extends</span> <span class="title class_">VariableElement</span>&gt; parameters = ((ExecutableElement) element).getParameters();</span><br><span class="line">    <span class="keyword">if</span> (parameters.size() != <span class="number">1</span>) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">&quot;Subscriber method must have exactly 1 parameter&quot;</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>å¿…é¡»ä¸èƒ½æ˜¯é™æ€æ–¹æ³•</li>
<li>å¿…é¡»æ˜¯å…¬å¼€æ–¹æ³•</li>
<li>æ–¹æ³•æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå…¥å‚</li>
</ul>
<p><strong>æ³¨æ„è¿™é‡Œæ²¡æœ‰åˆ¤æ–­æ˜¯å¦æ˜¯æ¡¥æ¥æ–¹æ³•å’Œåˆæˆæ–¹æ³•ï¼Œå› ä¸ºæ³¨è§£å¤„ç†å™¨å¤„äºç¼–è¯‘æœŸï¼Œæ¡¥æ¥æ–¹æ³•å’Œåˆæˆæ–¹æ³•åº”è¯¥ç»è¿‡ javac ç¼–è¯‘åæ‰ä¼šæœ‰ã€‚</strong></p>
<p>æœ€åæŠŠç¬¦åˆè®¢é˜…æ–¹æ³•è§„èŒƒçš„æ–¹æ³•æ”¶é›†èµ·æ¥ï¼Œå­˜å‚¨åœ¨ <code>methodsByClass</code> ä¸­ï¼Œ<code>methodsByClass</code> æ˜¯ greenrobot è‡ªå®šä¹‰çš„ï¼Œå…¶å®é™…ç±»å‹æ˜¯ <code>Map&lt;TypeElement, List&lt;ExecutableElement&gt;&gt;</code>ï¼Œä»¥è®¢é˜…è€…ä¸º Keyï¼Œè®¢é˜…è€…ä¸­çš„è®¢é˜…æ–¹æ³•é›†åˆä¸º Valueã€‚</p>
<h3 id="checkforsubscriberstoskip"><a class="markdownIt-Anchor" href="#checkforsubscriberstoskip"></a> checkForSubscribersToSkip</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkForSubscribersToSkip</span><span class="params">(Messager messager, String myPackage)</span> &#123;</span><br><span class="line">    <span class="comment">// éå† è®¢é˜…è€…</span></span><br><span class="line">    <span class="keyword">for</span> (TypeElement skipCandidate : methodsByClass.keySet()) &#123;</span><br><span class="line">        <span class="type">TypeElement</span> <span class="variable">subscriberClass</span> <span class="operator">=</span> skipCandidate;</span><br><span class="line">        <span class="comment">// å¾ªç¯åˆ¤æ–­è®¢é˜…è€…åŠå…¶çˆ¶ç±»</span></span><br><span class="line">        <span class="keyword">while</span> (subscriberClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­è®¢é˜…è€…æ˜¯å¦å¯è§</span></span><br><span class="line">            <span class="keyword">if</span> (!isVisible(myPackage, subscriberClass)) &#123;</span><br><span class="line">                <span class="comment">// è‹¥ä¸å¯è§ï¼Œåˆ™æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆï¼Œé€€å‡º while å¾ªç¯</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">added</span> <span class="operator">=</span> classesToSkip.add(skipCandidate);</span><br><span class="line">                <span class="keyword">if</span> (added) &#123;</span><br><span class="line">                    String msg;</span><br><span class="line">                    <span class="keyword">if</span> (subscriberClass.equals(skipCandidate)) &#123;</span><br><span class="line">                        msg = <span class="string">&quot;Falling back to reflection because class is not public&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        msg = <span class="string">&quot;Falling back to reflection because &quot;</span> + skipCandidate +</span><br><span class="line">                            <span class="string">&quot; has a non-public super class&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    messager.printMessage(Diagnostic.Kind.NOTE, msg, subscriberClass);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–è®¢é˜…è€…ä¸­çš„è®¢é˜…æ–¹æ³•é›†åˆ</span></span><br><span class="line">            List&lt;ExecutableElement&gt; methods = methodsByClass.get(subscriberClass);</span><br><span class="line">            <span class="keyword">if</span> (methods != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¾ªç¯åˆ¤æ–­æ˜¯å¦æ ¹æ®è®¢é˜…æ–¹æ³•è·³è¿‡è®¢é˜…è€…</span></span><br><span class="line">                <span class="keyword">for</span> (ExecutableElement method : methods) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">skipReason</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="type">VariableElement</span> <span class="variable">param</span> <span class="operator">=</span> method.getParameters().get(<span class="number">0</span>);</span><br><span class="line">                    <span class="type">TypeMirror</span> <span class="variable">typeMirror</span> <span class="operator">=</span> getParamTypeMirror(param, messager);</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­è®¢é˜…æ–¹æ³•çš„å…¥å‚æ˜¯å¦æ˜¯å£°æ˜ç±»å‹ï¼Œå³ä¸æ˜¯åŸºæœ¬ç±»å‹ï¼›æˆ–è€…æ˜¯å£°æ˜ç±»å‹ä½†ä¸æ˜¯ç±»æˆ–æ¥å£</span></span><br><span class="line">                    <span class="keyword">if</span> (!(typeMirror <span class="keyword">instanceof</span> DeclaredType) ||</span><br><span class="line">                        !(((DeclaredType) typeMirror).asElement() <span class="keyword">instanceof</span> TypeElement)) &#123;</span><br><span class="line">                        skipReason = <span class="string">&quot;event type cannot be processed&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (skipReason == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">TypeElement</span> <span class="variable">eventTypeElement</span> <span class="operator">=</span> (TypeElement) ((DeclaredType) typeMirror).asElement();</span><br><span class="line">                        <span class="comment">// åˆ¤æ–­ Event æ˜¯å¦å¯è§</span></span><br><span class="line">                        <span class="keyword">if</span> (!isVisible(myPackage, eventTypeElement)) &#123;</span><br><span class="line">                            skipReason = <span class="string">&quot;event type is not public&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (skipReason != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆï¼Œé€€å‡º for å¾ªç¯</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">added</span> <span class="operator">=</span> classesToSkip.add(skipCandidate);</span><br><span class="line">                        <span class="keyword">if</span> (added) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Falling back to reflection because &quot;</span> + skipReason;</span><br><span class="line">                            <span class="keyword">if</span> (!subscriberClass.equals(skipCandidate)) &#123;</span><br><span class="line">                                msg += <span class="string">&quot; (found in super class for &quot;</span> + skipCandidate + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            messager.printMessage(Diagnostic.Kind.NOTE, msg, param);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç§»åŠ¨è‡³çˆ¶ç±»</span></span><br><span class="line">            subscriberClass = getSuperclass(subscriberClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè°ƒç”¨ <code>isVisible</code> æ–¹æ³•åˆ¤æ–­è®¢é˜…è€…æ˜¯å¦å¯è§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isVisible</span><span class="params">(String myPackage, TypeElement typeElement)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æè¿°ç¬¦é›†åˆ</span></span><br><span class="line">    Set&lt;Modifier&gt; modifiers = typeElement.getModifiers();</span><br><span class="line">    <span class="type">boolean</span> visible;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ PUBLIC</span></span><br><span class="line">    <span class="keyword">if</span> (modifiers.contains(Modifier.PUBLIC)) &#123;</span><br><span class="line">        visible = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ PRIVATE æˆ–è€… PROTECTED</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifiers.contains(Modifier.PRIVATE) || modifiers.contains(Modifier.PROTECTED)) &#123;</span><br><span class="line">        visible = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…¶ä»–æƒ…å†µ</span></span><br><span class="line">        <span class="comment">// è·å–å…ƒç´ çš„åŒ…å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subscriberPackage</span> <span class="operator">=</span> getPackageElement(typeElement).getQualifiedName().toString();</span><br><span class="line">        <span class="comment">// è‹¥ Index ç±»åŒ…åä¸ºç©ºï¼Œåˆ™æ ¹æ®å…ƒç´ åŒ…åçš„é•¿åº¦åˆ¤æ–­ï¼Œå¦åˆ™æ¯”è¾ƒ Index ç±»å’Œå…ƒç´ æ˜¯å¦åœ¨åŒä¸€ä¸ªåŒ…ä¸‹</span></span><br><span class="line">        <span class="keyword">if</span> (myPackage == <span class="literal">null</span>) &#123;</span><br><span class="line">            visible = subscriberPackage.length() == <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            visible = myPackage.equals(subscriberPackage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> visible;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè®¢é˜…è€…ç¬¦åˆä»¥ä¸‹æ¡ä»¶å³è®¤ä¸ºå¯è§ï¼š</p>
<ul>
<li>è®¢é˜…è€…å«æœ‰ public ä¿®é¥°ç¬¦</li>
<li>Index ç±»åŒ…åä¸ºç©ºæ—¶ï¼Œè®¢é˜…è€…åŒ…åé•¿åº¦ä¸º 0ï¼Œ</li>
<li>Index ç±»åŒ…åä¸ä¸ºç©ºï¼Œè®¢é˜…è€…å’Œ Index ç±»åŒå±ä¸€ä¸ªåŒ…ä¸‹</li>
</ul>
<p>å¦‚æœè®¢é˜…è€…ä¸ç¬¦åˆå¯è§æ€§æ¡ä»¶ï¼Œåˆ™æ·»åŠ è¿› <code>classesToSkip</code> é›†åˆï¼Œåç»­ç”Ÿæˆ Index ç±»æ—¶ä¼šå¿½ç•¥æ­¤è¿™äº›è®¢é˜…è€…ã€‚</p>
<p>å¦‚æœè®¢é˜…è€…ç¬¦åˆå¯è§æ€§æ¡ä»¶ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­è®¢é˜…æ–¹æ³•æ˜¯å¦ç¬¦åˆè§„èŒƒï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (ExecutableElement method : methods) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">skipReason</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">VariableElement</span> <span class="variable">param</span> <span class="operator">=</span> method.getParameters().get(<span class="number">0</span>);</span><br><span class="line">    <span class="type">TypeMirror</span> <span class="variable">typeMirror</span> <span class="operator">=</span> getParamTypeMirror(param, messager);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è®¢é˜…æ–¹æ³•çš„å…¥å‚æ˜¯å¦æ˜¯å£°æ˜ç±»å‹ï¼Œå³ä¸æ˜¯åŸºæœ¬ç±»å‹ï¼›æˆ–è€…æ˜¯å£°æ˜ç±»å‹ä½†ä¸æ˜¯ç±»æˆ–æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (!(typeMirror <span class="keyword">instanceof</span> DeclaredType) ||</span><br><span class="line">        !(((DeclaredType) typeMirror).asElement() <span class="keyword">instanceof</span> TypeElement)) &#123;</span><br><span class="line">        skipReason = <span class="string">&quot;event type cannot be processed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (skipReason == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">TypeElement</span> <span class="variable">eventTypeElement</span> <span class="operator">=</span> (TypeElement) ((DeclaredType) typeMirror).asElement();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ Event æ˜¯å¦å¯è§</span></span><br><span class="line">        <span class="keyword">if</span> (!isVisible(myPackage, eventTypeElement)) &#123;</span><br><span class="line">            skipReason = <span class="string">&quot;event type is not public&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (skipReason != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆï¼Œé€€å‡º for å¾ªç¯</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">added</span> <span class="operator">=</span> classesToSkip.add(skipCandidate);</span><br><span class="line">        <span class="keyword">if</span> (added) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Falling back to reflection because &quot;</span> + skipReason;</span><br><span class="line">            <span class="keyword">if</span> (!subscriberClass.equals(skipCandidate)) &#123;</span><br><span class="line">                msg += <span class="string">&quot; (found in super class for &quot;</span> + skipCandidate + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.NOTE, msg, param);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå†è®¢é˜…æ–¹æ³•ï¼Œåˆ¤æ–­è®¢é˜…æ–¹æ³•çš„å…¥å‚å¦‚æœä¸æ˜¯å£°æ˜ç±»å‹ï¼Œå³ä¸æ˜¯åŸºæœ¬ç±»å‹ï¼›æˆ–è€…å…¥å‚æ˜¯å£°æ˜ç±»å‹ä½†ä¸æ˜¯ç±»æˆ–æ¥å£ï¼Œåˆ™å°†è®¢é˜…è€…æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆå¹¶é€€å‡º for å¾ªç¯ï¼Œå¦åˆ™å†åˆ¤æ–­å…¥å‚æ˜¯å¦å¯è§ï¼Œè‹¥æ˜¯ä¸å¯è§ï¼Œåˆ™å°†è®¢é˜…è€…æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆå¹¶é€€å‡º for å¾ªç¯ã€‚</p>
<p>æœ€åè·å–å½“å‰è®¢é˜…è€…çš„çˆ¶ç±»ï¼Œå¾ªç¯åˆ¤æ–­çˆ¶ç±»æ˜¯å¦ä¹Ÿç¬¦åˆä»¥ä¸Šè§„èŒƒï¼Œè‹¥æ˜¯çˆ¶ç±»ä¸ç¬¦åˆä»¥ä¸Šè§„èŒƒï¼Œåˆ™å°†å½“å‰è®¢é˜…è€…æ·»åŠ è¿›è·³è¿‡è®¢é˜…è€…é›†åˆå¹¶é€€å‡º for å¾ªç¯ã€‚</p>
<h3 id="createinfoindexfile"><a class="markdownIt-Anchor" href="#createinfoindexfile"></a> createInfoIndexFile</h3>
<p>æ”¶é›†å’Œè¿‡æ»¤å®Œè®¢é˜…è€…åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç”Ÿæˆ Index ç±»äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createInfoIndexFile</span><span class="params">(String index)</span> &#123;</span><br><span class="line">    <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JavaFileObject</span> <span class="variable">sourceFile</span> <span class="operator">=</span> processingEnv.getFiler().createSourceFile(index);</span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> index.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">myPackage</span> <span class="operator">=</span> period &gt; <span class="number">0</span> ? index.substring(<span class="number">0</span>, period) : <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clazz</span> <span class="operator">=</span> index.substring(period + <span class="number">1</span>);</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(sourceFile.openWriter());</span><br><span class="line">        <span class="comment">// åŒ…åä¸ä¸ºç©ºï¼Œå†™å…¥åŒ…å</span></span><br><span class="line">        <span class="keyword">if</span> (myPackage != <span class="literal">null</span>) &#123;</span><br><span class="line">            writer.write(<span class="string">&quot;package &quot;</span> + myPackage + <span class="string">&quot;;\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¼åŒ…</span></span><br><span class="line">        writer.write(<span class="string">&quot;import com.yarward.org.greenrobot.eventbus.meta.SimpleSubscriberInfo;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import com.yarward.org.greenrobot.eventbus.meta.SubscriberMethodInfo;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import com.yarward.org.greenrobot.eventbus.meta.SubscriberInfo;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import com.yarward.org.greenrobot.eventbus.meta.SubscriberInfoIndex;\n\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import com.yarward.org.greenrobot.eventbus.ThreadMode;\n\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import java.util.HashMap;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;import java.util.Map;\n\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;/** This class is generated by EventBus, do not edit. */\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç±»å£°æ˜ï¼Œå®ç° `SubscriberInfoIndex` æ¥å£</span></span><br><span class="line">        writer.write(<span class="string">&quot;public class &quot;</span> + clazz + <span class="string">&quot; implements SubscriberInfoIndex &#123;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é™æ€å­—æ®µå£°æ˜</span></span><br><span class="line">        writer.write(<span class="string">&quot;    private static final Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;\n\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é™æ€ä»£ç å—</span></span><br><span class="line">        writer.write(<span class="string">&quot;    static &#123;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        SUBSCRIBER_INDEX = new HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();\n\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†™å…¥ Index</span></span><br><span class="line">        writeIndexLines(writer, myPackage);</span><br><span class="line">        writer.write(<span class="string">&quot;    &#125;\n\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line">        writer.write(<span class="string">&quot;    private static void putIndex(SubscriberInfo info) &#123;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;    &#125;\n\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®ç° `SubscriberInfoIndex` æ¥å£æ–¹æ³•</span></span><br><span class="line">        writer.write(<span class="string">&quot;    @Override\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;    public SubscriberInfo getSubscriberInfo(Class&lt;?&gt; subscriberClass) &#123;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        if (info != null) &#123;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;            return info;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        &#125; else &#123;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;            return null;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;        &#125;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;    &#125;\n&quot;</span>);</span><br><span class="line">        writer.write(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Could not write source for &quot;</span> + index, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">//Silent</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createInfoIndexFile</code> æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯æ¨¡æ¿ä»£ç ï¼Œç”Ÿæˆ Index çš„é€»è¾‘ä¸»è¦åœ¨ <code>writeIndexLines</code> ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeIndexLines</span><span class="params">(BufferedWriter writer, String myPackage)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// éå†è®¢é˜…è€…</span></span><br><span class="line">    <span class="keyword">for</span> (TypeElement subscriberTypeElement : methodsByClass.keySet()) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦å¿½ç•¥å½“å‰è®¢é˜…è€…</span></span><br><span class="line">        <span class="keyword">if</span> (classesToSkip.contains(subscriberTypeElement)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–è®¢é˜…è€…ç±»åï¼Œæ˜¯å†…éƒ¨ç±»æ—¶åŒ…å«å¤–éƒ¨ç±»çš„ç±»å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subscriberClass</span> <span class="operator">=</span> getClassString(subscriberTypeElement, myPackage);</span><br><span class="line">        <span class="comment">// å†æ¬¡åˆ¤æ–­è®¢é˜…è€…æ˜¯å¦å¯è§</span></span><br><span class="line">        <span class="keyword">if</span> (isVisible(myPackage, subscriberTypeElement)) &#123;</span><br><span class="line">            writeLine(writer, <span class="number">2</span>,</span><br><span class="line">                      <span class="string">&quot;putIndex(new SimpleSubscriberInfo(&quot;</span> + subscriberClass + <span class="string">&quot;.class,&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;true,&quot;</span>, <span class="string">&quot;new SubscriberMethodInfo[] &#123;&quot;</span>);</span><br><span class="line">            <span class="comment">// è·å–å½“å‰è®¢é˜…è€…ä¸­è®¢é˜…æ–¹æ³•é›†åˆ</span></span><br><span class="line">            List&lt;ExecutableElement&gt; methods = methodsByClass.get(subscriberTypeElement);</span><br><span class="line">            <span class="comment">// ç”Ÿæˆè®¢é˜…æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">            writeCreateSubscriberMethods(writer, methods, <span class="string">&quot;new SubscriberMethodInfo&quot;</span>, myPackage);</span><br><span class="line">            writer.write(<span class="string">&quot;        &#125;));\n\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writer.write(<span class="string">&quot;        // Subscriber not visible to index: &quot;</span> + subscriberClass + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>writeIndexLines</code> æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œéå†ä¹‹å‰æ”¶é›†çš„è®¢é˜…è€…é›†åˆï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¿½ç•¥å½“å‰è®¢é˜…è€…ï¼Œéšåè·å–è®¢é˜…è€…ç±»åï¼Œå¦‚æœæ˜¯å†…éƒ¨ç±»åˆ™åŒ…å«å¤–éƒ¨ç±»çš„ç±»åï¼Œç„¶åå†æ¬¡åˆ¤æ–­å½“å‰è®¢é˜…è€…æ˜¯å¦å¯è§ï¼Œå¦‚æœå¯è§åˆ™ç”Ÿæˆ <code>SimpleSubscriberInfo</code> å¯¹è±¡æ·»åŠ è¿› Indexã€‚</p>
<p><code>SimpleSubscriberInfo</code> æ˜¯ Index å…ƒç´ ï¼Œå…¶æ„é€ æ–¹æ³•æœ‰ä¸‰ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ï¼šè®¢é˜…è€… Class å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå…¥å‚æ˜¯ï¼šæ˜¯å¦æ£€æŸ¥çˆ¶ç±»ï¼Œé»˜è®¤ä¸º trueï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ï¼šè®¢é˜…æ–¹æ³•ä¿¡æ¯æ•°ç»„ã€‚</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨ <code>writeCreateSubscriberMethods</code> æ–¹æ³•ç”Ÿæˆè®¢é˜…æ–¹æ³•ä¿¡æ¯ <code>SubscriberMethodInfo</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeCreateSubscriberMethods</span><span class="params">(BufferedWriter writer, List&lt;ExecutableElement&gt; methods,</span></span><br><span class="line"><span class="params">                                          String callPrefix, String myPackage)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// éå†è®¢é˜…æ–¹æ³•é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (ExecutableElement method : methods) &#123;</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">VariableElement</span>&gt; parameters = method.getParameters();</span><br><span class="line">        <span class="type">TypeMirror</span> <span class="variable">paramType</span> <span class="operator">=</span> getParamTypeMirror(parameters.get(<span class="number">0</span>), <span class="literal">null</span>);</span><br><span class="line">        <span class="type">TypeElement</span> <span class="variable">paramElement</span> <span class="operator">=</span> (TypeElement) processingEnv.getTypeUtils().asElement(paramType);</span><br><span class="line">        <span class="comment">// è·å–è®¢é˜…æ–¹æ³•åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getSimpleName().toString();</span><br><span class="line">        <span class="comment">// è·å– Event äº‹ä»¶ Class å¯¹è±¡</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">eventClass</span> <span class="operator">=</span> getClassString(paramElement, myPackage) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– `Subscribe` æ³¨è§£</span></span><br><span class="line">        <span class="type">Subscribe</span> <span class="variable">subscribe</span> <span class="operator">=</span> method.getAnnotation(Subscribe.class);</span><br><span class="line">        List&lt;String&gt; parts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        parts.add(callPrefix + <span class="string">&quot;(\&quot;&quot;</span> + methodName + <span class="string">&quot;\&quot;,&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lineEnd</span> <span class="operator">=</span> <span class="string">&quot;),&quot;</span>;</span><br><span class="line">        <span class="comment">// è·å– `Subscribe` æ³¨è§£çš„å‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°ç”Ÿæˆ `SubscriberMethodInfo` çš„å…¥å‚</span></span><br><span class="line">        <span class="keyword">if</span> (subscribe.priority() == <span class="number">0</span> &amp;&amp; !subscribe.sticky()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (subscribe.threadMode() == ThreadMode.POSTING) &#123;</span><br><span class="line">                parts.add(eventClass + lineEnd);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parts.add(eventClass + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">                parts.add(<span class="string">&quot;ThreadMode.&quot;</span> + subscribe.threadMode().name() + lineEnd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parts.add(eventClass + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            parts.add(<span class="string">&quot;ThreadMode.&quot;</span> + subscribe.threadMode().name() + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            parts.add(subscribe.priority() + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="comment">// æ­¤å¤„æ˜¯ç¬”è€…å¯¹å¿…è¾¾äº‹ä»¶çš„å¤„ç†</span></span><br><span class="line">            <span class="comment">// begin - æ·»åŠ å¿…è¾¾äº‹ä»¶</span></span><br><span class="line">            parts.add(subscribe.sticky() + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            parts.add(subscribe.rendezvous() + lineEnd);</span><br><span class="line">            <span class="comment">// end - æ·»åŠ å¿…è¾¾äº‹ä»¶</span></span><br><span class="line">        &#125;</span><br><span class="line">        writeLine(writer, <span class="number">3</span>, parts.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[parts.size()]));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">            processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, <span class="string">&quot;Indexed @Subscribe at &quot;</span> +</span><br><span class="line">                                                     method.getEnclosingElement().getSimpleName() + <span class="string">&quot;.&quot;</span> + methodName +</span><br><span class="line">                                                     <span class="string">&quot;(&quot;</span> + paramElement.getSimpleName() + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå†å½“å‰è®¢é˜…è€…ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•ï¼Œé¦–å…ˆè®¢é˜…æ–¹æ³•çš„åç§°ï¼Œå…¥å‚ Event äº‹ä»¶çš„ Class å¯¹è±¡ï¼Œç„¶åè·å– <code>@Subscribe</code> æ³¨è§£çš„å‚æ•°ï¼Œå¹¶æ ¹æ®æ³¨è§£çš„å‚æ•°ç”Ÿæˆ <code>SubscriberMethodInfo</code> çš„å…¥å‚ï¼Œ<strong>è¿™é‡Œæœ‰ç¬”è€…å¯¹å¿…è¾¾äº‹ä»¶çš„å¤„ç†(æ³¨æ„ï¼šè¿™é‡Œå¤„ç†æœ‰Bugï¼Œä¸çŸ¥è¯»è€…æœ‰æ²¡æœ‰çœ‹å‡ºæ¥å‘¢ï¼Ÿ)</strong>ï¼Œæœ€åè°ƒç”¨ <code>writeLine</code> å®Œæ•´çš„ç”Ÿæˆ <code>SubscriberMethodInfo</code> æ–¹æ³•ã€‚</p>
<p>è‡³æ­¤ï¼ŒEventBus æ³¨è§£å¤„ç†å™¨çš„æµç¨‹åˆ†æå®Œæ¯•ï¼Œä¸‹é¢æ˜¯ç”Ÿæˆçš„ Index ç±»ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBusTestsIndex</span> <span class="keyword">implements</span> <span class="title class_">SubscriberInfoIndex</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Class&lt;?&gt;, SubscriberInfo&gt;();</span><br><span class="line"></span><br><span class="line">        putIndex(<span class="keyword">new</span> <span class="title class_">SimpleSubscriberInfo</span>(EventBusMainThreadTest.class, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">SubscriberMethodInfo</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SubscriberMethodInfo</span>(<span class="string">&quot;onEventMainThread&quot;</span>, String.class, ThreadMode.MAIN),</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">putIndex</span><span class="params">(SubscriberInfo info)</span> &#123;</span><br><span class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubscriberInfo <span class="title function_">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> &#123;</span><br><span class="line">        <span class="type">SubscriberInfo</span> <span class="variable">info</span> <span class="operator">=</span> SUBSCRIBER_INDEX.get(subscriberClass);</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> info;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<ul>
<li>åœ¨ç¬¬ä¸€ç¯‡ <a href="https://juejin.cn/post/7104107150678917133">Android-EventBusä¿®æ”¹çºªå®</a> æ–‡ç« ä¸­ç¬”è€…è®°å½•äº†ä¸º EventBus å¢åŠ  <strong>å¿…è¾¾äº‹ä»¶</strong> çš„è¿‡ç¨‹ï¼Œ</li>
<li>åœ¨ç¬¬äºŒç¯‡ <a href="https://juejin.cn/post/7104536485428199437">Android-EventBusä¿®æ”¹çºªå®(äºŒ)</a> æ–‡ç« ä¸­ç¬”è€…å¯¹ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æœªå®ç°çš„éƒ¨åˆ†è¿›è¡Œäº†è¡¥å……ï¼Œå¹¶ç®€å•ä»‹ç»äº† EventBus æä¾›çš„çº¿ç¨‹æ¨¡å‹åŠä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼Œ</li>
<li>åœ¨ç¬¬ä¸‰ç¯‡ <a href="https://juejin.cn/post/7104912340851621901">Android-EventBusä¿®æ”¹çºªå®(ä¸‰)</a> æ–‡ç« ä¸­ç¬”è€…è¯¦ç»†åˆ†æäº† EventBus çš„çº¿ç¨‹è°ƒåº¦è¿‡ç¨‹åŠä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼Œ</li>
<li>åœ¨ç¬¬å››ç¯‡æ–‡ç« ä¸­ç¬”è€…è¯¦ç»†åˆ†æäº† EventBus æ³¨è§£å¤„ç†å™¨ç”Ÿæˆ Index ç±»çš„æµç¨‹ï¼Œç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ·»åŠ  <strong>å¿…è¾¾äº‹ä»¶</strong> æ—¶æ²¡æœ‰ä¿®æ”¹æ³¨è§£å¤„ç†å™¨ï¼Œåœ¨æœ¬æ–‡ä¸­ä¹Ÿè¿›è¡Œäº†ç®€å•çš„æè¿°ã€‚</li>
</ul>
<p>æœ¬æ–‡åˆ†æè®¢é˜…è€…æ˜¯å¦ç¬¦åˆè§„èŒƒæ—¶ï¼Œæœ‰ä¸€å¤„æ ¹æ®è®¢é˜…æ–¹æ³•æ£€æŸ¥è¿‡æ»¤è®¢é˜…è€…ï¼Œå¦‚æœè®¢é˜…è€…ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•ä¸ç¬¦åˆè§„èŒƒï¼Œæ•´ä¸ªè®¢é˜…è€…éƒ½è¦è·³è¿‡ï¼Œè¿™é‡Œä½ è®¤ä¸ºæ˜¯å¦åˆç†å‘¢ï¼Ÿ</p>
<p>å¤§å®¶æ±‚åŒå­˜å¼‚ï¼Œæ¬¢è¿äº¤æµã€‚</p>
<p>happy~ï¼Œå¸Œæœ›å¯ä»¥å¸®ä½ æ›´å¥½çš„ä½¿ç”¨ EventBus</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>eventbus</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-WebViewè½¯é”®ç›˜é®æŒ¡è¾“å…¥æ¡†ä¼˜åŒ–çºªå®</title>
    <url>/2022/06/05/Android/Android-WebView%E8%BD%AF%E9%94%AE%E7%9B%98%E9%81%AE%E6%8C%A1%E8%BE%93%E5%85%A5%E6%A1%86%E4%BC%98%E5%8C%96%E7%BA%AA%E5%AE%9E/</url>
    <content><![CDATA[<h1 id="android-webviewè½¯é”®ç›˜é®æŒ¡è¾“å…¥æ¡†ä¼˜åŒ–çºªå®"><a class="markdownIt-Anchor" href="#android-webviewè½¯é”®ç›˜é®æŒ¡è¾“å…¥æ¡†ä¼˜åŒ–çºªå®"></a> Android-WebViewè½¯é”®ç›˜é®æŒ¡è¾“å…¥æ¡†ä¼˜åŒ–çºªå®</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 7 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>ç¬”è€…åœ¨ä½¿ç”¨ WebView åŠ è½½å«æœ‰è¾“å…¥æ¡†çš„ H5 é¡µé¢æ—¶ï¼Œç‚¹å‡»è¾“å…¥æ¡†åï¼Œè¾“å…¥æ¡†ä¼šè¢«è½¯é”®ç›˜é®æŒ¡ä½ï¼Œæ— æ³•çœ‹åˆ°è¾“å…¥çš„å†…å®¹ï¼Œè¿™å¾ˆå½±å“ç”¨æˆ·ä½“éªŒã€‚</p>
<p>ç¬”è€…æƒ³ç€è¿™ç§ä¸šåŠ¡åœºæ™¯æ¯”è¾ƒå¸¸è§ï¼Œé‚ä¸Šç½‘æœç´¢ä¸€ç•ªï¼Œæœä¸å…¶ç„¶ï¼Œæœ‰ä¸å°‘åŒå¿—é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæƒ³æ¥è¿™ä¸ªé—®é¢˜å¾ˆå¥½è§£å†³äº†ã€‚ç¬”è€…ä¸€ä¸€å°è¯•äº†åŒå¿—ä»¬æä¾›çš„è§£å†³æ–¹æ¡ˆï¼Œç»“æœè¦ä¸æ˜¯æ²¡æœ‰ä½œç”¨ï¼Œè¦ä¸æ˜¯æ•ˆæœä¸å¤ªæ»¡æ„ï¼Œåªå¥½è‡ªå·±å¦è¾Ÿè¹Šå¾„äº†ã€‚</p>
<p><strong>æ³¨ï¼šåœ¨ç¬”è€…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼ŒAppæ˜¯å…¨å±çš„ï¼Œå³æ²¡æœ‰é¡¶éƒ¨çš„ç³»ç»Ÿæ ï¼Œä¹Ÿæ²¡æœ‰åº•éƒ¨çš„å¯¼èˆªæ ï¼Œæ‰€ä»¥ç¬”è€…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯èƒ½ä¸é€‚ç”¨äºå…¶ä»–åœºæ™¯ã€‚</strong></p>
<h2 id="çºªå®"><a class="markdownIt-Anchor" href="#çºªå®"></a> çºªå®</h2>
<h3 id="æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆ"></a> æ–¹æ¡ˆ</h3>
<p>å¥½çš„ï¼Œé‡æ–°æ¢³ç†ä¸‹é‡åˆ°çš„é—®é¢˜ï¼Œç›®å‰çš„é—®é¢˜æ˜¯ï¼š<strong>ç”¨æˆ·æ— æ³•çœ‹åˆ°è¾“å…¥æ¡†é‡Œçš„å†…å®¹</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆè®©ç”¨æˆ·çœ‹åˆ°è¾“å…¥æ¡†é‡Œçš„å†…å®¹ã€‚</p>
<p>ç¬”è€…æƒ³åˆ°äº†ç¬¬ä¸€ç§æ–¹æ¡ˆï¼š**è¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡åï¼Œåœ¨è½¯é”®ç›˜è¾“å…¥æ—¶ï¼Œå¯ä»¥åœ¨ H5 é¡µé¢é¡¶éƒ¨å®æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†é‡Œçš„å†…å®¹ã€‚**æœ¬æ–¹æ¡ˆè§£å†³äº†è¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡åçœ‹ä¸åˆ°è¾“å…¥å†…å®¹çš„é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³è¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡çš„é—®é¢˜ï¼Œæ­¤æ–¹æ¡ˆä¸€å®šç¨‹åº¦ä¸Šæå‡äº†ç”¨æˆ·ä½“éªŒï¼Œä¸è¿‡ç¬”è€…è®¤ä¸ºæœ¬æ–¹æ¡ˆä¸æ˜¯å¾ˆå®Œç¾ï¼Œç»§ç»­æ€è€ƒå…¶ä»–æ–¹æ¡ˆã€‚</p>
<p>æœ€åç¬”è€…æƒ³åˆ°äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¬”è€…çš„ä¸šåŠ¡åœºæ™¯ï¼ŒAppæ˜¯å…¨å±çš„ï¼Œæ‰€ä»¥æ•´ä¸ª WebView ä¹Ÿæ˜¯å…¨å±çš„ï¼Œ</li>
<li>åœ¨ç‚¹å‡» H5 é¡µé¢çš„è¾“å…¥æ¡†æ—¶ï¼ŒH5 è·å–å½“å‰è¾“å…¥æ¡†å·¦ä¸‹è§’çš„ Y åæ ‡ï¼Œç„¶åæŠŠå·¦ä¸‹è§’çš„ Y åæ ‡é€šçŸ¥åˆ° Android åŸç”Ÿï¼Œ</li>
<li>Android åŸç”Ÿè·å–è½¯é”®ç›˜é¡¶éƒ¨çš„ Y åæ ‡ä¸è¾“å…¥æ¡†å·¦ä¸‹è§’çš„ Y åæ ‡è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå°äºå·¦ä¸‹è§’çš„ Y åæ ‡ï¼Œåˆ™è®¤ä¸ºæ­¤æ—¶è¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡ï¼Œéœ€è¦å°† WebView å‘ä¸Šæ»šåŠ¨ç›¸åº”çš„è·ç¦»ä»¥æ˜¾ç¤ºå‡ºæ¥è¾“å…¥æ¡†ï¼Œå¦åˆ™åˆ¤æ–­ WebView å½“å‰çš„æ»šåŠ¨è·ç¦»æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸ä¸º 0 åˆ™å–å½“å‰è·ç¦»çš„è´Ÿå€¼ä½œä¸ºæ»šåŠ¨è·ç¦»ï¼Œå¦åˆ™å°±ä¸æ»šåŠ¨ã€‚</li>
</ol>
<p>ä¸Šè¿°æ–¹æ¡ˆçš„æ–‡å­—æè¿°å¯èƒ½æ¯”è¾ƒç»•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢çš„æµç¨‹å›¾è·Ÿä¸Šæ€è·¯ï¼š</p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202206052140191.png" alt="image-20220605214012705" /></p>
<h3 id="å®ç°"><a class="markdownIt-Anchor" href="#å®ç°"></a> å®ç°</h3>
<p>æ¥ä¸‹æ¥ç¬”è€…æ ¹æ®ä¸Šé¢çš„æ–¹æ¡ˆäºŒè¿›è¡Œä»£ç ä¸Šçš„å…·ä½“å®ç°ï¼š</p>
<p>é¦–å…ˆæ˜¯è·å–è¾“å…¥æ¡†å·¦ä¸‹è§’çš„ Y åæ ‡ï¼Œè¿™ä¸€æ­¥å¦‚æœè®©å‰ç«¯æ¥å®ç°çš„è¯ï¼Œæ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œä¸è¿‡ç¬”è€…è®¤ä¸ºæ–¹æ¡ˆäºŒæ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥æå–å‡ºæ¥ä½œä¸ºäºŒæ–¹åº“æ¥ä½¿ç”¨ï¼Œå¦‚æœè®©å…¶ä»–ä½¿ç”¨äºŒæ–¹åº“é¡¹ç›®ç»„çš„å‰ç«¯åŒå¿—ä¹Ÿæ¥å®ç°ä¸€æ¬¡çš„è¯å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€æ­¥ï¼Œç¬”è€…é€‰æ‹©äº†åœ¨ Android ç«¯æ³¨å…¥ JS çš„æ–¹æ¡ˆï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">ready</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;readystatechange&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> readyState = <span class="variable language_">document</span>.<span class="property">readyState</span>;</span><br><span class="line">    <span class="keyword">if</span> (readyState !== <span class="string">&quot;loading&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(readyState);</span><br><span class="line">        <span class="title function_">ready</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">ready</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ready</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMNodeInserted&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">webInput</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">webInput</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">webInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> input = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;input&quot;</span>) || [];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;input -&gt; &quot;</span> + input.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    input.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> type = value.<span class="title function_">getAttribute</span>(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;type -&gt; &quot;</span> + type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type === <span class="literal">null</span></span><br><span class="line">            || type === <span class="string">&quot;number&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;search&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;password&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;tel&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;email&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;url&quot;</span></span><br><span class="line">            || type === <span class="string">&quot;text&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            value.<span class="title function_">removeEventListener</span>(<span class="string">&quot;click&quot;</span>, webInput2Android);</span><br><span class="line"></span><br><span class="line">            value.<span class="title function_">removeEventListener</span>(<span class="string">&quot;focus&quot;</span>, webInput2Android);</span><br><span class="line"></span><br><span class="line">            value.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, webInput2Android);</span><br><span class="line"></span><br><span class="line">            value.<span class="title function_">addEventListener</span>(<span class="string">&quot;focus&quot;</span>, webInput2Android);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">webInput2Android</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;webInput2Android&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> offset = <span class="title function_">getOffset</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">var</span> x = offset.<span class="property">x</span>;</span><br><span class="line">    <span class="keyword">var</span> y = offset.<span class="property">y</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;x:y --&gt; &quot;</span> + x + <span class="string">&quot;:&quot;</span> + y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> width = <span class="variable language_">this</span>.<span class="property">offsetWidth</span>;</span><br><span class="line">    <span class="keyword">var</span> height = <span class="variable language_">this</span>.<span class="property">offsetHeight</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;w:h --&gt; &quot;</span> + width + <span class="string">&quot;:&quot;</span> + height);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Send to Android</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getOffset</span> (el) &#123;</span><br><span class="line">    <span class="keyword">var</span> box = el.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">x</span>: box.<span class="property">left</span> + <span class="variable language_">window</span>.<span class="property">pageXOffset</span> - <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientLeft</span>,</span><br><span class="line">        <span class="attr">y</span>: box.<span class="property">top</span> + <span class="variable language_">window</span>.<span class="property">pageYOffset</span> - <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientTop</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ JS ä¸­é€šè¿‡ç›‘å¬è¾“å…¥æ¡†çš„ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ç‚¹å‡»æ—¶è·å–è¾“å…¥æ¡†å·¦ä¸Šè§’çš„åæ ‡å’Œè¾“å…¥æ¡†çš„å®½é«˜ï¼Œé—´æ¥ç®—å‡ºè¾“å…¥æ¡†å·¦ä¸‹è§’çš„åæ ‡ï¼Œç„¶åé€šçŸ¥åˆ° Android åŸç”Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> mActivityReference.get();</span><br><span class="line">    <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> mWebViewReference.get();</span><br><span class="line">    <span class="keyword">if</span> (activity == <span class="literal">null</span> || webView == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JS ä¼ å…¥çš„è¾“å…¥æ¡†å·¦ä¸‹è§’ Y åæ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">bottom</span> <span class="operator">=</span> mWebInput.getBottom();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–è½¯é”®ç›˜é¡¶éƒ¨çš„ Y åæ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">keyboardTop</span> <span class="operator">=</span> KeyboardHelper.getKeyboardTop(activity);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WebView å½“å‰æ»šåŠ¨çš„è·ç¦»</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">scrollY</span> <span class="operator">=</span> webView.getScrollY();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è½¯é”®ç›˜æ˜¯å¦å¼¹å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (keyboardTop != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¾“å…¥æ¡†æ˜¯å¦è¢«è½¯é”®ç›˜é®æŒ¡</span></span><br><span class="line">        <span class="keyword">if</span> (bottom &gt;= keyboardTop) &#123;</span><br><span class="line">            <span class="comment">// è®¡ç®—æ»šåŠ¨è·ç¦»</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">diff</span> <span class="operator">=</span> bottom - keyboardTop - scrollY;</span><br><span class="line">            <span class="comment">// æ»šåŠ¨ WebView diff + mDistance è·ç¦»ï¼ŒmDistance é»˜è®¤ 50ï¼Œ</span></span><br><span class="line">            <span class="comment">// diff + mDistanceï¼šå³è½¯é”®ç›˜è·ç¦»è¾“å…¥æ¡†åº•éƒ¨ 50 è·ç¦» </span></span><br><span class="line">            webView.assistWebKeyboard(scrollY, diff + mDistance);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ WebView æ˜¯å¦æœ‰æ»šåŠ¨</span></span><br><span class="line">            <span class="keyword">if</span> (scrollY != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ»šåŠ¨ WebView</span></span><br><span class="line">                webView.assistWebKeyboard(scrollY, -scrollY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç å®ç°æ–¹æ¡ˆäºŒä¸­ç¬¬ä¸‰æ­¥ï¼Œé¦–å…ˆè·å– JS ä¼ å…¥çš„è¾“å…¥æ¡†å·¦ä¸‹è§’ Y åæ ‡ï¼Œå…¶æ¬¡è·å–è½¯é”®ç›˜é¡¶éƒ¨çš„ Y åæ ‡ï¼Œç„¶åè·å– WebView å½“å‰æ»šåŠ¨çš„è·ç¦»ï¼Œæ¥ä¸‹æ¥æ ¹æ®è½¯é”®ç›˜é¡¶éƒ¨çš„ Y åæ ‡åˆ¤æ–­è½¯é”®ç›˜æ˜¯å¦å¼¹å‡ºï¼Œåœ¨è½¯é”®ç›˜å¼¹å‡ºçš„æƒ…å†µä¸‹ï¼Œåˆ¤æ–­è¾“å…¥æ¡†å·¦ä¸‹è§’ Y åæ ‡æ˜¯å¦å¤§äºç­‰äºè½¯é”®ç›˜é¡¶éƒ¨ Y åæ ‡ï¼š</p>
<ol>
<li>å¦‚æœå¤§äºç­‰äºï¼Œåˆ™è®¤ä¸ºè¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡ï¼Œæ­¤æ—¶è®¡ç®—å‡º WebView éœ€è¦æ»šåŠ¨å¤šé•¿çš„è·ç¦»ï¼Œè¾“å…¥æ¡†æ‰èƒ½è¢«æ˜¾ç¤ºå‡ºæ¥ï¼Œæœ€åè°ƒç”¨ <code>assistWebKeyboard</code> æ–¹æ³•æ»šåŠ¨ WebView</li>
<li>å¦‚æœå°äºï¼Œåˆ™è®¤ä¸ºè¾“å…¥æ¡†æ²¡æœ‰è¢«è½¯é”®ç›˜é®æŒ¡ï¼Œæ­¤æ—¶åˆ¤å®š WebView ä¹‹å‰æ˜¯å¦æœ‰æ»šåŠ¨ï¼Œå¦‚æœæœ‰æ»šåŠ¨è·ç¦»ï¼Œåˆ™è®¡ç®—æ»šåŠ¨è·ç¦»ä¸ºå½“å‰æ»šåŠ¨è·ç¦»çš„è´Ÿå€¼ï¼Œæœ€åè°ƒç”¨ <code>assistWebKeyboard</code> æ–¹æ³•æ»šåŠ¨ WebView</li>
</ol>
<p>è‡³æ­¤å®Œç»“ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡æä¾›äº†ä¸€ç§æ–°çš„è§£å†³ WebView è¾“å…¥æ¡†è¢«è½¯é”®ç›˜é®æŒ¡çš„æ€è·¯ï¼Œä¸è¿‡è¿™ç§æ€è·¯ä¹Ÿæœ‰å®ƒçš„å±€é™æ€§ï¼Œç›®å‰æ¥çœ‹ä»…é€‚ç”¨äºå…¨å±çš„ WebView ä¸­ï¼Œåç»­ç¬”è€…å†æƒ³åˆ°å…¶ä»–æ–¹æ¡ˆæ—¶ï¼Œå¦å†™ä¸€ç¯‡çºªå®ç»­é›†å§ã€‚</p>
<p>æœŸå¾…ä¸å„ä½åŒå¿—äº¤æµæ–¹æ¡ˆä¸æ€è·¯ğŸ˜€</p>
<p>happyï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ~</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>webview</tag>
        <tag>è½¯é”®ç›˜</tag>
      </tags>
  </entry>
  <entry>
    <title>Git-ç¬¬ä¸€ç¯‡</title>
    <url>/2022/07/19/Git/Git-%E7%AC%AC%E4%B8%80%E7%AF%87/</url>
    <content><![CDATA[<h1 id="git-ç¬¬ä¸€ç¯‡"><a class="markdownIt-Anchor" href="#git-ç¬¬ä¸€ç¯‡"></a> Git-ç¬¬ä¸€ç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>Gitå­¦ä¹ ç³»åˆ—æ–‡ç« æœ¬ç€é‡å­¦Gitç›®çš„ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£<a href="https://git-scm.com/book/zh/v2">Git - Book (git-scm.com)</a>åŠå‰äººçš„ç»éªŒï¼Œç»“åˆä¸ªäººåœ¨ä½¿ç”¨Gitè¿‡ç¨‹ä¸­çš„ä¸€äº›æ„Ÿæ‚Ÿ</p>
<p>æœ¬ç³»åˆ—æ–‡ç« éšå¿ƒæ‰€æ¬²ï¼Œå¯èƒ½åˆšå¼€å§‹è¿˜æœ‰ç« å¯å¾ªï¼Œåç»­å¯èƒ½å°±è®°å½•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</p>
<h2 id="èµ·æ­¥"><a class="markdownIt-Anchor" href="#èµ·æ­¥"></a> èµ·æ­¥</h2>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>Git-.gitç›®å½•æ¢ç§˜</title>
    <url>/2022/07/19/Git/Git-.git%E7%9B%AE%E5%BD%95%E6%8E%A2%E7%A7%98/</url>
    <content><![CDATA[<h1 id="git-gitç›®å½•æ¢ç§˜"><a class="markdownIt-Anchor" href="#git-gitç›®å½•æ¢ç§˜"></a> Git-.gitç›®å½•æ¢ç§˜</h1>
<hr />
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹-Androidçš„UIæ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„ï¼Ÿ</title>
    <url>/2022/05/18/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-Android%E7%9A%84UI%E6%A1%86%E6%9E%B6%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84/</url>
    <content><![CDATA[<h1 id="javaå¹¶å‘ç¼–ç¨‹-androidçš„uiæ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„"><a class="markdownIt-Anchor" href="#javaå¹¶å‘ç¼–ç¨‹-androidçš„uiæ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„"></a> Javaå¹¶å‘ç¼–ç¨‹-Androidçš„UIæ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„ï¼Ÿ</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒAndroid ä¼šåœ¨ <code>ViewRootImpl</code> ä¸­è°ƒç”¨ <code>checkThread</code> æ–¹æ³•æ£€æµ‹æ˜¯å¦æ˜¯åœ¨ UI çº¿ç¨‹ä¸­æ›´æ–° UI</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ViewRootImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Thread mThread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display)</span> &#123;</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">checkThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CalledFromWrongThreadException</span>(</span><br><span class="line">            <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆ Android åªèƒ½åœ¨ UI çº¿ç¨‹ä¸­æ›´æ–° UIï¼Œä¸èƒ½åœ¨å­çº¿ç¨‹ä¸­æ›´æ–° UI<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼ŸAndroid ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹æ›´æ–° UIå‘¢ï¼Ÿ</p>
<h2 id="gui-æ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„"><a class="markdownIt-Anchor" href="#gui-æ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„"></a> GUI æ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></h2>
<blockquote>
<p>æ—©æœŸçš„ GUI åº”ç”¨ç¨‹åºéƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œå¹¶ä¸” GUI äº‹ä»¶åœ¨ â€ä¸»äº‹ä»¶å¾ªç¯â€œ ä¸­è¿›è¡Œå¤„ç†ã€‚å½“å‰çš„ GUI æ¡†æ¶åˆ™ä½¿ç”¨äº†ä¸€ç§ç•¥æœ‰ä¸åŒçš„æ¨¡å‹ï¼šåœ¨è¯¥æ¨¡å‹ä¸­åˆ›å»ºä¸€ä¸ªä¸“é—¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼ˆEvent Dispatch Threadï¼ŒEDTï¼‰æ¥å¤„ç† GUI äº‹ä»¶</p>
</blockquote>
<blockquote>
<p>å•çº¿ç¨‹çš„ GUI æ¡†æ¶å¹¶ä¸ä»…é™äºåœ¨ Java ä¸­ï¼Œåœ¨ Qtã€NexiStepã€MacOS Cocoaã€X Windows ä»¥åŠå…¶ä»–ç¯å¢ƒä¸­çš„ GUI æ¡†æ¶éƒ½æ˜¯å•çº¿ç¨‹çš„ã€‚è®¸å¤šäººæ›¾ç»å°è¯•è¿‡ç¼–å†™å¤šçº¿ç¨‹çš„ GUI æ¡†æ¶ï¼Œä½†æœ€ç»ˆéƒ½ç”±äºé™æ€æ¡ä»¶å’Œæ­»é”å¯¼è‡´çš„ç¨³å®šæ€§é—®é¢˜è€Œåˆé‡æ–°å›åˆ°å•çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—æ¨¡å‹ï¼šé‡‡ç”¨ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­æŠ½å–äº‹ä»¶ï¼Œå¹¶å°†å®ƒä»¬è½¬å‘åˆ°åº”ç”¨ç¨‹åºå®šä¹‰çš„äº‹ä»¶å¤„ç†å™¨ã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨å¤šçº¿ç¨‹çš„ GUI æ¡†æ¶ä¸­æ›´å®¹æ˜“å‘ç”Ÿæ­»é”é—®é¢˜ï¼Œå…¶éƒ¨åˆ†åŸå› åœ¨äºï¼Œåœ¨è¾“å…¥äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ä¸­ä¸ GUI ç»„ä»¶çš„é¢å‘å¯¹è±¡æ¨¡å‹ä¹‹é—´ä¼šå­˜åœ¨é”™è¯¯çš„äº¤äº’ã€‚ç”¨æˆ·å¼•å‘çš„åŠ¨ä½œå°†é€šè¿‡ä¸€ç§ç±»ä¼¼äº â€œæ°”æ³¡ä¸Šå‡â€ çš„æ–¹å¼ä»æ“ä½œç³»ç»Ÿä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼šæ“ä½œç³»ç»Ÿé¦–å…ˆæ£€æµ‹åˆ°ä¸€æ¬¡é¼ æ ‡ç‚¹å‡»ï¼Œç„¶åé€šè¿‡å·¥å…·åŒ…å°†å…¶è½¬åŒ–ä¸º â€œé¼ æ ‡ç‚¹å‡»â€ äº‹ä»¶ï¼Œè¯¥äº‹ä»¶æœ€ç»ˆè¢«è½¬æ¢ä¸ºä¸€ä¸ªæ›´é«˜å±‚äº‹ä»¶ï¼ˆä¾‹å¦‚ â€œé¼ æ ‡å·¦é”®è¢«æŒ‰ä¸‹â€ äº‹ä»¶ï¼‰è½¬å‘ç»™åº”ç”¨ç¨‹åºçš„ç›‘å¬å™¨ã€‚å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºå¼•å‘çš„åŠ¨ä½œåˆä¼šä»¥ â€œæ°”æ³¡ä¸‹æ²‰â€ çš„æ–¹å¼ä»åº”ç”¨ç¨‹åºè¿”å›ç»™æ“ä½œç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­å¼•å‘ä¿®æ”¹æŸä¸ªç»„ä»¶èƒŒæ™¯è‰²çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚å°†è¢«è½¬å‘ç»™æŸä¸ªç‰¹å®šçš„ç»„ä»¶ï¼Œå¹¶æœ€ç»ˆè½¬å‘ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œç»˜åˆ¶ã€‚å› æ­¤ï¼Œä¸€æ–¹é¢è¿™ç»„æ“ä½œå°†ä»¥å®Œå…¨ç›¸åçš„é¡ºåºæ¥è®¿é—®ç›¸åŒçš„ GUI å¯¹è±¡ï¼›å¦ä¸€æ–¹é¢åˆè¦ç¡®ä¿æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»è€Œå¯¼è‡´ä¸ä¸€è‡´çš„é”å®šé¡ºåºï¼Œå¹¶å¼•å‘æ­»é”ã€‚</p>
</blockquote>
<blockquote>
<p>å¦ä¸€ä¸ªåœ¨å¤šçº¿ç¨‹ GUI æ¡†æ¶ä¸­å¯¼è‡´æ­»é”çš„åŸå› å°±æ˜¯ â€œæ¨¡å‹ â€” è§†å›¾ â€” æ§åˆ¶ (MVC)â€ è¿™ç§è®¾è®¡æ¨¡å¼çš„å¹¿æ³›åº”ç”¨ã€‚é€šè¿‡å°†ç”¨æˆ·çš„äº¤äº’åˆ†è§£åˆ°æ¨¡å‹ã€è§†å›¾å’Œæ§åˆ¶ç­‰æ¨¡å—ä¸­ï¼Œèƒ½æå¤§çš„ç®€åŒ– GUI åº”ç”¨ç¨‹åºçš„å®ç°ï¼Œä½†è¿™å´ä¹Ÿè¿›ä¸€æ­¥å¢åŠ äº†å‡ºç°ä¸ä¸€è‡´é”å®šé¡ºåºçš„é£é™©ã€‚</p>
</blockquote>
<blockquote>
<p>å•çº¿ç¨‹çš„ GUI æ¡†æ¶é€šè¿‡çº¿ç¨‹å°é—­æœºåˆ¶æ¥å®ç°çº¿ç¨‹å®‰å…¨æ€§ã€‚æ‰€æœ‰ GUI å¯¹è±¡ï¼ŒåŒ…æ‹¬å¯è§†åŒ–ç»„ä»¶å’Œæ•°æ®æ¨¡å‹ç­‰ï¼Œéƒ½åªèƒ½åœ¨äº‹ä»¶çº¿ç¨‹ä¸­è®¿é—®ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯å°†ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§çš„ä¸€éƒ¨åˆ†å·¥ä½œäº¤ç»™åº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜æ¥è´Ÿè´£ï¼Œä»–ä»¬å¿…é¡»ç¡®è®¤è¿™äº›å¯¹è±¡è¢«æ­£ç¡®çš„å°é—­åœ¨äº‹ä»¶çº¿ç¨‹ä¸­ã€‚</p>
</blockquote>
<p>ä»ä»¥ä¸Šæ–‡æ¡£ä¸­ä¸éš¾å‘ç°ï¼Œæ—©æœŸå‰è¾ˆä»¬å°è¯•è¿‡å¤šçº¿ç¨‹çš„ GUI æ¡†æ¶ï¼Œæœ€ç»ˆéƒ½ä»¥ â€œå¤±è´¥â€ å‘Šç»ˆè€Œåˆå›å½’åˆ°å•çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—æ¨¡å‹</p>
<p>åŸå› å¤§è‡´æ€»ç»“ä¸ºï¼š<strong>åœ¨å¤šçº¿ç¨‹ä¸­æ“ä½œ GUI å¯¹è±¡ï¼Œä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>
<h2 id="çº¿ç¨‹å®‰å…¨ä¸‰å¤§æ¶"><a class="markdownIt-Anchor" href="#çº¿ç¨‹å®‰å…¨ä¸‰å¤§æ¶"></a> çº¿ç¨‹å®‰å…¨ä¸‰å¤§æ¶</h2>
<h3 id="ä½•ä¸ºçº¿ç¨‹å®‰å…¨æ€§"><a class="markdownIt-Anchor" href="#ä½•ä¸ºçº¿ç¨‹å®‰å…¨æ€§"></a> ä½•ä¸ºçº¿ç¨‹å®‰å…¨æ€§<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></h3>
<blockquote>
<p>è¦å¯¹çº¿ç¨‹å®‰å…¨æ€§ç»™å‡ºä¸€ä¸ªç¡®åˆ‡çš„å®šä¹‰æ˜¯éå¸¸å¤æ‚çš„ã€‚å®šä¹‰è¶Šæ­£å¼ï¼Œå°±è¶Šå¤æ‚ï¼Œä¸ä»…å¾ˆéš¾æä¾›æœ‰å®é™…æ„ä¹‰çš„æŒ‡å¯¼å»ºè®®ï¼Œè€Œä¸”ä¹Ÿå¾ˆéš¾ä»ç›´è§‚ä¸Šå»ç†è§£ã€‚å› æ­¤ï¼Œä¸‹é¢ç»™å‡ºäº†ä¸€äº›éæ­£å¼çš„æè¿°ï¼Œçœ‹ä¸Šå»ä»¤äººå›°æƒ‘ã€‚åœ¨äº’è”ç½‘ä¸Šå¯ä»¥æœåˆ°è®¸å¤š â€œå®šä¹‰â€ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹ä¹‹é—´ä¸ä¼šå‡ºç°é”™è¯¯çš„äº¤äº’ã€‚</li>
<li>å¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œè€Œè°ƒç”¨è€…æ— éœ€æ‰§è¡Œé¢å¤–çš„åŠ¨ä½œã€‚</li>
</ul>
<p>çœ‹çœ‹è¿™äº›å®šä¹‰ï¼Œéš¾æ€ªæˆ‘ä»¬ä¼šå¯¹çº¿ç¨‹å®‰å…¨æ€§æ„Ÿåˆ°å›°æƒ‘ã€‚å®ƒä»¬å¬èµ·æ¥éå¸¸åƒ â€œå¦‚æœæŸä¸ªç±»å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»â€ã€‚å¯¹äºè¿™ç§è¯´æ³•ï¼Œè™½ç„¶æ²¡æœ‰å¤ªå¤šçš„äº‰è®®ï¼Œä½†åŒæ ·ä¸ä¼šå¸¦æ¥å¤ªå¤šçš„å¸®åŠ©ã€‚æˆ‘ä»¬å¦‚ä½•åŒºåˆ†çº¿ç¨‹å®‰å…¨çš„ç±»ä»¥åŠéçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Ÿè¿›ä¸€æ­¥è¯´ï¼Œâ€œå®‰å…¨â€ çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>åœ¨çº¿ç¨‹å®‰å…¨æ€§çš„å®šä¹‰ä¸­ï¼Œæœ€æ ¸å¿ƒçš„æ¦‚å¿µå°±æ˜¯æ­£ç¡®æ€§ã€‚å¦‚æœå¯¹çº¿ç¨‹å®‰å…¨æ€§çš„å®šä¹‰æ˜¯æ¨¡ç³Šçš„ï¼Œé‚£ä¹ˆå°±æ˜¯å› ä¸ºç¼ºä¹å¯¹æ­£ç¡®æ€§çš„æ¸…æ™°å®šä¹‰ã€‚</p>
<p>æ­£ç¡®æ€§çš„å«ä¹‰æ˜¯ï¼šæŸä¸ªç±»çš„è¡Œä¸ºä¸å…¶è§„èŒƒå®Œå…¨ä¸€è‡´ã€‚åœ¨è‰¯å¥½çš„è§„èŒƒä¸­é€šå¸¸ä¼šå®šä¹‰å„ç§ä¸å˜æ€§æ¡ä»¶ï¼ˆInvariantï¼‰æ¥çº¦æŸå¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥åŠå®šä¹‰å„ç§åéªŒæ¡ä»¶ï¼ˆPostconditionï¼‰æ¥æè¿°å¯¹è±¡æ“ä½œçš„ç»“æœã€‚ç”±äºæˆ‘ä»¬é€šå¸¸ä¸ä¼šç¼–å†™è¯¦ç»†çš„è§„èŒƒï¼Œé‚£ä¹ˆå¦‚ä½•çŸ¥é“è¿™äº›ç±»æ˜¯å¦æ­£ç¡®å‘¢ï¼Ÿæˆ‘ä»¬æ— æ³•çŸ¥é“ï¼Œä½†è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬åœ¨ç¡®ä¿¡ â€œç±»çš„ä»£ç èƒ½å·¥ä½œâ€ åä½¿ç”¨å®ƒä»¬ã€‚è¿™ç§ â€œä»£ç å¯ä¿¡æ€§â€ éå¸¸æ¥è¿‘äºæˆ‘ä»¬å¯¹æ­£ç¡®æ€§çš„ç†è§£ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å•çº¿ç¨‹çš„æ­£ç¡®æ€§è¿‘ä¼¼å®šä¹‰ä¸º â€œæ‰€è§å³æ‰€çŸ¥ï¼ˆwe know it when we see itï¼‰â€ã€‚åœ¨å¯¹ â€œæ­£ç¡®æ€§â€ ç»™å‡ºä¸€ä¸ªè¾ƒä¸ºæ¸…æ™°çš„å®šä¹‰åï¼Œå°±å¯ä»¥å®šä¹‰çº¿ç¨‹å®‰å…¨æ€§ï¼šå½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»æ—¶ï¼Œè¿™ä¸ªç±»å§‹ç»ˆéƒ½èƒ½è¡¨ç°å‡ºæ­£ç¡®çš„è¡Œä¸ºï¼Œé‚£ä¹ˆå°±ç§°è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ç”±äºå•çº¿ç¨‹ç¨‹åºä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºï¼Œå¦‚æœæŸä¸ªç±»åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­éƒ½ä¸æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå®ƒè‚¯å®šä¸ä¼šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
</blockquote>
<h3 id="å¤§æ¶-å¯è§æ€§"><a class="markdownIt-Anchor" href="#å¤§æ¶-å¯è§æ€§"></a> å¤§æ¶ - å¯è§æ€§</h3>
<blockquote>
<p>å¯è§æ€§æ˜¯ä¸€ç§å¤æ‚çš„å±æ€§ï¼Œå› ä¸ºå¯è§æ€§ä¸­çš„é”™è¯¯æ€»æ˜¯ä¼šè¿èƒŒæˆ‘ä»¬çš„ç›´è§‰ã€‚<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
</blockquote>
<p>åœ¨ä¸Šä¸ªä¸–çºªçš„å•æ ¸æ—¶ä»£ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨å”¯ä¸€çš„ä¸€é¢— CPU ä¸Šæ‰§è¡Œï¼ŒCPU ç¼“å­˜ä¸å†…å­˜ä¹‹é—´çš„å°±åƒä¸¤å£å­ï¼Œä½ çš„å°±æ˜¯æˆ‘çš„ï¼Œæˆ‘çš„å°±æ˜¯ä½ çš„ï¼Œä¸åˆ†å½¼æ­¤ğŸ˜‚</p>
<p>å› ä¸ºåªæœ‰ä¸€é¢— CPUï¼Œä¹Ÿåªæœ‰ä¸€ä¸ª CPU ç¼“å­˜ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹èŠ±äº†å¤§æ´‹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ¥è¯´ï¼Œå®ƒä¸€å®šèƒ½çœ‹åˆ°è¿˜å‰©å¤šå°‘å¤§æ´‹ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„å›¾ä¸­ï¼Œå†…å­˜ä¸­ä¸€å…±æœ‰100å¤§æ´‹ï¼Œå¦‚æœçº¿ç¨‹AèŠ±äº†20å¤§æ´‹ï¼Œçº¿ç¨‹Bæƒ³å†æŒ¥éœæ—¶ï¼Œåªèƒ½æŒ¥éœ80å¤§æ´‹</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205171657411.png" alt="image-20220516195337629" /></p>
<p>ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç«‹åˆ»çœ‹åˆ°ï¼Œç§°ä¸º<strong>å¯è§æ€§</strong></p>
<p>åœ¨21ä¸–çºªçš„å¤šæ ¸æ—¶ä»£ï¼Œæ¯é¢— CPU éƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œè¿™æ—¶ CPU ç¼“å­˜ä¸å†…å­˜ä¹‹é—´çš„äº‹å°±ä¸å¥½æ°æ‰¯äº†ï¼Œå°±åƒå¤ä»£çš„çš‡å¸(å†…å­˜)æœ‰åå®«ä½³ä¸½ä¸‰åƒ(CPU)ï¼Œçš‡å¸è·Ÿæ‰€æœ‰ä½³ä¸½ä»¬è¯´å’±å›½åº“å……è¶³ï¼šç™½é“¶100ä¸¤ï¼Œä½³ä¸½ä»¬éƒ½çŸ¥é“äº†å›½åº“æœ‰100ä¸¤ç™½é“¶ï¼Œçš‡åæƒ³èŠ±80ä¸¤ä¹°é¢è†œ(æ“ä½œ CPU-1 ç¼“å­˜)ï¼Œè´µå¦ƒæƒ³èŠ±70ä¸¤ä¹°BBéœœ(æ“ä½œ CPU-2 ç¼“å­˜)ï¼Œè¿‡æ®µæ—¶é—´çš‡å¸ä¸€çœ‹(CPU ç¼“å­˜åŒæ­¥åˆ°å†…å­˜)ï¼Œå›½åº“è¿˜æœ‰30ä¸¤ç™½é“¶ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„å›¾ä¸­ï¼Œå†…å­˜æœ‰100ä¸¤ç™½é“¶ï¼Œçº¿ç¨‹AèŠ±äº†80ä¸¤ï¼Œç„¶ååŒæ­¥åˆ°å†…å­˜ï¼Œçš‡å¸çœ‹äº†å›½åº“è¿˜æœ‰20ä¸¤ï¼Œçº¿ç¨‹BèŠ±äº†70ä¸¤ï¼Œç„¶ååŒæ­¥åˆ°å†…å­˜ï¼Œå›½åº“å˜æˆ30ä¸¤äº†ï¼Ÿå•§å•§ï¼Œè¿™å›½åº“ç™½é“¶è¶ŠèŠ±è¶Šå¤šğŸ˜‚</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205171657692.png" alt="image-20220516203133183" /></p>
<p><strong>è¿™é‡Œæƒ³è¯´æ˜çº¿ç¨‹Aå¯¹å…±äº«å˜é‡çš„æ“ä½œå¯¹äºçº¿ç¨‹Bæ¥è¯´æ˜¯ä¸å¯è§çš„</strong></p>
<p>æ¥ä¸‹æ¥ç”¨ä¸€æ®µä»£ç æ¥çœ‹ä¸€ä¸‹å¯è§æ€§é—®é¢˜ï¼Œä¸‹é¢ä»£ç <sup class="footnote-ref"><a href="#fn4" id="fnref4:1">[4:1]</a></sup>ä¸­è¯´æ˜äº†å½“å¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å…±äº«æ•°æ®æ—¶å‡ºç°çš„é”™è¯¯ã€‚åœ¨ä»£ç ä¸­ï¼Œä¸»çº¿ç¨‹å’Œè¯»çº¿ç¨‹éƒ½å°†è®¿é—®å…±äº«å˜é‡ ready å’Œ numberã€‚ä¸»çº¿ç¨‹å¯åŠ¨è¯»çº¿ç¨‹ï¼Œç„¶åå°† number è®¾ä¸º 45ï¼Œå¹¶å°† ready è®¾ä¸º trueã€‚è¯»çº¿ç¨‹ä¸€ç›´å¾ªç¯ç›´åˆ°å‘ç° ready çš„å€¼å˜ä¸º trueï¼Œç„¶åè¾“å‡º number çš„å€¼ã€‚è™½ç„¶ç¨‹åºçœ‹èµ·æ¥ä¼šè¾“å‡º 45ï¼Œä½†äº‹å®ä¸Šå¾ˆå¯èƒ½è¾“å‡º 0ï¼Œæˆ–è€…æ ¹æœ¬æ— æ³•ç»ˆæ­¢ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨è¶³å¤Ÿçš„åŒæ­¥æœºåˆ¶ï¼Œå› æ­¤æ— æ³•ä¿è¯ä¸»çº¿ç¨‹å†™å…¥çš„ ready å€¼å’Œ number å€¼å¯¹äºè¯»çº¿ç¨‹æ¥è¯´æ˜¯å¯è§çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VisibilityTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> ready;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReaderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!ready) &#123;</span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;number = &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReaderThread</span>().start();</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">        number = <span class="number">45</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="äºŒæ¶-åŸå­æ€§"><a class="markdownIt-Anchor" href="#äºŒæ¶-åŸå­æ€§"></a> äºŒæ¶ - åŸå­æ€§</h3>
<blockquote>
<p>ä¸å¯è§æ€§ç±»ä¼¼ï¼ŒåŸå­æ€§ä¹Ÿæ˜¯ä¸€ç§å¤æ‚çš„å±æ€§ï¼Œå› ä¸ºåŸå­æ€§ä¸­çš„é”™è¯¯ä¹Ÿæ˜¯ä¼šè¿èƒŒæˆ‘ä»¬çš„ç›´è§‰ã€‚</p>
</blockquote>
<p><strong>åŸå­æ€§ï¼šæ˜¯æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡ä»¤(æ“ä½œ)åœ¨ CPU æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­ã€ä¸å¯åˆ†å‰²çš„ç‰¹æ€§ï¼Œè¿™é‡Œå¼ºè°ƒåœ¨ CPU æŒ‡ä»¤(æ“ä½œ)çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¡¨ç¤ºåŸå­æ€§æ˜¯åœ¨ CPU æŒ‡ä»¤(æ“ä½œ)å±‚é¢è€Œä¸æ˜¯è¯­è¨€å±‚é¢</strong></p>
<p>ä¸‹é¢ä»‹ç»ä¸¤ç§å¸¸è§çš„åŸå­æ€§é”™è¯¯å½¢å¼</p>
<h4 id="è¯»å–-ä¿®æ”¹-å†™å…¥"><a class="markdownIt-Anchor" href="#è¯»å–-ä¿®æ”¹-å†™å…¥"></a> è¯»å– - ä¿®æ”¹ - å†™å…¥</h4>
<p>æ¥ä¸‹æ¥ç”¨ä¸€æ®µä»£ç çœ‹ä¸€ä¸‹ â€œè¯»å– - ä¿®æ”¹ - å†™å…¥â€ é—®é¢˜ï¼Œä¸‹é¢ä»£ç ç”± <code>Kotlin</code> ç¼–å†™ï¼Œåœ¨ <code>reduceCount</code> æ–¹æ³•ä¸­å¾ªç¯ 100000 æ¬¡æ‰§è¡Œ <code>count--</code> æ“ä½œï¼Œä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œ <code>reduceCount</code> æ–¹æ³•ï¼Œå¯ä»¥å…ˆæƒ³ä¸‹ç¨‹åºè¿è¡Œåè¾“å‡ºçš„ <code>count</code> æ˜¯å¤šå°‘ï¼Ÿ</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> thread1 = thread &#123;</span><br><span class="line">        reduceCount()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> thread2 = thread &#123;</span><br><span class="line">        reduceCount()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    thread1.join()</span><br><span class="line">    thread2.join()</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;count = <span class="variable">$count</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 20ä¸‡</span></span><br><span class="line"><span class="keyword">var</span> count: <span class="built_in">Long</span> = <span class="number">200000L</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">reduceCount</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¾ªç¯10ä¸‡æ¬¡</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.100000</span>) &#123;</span><br><span class="line">        count--</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´è§‚ä¸Šæ„Ÿè§‰ <code>count</code> åº”è¯¥æ˜¯ 0ï¼Œä½†æ˜¯ç¨‹åºè¾“å‡ºçš„ <code>count</code> æ˜¯ä½äº 0 è‡³ 100000 ä¹‹é—´çš„éšæœºæ•°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>è™½ç„¶é€’å‡æ“ä½œ <code>count--</code> æ˜¯ä¸€ç§ç´§å‡‘çš„è¯­æ³•ï¼Œä½¿å…¶çœ‹ä¸Šå»åªæ˜¯ä¸€ä¸ªæ“ä½œï¼Œä½†è¿™ä¸ªæ“ä½œå¹¶éåŸå­çš„ï¼Œå› è€Œå®ƒå¹¶ä¸ä¼šä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œæ¥æ‰§è¡Œã€‚</p>
<p>å®é™…ä¸Šï¼Œå®ƒåŒ…å«äº†ä¸‰ä¸ªç‹¬ç«‹çš„æ“ä½œï¼š</p>
<ul>
<li>è¯»å– count çš„å€¼</li>
<li>å°†å€¼åŠ  1</li>
<li>ç„¶åå°†ç¬¬äºŒæ­¥è®¡ç®—ç»“æœå†™å…¥ count</li>
</ul>
<p>å¯¹äºä¸Šé¢çš„ä¸‰ä¸ªæ“ä½œæ¥è¯´ï¼Œcount çš„åˆå§‹å€¼ä¸º 200000ï¼Œé‚£ä¹ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªçº¿ç¨‹è¯»åˆ°çš„å€¼éƒ½ä¸º 200000ï¼Œæ¥ç€æ‰§è¡Œé€’å‡æ“ä½œï¼Œå¹¶ä¸”éƒ½å°† count çš„å€¼è®¾ä¸º 199999ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚è¿™ç§ç”±äºä¸æ°å½“çš„æ‰§è¡Œæ—¶åºè€Œå‡ºç°ä¸æ­£ç¡®çš„ç»“æœæ˜¯ä¸€ç§éå¸¸é‡è¦çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µç§°ä¸ºï¼šç«æ€æ¡ä»¶ (Race Condition)</p>
<h4 id="å…ˆæ£€æŸ¥åæ‰§è¡Œ"><a class="markdownIt-Anchor" href="#å…ˆæ£€æŸ¥åæ‰§è¡Œ"></a> å…ˆæ£€æŸ¥åæ‰§è¡Œ</h4>
<p>å…ˆæ£€æŸ¥åæ‰§è¡Œæ˜¯æœ€å¸¸è§çš„ç«æ€æ¡ä»¶ç±»å‹ï¼Œå³é€šè¿‡ä¸€ä¸ªå¯èƒ½å¤±æ•ˆçš„è§‚æµ‹ç»“æœæ¥å†³å®šä¸‹ä¸€æ­¥çš„åŠ¨ä½œã€‚å…ˆæ£€æŸ¥åæ‰§è¡Œé—®é¢˜ä¸­å¸¸è§çš„æƒ…å†µå°±æ˜¯ä¸‹é¢å½¢å¼çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// check</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="comment">// action</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢é€šè¿‡å»¶è¿Ÿåˆå§‹åŒ–çœ‹ä¸€ä¸‹ â€œå…ˆæ£€æŸ¥åæ‰§è¡Œâ€ é—®é¢˜ï¼Œå»¶è¿Ÿåˆå§‹åŒ–çš„ç›®çš„æ˜¯å°†å¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œæ¨è¿Ÿåˆ°å®é™…ä½¿ç”¨æ—¶æ‰è¿›è¡Œï¼ŒåŒæ—¶è¦ç¡®ä¿åªè¢«åˆå§‹åŒ–ä¸€æ¬¡<sup class="footnote-ref"><a href="#fn3" id="fnref3:1">[3:1]</a></sup>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyInitRace</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">LazyInitRace</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LazyInitRace <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ£€æŸ¥instaceæ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»åˆå§‹åŒ–åˆ™è¿”å›ç°æœ‰çš„å®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªå®ä¾‹å¼•ç”¨</span></span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">LazyInitRace</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazyInitRace</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ LazyInitRace ä¸­åŒ…å«äº†ä¸€ä¸ªç«æ€æ¡ä»¶ï¼Œå®ƒå¯èƒ½ä¼šç ´åè¿™ä¸ªç±»çš„æ­£ç¡®æ€§ã€‚å‡å®šçº¿ç¨‹ A å’Œçº¿ç¨‹ B åŒæ—¶æ‰§è¡Œ <code>getInstance</code>ã€‚çº¿ç¨‹ A çœ‹åˆ° instance ä¸ºç©ºï¼Œå› è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ LazyInitRace å®ä¾‹ã€‚çº¿ç¨‹ B åŒæ ·éœ€è¦åˆ¤æ–­ instance æ˜¯å¦ä¸ºç©ºã€‚æ­¤æ—¶çš„ instance æ˜¯å¦ä¸ºç©ºï¼Œè¦å–å†³äºä¸å¯é¢„æµ‹çš„æ—¶åºï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„è°ƒåº¦æ–¹å¼ï¼Œä»¥åŠçº¿ç¨‹ A éœ€è¦èŠ±å¤šé•¿æ—¶é—´æ¥åˆå§‹åŒ– LazyInitRace å¹¶è®¾ç½® instanceã€‚å¦‚æœå½“çº¿ç¨‹ B æ£€æŸ¥æ—¶ï¼Œinstance ä¸ºç©ºï¼Œé‚£ä¹ˆåœ¨ä¸¤æ¬¡è°ƒç”¨ <code>getInstance</code> æ—¶å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœï¼Œå³ä½¿ <code>getInstance</code> é€šå¸¸è¢«è®¤ä¸ºæ˜¯è¿”å›ç›¸åŒçš„å®ä¾‹ã€‚<sup class="footnote-ref"><a href="#fn3" id="fnref3:2">[3:2]</a></sup></p>
<p>ä¾‹å¦‚åœ¨ä¸‹å›¾ä¸­ï¼Œçº¿ç¨‹A æ‰§è¡Œå®Œ â€œæ£€æŸ¥â€ é˜¶æ®µååšçº¿ç¨‹è°ƒåº¦(åˆ‡æ¢)ï¼Œçº¿ç¨‹ A å’Œçº¿ç¨‹ B æŒ‰å›¾ä¸­åºåˆ—æ‰§è¡Œï¼Œæœ€ç»ˆå‘ç°ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ LazyInitRace å®ä¾‹ï¼Œä½†è¿™ä¸æ˜¯æœŸæœ›çš„ç»“æœã€‚</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205171657294.png" alt="image-20220517165708450" /></p>
<h3 id="ä¸‰æ¶-æœ‰åºæ€§"><a class="markdownIt-Anchor" href="#ä¸‰æ¶-æœ‰åºæ€§"></a> ä¸‰æ¶ - æœ‰åºæ€§</h3>
<p>åœ¨å¯è§æ€§ç« èŠ‚ä¸­çš„ç¤ºä¾‹ä»£ç ä¸­æœ‰ä¸€ç§æƒ…å†µï¼šnumber å¾ˆå¯èƒ½è¾“å‡º 0ï¼Œå› ä¸ºè¯»çº¿ç¨‹å¯èƒ½çœ‹åˆ°äº†å†™å…¥ ready çš„å€¼ï¼Œä½†å´æ²¡æœ‰çœ‹åˆ°ä¹‹åå†™å…¥ number çš„å€¼ï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸º â€œé‡æ’åº (Reordering)â€ã€‚</p>
<blockquote>
<p>åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ä»¥åŠè¿è¡Œæ—¶ç­‰éƒ½æœ‰å¯èƒ½å¯¹æ“ä½œçš„æ‰§è¡Œé¡ºåºè¿›è¡Œä¸€äº›æ„æƒ³ä¸åˆ°çš„è°ƒæ•´ã€‚åœ¨ç¼ºä¹è¶³å¤ŸåŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œè¦æƒ³å¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºè¿›è¡Œåˆ¤æ–­ï¼Œå‡ ä¹æ— æ³•å¾—åˆ°æ­£ç¡®çš„ç»“è®ºã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VisibilityTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> ready;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReaderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!ready) &#123;</span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;number = &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReaderThread</span>().start();</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">        number = <span class="number">45</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æœ‰åºæ€§æŒ‡çš„æ˜¯ç¨‹åºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œ</strong></p>
<p>ä¸‹é¢å†æ¥ä¸ªä»£ç ç¤ºä¾‹<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>æ¥è¯´æ˜æœ‰åºæ€§é—®é¢˜ï¼Œåœ¨ç¨‹åº PossibleReordering ä¸­è¯´æ˜äº†<sup class="footnote-ref"><a href="#fn5" id="fnref5:1">[5:1]</a></sup>ï¼Œåœ¨æ²¡æœ‰æ­£ç¡®åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå³ä½¿è¦æ¨æ–­æœ€ç®€å•çš„å¹¶å‘ç¨‹åºçš„è¡Œä¸ºä¹Ÿå¾ˆå›°éš¾ã€‚å¾ˆå®¹æ˜“æƒ³è±¡ PossibleReordering æ˜¯å¦‚ä½•è¾“å‡º (1, 0) æˆ– (0ï¼Œ1) æˆ– (1ï¼Œ1) çš„ï¼šçº¿ç¨‹ A å¯ä»¥åœ¨çº¿ç¨‹ B å¼€å§‹ä¹‹å‰å°±æ‰§è¡Œå®Œæˆï¼Œçº¿ç¨‹ B ä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹ A å¼€å§‹ä¹‹å‰æ‰§è¡Œå®Œæˆï¼Œæˆ–è€…äºŒè€…çš„æ“ä½œäº¤æ›¿è¿›è¡Œã€‚ä½†å¥‡æ€ªçš„æ˜¯ï¼ŒPossibleReordering è¿˜å¯ä»¥è¾“å‡º (0ï¼Œ0) ã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹ä¸­çš„å„ä¸ªæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®æµä¾èµ–æ€§ï¼Œå› æ­¤è¿™äº›æ“ä½œå¯ä»¥ä¹±åºæ‰§è¡Œã€‚(å³ä½¿è¿™äº›æ“ä½œæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä½†åœ¨å°†ç¼“å­˜åˆ·æ–°åˆ°ä¸»å†…å­˜çš„ä¸åŒæ—¶åºä¸­ä¹Ÿå¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œä»çº¿ç¨‹ B çš„è§’åº¦çœ‹ï¼Œçº¿ç¨‹ A ä¸­çš„èµ‹å€¼æ“ä½œå¯èƒ½ä»¥ç›¸åçš„æ¬¡åºæ‰§è¡Œã€‚)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PossibleReordering</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            x = b;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            b = <span class="number">1</span>;</span><br><span class="line">            y = a;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        </span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;( &quot;</span> + x + <span class="string">&quot;, &quot;</span> + y + <span class="string">&quot; )&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾ç»™å‡ºäº†ä¸€ç§å¯èƒ½ç”±é‡æ’åºå¯¼è‡´çš„äº¤æ›¿æ‰§è¡Œæ–¹å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸­ä¼šè¾“å‡º (0ï¼Œ0) ã€‚</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205171819633.png" alt="image-20220517181932852" /></p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡ä»å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨è§’åº¦è§£è¯»äº† Android UI æ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„ï¼ŒçŒœæƒ³ Android UI æ¡†æ¶è®¾è®¡äººå‘˜ä¹Ÿæ˜¯æ±²å–äº†å‰äººå¤šçº¿ç¨‹ä¸­çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚é‡‡å–å•çº¿ç¨‹çš„å°é—­æœºåˆ¶æ¥å®ç°çº¿ç¨‹å®‰å…¨æ€§ã€‚</p>
<h2 id="è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®"></a> è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½æ›´æ–°UIï¼Œè¿™é‡Œä¸æŠ¬æ  <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p>æ‘˜è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬ä¹ç« ã€‹ <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p>æ‘˜è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬äºŒç« ã€‹ <a href="#fnref3" class="footnote-backref">â†©ï¸</a> <a href="#fnref3:1" class="footnote-backref">â†©ï¸</a> <a href="#fnref3:2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p>æ‘˜è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬ä¸‰ç« ã€‹ <a href="#fnref4" class="footnote-backref">â†©ï¸</a> <a href="#fnref4:1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn5" class="footnote-item"><p>æ‘˜è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬åå…­ç« ã€‹ <a href="#fnref5" class="footnote-backref">â†©ï¸</a> <a href="#fnref5:1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>java</tag>
        <tag>concurrent</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹-Javaå†…å­˜æ¨¡å‹(JMM)</title>
    <url>/2022/05/25/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B(JMM)/</url>
    <content><![CDATA[<h1 id="javaå¹¶å‘ç¼–ç¨‹-javaå†…å­˜æ¨¡å‹jmm"><a class="markdownIt-Anchor" href="#javaå¹¶å‘ç¼–ç¨‹-javaå†…å­˜æ¨¡å‹jmm"></a> Javaå¹¶å‘ç¼–ç¨‹-Javaå†…å­˜æ¨¡å‹(JMM)</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>åœ¨ä¸Šä¸€ç«  <a href="https://juejin.cn/post/7098882471810301959">Javaå¹¶å‘ç¼–ç¨‹-Androidçš„UIæ¡†æ¶ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çš„ï¼Ÿ</a> ä¸­ç¬”è€…ä»‹ç»äº†å¹¶å‘ç¼–ç¨‹çº¿ç¨‹å®‰å…¨ã€Œä¸‰å¤§æ¶ã€ï¼šã€Œå¯è§æ€§ã€ã€ã€ŒåŸå­æ€§ã€ä»¥åŠã€Œæœ‰åºæ€§ã€</p>
<p>å¹¿ä¹‰ä¸Šæ¥è¯´ï¼Œå¹¶å‘ç¼–ç¨‹é—®é¢˜ç¬”è€…å½’çº³ä¸ºï¼šæ˜¯ç”±äºåç»­æ“ä½œçœ‹ä¸åˆ°å‰é¢æ“ä½œçš„ç»“æœè€Œå¼•å‘çš„</p>
<p>é¦–å…ˆã€Œå¤§æ¶-å¯è§æ€§ã€é¡¾åæ€ä¹‰ï¼Œå³çº¿ç¨‹Bèƒ½å¦çœ‹è§çº¿ç¨‹Aå¯¹å…±äº«å˜é‡çš„æ“ä½œç»“æœ</p>
<p>å…¶æ¬¡ã€ŒäºŒæ¶-åŸå­æ€§ã€CPU æŒ‡ä»¤/æ“ä½œè¢«ä¸­æ–­/åˆ†å‰²ï¼Œå¹¿ä¹‰ä¸Šçœ‹ç¬”è€…è®¤ä¸ºä¹Ÿæ˜¯å¯è§æ€§é—®é¢˜ï¼Œæ¯”å¦‚çº¿ç¨‹ A ä¿®æ”¹å…±äº«å˜é‡ <code>x += 1</code> æ—¶è¢«ä¸­æ–­ï¼Œå»æ‰§è¡Œçº¿ç¨‹ B <code>x = 40</code> ï¼Œçº¿ç¨‹ A æ¢å¤æ‰§è¡Œæ—¶å¯èƒ½çœ‹ä¸åˆ° <code>x</code> å·²ç»è¢«ä¿®æ”¹ä¸º 40</p>
<p>æœ€åã€Œä¸‰æ¶-æœ‰åºæ€§ã€æŒ‡çš„æ˜¯ç¨‹åºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œï¼Œå³å…ˆæ‰§è¡Œ <code>x = 40</code> ï¼Œåç»­è¯»å– <code>x == 40</code> ä¸€å®šä¸ºçœŸï¼Œå¦‚æœæœ‰å„ç§ä¼˜åŒ–å¯¼è‡´æŒ‡ä»¤é‡æ’åºï¼Œåç»­è¯»å– <code>x == 40</code> æ—¶å¯èƒ½ä¸ä¸ºçœŸ</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œå¹¶å‘ç¼–ç¨‹çš„é—®é¢˜å¤§éƒ¨åˆ†éƒ½æ˜¯ã€Œå¯è§æ€§ã€é—®é¢˜</p>
<h2 id="javaå†…å­˜æ¨¡å‹jmm"><a class="markdownIt-Anchor" href="#javaå†…å­˜æ¨¡å‹jmm"></a> Javaå†…å­˜æ¨¡å‹(JMM)</h2>
<p>åœ¨ä¸Šä¸€ç« ä¸­ç¬”è€…ä»‹ç»äº†å¯¼è‡´ã€Œå¯è§æ€§ã€çš„åŸå› æ˜¯ç¼“å­˜ï¼Œå¯¼è‡´ã€Œæœ‰åºæ€§ã€çš„åŸå› æ˜¯å„ç§ä¼˜åŒ–(ç¼–è¯‘æ—¶ã€å¤„ç†å™¨ä»¥åŠè¿è¡Œæ—¶)ï¼Œé¦–å…ˆç¬”è€…æƒ³åˆ°çš„æ˜¯ç¦ç”¨ç¼“å­˜å’Œç¦æ­¢å„ç§ä¼˜åŒ–æ“ä½œï¼Œåœ¨ Java ä¸­å¦‚ä½•ç¦ç”¨ç¼“å­˜å’Œç¦æ­¢å„ç§ä¼˜åŒ–å‘¢ï¼Ÿ</p>
<h3 id="happens-before"><a class="markdownIt-Anchor" href="#happens-before"></a> Happens-Before</h3>
<p>Java å†…å­˜æ¨¡å‹æ˜¯é€šè¿‡å„ç§æ“ä½œæ¥å®šä¹‰çš„<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼ŒåŒ…æ‹¬å¯¹å˜é‡çš„è¯» / å†™æ“ä½œï¼Œç›‘è§†å™¨é”çš„åŠ é”å’Œé‡Šæ”¾æ“ä½œï¼Œä»¥åŠçº¿ç¨‹çš„å¯åŠ¨å’Œåˆå¹¶æ“ä½œã€‚JMM ä¸ºç¨‹åºä¸­æ‰€æœ‰çš„æ“ä½œå®šä¹‰äº†ä¸€ä¸ªååºå…³ç³»<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>ï¼Œç§°ä¹‹ä¸º Happens-Beforeã€‚è¦æƒ³ä¿è¯æ‰§è¡Œæ“ä½œ B çš„çº¿ç¨‹çœ‹åˆ°æ“ä½œ A çš„ç»“æœï¼ˆæ— è®º A å’Œ B æ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ï¼Œé‚£ä¹ˆåœ¨ A å’Œ B ä¹‹é—´å¿…é¡»æ»¡è¶³ Happens-Before å…³ç³»ã€‚å¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´ç¼ºä¹ Happens-Before å…³ç³»ï¼Œé‚£ä¹ˆ JVM å¯ä»¥å¯¹å®ƒä»¬ä»»æ„çš„é‡æ’åºã€‚</p>
<p>Happens-Before çš„è§„åˆ™åŒ…æ‹¬ï¼š</p>
<h4 id="è§„åˆ™ä¸€ç¨‹åºé¡ºåº"><a class="markdownIt-Anchor" href="#è§„åˆ™ä¸€ç¨‹åºé¡ºåº"></a> è§„åˆ™ä¸€ï¼šç¨‹åºé¡ºåº</h4>
<p>è¿™æ¡è§„åˆ™æ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„ç›´è§‰ï¼Œåœ¨å•çº¿ç¨‹ä¸­ä»£ç çš„é¡ºåºå³ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼š<code>int x = 40</code> å°†åœ¨ <code>int y = 41</code> ä¹‹å‰æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">41</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è§„åˆ™äºŒç›‘è§†å™¨é”"><a class="markdownIt-Anchor" href="#è§„åˆ™äºŒç›‘è§†å™¨é”"></a> è§„åˆ™äºŒï¼šç›‘è§†å™¨é”<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></h4>
<p>ç›‘è§†å™¨é”å³å†…ç½®é”(synchronized)ï¼Œåœ¨ç›‘è§†å™¨é”ä¸Šçš„è§£é”æ“ä½œå¿…é¡»åœ¨åŒä¸€ä¸ªç›‘è§†å™¨é”çš„åŠ é”æ“ä½œä¹‹å‰æ‰§è¡Œï¼Œè¿™æ¡è§„åˆ™æ¯”è¾ƒå¥½ç†è§£ï¼Œç°å®ä¸–ç•Œä¸­çš„é”åœ¨å…³é”å‰å¿…é¡»å¤„äºæ‰“å¼€çŠ¶æ€</p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202205251421708.png" alt="image-20220525142109393" /></p>
<h4 id="è§„åˆ™ä¸‰volatile-å˜é‡"><a class="markdownIt-Anchor" href="#è§„åˆ™ä¸‰volatile-å˜é‡"></a> è§„åˆ™ä¸‰ï¼švolatile å˜é‡<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup><sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></h4>
<p>å¯¹ volatile å˜é‡çš„å†™å…¥æ“ä½œå¿…é¡»åœ¨å¯¹è¯¥å˜é‡çš„è¯»å–æ“ä½œä¹‹å‰æ‰§è¡Œã€‚</p>
<p>è¿™æ¡è§„åˆ™ä¸å¤§å¥½ç†è§£ï¼Œä»¥ä¸‹ä»£ç ä¸æ–‡å­—æ‘˜è‡ª <a href="https://www.infoq.cn/article/java-memory-model-4">æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆå››ï¼‰â€”â€”volatile</a></p>
<blockquote>
<p>ç†è§£ volatile ç‰¹æ€§çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯ï¼šæŠŠå¯¹ volatile å˜é‡çš„å•ä¸ªè¯»/å†™ï¼Œçœ‹æˆæ˜¯ä½¿ç”¨åŒä¸€ä¸ªç›‘è§†å™¨é”å¯¹è¿™äº›å•ä¸ªè¯»/å†™æ“ä½œåšäº†åŒæ­¥<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VolatileFeaturesExample</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">vl</span> <span class="operator">=</span> <span class="number">0L</span>;  <span class="comment">// ä½¿ç”¨ volatile å£°æ˜ 64 ä½çš„ long å‹å˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">        vl = l;   <span class="comment">// å•ä¸ª volatile å˜é‡çš„å†™</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getAndIncrement</span> <span class="params">()</span> &#123;</span><br><span class="line">        vl++;    <span class="comment">// å¤åˆï¼ˆå¤šä¸ªï¼‰volatile å˜é‡çš„è¯» / å†™</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> vl;   <span class="comment">// å•ä¸ª volatile å˜é‡çš„è¯»</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾æœ‰å¤šä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨ä¸Šé¢ç¨‹åºçš„ä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªç¨‹åºåœ¨è¯­æ„ä¸Šå’Œä¸‹é¢ç¨‹åºç­‰ä»·ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VolatileFeaturesExample</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">vl</span> <span class="operator">=</span> <span class="number">0L</span>;               <span class="comment">// 64 ä½çš„ long å‹æ™®é€šå˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">long</span> l)</span> &#123;     <span class="comment">// å¯¹å•ä¸ªçš„æ™®é€š å˜é‡çš„å†™ç”¨åŒä¸€ä¸ªç›‘è§†å™¨åŒæ­¥</span></span><br><span class="line">        vl = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getAndIncrement</span> <span class="params">()</span> &#123; <span class="comment">// æ™®é€šæ–¹æ³•è°ƒç”¨</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">temp</span> <span class="operator">=</span> get();           <span class="comment">// è°ƒç”¨å·²åŒæ­¥çš„è¯»æ–¹æ³•</span></span><br><span class="line">        temp += <span class="number">1L</span>;                  <span class="comment">// æ™®é€šå†™æ“ä½œ</span></span><br><span class="line">        set(temp);                   <span class="comment">// è°ƒç”¨å·²åŒæ­¥çš„å†™æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">get</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> vl; <span class="comment">// å¯¹å•ä¸ªçš„æ™®é€šå˜é‡çš„è¯»ç”¨åŒä¸€ä¸ªç›‘è§†å™¨åŒæ­¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢ç¤ºä¾‹ç¨‹åºæ‰€ç¤ºï¼Œå¯¹ä¸€ä¸ª volatile å˜é‡çš„å•ä¸ªè¯» / å†™æ“ä½œï¼Œä¸å¯¹ä¸€ä¸ªæ™®é€šå˜é‡çš„è¯» / å†™æ“ä½œä½¿ç”¨åŒä¸€ä¸ªç›‘è§†å™¨é”æ¥åŒæ­¥ï¼Œå®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œæ•ˆæœç›¸åŒã€‚</p>
<p>ä»å†…å­˜è¯­ä¹‰çš„è§’åº¦æ¥è¯´ï¼Œvolatile ä¸ç›‘è§†å™¨é”æœ‰ç›¸åŒçš„æ•ˆæœï¼švolatile å†™å’Œç›‘è§†å™¨çš„é‡Šæ”¾æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ï¼›volatile è¯»ä¸ç›‘è§†å™¨çš„è·å–æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œvolatile å˜é‡è‡ªèº«å…·æœ‰ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯è§æ€§ã€‚å¯¹ä¸€ä¸ª volatile å˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ª volatile å˜é‡æœ€åçš„å†™å…¥ã€‚</li>
<li>åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ª volatile å˜é‡çš„è¯» / å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äº volatile++ è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚</li>
</ul>
<h4 id="è§„åˆ™å››çº¿ç¨‹å¯åŠ¨"><a class="markdownIt-Anchor" href="#è§„åˆ™å››çº¿ç¨‹å¯åŠ¨"></a> è§„åˆ™å››ï¼šçº¿ç¨‹å¯åŠ¨</h4>
<p>åœ¨çº¿ç¨‹ä¸Šå¯¹ Thread.start çš„è°ƒç”¨å¿…é¡»åœ¨è¯¥çº¿ç¨‹ä¸­æ‰§è¡Œä»»ä½•æ“ä½œä¹‹å‰æ‰§è¡Œã€‚</p>
<p>è¿™æ¡è§„åˆ™æ¯”è¾ƒå¥½ç†è§£ï¼Œå³çº¿ç¨‹ A å¯åŠ¨æ“ä½œå…ˆæ‰§è¡Œï¼Œç„¶åå†æ‰§è¡Œçº¿ç¨‹ A å†…çš„æ“ä½œï¼Œæ¢è¨€ä¹‹ï¼Œçº¿ç¨‹ A å¯åŠ¨å‰çš„æ“ä½œç»“æœå¯¹çº¿ç¨‹ A ä¸­çš„æ“ä½œå¯è§ï¼Œå‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸­çš„æ“ä½œ, å¯ä»¥çœ‹åˆ°çº¿ç¨‹å¯åŠ¨å‰å¯¹å…±äº«å˜é‡çš„æ“ä½œç»“æœ</span></span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹å¯åŠ¨å‰æ“ä½œå…±äº«å˜é‡</span></span><br><span class="line">x = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹å¯åŠ¨</span></span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure>
<h4 id="è§„åˆ™äº”çº¿ç¨‹ç»“æŸ"><a class="markdownIt-Anchor" href="#è§„åˆ™äº”çº¿ç¨‹ç»“æŸ"></a> è§„åˆ™äº”ï¼šçº¿ç¨‹ç»“æŸ</h4>
<p>çº¿ç¨‹ä¸­çš„ä»»ä½•æ“ä½œéƒ½å¿…é¡»åœ¨å…¶ä»–çº¿ç¨‹æ£€æµ‹åˆ°è¯¥çº¿ç¨‹å·²ç»ç»“æŸä¹‹å‰æ‰§è¡Œï¼Œæˆ–è€…ä» Thread.join ä¸­æˆåŠŸè¿”å›ï¼Œæˆ–è€…åœ¨è°ƒç”¨ Thread.isAlive æ—¶è¿”å› falseã€‚</p>
<p>è¿™æ¡è§„åˆ™ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œå³çº¿ç¨‹ç»“æŸå‰ï¼Œçº¿ç¨‹å†…çš„ä»»ä½•æ“ä½œéƒ½å·²ç»æ‰§è¡Œï¼Œæ¢è¨€ä¹‹ï¼Œçº¿ç¨‹ç»“æŸåï¼Œçº¿ç¨‹å†…çš„æ“ä½œç»“æœå¯¹åç»­æ“ä½œå¯è§ï¼Œå‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸­çš„æ“ä½œ, å¯ä»¥çœ‹åˆ°çº¿ç¨‹å¯åŠ¨å‰å¯¹å…±äº«å˜é‡çš„æ“ä½œç»“æœ</span></span><br><span class="line">    System.out.println(x);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸­æ“ä½œå…±äº«å˜é‡</span></span><br><span class="line">    x = <span class="number">20</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹å¯åŠ¨å‰æ“ä½œå…±äº«å˜é‡</span></span><br><span class="line">x = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹å¯åŠ¨</span></span><br><span class="line">thread.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹join, ç­‰å¾…çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">thread.join();</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹ä¸­å¯¹å…±äº«å˜é‡çš„æ“ä½œç»“æœæ­¤å¤„å¯è§</span></span><br><span class="line">System.out.println(x);</span><br></pre></td></tr></table></figure>
<h4 id="è§„åˆ™å…­çº¿ç¨‹ä¸­æ–­"><a class="markdownIt-Anchor" href="#è§„åˆ™å…­çº¿ç¨‹ä¸­æ–­"></a> è§„åˆ™å…­ï¼šçº¿ç¨‹ä¸­æ–­</h4>
<p>å½“ä¸€ä¸ªçº¿ç¨‹åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè°ƒç”¨ interrupt æ—¶ï¼Œå¿…é¡»åœ¨è¢«ä¸­æ–­çº¿ç¨‹æ£€æµ‹åˆ° interrupt è°ƒç”¨ä¹‹å‰æ‰§è¡Œï¼ˆé€šè¿‡æŠ›å‡º InterruptedExceptionï¼Œæˆ–è€…è°ƒç”¨ isInterrupted å’Œ interruptedï¼‰ã€‚</p>
<p>è¿™æ¡è§„åˆ™ç¬”è€…ä¸å¤ªç†è§£ï¼Œåªæ˜¯ç†è§£äº†è¡¨é¢æ„æ€å³ï¼šçº¿ç¨‹ A å¯¹çº¿ç¨‹ B interrupt çš„è°ƒç”¨ï¼Œå¿…é¡»åœ¨çº¿ç¨‹ B æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶ä¹‹å‰æ‰§è¡Œã€‚</p>
<h4 id="è§„åˆ™ä¸ƒç»ˆç»“å™¨"><a class="markdownIt-Anchor" href="#è§„åˆ™ä¸ƒç»ˆç»“å™¨"></a> è§„åˆ™ä¸ƒï¼šç»ˆç»“å™¨</h4>
<p>å¯¹è±¡çš„æ„é€ å‡½æ•°å¿…é¡»åœ¨å¯åŠ¨è¯¥å¯¹è±¡çš„ç»ˆç»“å™¨<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>ä¹‹å‰å®Œæˆã€‚</p>
<p>è¿™æ¡è§„åˆ™å¥½ç†è§£ï¼Œå¯ä»¥ç†è§£ä¸º Android Activity çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™é‡Œè¯´çš„æ„é€ å‡½æ•°ä¸ç»ˆç»“å™¨å°±æ˜¯å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè°ƒç”¨ç»ˆç»“å™¨ä¹‹å‰ï¼Œå¯¹è±¡å¿…é¡»å·²ç»åˆå§‹åŒ–ã€‚</p>
<h4 id="è§„åˆ™å…«ä¼ é€’æ€§"><a class="markdownIt-Anchor" href="#è§„åˆ™å…«ä¼ é€’æ€§"></a> è§„åˆ™å…«ï¼šä¼ é€’æ€§</h4>
<p>å¦‚æœæ“ä½œ A åœ¨æ“ä½œ B ä¹‹å‰æ‰§è¡Œï¼Œå¹¶ä¸”æ“ä½œ B åœ¨æ“ä½œ C ä¹‹å‰æ‰§è¡Œï¼Œé‚£ä¹ˆæ“ä½œ A å¿…é¡»åœ¨ æ“ä½œ C ä¹‹å‰æ‰§è¡Œã€‚</p>
<p>çœ‹åˆ°è¿™æ¡è§„åˆ™ï¼Œç¬”è€…ç«Ÿç„¶é¦–å…ˆæƒ³åˆ°äº†ã€Šç§¦æ—¶æ˜æœˆã€‹ä¸­ã€Šç™½é©¬éé©¬ã€‹è¾©è®ºï¼šç™½é©¬ == ä¼ å®¶å®ï¼Œé»‘é©¬ == ä¼ å®¶å®ï¼Œä¼ å®¶å® == ä¼ å®¶å®ï¼Œç™½é©¬ == é»‘é©¬ï¼›æ‰¯è¿œäº†ã€‚</p>
<p>è¿™æ¡è§„åˆ™å¯ä»¥ç†è§£ä¸ºå¤§å°å…³ç³»ï¼Œæ¯”å¦‚ï¼ša å¤§äº bï¼Œb å¤§äº cï¼Œé‚£ä¹ˆ a ä¸€å®šå¤§äº cã€‚</p>
<p>ä¼ é€’æ€§è§„åˆ™å¯ä»¥ä¸å…¶ä»–è§„åˆ™ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œè¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚</p>
<h4 id="å°ç»“"><a class="markdownIt-Anchor" href="#å°ç»“"></a> å°ç»“<sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup></h4>
<p>ä¸Šè¿°è§„åˆ™è™½ç„¶åªæ»¡è¶³ååºå…³ç³»ï¼Œä½†åŒæ­¥æ“ä½œï¼Œå¦‚é”çš„è·å–ä¸é‡Šæ”¾ç­‰æ“ä½œï¼Œä»¥åŠ volatile å˜é‡çš„è¯»å–ä¸å†™å…¥æ“ä½œï¼Œéƒ½æ»¡è¶³å…¨åºå…³ç³»ã€‚å› æ­¤ï¼Œåœ¨æè¿° Happens-Before å…³ç³»æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ â€œåç»­çš„é”è·å–æ“ä½œâ€ å’Œ â€œåç»­çš„ volatile å˜é‡çš„è¯»å–æ“ä½œâ€ ç­‰è¡¨è¾¾æœ¯è¯­ã€‚</p>
<h3 id="final-åŸŸ"><a class="markdownIt-Anchor" href="#final-åŸŸ"></a> final åŸŸ</h3>
<p>åœ¨ Java ä¸­ï¼Œä¸ç®¡æ˜¯åœ¨å†™ç±»ã€å†™å˜é‡è¿˜æ˜¯å†™æ–¹æ³•æ—¶ï¼Œå¤§éƒ¨åˆ†ç¨‹åºå‘˜å¯èƒ½éƒ½ä¼šå¿½è§† <strong>final å…³é”®å­—</strong> çš„ä½œç”¨ï¼Œä»è€Œå¯¼è‡´ä¸€äº›ä¸å¯é¢„è§çš„é—®é¢˜ï¼Œåœ¨ Kotlin ä¸­ç±»å’Œæ–¹æ³•é»˜è®¤æ˜¯ final çš„ï¼Œå£°æ˜å˜é‡æ—¶å»ºè®®ä½¿ç”¨ val ä¿®é¥°è€Œä¸æ˜¯ varã€‚</p>
<p>åœ¨ Java ä¸­åŸºäº final å…³é”®å­—ä¿®é¥°çš„å˜é‡åœ¨å¤šçº¿ç¨‹ä¸­ä¹Ÿæœ‰ä¸å¯å˜çš„ç‰¹æ€§ï¼Œå»ºè®®å°½é‡ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ final æ¥ä¿®é¥°å˜é‡ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>Java å†…å­˜æ¨¡å‹å°±æ˜¯å¯¹ JVM çš„ä¸€ç§è§„èŒƒï¼Œå…¶ä¸­ Happens-Before å®šä¹‰äº†ä¸ç¨‹åºå‘˜ç›¸å…³çš„ä¸€äº›è§„åˆ™ï¼Œå¯ä»¥ç†è§£ä¸º Happens-Before è§„åˆ™æ˜¯åº•å±‚å¯¹ç¨‹åºå‘˜æš´éœ²çš„ä¸€äº›æ¥å£ï¼Œç¨‹åºå‘˜æ­£ç¡®çš„ä½¿ç”¨è¿™äº›æ¥å£å¯ä»¥ç¼–å†™å‡ºæ­£ç¡®çš„ä»£ç ã€‚</p>
<p>Happens-Before è§„åˆ™å¯ä»¥è¯´æ˜¯å¼ºåˆ¶è§„å®šäº†ä»£ç çš„ä¸€äº›æ‰§è¡Œé¡ºåºï¼ŒåŒæ—¶è¡¨è¾¾å‡º <strong>åç»­æ“ä½œå¯ä»¥çœ‹è§å‰é¢ä¸€ä¸ªæ“ä½œçš„ç»“æœ</strong></p>
<p>å¯¹ Java å†…å­˜æ¨¡å‹çš„å­¦ä¹ ï¼Œæœ‰åŠ©äºåˆ†æè§£å†³é‡åˆ°çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œç†è§£çº¿ç¨‹å®‰å…¨é—®é¢˜å‡ºç°çš„åŸå› ï¼Œä»¥åŠé‡å¡‘è‡ªå·±çš„ç¼–ç¨‹æ€æƒ³ã€‚</p>
<p>ç¬”è€…è®¤ä¸ºæœ€é‡è¦çš„æ˜¯é‡å¡‘è‡ªå·±çš„ç¼–ç¨‹æ€æƒ³ï¼Œä¿—è¯è¯´ â€œè¯»ä¹¦ç ´ä¸‡å·, ä¸‹ç¬”å¦‚æœ‰ç¥â€ï¼Œç†è§£åŸç†ï¼ŒæŒæ¡è§„åˆ™ï¼Œé‡å¡‘æ€æƒ³åï¼Œæ‰èƒ½åœ¨ç¼–ç æ—¶å†™å‡º â€œBugâ€(ç‹—å¤´ä¿å‘½)ã€‚</p>
<p>Java å¹¶å‘ç¼–ç¨‹å±å®éš¾ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œè¿˜è¯·ä¸åèµæ•™ã€‚</p>
<h2 id="è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®"></a> è¯´æ˜ä¸å‚è€ƒæ–‡çŒ®</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬åå…­ç« ã€‹ <a href="#fnref1" class="footnote-backref">â†©ï¸</a> <a href="#fnref1:1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p>ååºå…³ç³» Ï€ æ˜¯é›†åˆä¸Šçš„ä¸€ç§å…³ç³»ï¼Œå…·æœ‰åå¯¹ç§°ã€è‡ªåå’Œä¼ é€’å±æ€§ <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p>æ˜¾ç¤ºé”ä¸å†…ç½®é”åœ¨åŠ é”å’Œè§£é”ç­‰æ“ä½œä¸Šæœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ <a href="#fnref3" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p>åŸå­å˜é‡ä¸ volatile å˜é‡åœ¨è¯»/å†™æ“ä½œä¸Šæœ‰ç›¸åŒçš„è¯­ä¹‰ <a href="#fnref4" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="http://ifeve.com/jmm-faq-volatile/">Javaå†…å­˜æ¨¡å‹FAQï¼ˆåï¼‰volatileæ˜¯å¹²ä»€ä¹ˆç”¨çš„</a> <a href="#fnref5" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://www.infoq.cn/article/java-memory-model-4">æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆå››ï¼‰â€”â€”volatile</a> <a href="#fnref6" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn7" class="footnote-item"><p>å³ finalize() æ–¹æ³• <a href="#fnref7" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>java</tag>
        <tag>concurrent</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹-å‘å¸ƒä¸é€¸å‡º</title>
    <url>/2022/07/19/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E5%8F%91%E5%B8%83%E4%B8%8E%E9%80%B8%E5%87%BA/</url>
    <content><![CDATA[<h1 id="javaå¹¶å‘ç¼–ç¨‹-å‘å¸ƒä¸é€¸å‡º"><a class="markdownIt-Anchor" href="#javaå¹¶å‘ç¼–ç¨‹-å‘å¸ƒä¸é€¸å‡º"></a> Javaå¹¶å‘ç¼–ç¨‹-å‘å¸ƒä¸é€¸å‡º</h1>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>Java å¹¶å‘ç¼–ç¨‹å±å®éš¾ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œè¿˜è¯·ä¸åèµæ•™ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>java</tag>
        <tag>concurrent</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-KCPçš„åº”ç”¨-ä¿®æ”¹SDKç‰ˆæœ¬å·</title>
    <url>/2022/05/23/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E4%BF%AE%E6%94%B9SDK%E7%89%88%E6%9C%AC%E5%8F%B7/</url>
    <content><![CDATA[<h1 id="kotlin-kcpçš„åº”ç”¨-ä¿®æ”¹sdkç‰ˆæœ¬å·"><a class="markdownIt-Anchor" href="#kotlin-kcpçš„åº”ç”¨-ä¿®æ”¹sdkç‰ˆæœ¬å·"></a> Kotlin-KCPçš„åº”ç”¨-ä¿®æ”¹SDKç‰ˆæœ¬å·</h1>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>åœ¨ SDK å¼€å‘ä¸­ï¼Œä¸€èˆ¬ä¼šæš´éœ²è·å– SDK ç‰ˆæœ¬å·çš„æ¥å£ï¼Œè·å–çš„ç‰ˆæœ¬å·ä¸€èˆ¬ä¸º String ç±»å‹ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sdkæ¥å£</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Sdk</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getVersion</span><span class="params">()</span></span>: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sdkè°ƒç”¨æ–¹</span></span><br><span class="line">sdk.getVersion()</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ–¹å¼å¯ä»¥é€šè¿‡åœ¨ <code>gradle.properties</code> ä¸­é…ç½®ç‰ˆæœ¬å·ï¼Œç„¶ååœ¨ <code>build.gradle</code> ä¸­è¯»å–ç‰ˆæœ¬å·ç”Ÿæˆè‡³ <code>BuildConfig.java</code> ä¸­ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gradle.properties</span></span><br><span class="line">VERSION=<span class="number">1.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// builde.gradle</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;SDK_VERSION&quot;</span>, <span class="string">&quot;\&quot;$VERSION\&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SdkImple.kt</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SdkImpl</span> : Sdk &#123;</span><br><span class="line">    override fun getVersion(): String &#123;</span><br><span class="line">        <span class="comment">// è¿”å› BuildConfig ä¸­çš„ SDK_VERSION</span></span><br><span class="line">        <span class="keyword">return</span> BuildConfig.SDK_VERSION</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ–¹å¼åœ¨ SDK å‘ç‰ˆæ—¶åªéœ€ä¿®æ”¹ <code>gradle.properties</code> ä¸­çš„ç‰ˆæœ¬å·å³å¯</p>
<p>ä½†æ˜¯ä¸Šè¿°æ–¹å¼æœ‰ä¸€ä¸ªå¼Šç«¯ï¼šSDK æä¾›çš„ç‰ˆæœ¬å·ä¸º String ç±»å‹ï¼Œç¬¬ä¸‰æ–¹æ ¹æ®ç‰ˆæœ¬å·è¿›è¡Œé€‚é…å¼€å‘æ—¶ä¸å¤ªæ–¹ä¾¿ï¼Œç¬¬ä¸‰æ–¹éœ€è¦è‡ªå·±å®ç°ç‰ˆæœ¬å·å¤§å°çš„åˆ¤æ–­ï¼Œç¬”è€…å¸Œæœ› SDK è‡ªèº«å¯ä»¥æš´éœ²åˆ¤æ–­ç‰ˆæœ¬å·å¤§å°çš„æ¥å£</p>
<h2 id="æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆ"></a> æ–¹æ¡ˆ</h2>
<p>åŸºäºä¸Šè¿°éœ€æ±‚ï¼ŒSDK æš´éœ²çš„è·å–ç‰ˆæœ¬å·æ¥å£å°±ä¸èƒ½è¿”å› String ç±»å‹äº†ï¼Œ<code>Sdk</code> æ¥å£ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Sdk</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ª Version å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getVersion</span><span class="params">()</span></span>: Version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SdkImpl</span> : <span class="type">Sdk</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getVersion</span><span class="params">()</span></span>: Version &#123;</span><br><span class="line">        <span class="comment">// è¿”å› Version ä¸­çš„ CURRENT</span></span><br><span class="line">        <span class="keyword">return</span> Version.CURRENT</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ <code>Version</code> å¯¹è±¡çš„å®šä¹‰<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼Œç‰ˆæœ¬å·è§„åˆ™ä¸å°½ç›¸åŒï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Version</span> <span class="keyword">internal</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> major: <span class="built_in">Int</span>, <span class="comment">// ä¸»ç‰ˆæœ¬ 1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> minor: <span class="built_in">Int</span>, <span class="comment">// æ¬¡ç‰ˆæœ¬ 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> patch: <span class="built_in">Int</span>, <span class="comment">// è¡¥ä¸ç‰ˆæœ¬ 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> extra: <span class="built_in">Int</span>, <span class="comment">// ä¿ç•™ç‰ˆæœ¬ 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> suffix: String?, <span class="comment">// åç¼€ç‰ˆæœ¬, æ¯”å¦‚ï¼šalpha01ã€beta01</span></span><br><span class="line">) : Comparable&lt;Version&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> version = versionOf(major, minor, patch, extra)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰ˆæœ¬æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">versionOf</span><span class="params">(major: <span class="type">Int</span>, minor: <span class="type">Int</span>, patch: <span class="type">Int</span>, extra: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        require(</span><br><span class="line">            major <span class="keyword">in</span> <span class="number">0.</span>.MAX_COMPONENT_VALUE &amp;&amp;</span><br><span class="line">                    minor <span class="keyword">in</span> <span class="number">0.</span>.MAX_COMPONENT_VALUE &amp;&amp;</span><br><span class="line">                    patch <span class="keyword">in</span> <span class="number">0.</span>.MAX_COMPONENT_VALUE &amp;&amp;</span><br><span class="line">                    extra <span class="keyword">in</span> <span class="number">0.</span>.MAX_COMPONENT_VALUE</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="string">&quot;Version components are out of range: <span class="variable">$major</span>.<span class="variable">$minor</span>.<span class="variable">$patch</span>.<span class="variable">$extra</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> major.shl(<span class="number">24</span>) + minor.shl(<span class="number">16</span>) + patch.shl(<span class="number">8</span>) + extra</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String =</span><br><span class="line">        <span class="keyword">if</span> (suffix.isNullOrEmpty()) <span class="string">&quot;<span class="variable">$major</span>.<span class="variable">$minor</span>.<span class="variable">$patch</span>.<span class="variable">$extra</span>&quot;</span> <span class="keyword">else</span> <span class="string">&quot;<span class="variable">$major</span>.<span class="variable">$minor</span>.<span class="variable">$patch</span>.<span class="variable">$extra</span>-<span class="variable">$suffix</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> === other) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">val</span> otherVersion = (other <span class="keyword">as</span>? Version) ?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.version == otherVersion.version</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hashCode</span><span class="params">()</span></span>: <span class="built_in">Int</span> = version</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰ˆæœ¬æ¯”è¾ƒ1</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">compareTo</span><span class="params">(other: <span class="type">Version</span>)</span></span>: <span class="built_in">Int</span> = version - other.version</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰ˆæœ¬æ¯”è¾ƒ2</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isAtLeast</span><span class="params">(major: <span class="type">Int</span>, minor: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> =</span><br><span class="line">        <span class="keyword">this</span>.major &gt; major || (<span class="keyword">this</span>.major == major &amp;&amp;</span><br><span class="line">                <span class="keyword">this</span>.minor &gt;= minor)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰ˆæœ¬æ¯”è¾ƒ2</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isAtLeast</span><span class="params">(major: <span class="type">Int</span>, minor: <span class="type">Int</span>, patch: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> =</span><br><span class="line">        <span class="keyword">this</span>.major &gt; major || (<span class="keyword">this</span>.major == major &amp;&amp;</span><br><span class="line">                (<span class="keyword">this</span>.minor &gt; minor || <span class="keyword">this</span>.minor == minor &amp;&amp;</span><br><span class="line">                        <span class="keyword">this</span>.patch &gt;= patch))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰ˆæœ¬æ¯”è¾ƒ2</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isAtLeast</span><span class="params">(major: <span class="type">Int</span>, minor: <span class="type">Int</span>, patch: <span class="type">Int</span>, extra: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> =</span><br><span class="line">        <span class="keyword">this</span>.major &gt; major || (<span class="keyword">this</span>.major == major &amp;&amp;</span><br><span class="line">                (<span class="keyword">this</span>.minor &gt; minor || <span class="keyword">this</span>.minor == minor &amp;&amp;</span><br><span class="line">                        (<span class="keyword">this</span>.patch &gt; patch || <span class="keyword">this</span>.patch == patch &amp;&amp;</span><br><span class="line">                                <span class="keyword">this</span>.extra &gt;= extra)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keyword">val</span> MAX_COMPONENT_VALUE = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰ç‰ˆæœ¬</span></span><br><span class="line">        <span class="meta">@JvmField</span></span><br><span class="line">        <span class="keyword">val</span> CURRENT: Version = VersionCurrentValue.<span class="keyword">get</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">object</span> VersionCurrentValue &#123;</span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">()</span></span>: Version =</span><br><span class="line">        Version(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>) <span class="comment">// value is written here automatically during build</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰æ–¹è¿›è¡Œç‰ˆæœ¬é€‚é…å¼€å‘æ—¶ï¼Œå¯ä»¥å¦‚ä¸‹æ“ä½œï¼Œå°±æ¯”è¾ƒæ–¹ä¾¿äº†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> version = sdk.getVersion()</span><br><span class="line">println(<span class="string">&quot;version = <span class="variable">$version</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (version.isAtLeast(<span class="number">1</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// å½“å‰ç‰ˆæœ¬å¤§äºç­‰äº 1.2.0.0</span></span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰ç‰ˆæœ¬å°äº 1.2.0.0</span></span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ–¹æ¡ˆæ˜¯ä¸æ˜¯æ¯”è¾ƒå‹å¥½äº†ï¼Ÿ:happy:ï¼Œä¸çŸ¥é“è¯»è€…æœ‰æ²¡æœ‰å‘ç°ï¼Œåœ¨å“ªé‡Œä¿®æ”¹ç‰ˆæœ¬å·å‘¢ï¼Ÿ</p>
<p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½å·²ç»å‘ç°ï¼Œ<code>Version.CURRENT</code> æ˜¯è°ƒç”¨çš„ <code>VersionCurrentValue#get()</code> æ–¹æ³•ï¼Œ<code>VersionCurrentValue#get()</code> æ–¹æ³•ä¼šåˆ›å»º <code>Version</code> å¯¹è±¡çš„å®ä¾‹ï¼Œåªéœ€è¦ä¿®æ”¹ <code>VersionCurrentValue#get()</code> æ–¹æ³•ä¼ å…¥ç‰ˆæœ¬å·å³å¯ã€‚ç­‰ä¸‹ï¼Œæ¯æ¬¡å‘ç‰ˆæ—¶éƒ½è¦ä¿®æ”¹ <code>VersionCurrentValue#get()</code> æ–¹æ³•ï¼Ÿ</p>
<p>éšéšæ„Ÿè§‰åˆ°ä¸€ä¸ä¸å¦¥ï¼Œè¦æ˜¯å“ªæ¬¡å‘ç‰ˆæ—¶å¿˜è®°ä¿®æ”¹ <code>VersionCurrentValue#get()</code> æ–¹æ³•ï¼Œè¿™ä¸æƒ¨äº†ğŸ˜¢</p>
<p>â€œäººéåœ£è´¤å­°èƒ½æ— è¿‡â€ å‘¢ï¼Œè¿˜æ˜¯è®©ç¨‹åºå¸®æˆ‘ä»¬ç”Ÿæˆç‰ˆæœ¬å·å§ï¼ŒåŒæ—¶å…¼å®¹æ–¹æ¡ˆä¸€ï¼šåªä¿®æ”¹ <code>gradle.properties</code> å³å¯</p>
<p>ä½¿ç”¨ KCP åœ¨ç¼–è¯‘é˜¶æ®µä¿®æ”¹ <code>VersionCurrentValue#get()</code> æ–¹æ³•</p>
<h2 id="å®ç°"><a class="markdownIt-Anchor" href="#å®ç°"></a> å®ç°</h2>
<p>åœ¨ä¸Šç¯‡ <a href="https://juejin.cn/post/7096720525799473165">Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡</a> ä¸­ç¬”è€…è®°å½•äº†æ­å»º KCP ç¯å¢ƒçš„åŸºæœ¬æ­¥éª¤ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å…ˆçœ‹ä¸‹ä¸Šç¯‡æ–‡ç« </p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202205222241364.png" alt="image-20220522224118965" /></p>
<p>ä¸Šå›¾æ˜¯æœ¬é¡¹ç›®çš„ç»„ç»‡æ¶æ„ï¼Œç®€å•ä»‹ç»ä¸‹ï¼š</p>
<ul>
<li>
<p>sampleï¼šåŒ…å« <code>Version</code> åŠæµ‹è¯•ç±»</p>
</li>
<li>
<p>version-plugin-gradleï¼škcp ä¸­çš„ gradle plugin éƒ¨åˆ†</p>
</li>
<li>
<p>version-plugin-kotlinï¼škcp ä¸­çš„ kotlin compiler plugin éƒ¨åˆ†</p>
</li>
</ul>
<p>sample æ¨¡å—ä¸åšä»‹ç»ï¼Œä¸‹é¢ä¸»è¦å®ç°å…¶ä»–ä¸¤ä¸ªæ¨¡å—</p>
<h3 id="buildgradlekts-project-level"><a class="markdownIt-Anchor" href="#buildgradlekts-project-level"></a> build.gradle.kts - project level</h3>
<p>åœ¨é¡¹ç›®çº§åˆ«çš„ build.gradle.kts è„šæœ¬ä¸­é…ç½®æ’ä»¶ä¾èµ–</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ID</span></span><br><span class="line">    extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>] = <span class="string">&quot;com.guodong.android.version.kcp&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;1.5.31&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½® Gradle å‘å¸ƒæ’ä»¶ï¼Œå¯ä»¥ä¸å†å†™ META-INF</span></span><br><span class="line">    id(<span class="string">&quot;com.gradle.plugin-publish&quot;</span>) version <span class="string">&quot;0.16.0&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½®ç”Ÿæˆ BuildConfig æ’ä»¶</span></span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>) version <span class="string">&quot;3.0.3&quot;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶ç‰ˆæœ¬</span></span><br><span class="line">    version = <span class="string">&quot;0.0.1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="version-plugin-gradle"><a class="markdownIt-Anchor" href="#version-plugin-gradle"></a> version-plugin-gradle</h3>
<p>é¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p>
<h4 id="buildgradlekts-module-level"><a class="markdownIt-Anchor" href="#buildgradlekts-module-level"></a> build.gradle.kts - module level</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id(<span class="string">&quot;java-gradle-plugin&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(kotlin(<span class="string">&quot;gradle-plugin-api&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildConfig &#123;</span><br><span class="line">    <span class="comment">// é…ç½® BuildConfig çš„åŒ…å</span></span><br><span class="line">    packageName(<span class="string">&quot;com.guodong.android.version.kcp.plugin.gradle&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_ID&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>]&#125;</span>\&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ GroupId</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_GROUP&quot;</span>, <span class="string">&quot;\&quot;com.guodong.android\&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ ArtifactId</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_NAME&quot;</span>, <span class="string">&quot;\&quot;version-kcp-kotlin-plugin\&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ Version</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_VERSION&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;project.version&#125;</span>\&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradlePlugin &#123;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        create(<span class="string">&quot;Version&quot;</span>) &#123;</span><br><span class="line">            id = rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>] <span class="keyword">as</span> String <span class="comment">// `apply plugin: &quot;com.guodong.android.version.kcp&quot;`</span></span><br><span class="line">            displayName = <span class="string">&quot;Version Kcp&quot;</span></span><br><span class="line">            description = <span class="string">&quot;Version Kcp&quot;</span></span><br><span class="line">            implementationClass = <span class="string">&quot;com.guodong.android.version.kcp.gradle.VersionGradlePlugin&quot;</span> <span class="comment">// æ’ä»¶å…¥å£ç±»</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType&lt;KotlinCompile&gt; &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versiongradleplugin"><a class="markdownIt-Anchor" href="#versiongradleplugin"></a> VersionGradlePlugin</h4>
<p>åˆ›å»º <code>VersionGradlePlugin</code> å®ç° <code>KotlinCompilerPluginSupportPlugin</code> æ¥å£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionGradlePlugin</span> : <span class="type">KotlinCompilerPluginSupportPlugin</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(target: <span class="type">Project</span>)</span></span>: <span class="built_in">Unit</span> = with(target) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Welcome to guodongAndroid-version kcp gradle plugin.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¤å¤„é…ç½® Gradle æ’ä»¶æ‰©å±•</span></span><br><span class="line">        extensions.create(<span class="string">&quot;version&quot;</span>, VersionExtension::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦é€‚ç”¨, é»˜è®¤True</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isApplicable</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– Kotlin æ’ä»¶å”¯ä¸€ID</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCompilerPluginId</span><span class="params">()</span></span>: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– Kotlin æ’ä»¶ Maven åæ ‡ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPluginArtifact</span><span class="params">()</span></span>: SubpluginArtifact = SubpluginArtifact(</span><br><span class="line">        groupId = BuildConfig.KOTLIN_PLUGIN_GROUP,</span><br><span class="line">        artifactId = BuildConfig.KOTLIN_PLUGIN_NAME,</span><br><span class="line">        version = BuildConfig.KOTLIN_PLUGIN_VERSION</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– Gradle æ’ä»¶æ‰©å±•ä¿¡æ¯å¹¶å†™å…¥ SubpluginOption</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyToCompilation</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: Provider&lt;List&lt;SubpluginOption&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> project = kotlinCompilation.target.project</span><br><span class="line">        <span class="keyword">val</span> extension = project.extensions.getByType(VersionExtension::<span class="keyword">class</span>.java)</span><br><span class="line">        <span class="keyword">return</span> project.provider &#123;</span><br><span class="line">            listOf(</span><br><span class="line">                SubpluginOption(key = <span class="string">&quot;version&quot;</span>, value = extension.version)</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºç‰ˆæœ¬å·éœ€è¦åœ¨å¤–éƒ¨é…ç½®ä¼ å…¥ Gradle Pluginï¼Œè¿™é‡Œéœ€è¦åˆ›å»º VersionExtensionï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">VersionExtension</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> version: String = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;VersionExtension(version=<span class="variable">$version</span>)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ Gradle æ’ä»¶ç¼–å†™å®Œæˆ</p>
<h3 id="version-plugin-kotlin"><a class="markdownIt-Anchor" href="#version-plugin-kotlin"></a> version-plugin-kotlin</h3>
<p>æ¥ä¸‹æ¥ç¼–å†™ Kotlin ç¼–è¯‘å™¨æ’ä»¶ï¼Œé¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p>
<h4 id="buildgradlekts-module-level-2"><a class="markdownIt-Anchor" href="#buildgradlekts-module-level-2"></a> build.gradle.kts - module level</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;kapt&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// ä¾èµ– Kotlin ç¼–è¯‘å™¨åº“</span></span><br><span class="line">    compileOnly(<span class="string">&quot;org.jetbrains.kotlin:kotlin-compiler-embeddable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾èµ– Google auto service</span></span><br><span class="line">    kapt(<span class="string">&quot;com.google.auto.service:auto-service:1.0&quot;</span>)</span><br><span class="line">    compileOnly(<span class="string">&quot;com.google.auto.service:auto-service-annotations:1.0&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildConfig &#123;</span><br><span class="line">    <span class="comment">// é…ç½® BuildConfig çš„åŒ…å</span></span><br><span class="line">    packageName(<span class="string">&quot;com.guodong.android.version.kcp.plugin.kotlin&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_ID&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>]&#125;</span>\&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType&lt;KotlinCompile&gt; &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versioncommandlineprocessor"><a class="markdownIt-Anchor" href="#versioncommandlineprocessor"></a> VersionCommandLineProcessor</h4>
<p>å®ç° <code>CommandLineProcessor</code></p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(CommandLineProcessor::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VersionCommandLineProcessor</span> : <span class="type">CommandLineProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="comment">// OptionName å¯¹åº” VersionGradlePlugin#applyToCompilation() ä¼ å…¥çš„ Key</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> OPTION_VERSION = <span class="string">&quot;version&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ConfigurationKey</span></span><br><span class="line">        <span class="keyword">val</span> ARG_VERSION = CompilerConfigurationKey&lt;String&gt;(OPTION_VERSION)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginId: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– `SubpluginOptions` å‚æ•°ï¼Œå¹¶å†™å…¥ `CliOption`</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginOptions: Collection&lt;AbstractCliOption&gt; = listOf(</span><br><span class="line">        CliOption(</span><br><span class="line">            optionName = OPTION_VERSION,</span><br><span class="line">            valueDescription = <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            description = <span class="string">&quot;version string&quot;</span>,</span><br><span class="line">            required = <span class="literal">true</span>,</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç† `CliOption` å†™å…¥ `CompilerConfiguration`</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">processOption</span><span class="params">(option: <span class="type">AbstractCliOption</span>, value: <span class="type">String</span>, configuration: <span class="type">CompilerConfiguration</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (option.optionName) &#123;</span><br><span class="line">            OPTION_VERSION -&gt; configuration.put(ARG_VERSION, value)</span><br><span class="line">            <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Unexpected config option <span class="subst">$&#123;option.optionName&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versioncomponentregistrar"><a class="markdownIt-Anchor" href="#versioncomponentregistrar"></a> VersionComponentRegistrar</h4>
<p>å®ç° <code>ComponentRegistrar</code></p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(ComponentRegistrar::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VersionComponentRegistrar</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> defaultVersion: String,</span><br><span class="line">) : ComponentRegistrar &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keyword">val</span> DEFAULT_VERSION = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Suppress(<span class="string">&quot;unused&quot;</span>)</span> <span class="comment">// Used by service loader</span></span><br><span class="line">    <span class="keyword">constructor</span>() : <span class="keyword">this</span>(DEFAULT_VERSION)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerProjectComponents</span><span class="params">(project: <span class="type">MockProject</span>, configuration: <span class="type">CompilerConfiguration</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—¥å¿—æ”¶é›†å™¨</span></span><br><span class="line">        <span class="keyword">val</span> messageCollector = configuration.<span class="keyword">get</span>(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY, MessageCollector.NONE)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–ä¼ å…¥çš„ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">val</span> version = configuration.<span class="keyword">get</span>(VersionCommandLineProcessor.ARG_VERSION, defaultVersion)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºæ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// CompilerMessageSeverity.INFO - æ²¡æœ‰çœ‹åˆ°æ—¥å¿—è¾“å‡º</span></span><br><span class="line">        <span class="comment">// CompilerMessageSeverity.ERROR - ç¼–è¯‘è¿‡ç¨‹åœæ­¢æ‰§è¡Œ</span></span><br><span class="line">        messageCollector.report(CompilerMessageSeverity.STRONG_WARNING, <span class="string">&quot;Welcome to guodongAndroid-version kcp kotlin plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤å¤„åœ¨ `ClassBuilderInterceptorExtension` ä¸­æ³¨å†Œæ‰©å±•</span></span><br><span class="line">        ClassBuilderInterceptorExtension.registerExtension(</span><br><span class="line">            project,</span><br><span class="line">            VersionClassGenerationInterceptor(</span><br><span class="line">                messageCollector = messageCollector,</span><br><span class="line">                <span class="comment">// ä¼ å…¥ç‰ˆæœ¬å·</span></span><br><span class="line">                version = version</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versionclassgenerationinterceptor"><a class="markdownIt-Anchor" href="#versionclassgenerationinterceptor"></a> VersionClassGenerationInterceptor</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionClassGenerationInterceptor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> version: String,</span><br><span class="line">) : ClassBuilderInterceptorExtension &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¦æˆª ClassBuilderFactory</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">interceptClassBuilderFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        interceptedFactory: <span class="type">ClassBuilderFactory</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bindingContext: <span class="type">BindingContext</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        diagnostics: <span class="type">DiagnosticSink</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// è‡ªå®šä¹‰ ClassBuilderFactory å§”æ‰˜ç»™ æºClassBuilderFactory</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: ClassBuilderFactory = <span class="keyword">object</span> : ClassBuilderFactory <span class="keyword">by</span> interceptedFactory &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤å†™ newClassBuilder</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newClassBuilder</span><span class="params">(origin: <span class="type">JvmDeclarationOrigin</span>)</span></span>: ClassBuilder &#123;</span><br><span class="line">            <span class="comment">// è‡ªå®šä¹‰ ClassBuilder</span></span><br><span class="line">            <span class="keyword">return</span> VersionClassBuilder(</span><br><span class="line">                messageCollector = messageCollector,</span><br><span class="line">                <span class="comment">// ä¼ å…¥ç‰ˆæœ¬å·</span></span><br><span class="line">                version = version,</span><br><span class="line">                <span class="comment">// ä¼ å…¥æºClassBuilder</span></span><br><span class="line">                delegate = interceptedFactory.newClassBuilder(origin),</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versionclassbuilder"><a class="markdownIt-Anchor" href="#versionclassbuilder"></a> VersionClassBuilder</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionClassBuilder</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> version: String,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> delegate: ClassBuilder,</span><br><span class="line">) : DelegatingClassBuilder() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> VERSION_NAME = <span class="string">&quot;com/guodong/android/VersionCurrentValue&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> MIN_COMPONENT_VALUE = <span class="number">0</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> MAX_COMPONENT_VALUE = <span class="number">255</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDelegate</span><span class="params">()</span></span>: ClassBuilder &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        origin: <span class="type">JvmDeclarationOrigin</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        access: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        desc: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        signature: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        exceptions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: MethodVisitor &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> original = <span class="keyword">super</span>.newMethod(origin, access, name, desc, signature, exceptions)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> thisName = delegate.thisName</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ ¡éªŒVersionCurrentValueçš„å®Œå…¨é™å®šå</span></span><br><span class="line">        <span class="keyword">if</span> (thisName != VERSION_NAME) &#123;</span><br><span class="line">            <span class="keyword">return</span> original</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ¡éªŒæ˜¯å¦åœ¨`build.gradle`ä¸­è®¾ç½®äº†ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">if</span> (version == VersionComponentRegistrar.DEFAULT_VERSION) &#123;</span><br><span class="line">            messageCollector.report(</span><br><span class="line">                CompilerMessageSeverity.ERROR,</span><br><span class="line">                <span class="string">&quot;Missing version, need to set version in build.gradle, like this:\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;version &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;\tversion = \&quot;1.0.0.0\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»“æ„ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">val</span> (major, minor, patch, extra, suffix) = parseVersion()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿”å›ASM MethodVisitor</span></span><br><span class="line">        <span class="keyword">return</span> VersionMethodVisitor(Opcodes.ASM9, original, major, minor, patch, extra, suffix)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æç‰ˆæœ¬å·ä¸º`Multiple`</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">parseVersion</span><span class="params">()</span></span>: Multiple&lt;<span class="built_in">Int</span>, <span class="built_in">Int</span>, <span class="built_in">Int</span>, <span class="built_in">Int</span>, String?&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (version.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Version must not be empty.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> major: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> minor: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> patch: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> extra: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> suffix: String?</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (version.contains(<span class="string">&quot;-&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">val</span> split = version.split(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (split.size != <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Version components must be only contains one `-`.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> versions = split[<span class="number">0</span>].split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">val</span> length = versions.size</span><br><span class="line">            <span class="keyword">if</span> (length != <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Version components must be four digits, it is [ <span class="variable">$version</span> ] now.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                major = versions[<span class="number">0</span>].toInt()</span><br><span class="line">                minor = versions[<span class="number">1</span>].toInt()</span><br><span class="line">                patch = versions[<span class="number">2</span>].toInt()</span><br><span class="line">                extra = versions[<span class="number">3</span>].toInt()</span><br><span class="line">                suffix = split[<span class="number">1</span>]</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: NumberFormatException) &#123;</span><br><span class="line">                <span class="keyword">val</span> errMsg = <span class="string">&quot;Version components must consist of numbers.&quot;</span></span><br><span class="line">                <span class="keyword">val</span> exception = IllegalArgumentException(errMsg)</span><br><span class="line">                exception.addSuppressed(e)</span><br><span class="line">                <span class="keyword">throw</span> exception</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> versions = version.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">val</span> length = versions.size</span><br><span class="line">            <span class="keyword">if</span> (length != <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Version components must be four digits, it is [ <span class="variable">$version</span> ] now.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                major = versions[<span class="number">0</span>].toInt()</span><br><span class="line">                minor = versions[<span class="number">1</span>].toInt()</span><br><span class="line">                patch = versions[<span class="number">2</span>].toInt()</span><br><span class="line">                extra = versions[<span class="number">3</span>].toInt()</span><br><span class="line">                suffix = <span class="literal">null</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: NumberFormatException) &#123;</span><br><span class="line">                <span class="keyword">val</span> errMsg = <span class="string">&quot;Version components must consist of numbers.&quot;</span></span><br><span class="line">                <span class="keyword">val</span> exception = IllegalArgumentException(errMsg)</span><br><span class="line">                exception.addSuppressed(e)</span><br><span class="line">                <span class="keyword">throw</span> exception</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (suffix.isNullOrEmpty()) &#123;</span><br><span class="line">            messageCollector.report(</span><br><span class="line">                CompilerMessageSeverity.WARNING,</span><br><span class="line">                String.format(Locale.CHINA, <span class="string">&quot;version = %d.%d.%d.%d&quot;</span>, major, minor, patch, extra)</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            messageCollector.report(</span><br><span class="line">                CompilerMessageSeverity.WARNING,</span><br><span class="line">                String.format(Locale.CHINA, <span class="string">&quot;version = %d.%d.%d.%d-%s&quot;</span>, major, minor, patch, extra, suffix)</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (checkVersion(major) || checkVersion(minor) || checkVersion(patch) || checkVersion(extra)) &#123;</span><br><span class="line">            <span class="keyword">val</span> msg = String.format(</span><br><span class="line">                Locale.CHINA,</span><br><span class="line">                <span class="string">&quot;Version components are out of range: %d.%d.%d.%d.&quot;</span>,</span><br><span class="line">                major,</span><br><span class="line">                minor,</span><br><span class="line">                patch,</span><br><span class="line">                extra</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(msg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Multiple(major, minor, patch, extra, suffix)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkVersion</span><span class="params">(version: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> version &lt; MIN_COMPONENT_VALUE || version &gt; MAX_COMPONENT_VALUE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="multiple"><a class="markdownIt-Anchor" href="#multiple"></a> Multiple</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Multiple</span>&lt;<span class="type">out A, out B, out C, out D, out E</span>&gt;(</span><br><span class="line">    <span class="keyword">val</span> first: A,</span><br><span class="line">    <span class="keyword">val</span> second: B,</span><br><span class="line">    <span class="keyword">val</span> third: C,</span><br><span class="line">    <span class="keyword">val</span> fourth: D,</span><br><span class="line">    <span class="keyword">val</span> fifth: E?</span><br><span class="line">) : Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">&quot;(<span class="variable">$first</span>, <span class="variable">$second</span>, <span class="variable">$third</span>, <span class="variable">$fourth</span>, <span class="variable">$fifth</span>)&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="versionmethodvisitor"><a class="markdownIt-Anchor" href="#versionmethodvisitor"></a> VersionMethodVisitor</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionMethodVisitor</span>(</span><br><span class="line">    api: <span class="built_in">Int</span>,</span><br><span class="line">    mv: MethodVisitor,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> major: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> minor: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> patch: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> extra: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> suffix: String?</span><br><span class="line">) : MethodPatternAdapter(api, mv) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="comment">// çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> SEEN_ICONST_0 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> SEEN_ICONST_0_ICONST_0 = <span class="number">2</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> SEEN_ICONST_0_ICONST_0_ICONST_0 = <span class="number">3</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0 = <span class="number">4</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0_ACONST_NULL = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Versionå®Œå…¨é™å®šå</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> OWNER = <span class="string">&quot;com/guodong/android/Version&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> METHOD_NAME = <span class="string">&quot;&lt;init&gt;&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> METHOD_DESCRIPTOR = <span class="string">&quot;(IIIILjava/lang/String;)V&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * val version = Version(0, 0, 0, 0, null)</span></span><br><span class="line"><span class="comment">     * ICONST_0</span></span><br><span class="line"><span class="comment">     * ICONST_0</span></span><br><span class="line"><span class="comment">     * ICONST_0</span></span><br><span class="line"><span class="comment">     * ICONST_0</span></span><br><span class="line"><span class="comment">     * ACONST_NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visitInsn</span><span class="params">(opcode: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// çŠ¶æ€æœº</span></span><br><span class="line">        <span class="keyword">when</span> (state) &#123;</span><br><span class="line">            SEEN_NOTHING -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ICONST_0) &#123;</span><br><span class="line">                    state = SEEN_ICONST_0</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0 -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ICONST_0) &#123;</span><br><span class="line">                    state = SEEN_ICONST_0_ICONST_0</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ICONST_0) &#123;</span><br><span class="line">                    state = SEEN_ICONST_0_ICONST_0_ICONST_0</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ICONST_0) &#123;</span><br><span class="line">                    state = SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ACONST_NULL) &#123;</span><br><span class="line">                    state = SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0_ACONST_NULL</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0_ACONST_NULL -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == Opcodes.ACONST_NULL) &#123;</span><br><span class="line">                    mv.visitInsn(opcode)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.visitInsn(opcode)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visitMethodInsn</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        opcode: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        owner: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        descriptor: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        isInterface: <span class="type">Boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> flag = opcode == Opcodes.INVOKESPECIAL</span><br><span class="line">        &amp;&amp; OWNER == owner</span><br><span class="line">        &amp;&amp; METHOD_NAME == name</span><br><span class="line">        &amp;&amp; METHOD_DESCRIPTOR == descriptor</span><br><span class="line"></span><br><span class="line">        <span class="keyword">when</span> (state) &#123;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0_ACONST_NULL -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                    weaveCode(major)</span><br><span class="line">                    weaveCode(minor)</span><br><span class="line">                    weaveCode(patch)</span><br><span class="line">                    weaveCode(extra)</span><br><span class="line">                    weaveSuffix()</span><br><span class="line">                    state = SEEN_NOTHING</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¥å‘</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visitInsn</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (state) &#123;</span><br><span class="line">            SEEN_ICONST_0 -&gt; &#123;</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0 -&gt; &#123;</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">            &#125;</span><br><span class="line">            SEEN_ICONST_0_ICONST_0_ICONST_0_ICONST_0_ACONST_NULL -&gt; &#123;</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ICONST_0)</span><br><span class="line">                mv.visitInsn(Opcodes.ACONST_NULL)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        state = SEEN_NOTHING</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‡å…¥ç‰ˆæœ¬å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">weaveCode</span><span class="params">(code: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">            code &lt;= <span class="number">5</span> -&gt; &#123;</span><br><span class="line">                <span class="keyword">val</span> opcode = <span class="keyword">when</span> (code) &#123;</span><br><span class="line">                    <span class="number">0</span> -&gt; Opcodes.ICONST_0</span><br><span class="line">                    <span class="number">1</span> -&gt; Opcodes.ICONST_1</span><br><span class="line">                    <span class="number">2</span> -&gt; Opcodes.ICONST_2</span><br><span class="line">                    <span class="number">3</span> -&gt; Opcodes.ICONST_3</span><br><span class="line">                    <span class="number">4</span> -&gt; Opcodes.ICONST_4</span><br><span class="line">                    <span class="number">5</span> -&gt; Opcodes.ICONST_5</span><br><span class="line">                    <span class="keyword">else</span> -&gt; Opcodes.ICONST_0</span><br><span class="line">                &#125;</span><br><span class="line">                mv.visitInsn(opcode)</span><br><span class="line">            &#125;</span><br><span class="line">            code &lt;= <span class="number">127</span> -&gt; &#123;</span><br><span class="line">                mv.visitIntInsn(Opcodes.BIPUSH, code)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                mv.visitIntInsn(Opcodes.SIPUSH, code)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‡å…¥åç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">weaveSuffix</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (suffix.isNullOrEmpty()) &#123;</span><br><span class="line">            mv.visitInsn(Opcodes.ACONST_NULL)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mv.visitLdcInsn(suffix)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åº”ç”¨"><a class="markdownIt-Anchor" href="#åº”ç”¨"></a> åº”ç”¨</h2>
<h3 id="sample-buildgradlekts"><a class="markdownIt-Anchor" href="#sample-buildgradlekts"></a> sample - build.gradle.kts</h3>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.guodong.android.version.kcp&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">version &#123;</span><br><span class="line">    version = <span class="string">&quot;1.0.0.1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="test"><a class="markdownIt-Anchor" href="#test"></a> Test</h3>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;version = <span class="subst">$&#123;Version.CURRENT&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line">version = <span class="number">1.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>happy~</p>
<h2 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>å‚è€ƒ <code>KotlinVersion.kt</code> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>kcp</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-KCPçš„åº”ç”¨-ç¬¬ä¸€ç¯‡</title>
    <url>/2022/05/08/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E7%AC%AC%E4%B8%80%E7%AF%87/</url>
    <content><![CDATA[<h1 id="kotlin-kcpçš„åº”ç”¨-ç¬¬ä¸€ç¯‡"><a class="markdownIt-Anchor" href="#kotlin-kcpçš„åº”ç”¨-ç¬¬ä¸€ç¯‡"></a> Kotlin-KCPçš„åº”ç”¨-ç¬¬ä¸€ç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>KCPçš„åº”ç”¨è®¡åˆ’åˆ†ä¸¤ç¯‡ï¼Œæœ¬æ–‡æ˜¯ç¬¬ä¸€ç¯‡</p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•ä»å‘ç°é—®é¢˜åˆ°ä½¿ç”¨KCPè§£å†³é—®é¢˜çš„æŠ˜è…¾è¿‡ç¨‹ï¼Œä¸‹ä¸€ç¯‡è®°å½•KCPçš„åº”ç”¨</p>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p><code>Kotlin</code> å·ç§°ç™¾åˆ†ç™¾å…¼å®¹ <code>Java</code> ï¼Œæ‰€ä»¥åœ¨ <code>Kotlin</code> ä¸­ä¸€äº›ä¿®é¥°ç¬¦ï¼Œæ¯”å¦‚ <code>internal</code> ï¼Œåœ¨ç¼–è¯‘åæ”¾åœ¨çº¯ <code>Java</code> çš„é¡¹ç›®ä¸­ä½¿ç”¨(æ²¡æœ‰<code>Kotlin</code>ç¯å¢ƒ)ï¼Œ<code>Java</code> ä»ç„¶å¯ä»¥è®¿é—®è¢« <code>internal</code> ä¿®é¥°çš„ç±»ã€æ–¹æ³•ã€å­—æ®µç­‰</p>
<p>åœ¨ä½¿ç”¨ <code>Kotlin</code> å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦å¯¹å¤–æä¾› <code>SDK</code> åŒ…ï¼Œåœ¨ <code>SDK</code> ä¸­æœ‰ä¸€äº› <code>API</code> ä¸æƒ³è¢«å¤–éƒ¨è°ƒç”¨ï¼Œå¹¶ä¸”å·²ç»æ·»åŠ äº† <code>internal</code> ä¿®é¥°ï¼Œä½†æ˜¯å—é™äºä¸Šè¯‰é—®é¢˜ä¸”ç¬¬ä¸‰æ–¹ä½¿ç”¨ <code>SDK</code> çš„ç¯å¢ƒä¸å¯æ§(ä¸èƒ½è¦æ±‚ç¬¬ä¸‰æ–¹å¿…é¡»ä½¿ç”¨<code>Kotlin</code>)</p>
<p>å¸¦ç€é—®é¢˜Googleä¸€ç•ªï¼ŒæŸ¥åˆ°ä»¥ä¸‹å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä½¿ç”¨ <code>JvmName</code> æ³¨è§£è®¾ç½®ä¸€ä¸ªä¸ç¬¦åˆ <code>Java</code> å‘½åè§„åˆ™çš„æ ‡è¯†ç¬¦<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></li>
<li>ä½¿ç”¨ <code>Ë‹Ë‹</code> åœ¨ <code>Kotlin</code> ä¸­æŠŠä¸€ä¸ªä¸åˆæ³•çš„æ ‡è¯†ç¬¦å¼ºè¡Œåˆæ³•åŒ–<sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup></li>
<li>ä½¿ç”¨ <code>JvmSynthetic</code> æ³¨è§£<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></li>
</ol>
<p>ä»¥ä¸Šæ–¹æ¡ˆå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œä½†æ˜¯ä»¥ä¸Šæ–¹æ¡ˆéƒ½ä¸æ»¡è¶³éšè—æ„é€ æ–¹æ³•ï¼Œå¯èƒ½ä¼šæƒ³ä»€ä¹ˆæƒ…æ™¯ä¸‹éœ€è¦éšè—æ„é€ æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Builder</span>(<span class="keyword">internal</span> <span class="keyword">val</span> a: <span class="built_in">Int</span>, <span class="keyword">internal</span> <span class="keyword">val</span> b: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * non-public constructor for java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">constructor</span>() : <span class="keyword">this</span>(-<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºæ­¤æˆ‘è¿˜æäº†ä¸ªIssue<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>ï¼ŒæœŸæœ›å®˜æ–¹æŠŠ <code>JvmSynthetic</code> çš„ä½œç”¨åŸŸæ‰©å±•åˆ°æ„é€ æ–¹æ³•ï¼Œä¸è¿‡å®˜æ–¹å¥½åƒæ²¡æœ‰æ‰“ç®—å®ç°ğŸ˜‚</p>
<p>ä¸ºè§£å†³éšè—æ„é€ æ–¹æ³•ï¼Œå¯ä»¥æŠŠæ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œå¯¹å¤–æš´éœ²é™æ€å·¥å‚æ–¹æ³•ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Builder</span> <span class="keyword">private</span> <span class="keyword">constructor</span> (<span class="keyword">internal</span> <span class="keyword">val</span> a: <span class="built_in">Int</span>, <span class="keyword">internal</span> <span class="keyword">val</span> b: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * non-public constructor for java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">constructor</span>() : <span class="keyword">this</span>(-<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">newBuilder</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> = Builder(a, b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ¡ˆè¯´å®Œäº†ï¼Œå¤§å®¶æ•£äº†å§ï¼Œæ•£äº†å§~</p>
<p>å¼€ç©ç¬‘ï¼Œå¼€ç©ç¬‘ğŸ˜›ï¼Œå¿…ç„¶è¦æŠ˜è…¾ä¸€ç•ª</p>
<h2 id="æŠ˜è…¾"><a class="markdownIt-Anchor" href="#æŠ˜è…¾"></a> æŠ˜è…¾</h2>
<h3 id="æ¢ç´¢jvmsyntheticå®ç°åŸç†"><a class="markdownIt-Anchor" href="#æ¢ç´¢jvmsyntheticå®ç°åŸç†"></a> æ¢ç´¢<code>JvmSynthetic</code>å®ç°åŸç†</h3>
<p>å…ˆçœ‹ä¸‹ <code>JvmSynthetic</code> æ³¨è§£çš„æ³¨é‡Šæ–‡æ¡£</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Sets `ACC_SYNTHETIC` flag on the annotated target in the Java bytecode.</span><br><span class="line"> *</span><br><span class="line"> * Synthetic targets become inaccessible for Java sources at compile time while still being accessible for Kotlin sources.</span><br><span class="line"> * Marking target as synthetic is a binary compatible change, already compiled Java code will be able to access such target.</span><br><span class="line"> *</span><br><span class="line"> * This annotation is intended for *rare cases* when API designer needs to hide Kotlin-specific target from Java API</span><br><span class="line"> * while keeping it a part of Kotlin API so the resulting API is idiomatic for both languages.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>å¥½å®¶ä¼™ï¼Œå®ç°åŸç†éƒ½è¯´äº†ï¼šåœ¨ <code>Java</code> å­—èŠ‚ç ä¸­çš„æ³¨è§£ç›®æ ‡ä¸Šè®¾ç½® <code>ACC_SYNTHETIC</code> æ ‡è¯†</p>
<p>æ­¤å¤„æ¶‰åŠ <code>Java</code> å­—èŠ‚ç çŸ¥è¯†ç‚¹ï¼Œ<code>ACC_SYNTHETIC</code> æ ‡è¯†å¯ä»¥ç®€å•ç†è§£æ˜¯ <code>Java</code> éšè—çš„ï¼Œéå…¬å¼€çš„ä¸€ç§ä¿®é¥°ç¬¦ï¼Œå¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å­—æ®µç­‰<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<p>å¾—çœ‹çœ‹ <code>Kotlin</code> æ˜¯å¦‚ä½•è®¾ç½® <code>ACC_SYNTHETIC</code> æ ‡è¯†çš„ï¼Œæ‰“å¼€ <a href="https://github.com/JetBrains/kotlin"><code>Github Kotlin</code> ä»“åº“</a>ï¼Œåœ¨ä»“åº“å†…æœç´¢ <code>JvmSynthetic</code> å…³é”®å­— <a href="https://github.com/JetBrains/kotlin/search?q=JvmSynthetic">Search Â· JvmSynthetic (github.com)</a></p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205081206919.png" alt="image-20220508120615028" /></p>
<p>åœ¨æœç´¢ç»“æœä¸­åˆ†æå‘ç° <code>JVM_SYNTHETIC_ANNOTATION_FQ_NAME</code> å…³è”æ€§è¾ƒå¤§ï¼Œç»§ç»­åœ¨ä»“åº“å†…æœç´¢ <code>JVM_SYNTHETIC_ANNOTATION_FQ_NAME</code> å…³é”®å­— <a href="https://github.com/JetBrains/kotlin/search?q=JVM_SYNTHETIC_ANNOTATION_FQ_NAME">Search Â· JVM_SYNTHETIC_ANNOTATION_FQ_NAME (github.com)</a></p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205081212412.png" alt="image-20220508121250275" /></p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205081211833.png" alt="image-20220508121115651" /></p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205081211011.png" alt="image-20220508121137580" /></p>
<p>åœ¨æœç´¢ç»“æœä¸­å‘ç°å‡ ä¸ªç±»åä¸ä»£ç ç”Ÿæˆç›¸å…³ï¼Œè¿™é‡Œä»¥ <a href="https://github.com/JetBrains/kotlin/blob/effd21d074fb07e64797aef4db624cae0decbf42/compiler/ir/backend.jvm/codegen/src/org/jetbrains/kotlin/backend/jvm/codegen/ClassCodegen.kt"><code>ClassCodegen.kt</code></a> ä¸ºä¾‹ï¼Œé™„ä¸Šç›¸å…³ä»£ç </p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–Classçš„SynthAccessFlag</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> IrClass.<span class="title">getSynthAccessFlag</span><span class="params">(languageVersionSettings: <span class="type">LanguageVersionSettings</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰`JvmSynthetic`æ³¨è§£ï¼Œè¿”å›`ACC_SYNTHETIC`æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">if</span> (hasAnnotation(JVM_SYNTHETIC_ANNOTATION_FQ_NAME))</span><br><span class="line">        <span class="keyword">return</span> Opcodes.ACC_SYNTHETIC</span><br><span class="line">    <span class="keyword">if</span> (origin == IrDeclarationOrigin.GENERATED_SAM_IMPLEMENTATION &amp;&amp;</span><br><span class="line">        languageVersionSettings.supportsFeature(LanguageFeature.SamWrapperClassesAreSynthetic)</span><br><span class="line">    )</span><br><span class="line">        <span class="keyword">return</span> Opcodes.ACC_SYNTHETIC</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—å­—æ®µçš„AccessFlag</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> IrField.<span class="title">computeFieldFlags</span><span class="params">(context: <span class="type">JvmBackendContext</span>, languageVersionSettings: <span class="type">LanguageVersionSettings</span>)</span></span>: <span class="built_in">Int</span> =</span><br><span class="line">    origin.flags or visibility.flags or</span><br><span class="line">            (<span class="keyword">if</span> (isDeprecatedCallable(context) ||</span><br><span class="line">                correspondingPropertySymbol?.owner?.isDeprecatedCallable(context) == <span class="literal">true</span></span><br><span class="line">            ) Opcodes.ACC_DEPRECATED <span class="keyword">else</span> <span class="number">0</span>) or</span><br><span class="line">            (<span class="keyword">if</span> (isFinal) Opcodes.ACC_FINAL <span class="keyword">else</span> <span class="number">0</span>) or</span><br><span class="line">            (<span class="keyword">if</span> (isStatic) Opcodes.ACC_STATIC <span class="keyword">else</span> <span class="number">0</span>) or</span><br><span class="line">            (<span class="keyword">if</span> (hasAnnotation(VOLATILE_ANNOTATION_FQ_NAME)) Opcodes.ACC_VOLATILE <span class="keyword">else</span> <span class="number">0</span>) or</span><br><span class="line">            (<span class="keyword">if</span> (hasAnnotation(TRANSIENT_ANNOTATION_FQ_NAME)) Opcodes.ACC_TRANSIENT <span class="keyword">else</span> <span class="number">0</span>) or</span><br><span class="line">			<span class="comment">// å¦‚æœæœ‰`JvmSynthetic`æ³¨è§£ï¼Œè¿”å›`ACC_SYNTHETIC`æ ‡è¯†</span></span><br><span class="line">            (<span class="keyword">if</span> (hasAnnotation(JVM_SYNTHETIC_ANNOTATION_FQ_NAME) ||</span><br><span class="line">                isPrivateCompanionFieldInInterface(languageVersionSettings)</span><br><span class="line">            ) Opcodes.ACC_SYNTHETIC <span class="keyword">else</span> <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æºç ä¸­ <code>Opcodes</code> æ˜¯å­—èŠ‚ç æ“ä½œåº“ <code>ASM</code> ä¸­çš„ç±»</p>
<p>çŒœæƒ³ <code>Kotlin</code> ç¼–è¯‘å™¨ä¹Ÿæ˜¯ä½¿ç”¨ <code>ASM</code> ç¼–è¯‘ç”Ÿæˆ/ä¿®æ”¹Classæ–‡ä»¶</p>
<p>ğŸ†—ï¼ŒçŸ¥é“äº† <code>JvmSynthetic</code> æ³¨è§£çš„å®ç°åŸç†ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ä»¿ç…§ <code>JvmSynthetic</code> ç»™æ„é€ æ–¹æ³•ä¹Ÿæ·»åŠ  <code>ACC_SYNTHETIC</code> æ ‡è¯†å‘¢â“</p>
<p>é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯åˆ©ç”¨ AGP Transform è¿›è¡Œå­—èŠ‚ç ä¿®æ”¹</p>
<h3 id="agp-transform"><a class="markdownIt-Anchor" href="#agp-transform"></a> AGP Transform</h3>
<p>AGP Transform çš„æ­å»ºã€ä½¿ç”¨ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³æ–‡ç« ï¼Œæ­¤å¤„ä¸å†æè¿°ï¼Œä¸‹å›¾æ˜¯æœ¬ä»“åº“çš„ç»„ç»‡æ¶æ„</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205081312860.png" alt="image-20220508131245185" /></p>
<p>è¿™é‡Œç®€å•è¯´æ˜ä¸‹ï¼š</p>
<h4 id="api-xxx"><a class="markdownIt-Anchor" href="#api-xxx"></a> api-xxx</h4>
<p>api-xxxæ¨¡å—ä¸­åªæœ‰ä¸€ä¸ªæ³¨è§£ç±» <code>Hide</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.CONSTRUCTOR, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Hide &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(</span></span><br><span class="line"><span class="meta">    AnnotationTarget.FIELD,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.CONSTRUCTOR,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.FUNCTION,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.PROPERTY_GETTER,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.PROPERTY_SETTER,</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.BINARY)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Hide</span></span><br></pre></td></tr></table></figure>
<h4 id="kcp"><a class="markdownIt-Anchor" href="#kcp"></a> kcp</h4>
<p>kcpç›¸å…³ï¼Œä¸‹ç¯‡å†è®²</p>
<h4 id="lib-xxx"><a class="markdownIt-Anchor" href="#lib-xxx"></a> lib-xxx</h4>
<p>lib-xxxæ¨¡å—ä¸­åŒ…å«å¯¹æ³¨è§£api-xxxçš„æµ‹è¯•ï¼Œæ‰“åŒ…æˆ<code>SDK</code>ï¼Œä¾›appæ¨¡å—ä½¿ç”¨</p>
<h4 id="plugin"><a class="markdownIt-Anchor" href="#plugin"></a> plugin</h4>
<p>pluginæ¨¡å—åŒ…å«AGP Transform</p>
<h3 id="å®ç°pluginæ¨¡å—"><a class="markdownIt-Anchor" href="#å®ç°pluginæ¨¡å—"></a> å®ç°pluginæ¨¡å—</h3>
<h4 id="åˆ›å»ºmaskplugin"><a class="markdownIt-Anchor" href="#åˆ›å»ºmaskplugin"></a> åˆ›å»ºMaskPlugin</h4>
<p>åˆ›å»º <code>MaskPlugin</code> ç±»ï¼Œå®ç° <code>org.gradle.api.Plugin</code> æ¥å£</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskPlugin</span> <span class="keyword">implements</span> <span class="title class_">Plugin</span>&lt;Project&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">void</span> apply(Project project) &#123;</span><br><span class="line">        <span class="comment">// è¾“å‡ºæ—¥å¿—ï¼ŒæŸ¥çœ‹Pluginæ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">        project.logger.error(<span class="string">&quot;Welcome to guodongAndroid mask plugin.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›®å‰å¢åŠ äº†é™åˆ¶ä»…èƒ½ç”¨äº`AndroidLibrary`</span></span><br><span class="line">        LibraryExtension extension = project.extensions.findByType(LibraryExtension)</span><br><span class="line">        <span class="keyword">if</span> (extension == <span class="literal">null</span>) &#123;</span><br><span class="line">            project.logger.error(<span class="string">&quot;Only support [AndroidLibrary].&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        extension.registerTransform(<span class="keyword">new</span> MaskTransform(project))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºmasktransform"><a class="markdownIt-Anchor" href="#åˆ›å»ºmasktransform"></a> åˆ›å»ºMaskTransform</h4>
<p>åˆ›å»º <code>MaskTransform</code>ï¼Œç»§æ‰¿ <code>com.android.build.api.transform.Transform</code> æŠ½è±¡ç±»ï¼Œä¸»è¦å®ç° <code>transform</code> æ–¹æ³•ï¼Œä»¥ä¸‹ä¸ºæ ¸å¿ƒä»£ç </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskTransform</span> <span class="keyword">extends</span> <span class="title class_">Transform</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">void</span> transform(TransformInvocation transformInvocation) <span class="keyword">throws</span> TransformException, InterruptedException, IOException &#123;</span><br><span class="line">        <span class="type">long</span> start = System.currentTimeMillis()</span><br><span class="line">        logE(<span class="string">&quot;$TAG - start&quot;</span>)</span><br><span class="line"></span><br><span class="line">        TransformOutputProvider outputProvider = transformInvocation.outputProvider</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ²¡æœ‰é€‚é…å¢é‡ç¼–è¯‘</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åªå…³å¿ƒæœ¬é¡¹ç›®ç”Ÿæˆçš„Classæ–‡ä»¶</span></span><br><span class="line">        transformInvocation.inputs.each &#123; transformInput -&gt;</span><br><span class="line">            transformInput.directoryInputs.each &#123; dirInput -&gt;</span><br><span class="line">                <span class="keyword">if</span> (dirInput.file.isDirectory()) &#123;</span><br><span class="line">                    dirInput.file.eachFileRecurse &#123; file -&gt;</span><br><span class="line">                        <span class="keyword">if</span> (file.name.endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">                            <span class="comment">// ä½¿ç”¨ASMä¿®æ”¹Classæ–‡ä»¶</span></span><br><span class="line">                            ClassReader cr = <span class="keyword">new</span> ClassReader(file.bytes)</span><br><span class="line">                            ClassWriter cw = <span class="keyword">new</span> ClassWriter(cr, ClassWriter.COMPUTE_MAXS)</span><br><span class="line">                            ClassVisitor cv = <span class="keyword">new</span> CheckClassAdapter(cw)</span><br><span class="line">                            cv = <span class="keyword">new</span> MaskClassNode(Opcodes.ASM9, cv, mProject)</span><br><span class="line">                            <span class="type">int</span> parsingOptions = <span class="number">0</span></span><br><span class="line">                            cr.accept(cv, parsingOptions)</span><br><span class="line">                            <span class="type">byte</span>[] bytes = cw.toByteArray()</span><br><span class="line"></span><br><span class="line">                            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file)</span><br><span class="line">                            fos.write(bytes)</span><br><span class="line">                            fos.flush()</span><br><span class="line">                            fos.close()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                File dest = outputProvider.getContentLocation(dirInput.name, dirInput.contentTypes, dirInput.scopes, Format.DIRECTORY)</span><br><span class="line">                FileUtils.copyDirectory(dirInput.file, dest)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸å…³å¿ƒç¬¬ä¸‰æ–¹Jarä¸­çš„Classæ–‡ä»¶</span></span><br><span class="line">            transformInput.jarInputs.each &#123; jarInput -&gt;</span><br><span class="line">                String jarName = jarInput.name</span><br><span class="line">                String md5Name = DigestUtils.md5Hex(jarInput.file.getAbsolutePath())</span><br><span class="line">                <span class="keyword">if</span> (jarName.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">                    jarName = jarName.substring(<span class="number">0</span>, jarName.length() - <span class="number">4</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                File dest = outputProvider.getContentLocation(jarName + md5Name, jarInput.contentTypes, jarInput.scopes, Format.JAR)</span><br><span class="line">                FileUtils.copyFile(jarInput.file, dest)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> cost = System.currentTimeMillis() - start</span><br><span class="line">        logE(String.format(Locale.CHINA, <span class="string">&quot;$TAG - end, cost: %dms&quot;</span>, cost))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">void</span> logE(String msg) &#123;</span><br><span class="line">        mProject.logger.error(msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºmaskclassnode"><a class="markdownIt-Anchor" href="#åˆ›å»ºmaskclassnode"></a> åˆ›å»ºMaskClassNode</h4>
<p>åˆ›å»º <code>MaskClassNode</code>ï¼Œç»§æ‰¿ <code>org.objectweb.asm.tree.ClassNode</code>ï¼Œä¸»è¦å®ç° <code>visitEnd</code> æ–¹æ³•</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskClassNode</span> <span class="keyword">extends</span> <span class="title class_">ClassNode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = MaskClassNode.<span class="keyword">class</span>.simpleName</span><br><span class="line"></span><br><span class="line">    <span class="comment">// api-javaä¸­`Hide`æ³¨è§£çš„æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HIDE_JAVA_DESCRIPTOR = <span class="string">&quot;Lcom/guodong/android/mask/api/Hide;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// api-ktä¸­`Hide`æ³¨è§£çš„æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HIDE_KOTLIN_DESCRIPTOR = <span class="string">&quot;Lcom/guodong/android/mask/api/kt/Hide;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; HIDE_DESCRIPTOR_SET = <span class="keyword">new</span> HashSet&lt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        HIDE_DESCRIPTOR_SET.add(HIDE_JAVA_DESCRIPTOR)</span><br><span class="line">        HIDE_DESCRIPTOR_SET.add(HIDE_KOTLIN_DESCRIPTOR)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Project project</span><br><span class="line"></span><br><span class="line">    MaskClassNode(<span class="type">int</span> api, ClassVisitor cv, Project project) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(api)</span><br><span class="line">        <span class="variable language_">this</span>.project = project</span><br><span class="line">        <span class="variable language_">this</span>.cv = cv</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">void</span> visitEnd() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†Field</span></span><br><span class="line">        <span class="keyword">for</span> (fn <span class="keyword">in</span> fields) &#123;</span><br><span class="line">            <span class="type">boolean</span> has = hasHideAnnotation(fn.invisibleAnnotations)</span><br><span class="line">            <span class="keyword">if</span> (has) &#123;</span><br><span class="line">                project.logger.error(<span class="string">&quot;$TAG, before --&gt; typeName = $name, fieldName = $&#123;fn.name&#125;, access = $&#123;fn.access&#125;&quot;</span>)</span><br><span class="line">                <span class="comment">// ä¿®æ”¹å­—æ®µçš„è®¿é—®æ ‡è¯†</span></span><br><span class="line">                fn.access += Opcodes.ACC_SYNTHETIC</span><br><span class="line">                project.logger.error(<span class="string">&quot;$TAG, after --&gt; typeName = $name, fieldName = $&#123;fn.name&#125;, access = $&#123;fn.access&#125;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†Method</span></span><br><span class="line">        <span class="keyword">for</span> (mn <span class="keyword">in</span> methods) &#123;</span><br><span class="line">            <span class="type">boolean</span> has = hasHideAnnotation(mn.invisibleAnnotations)</span><br><span class="line">            <span class="keyword">if</span> (has) &#123;</span><br><span class="line">                project.logger.error(<span class="string">&quot;$TAG, before --&gt; typeName = $name, methodName = $&#123;mn.name&#125;, access = $&#123;mn.access&#125;&quot;</span>)</span><br><span class="line">                <span class="comment">// ä¿®æ”¹æ–¹æ³•çš„è®¿é—®æ ‡è¯†</span></span><br><span class="line">                mn.access += Opcodes.ACC_SYNTHETIC</span><br><span class="line">                project.logger.error(<span class="string">&quot;$TAG, after --&gt; typeName = $name, methodName = $&#123;mn.name&#125;, access = $&#123;mn.access&#125;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">super</span>.visitEnd()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cv != <span class="literal">null</span>) &#123;</span><br><span class="line">            accept(cv)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦æœ‰`Hide`æ³¨è§£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> hasHideAnnotation(List&lt;AnnotationNode&gt; annotationNodes) &#123;</span><br><span class="line">        <span class="keyword">if</span> (annotationNodes == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">for</span> (node <span class="keyword">in</span> annotationNodes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (HIDE_DESCRIPTOR_SET.contains(node.desc)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨transform"><a class="markdownIt-Anchor" href="#ä½¿ç”¨transform"></a> ä½¿ç”¨Transform</h3>
<h4 id="buildgradle-project-level"><a class="markdownIt-Anchor" href="#buildgradle-project-level"></a> build.gradle - project level</h4>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext.plugin_version = <span class="string">&#x27;x.x.x&#x27;</span></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&quot;com.guodong.android:mask-gradle-plugin:$&#123;plugin_version&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="buildgradle-module-level"><a class="markdownIt-Anchor" href="#buildgradle-module-level"></a> build.gradle - module level</h4>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"># lib-kotlin</span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;kotlin-kapt&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;maven-publish&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;com.guodong.android.mask&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="lib-kotlin"><a class="markdownIt-Anchor" href="#lib-kotlin"></a> lib-kotlin</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">InterfaceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="meta">@Hide</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInterface</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KotlinTest</span>(a: <span class="built_in">Int</span>) : InterfaceTest &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="meta">@Hide</span></span><br><span class="line">    <span class="keyword">constructor</span>() : <span class="keyword">this</span>(-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">newKotlinTest</span><span class="params">()</span></span> = KotlinTest()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding: LayoutKotlinTestBinding? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="keyword">var</span> a = a</span><br><span class="line">        <span class="meta">@Hide</span> <span class="keyword">get</span></span><br><span class="line">        <span class="meta">@Hide</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getA1</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        a = <span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">testInterface</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Interface function test&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="app"><a class="markdownIt-Anchor" href="#app"></a> app</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># MainActivity.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testKotlinLib</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡æ—¶ä¸èƒ½è®¿é—®æ— å‚æ„é€ æ–¹æ³•ï¼Œå¯ä»¥è®¿é—®æœ‰å‚æ„é€ æ–¹æ³•æˆ–è®¿é—®é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="type">KotlinTest</span> <span class="variable">test</span> <span class="operator">=</span> KotlinTest.newKotlinTest();</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ—¶ä¸èƒ½è®¿é—®`test.getA()`æ–¹æ³•ï¼Œä»…èƒ½è®¿é—®`getA1()æ–¹æ³•</span></span><br><span class="line">    Log.e(TAG, <span class="string">&quot;testKotlinLib: before --&gt; &quot;</span> + test.getA1());</span><br><span class="line">    test.test();</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;testKotlinLib: after --&gt; &quot;</span> + test.getA1());</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    test.testInterface();</span><br><span class="line">    </span><br><span class="line">    <span class="type">InterfaceTest</span> <span class="variable">interfaceTest</span> <span class="operator">=</span> test;</span><br><span class="line">    <span class="comment">// Error - cannot resolve method &#x27;testInterface&#x27; in &#x27;InterfaceTest&#x27;</span></span><br><span class="line">    interfaceTest.testInterface();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>happy:happy:</p>
<h2 id="å‚è€ƒæ–‡æ¡£"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡æ¡£"></a> å‚è€ƒæ–‡æ¡£</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://blog.csdn.net/qq_23626713/article/details/90698534">æ­£ç¡®åœ°ä½¿ç”¨ Kotlin çš„ internal</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a> <a href="#fnref1:1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://youtrack.jetbrains.com/issue/KT-24981/Support-more-targets-for-JvmSynthetic">Support more targets for @JvmSynthetic : KT-24981 (jetbrains.com)</a> <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://youtrack.jetbrains.com/issue/KT-50609/Support-constructor-target-for-JvmSynthetic-annotation">Support â€˜constructorâ€™ target for JvmSynthetic annotation : KT-50609 (jetbrains.com)</a> <a href="#fnref3" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">Chapter 4. The class File Format (oracle.com)</a> <a href="#fnref4" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>kcp</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡</title>
    <url>/2022/05/12/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E7%AC%AC%E4%BA%8C%E7%AF%87/</url>
    <content><![CDATA[<h1 id="kotlin-kcpçš„åº”ç”¨-ç¬¬äºŒç¯‡"><a class="markdownIt-Anchor" href="#kotlin-kcpçš„åº”ç”¨-ç¬¬äºŒç¯‡"></a> Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>æ¥<a href="https://juejin.cn/post/7095248182912745502">Kotlin-KCPçš„åº”ç”¨-ç¬¬ä¸€ç¯‡</a>ï¼Œæœ¬æ–‡æ˜¯ç¬¬äºŒç¯‡ï¼Œä»¥ä¸‹æ˜¯æœ¬æ–‡çš„ç›®æ ‡ï¼š</p>
<ol>
<li>è®°å½•å¦‚ä½•ç®€å•æ­å»º KCP å¼€å‘ç¯å¢ƒ</li>
<li>ä½¿ç”¨ KCP è§£å†³ç¬¬ä¸€ç¯‡ä¸­çš„é—®é¢˜</li>
</ol>
<h2 id="ä½•ä¸ºkcpä¸ºä½•ä¸ä½¿ç”¨ksp"><a class="markdownIt-Anchor" href="#ä½•ä¸ºkcpä¸ºä½•ä¸ä½¿ç”¨ksp"></a> ä½•ä¸ºKCPï¼Ÿä¸ºä½•ä¸ä½¿ç”¨KSPï¼Ÿ</h2>
<h3 id="ksp"><a class="markdownIt-Anchor" href="#ksp"></a> KSP</h3>
<p><code>KSP</code> å³ <a href="https://github.com/google/ksp"><code>Kotlin Symbol Processing(Kotlinç¬¦å·å¤„ç†å™¨)</code></a>ï¼ŒKSP ç›®å‰åªèƒ½ç”Ÿæˆä»£ç ï¼Œä¸èƒ½ä¿®æ”¹å­—èŠ‚ç ï¼Œç¬¬ä¸€ç¯‡ä¸­çš„é—®é¢˜éœ€è¦ä¿®æ”¹å­—èŠ‚ç ï¼Œå› æ­¤ KSP ä¸èƒ½æ»¡è¶³éœ€æ±‚</p>
<h3 id="kcp"><a class="markdownIt-Anchor" href="#kcp"></a> KCP</h3>
<p><code>KCP</code> å³ <code>Kotlin Compiler Plugin(Kotlinç¼–è¯‘å™¨æ’ä»¶)</code>ï¼Œåœ¨ <code>kotlinc</code> è¿‡ç¨‹ä¸­æä¾› hook æ—¶æœºï¼Œåœ¨æ­¤æœŸé—´å¯ä»¥ç”Ÿæˆä»£ç ã€ä¿®æ”¹å­—èŠ‚ç ç­‰</p>
<p>æ ‡å‡†çš„ KCP æ¶æ„å¦‚ä¸‹<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼š</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205120932971.png" alt="KCPæ¶æ„" /></p>
<h3 id="plugin"><a class="markdownIt-Anchor" href="#plugin"></a> Plugin</h3>
<ul>
<li>Gradle æ’ä»¶ï¼Œä¸ Kotlin æ— å…³ï¼Œåœ¨ build.gradle è„šæœ¬ä¸­æä¾›ä¸€ä¸ªå…¥å£</li>
<li>é€šè¿‡ Gradle æ‰©å±•è®¾ç½®é…ç½®ä¿¡æ¯</li>
</ul>
<h3 id="subplugin"><a class="markdownIt-Anchor" href="#subplugin"></a> Subplugin</h3>
<ul>
<li>ä»‹äº Gradle å’Œ Kotlin ç›´æ¥çš„ APIs æ¥å£</li>
<li>è¯»å– Gradle æ‰©å±•é…ç½®ä¿¡æ¯å¹¶å†™å…¥ <code>SubpluginOptions</code></li>
<li>å®šä¹‰ç¼–è¯‘å™¨æ’ä»¶çš„å”¯ä¸€<code>ID</code></li>
<li>å®šä¹‰ Kotlin æ’ä»¶çš„ Maven åæ ‡ä¿¡æ¯ï¼Œä¾¿äºç¼–è¯‘å™¨ä¸‹è½½å®ƒ</li>
</ul>
<h3 id="commandlinprocessor"><a class="markdownIt-Anchor" href="#commandlinprocessor"></a> CommandLinProcessor</h3>
<ul>
<li>è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</li>
<li>è¯»å– kotlinc -Xplugin å‚æ•°</li>
<li>è¯»å– <code>SubpluginOptions</code> é…ç½®ä¿¡æ¯ï¼Œå¹¶å†™å…¥ <code>CompilerConfigurationKeys</code></li>
</ul>
<h3 id="componentregistrar"><a class="markdownIt-Anchor" href="#componentregistrar"></a> ComponentRegistrar</h3>
<ul>
<li>è¯»å– <code>CompilerConfigurationKeys</code></li>
<li>æ³¨å†Œ <code>Extension</code> åˆ°å„ç¼–è¯‘æµç¨‹</li>
</ul>
<h3 id="extension"><a class="markdownIt-Anchor" href="#extension"></a> Extension</h3>
<ul>
<li>ç”Ÿæˆä»£ç </li>
<li>ä¿®æ”¹å­—èŠ‚ç </li>
<li>å¤šç§ç±»å‹çš„æ‰©å±•ï¼Œæ¯”å¦‚
<ul>
<li>ExpressionCodegenExtension</li>
<li>ClassBuilderInterceptorExtension</li>
<li>StorageComponentContainerContributor</li>
<li>IrGenerationExtension</li>
</ul>
</li>
</ul>
<h2 id="å®ç°kcp"><a class="markdownIt-Anchor" href="#å®ç°kcp"></a> å®ç°KCP</h2>
<h3 id="ç›®æ ‡"><a class="markdownIt-Anchor" href="#ç›®æ ‡"></a> ç›®æ ‡</h3>
<p>æ ¹æ® KCP çš„æ¶æ„ï¼Œä¸‹é¢ä¸€ä¸€è¿›è¡Œå®ç°</p>
<p><img data-src="https://gitee.com/guodongAndroid/typora/raw/master/img/202205120959782.png" alt="image-20220512095927050" /></p>
<p>ä¸Šå›¾æ˜¯æœ¬ä»“åº“æ¶æ„ï¼Œæ—¨åœ¨é€šè¿‡ KCP åœ¨ Java å­—èŠ‚ç ä¸­ <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸Šè®¾ç½® <code>ACC_SYNTHETIC</code> æ ‡è¯†ï¼Œä½¿å…¶åœ¨ Java ä¸­ä¸èƒ½æ­£å¸¸è°ƒç”¨ï¼Œè¾¾åˆ°éšè— API çš„æ•ˆæœ</p>
<h3 id="buildgradle-project-level"><a class="markdownIt-Anchor" href="#buildgradle-project-level"></a> build.gradle - project level</h3>
<p>åœ¨é¡¹ç›®çº§åˆ«çš„ build.gradle è„šæœ¬ä¸­é…ç½®æ’ä»¶ä¾èµ–</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ID</span></span><br><span class="line">    ext.kotlin_plugin_id = <span class="string">&quot;com.guodong.android.mask.kcp&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶ç‰ˆæœ¬</span></span><br><span class="line">    ext.plugin_version = <span class="string">&#x27;x.x.x&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    <span class="comment">// é…ç½® Gradle å‘å¸ƒæ’ä»¶ï¼Œå¯ä»¥ä¸å†å†™ META-INF</span></span><br><span class="line">    id(<span class="string">&quot;com.gradle.plugin-publish&quot;</span>) version <span class="string">&quot;0.16.0&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½®ç”Ÿæˆ BuildConfig æ’ä»¶</span></span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>) version <span class="string">&quot;3.0.3&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    id <span class="string">&#x27;org.jetbrains.kotlin.jvm&#x27;</span> version <span class="string">&#x27;1.6.10&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="plugin-gradle"><a class="markdownIt-Anchor" href="#plugin-gradle"></a> plugin-gradle</h3>
<p>æ¥ä¸‹æ¥ç¼–å†™ Gradle æ’ä»¶ï¼Œæ­¤æ’ä»¶å¯¹åº” KCP æ¶æ„ä¸­çš„ <code>Plugin</code> å’Œ <code>Subplugin</code></p>
<p>é¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p>
<h4 id="buildgradlekts-module-level"><a class="markdownIt-Anchor" href="#buildgradlekts-module-level"></a> build.gradle.kts - module level</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id(<span class="string">&quot;java-gradle-plugin&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(kotlin(<span class="string">&quot;gradle-plugin-api&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildConfig &#123;</span><br><span class="line">    <span class="comment">// é…ç½® BuildConfig çš„åŒ…å</span></span><br><span class="line">    packageName(<span class="string">&quot;com.guodong.android.mask.kcp.gradle&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_ID&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>]&#125;</span>\&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ GroupId</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_GROUP&quot;</span>, <span class="string">&quot;\&quot;com.guodong.android\&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ ArtifactId</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_NAME&quot;</span>, <span class="string">&quot;\&quot;mask-kcp-kotlin-plugin\&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶ Version</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_VERSION&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;rootProject.extra[<span class="string">&quot;PLUGIN_VERSION&quot;</span>]&#125;</span>\&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradlePlugin &#123;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        create(<span class="string">&quot;Mask&quot;</span>) &#123;</span><br><span class="line">            id = rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>] <span class="keyword">as</span> String <span class="comment">// `apply plugin: &quot;com.guodong.android.mask.kcp&quot;`</span></span><br><span class="line">            displayName = <span class="string">&quot;Mask Kcp&quot;</span></span><br><span class="line">            description = <span class="string">&quot;Mask Kcp&quot;</span></span><br><span class="line">            implementationClass = <span class="string">&quot;com.guodong.android.mask.kcp.gradle.MaskGradlePlugin&quot;</span> <span class="comment">// æ’ä»¶å…¥å£ç±»</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType&lt;KotlinCompile&gt; &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="maskgradleplugin"><a class="markdownIt-Anchor" href="#maskgradleplugin"></a> MaskGradlePlugin</h4>
<p>åˆ›å»º <code>MaskGradlePlugin</code> å®ç° <code>KotlinCompilerPluginSupportPlugin</code> æ¥å£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskGradlePlugin</span> : <span class="type">KotlinCompilerPluginSupportPlugin</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(target: <span class="type">Project</span>)</span></span> = with(target) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Welcome to guodongAndroid mask kcp gradle plugin.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¤å¤„å¯ä»¥é…ç½® Gradle æ’ä»¶æ‰©å±•</span></span><br><span class="line">        <span class="comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®é¡¹, æ— éœ€é…ç½®æ‰©å±•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦é€‚ç”¨, é»˜è®¤True</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isApplicable</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– Kotlin æ’ä»¶å”¯ä¸€ID</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCompilerPluginId</span><span class="params">()</span></span>: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– Kotlin æ’ä»¶ Maven åæ ‡ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPluginArtifact</span><span class="params">()</span></span>: SubpluginArtifact = SubpluginArtifact(</span><br><span class="line">        groupId = BuildConfig.KOTLIN_PLUGIN_GROUP,</span><br><span class="line">        artifactId = BuildConfig.KOTLIN_PLUGIN_NAME,</span><br><span class="line">        version = BuildConfig.KOTLIN_PLUGIN_VERSION,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– Gradle æ’ä»¶æ‰©å±•ä¿¡æ¯å¹¶å†™å…¥ SubpluginOption</span></span><br><span class="line">    <span class="comment">// æœ¬æ’ä»¶æ²¡æœ‰æ‰©å±•ä¿¡æ¯ï¼Œæ‰€ä»¥è¿”å›ç©ºé›†åˆ</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyToCompilation</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: Provider&lt;List&lt;SubpluginOption&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> project = kotlinCompilation.target.project</span><br><span class="line">        <span class="keyword">return</span> project.provider &#123; emptyList() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ Gradle æ’ä»¶ç¼–å†™å®Œæˆï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ğŸ˜„</p>
<h3 id="plugin-kotlin"><a class="markdownIt-Anchor" href="#plugin-kotlin"></a> plugin-kotlin</h3>
<p>æ¥ä¸‹æ¥ç¼–å†™ Kotlin ç¼–è¯‘å™¨æ’ä»¶ï¼Œæ­¤æ’ä»¶å¯¹åº” KCP æ¶æ„ä¸­çš„ <code>CommandLineProcessor</code> ã€ <code>ComponentRegistrar</code> å’Œ <code>Extension</code></p>
<p>é¦–å…ˆé…ç½®ä¸‹ build.gradle.kts è„šæœ¬</p>
<h4 id="buildgradlekts-module-level-2"><a class="markdownIt-Anchor" href="#buildgradlekts-module-level-2"></a> build.gradle.kts - module level</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;kapt&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.github.gmazzo.buildconfig&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// ä¾èµ– Kotlin ç¼–è¯‘å™¨åº“</span></span><br><span class="line">    compileOnly(<span class="string">&quot;org.jetbrains.kotlin:kotlin-compiler-embeddable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾èµ– Google auto service</span></span><br><span class="line">    kapt(<span class="string">&quot;com.google.auto.service:auto-service:1.0&quot;</span>)</span><br><span class="line">    compileOnly(<span class="string">&quot;com.google.auto.service:auto-service-annotations:1.0&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildConfig &#123;</span><br><span class="line">    <span class="comment">// é…ç½® BuildConfig çš„åŒ…å</span></span><br><span class="line">    packageName(<span class="string">&quot;com.guodong.android.mask.kcp.kotlin&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;KOTLIN_PLUGIN_ID&quot;</span>, <span class="string">&quot;\&quot;<span class="subst">$&#123;rootProject.extra[<span class="string">&quot;kotlin_plugin_id&quot;</span>]&#125;</span>\&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType&lt;KotlinCompile&gt; &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® KCP æ¶æ„ï¼Œä¸‹é¢å®ç° <code>CommandLineProcessor</code></p>
<h4 id="maskcommandlineprocessor"><a class="markdownIt-Anchor" href="#maskcommandlineprocessor"></a> MaskCommandLineProcessor</h4>
<p>åˆ›å»º <code>MaskCommandLineProcessor</code> å®ç° <code>CommandLineProcessor</code> æ¥å£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(CommandLineProcessor::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaskCommandLineProcessor</span> : <span class="type">CommandLineProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½® Kotlin æ’ä»¶å”¯ä¸€ ID</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginId: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– `SubpluginOptions` å‚æ•°ï¼Œå¹¶å†™å…¥ `CliOption`</span></span><br><span class="line">    <span class="comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®ä¿¡æ¯ï¼Œè¿”å›ç©ºé›†åˆ</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginOptions: Collection&lt;AbstractCliOption&gt; = emptyList()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç† `CliOption` å†™å…¥ `CompilerConfiguration`</span></span><br><span class="line">    <span class="comment">// æœ¬æ’ä»¶æ²¡æœ‰é…ç½®ä¿¡æ¯ï¼Œæ­¤å¤„æ²¡æœ‰å®ç°</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">processOption</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        option: <span class="type">AbstractCliOption</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        value: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        configuration: <span class="type">CompilerConfiguration</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.processOption(option, value, configuration)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CommandLineProcessor</code> ç¼–å†™å®Œæˆ</p>
<p>æ¥ä¸‹æ¥å®ç° <code>ComponentRegistrar</code></p>
<h4 id="maskcomponentregistrar"><a class="markdownIt-Anchor" href="#maskcomponentregistrar"></a> MaskComponentRegistrar</h4>
<p>åˆ›å»º <code>MaskComponentRegistrar</code> å®ç° <code>ComponentRegistrar</code> æ¥å£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(ComponentRegistrar::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaskComponentRegistrar</span> : <span class="type">ComponentRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerProjectComponents</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        project: <span class="type">MockProject</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        configuration: <span class="type">CompilerConfiguration</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—¥å¿—æ”¶é›†å™¨</span></span><br><span class="line">        <span class="keyword">val</span> messageCollector =</span><br><span class="line">            configuration.<span class="keyword">get</span>(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY, MessageCollector.NONE)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºæ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// CompilerMessageSeverity.INFO - æ²¡æœ‰çœ‹åˆ°æ—¥å¿—è¾“å‡º</span></span><br><span class="line">        <span class="comment">// CompilerMessageSeverity.ERROR - ç¼–è¯‘è¿‡ç¨‹åœæ­¢æ‰§è¡Œ</span></span><br><span class="line">        messageCollector.report(</span><br><span class="line">            CompilerMessageSeverity.WARNING,</span><br><span class="line">            <span class="string">&quot;Welcome to guodongAndroid mask kcp kotlin plugin&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤å¤„åœ¨ `ClassBuilderInterceptorExtension` ä¸­æ³¨å†Œæ‰©å±•</span></span><br><span class="line">        ClassBuilderInterceptorExtension.registerExtension(</span><br><span class="line">            project,</span><br><span class="line">            MaskClassGenerationInterceptor(messageCollector)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå®ç° <code>Extension</code></p>
<h4 id="maskclassgenerationinterceptor"><a class="markdownIt-Anchor" href="#maskclassgenerationinterceptor"></a> MaskClassGenerationInterceptor</h4>
<p>åˆ›å»º <code>MaskClassGenerationInterceptor</code> å®ç° <code>ClassBuilderInterceptorExtension</code> æ¥å£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskClassGenerationInterceptor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">) : ClassBuilderInterceptorExtension &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¦æˆª ClassBuilderFactory</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">interceptClassBuilderFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        interceptedFactory: <span class="type">ClassBuilderFactory</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bindingContext: <span class="type">BindingContext</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        diagnostics: <span class="type">DiagnosticSink</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// è‡ªå®šä¹‰ ClassBuilderFactory å§”æ‰˜ç»™ æºClassBuilderFactory</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: ClassBuilderFactory = <span class="keyword">object</span> : ClassBuilderFactory <span class="keyword">by</span> interceptedFactory &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤å†™ newClassBuilderï¼Œè‡ªå®šä¹‰ ClassBuilder</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newClassBuilder</span><span class="params">(origin: <span class="type">JvmDeclarationOrigin</span>)</span></span>: ClassBuilder &#123;</span><br><span class="line">            <span class="comment">// ä¼ å…¥æºClassBuilder</span></span><br><span class="line">            <span class="keyword">return</span> MaskClassBuilder(messageCollector, interceptedFactory.newClassBuilder(origin))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="maskclassbuilder"><a class="markdownIt-Anchor" href="#maskclassbuilder"></a> MaskClassBuilder</h4>
<p>åˆ›å»º <code>MaskClassBuilder</code> ç»§æ‰¿ <code>DelegatingClassBuilder</code>ï¼Œå®ç° <code>getDelegate</code> æ–¹æ³•ï¼Œå¤å†™ <code>newField</code> å’Œ <code>newMethod</code> æ–¹æ³•</p>
<h6 id="getdelegate"><a class="markdownIt-Anchor" href="#getdelegate"></a> getDelegate</h6>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskClassBuilder</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> delegate: ClassBuilder</span><br><span class="line">) : DelegatingClassBuilder() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hideæ³¨è§£çš„å®Œå…¨é™å®šå(fully qualified name)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> annotations: List&lt;FqName&gt; = listOf(</span><br><span class="line">        FqName(<span class="string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span>),</span><br><span class="line">        FqName(<span class="string">&quot;com.guodong.android.mask.api.Hide&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ä»£ç†</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDelegate</span><span class="params">()</span></span>: ClassBuilder = delegate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="newfield"><a class="markdownIt-Anchor" href="#newfield"></a> newField</h6>
<p>å¤„ç† <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸ºå­—æ®µ</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaskClassBuilder</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> delegate: ClassBuilder</span><br><span class="line">) : DelegatingClassBuilder() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hideæ³¨è§£çš„å®Œå…¨é™å®šå(fully qualified name)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> annotations: List&lt;FqName&gt; = listOf(</span><br><span class="line">        FqName(<span class="string">&quot;com.guodong.android.mask.api.kt.Hide&quot;</span>),</span><br><span class="line">        FqName(<span class="string">&quot;com.guodong.android.mask.api.Hide&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newField</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        origin: <span class="type">JvmDeclarationOrigin</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        access: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        desc: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        signature: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        value: <span class="type">Any</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: FieldVisitor &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æè¿°ç¬¦æ˜¯å¦æ˜¯å­—æ®µ</span></span><br><span class="line">        <span class="keyword">val</span> field = origin.descriptor <span class="keyword">as</span>? FieldDescriptor</span><br><span class="line">        	?: <span class="keyword">return</span> <span class="keyword">super</span>.newField(origin, access, name, desc, signature, value)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­å­—æ®µä¸Šæ˜¯å¦æœ‰`@Hide`æ³¨è§£</span></span><br><span class="line">        <span class="keyword">if</span> (annotations.none &#123; field.annotations.hasAnnotation(it) &#125;) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.newField(origin, access, name, desc, signature, value)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºå­—æ®µæºè®¿é—®æ ‡å¿—</span></span><br><span class="line">        messageCollector.report(</span><br><span class="line">            CompilerMessageSeverity.WARNING,</span><br><span class="line">            <span class="string">&quot;Mask Class = <span class="subst">$&#123;delegate.thisName&#125;</span>, fieldName = <span class="variable">$name</span>, originalAccess = <span class="variable">$access</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¢åŠ `ACC_SYNTHETIC`æ ‡è¯†</span></span><br><span class="line">        <span class="keyword">val</span> maskAccess = access + Opcodes.ACC_SYNTHETIC</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºå­—æ®µMaskåè®¿é—®æ ‡å¿—</span></span><br><span class="line">        messageCollector.report(</span><br><span class="line">            CompilerMessageSeverity.WARNING,</span><br><span class="line">            <span class="string">&quot;Mask Class = <span class="subst">$&#123;delegate.thisName&#125;</span>, fieldName = <span class="variable">$name</span>, maskAccess = <span class="variable">$maskAccess</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¼ å…¥Maskåè®¿é—®æ ‡å¿—</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newField(origin, maskAccess, name, desc, signature, value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="newmethod"><a class="markdownIt-Anchor" href="#newmethod"></a> newMethod</h6>
<p>å¤„ç† <code>@Hide</code> æ³¨è§£ç›®æ ‡ä¸ºæ–¹æ³•/å‡½æ•°ï¼Œå¤„ç†é€»è¾‘ä¸å­—æ®µç±»ä¼¼</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    origin: <span class="type">JvmDeclarationOrigin</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    access: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    desc: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    signature: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    exceptions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: MethodVisitor &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ–¹æ³•/å‡½æ•°æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">val</span> function = origin.descriptor <span class="keyword">as</span>? FunctionDescriptor</span><br><span class="line">    	?: <span class="keyword">return</span> <span class="keyword">super</span>.newMethod(origin, access, name, desc, signature, exceptions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–¹æ³•/å‡½æ•°ä¸Šæ˜¯å¦æœ‰`@Hide`æ³¨è§£</span></span><br><span class="line">    <span class="keyword">if</span> (annotations.none &#123; function.annotations.hasAnnotation(it) &#125;) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newMethod(origin, access, name, desc, signature, exceptions)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ–¹æ³•/å‡½æ•°æºè®¿é—®æ ‡å¿—</span></span><br><span class="line">    messageCollector.report(</span><br><span class="line">        CompilerMessageSeverity.WARNING,</span><br><span class="line">        <span class="string">&quot;Mask Class = <span class="subst">$&#123;delegate.thisName&#125;</span>, methodName = <span class="variable">$name</span>, originalAccess = <span class="variable">$access</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ `ACC_SYNTHETIC`æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">val</span> maskAccess = access + Opcodes.ACC_SYNTHETIC</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ–¹æ³•/å‡½æ•°Maskåè®¿é—®æ ‡å¿—</span></span><br><span class="line">    messageCollector.report(</span><br><span class="line">        CompilerMessageSeverity.WARNING,</span><br><span class="line">        <span class="string">&quot;Mask Class = <span class="subst">$&#123;delegate.thisName&#125;</span>, methodName = <span class="variable">$name</span>, maskAccess = <span class="variable">$maskAccess</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼ å…¥Maskåè®¿é—®æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.newMethod(origin, maskAccess, name, desc, signature, exceptions)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ Kotlin ç¼–è¯‘å™¨æ’ä»¶å®Œæˆ:happy:</p>
<h2 id="åº”ç”¨kcp"><a class="markdownIt-Anchor" href="#åº”ç”¨kcp"></a> åº”ç”¨KCP</h2>
<h3 id="buildgradle-project-level-2"><a class="markdownIt-Anchor" href="#buildgradle-project-level-2"></a> build.gradle - project level</h3>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext.plugin_version = <span class="string">&#x27;x.x.x&#x27;</span></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&quot;com.guodong.android:mask-kcp-gradle-plugin:$&#123;plugin_version&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lib-kotlinbuildgradle-module-level"><a class="markdownIt-Anchor" href="#lib-kotlinbuildgradle-module-level"></a> lib-kotlin/build.gradle - module level</h3>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"># lib-kotlin</span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;kotlin-kapt&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;maven-publish&#x27;</span></span><br><span class="line">    <span class="comment">// id &#x27;com.guodong.android.mask&#x27; // use kcp</span></span><br><span class="line">    id <span class="string">&#x27;com.guodong.android.mask.kcp&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lib-kotlin"><a class="markdownIt-Anchor" href="#lib-kotlin"></a> lib-kotlin</h3>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">InterfaceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="meta">@Hide</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInterface</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KotlinTest</span>(a: <span class="built_in">Int</span>) : InterfaceTest &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="meta">@Hide</span></span><br><span class="line">    <span class="keyword">constructor</span>() : <span class="keyword">this</span>(-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">newKotlinTest</span><span class="params">()</span></span> = KotlinTest()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding: LayoutKotlinTestBinding? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨api-ktä¸­çš„æ³¨è§£</span></span><br><span class="line">    <span class="keyword">var</span> a = a</span><br><span class="line">        <span class="meta">@Hide</span> <span class="keyword">get</span></span><br><span class="line">        <span class="meta">@Hide</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getA1</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        a = <span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">testInterface</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Interface function test&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="app"><a class="markdownIt-Anchor" href="#app"></a> app</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># MainActivity.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testKotlinLib</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡æ—¶ä¸èƒ½è®¿é—®æ— å‚æ„é€ æ–¹æ³•ï¼Œå¯ä»¥è®¿é—®æœ‰å‚æ„é€ æ–¹æ³•æˆ–è®¿é—®é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="type">KotlinTest</span> <span class="variable">test</span> <span class="operator">=</span> KotlinTest.newKotlinTest();</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ—¶ä¸èƒ½è®¿é—®`test.getA()`æ–¹æ³•ï¼Œä»…èƒ½è®¿é—®`getA1()æ–¹æ³•</span></span><br><span class="line">    Log.e(TAG, <span class="string">&quot;testKotlinLib: before --&gt; &quot;</span> + test.getA1());</span><br><span class="line">    test.test();</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;testKotlinLib: after --&gt; &quot;</span> + test.getA1());</span><br><span class="line">    </span><br><span class="line">    test.testInterface();</span><br><span class="line">    </span><br><span class="line">    <span class="type">InterfaceTest</span> <span class="variable">interfaceTest</span> <span class="operator">=</span> test;</span><br><span class="line">    <span class="comment">// Error - cannot resolve method &#x27;testInterface&#x27; in &#x27;InterfaceTest&#x27;</span></span><br><span class="line">    interfaceTest.testInterface();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>happy:happy:</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡çŒ®"></a> å‚è€ƒæ–‡çŒ®</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>[Writing Your First Kotlin Compiler Plugin (<a href="http://jetbrains.com">jetbrains.com</a>)](<a href="https://resources.jetbrains.com/storage/products/kotlinconf2018/slides/5_Writing">https://resources.jetbrains.com/storage/products/kotlinconf2018/slides/5_Writing</a> Your First Kotlin Compiler Plugin.pdf) <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>kcp</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-åç¨‹ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿï¼Ÿ</title>
    <url>/2022/05/29/Kotlin/Kotlin-%E5%8D%8F%E7%A8%8B%E4%B8%BA%E7%BA%BF%E7%A8%8B%E6%A1%86%E6%9E%B6%E8%80%8C%E7%94%9F%EF%BC%9F/</url>
    <content><![CDATA[<h1 id="kotlin-åç¨‹ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿ"><a class="markdownIt-Anchor" href="#kotlin-åç¨‹ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿ"></a> Kotlin-åç¨‹ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿï¼Ÿ</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 1 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>ç¬”è€…åœ¨å¼€å§‹å­¦ä¹  Kotlin åç¨‹æ—¶ï¼Œåœ¨ç½‘ä¸Šç»å¸¸çœ‹åˆ° â€œKotlin åç¨‹æ˜¯ä¸€ç§çº¿ç¨‹æ¡†æ¶â€ è¿™ç§è¯´æ³•ï¼Œå½“æ—¶è®¤ä¸ºè¿™ç§è¯´æ³•å¥½ç‰›é€¼ï¼Œåç¨‹æ¯”çº¿ç¨‹æ›´å‰å®³ï¼Œæ€§èƒ½è‚¯å®šæ¯”çº¿ç¨‹æ›´å¥½ï¼Œæ­¤ä¸€æ—¶å½¼ä¸€æ—¶ï¼Œç°åœ¨æˆ‘å¯¹è¿™ç§è¯´æ³•ä¸æ•¢è‹ŸåŒã€‚</p>
<h2 id="ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿ"><a class="markdownIt-Anchor" href="#ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿ"></a> ä¸ºçº¿ç¨‹æ¡†æ¶è€Œç”Ÿï¼Ÿ</h2>
<p>è¿™é‡Œä¸å¦¨å†é—®ä¸€ä¸‹ï¼Œä½•ä¸ºæ¡†æ¶ï¼Ÿæˆ‘ä»¬ä¸€ç›´åœ¨è¯´çš„å„ç§å¼€å‘æ¡†æ¶ï¼Œç”šè‡³è‡ªå·±å¼€å‘ä¸€ä¸ªæ¡†æ¶ï¼Œæ¯”å¦‚åœ¨ Android ä¸­ä½¿ç”¨ MVP + Retrofit æ­å»ºå¼€å‘æ¡†æ¶ï¼Œå¯èƒ½æˆ‘ä»¬æ›´å¤šå…³æ³¨ä½¿ç”¨æ¡†æ¶ï¼Œè€Œå¿½ç•¥äº†ä»€ä¹ˆæ˜¯æ¡†æ¶ã€‚</p>
<blockquote>
<p>åœ¨<a href="https://en.wikipedia.org/wiki/Computer_programming">è®¡ç®—æœºç¼–ç¨‹</a>ä¸­ï¼Œ<strong>è½¯ä»¶æ¡†æ¶</strong>æ˜¯ä¸€ç§<a href="https://en.wikipedia.org/wiki/Abstraction_(computer_science)">æŠ½è±¡</a>ï¼Œå…¶ä¸­æä¾›é€šç”¨åŠŸèƒ½<a href="https://en.wikipedia.org/wiki/Software">çš„è½¯ä»¶</a>å¯ä»¥é€šè¿‡å…¶ä»–ç”¨æˆ·ç¼–å†™çš„ä»£ç æœ‰é€‰æ‹©åœ°æ›´æ”¹ï¼Œä»è€Œæä¾›ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„è½¯ä»¶ã€‚å®ƒæä¾›äº†ä¸€ç§æ„å»ºå’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ ‡å‡†æ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªé€šç”¨çš„ã€å¯é‡ç”¨<a href="https://en.wikipedia.org/wiki/Software_environment_(disambiguation)">çš„è½¯ä»¶ç¯å¢ƒ</a>ï¼Œå®ƒæä¾›ç‰¹å®šåŠŸèƒ½ä½œä¸ºæ›´å¤§<a href="https://en.wikipedia.org/wiki/Software_platform">è½¯ä»¶å¹³å°</a>çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ä¿ƒè¿›<a href="https://en.wikipedia.org/wiki/Software_application">è½¯ä»¶åº”ç”¨ç¨‹åº</a>ã€äº§å“å’Œè§£å†³æ–¹æ¡ˆçš„å¼€å‘ã€‚è½¯ä»¶æ¡†æ¶å¯èƒ½åŒ…æ‹¬æ”¯æŒç¨‹åºã€ç¼–è¯‘å™¨ã€ä»£ç åº“ã€å·¥å…·é›†å’Œ<a href="https://en.wikipedia.org/wiki/Application_programming_interface">åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ ï¼ˆAPI</a>ï¼‰ï¼Œå®ƒä»¬å°†æ‰€æœ‰ä¸åŒçš„<a href="https://en.wikipedia.org/wiki/Software_component">ç»„ä»¶</a>ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥å®ç°<a href="https://en.wikipedia.org/wiki/Software_project">é¡¹ç›®</a>æˆ–<a href="https://en.wikipedia.org/wiki/Software_system">ç³»ç»Ÿçš„</a>å¼€å‘ã€‚<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
</blockquote>
<p>ä»¥ä¸Šå¯¹ã€Œè½¯ä»¶æ¡†æ¶ã€çš„æè¿°æ‘˜è‡ªç»´åŸºç™¾ç§‘ï¼Œæ˜¯ä¸æ˜¯æ„Ÿåˆ°æ¯”è¾ƒæ¨¡ç³Šï¼Œè¿™å•¥ï¼Ÿ</p>
<p>å¯¹æ¯ä¸ªäººæ¥è¯´ï¼Œå¯¹æ¡†æ¶çš„ç†è§£ã€åˆ’åˆ†éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ–è®¸æˆ‘ä»¬è®¤ä¸º OkHttp æ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ¡†æ¶ï¼ŒRetrofit åŸºäº OkHttp ä¹Ÿæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼ŒAndroid ç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªæ¡†æ¶ã€‚</p>
<p>æ¡†æ¶æœ‰å¤§æœ‰å°ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œæ¡†æ¶æ˜¯ä¸€ç§åŠæˆå“ï¼Œä¸ºäº†å®ç°æŸç§åŠŸèƒ½ï¼Œæä¾›ä¸€äº›åŸºç¡€é€šç”¨çš„ç»„ä»¶ï¼Œæ¯”å¦‚ Android ä¸ºå¼€å‘è€…æä¾› SDK å¼€å‘å·¥å…·åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ SDK å¼€å‘è‡ªå·±çš„ Appï¼Œå®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>å“ªä»€ä¹ˆæ˜¯çº¿ç¨‹æ¡†æ¶å‘¢ï¼Ÿå¯¹çº¿ç¨‹æ¡†æ¶çš„ç†è§£ï¼Œä¹Ÿæ˜¯ä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºï¼Œæˆ–è®¸ä½ è®¤ä¸º <code>Executor</code> æ˜¯ä¸€ç§çº¿ç¨‹æ¡†æ¶ï¼Œåœ¨ä½¿ç”¨æ—¶ä¸ç”¨å…³å¿ƒä»€ä¹ˆæ—¶å€™å¯åŠ¨çº¿ç¨‹ï¼Œçº¿ç¨‹ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œåªè¦æ‰§è¡Œ <code>execute</code> å³å¯ï¼Œæˆ–è®¸ä½ è®¤ä¸º RxJava ä¹Ÿæ˜¯ä¸€ç§çº¿ç¨‹æ¡†æ¶ï¼Œåœ¨ä½¿ç”¨æ—¶å¯ä»¥ä½¿ç”¨æ“ä½œç¬¦æ–¹ä¾¿çš„åˆ‡æ¢çº¿ç¨‹ã€‚</p>
<p>ä¸Šè¿°ä¸¾ä¾‹çš„ <code>Executor</code> å’Œ <code>RxJava</code>  æœ‰ä¸ªå…±åŒç‚¹ï¼šå®ƒä»¬éƒ½å¯ä»¥åˆ‡çº¿ç¨‹ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºï¼šèƒ½åˆ‡çº¿ç¨‹å°±æ˜¯çº¿ç¨‹æ¡†æ¶å‘¢ï¼Ÿæˆ‘å¦‚æœé—®ä½  <code>Handler</code> ä¹Ÿèƒ½åˆ‡çº¿ç¨‹ï¼Œä½ è®¤ä¸º <code>Handler</code> ä¹Ÿæ˜¯çº¿ç¨‹æ¡†æ¶ä¹ˆï¼Ÿ</p>
<p><code>Handler</code> çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ <code>Handler</code> ä¸»è¦ç”¨äºæ¶ˆæ¯å¤„ç†ï¼Œæ¶ˆæ¯å¯èƒ½æ¥è‡ªä¸»çº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªå­çº¿ç¨‹ï¼Œæ¥è‡ªå­çº¿ç¨‹æ—¶ï¼ŒåŠ¿å¿…æ¶‰åŠçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸º <code>Handler</code> ä¸æ˜¯çº¿ç¨‹æ¡†æ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†æ¡†æ¶ï¼Œåªæ˜¯æä¾›äº†åˆ‡çº¿ç¨‹çš„æ–¹æ³•ã€‚</p>
<p>å›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬å†çœ‹ Kotlin åç¨‹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…è¯´ Kotlin åç¨‹ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚ç¬”è€…è®¤ä¸º Kotlin åç¨‹å¯ä»¥ç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±ï¼ŒæŠŠå¼‚æ­¥è°ƒç”¨å†™æˆåŒæ­¥è°ƒç”¨çš„å½¢å¼ï¼Œä¸€ç§å¼‚æ­¥è½¬åŒæ­¥çš„ç¼–ç¨‹æ€æƒ³ï¼Œè€Œå¼‚æ­¥è°ƒç”¨å¯èƒ½æ¶‰åŠçº¿ç¨‹åˆ‡æ¢ï¼Œæ­£å¥½ Kotlin åç¨‹æä¾›äº†åˆ‡çº¿ç¨‹çš„æ–¹æ³•ã€‚</p>
<p>è¯´åˆ°å¼‚æ­¥è°ƒç”¨ï¼Œä½ ä¸åˆ‡çº¿ç¨‹å’‹å¼‚æ­¥è°ƒç”¨å‘¢ï¼Ÿæƒ³æƒ³åœ¨ Android ä¸­ï¼Œä½ åœ¨ <code>Activity#onResume</code> ä¸­ä½¿ç”¨ <code>handlper.post</code> ä¸€ä¸ª <code>Runnable</code>ï¼Œ è¿™ä¸ª <code>Runnable</code> çš„æ‰§è¡Œæœ‰åˆ‡æ¢çº¿ç¨‹ä¹ˆï¼Ÿ</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume()</span><br><span class="line">    handler.post &#123;</span><br><span class="line">        <span class="comment">// Do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>Kotlinåç¨‹æ˜¯ä¸€ä¸ªå›è°ƒæ¡†æ¶ï¼Œå®ƒå¯ä»¥ä½¿å¼‚æ­¥ä»£ç åŒæ­¥åŒ–ï¼ŒåŒæ—¶æä¾›ç»“æ„åŒ–å¹¶å‘çš„ç‰¹æ€§ï¼Œä½¿å¹¶å‘ä»£ç ç®€æ´åŒ–ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†åˆ‡æ¢çº¿ç¨‹çš„èƒ½åŠ›ï¼Œæ–¹ä¾¿å†™å‡ºé«˜æ•ˆçš„å¼‚æ­¥å’Œå¹¶å‘ä»£ç ã€‚</p>
<h2 id="è¯´æ˜"><a class="markdownIt-Anchor" href="#è¯´æ˜"></a> è¯´æ˜</h2>
<p>ä»¥ä¸Šä¸ºç¬”è€…ä¸ªäººè§è§£ï¼Œä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºï¼Œå¤§å®¶å¯ä»¥æ±‚åŒå­˜å¼‚ï¼ŒåŒæ—¶ç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œæ¬¢è¿äº¤æµã€‚</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡çŒ®"></a> å‚è€ƒæ–‡çŒ®</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/Software_framework">è½¯ä»¶æ¡†æ¶</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>coroutines</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-å›è°ƒå¦‚ä½•è½¬æˆæŒ‚èµ·å‡½æ•°</title>
    <url>/2022/05/31/Kotlin/Kotlin-%E5%9B%9E%E8%B0%83%E5%A6%82%E4%BD%95%E8%BD%AC%E6%88%90%E6%8C%82%E8%B5%B7%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="kotlin-å›è°ƒå¦‚ä½•è½¬æˆæŒ‚èµ·å‡½æ•°"><a class="markdownIt-Anchor" href="#kotlin-å›è°ƒå¦‚ä½•è½¬æˆæŒ‚èµ·å‡½æ•°"></a> Kotlin-å›è°ƒå¦‚ä½•è½¬æˆæŒ‚èµ·å‡½æ•°</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 9 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>ç¬”è€…åœ¨é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Kotlin æ—¶è¿˜æ˜¯ Java å’Œ Kotlin æ··åˆçš„é¡¹ç›®ï¼Œæ‰€ä»¥å¯¹äºä¸€äº› Java åº“æä¾›çš„å›è°ƒæ¥å£ï¼Œå†ä½¿ç”¨ Java çš„æ–¹å¼è°ƒç”¨æ„Ÿè§‰ä½¿ç”¨äº†å‡çš„ Kotlinã€‚</p>
<p>æœ¬æ–‡è®°å½•ä¸‹ç¬”è€…åœ¨ä½¿ç”¨ Kotlin è¿‡ç¨‹ä¸­ï¼ŒæŠŠ Java å›è°ƒè½¬æˆæŒ‚èµ·å‡½æ•°çš„è¿‡ç¨‹ï¼Œä¸æ­¢æ˜¯ Java å›è°ƒï¼ŒKotlin å›è°ƒä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h2 id="å•ä¸€å›è°ƒæ–¹æ³•"><a class="markdownIt-Anchor" href="#å•ä¸€å›è°ƒæ–¹æ³•"></a> å•ä¸€å›è°ƒæ–¹æ³•</h2>
<p>å•ä¸€å›è°ƒæ–¹æ³•æ˜¯æœ€å®¹æ˜“è½¬æˆæŒ‚èµ·å‡½æ•°çš„ï¼Œä»¥ Android ä¸­å¸¸è§çš„ç‚¹å‡»äº‹ä»¶æ¥å£ä¸ºä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„Viewï¼Œä»£è¡¨Androidä¸­çš„View</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">View</span>(<span class="keyword">val</span> viewId: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„OnClickListenerï¼Œä»£è¡¨Androidä¸­çš„OnClickListener</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> OnClickListener &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(view: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„setOnClickListenerï¼Œä»£è¡¨Android Viewä¸­çš„setOnClickListener</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setOnClickListener</span><span class="params">(listener: <span class="type">OnClickListener</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    thread &#123;</span><br><span class="line">        <span class="comment">// ç¡çœ 2ç§’</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨å›è°ƒæ–¹æ³•</span></span><br><span class="line">        listener.onClick(View(-<span class="number">1</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç æ˜¯å¯¹ Android ä¸­ç‚¹å‡»äº‹ä»¶çš„æŠ½è±¡ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥æ˜¯ä»¥ä¸‹é¢çš„å½¢å¼è°ƒç”¨ <code>setOnClickListener</code> æ–¹æ³•ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    setOnClickListener &#123; view -&gt;</span><br><span class="line">        view.viewId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬æ€ä¹ˆæŠŠ <code>setOnClickListener</code> æ–¹æ³•è½¬æˆæŒ‚èµ·å‡½æ•°å‘¢ï¼Ÿå°±æ˜¯ä½¿ç”¨ Kotlin  æä¾›çš„ <code>suspendCoroutine</code> æ–¹æ³•ï¼Œ<code>suspendCoroutine</code> æ–¹æ³•å¯ä»¥å¸®æˆ‘ä»¬æ‹¿åˆ°å½“å‰åç¨‹çš„ <code>Continuation</code> å®ä¾‹ï¼Œç¬”è€…åœ¨ <a href="https://juejin.cn/post/7103543028316373005">Kotlin-æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥ï¼Ÿ</a> ä¸­ç®€å•ä»‹ç»äº† <code>suspendCoroutine</code> çš„å®ç°ã€‚</p>
<p>ä¸‹é¢è®©æˆ‘ä»¬æŠŠå›è°ƒè½¬æˆæŒ‚èµ·å‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">setOnClickListenerSuspend</span><span class="params">()</span></span>: View &#123;</span><br><span class="line">    <span class="keyword">return</span> suspendCoroutine &#123; continuation -&gt;</span><br><span class="line">        setOnClickListener &#123; view -&gt;</span><br><span class="line">            continuation.resume(view)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå£°æ˜æŒ‚èµ·æ–¹æ³• <code>setOnClickListenerSuspend</code> è¿”å›å€¼ä¸ºå›è°ƒæ–¹æ³•ä¸­çš„å…¥å‚ç±»å‹ Viewï¼Œæ¥ç€å†™æŒ‚èµ·å‡½æ•°çš„æ–¹æ³•ä½“ï¼Œç›´æ¥è°ƒç”¨ <code>suspendCoroutine</code> è¿”å›ï¼Œåœ¨ <code>suspendCoroutine</code> çš„ block ä¸­è°ƒç”¨åŸæ¥çš„ <code>setOnClickListener</code> ä¼ å…¥å›è°ƒï¼Œæœ€ååœ¨å›è°ƒä¸­è°ƒç”¨ <code>Continuation#resume</code> å‡½æ•°ä¼ å…¥å›è°ƒæ–¹æ³•çš„View ç±»å‹çš„å…¥å‚ã€‚</p>
<p>è¿™æ ·å°±å®Œæˆäº†å•ä¸€å›è°ƒæ–¹æ³•è½¬æˆæŒ‚èµ·å‡½æ•°ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸‹è¯•è¯•ï¼Œä¸åŸæ¥å›è°ƒçš„æ–¹å¼å¯¹æ¯”ä¸€ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mainæ–¹æ³•å¢åŠ suspendå…³é”®å­—</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›è°ƒçš„æ–¹å¼</span></span><br><span class="line">    setOnClickListener &#123; view -&gt;</span><br><span class="line">        view.viewId</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‡½æ•°çš„æ–¹å¼</span></span><br><span class="line">    <span class="keyword">val</span> view = setOnClickListenerSuspend()</span><br><span class="line">    view.viewId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€šè¿‡ <code>suspendCoroutine</code> æŠŠå•ä¸€å›è°ƒæ–¹æ³•è½¬æˆäº†æŒ‚èµ·å‡½æ•°ï¼Œä¸åŸæ¥å›è°ƒçš„æ–¹å¼ç›¸æ¯”ï¼Œä»£ç é¡ºåºä¸Šæ˜¯æŒ‚èµ·å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„å½¢å¼ï¼Œçœ‹èµ·æ¥æ›´ç›´è§‚ä¸€äº›ã€‚</p>
<h2 id="ä¸¤ä¸ªå›è°ƒæ–¹æ³•"><a class="markdownIt-Anchor" href="#ä¸¤ä¸ªå›è°ƒæ–¹æ³•"></a> ä¸¤ä¸ªå›è°ƒæ–¹æ³•</h2>
<p>ä¸¤ä¸ªå›è°ƒæ–¹æ³•æˆ‘ä»¬å¸¸è§çš„æ˜¯ OkHttp ä¸­çš„ç½‘ç»œè¯·æ±‚å›è°ƒï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Response</span>(<span class="keyword">val</span> value: String)</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Callback</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(e: <span class="type">IOException</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Throws(IOException::class)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(response: <span class="type">Response</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sendRequest</span><span class="params">(callback: <span class="type">Callback</span>)</span></span> &#123;</span><br><span class="line">    thread &#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            callback.onResponse(Response(<span class="string">&quot;gudongAndroid&quot;</span>))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">            callback.onFailure(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬è°ƒç”¨åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    sendRequest(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(e: <span class="type">IOException</span>)</span></span> &#123;</span><br><span class="line">            println(e)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">            println(response.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>object</code> å…³é”®å­—æ„é€ å›è°ƒçš„åŒ¿åç±»ç„¶åä¼ å…¥ <code>sendRequest</code> æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ <code>suspendCoroutine</code> æ–¹æ³•æŠŠ <code>sendRequest</code> æ–¹æ³•è½¬æˆæŒ‚èµ·å‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestSuspend</span><span class="params">()</span></span> = suspendCoroutine&lt;Response&gt; &#123; continuation -&gt;</span><br><span class="line">    sendRequest(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(e: <span class="type">IOException</span>)</span></span> &#123;</span><br><span class="line">            continuation.resumeWithException(e)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">            continuation.resume(response)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>onFailure</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>Continuation#resumeWithException</code> å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨ <code>onResponse</code> æ–¹æ³•ä¸­è¿˜æ˜¯è°ƒç”¨ <code>Continuation#resume</code> å‡½æ•°ä¼ å…¥ç»“æœï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸‹å‰åä½¿ç”¨ä¸Šçš„å·®å¼‚ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›è°ƒçš„æ–¹å¼</span></span><br><span class="line">    sendRequest(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(e: <span class="type">IOException</span>)</span></span> &#123;</span><br><span class="line">            println(e)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">            println(response.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‡½æ•°çš„æ–¹å¼</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> response = sendRequestSuspend()</span><br><span class="line">        println(response.value)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">        println(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æŒ‚èµ·å‡½æ•°çš„æ–¹å¼ï¼Œ<code>Continuation#resumeWithException</code> å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸ä¸€èˆ¬ä½¿ç”¨ <code>try catch</code> æ•è·å¼‚å¸¸ï¼Œè°ƒç”¨æ–¹å¯ä»¥æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†é€»è¾‘ã€‚</p>
<h2 id="å¤šä¸ªå›è°ƒæ–¹æ³•"><a class="markdownIt-Anchor" href="#å¤šä¸ªå›è°ƒæ–¹æ³•"></a> å¤šä¸ªå›è°ƒæ–¹æ³•</h2>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>coroutines</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin-æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥ï¼Ÿ</title>
    <url>/2022/05/30/Kotlin/Kotlin-%E6%8C%82%E8%B5%B7%E5%87%BD%E6%95%B0%E6%8C%82%E8%B5%B7%E4%BA%86%E5%95%A5%EF%BC%9F/</url>
    <content><![CDATA[<h1 id="kotlin-æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥"><a class="markdownIt-Anchor" href="#kotlin-æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥"></a> Kotlin-æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥ï¼Ÿ</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 2 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<p>ä¸ç’å„ä½ï¼Œç¬”è€…åœ¨åˆšå¼€å§‹å­¦ä¹  Kotlin åç¨‹çš„æ—¶å€™çœ‹åˆ°æŒ‚èµ·å‡½æ•°æ€»æ˜¯æƒ³åˆ°é˜»å¡çº¿ç¨‹ï¼Œä¸ºå•¥å‘€ï¼Ÿå› ä¸ºä»è¡¨é¢ä¸Šçœ‹ï¼Œæ‰§è¡ŒæŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œåé¢çš„ä»£ç å°±ä¸æ‰§è¡Œäº†ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†æŒ‚èµ·å‡½æ•°éƒ½æ˜¯è€—æ—¶çš„ï¼Œè¿™ä¸åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œä¼šé˜»å¡çº¿ç¨‹ç±»ä¼¼ï¼Œä¸¾ä¸ªæ —å­ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">GlobalScope.launch &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‚èµ·å‡½æ•°å‰çš„ä»£ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    println(<span class="string">&quot;1:<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) <span class="comment">// â‘  æ ‡è®°1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰§è¡ŒæŒ‚èµ·å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‚èµ·å‡½æ•°åçš„ä»£ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    println(<span class="string">&quot;2:<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) <span class="comment">// â‘¡ æ ‡è®°2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä» â‘  å’Œ â‘¡ çš„è¾“å‡ºç»“æœæ¥çœ‹ï¼Œä»£ç çš„ç¡®é—´éš” 1 ç§’é’Ÿæ‰§è¡Œï¼Œä»ä»£ç é¡ºåºä¸Šçœ‹ï¼Œ<code>delay(1000)</code> æ€ä¹ˆçœ‹éƒ½æ˜¯é˜»å¡äº†çº¿ç¨‹ 1 ç§’é’Ÿï¼Œç±»ä¼¼ Java ä¸­çš„ <code>Thread.sleep(1000)</code> ï¼Œè¿™çœ‹èµ·æ¥ä¸å°±æ˜¯é˜»å¡æ‰§è¡Œäº†ä¹ˆï¼Ÿ</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä¸å°‘è¯»è€…å·²ç»è¿·ç³Šäº†ï¼ŒKotlin åç¨‹ä¸æ˜¯éé˜»å¡çš„ä¹ˆï¼Ÿä¸Šé¢ä»£ç çœ‹èµ·æ¥æ˜¯é˜»å¡çš„å•Šã€‚</p>
<h2 id="ä½•ä¸ºé˜»å¡"><a class="markdownIt-Anchor" href="#ä½•ä¸ºé˜»å¡"></a> ä½•ä¸ºé˜»å¡</h2>
<p>æ¬¸ï¼Œåˆ«æ…Œï¼Œå…ˆææ˜ç™½é˜»å¡æ˜¯ä»€ä¹ˆï¼Œé˜»å¡çš„å¯¹è±¡æ˜¯è°ï¼Ÿ</p>
<p>é˜»å¡å¯¹æ¯”ç°å®ä¸–ç•Œçš„ä¾‹å­æ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯”å¦‚å»è¶…å¸‚è´­ç‰©ç»“è´¦æ—¶ï¼š</p>
<ul>
<li>ä½ ç»“è´¦çš„çª—å£æ‰«ç æªåäº†ï¼Œç»“ä¸äº†è´¦ï¼ˆå‘ç”Ÿé˜»å¡ï¼‰</li>
<li>ç­‰åˆ°æ¢ä¸ªæ–°çš„æ‰«ç æªæ‰èƒ½ç»“è´¦ï¼ˆé˜»å¡æ¢å¤ï¼‰</li>
</ul>
<p>ç°åœ¨çœ‹çœ‹é˜»å¡çš„æ˜¯è°å‘¢ï¼Ÿé˜»å¡çš„å°±æ˜¯è¿™ä¸ªç»“è´¦çª—å£ï¼ˆçº¿ç¨‹ï¼‰ï¼Œæ²¡é”™ï¼Œé˜»å¡çš„æ˜¯çº¿ç¨‹ã€‚</p>
<p>é˜»å¡ä¸é˜»å¡æ˜¯é’ˆå¯¹å½“å‰çº¿ç¨‹æ¥è¯´çš„ï¼Œå»åˆ«çš„çº¿ç¨‹æ‰§è¡Œï¼Œè‡ªç„¶ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸Šè¿°ç»“è´¦ï¼Œä½ å¯ä»¥å»å…¶ä»–çª—å£è¿›è¡Œç»“è´¦ã€‚</p>
<p>å›è¿‡å¤´çœ‹ä¸Šé¢çš„ä»£ç ä¾‹å­ï¼Œæ— è®ºæ˜¯ä»ä»£ç æ‰§è¡Œé¡ºåºè¿˜æ˜¯ä»£ç æ‰§è¡Œç»“æœä¸Šçœ‹ï¼Œéƒ½åƒæ˜¯é˜»å¡æ‰§è¡Œï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;1:<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) <span class="comment">// â‘  æ ‡è®°1</span></span><br><span class="line">    handler.postDelayed(&#123;</span><br><span class="line">        println(<span class="string">&quot;2:<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>) <span class="comment">// â‘¡ æ ‡è®°2          </span></span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android å¼€å‘åŒå­¦çœ‹è§ Handler åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå¯¹æ¯”è¿™ä¸¤ä¸ªä»£ç ç¤ºä¾‹ï¼Œä»ä»£ç æ‰§è¡Œé¡ºåºè¿˜æ˜¯ä»£ç æ‰§è¡Œç»“æœä¸Šæ˜¯å¦æ˜¯ä¸€æ ·çš„å‘¢ï¼Ÿæˆ–è®¸æˆ‘ä»¬åº”è¯¥çœ‹çœ‹ <code>delay</code> çš„æºç äº†</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">delay</span><span class="params">(timeMillis: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (timeMillis &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="comment">// don&#x27;t delay</span></span><br><span class="line">    <span class="keyword">return</span> suspendCancellableCoroutine <span class="symbol">sc@</span> &#123; cont: CancellableContinuation&lt;<span class="built_in">Unit</span>&gt; -&gt;</span><br><span class="line">        <span class="comment">// if timeMillis == Long.MAX_VALUE then just wait forever like awaitCancellation, don&#x27;t schedule.</span></span><br><span class="line">        <span class="keyword">if</span> (timeMillis &lt; <span class="built_in">Long</span>.MAX_VALUE) &#123;</span><br><span class="line">            cont.context.delay.scheduleResumeAfterDelay(timeMillis, cont)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>cont.context.delay.scheduleResumeAfterDelay(timeMillis, cont)</code> è¿™ä¸ªæ“ä½œï¼Œå’Œ <code>handler.postDelay()</code> ç±»ä¼¼ï¼Œæœ¬è´¨ä¸Šæ˜¯è®¾ç½®ä¸€ä¸ªå»¶æ—¶çš„å›è°ƒï¼Œæ—¶é—´åˆ°äº†å°±è°ƒç”¨ <code>cont</code> çš„ resume ç­‰æ–¹æ³•è®©åç¨‹æ¢å¤ã€‚</p>
<h2 id="kotlin-åç¨‹çš„éé˜»å¡ä½“ç°åœ¨å“ªå‘¢"><a class="markdownIt-Anchor" href="#kotlin-åç¨‹çš„éé˜»å¡ä½“ç°åœ¨å“ªå‘¢"></a> Kotlin åç¨‹çš„éé˜»å¡ä½“ç°åœ¨å“ªå‘¢ï¼Ÿ</h2>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»çŸ¥é“é˜»å¡çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼Œçº¿ç¨‹æ˜¯åœ¨ CPU é‡Œæ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¯ä»¥è¯´é˜»å¡çš„å¯¹è±¡ä¹Ÿæ˜¯ CPUï¼Œè€Œ Kotlin åç¨‹çš„éé˜»å¡åªæ˜¯è¯­è¨€å±‚é¢çš„ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„é˜»å¡ï¼Œè¯´æ˜åœ¨åç¨‹ä¸­è°ƒç”¨é˜»å¡çš„æ–¹æ³•ï¼Œæ¯”å¦‚ <code>Thread.sleep()</code> çš„æ—¶å€™ï¼Œåç¨‹ä»ç„¶æ˜¯é˜»å¡çš„ã€‚</p>
<p>Kotlin åç¨‹çš„éé˜»å¡æ˜¯ä¸çº¿ç¨‹é˜»å¡ç›¸æ¯”è¾ƒçš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è°ƒç”¨ <code>Thread.sleep()</code> ä¼‘çœ çº¿ç¨‹è¾¾åˆ°å»¶è¿Ÿçš„æ•ˆæœï¼Œåç¨‹åˆ™å¯ä»¥ä½¿ç”¨ <code>delay()</code> æŒ‚èµ·åŒæ ·è¾¾åˆ°å»¶è¿Ÿæ•ˆæœã€‚</p>
<h2 id="é‚£æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥"><a class="markdownIt-Anchor" href="#é‚£æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥"></a> é‚£æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥ï¼Ÿ</h2>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œåç¨‹åœ¨å“ªé‡ŒæŒ‚èµ·çš„ï¼Œé’ˆå¯¹ç¬¬ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåç¨‹åœ¨ <code>delay(1000)</code> å¤„æŒ‚èµ·ï¼Œé‚£å®ƒæŒ‚èµ·äº†ä»€ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬ä¸å¦¨æƒ³ä¸€ä¸‹ï¼Œåœ¨é…’åº—ç‚¹èœæ—¶çš„æŒ‚èµ·ï¼Œå®¢äººç‚¹äº†ä¸€ä»½èœå•ï¼Œä½†æ˜¯å‘ŠçŸ¥ç°åœ¨ä¸èƒ½å¼€å§‹åšï¼Œç­‰åŠå°æ—¶åå†å¼€å§‹åšï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿä¸­å…ˆå½•å…¥è¿™ä»½èœå•ï¼Œç‚¹å‡»æŒ‚èµ·ï¼Œè¾“å…¥æŒ‚èµ·æ—¶é•¿ä¿å­˜ï¼Œç­‰æŒ‚èµ·æ—¶é•¿åˆ°äº†ï¼Œç³»ç»Ÿè‡ªåŠ¨æŠŠèœå•å‘ç»™åå¨ï¼Œåå¨å¼€å§‹åšèœã€‚</p>
<p>ä¸Šé¢é…’åº—ç‚¹èœçš„ç¤ºä¾‹ï¼Œå’Œ <code>delay()</code> çš„æ•ˆæœç±»ä¼¼ï¼Œéƒ½æ˜¯å»¶è¿Ÿè§¦å‘åç»­çš„é€»è¾‘ã€‚åœ¨ç‚¹èœç¤ºä¾‹ä¸­æŒ‚èµ·çš„ä»€ä¹ˆï¼Ÿæ˜¯èœå•è¿˜æ˜¯åšèœåŠ¨ä½œï¼Ÿè¿™é‡Œç¬”è€…è®¤ä¸ºæ˜¯åšèœçš„åŠ¨ä½œï¼Œè€Œèœå•è®¤ä¸ºæ˜¯æŒ‚èµ·ç‚¹ï¼Œå³ä»èœå•æŒ‚èµ·ï¼Œä¹Ÿä»èœå•æ¢å¤ï¼Œå¯¹åº”ç¬¬ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼Œæ—¢ä» <code>delay(1000)</code> å¤„æŒ‚èµ·ï¼Œä¹Ÿä» <code>delay(1000)</code> å¤„æ¢å¤ï¼ŒæŒ‚èµ·çš„æ˜¯ <code>delay(1000)</code> ä¹‹åè¦æ‰§è¡Œçš„ä»£ç ï¼Œæˆ–è€…è¯´æŒ‚èµ·äº†åç¨‹æ¢å¤åè¦æ‰§è¡Œçš„ä»£ç ï¼Œå³ â‘¡ å¤„ä»£ç ã€‚</p>
<p>ç°åœ¨è¿˜æœ‰ <code>suspendCancellableCoroutine</code> æ¯”è¾ƒç¥ç§˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">suspend</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">suspendCancellableCoroutine</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">crossinline</span> block: (<span class="type">CancellableContinuation</span>&lt;<span class="type">T</span>&gt;) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: T =</span><br><span class="line">    suspendCoroutineUninterceptedOrReturn &#123; uCont -&gt;</span><br><span class="line">        <span class="keyword">val</span> cancellable = CancellableContinuationImpl(uCont.intercepted(), resumeMode = MODE_CANCELLABLE)</span><br><span class="line">        cancellable.initCancellability()</span><br><span class="line">        block(cancellable)</span><br><span class="line">        cancellable.getResult()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>suspendCoroutineUninterceptedOrReturn</code> è¿™ä¸ªæ–¹æ³•çš„æºç æ˜¯çœ‹ä¸åˆ°çš„ï¼Œå®ƒæœ¬èº«å°±æ²¡æœ‰æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">suspend</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">suspendCoroutineUninterceptedOrReturn</span><span class="params">(<span class="keyword">crossinline</span> block: (<span class="type">Continuation</span>&lt;<span class="type">T</span>&gt;) -&gt; <span class="type">Any</span>?)</span></span>: T &#123;</span><br><span class="line">    contract &#123; callsInPlace(block, InvocationKind.EXACTLY_ONCE) &#125;</span><br><span class="line">    <span class="keyword">throw</span> NotImplementedError(<span class="string">&quot;Implementation of suspendCoroutineUninterceptedOrReturn is intrinsic&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬æ‹¿åˆ°å½“å‰åç¨‹çš„ <code>Continuation</code> å®ä¾‹ï¼Œä¸è¿‡æˆ‘é€šè¿‡ç¿»é˜… Kotlin æºç ï¼ˆæœç´¢ <code>suspendCoroutineUninterceptedOrReturn</code> å…³é”®å­—ï¼‰æ‰¾åˆ°äº†ä»¥ä¸‹ä»£ç ï¼Œç¬”è€…è®¤ä¸ºä¸‹å›¾<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ä¸­ä»£ç å°±æ˜¯å…·ä½“çš„å®ç°ï¼Œä»£ç ä¸­çš„æ³¨é‡Šï¼Œæ­£å¥½å¯¹åº”æºç ä¸­çš„ <code>block</code>ã€<code>Continuation</code>:</p>
<p><img data-src="https://guodongandroid.coding.net/p/typora/d/typora/git/raw/master/img/202205301732755.png" alt="image-20220530173205836" /></p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>Kotlin åç¨‹çš„æŒ‚èµ·å‡½æ•°æŒ‚èµ·äº†å•¥ï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‚èµ·çš„æ˜¯æŒ‚èµ·å‡½æ•°æ¢å¤ä¹‹åè¦æ‰§è¡Œçš„é€»è¾‘ã€‚</p>
<h2 id="è¯´æ˜"><a class="markdownIt-Anchor" href="#è¯´æ˜"></a> è¯´æ˜</h2>
<p>ä»¥ä¸Šä¸ºç¬”è€…ä¸ªäººè§è§£ï¼Œä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºï¼Œå¤§å®¶å¯ä»¥æ±‚åŒå­˜å¼‚ï¼ŒåŒæ—¶ç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸åŒè§è§£ï¼Œæ¬¢è¿äº¤æµã€‚</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡çŒ®"></a> å‚è€ƒæ–‡çŒ®</h2>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://github.com/JetBrains/kotlin/blob/8cb9a5ff67ce2a1ff1343ce211453bb10fc885c2/compiler/backend/src/org/jetbrains/kotlin/codegen/coroutines/coroutineCodegenUtil.kt">Kotlin-coroutineCodegenUtil.kt</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
        <tag>coroutines</tag>
      </tags>
  </entry>
  <entry>
    <title>linphone-sdk-androidç‰ˆæœ¬å·ç”Ÿæˆåˆ†æ</title>
    <url>/2022/09/16/linphone-sdk-android/linphone-sdk-android%E7%89%88%E6%9C%AC%E5%8F%B7%E7%94%9F%E6%88%90%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="linphone-sdk-androidç‰ˆæœ¬å·ç”Ÿæˆåˆ†æ"><a class="markdownIt-Anchor" href="#linphone-sdk-androidç‰ˆæœ¬å·ç”Ÿæˆåˆ†æ"></a> linphone-sdk-androidç‰ˆæœ¬å·ç”Ÿæˆåˆ†æ</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>å¥½ä¹…æ²¡å†™ <code>linphone-sdk-android</code> ç›¸å…³çš„æ–‡ç« äº†ï¼Œæœ¬æ–‡è®°å½•ä¸‹ç¬”è€…åˆ†æ <code>linphone-sdk</code> ç‰ˆæœ¬å·ç”Ÿæˆçš„è¿‡ç¨‹ã€‚</p>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<blockquote>
<p>æ³¨ï¼šä»¥ä¸‹æºç åŸºäº linphone-sdk-android 4.5.26ã€‚</p>
</blockquote>
<p>ä¿®æ”¹å®Œ <code>linphone-sdk</code> çš„æºç åæ€»æ˜¯è¦ç¼–è¯‘çš„ï¼Œç¼–è¯‘å®Œæˆåæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå¸¦æœ‰ç‰ˆæœ¬å·çš„ <code>aar</code> åŒ…ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰ˆæœ¬å·æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ</p>
<h3 id="ç¼–è¯‘äº§ç‰©"><a class="markdownIt-Anchor" href="#ç¼–è¯‘äº§ç‰©"></a> ç¼–è¯‘äº§ç‰©</h3>
<p>é¦–å…ˆçœ‹ä¸‹ç¼–è¯‘å®Œæˆå <code>build</code> ç›®å½•ä¸‹çš„äº§ç‰©ï¼Œä¼šå‘ç°æœ‰ä¸¤ä¸ª <code>gradle</code> è„šæœ¬æ–‡ä»¶ï¼š<code>build.gradle</code> å’Œ <code>upload.gradle</code>ï¼Œæ‰“å¼€ <code>upload.gradle</code> è„šæœ¬æ–‡ä»¶ï¼Œåœ¨é‡Œé¢å‘ç°å¦‚ä¸‹ä»£ç ï¼š<code>println(&quot;AAR artefact group is: &quot; + artefactGroupId + &quot;, SDK version 4.5.27&quot;)</code>ï¼Œå…¶ä¸­ <code>4.5.27</code> å°±æ˜¯ <code>linphone-sdk</code> çš„ç‰ˆæœ¬å·ã€‚</p>
<p>æ ¹æ®å‰é¢æ–‡ç« çš„åˆ†æï¼Œç¼–è¯‘äº§ç‰©ä¸€èˆ¬æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ç¬”è€…åœ¨ <code>linphone-sdk</code> ç›®å½•ä¸‹æœç´¢ <code>upload.gradle</code> ï¼š<code>find . -name '*upload.gradle*'</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./cmake/Android/gradle/upload.gradle.cmake</span><br><span class="line">./build/upload.gradle</span><br></pre></td></tr></table></figure>
<p>æœç„¶æ‰¾åˆ°äº†ï¼Œå…¶ä¸­ç¬¬2è¡Œæ˜¯ç¬”è€…åˆšæ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°å¹¶æ‰“å¼€ç¬¬1è¡Œçš„æ–‡ä»¶ <code>upload.gradle.cmake</code>ï¼Œä¸ç¬¬2è¡Œçš„æ–‡ä»¶å¯¹æ¯”ï¼Œå‘ç°å‰è€…å°±æ˜¯åè€…çš„æ¨¡æ¿æ–‡ä»¶ï¼Œåœ¨ <code>upload.gradle.cmake</code> æ–‡ä»¶ä¸­å‘ç°ï¼š<code>println(&quot;AAR artefact group is: &quot; + artefactGroupId + &quot;, SDK version @LINPHONESDK_VERSION@&quot;)</code>ï¼Œå…¶ä¸­ <code>@LINPHONESDK_VERSION@</code> å°±æ˜¯ <code>linphone-sdk</code> çš„ç‰ˆæœ¬å·äº†ã€‚å› ä¸ºæ­¤æ–‡ä»¶åç¼€æ˜¯ <code>.cmake</code>ï¼Œé‚£ä¹ˆè”æƒ³ <code>@LINPHONESDK_VERSION@</code> åº”è¯¥æ˜¯ä¸ª cmake å‚æ•°ã€‚</p>
<p>æ¥ä¸‹æ¥åœ¨ <code>linphone-sdk</code> ç›®å½•ä¸‹æœç´¢åŒ…å« <code>LINPHONESDK_VERSION</code> å­—æ ·çš„æ–‡ä»¶ï¼š<code>find . -type f | xargs grep 'LINPHONESDK_VERSION'</code>ï¼Œæœ¬æ¬¡æŸ¥æ‰¾ç»“æœè¾ƒå¤šï¼Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œç»è¿‡ç¬”è€…çš„å¯¹æ¯”åˆ†æï¼Œé”å®šäº†æœ€åä¸€è¡Œç»“æœï¼š<code>./CMakeLists.txt:bc_compute_full_version(LINPHONESDK_VERSION)</code>ã€‚</p>
<h3 id="cmake"><a class="markdownIt-Anchor" href="#cmake"></a> CMake</h3>
<p>æ‰“å¼€ <code>./CMakeLists.txt</code>ï¼Œåœ¨å‰å‡ è¡Œå°±å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(bctoolbox/cmake/BcToolboxCMakeUtils.cmake)</span><br><span class="line">bc_compute_full_version(LINPHONESDK_VERSION)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ç¬¬2è¡Œä»£ç  <code>bc_compute_full_version</code> å°±æ˜¯è®¡ç®— <code>linphone-sdk</code> ç‰ˆæœ¬å·çš„å‡½æ•°ï¼Œå…¶å®šä¹‰åœ¨ç¬¬1è¡Œä»£ç ä¸­çš„ <code>BcToolboxCMakeUtils.cmake</code> ä¸­ï¼Œæ‰“å¼€ <code>BcToolboxCMakeUtils.cmake</code> æ–‡ä»¶å¹¶æ‰¾åˆ° <code>bc_compute_full_version</code> å‡½æ•°ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>(bc_compute_full_version OUTPUT_VERSION)</span><br><span class="line">	<span class="comment"># æŸ¥æ‰¾ Git ç¨‹åº</span></span><br><span class="line">	<span class="keyword">find_program</span>(GIT_EXECUTABLE git NAMES Git CMAKE_FIND_ROOT_PATH_BOTH)</span><br><span class="line">	<span class="comment"># å¦‚æœæ‰¾åˆ° Git ç¨‹åº</span></span><br><span class="line">	<span class="keyword">if</span>(GIT_EXECUTABLE)</span><br><span class="line">		<span class="comment"># æ‰§è¡Œ git describe å‘½ä»¤</span></span><br><span class="line">		<span class="keyword">execute_process</span>(</span><br><span class="line">			<span class="keyword">COMMAND</span> <span class="string">&quot;$&#123;GIT_EXECUTABLE&#125;&quot;</span> <span class="string">&quot;describe&quot;</span></span><br><span class="line">			OUTPUT_VARIABLE GIT_DESCRIBE_VERSION</span><br><span class="line">			OUTPUT_STRIP_TRAILING_WHITESPACE</span><br><span class="line">			ERROR_QUIET</span><br><span class="line">			WORKING_DIRECTORY <span class="string">&quot;$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&quot;</span></span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># parse git describe version</span></span><br><span class="line">		<span class="comment"># è§£æ git describe çš„è¿”å›å€¼ä½œä¸ºç‰ˆæœ¬å·, é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„åŒ¹é…è¿›è¡Œè§£æï¼š4.5.26-alpha-9-gb342a93</span></span><br><span class="line">		<span class="comment"># å¦‚æœæ²¡æœ‰è§£æåˆ°, è¾“å‡ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">NOT</span> (GIT_DESCRIBE_VERSION <span class="keyword">MATCHES</span> <span class="string">&quot;^([0-9]+)[.]([0-9]+)[.]([0-9]+)(-alpha|-beta)?(-[0-9]+)?(-g[0-9a-f]+)?$&quot;</span>))</span><br><span class="line">			<span class="keyword">message</span>(FATAL_ERROR <span class="string">&quot;invalid git describe version: &#x27;$&#123;GIT_DESCRIBE_VERSION&#125;&#x27;&quot;</span>)</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># è®¾ç½®åˆ†ç»„1ä¸ºä¸»è¦ç‰ˆæœ¬: ([0-9]+) -&gt; 4</span></span><br><span class="line">		<span class="keyword">set</span>(version_major <span class="variable">$&#123;CMAKE_MATCH_1&#125;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># è®¾ç½®åˆ†ç»„2ä¸ºæ¬¡è¦ç‰ˆæœ¬: ([0-9]+) -&gt; 5</span></span><br><span class="line">		<span class="keyword">set</span>(version_minor <span class="variable">$&#123;CMAKE_MATCH_2&#125;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># è®¾ç½®åˆ†ç»„3ä¸ºè¡¥ä¸ç‰ˆæœ¬: ([0-9]+) -&gt; 26</span></span><br><span class="line">		<span class="keyword">set</span>(version_patch <span class="variable">$&#123;CMAKE_MATCH_3&#125;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># å¦‚æœè§£æåˆ°åˆ†ç»„4: (-alpha|-beta)? -&gt; -alpha, åˆ™å»æ‰å‰é¢çš„â€˜-â€™, å¾—åˆ°åé¢çš„â€˜alpha|betaâ€™, èµ‹å€¼ç»™ version_prerelease</span></span><br><span class="line">		<span class="keyword">if</span> (CMAKE_MATCH_4)</span><br><span class="line">			<span class="keyword">string</span>(SUBSTRING <span class="string">&quot;$&#123;CMAKE_MATCH_4&#125;&quot;</span> <span class="number">1</span> -<span class="number">1</span> version_prerelease)</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># å¦‚æœè§£æåˆ°åˆ†ç»„5ï¼š(-[0-9]+)? -&gt; -9, åˆ™å»æ‰å‰é¢çš„â€˜-â€™, å¾—åˆ°åé¢çš„â€˜9â€™, èµ‹å€¼ç»™ version_commit</span></span><br><span class="line">		<span class="keyword">if</span> (CMAKE_MATCH_5)</span><br><span class="line">			<span class="keyword">string</span>(SUBSTRING <span class="string">&quot;$&#123;CMAKE_MATCH_5&#125;&quot;</span> <span class="number">1</span> -<span class="number">1</span> version_commit)</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># å¦‚æœè§£æåˆ°åˆ†ç»„6: (-g[0-9a-f]+)? -&gt; -gb342a93, åˆ™å»æ‰å‰é¢çš„â€˜-gâ€™, å¾—åˆ°åé¢çš„â€˜b342a93â€™, èµ‹å€¼ç»™ version_hash</span></span><br><span class="line">		<span class="keyword">if</span> (CMAKE_MATCH_6)</span><br><span class="line">			<span class="keyword">string</span>(SUBSTRING <span class="string">&quot;$&#123;CMAKE_MATCH_6&#125;&quot;</span> <span class="number">2</span> -<span class="number">1</span> version_hash)</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">		<span class="comment"># interpret untagged hotfixes as pre-releases of the next &quot;patch&quot; release</span></span><br><span class="line">		<span class="comment"># å¦‚æœæ²¡æœ‰ version_prerelease, ä½†æ˜¯æœ‰ version_commit, è®¤ä¸ºæ˜¯æ­¤è¡¥ä¸ç¨‹åºæ˜¯ä¸‹ä¸€ä¸ªè¡¥ä¸ç‰ˆæœ¬çš„é¢„å‘ç‰ˆæœ¬, å³å°†è¡¥ä¸ç‰ˆæœ¬å·+1</span></span><br><span class="line">		<span class="comment"># å¹¶è®¾ç½® version_prerelease ä¸º &quot;pre&quot;</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">NOT</span> version_prerelease <span class="keyword">AND</span> version_commit)</span><br><span class="line">			<span class="keyword">math</span>(EXPR version_patch <span class="string">&quot;$&#123;version_patch&#125; + 1&quot;</span>)</span><br><span class="line">			<span class="keyword">set</span>(version_prerelease <span class="string">&quot;pre&quot;</span>)</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">		<span class="comment"># format full version</span></span><br><span class="line">		<span class="comment"># æ‹¼æ¥ä¸»ã€æ¬¡ã€è¡¥ä¸ç‰ˆæœ¬å·</span></span><br><span class="line">		<span class="keyword">set</span>(full_version <span class="string">&quot;$&#123;version_major&#125;.$&#123;version_minor&#125;.$&#123;version_patch&#125;&quot;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># å¦‚æœæœ‰ version_prerelease</span></span><br><span class="line">		<span class="keyword">if</span> (version_prerelease)</span><br><span class="line">			<span class="comment"># ç‰ˆæœ¬å·è¿½åŠ  &quot;-pre&quot;</span></span><br><span class="line">			<span class="keyword">string</span>(APPEND full_version <span class="string">&quot;-$&#123;version_prerelease&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">			<span class="comment"># å¦‚æœæœ‰ version_commit</span></span><br><span class="line">			<span class="keyword">if</span> (version_commit)</span><br><span class="line">				<span class="comment"># ç‰ˆæœ¬å·è¿½åŠ  &quot;.9+b342a93&quot;</span></span><br><span class="line">				<span class="keyword">string</span>(APPEND full_version <span class="string">&quot;.$&#123;version_commit&#125;+$&#123;version_hash&#125;&quot;</span>)</span><br><span class="line">			<span class="keyword">endif</span>()</span><br><span class="line">		<span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">		<span class="comment"># çœç•¥å…¶ä»–æ£€æŸ¥é€»è¾‘</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># è®¾ç½®ç‰ˆæœ¬å·ä¸ºCMakeç¼“å­˜å‚æ•°, å®Œæ•´ç‰ˆæœ¬å·: 4.5.27-pre.9+b342a93</span></span><br><span class="line">		<span class="keyword">set</span>(<span class="variable">$&#123;OUTPUT_VERSION&#125;</span> <span class="string">&quot;$&#123;full_version&#125;&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line">	<span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endfunction</span>()</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å°±æ˜¯åˆ†æ <code>bc_compute_full_version</code> å‡½æ•°äº†ã€‚</p>
<p>é¦–å…ˆæŸ¥æ‰¾ <code>Git</code> ç¨‹åºï¼Œå¦‚æœæ‰¾åˆ° <code>Git</code> ç¨‹åºï¼Œå‡½æ•°æ‰ä¼šç»§ç»­ï¼Œå¦åˆ™æ— æ³•è®¡ç®—ç‰ˆæœ¬å·ã€‚</p>
<p>æ‰¾åˆ° <code>Git</code> ç¨‹åºåä¼šæ‰§è¡Œ <code>git describe</code> å‘½ä»¤ï¼Œæ­¤å‘½ä»¤ä¼šåŸºäºå½“å‰å¯ç”¨çš„ ref ç»™ä¸€ä¸ªäººç±»å¯è¯»çš„åç§°ã€‚</p>
<ul>
<li>
<p>å¦‚æœå½“å‰æœ€æ–°çš„ commit ä¸Šæœ‰ TAGï¼Œä¸” TAG å¿…é¡»æœ‰æè¿°ä¿¡æ¯æˆ–è€…å¸¦æœ‰ <code>-- tags</code> å‚æ•°ï¼Œæ­¤å‘½ä»¤åˆ™è¿”å›æ­¤ TAG åç§°ï¼š4.5.26ï¼Œ</p>
</li>
<li>
<p>å¦åˆ™è¿”å›ç¦»å½“å‰æœ€è¿‘çš„ TAG åç§° + æ­¤ TAG ä¹‹åçš„æäº¤æ¬¡æ•° + å½“å‰çš„ commit hash å€¼å‰ 7 ä½ï¼š4.5.26-9-gb342a93ï¼Œå…¶ä¸­ â€˜gâ€™ è¡¨ç¤ºæ˜¯ <code>Git</code>ï¼Œ</p>
</li>
<li>
<p>å…·ä½“å¯æŸ¥çœ‹ <a href="https://git-scm.com/docs/git-describe">git-describe</a>ã€‚</p>
</li>
</ul>
<p>å‡è®¾ <code>git describe</code> å‘½ä»¤è¿”å›çš„æ˜¯ï¼š<code>4.5.26-alpha-9-gb342a93</code>ï¼Œæ¥ä¸‹æ¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„åŒ¹é…è§£æè¿”å›çš„ç»“æœã€‚</p>
<p>æ­£åˆ™è¡¨è¾¾å¼ï¼š<code>^([0-9]+)[.]([0-9]+)[.]([0-9]+)(-alpha|-beta)?(-[0-9]+)?(-g[0-9a-f]+)?$</code>ï¼Œå…¶åˆ†ä¸ºä»¥ä¸‹ 6 ç»„ï¼š</p>
<ol>
<li><code>([0-9]+)</code> ä¸ºç¬¬ä¸€ç»„ <code>CMAKE_MATCH_1</code>ï¼Œå¯¹åº” 4ï¼Œ</li>
<li><code>([0-9]+)</code> ä¸ºç¬¬äºŒç»„ <code>CMAKE_MATCH_2</code>ï¼Œå¯¹åº” 5ï¼Œ</li>
<li><code>([0-9]+)</code> ä¸ºç¬¬ä¸‰ç»„ <code>CMAKE_MATCH_3</code>ï¼Œå¯¹åº” 26ï¼Œ</li>
<li><code>(-alpha|-beta)?</code> ä¸ºç¬¬å››ç»„ <code>CMAKE_MATCH_4</code>ï¼Œå¯ä¸ºç©ºï¼Œå¯¹åº” -alphaï¼Œ</li>
<li><code>(-[0-9]+)?</code> ä¸ºç¬¬äº”ç»„ <code>CMAKE_MATCH_5</code>ï¼Œå¯ä¸ºç©ºï¼Œå¯¹åº” -9ï¼Œ</li>
<li><code>(-g[0-9a-f]+)?</code> ä¸ºç¬¬å…­ç»„ <code>CMAKE_MATCH_6</code>ï¼Œå¯ä¸ºç©ºï¼Œå¯¹åº” gb342a93ï¼Œ</li>
</ol>
<p>åˆ†ç»„ä¸€ã€åˆ†ç»„äºŒå’Œåˆ†ç»„ä¸‰åˆ†åˆ«ä½œä¸ºä¸»è¦ç‰ˆæœ¬ã€æ¬¡è¦ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬ï¼š4.5.26ã€‚</p>
<p>å¦‚æœè§£æåˆ°åˆ†ç»„å››:  <code>-alpha</code>ï¼Œåˆ™å»æ‰å‰é¢çš„ <code>-</code>ï¼Œå¾—åˆ°åé¢çš„ <code>alpha</code>ï¼Œå¹¶èµ‹å€¼ç»™ <code>version_prerelease</code> å˜é‡ï¼›å¦‚æœè§£æåˆ°åˆ†ç»„äº”: <code>-9</code>ï¼Œåˆ™å»æ‰å‰é¢çš„ <code>-</code>ï¼Œå¾—åˆ°åé¢çš„ <code>9</code>ï¼Œå¹¶èµ‹å€¼ç»™ <code>version_commit</code> å˜é‡ï¼›å¦‚æœè§£æåˆ°åˆ†ç»„å…­: <code>-gb342a93</code>ï¼Œåˆ™å»æ‰å‰é¢çš„ <code>-g</code>ï¼Œå¾—åˆ°åé¢çš„ <code>b342a93</code>ï¼Œå¹¶èµ‹å€¼ç»™ <code>version_hash</code> å˜é‡ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ <code>version_prerelease</code> å˜é‡ï¼Œä½†æ˜¯æœ‰ <code>version_commit</code> å˜é‡ï¼Œåˆ™è®¤ä¸ºæ­¤è¡¥ä¸ç¨‹åºæ˜¯ä¸‹ä¸€ä¸ªè¡¥ä¸ç‰ˆæœ¬çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå³å°†è¡¥ä¸ç‰ˆæœ¬å·å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å¹¶èµ‹å€¼<code>version_prerelease</code> å˜é‡ä¸º <code>pre</code>ã€‚</p>
<p>æ‹¼æ¥ä¸»è¦ç‰ˆæœ¬ã€æ¬¡è¦ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬ä¸ºï¼š<code>4.5.27</code>ï¼Œå¹¶èµ‹å€¼ç»™ <code>full_version</code> å˜é‡ã€‚</p>
<p>å¦‚æœæœ‰ <code>version_prerelease</code> å˜é‡ï¼Œåˆ™ <code>full_version</code> å˜é‡è¿½åŠ  <code>-pre</code>ï¼Œæ­¤æ—¶ç‰ˆæœ¬å·ä¸ºï¼š<code>4.5.27-pre</code>ï¼›å¦‚æœæœ‰ <code>version_commit</code> å˜é‡ï¼Œåˆ™ç‰ˆæœ¬å·å†è¿½åŠ  <code>version_commit</code> å’Œ <code>version_hash</code> å˜é‡çš„å€¼ <code>.9+b342a93</code>ï¼Œå¾—åˆ°ç‰ˆæœ¬å·ï¼š<code>4.5.27-pre.9+b342a93</code>ã€‚</p>
<p>æœ€ç»ˆå¾—åˆ° <code>linphone-sdk</code> çš„ç‰ˆæœ¬å·ï¼š<code>4.5.27-pre.9+b342a93</code>ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡è®°å½•äº†ç¬”è€…æŸ¥æ‰¾ <code>linphone-sdk</code> ç”Ÿæˆç‰ˆæœ¬å·çš„è¿‡ç¨‹ï¼ŒåŒæ—¶åˆ†æäº†ç‰ˆæœ¬å·çš„ç”Ÿæˆé€»è¾‘ï¼Œ<code>linphone-sdk</code> é€šè¿‡è·å– <code>Git</code> æäº¤è®°å½•å’Œ TAG æ¥ç”Ÿæˆç‰ˆæœ¬å·ï¼š</p>
<ol>
<li>æ‰§è¡Œ <code>git describe</code> å‘½ä»¤è·å–å¯è¯» <code>Git</code> æäº¤ä¿¡æ¯ï¼Œ</li>
<li>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„é…ç½®æ¨¡å¼è§£æå¾—åˆ°çš„ <code>Git</code> æäº¤ä¿¡æ¯ï¼Œ</li>
<li>æœ€åæ ¹æ®åˆ†ç»„ä¿¡æ¯ä¿®æ­£å¹¶æ‹¼æ¥å¾—åˆ°å®Œæ•´çš„ç‰ˆæœ¬å·ã€‚</li>
</ol>
<p>åˆ©ç”¨ <code>Git</code> æäº¤ä¿¡æ¯æ¥ç”Ÿæˆç‰ˆæœ¬å·è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨å†™ SDK æ—¶æˆ–è®¸å¯ä»¥å€Ÿé‰´ä¸‹ã€‚</p>
<p>å¸Œæœ›å¯ä»¥å¸®åˆ°æ‚¨ï¼Œhappy~</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®æ”¹linphone-sdk-android-ç¬¬ä¸€ç¯‡</title>
    <url>/2022/04/23/linphone-sdk-android/%E4%BF%AE%E6%94%B9linphone-sdk-android-%E7%AC%AC%E4%B8%80%E7%AF%87/</url>
    <content><![CDATA[<h1 id="ä¿®æ”¹linphone-sdk-android-ä¸Šç¯‡"><a class="markdownIt-Anchor" href="#ä¿®æ”¹linphone-sdk-android-ä¸Šç¯‡"></a> ä¿®æ”¹linphone-sdk-android-ä¸Šç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>è®°å½•ä¿®æ”¹linphone-sdk-androidè¿‡ç¨‹ï¼Œè®¡åˆ’åˆ†ä¸ºä¸Šã€ä¸­ã€ä¸‹ä¸‰ç¯‡</p>
<p>æœ¬æ–‡æ˜¯ä¸Šç¯‡ï¼Œæœ¬ç¯‡ä»…è®°å½•ä¸‹ä¹¦é—®é¢˜2çš„åˆæ­¥æ’æŸ¥è¿‡ç¨‹ï¼Œå°½é‡æè¿°æ’æŸ¥é—®é¢˜è¿‡ç¨‹ä¸­çš„æ€è·¯ä¸æ–¹å‘</p>
<p>ä½™ä¸‹ä¸¤ç¯‡è®°å½•é—®é¢˜1ã€2çš„ä¿®æ”¹è¿‡ç¨‹</p>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>æ¥ä¸Šæ–‡<a href="https://juejin.cn/post/7087496636657565727">ç¼–è¯‘linphone-sdk-android</a></p>
<p>é¡¹ç›®ä¸­ä½¿ç”¨çš„linphone-sdk-androidç‰ˆæœ¬ä¸º4.5.xï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>æ‰“å¼€éŸ³é¢‘ç¼–è§£ç G722ã€G729æ—¶ï¼Œå‘èµ·å‘¼å«çš„INVITE SDPä¸­ï¼Œæ²¡æœ‰G722ã€G729çš„RTP MAPï¼Œå½“æ—¶ä»¥ä¸ºæ˜¯linphoneçš„bugï¼Œåé¢çœ‹æºç åŠæŸ¥èµ„æ–™å‘ç°å¯èƒ½ä¸æ˜¯bugï¼Œè¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨</li>
<li>ä½¿ç”¨sdkæä¾›çš„JavaLoggerè¾“å‡ºæ—¥å¿—æ—¶ï¼Œä¼ªä»£ç ï¼š<code>mFactory.getLoggingService().addListener(mAndroidLoggingService);</code>ï¼Œå¶ç°JNIå´©æºƒé—®é¢˜</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    --------- beginning of crash</span><br><span class="line">2022-04-11 14:16:22.350 1142-1430/? A/libc: Fatal signal 6 (SIGABRT), code -6 in tid 1430 (RealLinphonePro)</span><br><span class="line">2022-04-11 14:16:22.441 3756-3756/? A/DEBUG: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">2022-04-11 14:16:22.442 3756-3756/? A/DEBUG: Build fingerprint: &#x27;Android/rk3288/rk3288:7.1.2/NHG47K/builde03162201:userdebug/test-keys&#x27;</span><br><span class="line">2022-04-11 14:16:22.444 3756-3756/? A/DEBUG: Revision: &#x27;0&#x27;</span><br><span class="line">2022-04-11 14:16:22.446 3756-3756/? A/DEBUG: ABI: &#x27;arm&#x27;</span><br><span class="line">2022-04-11 14:16:22.447 3756-3756/? A/DEBUG: pid: 1142, tid: 1430, name: RealLinphonePro  &gt;&gt;&gt; com.guodong.android.linphone &lt;&lt;&lt;</span><br><span class="line">2022-04-11 14:16:22.448 3756-3756/? A/DEBUG: signal 6 (SIGABRT), code -6 (SI_TKILL), fault addr --------</span><br><span class="line">2022-04-11 14:16:22.454 3756-3756/? A/DEBUG: Abort message: &#x27;art/runtime/indirect_reference_table.cc:80] JNI ERROR (app bug): accessed deleted WeakGlobal 0x21ab&#x27;</span><br><span class="line">2022-04-11 14:16:22.456 3756-3756/? A/DEBUG:     r0 00000000  r1 00000596  r2 00000006  r3 00000008</span><br><span class="line">2022-04-11 14:16:22.457 3756-3756/? A/DEBUG:     r4 89aff978  r5 00000006  r6 89aff920  r7 0000010c</span><br><span class="line">2022-04-11 14:16:22.459 3756-3756/? A/DEBUG:     r8 00000043  r9 aaa7eef0  sl 0000000a  fp 89d04400</span><br><span class="line">2022-04-11 14:16:22.461 3756-3756/? A/DEBUG:     ip 0000000b  sp 89afef88  lr ab175857  pc ab1780c0  cpsr 600b0010</span><br><span class="line">2022-04-11 14:16:22.509 3756-3756/? A/DEBUG: backtrace:</span><br><span class="line">2022-04-11 14:16:22.511 3756-3756/? A/DEBUG:     #00 pc 0004a0c0  /system/lib/libc.so (tgkill+12)</span><br><span class="line">2022-04-11 14:16:22.512 3756-3756/? A/DEBUG:     #01 pc 00047853  /system/lib/libc.so (pthread_kill+34)</span><br><span class="line">2022-04-11 14:16:22.514 3756-3756/? A/DEBUG:     #02 pc 0001d8b5  /system/lib/libc.so (raise+10)</span><br><span class="line">2022-04-11 14:16:22.515 3756-3756/? A/DEBUG:     #03 pc 00019401  /system/lib/libc.so (__libc_android_abort+34)</span><br><span class="line">2022-04-11 14:16:22.517 3756-3756/? A/DEBUG:     #04 pc 00017048  /system/lib/libc.so (abort+4)</span><br><span class="line">2022-04-11 14:16:22.518 3756-3756/? A/DEBUG:     #05 pc 0031d8cd  /system/lib/libart.so (_ZN3art7Runtime5AbortEPKc+328)</span><br><span class="line">2022-04-11 14:16:22.520 3756-3756/? A/DEBUG:     #06 pc 000b5503  /system/lib/libart.so (_ZN3art10LogMessageD2Ev+1134)</span><br><span class="line">2022-04-11 14:16:22.521 3756-3756/? A/DEBUG:     #07 pc 001bd0ff  /system/lib/libart.so (_ZN3art22IndirectReferenceTable17AbortIfNoCheckJNIERKNSt3__112basic_stringIcNS1_11char_traitsIcEENS1_9allocatorIcEEEE+134)</span><br><span class="line">2022-04-11 14:16:22.523 3756-3756/? A/DEBUG:     #08 pc 0023ecaf  /system/lib/libart.so (_ZNK3art22IndirectReferenceTable10GetCheckedEPv+250)</span><br><span class="line">2022-04-11 14:16:22.525 3756-3756/? A/DEBUG:     #09 pc 0023c05b  /system/lib/libart.so (_ZN3art9JavaVMExt16DecodeWeakGlobalEPNS_6ThreadEPv+30)</span><br><span class="line">2022-04-11 14:16:22.526 3756-3756/? A/DEBUG:     #10 pc 00337679  /system/lib/libart.so (_ZNK3art6Thread13DecodeJObjectEP8_jobject+164)</span><br><span class="line">2022-04-11 14:16:22.528 3756-3756/? A/DEBUG:     #11 pc 00265843  /system/lib/libart.so (_ZN3art3JNI11NewLocalRefEP7_JNIEnvP8_jobject+406)</span><br><span class="line">2022-04-11 14:16:22.530 3756-3756/? A/DEBUG:     #12 pc 0060eff9  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (getLoggingService+88)</span><br><span class="line">2022-04-11 14:16:22.531 3756-3756/? A/DEBUG:     #13 pc 0061a977  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so</span><br><span class="line">2022-04-11 14:16:22.533 3756-3756/? A/DEBUG:     #14 pc 005ef911  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so</span><br><span class="line">2022-04-11 14:16:22.535 3756-3756/? A/DEBUG:     #15 pc 00025437  /data/app/com.guodong.android.linphone-1/lib/arm/libbctoolbox.so (bctbx_logv+182)</span><br><span class="line">2022-04-11 14:16:22.536 3756-3756/? A/DEBUG:     #16 pc 006f5061  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so</span><br><span class="line">2022-04-11 14:16:22.538 3756-3756/? A/DEBUG:     #17 pc 006f51d9  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (wake_lock_acquire+152)</span><br><span class="line">2022-04-11 14:16:22.539 3756-3756/? A/DEBUG:     #18 pc 006601c5  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so</span><br><span class="line">2022-04-11 14:16:22.541 3756-3756/? A/DEBUG:     #19 pc 00660b27  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (belle_sip_client_transaction_init+138)</span><br><span class="line">2022-04-11 14:16:22.542 3756-3756/? A/DEBUG:     #20 pc 006fb1d3  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (belle_sip_nict_new+30)</span><br><span class="line">2022-04-11 14:16:22.544 3756-3756/? A/DEBUG:     #21 pc 0065c3a7  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (belle_sip_provider_create_client_transaction+46)</span><br><span class="line">2022-04-11 14:16:22.546 3756-3756/? A/DEBUG:     #22 pc 0065dec3  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so</span><br><span class="line">2022-04-11 14:16:22.547 3756-3756/? A/DEBUG:     #23 pc 0065daf7  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (belle_sip_refresher_refresh+28)</span><br><span class="line">2022-04-11 14:16:22.549 3756-3756/? A/DEBUG:     #24 pc 005fac23  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (linphone_proxy_config_refresh_register+34)</span><br><span class="line">2022-04-11 14:16:22.550 3756-3756/? A/DEBUG:     #25 pc 005e9fc5  /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (linphone_core_refresh_registers+40)</span><br><span class="line">2022-04-11 14:16:22.552 3756-3756/? A/DEBUG:     #26 pc 019fc3bf  /data/app/com.guodong.android.linphone-1/oat/arm/base.odex (offset 0x18de000)</span><br><span class="line">2022-04-11 14:16:23.096 227-255/? I/AudioFlinger: BUFFER TIMEOUT: remove(4099) from active list on thread 0xabd03e00</span><br></pre></td></tr></table></figure>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<h3 id="é—®é¢˜2"><a class="markdownIt-Anchor" href="#é—®é¢˜2"></a> é—®é¢˜2</h3>
<p>é€šè¿‡å´©æºƒæ—¥å¿—ç¬¬27è¡Œ<code>2022-04-11 14:16:22.530 3756-3756/? A/DEBUG: #12 pc 0060eff9 /data/app/com.guodong.android.linphone-1/lib/arm/liblinphone.so (getLoggingService+88)</code>å¯ä»¥åˆ¤æ–­å´©æºƒæ˜¯åœ¨<code>getLoggingService()</code>è¿™ä¸ªæ–¹æ³•é‡Œ</p>
<p>å¦‚æ­¤éœ€è¦å…ˆæ‰¾åˆ°<code>getLoggingService()</code>æ–¹æ³•çš„æºç ï¼Œå…ˆåœ¨Source Insightä¸­æœç´¢<code>getLoggingService()</code>ï¼Œæœç´¢ä¸€åœˆå‘ç°æ²¡æœ‰ï¼ŒçŒœæƒ³æ­¤æ–¹æ³•åº”è¯¥æ˜¯ç¼–è¯‘åè‡ªåŠ¨ç”Ÿæˆçš„</p>
<p>åœ¨Ubuntuç¼–è¯‘ç¯å¢ƒé‡Œæ‰¾æ‰¾ï¼Œé€šè¿‡<code>find</code>å‘½ä»¤æŸ¥æ‰¾åŒ…å«<code>getLoggingService</code>æ–‡æœ¬çš„æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> linphone-sdk/build/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">find . -<span class="built_in">type</span> f | xargs grep <span class="string">&quot;getLoggingService&quot;</span></span></span><br><span class="line">./WORK/android-armv7/Build/linphone/wrappers/java/src/linphone_jni.cc:JNIEXPORT jobject JNICALL getLoggingService(JNIEnv *env, LinphoneLoggingService *cptr, bool_t takeref) &#123;</span><br><span class="line">./WORK/android-armv7/Build/linphone/wrappers/java/src/linphone_jni.cc:	jobject j_logService = getLoggingService(env, (LinphoneLoggingService *)logService, TRUE);</span><br><span class="line">./WORK/android-armv7/Build/linphone/wrappers/java/src/linphone_jni.cc:	jobject jni_result = (jobject)getLoggingService(env, (LinphoneLoggingService *)linphone_logging_service_get(), TRUE);</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°äº†bingo~</p>
<p>æ‰“å¼€<code>linphone_jni.cc</code>ï¼Œ<code>getLoggingService()</code>æ–¹æ³•ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">getLoggingService</span><span class="params">(JNIEnv *env, LinphoneLoggingService *cptr, <span class="type">bool_t</span> takeref)</span> </span>&#123;</span><br><span class="line">	jobject jobj = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cptr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="type">void</span> *up = <span class="built_in">belle_sip_object_data_get</span>((<span class="type">belle_sip_object_t</span> *)cptr, belle_sip_java_user_data_key);</span><br><span class="line">		LinphoneJavaBindings *ljb = (LinphoneJavaBindings *)<span class="built_in">linphone_factory_get_user_data</span>(<span class="built_in">linphone_factory_get</span>());</span><br><span class="line">		<span class="keyword">if</span> (!ljb) &#123;</span><br><span class="line">			ljb = <span class="keyword">new</span> <span class="built_in">LinphoneJavaBindings</span>(env);</span><br><span class="line">			<span class="built_in">linphone_factory_set_user_data</span>(<span class="built_in">linphone_factory_get</span>(), ljb);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		jclass linphone_logging_service_class = ljb-&gt;linphone_logging_service_class;</span><br><span class="line">		jmethodID linphone_logging_service_constructor = ljb-&gt;linphone_logging_service_class_constructor;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (up == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">			jobj = env-&gt;<span class="built_in">NewObject</span>(linphone_logging_service_class, linphone_logging_service_constructor, (jlong)cptr);</span><br><span class="line">			<span class="built_in">belle_sip_object_data_set</span>((<span class="type">belle_sip_object_t</span> *)cptr, belle_sip_java_user_data_key, (<span class="type">void</span>*)env-&gt;<span class="built_in">NewWeakGlobalRef</span>(jobj), <span class="literal">nullptr</span>);</span><br><span class="line">			<span class="keyword">if</span> (takeref)</span><br><span class="line">				<span class="built_in">linphone_logging_service_ref</span>(cptr);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			jobj = env-&gt;<span class="built_in">NewLocalRef</span>((jobject)up);</span><br><span class="line">			<span class="keyword">if</span> (jobj == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">				<span class="comment">// Delete weak ref ?</span></span><br><span class="line">				env-&gt;<span class="built_in">DeleteWeakGlobalRef</span>((jobject)up);</span><br><span class="line">				<span class="comment">// takes implicit local ref</span></span><br><span class="line">				jobj = env-&gt;<span class="built_in">NewObject</span>(linphone_logging_service_class, linphone_logging_service_constructor, (jlong)cptr);</span><br><span class="line">				<span class="built_in">belle_sip_object_data_set</span>((<span class="type">belle_sip_object_t</span> *)cptr, belle_sip_java_user_data_key, (<span class="type">void</span>*)env-&gt;<span class="built_in">NewWeakGlobalRef</span>(jobj), <span class="literal">nullptr</span>);</span><br><span class="line">				<span class="keyword">if</span> (takeref)</span><br><span class="line">					<span class="built_in">linphone_logging_service_ref</span>(cptr);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> jobj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å—¯ï¼Œçœ‹èµ·æ¥æ²¡å•¥é—®é¢˜ï¼Œä¹Ÿæœ‰åˆ¤ç©ºå¤„ç†ï¼Œä¸€æ—¶é—´æ‘¸ä¸ç€å¤´ç»ªï¼Œå…ˆåœ¨<code>getLoggingService()</code>æ–¹æ³•ä¸­åŠ ç‚¹æ—¥å¿—è¾“å‡ºçœ‹çœ‹å§</p>
<p>å‰é¢è¯´<code>linphone_jni.cc</code>æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç°åœ¨éœ€è¦æ‰¾åˆ°è‡ªåŠ¨ç”Ÿæˆ<code>linphone_jni.cc</code>çš„ä»£ç ï¼Œæ ¹æ®å´©æºƒæ—¥å¿—å¯ä»¥å‘ç°<code>getLoggingService()</code>åœ¨<code>linphone.so</code>ä¸­ï¼Œè€Œæºç ä¸­æœ‰<code>liblinphone</code>è¿™ä¸ªç›®å½•ï¼Œå…ˆåœ¨è¿™ä¸ªç›®å½•ä¸‹æ‰¾æ‰¾å§ï¼Œé€šè¿‡<code>find</code>å‘½ä»¤æŸ¥æ‰¾æ–‡ä»¶åä¸­åŒ…å«<code>jni</code>çš„æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> linphone-sdk/liblinphone/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">find . -name *jni*</span></span><br><span class="line">./coreapi/linphonecore_jni.cc</span><br><span class="line">./tools/lpc2xml_jni.cc</span><br><span class="line">./tools/xml2lpc_jni.cc</span><br><span class="line">./tools/my_jni.h</span><br><span class="line">./wrappers/java/jni.mustache</span><br></pre></td></tr></table></figure>
<p>æŸ¥æ‰¾å‡ºæ¥å¤šä¸ªæ–‡ä»¶ï¼Œæ—¢ç„¶<code>linphone_jni.cc</code>æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å¯ä»¥ç¡®å®š<code>.cc</code>ã€<code>.h</code>åç¼€çš„å‡ ä¸ªæ–‡ä»¶è‚¯å®šä¸æ˜¯ï¼Œæ’é™¤ååªå‰©ä¸‹è¿™ä¸ª<code>jni.mustache</code>æ–‡ä»¶ï¼Œæ‰“å¼€æ–‡ä»¶<code>vim ./wrappers/java/jni.mustache</code>æ³¨é‡Šç¬¬ä¸€è¡Œå°±æ˜¯<code>linphone_jni.cc</code>ï¼Œå¤ªæ£’äº†ï¼Œæ‰¾åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç äº†</p>
<p>é€šè¿‡ä¸€äº›æŸ¥çœ‹ï¼Œå¹¶ä¸<code>linphone_jni.cc</code>ä¸­çš„å®ç°å¯¹æ¯”ï¼Œé”å®šäº†ä»¥ä¸‹ä»£ç å³ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„æ¨¡æ¿ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">290 &#123;&#123;#objects&#125;&#125;</span><br><span class="line">291 JNIEXPORT jobject JNICALL get&#123;&#123;className&#125;&#125;(JNIEnv *env, &#123;&#123;classCName&#125;&#125; *cptr, bool_t takeref) &#123;</span><br><span class="line">292         jobject jobj = nullptr;</span><br><span class="line">293 </span><br><span class="line">294         if (cptr != nullptr) &#123;</span><br><span class="line">295                 void *up = belle_sip_object_data_get((belle_sip_object_t *)cptr, belle_sip_java_user_data_key);</span><br><span class="line">296                 LinphoneJavaBindings *ljb = (LinphoneJavaBindings *)linphone_factory_get_user_data(linphone_factory_get());</span><br><span class="line">297                 if (!ljb) &#123;</span><br><span class="line">298                         ljb = new LinphoneJavaBindings(env);</span><br><span class="line">299                         linphone_factory_set_user_data(linphone_factory_get(), ljb);</span><br><span class="line">300                 &#125;</span><br><span class="line">301 </span><br><span class="line">302                 jclass &#123;&#123;cPrefix&#125;&#125;_class = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class;</span><br><span class="line">303                 jmethodID &#123;&#123;cPrefix&#125;&#125;_constructor = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class_constructor;</span><br><span class="line">304 </span><br><span class="line">305                 if (up == nullptr) &#123;</span><br><span class="line">306                         jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">307                         belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">308                         if (takeref)</span><br><span class="line">309                                 &#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">310                 &#125; else &#123;</span><br><span class="line">311                         jobj = env-&gt;NewLocalRef((jobject)up);</span><br><span class="line">312                         if (jobj == nullptr) &#123;</span><br><span class="line">313                                 // Delete weak ref ?</span><br><span class="line">314                                 env-&gt;DeleteWeakGlobalRef((jobject)up);</span><br><span class="line">315                                 // takes implicit local ref</span><br><span class="line">316                                 jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">317                                 belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">318                                 if (takeref)</span><br><span class="line">319                                         &#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">320                         &#125;</span><br><span class="line">321                 &#125;</span><br><span class="line">322         &#125;</span><br><span class="line">323         return jobj;</span><br><span class="line">324 &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œlinphone-sdkä½¿ç”¨äº†<a href="https://github.com/janl/mustache.js">mustache</a>ï¼Œè¿˜è®°å¾—åœ¨ä¸Šç¯‡<a href="https://juejin.cn/post/7087496636657565727">ç¼–è¯‘Linphone-SDK-Android</a>ä¸­æœ‰å®‰è£…<code>pip3 install pystache</code>ï¼Œ<code>pystache</code>æ˜¯<code>mustache</code>çš„Pythonå®ç°ï¼Œ<code>mustache</code>çš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œåœ¨<code>github</code>ä¸Šçœ‹ä¸€çœ¼æ–‡æ¡£ï¼Œå†è·Ÿç€æºç æ¯”ç€è‘«èŠ¦ç”»ç“¢ï¼Œåº”è¯¥å°±å·®ä¸å¤šäº†</p>
<p>å¥½çš„ï¼Œå­¦ä¹ å®Œ<code>mustache</code>çš„è¯­æ³•ï¼Œäº†è§£åˆ°é«˜çº§ç”¨æ³•å¯ä»¥ä¼ ä¸€ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œæ¸²æŸ“ï¼Œæ­£å¥½ä¸<code>jni.mustache</code>åŒçº§ç›®å½•ä¸­æœ‰ä¸ª<code>genwrapper.py</code>æ–‡ä»¶ï¼Œæ‰“å¼€æ­¤æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šç±»ï¼Œå…¶ä¸­æœ‰ä¸ª<code>Jni</code>çš„ç±»ï¼Œé‡Œé¢æœ‰äº›å­—æ®µä¸<code>jni.mustache</code>ä¸­çš„æ ‡ç­¾æ­£å¥½å¯¹åº”ï¼Œå°±æ˜¯å®ƒäº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Jni</span>:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">add_object</span>(<span class="params">self, javaClass</span>):</span><br><span class="line">        <span class="keyword">if</span> javaClass.className == <span class="string">&#x27;Factory&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        obj = &#123;</span><br><span class="line">            <span class="string">&#x27;jniPrefix&#x27;</span>: self.jni_package,</span><br><span class="line">            <span class="string">&#x27;jniPath&#x27;</span>: self.jni_path,</span><br><span class="line">            <span class="string">&#x27;cPrefix&#x27;</span>: javaClass.cPrefix,</span><br><span class="line">            <span class="string">&#x27;className&#x27;</span>: javaClass.className,</span><br><span class="line">            <span class="string">&#x27;classCName&#x27;</span>: javaClass.cName,</span><br><span class="line">            <span class="string">&#x27;classImplName&#x27;</span>: javaClass.classImplName,</span><br><span class="line">            <span class="string">&#x27;refCountable&#x27;</span>: javaClass.refCountable,</span><br><span class="line">            <span class="string">&#x27;notRefCountable&#x27;</span>: <span class="keyword">not</span> javaClass.refCountable,</span><br><span class="line">        &#125;</span><br><span class="line">        self.objects.append(obj)</span><br></pre></td></tr></table></figure>
<p>happy~ä¸‡äº‹å…·å¤‡ï¼Œç°åœ¨å¯ä»¥ä¿®æ”¹æºç ï¼Œæ·»åŠ ä¸€äº›æ—¥å¿—è¾“å‡ºäº†</p>
<p>å› ä¸ºåœ¨<code>jni.mustache</code>ä¸­æ¨¡æ¿æ–¹æ³•<code>get&#123;&#123;className&#125;&#125;</code>æ˜¯å¯ä»¥ç”Ÿæˆå¤šä¸ªä»¥<code>get</code>å¼€å¤´çš„æ–¹æ³•ï¼Œç°åœ¨éœ€è¦åˆ¤æ–­<code>&#123;&#123;className&#125;&#125;</code>æ˜¯ä¸æ˜¯ç­‰äº<code>LoggingService</code>ï¼Œè€Œåœ¨<a href="https://github.com/janl/mustache.js">mustache</a>ä¸­æ²¡æœ‰å‘ç°æ¯”è¾ƒå­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒçš„è¯­æ³•ï¼Œæ‰€ä»¥åœ¨<code>genwrapper.py</code>çš„<code>Jni</code>ç±»ä¸­æ–°å¢ä¸€ä¸ª<code>isLoggingService</code>å­—æ®µè¡¨ç¤ºæ˜¯å¦æ˜¯<code>getLoggingService()</code>æ–¹æ³•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Jni</span>:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">add_object</span>(<span class="params">self, javaClass</span>):</span><br><span class="line">        <span class="keyword">if</span> javaClass.className == <span class="string">&#x27;Factory&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        obj = &#123;</span><br><span class="line">            <span class="string">&#x27;jniPrefix&#x27;</span>: self.jni_package,</span><br><span class="line">            <span class="string">&#x27;jniPath&#x27;</span>: self.jni_path,</span><br><span class="line">            <span class="string">&#x27;cPrefix&#x27;</span>: javaClass.cPrefix,</span><br><span class="line">            <span class="string">&#x27;className&#x27;</span>: javaClass.className,</span><br><span class="line">            <span class="string">&#x27;classCName&#x27;</span>: javaClass.cName,</span><br><span class="line">            <span class="string">&#x27;classImplName&#x27;</span>: javaClass.classImplName,</span><br><span class="line">            <span class="string">&#x27;refCountable&#x27;</span>: javaClass.refCountable,</span><br><span class="line">            <span class="string">&#x27;notRefCountable&#x27;</span>: <span class="keyword">not</span> javaClass.refCountable,</span><br><span class="line">            <span class="string">&#x27;isLoggingService&#x27;</span>: javaClass.className == <span class="string">&#x27;LoggingService&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        self.objects.append(obj)</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¿®æ”¹<code>jni.mustache</code>æ–‡ä»¶ï¼Œå¢åŠ æ—¥å¿—ï¼Œè¾“å‡º<code>up</code>æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ï¼Œ<code>up</code>æŒ‡é’ˆè½¬æˆ<code>jobject</code>åä¸<code>NULL</code>ã€<code>nullptr</code>æ¯”è¾ƒçš„ç»“æœï¼Œåˆ¤æ–­<code>up</code>æ˜¯å¦å·²ç»è¢«å›æ”¶äº†</p>
<p>è¿™é‡Œè¯´ä¸€ä¸‹ä»£ç çš„å¤§æ¦‚æ„æ€ï¼Œ<code>up</code>æŒ‡é’ˆä»<code>belle_sip_object_data_get</code>æ–¹æ³•ä¸­é€šè¿‡<code>belle_sip_java_user_data_key</code>è¿™ä¸ªKeyè·å–ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºJavaä¸­çš„Mapï¼›å¦‚æœ<code>up</code>ä¸ºç©ºï¼Œåˆ™è°ƒç”¨Javaæ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†åˆ›å»ºçš„Javaå¯¹è±¡é€šè¿‡<code>NewWeakGlobalRef</code>æ–¹æ³•è½¬æ¢ä¸ºå…¨å±€å¼±å¼•ç”¨ï¼Œå†é€šè¿‡<code>belle_sip_object_data_set</code>æ–¹æ³•ä¿å­˜èµ·æ¥ï¼›å¦‚æœ<code>up</code>ä¸ä¸ºç©ºï¼Œåˆ™å¼ºè½¬ä¸º<code>jobject</code>ï¼Œåˆ¤æ–­<code>jobject</code>æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™åˆ é™¤å…¨å±€å¼±å¼•ç”¨ï¼Œå†åˆ›å»ºä¿å­˜</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;#objects&#125;&#125;</span><br><span class="line">JNIEXPORT jobject JNICALL get&#123;&#123;className&#125;&#125;(JNIEnv *env, &#123;&#123;classCName&#125;&#125; *cptr, bool_t takeref) &#123;</span><br><span class="line">	jobject jobj = nullptr;</span><br><span class="line"></span><br><span class="line">	if (cptr != nullptr) &#123;</span><br><span class="line">		void *up = belle_sip_object_data_get((belle_sip_object_t *)cptr, belle_sip_java_user_data_key);</span><br><span class="line">		LinphoneJavaBindings *ljb = (LinphoneJavaBindings *)linphone_factory_get_user_data(linphone_factory_get());</span><br><span class="line">		if (!ljb) &#123;</span><br><span class="line">			ljb = new LinphoneJavaBindings(env);</span><br><span class="line">			linphone_factory_set_user_data(linphone_factory_get(), ljb);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		jclass &#123;&#123;cPrefix&#125;&#125;_class = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class;</span><br><span class="line">		jmethodID &#123;&#123;cPrefix&#125;&#125;_constructor = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class_constructor;</span><br><span class="line"></span><br><span class="line">		&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">		#ifdef __ANDROID__</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up = %p&quot;, up);</span><br><span class="line">		</span><br><span class="line">		jobject temp_jobj1 = (jobject)up;</span><br><span class="line">		jboolean up_available1 = env-&gt;IsSameObject(temp_jobj1, NULL);</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up_available1 = %d&quot;, up_available1);</span><br><span class="line">		</span><br><span class="line">		jobject temp_jobj2 = (jobject)up;</span><br><span class="line">		jboolean up_available2 = env-&gt;IsSameObject(temp_jobj2, nullptr);</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up_available2 = %d&quot;, up_available2);</span><br><span class="line">		#endif /* __ANDROID__ */</span><br><span class="line">		&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line"></span><br><span class="line">		if (up == nullptr) &#123;</span><br><span class="line">			jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">			belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">			if (takeref)</span><br><span class="line">				&#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			jobj = env-&gt;NewLocalRef((jobject)up);</span><br><span class="line">			if (jobj == nullptr) &#123;</span><br><span class="line">				// Delete weak ref ?</span><br><span class="line">				env-&gt;DeleteWeakGlobalRef((jobject)up);</span><br><span class="line">				// takes implicit local ref</span><br><span class="line">				jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">				belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">				if (takeref)</span><br><span class="line">					&#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return jobj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œä¿®æ”¹å®Œæºç ä¿å­˜åï¼Œå°±å¯ä»¥ç¼–è¯‘äº†</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> linphone-sdk/build/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake --build . --parallel 8</span></span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…ç¼–è¯‘å®Œæˆï¼Œæ‹·è´å‡ºæ¥ç¼–è¯‘å¥½çš„<code>aar</code>ï¼Œæ”¾åˆ°Android Studioä¸­è¿è¡Œï¼ŒæŸ¥çœ‹Logcatè¾“å‡º</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>linphone-sdk-androidç½‘ç»œæ£€æµ‹åˆ†æ</title>
    <url>/2022/06/06/linphone-sdk-android/linphone-sdk-android%E7%BD%91%E7%BB%9C%E6%A3%80%E6%B5%8B%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="linphone-sdk-androidç½‘ç»œæ£€æµ‹åˆ†æ"><a class="markdownIt-Anchor" href="#linphone-sdk-androidç½‘ç»œæ£€æµ‹åˆ†æ"></a> linphone-sdk-androidç½‘ç»œæ£€æµ‹åˆ†æ</h1>
<p>æŒç»­åˆ›ä½œï¼ŒåŠ é€Ÿæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 6 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 8 å¤©ï¼Œ<a href="https://juejin.cn/post/7099702781094674468">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>å¥½ä¹…æ²¡å†™ <code>linphone-sdk-android</code> ç›¸å…³çš„æ–‡ç« äº†ï¼Œä¸Šä¸€ç¯‡æ–‡ç« è¿˜æ˜¯ä¸€ä¸ªæœˆä¹‹å‰ï¼Œç»è¿‡ä¸Šæ¬¡ä¿®æ”¹ <code>linphone-sdk-android</code> åæœ€è¿‘æ²¡æœ‰å•¥é—®é¢˜å‘ç”Ÿï¼Œæœ¬æ–‡è®°å½•ä¸‹ä¹‹å‰é‡åˆ°çš„ <code>linphone</code> ç½‘ç»œé—®é¢˜çš„å‘ã€‚</p>
<blockquote>
<p>æ³¨ï¼šç¬”è€…çš„ App ä½œä¸º Launcher å¯åŠ¨ï¼Œç›®å‰è¿è¡Œåœ¨ Android 7.1.2 API 25 ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ä»¥å¤ªç½‘è¿æ¥ã€‚</p>
</blockquote>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<blockquote>
<p>æ³¨ï¼šä»¥ä¸‹æºç åŸºäº linphone-sdk-android 4.5.26ã€‚</p>
</blockquote>
<p>é—®é¢˜æè¿°ï¼šåœ¨è®¾å¤‡é‡å¯åï¼Œç¨‹åºå¶ç°å‘èµ·ä¸äº†å‘¼å«ï¼Œæç¤ºå½“å‰ç½‘ç»œä¸å¯è¾¾ï¼Œä½†æ˜¯å½“å‰ç½‘ç»œæ˜¯å¥½çš„ï¼Œè¿™å°±æ¯”è¾ƒå¥‡æ€ªäº†ã€‚</p>
<p>æ¥ä¸‹æ¥æŸ¥çœ‹è®¾å¤‡é‡å¯åçš„æ—¥å¿—ï¼Œå‘ç°ä¸€äº›ä¸ linphone ç½‘ç»œç›¸å…³çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">liblinphone : SIP network reachability state is now DOWN</span><br><span class="line">liblinphone : SIP network reachability state is now UP</span><br><span class="line">liblinphone : SIP network reachability state is now DOWN</span><br></pre></td></tr></table></figure>
<p>åˆ·æ–°è´¦æˆ·æ³¨å†Œæ—¶ä¹Ÿæç¤ºç½‘ç»œä¸å¯è¾¾ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">liblinphone : Refresh register operation not available (network unreachable)</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œæµ‹è¯•ç¨‹åºè°ƒç”¨ <code>Core#isNetworkReachable</code> æ–¹æ³•ä¹Ÿè¿”å› <code>false</code> ï¼Œå‘èµ·å‘¼å«æ—¶ç¬”è€…è°ƒç”¨äº†æ­¤æ¥å£åˆ¤æ–­ç½‘ç»œæ˜¯å¦å¯è¾¾ï¼Œæ‰€ä»¥å‡ºç°äº†å‘¼å«ä¸äº†ï¼Œæç¤ºå½“å‰ç½‘ç»œä¸å¯è¾¾çš„é—®é¢˜ï¼Œç°åœ¨çŒœæµ‹æ˜¯ <code>linphone</code> å†…éƒ¨ç»´æŠ¤çš„ç½‘ç»œçŠ¶æ€å‡ºç°äº†é—®é¢˜ï¼Œé‚å»æŸ¥çœ‹ä¸‹æºç ä¸­å¯¹ç½‘ç»œçŠ¶æ€çš„å¤„ç†ã€‚</p>
<h3 id="coresetnetworkreachable"><a class="markdownIt-Anchor" href="#coresetnetworkreachable"></a> Core#setNetworkReachable</h3>
<p>é¦–å…ˆæƒ³åˆ° <code>Core#setNetworkReachable</code> æ¥å£ï¼Œä» <code>setNetworkReachable</code> ä¸‹æ‰‹å§ï¼Œ<code>setNetworkReachable</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ native çš„ <code>private native void setNetworkReachable(long var1, boolean var3);</code> ã€‚</p>
<p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº† <code>Core</code> æ¥å£è°ƒç”¨çš„ native æ–¹æ³•ä¸€èˆ¬åœ¨ <code>linphone_jni.cc</code> ä¸­å®ç°ï¼Œæˆ‘ä»¬æ‰“å¼€ <code>linphone_jni.cc</code>ï¼Œåœ¨å…¶ä¸­æœç´¢ <code>setNetworkReachable</code> å…³é”®å­—ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_org_linphone_core_CoreImpl_setNetworkReachable</span><span class="params">(JNIEnv *env, jobject thiz, jlong ptr, jboolean reachable)</span> </span>&#123;</span><br><span class="line">    LinphoneCore *cptr = (LinphoneCore*)ptr;</span><br><span class="line">    <span class="keyword">if</span> (cptr == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">bctbx_error</span>(<span class="string">&quot;Java_org_linphone_core_CoreImpl_setNetworkReachable&#x27;s LinphoneCore C ptr is null!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">linphone_core_set_network_reachable</span>(cptr, (<span class="type">bool_t</span>)reachable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>linphone_jni.cc</code> ä¸­è°ƒç”¨äº† <code>linphone_core_set_network_reachable</code>ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linphone_core_set_network_reachable</span><span class="params">(LinphoneCore *lc, <span class="type">bool_t</span> is_reachable)</span> &#123;</span><br><span class="line">    <span class="type">bool_t</span> reachable = is_reachable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - ç”¨æˆ·è®¾ç½®çš„çŠ¶æ€</span></span><br><span class="line">    lc-&gt;sip_network_state.user_state = is_reachable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åª’ä½“ä¼ è¾“å±‚ç½‘ç»œçŠ¶æ€ - ç”¨æˆ·è®¾ç½®çš„çŠ¶æ€</span></span><br><span class="line">    lc-&gt;media_network_state.user_state = is_reachable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå¼€å¯äº†ç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹</span></span><br><span class="line">    <span class="keyword">if</span> (lc-&gt;auto_net_state_mon) reachable = reachable &amp;&amp; getPlatformHelpers(lc)-&gt;isNetworkReachable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">    set_sip_network_reachable(lc, reachable, ms_time(<span class="literal">NULL</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®åª’ä½“ä¼ è¾“å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">    set_media_network_reachable(lc, reachable);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šçŸ¥ç½‘ç»œå¯è¾¾æ€§å˜æ›´</span></span><br><span class="line">    notify_network_reachable_change(lc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>linphone_core_set_network_reachable</code> æ–¹æ³•ä¸­é¦–å…ˆæ˜¯ä¿®æ”¹äº† ã€ŒSIP åè®®å±‚ç½‘ç»œçŠ¶æ€ - ç”¨æˆ·è®¾ç½®çš„çŠ¶æ€ã€å’Œã€Œåª’ä½“ä¼ è¾“å±‚ç½‘ç»œçŠ¶æ€ - ç”¨æˆ·è®¾ç½®çš„çŠ¶æ€ã€ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å¼€å¯äº†ã€Œç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹ã€é…ç½®ï¼Œè‹¥æ˜¯å¼€å¯äº†ï¼Œåˆ™è·å–è‡ªåŠ¨æ£€æµ‹çš„ç½‘ç»œçŠ¶æ€å¹¶ä¸ä¼ å…¥çš„çŠ¶æ€å–ä¸”å€¼ï¼Œè¿™é‡Œå¯èƒ½ä¼šæ”¹å˜ä¼ å…¥çš„å€¼ï¼š<strong>å¦‚æœä¼ å…¥ Trueï¼Œè€Œ <code>isNetworkReachable</code> è¿”å› Falseï¼Œæœ€ç»ˆ <code>reachable</code> ä¸º Falseã€‚</strong></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹ <code>set_sip_network_reachable</code> æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_sip_network_reachable</span><span class="params">(LinphoneCore* lc,<span class="type">bool_t</span> is_sip_reachable, <span class="type">time_t</span> curtime)</span>&#123;</span><br><span class="line">	<span class="comment">// second get the list of available proxies</span></span><br><span class="line">	<span class="type">const</span> <span class="type">bctbx_list_t</span> *elem = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€ï¼Œæ¯”è¾ƒæ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (lc-&gt;sip_network_state.global_state==is_sip_reachable) <span class="keyword">return</span>; <span class="comment">// no change, ignore.</span></span><br><span class="line">	lc-&gt;network_reachable_to_be_notified=TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹åº”ä¸Šé¢æåˆ°çš„è®¾å¤‡é‡å¯åä¸ç½‘ç»œç›¸å…³çš„æ—¥å¿—</span></span><br><span class="line">	ms_message(<span class="string">&quot;SIP network reachability state is now [%s]&quot;</span>,is_sip_reachable?<span class="string">&quot;UP&quot;</span>:<span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	lc-&gt;netup_time=curtime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿®æ”¹SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">	lc-&gt;sip_network_state.global_state=is_sip_reachable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>set_sip_network_reachable</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯å¦ä¸å·²æœ‰çš„å€¼ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è®¤ä¸ºæ²¡æœ‰å˜åŒ–ï¼Œå¿½ç•¥æ­¤æ¬¡è°ƒç”¨ï¼Œç„¶åæ‰“å°ä¼ å…¥ <code>is_sip_reachable</code> çš„å€¼ï¼Œè¿™è¡Œæ—¥å¿—å¯¹åº”å‰é¢æåˆ°çš„è®¾å¤‡é‡å¯åä¸ç½‘ç»œç›¸å…³çš„æ—¥å¿—ï¼Œæœ€åä¿®æ”¹ã€ŒSIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€ã€ã€‚</p>
<p>å‰é¢æåˆ°åˆ·æ–°è´¦æˆ·æ³¨å†Œæ—¶ä¹Ÿæç¤ºç½‘ç»œä¸å¯è¾¾ï¼Œèµ¶å·§äº†ï¼Œ<code>set_sip_network_reachable</code> æ–¹æ³•çš„ä¸‹é¢å°±æ˜¯è°ƒç”¨åˆ·æ–°è´¦æˆ·æ³¨å†Œçš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linphone_core_refresh_registers</span><span class="params">(LinphoneCore* lc)</span> &#123;    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">	<span class="keyword">if</span> (!lc-&gt;sip_network_state.global_state) &#123;</span><br><span class="line">        <span class="comment">// å¯¹åº”åˆ·æ–°è´¦æˆ·æ³¨å†Œæ—¶çš„ç½‘ç»œä¸å¯è¾¾æ—¥å¿—</span></span><br><span class="line">		ms_warning(<span class="string">&quot;Refresh register operation not available (network unreachable)&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>linphone_core_refresh_registers</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå°±åˆ¤æ–­äº†ã€ŒSIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€ã€ï¼Œå¦‚æœä¸º Falseï¼Œåˆ™æ­¤æ—¶ç½‘ç»œä¸å¯è¾¾ï¼Œè¾“å‡ºç½‘ç»œä¸å¯è¾¾æ—¥å¿—ã€‚</p>
<p>æœ€åçœ‹ä¸‹ <code>Core#isNetworkReachable</code> çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool_t</span> <span class="title function_">linphone_core_is_network_reachable</span><span class="params">(LinphoneCore* lc)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å›SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">	<span class="keyword">return</span> lc-&gt;sip_network_state.global_state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Java ä¸­è°ƒç”¨ <code>isNetworkReachable</code> æœ€ç»ˆä¼šè°ƒç”¨åˆ°  <code>linphone_core_is_network_reachable</code> æ–¹æ³•ï¼Œåœ¨ <code>linphone_core_is_network_reachable</code> æ–¹æ³•ä¸­ï¼Œç›´æ¥è¿”å›äº†ã€ŒSIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€ã€ã€‚</p>
<h3 id="androidplatformhelpersetnetworkreachable"><a class="markdownIt-Anchor" href="#androidplatformhelpersetnetworkreachable"></a> AndroidPlatformHelper#setNetworkReachable</h3>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬åˆ†ææ˜¯åœ¨ <code>set_sip_network_reachable</code> æ–¹æ³•ä¿®æ”¹çš„ã€ŒSIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€ã€ï¼Œé™¤äº†æˆ‘ä»¬è°ƒç”¨ <code>Core#setNetworkReachable</code> å¤–ï¼Œåº”è¯¥è¿˜æœ‰è°ƒç”¨æ–¹ï¼Œåœ¨ IDE ä¸­åˆ†æå‘ç°äº† <code>linphone_core_set_network_reachable_internal</code> æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linphone_core_set_network_reachable_internal</span><span class="params">(LinphoneCore *lc, <span class="type">bool_t</span> is_reachable)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¼€å¯äº†ç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹</span></span><br><span class="line">	<span class="keyword">if</span> (lc-&gt;auto_net_state_mon) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®SIPåè®®å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">		set_sip_network_reachable(lc, lc-&gt;sip_network_state.user_state &amp;&amp; is_reachable, ms_time(<span class="literal">NULL</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®åª’ä½“ä¼ è¾“å±‚ç½‘ç»œçŠ¶æ€ - å…¨å±€çŠ¶æ€</span></span><br><span class="line">		set_media_network_reachable(lc, lc-&gt;media_network_state.user_state &amp;&amp; is_reachable);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥ç½‘ç»œå¯è¾¾æ€§å˜æ›´</span></span><br><span class="line">		notify_network_reachable_change(lc);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>linphone_core_set_network_reachable_internal</code> æ–¹æ³•ä¸­é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¼€å¯äº†ã€Œå¼€å¯äº†ç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹ã€é…ç½®ï¼Œç„¶åä¿®æ”¹å…¨å±€ç½‘ç»œçŠ¶æ€ã€‚</p>
<p>ç»§ç»­åˆ†æå“ªäº›è°ƒç”¨æ–¹è°ƒç”¨äº† <code>linphone_core_set_network_reachable_internal</code> æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// android-platform-helpers.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AndroidPlatformHelpers::setNetworkReachable</span><span class="params">(<span class="type">bool</span> reachable)</span> </span>&#123;</span><br><span class="line">	mNetworkReachable = reachable;</span><br><span class="line">	<span class="built_in">linphone_core_set_network_reachable_internal</span>(<span class="built_in">getCore</span>()-&gt;<span class="built_in">getCCore</span>(), reachable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­åˆ†æå“ªäº›è°ƒç”¨æ–¹è°ƒç”¨äº† <code>AndroidPlatformHelpers::setNetworkReachable</code> æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// android-platform-helpers.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_org_linphone_core_tools_AndroidPlatformHelper_setNetworkReachable</span><span class="params">(JNIEnv* env, jobject thiz, jlong ptr, jboolean reachable)</span> </span>&#123;</span><br><span class="line">	AndroidPlatformHelpers *androidPlatformHelper = <span class="built_in">static_cast</span>&lt;AndroidPlatformHelpers *&gt;((<span class="type">void</span> *)ptr);</span><br><span class="line">	<span class="type">const</span> std::function&lt;<span class="type">void</span> ()&gt; fun = [androidPlatformHelper, reachable]() &#123;</span><br><span class="line">		androidPlatformHelper-&gt;<span class="built_in">setNetworkReachable</span>(reachable);</span><br><span class="line">	&#125;;</span><br><span class="line">	androidPlatformHelper-&gt;<span class="built_in">getCore</span>()-&gt;<span class="built_in">doLater</span>(fun);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª <code>fun</code> å¯¹è±¡ï¼Œç±»ä¼¼ Java ä¸­çš„ <code>Runnable</code> æ¥å£ï¼ŒæŠ›ç»™ <code>doLater</code> æ–¹æ³•ç¨åæ‰§è¡Œã€‚</p>
<p>è·Ÿè¸ªåˆ°è¿™é‡Œï¼Œè¿½åˆ°äº† JNI å±‚ï¼Œçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ Java åŒ…åå’Œç±»å <code>AndroidPlatformHelper</code> ï¼Œåœ¨ AS ä¸­æ‰“å¼€ <code>AndroidPlatformHelper</code> ï¼Œæœç´¢è°ƒç”¨ <code>setNetworkReachable</code> çš„åœ°æ–¹ï¼Œå…±æœ‰ 6 å¤„ï¼Œå‡åœ¨ <code>updateNetworkReachability</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AndroidPlatformHelper.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">updateNetworkReachability</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.mNativePtr == <span class="number">0L</span>) &#123;</span><br><span class="line">        Log.w(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Native pointer has been reset, stopping there&quot;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.mNetworkManager == <span class="literal">null</span>) &#123;</span><br><span class="line">        Log.w(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Network Manager is null, stopping there&quot;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connected</span> <span class="operator">=</span> <span class="built_in">this</span>.mNetworkManager.isCurrentlyConnected(<span class="built_in">this</span>.mContext);</span><br><span class="line">        <span class="keyword">if</span> (!connected) &#123;</span><br><span class="line">            Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] No connectivity: setting network unreachable&quot;</span>&#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// â‘ </span></span><br><span class="line">            <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.mNetworkManager.hasHttpProxy(<span class="built_in">this</span>.mContext)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.useSystemHttpProxy(<span class="built_in">this</span>.mNativePtr)) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="built_in">this</span>.mNetworkManager.getProxyHost(<span class="built_in">this</span>.mContext);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="built_in">this</span>.mNetworkManager.getProxyPort(<span class="built_in">this</span>.mContext);</span><br><span class="line">                    <span class="built_in">this</span>.setHttpProxy(<span class="built_in">this</span>.mNativePtr, host, port);</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">this</span>.mUsingHttpProxy) &#123;</span><br><span class="line">                        Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Proxy wasn&#x27;t set before, disabling network reachability first&quot;</span>&#125;);</span><br><span class="line">                        <span class="comment">// â‘¡</span></span><br><span class="line">                        <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">this</span>.mUsingHttpProxy = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.w(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Proxy available but forbidden by linphone core [sip] use_system_http_proxy setting&quot;</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.setHttpProxy(<span class="built_in">this</span>.mNativePtr, <span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.mUsingHttpProxy) &#123;</span><br><span class="line">                    Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Proxy was set before, disabling network reachability first&quot;</span>&#125;);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// â‘¢</span></span><br><span class="line">                    <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.mUsingHttpProxy = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">NetworkInfo</span> <span class="variable">networkInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.mNetworkManager.getActiveNetworkInfo();</span><br><span class="line">            <span class="keyword">if</span> (networkInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] getActiveNetworkInfo() returned null !&quot;</span>&#125;);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// â‘£</span></span><br><span class="line">                <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Active network type is &quot;</span> + networkInfo.getTypeName() + <span class="string">&quot;, state &quot;</span> + networkInfo.getState() + <span class="string">&quot; / &quot;</span> + networkInfo.getDetailedState()&#125;);</span><br><span class="line">                <span class="keyword">if</span> (networkInfo.getState() == State.DISCONNECTED &amp;&amp; networkInfo.getDetailedState() == DetailedState.BLOCKED) &#123;</span><br><span class="line">                    Log.w(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Active network is in bad state...&quot;</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Network</span> <span class="variable">network</span> <span class="operator">=</span> <span class="built_in">this</span>.mNetworkManager.getActiveNetwork();</span><br><span class="line">                <span class="built_in">this</span>.mNetworkManager.updateDnsServers();</span><br><span class="line">                <span class="type">int</span> <span class="variable">currentNetworkType</span> <span class="operator">=</span> networkInfo.getType();</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.mLastNetworkType != -<span class="number">1</span> &amp;&amp; <span class="built_in">this</span>.mLastNetworkType != currentNetworkType) &#123;</span><br><span class="line">                    Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Network type has changed (last one was &quot;</span> + <span class="built_in">this</span>.networkTypeToString(<span class="built_in">this</span>.mLastNetworkType) + <span class="string">&quot;), disabling network reachability first&quot;</span>&#125;);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// â‘¤</span></span><br><span class="line">                    <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.mLastNetworkType = currentNetworkType;</span><br><span class="line">                Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Network reachability enabled&quot;</span>&#125;);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// â‘¥</span></span><br><span class="line">                <span class="built_in">this</span>.setNetworkReachable(<span class="built_in">this</span>.mNativePtr, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Š 6 å¤„è°ƒç”¨ï¼Œåªæœ‰æœ€åçš„ç¬¬ 6 å¤„ä¼ å…¥äº† Trueï¼Œè®¤ä¸ºç½‘ç»œå¯è¾¾ï¼›å…¶ä½™ 5 å¤„å‡ä¼ å…¥äº† Falseï¼Œè®¤ä¸ºç½‘ç»œä¸å¯è¾¾ã€‚ä¸Šé¢çš„ä»£ç ä¸»è¦æ˜¯è·å–å½“å‰æ´»è·ƒçš„ç½‘ç»œä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ´»è·ƒçš„ç½‘ç»œä¿¡æ¯å°±è®¤ä¸ºç½‘ç»œä¸å¯è¾¾ã€‚</p>
<p>ç»§ç»­åˆ†æå“ªäº›è°ƒç”¨æ–¹è°ƒç”¨äº† <code>AndroidPlatformHelpers#updateNetworkReachability</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AndroidPlatformHelper.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startNetworkMonitoring</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.mMonitoringEnabled) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® Android ç³»ç»Ÿç‰ˆæœ¬åˆ›å»ºç½‘ç»œç®¡ç†å™¨</span></span><br><span class="line">        <span class="built_in">this</span>.mNetworkManager = <span class="built_in">this</span>.createNetworkManager();</span><br><span class="line">        Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] Registering network callbacks&quot;</span>&#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†Œç½‘ç»œå˜åŒ–å›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.mNetworkManager.registerNetworkCallbacks(<span class="built_in">this</span>.mContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨äº†updateNetworkReachability</span></span><br><span class="line">        <span class="built_in">this</span>.updateNetworkReachability();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startNetworkMonitoring</code> æ–¹æ³•ä¸»è¦æ˜¯å¼€å¯ç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€é…ç½®ï¼Œæ¥ä¸‹æ¥æ ¹æ® Android ç³»ç»Ÿç‰ˆæœ¬åˆ›å»ºç½‘ç»œç®¡ç†å™¨ï¼Œç„¶åæ³¨å†Œç½‘ç»œå˜åŒ–å›è°ƒï¼Œæœ€åè°ƒç”¨äº† <code>updateNetworkReachability</code> æ–¹æ³•ï¼Œè¿›è¡Œä¸€æ¬¡ç½‘ç»œçŠ¶æ€é€šçŸ¥ã€‚</p>
<p>å‰é¢æåˆ°ç¬”è€…ç›®å‰ä½¿ç”¨çš„è®¾å¤‡æ˜¯ API 25ï¼Œåœ¨ <code>createNetworkManager</code> æ–¹æ³•ä¸­æ‰¾åˆ°å¯¹åº”çš„ç½‘ç»œç®¡ç†å™¨å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NetworkManagerAbove24.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NetworkManagerAbove24</span><span class="params">(AndroidPlatformHelper helper, ConnectivityManager cm, <span class="type">boolean</span> wifiOnly)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.mHelper = helper;</span><br><span class="line">    <span class="built_in">this</span>.mConnectivityManager = cm;</span><br><span class="line">    <span class="built_in">this</span>.mWifiOnly = wifiOnly;</span><br><span class="line">    <span class="built_in">this</span>.mNetworkAvailable = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.mLastNetworkAvailable = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç½‘ç»œå˜åŒ–å›è°ƒ</span></span><br><span class="line">    <span class="built_in">this</span>.mNetworkCallback = <span class="keyword">new</span> <span class="title class_">NetworkCallback</span>() &#123;</span><br><span class="line">        <span class="comment">// ç½‘ç»œå¯ç”¨</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAvailable</span><span class="params">(<span class="keyword">final</span> Network network)</span> &#123;</span><br><span class="line">            <span class="comment">// MainHandler</span></span><br><span class="line">            NetworkManagerAbove24.<span class="built_in">this</span>.mHelper.getHandler().post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="type">NetworkInfo</span> <span class="variable">info</span> <span class="operator">=</span> NetworkManagerAbove24.<span class="built_in">this</span>.mConnectivityManager.getNetworkInfo(network);</span><br><span class="line">                    <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">                        Log.e(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] [Network Manager 24] A network should be available but getNetworkInfo failed.&quot;</span>&#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] [Network Manager 24] A network is available: &quot;</span> + info.getTypeName() + <span class="string">&quot;, wifi only is &quot;</span> + (NetworkManagerAbove24.<span class="built_in">this</span>.mWifiOnly ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>)&#125;);</span><br><span class="line">                        <span class="keyword">if</span> (NetworkManagerAbove24.<span class="built_in">this</span>.mWifiOnly &amp;&amp; info.getType() != <span class="number">1</span> &amp;&amp; info.getType() != <span class="number">9</span>) &#123;</span><br><span class="line">                            Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] [Network Manager 24] Network isn&#x27;t wifi and wifi only mode is enabled&quot;</span>&#125;);</span><br><span class="line">                            <span class="keyword">if</span> (NetworkManagerAbove24.<span class="built_in">this</span>.mWifiOnly) &#123;</span><br><span class="line">                                NetworkManagerAbove24.<span class="built_in">this</span>.mLastNetworkAvailable = network;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            NetworkManagerAbove24.<span class="built_in">this</span>.mNetworkAvailable = network;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// è°ƒç”¨äº†updateNetworkReachability</span></span><br><span class="line">                            NetworkManagerAbove24.<span class="built_in">this</span>.mHelper.updateNetworkReachability();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç½‘ç»œä¸¢å¤±</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLost</span><span class="params">(<span class="keyword">final</span> Network network)</span> &#123;</span><br><span class="line">            <span class="comment">// MainHandler</span></span><br><span class="line">            NetworkManagerAbove24.<span class="built_in">this</span>.mHelper.getHandler().post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] [Network Manager 24] A network has been lost&quot;</span>&#125;);</span><br><span class="line">                    <span class="keyword">if</span> (NetworkManagerAbove24.<span class="built_in">this</span>.mNetworkAvailable != <span class="literal">null</span> &amp;&amp; NetworkManagerAbove24.<span class="built_in">this</span>.mNetworkAvailable.equals(network)) &#123;</span><br><span class="line">                        NetworkManagerAbove24.<span class="built_in">this</span>.mNetworkAvailable = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (NetworkManagerAbove24.<span class="built_in">this</span>.mLastNetworkAvailable != <span class="literal">null</span> &amp;&amp; NetworkManagerAbove24.<span class="built_in">this</span>.mLastNetworkAvailable.equals(network)) &#123;</span><br><span class="line">                        NetworkManagerAbove24.<span class="built_in">this</span>.mLastNetworkAvailable = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è°ƒç”¨äº†updateNetworkReachability</span></span><br><span class="line">                    NetworkManagerAbove24.<span class="built_in">this</span>.mHelper.updateNetworkReachability();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œç½‘ç»œå˜åŒ–å›è°ƒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerNetworkCallbacks</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">permissionGranted</span> <span class="operator">=</span> context.getPackageManager().checkPermission(<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>, context.getPackageName());</span><br><span class="line">    Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] [Network Manager 24] ACCESS_NETWORK_STATE permission is &quot;</span> + (permissionGranted == <span class="number">0</span> ? <span class="string">&quot;granted&quot;</span> : <span class="string">&quot;denied&quot;</span>)&#125;);</span><br><span class="line">    <span class="keyword">if</span> (permissionGranted == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.mConnectivityManager.registerDefaultNetworkCallback(<span class="built_in">this</span>.mNetworkCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>NetworkManagerAbove24.java</code> çš„å®ç°ä¸­ï¼Œç½‘ç»œå¯ç”¨æ—¶ä¹Ÿä¼šè°ƒç”¨ <code>AndroidPlatformHelper#updateNetworkReachability</code>æ–¹æ³•ã€‚</p>
<p>åˆ°è¿™é‡Œå…¶å®å·®ä¸å¤šäº†ï¼Œå› ä¸ºåˆ†æä¸‹æ¥ï¼Œå‘ç°ç½‘ç»œå¯ç”¨æ—¶é€šçŸ¥ linphone ç½‘ç»œå¯è¾¾ï¼Œç½‘ç»œä¸¢å¤±æ—¶é€šçŸ¥ linphone ç½‘ç»œä¸å¯è¾¾ï¼Œä»¥ä¸Šæµç¨‹ç¬¦åˆæ­£å¸¸çš„æ€ç»´é€»è¾‘ï¼Œç¬”è€…è¿½åˆ°è¿™é‡Œï¼Œåªèƒ½æ˜¯æ€€ç–‘åœ¨ <code>startNetworkMonitoring</code> å’Œ <code>NetworkManagerAbove24#onAvailable</code> çš„ä¸¤å¤„è°ƒç”¨æœ‰å¹¶å‘é¡ºåºé—®é¢˜ï¼Œ<code>onAvailable</code> ä¸€å®šæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œè€Œ <code>startNetworkMonitoring</code> å°±ä¸ç¡®å®šæ˜¯åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œäº†ã€‚</p>
<p>æœ€åç¬”è€…æƒ³ç€å…³é—­ã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€é…ç½®ï¼Œç”±ä¸šåŠ¡ç¨‹åºè‡ªèº«ç›‘å¬ç½‘ç»œå˜åŒ–ï¼Œç„¶åè°ƒç”¨ <code>Core#setNetworkReachable</code> æ–¹æ³•é€šçŸ¥ linphone ç½‘ç»œæ˜¯å¦å¯è¾¾ã€‚</p>
<h3 id="auto_net_state_mon"><a class="markdownIt-Anchor" href="#auto_net_state_mon"></a> auto_net_state_mon</h3>
<p>åœ¨ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬åˆ†æäº† <code>startNetworkMonitoring</code> æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­åˆ†æå“ªäº›è°ƒç”¨æ–¹è°ƒç”¨äº† <code>startNetworkMonitoring</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AndroidPlatformHelper.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">onLinphoneCoreStart</span><span class="params">(<span class="type">boolean</span> monitoringEnabled)</span> &#123;</span><br><span class="line">    Log.i(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[Platform Helper] onLinphoneCoreStart, network monitoring is &quot;</span> + monitoringEnabled&#125;);</span><br><span class="line">    <span class="built_in">this</span>.mMonitoringEnabled = monitoringEnabled;</span><br><span class="line">    <span class="built_in">this</span>.startNetworkMonitoring();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onLinphoneCoreStart</code> æ–¹æ³•åœ¨ <code>AndroidPlatformHelper.java</code> ä¸­æ²¡æœ‰æ‰¾åˆ°è°ƒç”¨æ–¹ï¼Œæ€€ç–‘æ­¤æ–¹æ³•æ˜¯åœ¨ native å±‚è°ƒç”¨äº†ï¼Œæˆ‘ä»¬å» <code>android-platform-helpers.cpp</code> ä¸­æœç´¢ä¸€ç•ªï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// android-platform-helpers.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AndroidPlatformHelpers::onLinphoneCoreStart</span><span class="params">(<span class="type">bool</span> monitoringEnabled)</span> </span>&#123;</span><br><span class="line">	JNIEnv *env = <span class="built_in">ms_get_jni_env</span>();</span><br><span class="line">	<span class="keyword">if</span> (env) &#123;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨AndroidPlatformHelper#onLinphoneCoreStart</span></span><br><span class="line">		<span class="keyword">if</span> (mJavaHelper) &#123;</span><br><span class="line">			env-&gt;<span class="built_in">CallVoidMethod</span>(mJavaHelper, mOnLinphoneCoreStartId, (jboolean)monitoringEnabled);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>AndroidPlatformHelpers::onLinphoneCoreStart</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>AndroidPlatformHelper#onLinphoneCoreStart</code> æ–¹æ³•ï¼Œå¥½çš„ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æ <code>AndroidPlatformHelpers::onLinphoneCoreStart</code> çš„è°ƒç”¨æ–¹ï¼Œé€šè¿‡åœ¨ IDE ä¸­æœç´¢å‘ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line">LinphoneStatus <span class="title function_">linphone_core_start</span> <span class="params">(LinphoneCore *lc)</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ˜¯å¦å¼€å¯äº†ç½‘ç»œçŠ¶æ€è‡ªåŠ¨æ£€æµ‹</span></span><br><span class="line">    <span class="type">bool</span> autoNetworkStateMonitoringEnabled = !!lc-&gt;auto_net_state_mon;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¼€å¯ï¼Œè¾“å‡ºæ—¥å¿—</span></span><br><span class="line">    <span class="keyword">if</span> (!autoNetworkStateMonitoringEnabled) &#123;</span><br><span class="line">        bctbx_warning(<span class="string">&quot;Automatic network state monitoring is disabled by configuration (auto_net_state_mon=0). This is not recommended.&quot;</span>);</span><br><span class="line">        bctbx_warning(<span class="string">&quot;In this mode, apps must use linphone_core_set_network_reachable() and linphone_core_set_dns_servers() to notify the LinphoneCore of network availability and provide the DNS server list.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨AndroidPlatformHelpers::onLinphoneCoreStart</span></span><br><span class="line">    getPlatformHelpers(lc)-&gt;onLinphoneCoreStart(autoNetworkStateMonitoringEnabled);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bingo~ï¼Œå‘ç°äº† <code>lc-&gt;auto_net_state_mon</code> ï¼Œç°åœ¨æˆ‘ä»¬åªè¦æ‰¾åˆ° <code>lc-&gt;auto_net_state_mon</code> æ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„å°±å¯ä»¥äº†ï¼Œè¿˜æ˜¯åœ¨ IDE ä¸­æœç´¢åˆ†æï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _linphone_core_read_config(LinphoneCore * lc) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯»å–å„ç§é…ç½®é¡¹</span></span><br><span class="line">    sip_setup_register_all(lc-&gt;factory);</span><br><span class="line">    sound_config_read(lc);</span><br><span class="line">    net_config_read(lc);</span><br><span class="line">    rtp_config_read(lc);</span><br><span class="line">    codecs_config_read(lc);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯»å–sip_config</span></span><br><span class="line">    sip_config_read(lc);</span><br><span class="line">    video_config_read(lc);</span><br><span class="line">    <span class="comment">//autoreplier_config_init(&amp;lc-&gt;autoreplier_conf);</span></span><br><span class="line">    misc_config_read(lc);</span><br><span class="line">    ui_config_read(lc);</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> TUNNEL_ENABLED</span></span><br><span class="line">    <span class="keyword">if</span> (lc-&gt;tunnel) &#123;</span><br><span class="line">        linphone_tunnel_configure(lc-&gt;tunnel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨sip_conf-&gt;auto_net_state_monèµ‹å€¼</span></span><br><span class="line">    lc-&gt;auto_net_state_mon=lc-&gt;sip_conf.auto_net_state_mon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_linphone_core_read_config</code> æ–¹æ³•ä¸»è¦æ˜¯è¯»å–å„ç§é…ç½®é¡¹ï¼Œä¸ <code>auto_net_state_mon</code> ç›¸å…³çš„ä¸»è¦æ˜¯ <code>sip_config_read(lc);</code> å’Œ æœ€åä¸€è¡Œä»£ç ï¼Œæœ€åä¸€è¡Œä»£ç ä½¿ç”¨ <code>sip_conf</code> ä¸­çš„ <code>auto_net_state_mon</code> ä¸º <code>lc-&gt;auto_net_state_mon</code> èµ‹å€¼ï¼Œ<code>sip_conf</code> åœ¨ <code>sip_config_read(lc);</code> ä¸­èµ‹å€¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// linphonecore.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sip_config_read</span><span class="params">(LinphoneCore *lc)</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    </span><br><span class="line">    lc-&gt;sip_conf.auto_net_state_mon = !!linphone_config_get_int(lc-&gt;config,<span class="string">&quot;sip&quot;</span>,<span class="string">&quot;auto_net_state_mon&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>sip_config_read</code> æ–¹æ³•ä¸­ï¼Œé€šè¿‡è¯»å– <code>Config</code> ä¸­çš„ <code>Section</code> å’Œ <code>Key</code> èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„ <code>Section</code> å’Œ <code>Key</code> ï¼Œåˆ™å–é»˜è®¤å€¼ 1ã€‚</p>
<p>ç»ˆäºæ‰¾åˆ°é…ç½®ã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€å¼€å…³çš„åœ°æ–¹äº†ï¼Œ<code>Config</code> æ˜¯åœ¨ Java å±‚åˆ›å»º <code>Core</code> æ—¶ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬åªéœ€ä¿®æ”¹ Java å±‚ä»£ç å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºConfig</span></span><br><span class="line">    <span class="type">Config</span> <span class="variable">configWithFactory</span> <span class="operator">=</span> mFactory.createConfigWithFactory(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®å¤–éƒ¨ä¼ å…¥çš„é…ç½®åˆ¤æ–­æ˜¯å¦å¼€å¯linphoneçš„ã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€å¼€å…³</span></span><br><span class="line">    <span class="keyword">if</span> (mConfig.autoNetStateMonitorEnabled()) &#123;</span><br><span class="line">        configWithFactory.setInt(<span class="string">&quot;sip&quot;</span>, <span class="string">&quot;auto_net_state_mon&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        configWithFactory.setInt(<span class="string">&quot;sip&quot;</span>, <span class="string">&quot;auto_net_state_mon&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®Configåˆ›å»ºCore</span></span><br><span class="line">    mCore = mFactory.createCoreWithConfig(configWithFactory, mContext.getApplicationContext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆé€šè¿‡ <code>Factory</code> åˆ›å»ºç©ºçš„ <code>Config</code> å¯¹è±¡ï¼Œç„¶åæ ¹æ®å¤–éƒ¨ä¼ å…¥çš„é…ç½®åˆ¤æ–­æ˜¯å¦å¼€å¯linphoneçš„ã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€å¼€å…³ï¼Œéšåæ ¹æ® <code>Config</code> å¯¹è±¡åˆ›å»º <code>Core</code>ï¼Œ</p>
<p>æœ€åè¿è¡Œç¨‹åºæŸ¥çœ‹ Logcat æ—¥å¿—ï¼Œåœ¨ <code>AndroidPlatformHelper#onLinphoneCoreStart</code> æ–¹æ³•ä¸­æœ‰è¾“å‡ºæ˜¯å¦å¼€å¯äº†ã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">linphone-android : [Platform Helper] onLinphoneCoreStart, network monitoring is false</span><br></pre></td></tr></table></figure>
<p>happy~</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡ç¬”è€…è®°å½•äº†ä»æ ¹æ®é—®é¢˜ç°è±¡ï¼Œåˆ†æé—®é¢˜ï¼Œåå‘è·Ÿè¸ªæºç åˆ°ç½‘ç»œæ£€æµ‹é€»è¾‘ï¼Œè‡³ç½‘ç»œæ£€æµ‹é€»è¾‘æ—¶ï¼Œé—®é¢˜åˆ†æé™·å…¥å›°å¢ƒï¼Œå†åˆ°å¤§èƒ†å‡è®¾æ˜¯å¹¶å‘å¼•èµ·çš„é—®é¢˜ï¼Œéšåæ²¿ç€å¹¶å‘å¼•èµ·é—®é¢˜çš„å‡è®¾ï¼Œæƒ³åˆ°å…³é—­ linphoneã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€é…ç½®çš„æ–¹æ³•ï¼Œæœ€ååˆ†æã€Œè‡ªåŠ¨æ£€æµ‹ç½‘ç»œçŠ¶æ€ã€é…ç½®çš„å¼€å¯æµç¨‹ã€‚</p>
<p>ç¬”è€…åœ¨åˆ†ææ’æŸ¥æœŸé—´æœ‰ä¸€æ­¥æ”¾å¼ƒçš„è¯ï¼Œä¹Ÿçœ‹ä¸åˆ°æœ€åçš„æ›™å…‰ã€‚</p>
<p>ä¸ç»å†é£é›¨æ€èƒ½è§å½©è™¹ï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ~</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®æ”¹linphone-sdk-android-ç¬¬ä¸‰ç¯‡</title>
    <url>/2022/04/26/linphone-sdk-android/%E4%BF%AE%E6%94%B9linphone-sdk-android-%E7%AC%AC%E4%B8%89%E7%AF%87/</url>
    <content><![CDATA[<h1 id="ä¿®æ”¹linphone-sdk-android-ä¸‹ç¯‡"><a class="markdownIt-Anchor" href="#ä¿®æ”¹linphone-sdk-android-ä¸‹ç¯‡"></a> ä¿®æ”¹linphone-sdk-android-ä¸‹ç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>æ¥ä¸Šç¯‡<a href="https://juejin.cn/post/7089664949907095559">ä¿®æ”¹linphone-sdk-android-ä¸Šç¯‡</a></p>
<p>æ¥ä¸­ç¯‡<a href="https://juejin.cn/post/7090172691617071118">ä¿®æ”¹linphone-sdk-android-ä¸­ç¯‡</a></p>
<p>æœ¬æ–‡æ˜¯ä¸‹ç¯‡ï¼Œæœ¬ç¯‡è®°å½•åœ¨ä¸Šç¯‡ä¸­æåˆ°çš„é—®é¢˜1æ’æŸ¥è¿‡ç¨‹åŠä¿®å¤æ–¹æ¡ˆï¼Œå°½é‡æè¿°æ’æŸ¥é—®é¢˜è¿‡ç¨‹ä¸­çš„æ€è·¯ä¸æ–¹å‘</p>
<p>ä¸Šç¯‡ä¸­è¯´é—®é¢˜1å½“åˆè®¤ä¸ºæ˜¯linphoneçš„bugï¼Œåé¢çœ‹æºç åŠæŸ¥èµ„æ–™å‘ç°å¯èƒ½ä¸æ˜¯bugï¼Œæœ¬ç¯‡å°†è®°å½•ä¸ªäººçš„ç†è§£</p>
<h2 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜</h2>
<p>è¿™é‡Œå†æè¿°ä¸‹é—®é¢˜1ï¼šæ‰“å¼€éŸ³é¢‘ç¼–è§£ç G722ã€G729ç­‰æ—¶ï¼Œå‘èµ·å‘¼å«çš„INVITE SDPä¸­ï¼Œæ²¡æœ‰G722ã€G729çš„<code>rtpmap</code></p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">m</span>=audio <span class="number">7078</span> RTP/AVP <span class="number">96</span> <span class="number">0</span> <span class="number">8</span> <span class="number">9</span> <span class="number">18</span> <span class="number">101</span> <span class="number">97</span></span><br><span class="line"><span class="attribute">a</span>=fmtp:<span class="number">18</span> annexb=yes</span><br><span class="line"><span class="attribute">a</span>=rtpmap:<span class="number">101</span> telephone-event/<span class="number">48000</span></span><br><span class="line"><span class="attribute">a</span>=rtpmap:<span class="number">97</span> telephone-event/<span class="number">8000</span></span><br><span class="line"><span class="attribute">a</span>=rtcp-fb:* trr-int <span class="number">1000</span></span><br><span class="line"><span class="attribute">a</span>=rtcp-fb:* ccm tmmbr</span><br></pre></td></tr></table></figure>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<p>è¿™é‡Œå…ˆäº†è§£ä¸‹SDPåè®®ï¼Œå‚è€ƒ<a href="https://www.3cx.com/blog/voip-howto/sdp-voip2/">The Session Description Protocol (SDP) (3cx.com)</a></p>
<p><code>rtpmap</code>æ˜¯<code>Session attribute lines</code>ï¼Œå³ä¸ºä¼šè¯å±æ€§è¡Œï¼Œæ˜¯å¯¹<code>Payload Type</code>çš„è¡¥å……è¯´æ˜ï¼Œ<code>Payload Type</code>æ—¢æ˜¯<code>m=audio 7078 RTP/AVP 96 0 8 9 18 101 97</code>ä¸­<code>AVP</code>åé¢çš„æ•°å­—ï¼Œè¿™äº›æ•°å­—æ˜¯éŸ³é¢‘ç¼–è§£ç å¯¹åº”çš„ä»£ç ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<p>ä¸‹è¡¨æºè‡ª<a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml#rtp-parameters-1">Real-Time Transport Protocol (RTP) Parameters (iana.org)</a></p>
<table>
<thead>
<tr>
<th style="text-align:left">PT <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
<th style="text-align:left">Encoding Name <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
<th style="text-align:left">Audio/Video (A/V) <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
<th style="text-align:left">Clock Rate (Hz) <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
<th style="text-align:left">Channels <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
<th style="text-align:left">Reference <img data-src="https://www.iana.org/assignments/_support/sort_none.gif" alt="img" /></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">PCMU</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">Reserved</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">Reserved</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">GSM</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">G723</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml#Vineet_Kumar">Vineet_Kumar</a>][<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">DVI4</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">DVI4</td>
<td style="text-align:left">A</td>
<td style="text-align:left">16000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">LPC</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">PCMA</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">G722</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">L16</td>
<td style="text-align:left">A</td>
<td style="text-align:left">44100</td>
<td style="text-align:left">2</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left">L16</td>
<td style="text-align:left">A</td>
<td style="text-align:left">44100</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left">QCELP</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left">CN</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3389">RFC3389</a>]</td>
</tr>
<tr>
<td style="text-align:left">14</td>
<td style="text-align:left">MPA</td>
<td style="text-align:left">A</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>][<a href="https://www.iana.org/go/rfc2250">RFC2250</a>]</td>
</tr>
<tr>
<td style="text-align:left">15</td>
<td style="text-align:left">G728</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">16</td>
<td style="text-align:left">DVI4</td>
<td style="text-align:left">A</td>
<td style="text-align:left">11025</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml#Joseph_Di_Pol">Joseph_Di_Pol</a>]</td>
</tr>
<tr>
<td style="text-align:left">17</td>
<td style="text-align:left">DVI4</td>
<td style="text-align:left">A</td>
<td style="text-align:left">22050</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml#Joseph_Di_Pol">Joseph_Di_Pol</a>]</td>
</tr>
<tr>
<td style="text-align:left">18</td>
<td style="text-align:left">G729</td>
<td style="text-align:left">A</td>
<td style="text-align:left">8000</td>
<td style="text-align:left">1</td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">19</td>
<td style="text-align:left">Reserved</td>
<td style="text-align:left">A</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">20</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">A</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">21</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">A</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">22</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">A</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">23</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">A</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">24</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">V</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">25</td>
<td style="text-align:left">CelB</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc2029">RFC2029</a>]</td>
</tr>
<tr>
<td style="text-align:left">26</td>
<td style="text-align:left">JPEG</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc2435">RFC2435</a>]</td>
</tr>
<tr>
<td style="text-align:left">27</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">V</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">28</td>
<td style="text-align:left">nv</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">29</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">V</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">30</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">V</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">31</td>
<td style="text-align:left">H261</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc4587">RFC4587</a>]</td>
</tr>
<tr>
<td style="text-align:left">32</td>
<td style="text-align:left">MPV</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc2250">RFC2250</a>]</td>
</tr>
<tr>
<td style="text-align:left">33</td>
<td style="text-align:left">MP2T</td>
<td style="text-align:left">AV</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc2250">RFC2250</a>]</td>
</tr>
<tr>
<td style="text-align:left">34</td>
<td style="text-align:left">H263</td>
<td style="text-align:left">V</td>
<td style="text-align:left">90000</td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml#Chunrong_Zhu">Chunrong_Zhu</a>]</td>
</tr>
<tr>
<td style="text-align:left">35-71</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">?</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">72-76</td>
<td style="text-align:left">Reserved for RTCP conflict avoidance</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
<tr>
<td style="text-align:left">77-95</td>
<td style="text-align:left">Unassigned</td>
<td style="text-align:left">?</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">96-127</td>
<td style="text-align:left">dynamic</td>
<td style="text-align:left">?</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">[<a href="https://www.iana.org/go/rfc3551">RFC3551</a>]</td>
</tr>
</tbody>
</table>
<p>ä»è¡¨ä¸­äº†è§£åˆ°ï¼ŒPayload Type(PT) code 0 - 95ä¸ºé™æ€ç±»å‹ï¼Œå³codeå¯¹åº”å›ºå®šçš„codec(ç¼–è§£ç å™¨)ï¼Œ96 - 127ä¸ºåŠ¨æ€codecï¼Œå³éœ€è¦åœ¨SDPåå•†è¿‡ç¨‹ä¸­ç¡®å®š</p>
<p>æ¥ä¸‹æ¥è¿½è¸ªä¸‹æºç ï¼Œçœ‹çœ‹SDPä¸­ä¸ºä»€ä¹ˆæ²¡æœ‰<code>rtpmap</code></p>
<p>å…ˆæ‰¾åˆ°<code>Java</code>å±‚å‘èµ·å‘¼å«çš„ä»£ç ï¼Œåœ¨<code>Core.java</code>ä¸­æœ‰4ä¸ªå‘èµ·å‘¼å«çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">Call <span class="title function_">invite</span><span class="params">(<span class="meta">@NonNull</span> String var1)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">Call <span class="title function_">inviteAddress</span><span class="params">(<span class="meta">@NonNull</span> Address var1)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">Call <span class="title function_">inviteAddressWithParams</span><span class="params">(<span class="meta">@NonNull</span> Address var1, <span class="meta">@NonNull</span> CallParams var2)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">Call <span class="title function_">inviteWithParams</span><span class="params">(<span class="meta">@NonNull</span> String var1, <span class="meta">@NonNull</span> CallParams var2)</span>;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“å®ç°åœ¨<code>CoreImpl.java</code>ä¸­ï¼ŒæŸ¥çœ‹è¿™ä¸ª<code>public Call inviteAddress(@NonNull Address addr);</code>æ–¹æ³•å§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> Call <span class="title function_">inviteAddress</span><span class="params">(<span class="type">long</span> nativePtr, Address addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">synchronized</span> <span class="keyword">public</span> Call <span class="title function_">inviteAddress</span><span class="params">(<span class="meta">@NonNull</span> Address addr)</span>  &#123;</span><br><span class="line">    <span class="keyword">return</span> (Call)inviteAddress(nativePtr, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Java</code>å±‚è°ƒç”¨äº†<code>native</code>å±‚ä»£ç ï¼Œæ‰“å¼€ç¼–è¯‘åç”Ÿæˆçš„<code>linphone_jni.cc</code>ï¼Œæ‰¾åˆ°<code>Java_org_linphone_core_CoreImpl_inviteAddress</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_org_linphone_core_CoreImpl_inviteAddress</span><span class="params">(JNIEnv *env, jobject thiz, jlong ptr, jobject addr)</span> </span>&#123;</span><br><span class="line">	LinphoneCore *cptr = (LinphoneCore*)ptr;</span><br><span class="line">	<span class="keyword">if</span> (cptr == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="built_in">bctbx_error</span>(<span class="string">&quot;Java_org_linphone_core_CoreImpl_inviteAddress&#x27;s LinphoneCore C ptr is null!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	LinphoneAddress* c_addr = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (addr) c_addr = (LinphoneAddress*)<span class="built_in">GetObjectNativePtr</span>(env, addr);</span><br><span class="line">	</span><br><span class="line">	jobject jni_result = (jobject)<span class="built_in">getCall</span>(env, (LinphoneCall *)<span class="built_in">linphone_core_invite_address</span>(cptr, c_addr), TRUE);</span><br><span class="line">	<span class="keyword">return</span> jni_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>native</code>å±‚è°ƒç”¨äº†<code>linphone_core_invite_address</code>è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨IDEä¸­ï¼Œå¯ä»¥é€šè¿‡Ctrl+å·¦é”®ç‚¹å‡»è¿›è¡Œè·³è½¬ï¼Œ<code>linphone_core_invite_address</code>ä½äº<code>linphonecore.c</code>ä¸­</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LinphoneCall * <span class="title">linphone_core_invite_address</span><span class="params">(LinphoneCore *lc, <span class="type">const</span> LinphoneAddress *addr)</span></span>&#123;</span><br><span class="line">	LinphoneCall *call;</span><br><span class="line">	LinphoneCallParams *p=<span class="built_in">linphone_core_create_call_params</span>(lc, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">linphone_call_params_enable_video</span>(p, <span class="built_in">linphone_call_params_video_enabled</span>(p) &amp;&amp; !!lc-&gt;video_policy.automatically_initiate);</span><br><span class="line">	call=<span class="built_in">linphone_core_invite_address_with_params</span> (lc,addr,p);</span><br><span class="line">	<span class="built_in">linphone_call_params_unref</span>(p);</span><br><span class="line">	<span class="keyword">return</span> call;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>linphone_core_invite_address</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>linphone_core_invite_address_with_params</code>å‘èµ·å‘¼å«ï¼Œè¿™ä¸ªæ–¹æ³•è¾ƒé•¿ï¼Œåˆ å‡ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LinphoneCall * <span class="title">linphone_core_invite_address_with_params</span><span class="params">(LinphoneCore *lc, <span class="type">const</span> LinphoneAddress *addr, <span class="type">const</span> LinphoneCallParams *params)</span></span>&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *from=<span class="literal">NULL</span>;</span><br><span class="line">	LinphoneCall *call;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!addr) &#123;</span><br><span class="line">		<span class="built_in">ms_error</span>(<span class="string">&quot;Can&#x27;t invite a NULL address&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	parsed_url2=<span class="built_in">linphone_address_new</span>(from);</span><br><span class="line">	call=<span class="built_in">linphone_call_new_outgoing</span>(lc,parsed_url2,addr,cp,proxy);</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> defer = Call::<span class="built_in">toCpp</span>(call)-&gt;<span class="built_in">initiateOutgoing</span>();</span><br><span class="line">	<span class="keyword">if</span> (!defer) &#123;</span><br><span class="line">		<span class="keyword">if</span> (Call::<span class="built_in">toCpp</span>(call)-&gt;<span class="built_in">startInvite</span>(<span class="literal">nullptr</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* The call has already gone to error and released state, so do not return it */</span></span><br><span class="line">			call = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>linphone_core_invite_address_with_params</code>æ–¹æ³•ä¸­è°ƒç”¨<code>linphone_call_new_outgoing</code>æ–¹æ³•åˆ›å»º<code>Call</code>å¯¹è±¡ï¼Œè°ƒç”¨<code>initiateOutgoing</code>æ–¹æ³•åˆå§‹åŒ–å‘èµ·å‘¼å«å¹¶è®¾ç½®å½“å‰çŠ¶æ€ä¸º<code>OutgoingInit</code>ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>startInvite</code>æ–¹æ³•å‘èµ·å‘¼å«ï¼Œ<code>startInvite</code>æ–¹æ³•ä½äº<code>call.cpp</code>ä¸­ï¼Œåœ¨å…¶ä¸­åˆè°ƒç”¨<code>getActiveSession</code>æ–¹æ³•è·å–<code>CallSession</code>ï¼Œè°ƒç”¨<code>CallSession::startInvite</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Call::startInvite</span> <span class="params">(<span class="type">const</span> Address *destination)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">getActiveSession</span>()-&gt;<span class="built_in">startInvite</span>(destination, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CallSession::startInvite</code>æ–¹æ³•ä½äº<code>call-session.cpp</code>ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ‰¾äº†åŠå¤©ï¼Œæ²¡è§æœ‰ä¸SDPå‘é€ç›¸å…³çš„é€»è¾‘ï¼Œå…ˆå»å¤´æ–‡ä»¶ä¸­çœ‹çœ‹æ–¹æ³•åŸå‹å§</p>
<p>æ‰¾äº†åŠå¤©ä¹Ÿæ˜¯æœ‰ç‚¹æ”¶è·çš„ï¼Œåˆ†æå‡ºè°ƒç”¨<code>addAdditionalLocalBody</code>å»ç»„è£…è‡ªå®šä¹‰æ‰©å±•å¤´æ•°æ®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">CallSession::startInvite</span> <span class="params">(<span class="type">const</span> Address *destination, <span class="type">const</span> string &amp;subject, <span class="type">const</span> Content *content)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">L_D</span>();</span><br><span class="line">	d-&gt;subject = subject;</span><br><span class="line">	<span class="comment">/* Try to be best-effort in giving real local or routable contact address */</span></span><br><span class="line">	d-&gt;<span class="built_in">setContactOp</span>();</span><br><span class="line">	string destinationStr;</span><br><span class="line">	<span class="type">char</span> *realUrl = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (destination)</span><br><span class="line">		destinationStr = destination-&gt;<span class="built_in">asString</span>();</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		realUrl = <span class="built_in">linphone_address_as_string</span>(d-&gt;log-&gt;to);</span><br><span class="line">		destinationStr = realUrl;</span><br><span class="line">		<span class="built_in">ms_free</span>(realUrl);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">char</span> *from = <span class="built_in">linphone_address_as_string</span>(d-&gt;log-&gt;from);</span><br><span class="line">	<span class="comment">/* Take a ref because sal_call() may destroy the CallSession if no SIP transport is available */</span></span><br><span class="line">	shared_ptr&lt;CallSession&gt; ref = <span class="built_in">getSharedFromThis</span>();</span><br><span class="line">	<span class="keyword">if</span> (content)</span><br><span class="line">		d-&gt;op-&gt;<span class="built_in">setLocalBody</span>(*content);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If a custom Content has been set in the call params, create a multipart body for the INVITE</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; content : d-&gt;params-&gt;<span class="built_in">getCustomContents</span>()) &#123;</span><br><span class="line">		d-&gt;op-&gt;<span class="built_in">addAdditionalLocalBody</span>(content);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> result = d-&gt;op-&gt;<span class="built_in">call</span>(from, destinationStr, subject);</span><br><span class="line">	<span class="built_in">ms_free</span>(from);</span><br><span class="line">	<span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((d-&gt;state != CallSession::State::Error) &amp;&amp; (d-&gt;state != CallSession::State::Released)) &#123;</span><br><span class="line">			<span class="comment">// sal_call() may invoke call_failure() and call_released() SAL callbacks synchronously,</span></span><br><span class="line">			<span class="comment">// in which case there is no need to perform a state change here.</span></span><br><span class="line">			d-&gt;<span class="built_in">setState</span>(CallSession::State::Error, <span class="string">&quot;Call failed&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">linphone_call_log_set_call_id</span>(d-&gt;log, d-&gt;op-&gt;<span class="built_in">getCallId</span>().<span class="built_in">c_str</span>()); <span class="comment">/* Must be known at that time */</span></span><br><span class="line">		d-&gt;<span class="built_in">setState</span>(CallSession::State::OutgoingProgress, <span class="string">&quot;Outgoing call in progress&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CallSession::startInvite</code>æ–¹æ³•åŸå‹ä¸ºï¼Œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">startInvite</span> <span class="params">(<span class="type">const</span> Address *destination, <span class="type">const</span> std::string &amp;subject = <span class="string">&quot;&quot;</span>, <span class="type">const</span> Content *content = <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸ª<code>virtual</code>è™šå‡½æ•°ï¼Œè¯´æ˜æœ‰å‡½æ•°å¤å†™ï¼Œåœ¨IDEä¸­æœç´¢å‘ç°<code>MediaSession</code>ç±»ç»§æ‰¿è‡ª<code>CallSession</code>ï¼Œå¥½çš„ï¼Œæ‰¾åˆ°<code>MediaSession</code>å¤å†™çš„<code>startInvite</code>æ–¹æ³•ï¼Œæ–¹æ³•è¾ƒé•¿ï¼Œåˆ é™¤ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MediaSession::startInvite</span> <span class="params">(<span class="type">const</span> Address *destination, <span class="type">const</span> string &amp;subject, <span class="type">const</span> Content *content)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">L_D</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆ é™¤ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">	d-&gt;op-&gt;<span class="built_in">setLocalMediaDescription</span>(d-&gt;localDesc);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> result = CallSession::<span class="built_in">startInvite</span>(destination, subject, content);</span><br><span class="line">	<span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (d-&gt;state == CallSession::State::Error)</span><br><span class="line">			d-&gt;<span class="built_in">stopStreams</span>();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>MediaSession::startInvite</code>ä¸­è°ƒç”¨<code>setLocalMediaDescription</code>æ–¹æ³•ç»„è£…æœ¬åœ°åª’ä½“æè¿°ä¿¡æ¯ï¼Œæœ€åå†è°ƒç”¨çˆ¶ç±»çš„<code>CallSession::startInvite</code>æ–¹æ³•ç»§ç»­å‘èµ·å‘¼å«ï¼Œå¥½çš„ï¼Œç°åœ¨åªå…³å¿ƒ<code>setLocalMediaDescription</code>æ–¹æ³•ï¼Œå…¶ä¸­<code>op</code>æ˜¯<code>SalCallOp</code>ï¼Œåœ¨IDEä¸­æ‰“å¼€<code>call-op.cpp</code>ï¼Œæ‰¾åˆ°<code>setLocalMediaDescription</code>æ–¹æ³•ï¼Œåˆ å‡ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">SalCallOp::setLocalMediaDescription</span> <span class="params">(SalMediaDescription *desc)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (desc) &#123;</span><br><span class="line">		<span class="built_in">sal_media_description_ref</span>(desc);</span><br><span class="line">		belle_sip_error_code error;</span><br><span class="line">		<span class="type">belle_sdp_session_description_t</span> *sdp = <span class="built_in">media_description_to_sdp</span>(desc);</span><br><span class="line">		vector&lt;<span class="type">char</span>&gt; buffer = <span class="built_in">marshalMediaDescription</span>(sdp, error);</span><br><span class="line">		<span class="built_in">belle_sip_object_unref</span>(sdp);</span><br><span class="line">		<span class="keyword">if</span> (error != BELLE_SIP_OK)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		mLocalBody.<span class="built_in">setContentType</span>(ContentType::Sdp);</span><br><span class="line">		mLocalBody.<span class="built_in">setBody</span>(<span class="built_in">move</span>(buffer));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mLocalBody = <span class="built_in">Content</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œç»ˆäºå‘ç°ä¸SDPç›¸å…³çš„æ–¹æ³•äº†<code>media_description_to_sdp</code>ï¼Œç»§ç»­æŸ¥çœ‹<code>media_description_to_sdp</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä½äº<code>sal_sdp.c</code>ä¸­ï¼Œæ–¹æ³•è¾ƒé•¿ï¼Œä¸»è¦æ˜¯ç»„è£…SDPåè®®æ•°æ®ï¼Œæ¯”å¦‚è®¾ç½®ç‰ˆæœ¬ã€åˆ›å»ºæºä¿¡æ¯ï¼Œåˆ›å»ºä¼šè¯ç­‰ï¼Œè¿™é‡Œåˆ å‡ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">belle_sdp_session_description_t</span> * <span class="title">media_description_to_sdp</span><span class="params">(<span class="type">const</span> SalMediaDescription *desc)</span> </span>&#123;</span><br><span class="line">	<span class="type">belle_sdp_session_description_t</span>* session_desc=<span class="built_in">belle_sdp_session_description_new</span>();</span><br><span class="line">	<span class="type">bool_t</span> inet6;</span><br><span class="line">	<span class="type">belle_sdp_origin_t</span>* origin;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">char</span> *escaped_username = <span class="built_in">belle_sip_uri_to_escaped_username</span>(desc-&gt;username);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( <span class="built_in">strchr</span> ( desc-&gt;addr,<span class="string">&#x27;:&#x27;</span> ) !=<span class="literal">NULL</span> ) &#123;</span><br><span class="line">		inet6=<span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> inet6=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">belle_sdp_session_description_set_version</span> ( session_desc,<span class="built_in">belle_sdp_version_create</span> ( <span class="number">0</span> ) );</span><br><span class="line"></span><br><span class="line">	origin = <span class="built_in">belle_sdp_origin_create</span> ( escaped_username</span><br><span class="line">									  ,desc-&gt;session_id</span><br><span class="line">									  ,desc-&gt;session_ver</span><br><span class="line">									  ,<span class="string">&quot;IN&quot;</span></span><br><span class="line">									  , inet6 ? <span class="string">&quot;IP6&quot;</span> :<span class="string">&quot;IP4&quot;</span></span><br><span class="line">									  ,desc-&gt;addr );</span><br><span class="line">	<span class="built_in">bctbx_free</span>(escaped_username);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">belle_sdp_session_description_set_origin</span> ( session_desc,origin );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">belle_sdp_session_description_set_session_name</span> ( session_desc,</span><br><span class="line">		<span class="built_in">belle_sdp_session_name_create</span> ( desc-&gt;name[<span class="number">0</span>]!=<span class="string">&#x27;\0&#x27;</span> ? desc-&gt;name : <span class="string">&quot;Talk&quot;</span> ) );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( i=<span class="number">0</span>; i&lt;desc-&gt;nb_streams; i++ ) &#123;</span><br><span class="line">		<span class="built_in">stream_description_to_sdp</span>(session_desc, desc, &amp;desc-&gt;streams[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> session_desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æ<code>media_description_to_sdp</code>æ–¹æ³•æ‰¾åˆ°åœ¨<code>stream_description_to_sdp</code>æ–¹æ³•ä¸­ç»„è£…æ•°æ®æµä¿¡æ¯åˆ°SDPåè®®ä¸­ï¼Œ<code>stream_description_to_sdp</code>æ–¹æ³•éå¸¸é•¿ï¼Œæ­¤æ–¹æ³•ä¸»è¦æ˜¯ç»„è£…SDPåè®®ä¸­ç¼–è§£ç ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™é‡Œåˆ é™¤å¤§éƒ¨åˆ†ä¸å…³å¿ƒçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">stream_description_to_sdp</span> <span class="params">( <span class="type">belle_sdp_session_description_t</span> *session_desc, <span class="type">const</span> SalMediaDescription *md, <span class="type">const</span> SalStreamDescription *stream )</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">	media_desc = <span class="built_in">belle_sdp_media_description_create</span> ( <span class="built_in">sal_stream_description_get_type_as_string</span>(stream)</span><br><span class="line">				 ,stream-&gt;rtp_port</span><br><span class="line">				 ,<span class="number">1</span></span><br><span class="line">				 ,<span class="built_in">sal_media_proto_to_string</span> ( stream-&gt;proto )</span><br><span class="line">				 ,<span class="literal">NULL</span> );</span><br><span class="line">    <span class="comment">// çœ‹åˆ°payloadså­—æ®µ</span></span><br><span class="line">	<span class="keyword">if</span> (stream-&gt;payloads) &#123;</span><br><span class="line">		<span class="keyword">for</span> ( pt_it=stream-&gt;payloads; pt_it!=<span class="literal">NULL</span>; pt_it=pt_it-&gt;next ) &#123;</span><br><span class="line">			pt= ( PayloadType* ) pt_it-&gt;data;</span><br><span class="line">			mime_param= <span class="built_in">belle_sdp_mime_parameter_create</span> ( pt-&gt;mime_type</span><br><span class="line">					, <span class="built_in">payload_type_get_number</span> ( pt )</span><br><span class="line">					, pt-&gt;clock_rate</span><br><span class="line">					, pt-&gt;channels&gt;<span class="number">0</span> ? pt-&gt;channels : <span class="number">-1</span> );</span><br><span class="line">			<span class="built_in">belle_sdp_mime_parameter_set_parameters</span> ( mime_param,pt-&gt;recv_fmtp );</span><br><span class="line">			<span class="keyword">if</span> ( stream-&gt;ptime&gt;<span class="number">0</span> ) &#123;</span><br><span class="line">				<span class="built_in">belle_sdp_mime_parameter_set_ptime</span> ( mime_param,stream-&gt;ptime );</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// é”å®šæ­¤æ–¹æ³•</span></span><br><span class="line">			<span class="built_in">belle_sdp_media_description_append_values_from_mime_parameter</span> ( media_desc,mime_param );</span><br><span class="line">			<span class="built_in">belle_sip_object_unref</span> ( mime_param );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* to comply with SDP we cannot have an empty payload type number list */</span></span><br><span class="line">		<span class="comment">/* as it happens only when mline is declined with a zero port, it does not matter to put whatever codec*/</span></span><br><span class="line">		<span class="type">belle_sip_list_t</span>* format = <span class="built_in">belle_sip_list_append</span>(<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">		<span class="built_in">belle_sdp_media_set_media_formats</span>(<span class="built_in">belle_sdp_media_description_get_media</span>(media_desc),format);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»„è£…è‡ªå®šä¹‰sdpå±æ€§</span></span><br><span class="line">	<span class="keyword">if</span> (stream-&gt;custom_sdp_attributes) &#123;</span><br><span class="line">		<span class="type">belle_sdp_session_description_t</span> *custom_desc = (<span class="type">belle_sdp_session_description_t</span> *)stream-&gt;custom_sdp_attributes;</span><br><span class="line">		<span class="type">belle_sip_list_t</span> *l = <span class="built_in">belle_sdp_session_description_get_attributes</span>(custom_desc);</span><br><span class="line">		<span class="type">belle_sip_list_t</span> *elem;</span><br><span class="line">		<span class="keyword">for</span> (elem = l; elem != <span class="literal">NULL</span>; elem = elem-&gt;next) &#123;</span><br><span class="line">			<span class="built_in">belle_sdp_media_description_add_attribute</span>(media_desc, (<span class="type">belle_sdp_attribute_t</span> *)elem-&gt;data);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ å‡ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>stream_description_to_sdp</code>æ–¹æ³•ä¸­çœ‹åˆ°<code>payload</code>å­—æ®µï¼Œé©¬ä¸Šå°±è¦æ‰¾åˆ°äº†happy~</p>
<p>ç»è¿‡åˆ†æï¼Œé”å®š<code>belle_sdp_media_description_append_values_from_mime_parameter</code>æ–¹æ³•ï¼Œåˆ†ææ­¤æ–¹æ³•ï¼Œåœ¨å…¶ä¸­æ‰¾åˆ°ç»„è£…<code>rtpmap</code>çš„æºç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">belle_sdp_media_description_append_values_from_mime_parameter</span><span class="params">(<span class="type">belle_sdp_media_description_t</span>* media_description, <span class="type">const</span> <span class="type">belle_sdp_mime_parameter_t</span>* mime_parameter)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BELLE_SDP_FORCE_RTP_MAP <span class="comment">/* defined to for RTP map even for static codec*/</span></span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">mime_parameter_is_static</span>(mime_parameter)) &#123;</span><br><span class="line">		<span class="comment">/*dynamic payload*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">belle_sdp_mime_parameter_get_channel_count</span>(mime_parameter)&gt;<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">snprintf</span>(atribute_value,MAX_FMTP_LENGTH,<span class="string">&quot;%i %s/%i/%i&quot;</span></span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_media_format</span>(mime_parameter)</span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_type</span>(mime_parameter)</span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_rate</span>(mime_parameter)</span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_channel_count</span>(mime_parameter));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">snprintf</span>(atribute_value,MAX_FMTP_LENGTH,<span class="string">&quot;%i %s/%i&quot;</span></span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_media_format</span>(mime_parameter)</span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_type</span>(mime_parameter)</span><br><span class="line">					,<span class="built_in">belle_sdp_mime_parameter_get_rate</span>(mime_parameter));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">belle_sdp_media_description_set_attribute_value</span>(media_description,<span class="string">&quot;rtpmap&quot;</span>,atribute_value);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BELLE_SDP_FORCE_RTP_MAP</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// always include fmtp parameters if available</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">belle_sdp_mime_parameter_get_parameters</span>(mime_parameter)) &#123;</span><br><span class="line">		<span class="built_in">snprintf</span>(atribute_value,MAX_FMTP_LENGTH,<span class="string">&quot;%i %s&quot;</span></span><br><span class="line">				,<span class="built_in">belle_sdp_mime_parameter_get_media_format</span>(mime_parameter)</span><br><span class="line">				,<span class="built_in">belle_sdp_mime_parameter_get_parameters</span>(mime_parameter));</span><br><span class="line">		<span class="built_in">belle_sdp_media_description_set_attribute_value</span>(media_description,<span class="string">&quot;fmtp&quot;</span>,atribute_value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…ˆåˆ†æä¸‹<code>mime_parameter_is_static</code>æ–¹æ³•æ˜¯å¹²ä»€ä¹ˆçš„ï¼ŸæŸ¥çœ‹ä»¥ä¸‹æºç å‘ç°ï¼Œå™¢~~ï¼ŒåŸæ¥æ˜¯ç”¨äºåˆ¤æ–­ç¼–è§£ç æ˜¯å¦æ˜¯é™æ€ç±»å‹(å‰é¢æåˆ°çš„Payload Type)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">static_payload</span> static_payload_list [] =&#123;</span><br><span class="line">	<span class="comment">/*audio*/</span></span><br><span class="line">	&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="string">&quot;PCMU&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">3</span>,<span class="number">1</span>,<span class="string">&quot;GSM&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">4</span>,<span class="number">1</span>,<span class="string">&quot;G723&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">5</span>,<span class="number">1</span>,<span class="string">&quot;DVI4&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">6</span>,<span class="number">1</span>,<span class="string">&quot;DVI4&quot;</span>,<span class="number">16000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">7</span>,<span class="number">1</span>,<span class="string">&quot;LPC&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">8</span>,<span class="number">1</span>,<span class="string">&quot;PCMA&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">9</span>,<span class="number">1</span>,<span class="string">&quot;G722&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">10</span>,<span class="number">2</span>,<span class="string">&quot;L16&quot;</span>,<span class="number">44100</span>&#125;,</span><br><span class="line">	&#123;<span class="number">11</span>,<span class="number">1</span>,<span class="string">&quot;L16&quot;</span>,<span class="number">44100</span>&#125;,</span><br><span class="line">	&#123;<span class="number">12</span>,<span class="number">1</span>,<span class="string">&quot;QCELP&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">13</span>,<span class="number">1</span>,<span class="string">&quot;CN&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">14</span>,<span class="number">1</span>,<span class="string">&quot;MPA&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">15</span>,<span class="number">1</span>,<span class="string">&quot;G728&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">16</span>,<span class="number">1</span>,<span class="string">&quot;DVI4&quot;</span>,<span class="number">11025</span>&#125;,</span><br><span class="line">	&#123;<span class="number">17</span>,<span class="number">1</span>,<span class="string">&quot;DVI4&quot;</span>,<span class="number">22050</span>&#125;,</span><br><span class="line">	&#123;<span class="number">18</span>,<span class="number">1</span>,<span class="string">&quot;G729&quot;</span>,<span class="number">8000</span>&#125;,</span><br><span class="line">	<span class="comment">/*video*/</span></span><br><span class="line">	&#123;<span class="number">25</span>,<span class="number">0</span>,<span class="string">&quot;CelB&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">26</span>,<span class="number">0</span>,<span class="string">&quot;JPEG&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">28</span>,<span class="number">0</span>,<span class="string">&quot;nv&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">31</span>,<span class="number">0</span>,<span class="string">&quot;H261&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">32</span>,<span class="number">0</span>,<span class="string">&quot;MPV&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">33</span>,<span class="number">0</span>,<span class="string">&quot;MP2T&quot;</span>,<span class="number">90000</span>&#125;,</span><br><span class="line">	&#123;<span class="number">34</span>,<span class="number">0</span>,<span class="string">&quot;H263&quot;</span>,<span class="number">90000</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">mime_parameter_is_static</span><span class="params">(<span class="type">const</span> <span class="type">belle_sdp_mime_parameter_t</span> *param)</span></span>&#123;</span><br><span class="line">	<span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">static_payload</span>* iterator;</span><br><span class="line">	<span class="type">size_t</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (iterator = static_payload_list,i=<span class="number">0</span>;i&lt;payload_list_elements;i++,iterator++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (iterator-&gt;number == param-&gt;media_format &amp;&amp;</span><br><span class="line">			<span class="built_in">strcasecmp</span>(iterator-&gt;type,param-&gt;type)==<span class="number">0</span> &amp;&amp;</span><br><span class="line">			iterator-&gt;channel_count==param-&gt;channel_count &amp;&amp;</span><br><span class="line">			iterator-&gt;rate==param-&gt;rate ) &#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å†æ¥åˆ†æä¸‹<code>belle_sdp_media_description_append_values_from_mime_parameter</code>æ–¹æ³•çš„æ„æ€ï¼Œå¤§æ„å¦‚ä¸‹ï¼šå¦‚æœæ²¡æœ‰å®šä¹‰<code>BELLE_SDP_FORCE_RTP_MAP</code>è¿™ä¸ªå®å°±æ‰§è¡Œ<code>if (!mime_parameter_is_static(mime_parameter))</code>åˆ¤æ–­ç¼–è§£ç æ˜¯å¦æ˜¯é™æ€ç±»å‹ï¼Œå¦‚æœå®šä¹‰äº†å°±ä¸åˆ¤æ–­æ˜¯å¦æ˜¯é™æ€ç±»å‹</p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯å¦‚æœæ²¡æœ‰å®šä¹‰<code>BELLE_SDP_FORCE_RTP_MAP</code>è¿™ä¸ªå®ï¼Œå°±ä¸ç»„è£…é™æ€ç±»å‹ç¼–è§£ç çš„<code>rtpmap</code>ä¿¡æ¯ï¼Œåªç»„è£…åŠ¨æ€ç±»å‹ç¼–è§£ç çš„<code>rtpmap</code>ä¿¡æ¯ï¼Œç»ˆäºæ‰¾åˆ°æºå¤´äº†ï¼ŒçœŸæ˜¯æ‹¨äº‘è§æ—¥å‘€</p>
<p>åˆ°è¿™é‡Œè¿˜æ²¡å®Œï¼Œæ—¢ç„¶æ˜¯æ ¹æ®å®å®šä¹‰åšçš„åˆ¤æ–­ï¼Œè‚¯å®šåœ¨ç¼–è¯‘çš„æ—¶å€™å¯ä»¥é…ç½®ï¼Œå…ˆçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°å®šä¹‰å®çš„åœ°æ–¹ï¼Œåœ¨IDEä¸­å…¨å±€æœç´¢ï¼Œåœ¨<code>belle-sip</code>ä¸‹çš„<code>CMakeList.txt</code>ä¸­å‘ç°</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">option</span>(ENABLE_RTP_MAP_ALWAYS_IN_SDP <span class="string">&quot;Always include rtpmap in SDP.&quot;</span> <span class="keyword">OFF</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ENABLE_RTP_MAP_ALWAYS_IN_SDP) </span><br><span class="line">	<span class="keyword">set</span>(BELLE_SDP_FORCE_RTP_MAP <span class="number">1</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>bingo~ï¼ŒçœŸçš„æ˜¯åˆ°æœ€åäº†</p>
<p>æœ€ååœ¨ç¼–è¯‘æ—¶å¢åŠ ç¼–è¯‘é…ç½®é¡¹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> linphone-sdk/build/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake -DENABLE_RTP_MAP_ALWAYS_IN_SDP=ON ..</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake --build . --parallel 8</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–è¯‘åæ‹·è´åˆ°ASä¸­è¿è¡Œï¼Œå‘èµ·å‘¼å«æŸ¥çœ‹Logcatè¾“å‡º</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>åœ¨æºç ä¸­çœ‹åˆ°é€šè¿‡<code>BELLE_SDP_FORCE_RTP_MAP</code>è¿™ä¸ªå®æ§åˆ¶æ˜¯å¦åœ¨SDPä¸­åŒ…å«é™æ€ç±»å‹ç¼–è§£ç çš„<code>rtpmap</code>ä¿¡æ¯ï¼Œä¸ªäººçŒœæµ‹æ˜¯é™æ€ç±»å‹çš„ç¼–è§£ç ä¿¡æ¯ï¼Œæ˜¯åè®®ä¸­å›ºå®šçš„ï¼Œä»»ä½•éµå¾ªåè®®çš„å®ç°æ–¹ï¼Œéƒ½å¯ä»¥æ ¹æ®é™æ€ç±»å‹ç¼–è§£ç å¯¹åº”çš„<code>code</code>è§£æå‡ºç›¸åº”çš„<code>rtpmap</code>ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨SDPä¸­å»æ‰é™æ€ç±»å‹ç¼–è§£ç å™¨çš„<code>rtpmap</code>ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å‡å°‘å‘é€æ•°æ®åŒ…çš„å¤§å°ï¼Œå‡è½»ç½‘ç»œå‹åŠ›</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®æ”¹linphone-sdk-android-ç¬¬äºŒç¯‡</title>
    <url>/2022/04/24/linphone-sdk-android/%E4%BF%AE%E6%94%B9linphone-sdk-android-%E7%AC%AC%E4%BA%8C%E7%AF%87/</url>
    <content><![CDATA[<h1 id="ä¿®æ”¹linphone-sdk-android-ä¸­ç¯‡"><a class="markdownIt-Anchor" href="#ä¿®æ”¹linphone-sdk-android-ä¸­ç¯‡"></a> ä¿®æ”¹linphone-sdk-android-ä¸­ç¯‡</h1>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>æ¥ä¸Šç¯‡<a href="https://juejin.cn/post/7089664949907095559">ä¿®æ”¹linphone-sdk-android-ä¸Šç¯‡</a></p>
<p>æœ¬æ–‡æ˜¯ä¸­ç¯‡ï¼Œæœ¬ç¯‡è®°å½•é—®é¢˜2çš„åç»­æ’æŸ¥è¿‡ç¨‹åŠä¿®å¤æ–¹æ¡ˆï¼Œå°½é‡æè¿°æ’æŸ¥é—®é¢˜è¿‡ç¨‹ä¸­çš„æ€è·¯ä¸æ–¹å‘</p>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<p>ä¸Šç¯‡è¯´åˆ°å¢åŠ æ—¥å¿—ï¼Œç¼–è¯‘åæ”¾åˆ°ASä¸­è¿è¡Œï¼ŒæŸ¥çœ‹Logcatè¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// upä¸ä¸ºNULL</span><br><span class="line">2022-04-24 18:10:36.969 4002-4018/com.guodong.android.linphone D/guodongAndroid: up = 0x100433</span><br><span class="line">2022-04-24 18:10:36.969 4002-4018/com.guodong.android.linphone D/guodongAndroid: up_available1 = 0</span><br><span class="line">2022-04-24 18:10:36.969 4002-4018/com.guodong.android.linphone D/guodongAndroid: up_available2 = 0</span><br><span class="line"></span><br><span class="line">// upä¸ºNULL</span><br><span class="line">2022-04-24 18:10:39.669 4002-4018/com.guodong.android.linphone D/guodongAndroid: up = 0x0</span><br><span class="line">2022-04-24 18:10:39.669 4002-4018/com.guodong.android.linphone D/guodongAndroid: up_available1 = 1</span><br><span class="line">2022-04-24 18:10:39.669 4002-4018/com.guodong.android.linphone D/guodongAndroid: up_available2 = 1</span><br></pre></td></tr></table></figure>
<p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºï¼Œæœ‰æ—¶<code>up</code>æ˜¯<code>NULL</code>çš„ï¼ŒçŒœæƒ³æœ‰é”€æ¯çš„æ–¹æ³•ï¼Œå†æ¬¡æŸ¥çœ‹<code>linphone_jni.cc</code>ï¼Œå‘ç°æœ‰ä¸€ä¸ª<code>unref</code>æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jboolean JNICALL <span class="title">Java_org_linphone_core_LoggingServiceImpl_unref</span><span class="params">(JNIEnv* env, jobject thiz, jlong ptr)</span> </span>&#123;</span><br><span class="line">	LinphoneLoggingService *cptr = (LinphoneLoggingService*)ptr;</span><br><span class="line">	<span class="keyword">if</span> (cptr == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">bctbx_error</span>(<span class="string">&quot;Java_org_linphone_core_LoggingServiceImpl_unref&#x27;s LinphoneLoggingService C ptr is null!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jobject wref = (jobject)<span class="built_in">belle_sip_object_data_get</span>((<span class="type">belle_sip_object_t</span> *)cptr, belle_sip_java_user_data_key);</span><br><span class="line">	<span class="built_in">belle_sip_object_data_set</span>((<span class="type">belle_sip_object_t</span> *)cptr, belle_sip_java_user_data_key, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">if</span> (wref) &#123;</span><br><span class="line">		env-&gt;<span class="built_in">DeleteWeakGlobalRef</span>(wref);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">belle_sip_object_unref_2</span>(cptr) == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å—¯ï¼Œçœ‹æ¥è¿™ä¸ªå°±æ˜¯é”€æ¯æ–¹æ³•äº†ï¼Œé€šè¿‡<code>belle_sip_object_data_get</code>æ–¹æ³•å–å‡ºå€¼ï¼Œå†é€šè¿‡<code>belle_sip_object_data_set</code>æ–¹æ³•è®¾ç½®ä¸º<code>nullptr</code>ï¼Œç„¶ååˆ é™¤å…¨å±€å¼±å¼•ç”¨</p>
<p>è¿™ä¸ªæ–¹æ³•ä¹ŸåŠ ç‚¹æ—¥å¿—è¾“å‡ºå§ï¼Œæ‰“å¼€<code>jni.mustache</code>ï¼Œæ‰¾åˆ°æ¨¡æ¿æ–¹æ³•ï¼Œæ·»åŠ æ—¥å¿—è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">JNIEXPORT jboolean JNICALL Java_&#123;&#123;jniPrefix&#125;&#125;&#123;&#123;classImplName&#125;&#125;_unref(JNIEnv* env, jobject thiz, jlong ptr) &#123;</span><br><span class="line">	&#123;&#123;classCName&#125;&#125; *cptr = (&#123;&#123;classCName&#125;&#125;*)ptr;</span><br><span class="line">	if (cptr == 0) &#123;</span><br><span class="line">		bctbx_error(&quot;Java_&#123;&#123;jniPrefix&#125;&#125;&#123;&#123;classImplName&#125;&#125;_unref&#x27;s &#123;&#123;classCName&#125;&#125; C ptr is null!&quot;);</span><br><span class="line">		return TRUE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jobject wref = (jobject)belle_sip_object_data_get((belle_sip_object_t *)cptr, belle_sip_java_user_data_key);</span><br><span class="line"></span><br><span class="line">	// begin - added</span><br><span class="line">	&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">    #ifdef __ANDROID__</span><br><span class="line">    __android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;unref wref = %p&quot;, wref);</span><br><span class="line">    #endif /* __ANDROID__ */</span><br><span class="line">    &#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line">  	// end - added</span><br><span class="line"></span><br><span class="line">	belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, nullptr, nullptr);</span><br><span class="line">	if (wref) &#123;</span><br><span class="line">		env-&gt;DeleteWeakGlobalRef(wref);</span><br><span class="line">	&#125;</span><br><span class="line">	&#123;&#123;#refCountable&#125;&#125;return belle_sip_object_unref_2(cptr) == 1;&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">	&#123;&#123;#notRefCountable&#125;&#125;return FALSE;&#123;&#123;/notRefCountable&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–è¯‘åæ”¾åˆ°ASä¸­è¿è¡Œï¼ŒæŸ¥çœ‹Logcatè¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2022-04-24 18:18:52.359 4240-4249/com.guodong.android.linphone D/guodongAndroid: unref wref = 0x1002e3</span><br><span class="line">2022-04-24 18:19:02.296 4240-4257/com.guodong.android.linphone D/guodongAndroid: up = 0x0</span><br><span class="line">2022-04-24 18:19:02.296 4240-4257/com.guodong.android.linphone D/guodongAndroid: up_available1 = 1</span><br><span class="line">2022-04-24 18:19:02.296 4240-4257/com.guodong.android.linphone D/guodongAndroid: up_available2 = 1</span><br></pre></td></tr></table></figure>
<p>ä»æ—¥å¿—ä¸­å¯ä»¥åˆ†æå‡ºä¸¤ç‚¹ï¼š</p>
<ol>
<li>çš„ç¡®æœ‰é”€æ¯çš„æ–¹æ³•è¢«è°ƒç”¨</li>
<li>è°ƒç”¨<code>unref</code>æ–¹æ³•çš„çº¿ç¨‹ä¸è°ƒç”¨<code>getLoggingService</code>æ–¹æ³•çš„çº¿ç¨‹ä¸åŒ</li>
</ol>
<p>ç»“åˆä»¥ä¸Šä¸¤ç‚¹ï¼Œå¤§èƒ†çš„çŒœæµ‹é—®é¢˜å‡ºåœ¨å¤šçº¿ç¨‹ä¸Šï¼Œåœ¨å¤šçº¿ç¨‹ä¸Šæ­¤é—®é¢˜æ˜¯å¶ç°çš„å°±ä¸å¥‡æ€ªäº†</p>
<p>å‡ºé—®é¢˜æ—¶ï¼Œæ—¥å¿—è¾“å‡ºå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2022-04-24 18:25:02.296 4240-4257/com.guodong.android.linphone D/guodongAndroid: up = 0x20004f</span><br><span class="line">2022-04-24 18:25:02.296 4240-4257/com.guodong.android.linphone D/guodongAndroid: up_available1 = 1</span><br><span class="line">2022-04-24 18:25:02.296 4240-4249/com.guodong.android.linphone D/guodongAndroid: unref wref = 0x1002e3</span><br><span class="line">App Crash</span><br></pre></td></tr></table></figure>
<p>å¤šçº¿ç¨‹é—®é¢˜ï¼Œç¬¬ä¸€æƒ³æ³•æ˜¯é€šè¿‡åŠ é”ï¼Œä¿è¯ä»£ç é—´è°ƒç”¨çš„äº’æ–¥æ€§</p>
<p>å†æ¬¡æ‰“å¼€<code>jni.mustache</code>ï¼Œæ·»åŠ äº’æ–¥é”ç›¸å…³ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Added by guodongAndroid on 2022/04/22</span><br><span class="line">#ifdef __ANDROID__</span><br><span class="line">static pthread_mutex_t mutex;</span><br><span class="line">#endif /* __ANDROID__ */</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *ajvm, void *reserved) &#123;</span><br><span class="line">#ifdef __ANDROID__</span><br><span class="line">	ms_set_jvm(ajvm);</span><br><span class="line">	int result = pthread_mutex_init(&amp;mutex, NULL);</span><br><span class="line">	__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;JNI_OnLoad, mutex init result = %d&quot;, result);</span><br><span class="line">#endif /* __ANDROID__ */</span><br><span class="line">	jvm = ajvm;</span><br><span class="line">	return JNI_VERSION_1_2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Added by guodongAndroid on 2022/04/22</span><br><span class="line">JNIEXPORT void JNI_OnUnload(JavaVM *ajvm, void *reserved) &#123;</span><br><span class="line">#ifdef __ANDROID__</span><br><span class="line">	int result = pthread_mutex_destroy(&amp;mutex);</span><br><span class="line">	__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;JNI_OnUnload, mutex destroy result = %d&quot;, result);</span><br><span class="line">#endif /* __ANDROID__ */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;#objects&#125;&#125;</span><br><span class="line">JNIEXPORT jobject JNICALL get&#123;&#123;className&#125;&#125;(JNIEnv *env, &#123;&#123;classCName&#125;&#125; *cptr, bool_t takeref) &#123;</span><br><span class="line">	jobject jobj = nullptr;</span><br><span class="line"></span><br><span class="line">	if (cptr != nullptr) &#123;</span><br><span class="line">		// begin add</span><br><span class="line">		&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">		#ifdef __ANDROID__</span><br><span class="line">		pthread_mutex_lock(&amp;mutex);</span><br><span class="line">		#endif /* __ANDROID__ */</span><br><span class="line">		&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line">		// end add</span><br><span class="line">		</span><br><span class="line">		void *up = belle_sip_object_data_get((belle_sip_object_t *)cptr, belle_sip_java_user_data_key);</span><br><span class="line">		LinphoneJavaBindings *ljb = (LinphoneJavaBindings *)linphone_factory_get_user_data(linphone_factory_get());</span><br><span class="line">		if (!ljb) &#123;</span><br><span class="line">			ljb = new LinphoneJavaBindings(env);</span><br><span class="line">			linphone_factory_set_user_data(linphone_factory_get(), ljb);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		jclass &#123;&#123;cPrefix&#125;&#125;_class = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class;</span><br><span class="line">		jmethodID &#123;&#123;cPrefix&#125;&#125;_constructor = ljb-&gt;&#123;&#123;cPrefix&#125;&#125;_class_constructor;</span><br><span class="line"></span><br><span class="line">		&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">		#ifdef __ANDROID__</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up = %p&quot;, up);</span><br><span class="line">		</span><br><span class="line">		jobject temp_jobj1 = (jobject)up;</span><br><span class="line">		jboolean up_available1 = env-&gt;IsSameObject(temp_jobj1, NULL);</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up_available1 = %d&quot;, up_available1);</span><br><span class="line">		</span><br><span class="line">		jobject temp_jobj2 = (jobject)up;</span><br><span class="line">		jboolean up_available2 = env-&gt;IsSameObject(temp_jobj2, nullptr);</span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;up_available2 = %d&quot;, up_available2);</span><br><span class="line">		#endif /* __ANDROID__ */</span><br><span class="line">		&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line"></span><br><span class="line">		if (up == nullptr) &#123;</span><br><span class="line">			jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">			belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">			if (takeref)</span><br><span class="line">				&#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			jobj = env-&gt;NewLocalRef((jobject)up);</span><br><span class="line">			if (jobj == nullptr) &#123;</span><br><span class="line">				// Delete weak ref ?</span><br><span class="line">				env-&gt;DeleteWeakGlobalRef((jobject)up);</span><br><span class="line">				// takes implicit local ref</span><br><span class="line">				jobj = env-&gt;NewObject(&#123;&#123;cPrefix&#125;&#125;_class, &#123;&#123;cPrefix&#125;&#125;_constructor, (jlong)cptr);</span><br><span class="line">				belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, (void*)env-&gt;NewWeakGlobalRef(jobj), nullptr);</span><br><span class="line">				if (takeref)</span><br><span class="line">					&#123;&#123;#refCountable&#125;&#125;&#123;&#123;cPrefix&#125;&#125;_ref(cptr);&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		// begin add</span><br><span class="line">		&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">		pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">		&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line">		// end add</span><br><span class="line">	&#125;</span><br><span class="line">	return jobj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jboolean JNICALL Java_&#123;&#123;jniPrefix&#125;&#125;&#123;&#123;classImplName&#125;&#125;_unref(JNIEnv* env, jobject thiz, jlong ptr) &#123;</span><br><span class="line">	&#123;&#123;classCName&#125;&#125; *cptr = (&#123;&#123;classCName&#125;&#125;*)ptr;</span><br><span class="line">	if (cptr == 0) &#123;</span><br><span class="line">		bctbx_error(&quot;Java_&#123;&#123;jniPrefix&#125;&#125;&#123;&#123;classImplName&#125;&#125;_unref&#x27;s &#123;&#123;classCName&#125;&#125; C ptr is null!&quot;);</span><br><span class="line">		return TRUE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// begin add</span><br><span class="line">	&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">	#ifdef __ANDROID__</span><br><span class="line">	pthread_mutex_lock(&amp;mutex);</span><br><span class="line">	#endif /* __ANDROID__ */</span><br><span class="line">	&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line">	// end add</span><br><span class="line">	</span><br><span class="line">	jobject wref = (jobject)belle_sip_object_data_get((belle_sip_object_t *)cptr, belle_sip_java_user_data_key);</span><br><span class="line"></span><br><span class="line">	&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">    #ifdef __ANDROID__</span><br><span class="line">    __android_log_print(ANDROID_LOG_DEBUG, &quot;guodongAndroid&quot;, &quot;unref wref = %p&quot;, wref);</span><br><span class="line">    #endif /* __ANDROID__ */</span><br><span class="line">    &#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line"></span><br><span class="line">	belle_sip_object_data_set((belle_sip_object_t *)cptr, belle_sip_java_user_data_key, nullptr, nullptr);</span><br><span class="line">	if (wref) &#123;</span><br><span class="line">		env-&gt;DeleteWeakGlobalRef(wref);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	// begin add</span><br><span class="line">	&#123;&#123;#isLoggingService&#125;&#125;</span><br><span class="line">	pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">	&#123;&#123;/isLoggingService&#125;&#125;</span><br><span class="line">	// end add</span><br><span class="line">	</span><br><span class="line">	&#123;&#123;#refCountable&#125;&#125;return belle_sip_object_unref_2(cptr) == 1;&#123;&#123;/refCountable&#125;&#125;</span><br><span class="line">	&#123;&#123;#notRefCountable&#125;&#125;return FALSE;&#123;&#123;/notRefCountable&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–è¯‘åæ‹·è´åˆ°ASä¸­è¿è¡Œï¼ŒæŒç»­è§‚å¯ŸLogcatåŠè¿è¡Œæƒ…å†µ</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®æ”¹linphone-sdk-android-ç¬¬å››ç¯‡</title>
    <url>/2022/04/27/linphone-sdk-android/%E4%BF%AE%E6%94%B9linphone-sdk-android-%E7%AC%AC%E5%9B%9B%E7%AF%87/</url>
    <content><![CDATA[<h1 id="ä¿®æ”¹linphone-sdk-android-ç¬¬å››ç¯‡"><a class="markdownIt-Anchor" href="#ä¿®æ”¹linphone-sdk-android-ç¬¬å››ç¯‡"></a> ä¿®æ”¹linphone-sdk-android-ç¬¬å››ç¯‡</h1>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>åœ¨ä½¿ç”¨linphone-sdk-androidè¿‡ç¨‹ä¸­ï¼Œå‘ç°å½“æœ‰ä¸€èµ·å‘¼å«åœ¨é€šè¯ä¸­æ—¶ï¼Œåˆæ”¶åˆ°ä¸€èµ·å‘¼å«ï¼Œä¼šè«åå…¶å¦™çš„æ’­æŠ¥æŒ¯é“ƒå£°éŸ³ï¼Œé—®é¢˜æ˜¯å·²ç»è°ƒç”¨linphone-sdk-androidæä¾›çš„æ¥å£å…³é—­äº†æŒ¯é“ƒå£°éŸ³</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…³é—­Ring</span></span><br><span class="line">mCore.setRing(<span class="literal">null</span>);</span><br><span class="line">mCore.setRingback(<span class="literal">null</span>);</span><br><span class="line">mCore.setRemoteRingbackTone(<span class="literal">null</span>);</span><br><span class="line">mCore.setNativeRingingEnabled(<span class="literal">false</span>);</span><br><span class="line">mCore.setRingDuringIncomingEarlyMedia(<span class="literal">false</span>);</span><br><span class="line">mCore.setVibrationOnIncomingCallEnabled(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­CallErrorTone</span></span><br><span class="line">Reason[] reasons = Reason.values();</span><br><span class="line"><span class="keyword">for</span> (Reason reason : reasons) &#123;</span><br><span class="line">    mCore.setCallErrorTone(reason, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­ToneId</span></span><br><span class="line">ToneID[] toneIds = ToneID.values();</span><br><span class="line"><span class="keyword">for</span> (ToneID toneId : toneIds) &#123;</span><br><span class="line">    mCore.setTone(toneId, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2>
<p>æŸ¥çœ‹Logcatè¾“å‡ºçš„æ—¥å¿—ï¼Œåˆ†æå‘ç°æœ‰<code>ToneManager</code>ã€<code>doStartRingtone</code>ç­‰å…³é”®è¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">13056-13056/com.guodong.android.linphone I/liblinphone: [ToneManager] [0x934e70ac] state changed : [None, LinphoneCallIncomingReceived]</span><br><span class="line">13056-13056/com.guodong.android.linphone I/liblinphone: [ToneManager] add new session [0x934e70ac]</span><br><span class="line">13056-13056/com.guodong.android.linphone I/liblinphone: [ToneManager] doStopToneToPlaySomethingElse</span><br><span class="line">13056-13056/com.guodong.android.linphone I/liblinphone: [ToneManager] doStartRingtone</span><br><span class="line">13056-13056/com.guodong.android.linphone I/liblinphone: [ToneManager] doStartNamedTone [2]</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€IDEå»æºç ä¸­æœç´¢ä¸€ç•ªï¼Œå‘ç°<code>tone-manager.cpp</code>ï¼Œåœ¨å…¶ä¸­æ‰¾åˆ°<code>doStopToneToPlaySomethingElse</code>ã€<code>doStartRingtone</code>ã€<code>doStartNamedTone</code>æ–¹æ³•ï¼Œä¸Logcatæ—¥å¿—è¾“å‡ºå»åˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::doStopToneToPlaySomethingElse</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">lInfo</span>() &lt;&lt; <span class="string">&quot;[ToneManager] &quot;</span> &lt;&lt; __func__;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">isAnotherSessionInState</span>(session, State::Tone)) &#123;</span><br><span class="line">		<span class="built_in">doStopTone</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::doStartRingtone</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">lInfo</span>() &lt;&lt; <span class="string">&quot;[ToneManager] &quot;</span> &lt;&lt; __func__;</span><br><span class="line">	LinphoneCore *lc = <span class="built_in">getCore</span>()-&gt;<span class="built_in">getCCore</span>();</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰ä¸€ä¸ªæ­£åœ¨é€šè¯çš„å‘¼å«å°±è°ƒç”¨`doStartNamedTone`</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">isAnotherSessionInState</span>(session, State::Call)) &#123;</span><br><span class="line">		<span class="comment">/* play a tone within the context of the current call */</span></span><br><span class="line">		<span class="built_in">doStartNamedTone</span>(session, LinphoneToneCallWaiting);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		MSSndCard *ringcard = lc-&gt;sound_conf.lsd_card ? lc-&gt;sound_conf.lsd_card : lc-&gt;sound_conf.ring_sndcard;</span><br><span class="line">		<span class="keyword">if</span> (ringcard &amp;&amp; !<span class="built_in">linphone_core_is_native_ringing_enabled</span>(lc)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">linphone_core_callkit_enabled</span>(lc))&#123;</span><br><span class="line">				<span class="built_in">ms_snd_card_set_stream_type</span>(ringcard, MS_SND_CARD_STREAM_RING);</span><br><span class="line">				<span class="built_in">linphone_ringtoneplayer_start</span>(lc-&gt;factory, lc-&gt;ringtoneplayer, ringcard, lc-&gt;sound_conf.local_ring, <span class="number">2000</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">ms_message</span>(<span class="string">&quot;Callkit is enabled, not playing ringtone.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::doStartNamedTone</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session, LinphoneToneID toneId)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">lInfo</span>() &lt;&lt; <span class="string">&quot;[ToneManager] &quot;</span> &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; [&quot;</span> &lt;&lt; Utils::<span class="built_in">toString</span>(toneId) &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	LinphoneToneDescription *tone = <span class="built_in">getToneFromId</span>(toneId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨Javaä¸­å·²å°†audiofileç½®ä¸º&quot;&quot;ï¼Œæ‰€ä»¥ä¼šèµ°elseåˆ†æ”¯</span></span><br><span class="line">	<span class="keyword">if</span> (tone &amp;&amp; tone-&gt;audiofile) &#123;</span><br><span class="line">		<span class="built_in">playFile</span>(tone-&gt;audiofile);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¤å¤„ç”ŸæˆæŒ¯é“ƒå£°éŸ³</span></span><br><span class="line">		MSDtmfGenCustomTone dtmfTone = <span class="built_in">generateToneFromId</span>(toneId);</span><br><span class="line">		<span class="built_in">playTone</span>(session, dtmfTone);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œç°åœ¨å…ˆæ‰¾åˆ°è°ƒç”¨<code>doStopToneToPlaySomethingElse</code>çš„æ–¹æ³•ï¼Œåœ¨IDEä¸­æŸ¥æ‰¾ï¼Œå‘ç°<code>startRingtone</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::printDebugInfo</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> callState = session-&gt;<span class="built_in">getState</span>();</span><br><span class="line">    <span class="keyword">auto</span> toneState = <span class="built_in">getState</span>(session);</span><br><span class="line">	<span class="built_in">lInfo</span>() &lt;&lt; <span class="string">&quot;[ToneManager] [&quot;</span> &lt;&lt; session &lt;&lt; <span class="string">&quot;] state changed : [&quot;</span> &lt;&lt; <span class="built_in">stateToString</span>(toneState)  &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; Utils::<span class="built_in">toString</span>(callState) &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::startRingtone</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printDebugInfo</span>(session); <span class="comment">// å¯¹åº”Logcatç¬¬ä¸€è¡Œè¾“å‡ºæ—¥å¿—</span></span><br><span class="line">	<span class="built_in">setState</span>(session, State::Ringtone); <span class="comment">// å¯¹åº”Logcatç¬¬äºŒè¡Œè¾“å‡ºæ—¥å¿—</span></span><br><span class="line">    <span class="comment">// å¦‚æœå¦å¤–ä¸€ä¸ªå‘¼å«ä¸åœ¨Ringtoneä¸”ä¸åœ¨RingbackçŠ¶æ€</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">isAnotherSessionInState</span>(session, State::Ringtone) &amp;&amp; !<span class="built_in">isAnotherSessionInState</span>(session, State::Ringback)) &#123;</span><br><span class="line">		<span class="built_in">doStopToneToPlaySomethingElse</span>(session);</span><br><span class="line">		<span class="built_in">doStartRingtone</span>(session);</span><br><span class="line">		mStats-&gt;number_of_startRingtone++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹<code>ToneManager::startRingtone</code>ä¸‹é¢çš„<code>startErrorTone</code>æ–¹æ³•ï¼Œå‘ç°æ­¤æ–¹æ³•æ˜¯è°ƒç”¨<code>linphone_core_tone_indications_enabled</code>åˆ¤æ–­æ˜¯å¦å¯ä»¥æ’­æŠ¥Toneï¼ŒçŒœæƒ³å¯ä»¥åœ¨<code>startRingtone</code>æ–¹æ³•ä¸­ä¹Ÿå¢åŠ æ­¤åˆ¤æ–­é€»è¾‘</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::startErrorTone</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session, LinphoneReason reason)</span> </span>&#123;</span><br><span class="line">	LinphoneCore *lc = <span class="built_in">getCore</span>()-&gt;<span class="built_in">getCCore</span>();</span><br><span class="line">    <span class="comment">// æ­¤å¤„åˆ¤æ–­æ˜¯å¦å¯ä»¥æ’­æŠ¥Tone</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">linphone_core_tone_indications_enabled</span>(lc)) &#123;</span><br><span class="line">		<span class="built_in">printDebugInfo</span>(session);</span><br><span class="line">		<span class="built_in">doStopToneToPlaySomethingElse</span>(session);</span><br><span class="line">		<span class="built_in">doStartErrorTone</span>(session, reason);</span><br><span class="line">		mStats-&gt;number_of_startErrorTone++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡éœ€è¦å…ˆäº†è§£ä¸‹<code>linphone_core_tone_indications_enabled</code>æ–¹æ³•çš„å®ç°ï¼Œæ­¤æ–¹æ³•ä½äº<code>msic.c</code>ä¸­ï¼Œæ–¹æ³•å†…éƒ¨ä»<code>linphone_config</code>ä¸­è¯»å–<code>sound</code>sectionä¸‹<code>tone_indications</code>keyçš„å€¼è½¬æ¢ä¸º<code>bool_t</code>ç±»å‹ï¼Œå¤§äº0ä¸ºTureï¼Œå°äºç­‰äº0ä¸ºFlaseï¼Œå…¶ä¸­<code>linphone_config</code>å¯ä»¥ä»Javaå±‚é…ç½®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool_t</span> <span class="title">linphone_core_tone_indications_enabled</span><span class="params">(LinphoneCore*lc)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !!<span class="built_in">linphone_config_get_int</span>(lc-&gt;config,<span class="string">&quot;sound&quot;</span>,<span class="string">&quot;tone_indications&quot;</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œé—®é¢˜åˆ†æå®Œæ¯•ï¼Œå¯ä»¥åœ¨<code>startRingtone</code>æ–¹æ³•ä¸­ä¹Ÿå¢åŠ æ­¤åˆ¤æ–­é€»è¾‘äº†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToneManager::startRingtone</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallSession&gt; &amp;session)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printDebugInfo</span>(session);</span><br><span class="line">	<span class="built_in">setState</span>(session, State::Ringtone);</span><br><span class="line">	<span class="comment">// modified by guodongAndroid on 2022/04/24 ä¿®æ”¹æœ‰æ­£åœ¨é€šè¯çš„å‘¼å«æ—¶ï¼Œåˆæ”¶åˆ°ä¸€èµ·å‘¼å«æ’­æŠ¥Ringtoneé—®é¢˜</span></span><br><span class="line">	<span class="comment">// å¢åŠ tone_indicationsæ˜¯å¦å¼€å¯åˆ¤æ–­</span></span><br><span class="line">	LinphoneCore *lc = <span class="built_in">getCore</span>()-&gt;<span class="built_in">getCCore</span>();</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">linphone_core_tone_indications_enabled</span>(lc)) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">isAnotherSessionInState</span>(session, State::Ringtone) &amp;&amp; !<span class="built_in">isAnotherSessionInState</span>(session, State::Ringback)) &#123;</span><br><span class="line">		<span class="built_in">doStopToneToPlaySomethingElse</span>(session);</span><br><span class="line">		<span class="built_in">doStartRingtone</span>(session);</span><br><span class="line">		mStats-&gt;number_of_startRingtone++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿å­˜é‡æ–°ç¼–è¯‘ï¼Œç­‰å¾…ç¼–è¯‘å®Œæˆæ‹·è´è‡³ASä¸­ï¼Œç°åœ¨åªéœ€åœ¨Javaå±‚åˆå§‹åŒ–æ—¶é…ç½®Configï¼Œä¿®æ”¹<code>tone_indications</code>çš„å€¼å³å¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// modified by guodongAndroid on 2022/04/24 ä¿®æ”¹æœ‰æ­£åœ¨é€šè¯çš„å‘¼å«æ—¶ï¼Œåˆæ”¶åˆ°ä¸€èµ·å‘¼å«æ’­æŠ¥Ringtoneé—®é¢˜</span></span><br><span class="line"><span class="comment">// å…³é—­ToneIndications</span></span><br><span class="line">mCore.getConfig().setInt(<span class="string">&quot;sound&quot;</span>, <span class="string">&quot;tone_indications&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>happy~</p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼–è¯‘linphone-sdk-android</title>
    <url>/2022/04/17/linphone-sdk-android/%E7%BC%96%E8%AF%91linphone-sdk-android/</url>
    <content><![CDATA[<h1 id="ç¼–è¯‘linphone-sdk-android"><a class="markdownIt-Anchor" href="#ç¼–è¯‘linphone-sdk-android"></a> ç¼–è¯‘linphone-sdk-android</h1>
<h2 id="ç¼–è¯‘ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#ç¼–è¯‘ç¯å¢ƒ"></a> ç¼–è¯‘ç¯å¢ƒ</h2>
<p>ç³»ç»Ÿ Ubuntu 20.04.4 LTS  2æ ¸4G 50Gå­˜å‚¨ i5-8250U 1.60Ghz</p>
<p>Android SDK r24.4.1</p>
<p>Android NDK r18b</p>
<p>Linphone SDK  Release 4.5</p>
<p>CMake 3.16.3</p>
<p>Python 3.8.10</p>
<p>Git 2.15.1</p>
<p>Java 1.8.0_312</p>
<h2 id="androidç¯å¢ƒå‡†å¤‡"><a class="markdownIt-Anchor" href="#androidç¯å¢ƒå‡†å¤‡"></a> Androidç¯å¢ƒå‡†å¤‡</h2>
<p>å®‰è£… Android SDK NDK cmdline-tools</p>
<p>NDKï¼š<a href="https://developer.android.google.cn/ndk/downloads?hl=en">https://developer.android.google.cn/ndk/downloads?hl=en</a></p>
<p>SDKï¼š<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fdl.google.com%2Fandroid%2Fandroid-sdk_r24.4.1-linux.tgz">https://links.jianshu.com/go?to=http%3A%2F%2Fdl.google.com%2Fandroid%2Fandroid-sdk_r24.4.1-linux.tgz</a></p>
<p>Cmdlineï¼š<a href="https://dl.google.com/android/repository/commandlinetools-linux-6200805_latest.zip">https://dl.google.com/android/repository/commandlinetools-linux-6200805_latest.zip</a></p>
<p>ä¸‰ä¸ªå‹ç¼©åŒ…ä¸‹è½½ä¹‹åï¼Œå°†NDKå’ŒSDKè§£å‹ï¼Œcommandlinetools-linux-6200805_latest.zip è§£å‹åå°†è§£å‹å‡ºæ¥çš„toolsæ–‡ä»¶å¤¹æ”¾åœ¨sdkæ ¹ç›®å½•çš„cmdline-toolsæ–‡ä»¶å¤¹é‡Œè¾¹ï¼Œå¦‚æœæ²¡æœ‰cmdline-toolsæ–‡ä»¶å¤¹ï¼Œå°±æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªã€‚æ”¾å¥½æ–‡ä»¶ä¹‹åéœ€è¦é…ç½®ç¯å¢ƒå˜é‡,åœ¨~/ .profileæ–‡ä»¶ä¸‹æœ«å°¾æ·»åŠ ä¸€ä¸‹å†…å®¹ï¼Œè·¯å¾„æ¢æˆä½ è‡ªå·±çš„æ–‡ä»¶è·¯å¾„</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">JAVA_HOME</span>=ä½ è‡ªå·±çš„è·¯å¾„</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="variable">$JAVA_HOME</span>:$PATH</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> <span class="attribute">ANDROID_HOME</span>=ä½ è‡ªå·±çš„è·¯å¾„/android-sdk-linux</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="variable">$ANDROID_HOME</span>/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/tools/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> <span class="attribute">NDK_HOME</span>=ä½ è‡ªå·±çš„è·¯å¾„/android-ndk-r18b</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="variable">$NDK_HOME</span>:$PATH</span><br></pre></td></tr></table></figure>
<h2 id="ubuntuç¯å¢ƒå‡†å¤‡"><a class="markdownIt-Anchor" href="#ubuntuç¯å¢ƒå‡†å¤‡"></a> Ubuntuç¯å¢ƒå‡†å¤‡</h2>
<h3 id="å®‰è£…cmake"><a class="markdownIt-Anchor" href="#å®‰è£…cmake"></a> å®‰è£…cmake</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install cmake</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…git"><a class="markdownIt-Anchor" href="#å®‰è£…git"></a> å®‰è£…git</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install git</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…java"><a class="markdownIt-Anchor" href="#å®‰è£…java"></a> å®‰è£…java</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install openjdk-8-jdk</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…yasm"><a class="markdownIt-Anchor" href="#å®‰è£…yasm"></a> å®‰è£…yasm</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install yasm</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…nasm"><a class="markdownIt-Anchor" href="#å®‰è£…nasm"></a> å®‰è£…nasm</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install nasm</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…doxygen"><a class="markdownIt-Anchor" href="#å®‰è£…doxygen"></a> å®‰è£…doxygen</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install doxygen</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…clang"><a class="markdownIt-Anchor" href="#å®‰è£…clang"></a> å®‰è£…clang</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install clang</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…gmultilib"><a class="markdownIt-Anchor" href="#å®‰è£…gmultilib"></a> å®‰è£…g+Â±multilib</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install g++-multilib</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…pip"><a class="markdownIt-Anchor" href="#å®‰è£…pip"></a> å®‰è£…pip</h3>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install python3-pip</span><br></pre></td></tr></table></figure>
<h3 id="é…ç½®pipæº"><a class="markdownIt-Anchor" href="#é…ç½®pipæº"></a> é…ç½®pipæº</h3>
<p>ç¼–è¾‘<code>~/.pip/pip.conf</code>ï¼Œè‹¥æ²¡æœ‰æ­¤æ–‡ä»¶è‡ªè¡Œåˆ›å»ºï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="keyword">index</span>-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">[install]</span><br><span class="line"><span class="keyword">trusted</span>-host = https://pypi.tuna.tsinghua.edu.cn</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…pystache"><a class="markdownIt-Anchor" href="#å®‰è£…pystache"></a> å®‰è£…pystache</h3>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip3 <span class="keyword">install</span> pystache</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…six"><a class="markdownIt-Anchor" href="#å®‰è£…six"></a> å®‰è£…six</h3>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip3 <span class="keyword">install</span> six</span><br></pre></td></tr></table></figure>
<h3 id="android-sdk-åè®®æˆäºˆ"><a class="markdownIt-Anchor" href="#android-sdk-åè®®æˆäºˆ"></a> Android SDK åè®®æˆäºˆ</h3>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">yes | sdkmanager</span> <span class="literal">--</span><span class="comment">licenses &amp;&amp; sdkmanager</span> <span class="literal">--</span><span class="comment">update</span></span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å‰ç¯å¢ƒåŸºæœ¬å‡†å¤‡å®Œæ¯•ã€‚</p>
<h2 id="ç¼–è¯‘linphone-sdk"><a class="markdownIt-Anchor" href="#ç¼–è¯‘linphone-sdk"></a> ç¼–è¯‘Linphone SDK</h2>
<h3 id="ä¸‹è½½æºç "><a class="markdownIt-Anchor" href="#ä¸‹è½½æºç "></a> ä¸‹è½½æºç </h3>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ git clone -b release<span class="regexp">/4.5 https:/</span><span class="regexp">/gitlab.linphone.org/</span>BC<span class="regexp">/public/</span>linphone-sdk.git --recursive</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ol>
<li>æ ¹æ®ä¸ªäººç½‘ç»œæƒ…å†µï¼Œå¯èƒ½éœ€è¦æŒ‚VPN</li>
<li>cloneéœ€è¦åŠ <code>--recursive</code>ï¼Œå› ä¸ºlinphone-sdkä½¿ç”¨git submoduleåŠŸèƒ½æ­å»ºï¼Œå¼•ç”¨äº†åå‡ ä¸ªmoduleï¼Œ<code>--recursive</code>ä¼šåœ¨cloneçš„æ—¶å€™æŠŠå¼•ç”¨çš„moduleä¹Ÿä¸‹è½½ä¸‹æ¥</li>
</ol>
<p>å¤„ç†ä¸‹æ–‡ä»¶å¯æ‰§è¡Œæƒé™ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> u+x linphone-sdk/cmake/Android/gradlew</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> u+x linphone-sdk/external/libvpx/configure</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> u+x linphone-sdk/cmake/dummy.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> u+x linphone-sdk/external/libvpx/build/make/*</span></span><br></pre></td></tr></table></figure>
<h3 id="å¼€å§‹ç¼–è¯‘"><a class="markdownIt-Anchor" href="#å¼€å§‹ç¼–è¯‘"></a> å¼€å§‹ç¼–è¯‘</h3>
<p>åˆ°è¿™é‡Œä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘äº†ï¼Œåˆ›å»ºbuildæ–‡ä»¶å¤¹ï¼Œç¼–è¯‘è¿‡ç¨‹äº§ç‰©éƒ½åœ¨buildæ–‡ä»¶å¤¹é‡Œ</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ cd linphone-sdk</span><br><span class="line">$ mkdir build &amp;&amp; cd build</span><br><span class="line">$ cmake <span class="attribute">-DCMAKE_VERBOSE_MAKEFILE</span>=ON <span class="attribute">-DLINPHONESDK_PLATFORM</span>=Android <span class="attribute">-DLINPHONESDK_ANDROID_ARCHS</span>=arm64,armv7,x86,x86_64 <span class="attribute">-DENABLE_G729</span>=<span class="literal">YES</span> <span class="built_in">..</span></span><br><span class="line">$ cmake --build . --parallel 8</span><br></pre></td></tr></table></figure>
<p>ç›®å‰æ˜¯æŒ‡å®šç¼–è¯‘ç›®æ ‡å¹³å°æ˜¯Androidï¼Œç¼–è¯‘ç›®æ ‡CPUæ¶æ„æ˜¯arm64/armv7,x86,x86_64ï¼Œå¹¶å¼€å¯G729éŸ³é¢‘ç¼–è§£ç ï¼Œå¼€å¯8ä¸ªçº¿ç¨‹ç¼–è¯‘ï¼Œåœ¨ç›®å‰ç¼–è¯‘ç¯å¢ƒä¸‹ï¼Œæ•´ç¼–ä¸€æ¬¡è€—æ—¶å¤§çº¦ä¸€ä¸ªåŠå°æ—¶ï¼Œåç»­å¢é‡ç¼–è¯‘ä¼šå¿«ä¸å°‘</p>
<p>ä¸éœ€è¦x86,x86_64æ¶æ„çš„ï¼Œå¯ä»¥åˆ é™¤ã€‚</p>
<p>ç›®å‰ç¼–è¯‘è¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ï¼Œhappy~~~</p>
<p>ç¼–è¯‘å®Œæˆåçš„äº§ç‰©åœ¨ä»¥ä¸‹ç›®å½•ï¼š</p>
<ul>
<li>.soï¼šbuild/libs/</li>
<li>aarï¼šbuild/linphone-sdk/bin/outputs/aar/</li>
<li>mavenï¼šbuild/maven_repository</li>
</ul>
<p>æœ€ååˆ›å»ºä¸€ä¸ªç¼–è¯‘è„šæœ¬<code>build.sh</code>ï¼ŒæŠŠä¸Šé¢çš„ç¼–è¯‘å‘½ä»¤å¤åˆ¶åˆ°æ–‡ä»¶é‡Œä¿å­˜ï¼Œæ¯æ¬¡ç¼–è¯‘æ—¶æ‰§è¡Œç¼–è¯‘è„šæœ¬å³å¯<code>./build.sh</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">cmake -DCMAKE_VERBOSE_MAKEFILE=ON -DLINPHONESDK_PLATFORM=Android -DLINPHONESDK_ANDROID_ARCHS=arm64,armv7,x86,x86_64 -DENABLE_G729=YES ..</span><br><span class="line">cmake --build . --parallel 8</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒæ–‡æ¡£"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡æ¡£"></a> å‚è€ƒæ–‡æ¡£</h2>
<p><a href="https://gitlab.linphone.org/BC/public/linphone-sdk">å®˜æ–¹æ–‡æ¡£</a></p>
<p><a href="https://www.jianshu.com/p/942f989eaac7">LinPhone Android SDK ç¼–è¯‘è¿‡ç¨‹</a></p>
<p><a href="https://www.codenong.com/cs106423576/">ç¼–è¯‘linphone Android</a></p>
]]></content>
      <categories>
        <category>linphone-sdk-android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>linphone-sdk-android</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-è‡ªå®šä¹‰View-ä»¿æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•</title>
    <url>/2022/07/28/Android/TouchView/touch-view/</url>
    <content><![CDATA[<h1 id="android-è‡ªå®šä¹‰view-ä»¿æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•"><a class="markdownIt-Anchor" href="#android-è‡ªå®šä¹‰view-ä»¿æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•"></a> Android-è‡ªå®šä¹‰View-ä»¿æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•</h1>
<p>æºæ‰‹åˆ›ä½œï¼Œå…±åŒæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 8 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 1 å¤©ï¼Œ<a href="https://juejin.cn/post/7123120819437322247">ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</a></p>
<hr />
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>å› é¡¹ç›®éœ€æ±‚å˜æ›´ï¼Œå…¬å¸å†…çš„å·¥å‚æµ‹è¯•ç¨‹åºé‡å†™ï¼Œä¹‹å‰çš„è§¦æ‘¸å±æµ‹è¯•å·²ä¸ç¬¦åˆé¡¹ç›®éœ€æ±‚ï¼Œé‚å¯¹æ¯”äº†æŸç±³å’ŒæŸä¸ºçš„è§¦æ‘¸å±æµ‹è¯•æ•ˆæœï¼Œä¸ªäººè§‰å¾—æŸç±³çš„æ•ˆæœä¸é”™ï¼Œè™½ç„¶æœ€åæ²¡æœ‰è¢«é‡‡çº³ï¼Œä½†æ˜¯è¿™ä¸å¦¨ç¢æˆ‘ä»¬å®ç°ä¸€ä¸‹æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•ã€‚å¯èƒ½å› æœºå‹ä¸åŒï¼Œæ‰“å¼€æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•çš„æ–¹å¼ä¹Ÿä¸å°½ç›¸åŒï¼Œè¯»è€…è¯·è‡ªè¡Œç™¾åº¦ç›¸åº”æœºå‹çš„æ–¹å¼ã€‚</p>
<img data-src="/imgs/android/touch-view/mi.jpg" alt="mi" style="zoom:30%;" />
<p>æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ï¼š</p>
<ul>
<li>å±å¹•å››å‘¨ã€å‚ç›´å±…ä¸­å’Œæ°´å¹³å±…ä¸­æœ‰ç»˜åˆ¶å•å…ƒæ ¼ï¼Œè§¦æ‘¸åä¼šé‡ç»˜é¢œè‰²ã€‚</li>
<li>å±å¹•ä¸¤ä¸ªå¯¹è§’çº¿æœ‰ç±»ä¼¼äºç®¡é“çš„å›¾æ¡ˆï¼Œæ­¤å›¾æ¡ˆé‡ç»˜åªèƒ½ä»ç»˜åˆ¶ X å·çš„åœ°æ–¹å¼€å§‹ï¼Œä¸€ç›´åˆ°ç®¡é“å¯¹ç«¯çš„ X å·åœ°æ–¹ä¸ºæ­¢ï¼Œå¦‚æœæœŸé—´æ‰‹æŒ‡è§¦æ‘¸è¶…å‡ºç®¡é“çš„èŒƒå›´å³å¤±è´¥ã€‚</li>
<li>æ‰‹æŒ‡è§¦æ‘¸åœ¨å•å…ƒæ ¼ä¸ç®¡é“å†…çš„åŒºåŸŸæ»‘åŠ¨æ—¶ï¼Œå±å¹•ä¼šæ˜¾ç¤ºæ»‘åŠ¨è½¨è¿¹ï¼Œå¦‚æœè¶…å‡ºåŒºåŸŸï¼Œåˆ™è½¨è¿¹æ¶ˆå¤±ã€‚</li>
<li>æ‰€æœ‰å•å…ƒæ ¼ä¸ä¸¤æ¡ç®¡é“é‡ç»˜å®Œæ¯•åˆ™æµ‹è¯•å®Œæˆã€‚</li>
</ul>
<h2 id="ç»˜åˆ¶å•å…ƒæ ¼"><a class="markdownIt-Anchor" href="#ç»˜åˆ¶å•å…ƒæ ¼"></a> ç»˜åˆ¶å•å…ƒæ ¼</h2>
<p>æ€è·¯å¦‚ä¸‹ï¼šä»¥å·¦ä¸Šè§’çš„å•å…ƒæ ¼ä¸ºèµ·ç‚¹ï¼Œè®¡ç®—å‡ºæ‰€æœ‰å•å…ƒæ ¼çš„åæ ‡ä¿å­˜èµ·æ¥ï¼Œæœ€ååœ¨ <code>onDraw</code> æ–¹æ³•ä¸­éå†å•å…ƒæ ¼ç»„ï¼Œæ ¹æ®åæ ‡è¿›è¡Œç»˜åˆ¶ã€‚</p>
<p>é¦–å…ˆå®šä¹‰å•å…ƒæ ¼çš„åŸºå‡†å®½é«˜ä¸æœ€ç»ˆå®½é«˜å˜é‡ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> itemWidthBasic = <span class="number">90</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> itemHeightBasic = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> itemWidth = -<span class="number">1F</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> itemHeight = -<span class="number">1F</span></span><br></pre></td></tr></table></figure>
<p>å…¶æ¬¡å®šä¹‰è‡ªå®šä¹‰ View çš„å®½é«˜å˜é‡ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> viewWidth: <span class="built_in">Int</span> = -<span class="number">1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> viewHeight: <span class="built_in">Int</span> = -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>æœ€åå®šä¹‰å•å…ƒæ ¼åœ¨å®½é«˜æ–¹å‘ä¸Šçš„æ•°é‡å˜é‡ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> widthCount = -<span class="number">1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> heightCount = -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ç»˜åˆ¶å•å…ƒæ ¼çš„ç”»ç¬”ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> boxPaint <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">        color = Color.GRAY</span><br><span class="line">        style = Paint.Style.STROKE</span><br><span class="line">        strokeWidth = <span class="number">2F</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ TouchRectF å®ä½“ï¼Œå¯¹ RectF åŒ…è£…ä¸€å±‚ï¼Œå¢åŠ  <code>isReDrawable</code> å˜é‡ï¼Œå•å…ƒæ ¼è¢«è§¦æ‘¸é‡ç»˜åæ ‡è®°ä¸º Trueï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">TouchRectF</span>(<span class="keyword">val</span> rectF: RectF, <span class="keyword">var</span> isReDrawable: <span class="built_in">Boolean</span> = <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">        isReDrawable = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¿å­˜å•å…ƒæ ¼åæ ‡çš„å®¹å™¨ï¼Œå…¶ä¸­åŒ…å«å±å¹•ä¸Šä¸‹å·¦å³ä»¥åŠå‚ç›´ä¸æ°´å¹³å±…ä¸­çš„åæ ‡å®¹å™¨ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å±å¹•å·¦ä¾§å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> leftRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±å¹•é¡¶éƒ¨å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> topRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±å¹•å³ä¾§å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> rightRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±å¹•åº•éƒ¨å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> bottomRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±å¹•æ°´å¹³å±…ä¸­å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> centerHorizontalRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±å¹•å‚ç›´å±…ä¸­å•å…ƒæ ¼çš„åæ ‡å®¹å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> centerVerticalRectFList = mutableListOf&lt;TouchRectF&gt;()</span><br></pre></td></tr></table></figure>
<p>é€‰æ‹©åœ¨ <code>onLayout</code> æ–¹æ³•ä¸­è®¡ç®—æ‰€æœ‰å•å…ƒæ ¼çš„åæ ‡å¹¶è·å– View çš„å®½é«˜ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, left: <span class="type">Int</span>, top: <span class="type">Int</span>, right: <span class="type">Int</span>, bottom: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom)</span><br><span class="line">    <span class="comment">// ä¿å­˜ View çš„å®½é«˜</span></span><br><span class="line">    viewWidth = width</span><br><span class="line">    viewHeight = height</span><br><span class="line"></span><br><span class="line">    computeRectF()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾æ˜¾ç¤ºäº†æ‰€æœ‰å•å…ƒæ ¼æ‰€åœ¨çš„èŒƒå›´ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view-scope.png" alt="scope" /></p>
<p>åœ¨ <code>computeRectF</code> æ–¹æ³•ä¸­è®¡ç®—å•å…ƒæ ¼çš„å®½é«˜ã€æ•°é‡åŠåæ ‡ï¼š</p>
<ol>
<li>é¦–å…ˆä»¥å•å…ƒæ ¼çš„åŸºå‡†å®½é«˜è®¡ç®—å•å…ƒæ ¼å®½é«˜æ–¹å‘ä¸Šçš„æ•°é‡</li>
<li>å…¶æ¬¡ä»¥å•å…ƒæ ¼å®½é«˜æ–¹å‘ä¸Šçš„æ•°é‡è®¡ç®—å•å…ƒæ ¼çš„æœ€ç»ˆå®½é«˜</li>
<li>æ¸…é™¤ä¹‹å‰è®¡ç®—çš„ç»“æœ</li>
</ol>
<p>æ ¹æ®ä¸Šé¢å•å…ƒæ ¼èŒƒå›´ç¤ºæ„å›¾ï¼š</p>
<ul>
<li>è®¡ç®—å¹¶ä¿å­˜å·¦ä¾§å•å…ƒæ ¼çš„åæ ‡ï¼Œä¸åŒ…å«å¤´å’Œå°¾ï¼Œå»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼</li>
<li>è®¡ç®—å¹¶ä¿å­˜é¡¶éƒ¨å•å…ƒæ ¼çš„åæ ‡</li>
<li>è®¡ç®—å¹¶ä¿å­˜å³ä¾§å•å…ƒæ ¼çš„åæ ‡ï¼Œä¸åŒ…å«å¤´å’Œå°¾ï¼Œå»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼</li>
<li>è®¡ç®—å¹¶ä¿å­˜åº•éƒ¨å•å…ƒæ ¼çš„åæ ‡</li>
<li>è®¡ç®—å¹¶ä¿å­˜æ°´å¹³å±…ä¸­å•å…ƒæ ¼çš„åæ ‡ï¼Œä¸åŒ…å«å¤´å’Œå°¾ï¼Œå»æ‰ä¸å·¦ä¾§å’Œå³ä¾§é‡å çš„å•å…ƒæ ¼</li>
<li>è®¡ç®—å¹¶ä¿å­˜å‚ç›´å±…ä¸­å•å…ƒæ ¼çš„åæ ‡ï¼Œä¸åŒ…å«å¤´å’Œå°¾ï¼Œå»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼ï¼Œä¸”å»æ‰ä¸æ°´å¹³å±…ä¸­é‡å çš„å•å…ƒæ ¼</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeRectF</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä»¥å•å…ƒæ ¼çš„åŸºå‡†å®½é«˜è®¡ç®—å•å…ƒæ ¼å®½é«˜æ–¹å‘ä¸Šçš„æ•°é‡</span></span><br><span class="line">    widthCount = viewWidth / itemWidthBasic</span><br><span class="line">    heightCount = viewHeight / itemHeightBasic</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥å•å…ƒæ ¼å®½é«˜æ–¹å‘ä¸Šçš„æ•°é‡å†è®¡ç®—å•å…ƒæ ¼çš„æœ€ç»ˆå®½é«˜</span></span><br><span class="line">    itemWidth = viewWidth.toFloat() / widthCount</span><br><span class="line">    itemHeight = viewHeight.toFloat() / heightCount</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºä¹‹å‰è®¡ç®—çš„ç»“æœ</span></span><br><span class="line">    leftRectFList.clear()</span><br><span class="line">    topRectFList.clear()</span><br><span class="line">    rightRectFList.clear()</span><br><span class="line">    bottomRectFList.clear()</span><br><span class="line">    centerHorizontalRectFList.clear()</span><br><span class="line">    centerVerticalRectFList.clear()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•å·¦ä¾§å•å…ƒæ ¼çš„åæ ‡, ä¸åŒ…å«å¤´å’Œå°¾, å»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until heightCount - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(<span class="number">0F</span>, itemHeight * i, itemWidth, itemHeight * (i + <span class="number">1</span>))</span><br><span class="line">        leftRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•é¡¶éƒ¨å•å…ƒæ ¼çš„åæ ‡</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until widthCount) &#123;</span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(itemWidth * i, <span class="number">0F</span>, itemWidth * (i + <span class="number">1</span>), itemHeight)</span><br><span class="line">        topRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•å³ä¾§å•å…ƒæ ¼çš„åæ ‡, ä¸åŒ…å«å¤´å’Œå°¾, å»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until heightCount - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(</span><br><span class="line">            viewWidth - itemWidth,</span><br><span class="line">            itemHeight * i,</span><br><span class="line">            viewWidth.toFloat(),</span><br><span class="line">            itemHeight * (i + <span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        rightRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•åº•éƒ¨å•å…ƒæ ¼çš„åæ ‡</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until widthCount) &#123;</span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(</span><br><span class="line">            itemWidth * i,</span><br><span class="line">            viewHeight - itemHeight,</span><br><span class="line">            itemWidth * (i + <span class="number">1</span>),</span><br><span class="line">            viewHeight.toFloat()</span><br><span class="line">        )</span><br><span class="line">        bottomRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•æ°´å¹³å±…ä¸­å•å…ƒæ ¼çš„åæ ‡, ä¸åŒ…å«å¤´å’Œå°¾, å»æ‰ä¸å·¦ä¾§å’Œå³ä¾§é‡å çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">val</span> centerHIndex = heightCount / <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until widthCount - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(</span><br><span class="line">            itemWidth * i,</span><br><span class="line">            itemHeight * centerHIndex,</span><br><span class="line">            itemWidth * (i + <span class="number">1</span>),</span><br><span class="line">            itemHeight * (centerHIndex + <span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        centerHorizontalRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¹¶ä¿å­˜å±å¹•å‚ç›´å±…ä¸­å•å…ƒæ ¼çš„åæ ‡, ä¸åŒ…å«å¤´å’Œå°¾, å»æ‰ä¸é¡¶éƒ¨å’Œåº•éƒ¨é‡å çš„å•å…ƒæ ¼, ä¸”å»æ‰ä¸æ°´å¹³å±…ä¸­é‡å çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">val</span> centerVIndex = widthCount / <span class="number">2</span></span><br><span class="line">    <span class="keyword">val</span> skipIndex: <span class="built_in">Int</span> = centerHIndex</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until heightCount - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// è·³è¿‡ä¸æ¨ªè½´äº¤å‰çš„éƒ¨åˆ†</span></span><br><span class="line">        <span class="keyword">if</span> (i == skipIndex) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> rectF = RectF(</span><br><span class="line">            itemWidth * centerVIndex,</span><br><span class="line">            itemHeight * i,</span><br><span class="line">            itemWidth * (centerVIndex + <span class="number">1</span>),</span><br><span class="line">            itemHeight * (i + <span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        centerVerticalRectFList.add(TouchRectF(rectF))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥åœ¨ <code>onDraw</code> ä¸­ç»˜åˆ¶å•å…ƒæ ¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å•å…ƒæ ¼æ•°é‡ä¸º -1 æ—¶è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (widthCount == -<span class="number">1</span> || heightCount == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºç”»å¸ƒ</span></span><br><span class="line">    canvas.drawColor(Color.BLACK, PorterDuff.Mode.CLEAR)</span><br><span class="line">    canvas.drawColor(Color.WHITE)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶æ°´å¹³æ–¹å‘çš„å•å…ƒæ ¼</span></span><br><span class="line">    drawHorizontalBox(canvas)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶å‚ç›´æ–¹å‘çš„å•å…ƒæ ¼</span></span><br><span class="line">    drawVerticalBox(canvas)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawHorizontalBox</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> topRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> centerHorizontalRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> bottomRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawVerticalBox</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> leftRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> centerVerticalRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (rectF <span class="keyword">in</span> rightRectFList) &#123;</span><br><span class="line">        drawBox(rectF, canvas)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawBox</span><span class="params">(rectF: <span class="type">TouchRectF</span>, canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    canvas.drawRect(rectF.rectF, boxPaint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>é¦–å…ˆåšå‚æ•°æ ¡éªŒä¸ç”»å¸ƒæ¸…ç©º</li>
<li>ç„¶åç»˜åˆ¶æ°´å¹³æ–¹å‘çš„å•å…ƒæ ¼ï¼Œåœ¨ <code>drawHorizontalBox</code> æ–¹æ³•ä¸­éå†æ°´å¹³æ–¹å‘çš„å•å…ƒæ ¼åæ ‡å®¹å™¨ï¼Œå†è°ƒç”¨ <code>drawBox</code> æ–¹æ³•ä¼ å…¥åæ ‡ç»˜åˆ¶å•å…ƒæ ¼</li>
<li>æœ€åç»˜åˆ¶å‚ç›´æ–¹å‘çš„å•å…ƒæ ¼ï¼Œåœ¨ <code>drawVerticalBox</code> æ–¹æ³•ä¸­éå†å‚ç›´æ–¹å‘çš„å•å…ƒæ ¼åæ ‡å®¹å™¨ï¼Œå†è°ƒç”¨ <code>drawBox</code> æ–¹æ³•ä¼ å…¥åæ ‡ç»˜åˆ¶å•å…ƒæ ¼</li>
<li>åœ¨ <code>drawBox</code> æ–¹æ³•ä¸­ç»˜åˆ¶å•å…ƒæ ¼</li>
</ol>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view-rectf.png" alt="box" /></p>
<h2 id="ç»˜åˆ¶äº¤å‰ç®¡é“"><a class="markdownIt-Anchor" href="#ç»˜åˆ¶äº¤å‰ç®¡é“"></a> ç»˜åˆ¶äº¤å‰ç®¡é“</h2>
<p>ä¸Šé¢ç»˜åˆ¶å•å…ƒæ ¼æ¯”è¾ƒç®€å•ä¸€äº›ï¼Œç°åœ¨è¦ç»˜åˆ¶çš„ä¸¤ä¸ªç®¡é“ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œæœ¬æ–‡ä¸ºäº†ç®€å•ï¼Œæ²¡æœ‰å®Œå…¨ä»¿ç…§æŸç±³è§¦æ‘¸å±æµ‹è¯•ä¸­ç®¡é“çš„ UI æ•ˆæœã€‚</p>
<p>æ€è·¯ï¼šé€šè¿‡ Path è¿æ¥å¯¹è§’ä¸¤ä¸ªå•å…ƒæ ¼çš„é¡¶ç‚¹ç»„æˆç®¡é“ï¼Œç”±äº Path é—­åˆåï¼Œå•å…ƒæ ¼çš„ä¸¤ä¸ªé¡¶ç‚¹ä¼šè¿æ¥æˆç›´çº¿ï¼Œè¿™é‡Œä¸¤ä¸ªé¡¶ç‚¹çš„è¿æ¥ä½¿ç”¨äºŒé˜¶è´èµ›å°”æ›²çº¿ç»˜åˆ¶ä¸€ä¸ª View æ˜¾ç¤ºèŒƒå›´ä¹‹å¤–çš„å¼§çº¿ï¼Œè¿™æ ·çœ‹èµ·æ¥ç®¡é“æ²¡æœ‰èµ·æ­¢ç‚¹ï¼Œä¸” Path ä¹Ÿå¯ä»¥é—­åˆï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿åˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨ç®¡é“å†…ã€‚</p>
<p>å®šä¹‰ç®¡é“ Path å’Œ Regionï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * /</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> positiveCrossPath = TouchPath()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> positiveCrossRegion = Region()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> reverseCrossPath = TouchPath()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> reverseCrossRegion = Region()</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>computeRectF</code> æ–¹æ³•ä¸­è®¡ç®—ç®¡é“ Path è·¯å¾„ï¼š</p>
<ul>
<li>é‡ç½® Path è·¯å¾„</li>
<li>è®¡ç®—æ­£å‘ç®¡é“ Pathï¼Œä»¥å·¦ä¸‹è§’å•å…ƒæ ¼ä¸ºèµ·ç‚¹ï¼Œå³ä¸Šè§’å•å…ƒæ ¼ä¸ºç»ˆç‚¹ç»˜åˆ¶ Pathã€‚</li>
<li>è®¡ç®—åå‘ç®¡é“ Pathï¼Œä»¥å·¦ä¸Šè§’å•å…ƒæ ¼ä¸ºèµ·ç‚¹ï¼Œå³ä¸‹è§’å•å…ƒæ ¼ä¸ºç»ˆç‚¹ç»˜åˆ¶ Pathã€‚</li>
<li>ä¸‹é¢ä»£ç ä¸­çš„æ³¨é‡Šè¯´æ˜çš„æ›´å¤šä¸€äº›ã€‚</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeRectF</span><span class="params">()</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥è®¡ç®—å•å…ƒæ ¼çš„ä»£ç </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡ç½® Path</span></span><br><span class="line">    positiveCrossPath.path.reset()</span><br><span class="line">    reverseCrossPath.path.reset()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PositiveCross</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å·¦ä¸‹è§’å•å…ƒæ ¼åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> lbRectF = bottomRectFList.first().rectF</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å³ä¸Šè§’å•å…ƒæ ¼åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> rtRectF = topRectFList.last().rectF</span><br><span class="line">    </span><br><span class="line">    with(positiveCrossPath.path) &#123;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨ Path è‡³å·¦ä¸‹è§’å•å…ƒæ ¼çš„å·¦ä¸Šè§’é¡¶ç‚¹</span></span><br><span class="line">        moveTo(lbRectF.left, lbRectF.top)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿æ¥ç›´çº¿è‡³å³ä¸Šè§’å•å…ƒæ ¼çš„å·¦ä¸Šè§’é¡¶ç‚¹</span></span><br><span class="line">        lineTo(rtRectF.left, rtRectF.top)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»¥å³ä¸Šè§’å•å…ƒæ ¼çš„å³ä¸Šè§’é¡¶ç‚¹åæ ‡ä¸ºåŸºå‡†è®¡ç®—å±å¹•å¤–ä¸€ç‚¹ä¸ºæ§åˆ¶ç‚¹, å³ä¸Šè§’å•å…ƒæ ¼çš„å³ä¸‹è§’é¡¶ç‚¹ä¸ºç»“æŸç‚¹ç»˜åˆ¶äºŒé˜¶è´èµ›å°”æ›²çº¿</span></span><br><span class="line">        quadTo(</span><br><span class="line">            rtRectF.right + itemWidth,</span><br><span class="line">            rtRectF.top - itemHeight,</span><br><span class="line">            rtRectF.right,</span><br><span class="line">            rtRectF.bottom</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿æ¥ç›´çº¿è‡³å·¦ä¸‹è§’å•å…ƒæ ¼çš„å³ä¸‹è§’é¡¶ç‚¹</span></span><br><span class="line">        lineTo(lbRectF.right, lbRectF.bottom)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»¥å·¦ä¸‹è§’å•å…ƒæ ¼çš„å·¦ä¸‹è§’é¡¶ç‚¹åæ ‡ä¸ºåŸºå‡†è®¡ç®—å±å¹•å¤–ä¸€ç‚¹ä¸ºæ§åˆ¶ç‚¹, å·¦ä¸‹è§’å•å…ƒæ ¼çš„å·¦ä¸Šè§’é¡¶ç‚¹ä¸ºç»“æŸç‚¹ç»˜åˆ¶äºŒé˜¶è´èµ›å°”æ›²çº¿</span></span><br><span class="line">        quadTo(</span><br><span class="line">            lbRectF.left - itemWidth,</span><br><span class="line">            lbRectF.bottom + itemHeight,</span><br><span class="line">            lbRectF.left,</span><br><span class="line">            lbRectF.top</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é—­åˆ Path</span></span><br><span class="line">        close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æ­£å‘ç®¡é“ Path åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">val</span> positiveCrossRectF = RectF()</span><br><span class="line">    positiveCrossPath.path.computeBounds(positiveCrossRectF, <span class="literal">true</span>)</span><br><span class="line">    positiveCrossRegion.setPath(positiveCrossPath.path, positiveCrossRectF.toRegion())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ReverseCross</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å·¦ä¸Šè§’å•å…ƒæ ¼åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> ltRectF = topRectFList.first().rectF</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å³ä¸‹è§’å•å…ƒæ ¼åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> rbRectF = bottomRectFList.last().rectF</span><br><span class="line">    </span><br><span class="line">    with(reverseCrossPath.path) &#123;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨ Path è‡³å·¦ä¸Šè§’å•å…ƒæ ¼çš„å³ä¸Šè§’é¡¶ç‚¹</span></span><br><span class="line">        moveTo(ltRectF.right, ltRectF.top)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿æ¥ç›´çº¿åªå³ä¸‹è§’å•å…ƒæ ¼çš„å³ä¸Šè§’é¡¶ç‚¹</span></span><br><span class="line">        lineTo(rbRectF.right, rbRectF.top)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»¥å³ä¸‹è§’å•å…ƒæ ¼çš„å³ä¸‹è§’é¡¶ç‚¹åæ ‡ä¸ºåŸºå‡†è®¡ç®—å±å¹•å¤–ä¸€ç‚¹ä¸ºæ§åˆ¶ç‚¹, å³ä¸‹è§’å•å…ƒæ ¼çš„å·¦ä¸‹è§’é¡¶ç‚¹ä¸ºç»“æŸç‚¹ç»˜åˆ¶äºŒé˜¶è´èµ›å°”æ›²çº¿</span></span><br><span class="line">        quadTo(</span><br><span class="line">            rbRectF.right + itemWidth,</span><br><span class="line">            rbRectF.bottom + itemHeight,</span><br><span class="line">            rbRectF.left,</span><br><span class="line">            rbRectF.bottom</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿æ¥ç›´çº¿è‡³å·¦ä¸Šè§’å•å…ƒæ ¼çš„å·¦ä¸‹è§’é¡¶ç‚¹</span></span><br><span class="line">        lineTo(ltRectF.left, ltRectF.bottom)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»¥å·¦ä¸Šè§’å•å…ƒæ ¼çš„å·¦ä¸‹è§’é¡¶ç‚¹åæ ‡ä¸ºåŸºå‡†è®¡ç®—å±å¹•å¤–ä¸€ç‚¹ä¸ºæ§åˆ¶ç‚¹, å·¦ä¸Šè§’å•å…ƒæ ¼çš„å³ä¸Šè§’é¡¶ç‚¹ä¸ºç»“æŸç‚¹ç»˜åˆ¶äºŒé˜¶è´èµ›å°”æ›²çº¿</span></span><br><span class="line">        quadTo(</span><br><span class="line">            ltRectF.left - itemWidth,</span><br><span class="line">            ltRectF.top - itemHeight,</span><br><span class="line">            ltRectF.right,</span><br><span class="line">            ltRectF.top</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é—­åˆ Path</span></span><br><span class="line">        close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—åå‘ç®¡é“ Path åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">val</span> reverseCrossRectF = RectF()</span><br><span class="line">    reverseCrossPath.path.computeBounds(reverseCrossRectF, <span class="literal">true</span>)</span><br><span class="line">    reverseCrossRegion.setPath(reverseCrossPath.path, reverseCrossRectF.toRegion())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥åœ¨ <code>onDraw</code> æ–¹æ³•ä¸­ç»˜åˆ¶ç®¡é“ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥ç»˜åˆ¶å•å…ƒæ ¼ä»£ç </span></span><br><span class="line"></span><br><span class="line">    drawPositiveCross(canvas)</span><br><span class="line">    drawReverseCross(canvas)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawReverseCross</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    canvas.drawPath(reverseCrossPath.path, boxPaint)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawPositiveCross</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    canvas.drawPath(positiveCrossPath.path, boxPaint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view.png" alt="pipe" /></p>
<h2 id="é‡ç»˜å•å…ƒæ ¼"><a class="markdownIt-Anchor" href="#é‡ç»˜å•å…ƒæ ¼"></a> é‡ç»˜å•å…ƒæ ¼</h2>
<p>å•å…ƒæ ¼ä¸ç®¡é“å·²ç»ç»˜åˆ¶å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆå¼€å§‹é‡ç»˜å•å…ƒæ ¼ã€‚</p>
<p>å¤§ä½“æ€è·¯ï¼šåœ¨æ‰‹æŒ‡è§¦æ‘¸å±å¹•çš„æ—¶å€™åˆ¤æ–­å½“å‰è§¦æ‘¸çš„å±å¹•åæ ‡æ˜¯å¦åœ¨å•å…ƒæ ¼å†…ï¼Œæ˜¯çš„è¯åˆ™é‡ç»˜ï¼Œå¦åˆ™ä¸é‡ç»˜ã€‚</p>
<p>é¦–å…ˆå®šä¹‰é‡ç»˜å•å…ƒæ ¼çš„ç”»ç¬”ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> fillPaint <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">        color = Color.GREEN</span><br><span class="line">        style = Paint.Style.FILL</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºå•å…ƒæ ¼ä¸å•å…ƒæ ¼ã€å•å…ƒæ ¼ä¸ç®¡é“ä¹‹é—´æœ‰é‡å çš„éƒ¨åˆ†ï¼Œçªå‡ºæ˜¾ç¤ºé‡å éƒ¨åˆ†å“ªå—å•å…ƒæ ¼æ²¡æœ‰è¢«é‡ç»˜ï¼Œé‡ç»˜å•å…ƒæ ¼æ—¶æ”¹å˜å•å…ƒæ ¼è¾¹æ¡†çš„é¢œè‰²ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰é‡ç»˜å•å…ƒæ ¼çš„ç”»ç¬”ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> redrawBoxPaint <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">        color = Color.YELLOW</span><br><span class="line">        style = Paint.Style.STROKE</span><br><span class="line">        strokeWidth = <span class="number">3F</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é‡å†™ <code>onTouchEvent</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> x = event.x</span><br><span class="line">    <span class="keyword">val</span> y = event.y</span><br><span class="line">    <span class="keyword">when</span> (event.actionMasked) &#123;</span><br><span class="line">        MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å½“å‰åæ ‡æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line">            findReDrawableBox(x, y)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é‡ç»˜ View</span></span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findReDrawableBox</span><span class="params">(x: <span class="type">Float</span>, y: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> touchRectF = (leftRectFList.find &#123; it.rectF.contains(x, y) &#125;</span><br><span class="line">        ?: topRectFList.find &#123; it.rectF.contains(x, y) &#125;</span><br><span class="line">        ?: rightRectFList.find &#123; it.rectF.contains(x, y) &#125;</span><br><span class="line">        ?: bottomRectFList.find &#123; it.rectF.contains(x, y) &#125;</span><br><span class="line">        ?: centerHorizontalRectFList.find &#123; it.rectF.contains(x, y) &#125;</span><br><span class="line">        ?: centerVerticalRectFList.find &#123; it.rectF.contains(x, y) &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (touchRectF != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ‡è®°å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line">        markBoxReDrawable(touchRectF)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markBoxReDrawable</span><span class="params">(rectF: <span class="type">TouchRectF</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rectF.isReDrawable) &#123;</span><br><span class="line">        rectF.isReDrawable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>onTouchEvent</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ç›‘å¬ <code>ACTION_DOWN</code> äº‹ä»¶ï¼Œæ ¹æ®å½“å‰è§¦æ‘¸å±å¹•çš„åæ ‡æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°åŒ¹é…çš„å•å…ƒæ ¼ä¸”æ­¤å•å…ƒæ ¼ç›®å‰è¿˜æ²¡æœ‰è¢«é‡ç»˜ï¼Œåˆ™æ ‡è®°æ­¤å•å…ƒæ ¼ä¸ºå¯é‡ç»˜çš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡æ„ç»˜åˆ¶å•å…ƒæ ¼çš„ <code>drawBox</code> æ–¹æ³•æ¥é‡ç»˜å•å…ƒæ ¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é‡æ„ drawBox æ–¹æ³•ï¼Œå¢åŠ é‡ç»˜ä»£ç </span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawBox</span><span class="params">(rectF: <span class="type">TouchRectF</span>, canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰å•å…ƒæ ¼æ˜¯å¦å·²ç»æ ‡è®°ä¸ºå¯é‡ç»˜</span></span><br><span class="line">    <span class="keyword">if</span> (rectF.isReDrawable) &#123;</span><br><span class="line">        <span class="comment">// é‡ç»˜å•å…ƒæ ¼</span></span><br><span class="line">        canvas.drawRect(rectF.rectF, redrawBoxPaint)</span><br><span class="line">        canvas.drawRect(rectF.rectF, fillPaint)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        canvas.drawRect(rectF.rectF, boxPaint)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»˜åˆ¶è½¨è¿¹çº¿"><a class="markdownIt-Anchor" href="#ç»˜åˆ¶è½¨è¿¹çº¿"></a> ç»˜åˆ¶è½¨è¿¹çº¿</h2>
<p>ä¸€ä¸ªä¸ªæ–¹æ ¼ç‚¹å‡»ä¸å¤ªç°å®ï¼Œå› æ­¤å¢åŠ æ‰‹æŒ‡æ»‘åŠ¨é‡ç»˜å•å…ƒæ ¼ï¼ŒåŒæ—¶å¢åŠ æ‰‹æŒ‡æ»‘åŠ¨è½¨è¿¹çº¿ç»˜åˆ¶ã€‚</p>
<p>å®šä¹‰è½¨è¿¹çº¿ Pathï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> linePath = Path()</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰è½¨è¿¹çº¿ç”»ç¬”ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> linePaint <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">        color = Color.BLUE</span><br><span class="line">        style = Paint.Style.STROKE</span><br><span class="line">        strokeWidth = <span class="number">8F</span></span><br><span class="line">        strokeJoin = Paint.Join.ROUND</span><br><span class="line">        strokeCap = Paint.Cap.ROUND</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹ <code>onTouchEvent</code> æ–¹æ³•å¢åŠ å¯¹æ»‘åŠ¨é‡ç»˜å•å…ƒæ ¼å’Œç»˜åˆ¶è½¨è¿¹çº¿çš„æ”¯æŒï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> x = event.x</span><br><span class="line">    <span class="keyword">val</span> y = event.y</span><br><span class="line">    <span class="keyword">when</span> (event.actionMasked) &#123;</span><br><span class="line">        MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ¸…ç©ºè½¨è¿¹çº¿ Path</span></span><br><span class="line">            linePath.reset()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç§»åŠ¨è½¨è¿¹çº¿èµ·ç‚¹è‡³ç‚¹å‡»åæ ‡</span></span><br><span class="line">            linePath.moveTo(x, y)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ ¹æ®å½“å‰åæ ‡æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line">            findReDrawableBox(x, y)</span><br><span class="line">        &#125;</span><br><span class="line">        MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å½“å‰åæ ‡æ˜¯å¦åœ¨å•å…ƒæ ¼å’Œç®¡é“åŒºåŸŸå†…</span></span><br><span class="line">            <span class="keyword">if</span> (isInTouchableRegion(x, y)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (linePath.isEmpty) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¢«é‡ç½®äº†ï¼Œå…ˆç§»åŠ¨èµ·ç‚¹è‡³å½“å‰åæ ‡</span></span><br><span class="line">                    linePath.moveTo(x, y)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰è¢«é‡ç½®ï¼Œè¿æ¥ç›´çº¿è‡³å½“å‰åæ ‡</span></span><br><span class="line">                    linePath.lineTo(x, y)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ ¹æ®å½“å‰åæ ‡æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line">                findReDrawableBox(x, y)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ¸…ç©ºè½¨è¿¹çº¿ Path</span></span><br><span class="line">                linePath.reset()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é‡ç»˜View</span></span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">        MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ¸…ç©ºè½¨è¿¹çº¿ Path</span></span><br><span class="line">            linePath.reset()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é‡ç»˜View</span></span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­å½“å‰åæ ‡æ˜¯å¦åœ¨å•å…ƒæ ¼å’Œç®¡é“åŒºåŸŸå†…</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInTouchableRegion</span><span class="params">(x: <span class="type">Float</span>, y: <span class="type">Float</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> leftRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		topRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		rightRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		bottomRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		centerHorizontalRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		centerVerticalRectFList.any &#123; it.rectF.contains(x, y) &#125; ||</span><br><span class="line">    		positiveCrossRegion.contains(x.toInt(), y.toInt()) ||</span><br><span class="line">    		reverseCrossRegion.contains(x.toInt(), y.toInt())</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆåœ¨ <code>ACTION_DOWN</code> ä¸­æ¸…ç©ºè½¨è¿¹çº¿ Pathï¼Œå¹¶ç§»åŠ¨è½¨è¿¹çº¿èµ·ç‚¹è‡³å½“å‰åæ ‡ã€‚</p>
<p>ç„¶ååœ¨ <code>ACTION_MOVE</code> ä¸­å…ˆåˆ¤æ–­å½“å‰åæ ‡æ˜¯å¦åœ¨å•å…ƒæ ¼å’Œç®¡é“åŒºåŸŸå†…ï¼Œå¦‚æœä¸åœ¨åŒºåŸŸå†…ï¼Œä¸ç»˜åˆ¶è½¨è¿¹çº¿ï¼Œåˆ™é‡ç½®è½¨è¿¹çº¿ Pathï¼›å¦åˆ™å†åˆ¤æ–­è½¨è¿¹çº¿ Path æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè®¤ä¸ºå·²ç»è¢«é‡ç½®ï¼Œå…ˆç§»åŠ¨è½¨è¿¹çº¿èµ·ç‚¹è‡³å½“å‰åæ ‡ï¼Œå¦åˆ™è®¤ä¸ºæ²¡æœ‰è¢«é‡ç½®ï¼Œè¿æ¥ç›´çº¿è‡³å½“å‰åæ ‡ï¼›æœ€åé‡ç»˜ Viewã€‚</p>
<p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>onDraw</code> æ–¹æ ¼ï¼Œå¢åŠ è½¨è¿¹çº¿çš„ç»˜åˆ¶ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥ç»˜åˆ¶å•å…ƒæ ¼å’Œç®¡é“ä»£ç </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»˜åˆ¶è½¨è¿¹çº¿</span></span><br><span class="line">    drawTrackLine(canvas)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawTrackLine</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è½¨è¿¹çº¿ Path æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (linePath.isEmpty) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶è½¨è¿¹çº¿</span></span><br><span class="line">    canvas.drawPath(linePath, linePaint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view-line.png" alt="line" /></p>
<h2 id="é‡ç»˜äº¤å‰ç®¡é“"><a class="markdownIt-Anchor" href="#é‡ç»˜äº¤å‰ç®¡é“"></a> é‡ç»˜äº¤å‰ç®¡é“</h2>
<p>åœ¨æŸç±³çš„è§¦æ‘¸å±æµ‹è¯•ä¸­ï¼Œç¬”è€…å‘ç°æœ‰ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>å¦‚æœæ»‘åŠ¨æœŸé—´è¶…å‡ºç®¡é“çš„èŒƒå›´è®¤ä¸ºæ— æ•ˆã€‚</li>
<li>åªèƒ½ä»ç®¡é“ä¸€ç«¯å¼€å§‹è§¦æ‘¸ï¼Œå³ä»ç®¡é“ä¸­é—´è§¦æ‘¸è§†ä¸ºæ— æ•ˆã€‚</li>
<li>å¦‚æœä»ç®¡é“ä¸€ç«¯å¼€å§‹ï¼Œä¸æ˜¯é€šè¿‡ç®¡é“åˆ°è¾¾å¦ä¸€ç«¯è®¤ä¸ºæ— æ•ˆï¼Œå³å¼€å§‹æ—¶æ˜¯ä»ç®¡é“ä¸€ç«¯å¼€å§‹ï¼ŒæœŸé—´é€šè¿‡æ²¿å•å…ƒæ ¼æ»‘åŠ¨åˆ°è¾¾å¦ä¸€ç«¯ã€‚</li>
</ol>
<p>ä»¥ä¸Šå‡ ä¸ªé—®é¢˜ä¸­ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜ä¸Šé¢ç»˜åˆ¶è½¨è¿¹çº¿æ—¶å·²ç»è§£å†³ï¼Œä¸‹é¢æˆ‘ä»¬è§£å†³å…¶ä»–å‡ ä¸ªé—®é¢˜ã€‚</p>
<p>è§£å†³æ€è·¯ï¼š</p>
<ul>
<li>é—®é¢˜2ï¼šåˆ¤æ–­è½¨è¿¹çº¿çš„èµ·ç‚¹åæ ‡æ˜¯å¦åœ¨å››ä¸ªé¡¶ç‚¹å•å…ƒæ ¼åŒºåŸŸå†…ã€‚</li>
<li>é—®é¢˜3ï¼šåˆ¤æ–­è½¨è¿¹çº¿ä¸Šæ‰€æœ‰ç‚¹çš„åæ ‡æ˜¯å¦åœ¨ç®¡é“åŒºåŸŸå†…ã€‚</li>
</ul>
<p>é¦–å…ˆå®šä¹‰ PathMeasure å˜é‡ï¼Œç”¨äºè·å–è½¨è¿¹çº¿ Path ä¸Šå„ç‚¹çš„åæ ‡ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> linePathMeasure = PathMeasure()</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>onTouchEvent</code> æ–¹æ³•ä¸­çš„ <code>ACTION_MOVE</code> åˆ†æ”¯ä¸­å¢åŠ  <code>findReDrawableCross</code> é‡ç»˜ç®¡é“é€»è¾‘ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">when</span> (event.actionMasked) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥ ACTION_DOWN</span></span><br><span class="line">        MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å½“å‰åæ ‡æ˜¯å¦åœ¨å•å…ƒæ ¼å’Œç®¡é“åŒºåŸŸå†…</span></span><br><span class="line">            <span class="keyword">if</span> (isInTouchableRegion(x, y)) &#123;</span><br><span class="line">                <span class="comment">// çœç•¥ä¹‹å‰ä»£ç </span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ ¹æ®å½“å‰åæ ‡æŸ¥æ‰¾å¯é‡ç»˜çš„å•å…ƒæ ¼</span></span><br><span class="line">                findReDrawableBox(x, y)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ–°å¢é‡ç»˜ç®¡é“é€»è¾‘</span></span><br><span class="line">                findReDrawableCross()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœç•¥ ACTION_UPã€ACTION_CANCEL</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>findReDrawableCross</code> æ–¹æ³•ä»£ç è¾ƒå¤šä¸”ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä¸‹é¢æˆ‘æŠŠä»£ç æ‹†å¼€é€æ­¥åˆ†æã€‚</p>
<h3 id="è½¨è¿¹çº¿è·¯å¾„æµ‹é‡åŠæ ¡éªŒ"><a class="markdownIt-Anchor" href="#è½¨è¿¹çº¿è·¯å¾„æµ‹é‡åŠæ ¡éªŒ"></a> è½¨è¿¹çº¿è·¯å¾„æµ‹é‡åŠæ ¡éªŒ</h3>
<ol>
<li>é¦–å…ˆæ ¡éªŒè½¨è¿¹çº¿ Path æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¿”å›ã€‚</li>
<li>æŠŠè½¨è¿¹çº¿ Path è®¾ç½®ç»™è·¯å¾„æµ‹é‡å™¨ã€‚</li>
<li>è·å–è½¨è¿¹çº¿ Path çš„èµ·ç‚¹ä¸ç»ˆç‚¹çš„åæ ‡å¹¶æ ¡éªŒåæ ‡åˆæ³•æ€§ã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findReDrawableCross</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// è½¨è¿¹çº¿ Path ä¸ºç©ºè¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (linePath.isEmpty) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠè½¨è¿¹çº¿ Path è®¾ç½®ç»™è·¯å¾„æµ‹é‡å™¨</span></span><br><span class="line">    linePathMeasure.setPath(linePath, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">val</span> startPoint = FloatArray(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">val</span> endPoint = FloatArray(<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å– Path é•¿åº¦</span></span><br><span class="line">    <span class="keyword">val</span> linePathLength = linePathMeasure.length</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡</span></span><br><span class="line">    linePathMeasure.getPosTan(<span class="number">0F</span>, startPoint, <span class="literal">null</span>)</span><br><span class="line">    linePathMeasure.getPosTan(linePathLength, endPoint, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒèµ·ç‚¹åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> startX = startPoint[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">val</span> startY = startPoint[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (startX == <span class="number">0F</span> || startY == <span class="number">0F</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒç»ˆç‚¹åæ ‡</span></span><br><span class="line">    <span class="keyword">val</span> endX = endPoint[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">val</span> endY = endPoint[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (endX == <span class="number">0F</span> || endY == <span class="number">0F</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é‡ç»˜æ­£å‘ç®¡é“"><a class="markdownIt-Anchor" href="#é‡ç»˜æ­£å‘ç®¡é“"></a> é‡ç»˜æ­£å‘ç®¡é“</h3>
<ol>
<li>è·å–æ­£å‘ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼ã€‚</li>
<li>åˆ¤æ–­è½¨è¿¹çº¿çš„èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡æ˜¯å¦éƒ½åœ¨ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼åŒºåŸŸå†…ã€‚</li>
<li>éå†è½¨è¿¹çº¿ï¼Œåˆ¤æ–­è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡æ˜¯å¦åœ¨ç®¡é“åŒºåŸŸå†…ã€‚</li>
<li>æ ‡è®°æ­£å‘ç®¡é“å¯é‡ç»˜ã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findReDrawableCross</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥æ ¡éªŒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ­£å‘ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">val</span> lbRectF = bottomRectFList.first().rectF</span><br><span class="line">    <span class="keyword">val</span> rtRectF = topRectFList.last().rectF</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è½¨è¿¹çº¿çš„èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡æ˜¯å¦éƒ½åœ¨ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼åŒºåŸŸå†…</span></span><br><span class="line">    <span class="keyword">if</span> (((lbRectF.contains(startX, startY) &amp;&amp; rtRectF.contains(endX, endY)) ||</span><br><span class="line">         (lbRectF.contains(endX, endY) &amp;&amp; rtRectF.contains(startX, startY)))</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ mark å˜é‡ä¸º true</span></span><br><span class="line">        <span class="keyword">var</span> mark = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå†è½¨è¿¹çº¿</span></span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until linePathLength.toInt()) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡</span></span><br><span class="line">            <span class="keyword">val</span> point = FloatArray(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">val</span> posTan = linePathMeasure.getPosTan(i.toFloat(), point, <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">if</span> (!posTan) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åæ ‡æ ¡éªŒ</span></span><br><span class="line">            <span class="keyword">val</span> x = point[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">val</span> y = point[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="number">0F</span> || y == <span class="number">0F</span>) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ¤æ–­è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡æ˜¯å¦åœ¨ç®¡é“åŒºåŸŸå†…</span></span><br><span class="line">            <span class="keyword">if</span> (!positiveCrossRegion.contains(x.toInt(), y.toInt())) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mark) &#123;</span><br><span class="line">            <span class="comment">// æ ‡è®°æ­£å‘ç®¡é“å¯é‡ç»˜</span></span><br><span class="line">            markPositiveCrossReDrawable()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°æ­£å‘ç®¡é“å¯é‡ç»˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markPositiveCrossReDrawable</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!positiveCrossPath.isReDrawable) &#123;</span><br><span class="line">        positiveCrossPath.isReDrawable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é‡ç»˜åå‘ç®¡é“"><a class="markdownIt-Anchor" href="#é‡ç»˜åå‘ç®¡é“"></a> é‡ç»˜åå‘ç®¡é“</h3>
<p>åå‘ç®¡é“çš„é‡ç»˜é€»è¾‘ä¸æ­£å‘ç®¡é“ç›¸åŒï¼š</p>
<ol>
<li>è·å–åå‘ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼ã€‚</li>
<li>åˆ¤æ–­è½¨è¿¹çº¿çš„èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡æ˜¯å¦éƒ½åœ¨ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼åŒºåŸŸå†…ã€‚</li>
<li>éå†è½¨è¿¹çº¿ï¼Œåˆ¤æ–­è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡æ˜¯å¦åœ¨ç®¡é“åŒºåŸŸå†…ã€‚</li>
<li>æ ‡è®°åå‘ç®¡é“å¯é‡ç»˜ã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findReDrawableCross</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥æ ¡éªŒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–åå‘ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">val</span> ltRectF = topRectFList.first().rectF</span><br><span class="line">    <span class="keyword">val</span> rbRectF = bottomRectFList.last().rectF</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è½¨è¿¹çº¿çš„èµ·ç‚¹ä¸ç»ˆç‚¹åæ ‡æ˜¯å¦éƒ½åœ¨ç®¡é“ä¸¤ç«¯çš„å•å…ƒæ ¼åŒºåŸŸå†…</span></span><br><span class="line">    <span class="keyword">if</span> (((ltRectF.contains(startX, startY) &amp;&amp; rbRectF.contains(endX, endY)) ||</span><br><span class="line">         (ltRectF.contains(endX, endY) &amp;&amp; rbRectF.contains(startX, startY)))</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ mark å˜é‡ä¸º true</span></span><br><span class="line">        <span class="keyword">var</span> mark = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå†è½¨è¿¹çº¿</span></span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until linePathLength.toInt()) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡</span></span><br><span class="line">            <span class="keyword">val</span> point = FloatArray(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">val</span> posTan = linePathMeasure.getPosTan(i.toFloat(), point, <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">if</span> (!posTan) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åæ ‡æ ¡éªŒ</span></span><br><span class="line">            <span class="keyword">val</span> x = point[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">val</span> y = point[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> (x == <span class="number">0F</span> || y == <span class="number">0F</span>) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ¤æ–­è½¨è¿¹çº¿ä¸Šç‚¹çš„åæ ‡æ˜¯å¦åœ¨ç®¡é“åŒºåŸŸå†…</span></span><br><span class="line">            <span class="keyword">if</span> (!reverseCrossRegion.contains(x.toInt(), y.toInt())) &#123;</span><br><span class="line">                mark = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mark) &#123;</span><br><span class="line">            <span class="comment">// æ ‡è®°åå‘ç®¡é“å¯é‡ç»˜</span></span><br><span class="line">            markReverseCrossReDrawable()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°åå‘ç®¡é“å¯é‡ç»˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markReverseCrossReDrawable</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!reverseCrossPath.isReDrawable) &#123;</span><br><span class="line">        reverseCrossPath.isReDrawable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç»˜äº¤å‰ç®¡é“çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view-cross.png" alt="cross" /></p>
<h2 id="æµ‹è¯•å®Œæˆ"><a class="markdownIt-Anchor" href="#æµ‹è¯•å®Œæˆ"></a> æµ‹è¯•å®Œæˆ</h2>
<p>æœ€åæˆ‘ä»¬è¿˜å‰©ä¸‹è§¦æ‘¸å±æµ‹è¯•å®Œæˆçš„åˆ¤æ–­ä»¥åŠå¯¹å¤–æä¾›æµ‹è¯•å®Œæˆçš„å›è°ƒï¼Œå¹¶ä¸”æµ‹è¯•å®Œæˆåä¸å†ç»˜åˆ¶è½¨è¿¹çº¿ã€‚</p>
<p>å®šä¹‰æµ‹è¯•å®Œæˆçš„å›è°ƒï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">TouchPassListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onTouchPass</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰æ˜¯å¦æµ‹è¯•å®Œæˆå˜é‡ä¸æµ‹è¯•å®Œæˆå›è°ƒå˜é‡ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> isPassed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> mTouchPassListener: TouchPassListener? = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>æ–°å¢ <code>isTouchPass</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­åˆ¤æ–­æ‰€æœ‰å•å…ƒæ ¼å’Œç®¡é“æ˜¯å¦éƒ½è¢«æ ‡è®°ä¸ºå¯é‡ç»˜çš„ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isTouchPass</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> leftRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		topRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		rightRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		bottomRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		centerHorizontalRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		centerVerticalRectFList.all &#123; it.isReDrawable &#125; &amp;&amp;</span><br><span class="line">    		positiveCrossPath.isReDrawable &amp;&amp;</span><br><span class="line">    		reverseCrossPath.isReDrawable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨æ ‡è®°å•å…ƒæ ¼å’Œç®¡é“ä¸ºå¯é‡ç»˜çš„æ–¹æ³•ä¸­è°ƒç”¨ <code>isTouchPass</code> æ–¹æ³•å³å¯ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markBoxReDrawable</span><span class="params">(rectF: <span class="type">TouchRectF</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rectF.isReDrawable) &#123;</span><br><span class="line">        rectF.isReDrawable = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isTouchPass()) &#123;</span><br><span class="line">            touchPass()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markPositiveCrossReDrawable</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!positiveCrossPath.isReDrawable) &#123;</span><br><span class="line">        positiveCrossPath.isReDrawable = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isTouchPass()) &#123;</span><br><span class="line">            touchPass()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">markReverseCrossReDrawable</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!reverseCrossPath.isReDrawable) &#123;</span><br><span class="line">        reverseCrossPath.isReDrawable = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isTouchPass()) &#123;</span><br><span class="line">            touchPass()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">touchPass</span><span class="params">()</span></span> &#123;</span><br><span class="line">    isPassed = <span class="literal">true</span></span><br><span class="line">    mTouchPassListener?.onTouchPass()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/android/touch-view/touch-view-complete.png" alt="touch-view-complete" /></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>view</tag>
      </tags>
  </entry>
  <entry>
    <title>Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(ä¸€)</title>
    <url>/2022/09/20/gosp/sword/00-sword/</url>
    <content><![CDATA[<h1 id="sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½ä¸€"><a class="markdownIt-Anchor" href="#sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½ä¸€"></a> Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(ä¸€)</h1>
<h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h2>
<p>Swordï¼šä¸€ä¸ªå¯ä»¥ç»™ Kotlin å‡½æ•°å¢åŠ ä»£ç†çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŸºäº KCP å®ç°ã€‚</p>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>ä¸ºä»€ä¹ˆå†™è¿™ä¸ªåº“å‘¢ï¼Ÿç¬”è€…åœ¨å­¦ä¹  Retrofit æ—¶ï¼Œå†™è¿‡ä¸€ç¯‡æ–‡ç«  <a href="https://sunxiaodou.com/book/SourceCodeAnalysis/Retrofit/2.%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.html">Retrofitå­¦ä¹ æ—¥è®°-åŠ¨æ€ä»£ç†</a>ï¼Œåœ¨è¿™æ—¶å€™ç¬”è€…å°±èŒç”Ÿäº†ä¸ºå‡½æ•°/æ–¹æ³•ä¹Ÿå¢åŠ ä»£ç†åŠŸèƒ½çš„æƒ³æ³•ã€‚</p>
<p>æ­£å¥½ç¬”è€…ä¹‹å‰å°±æœ‰æŠŠæŸä¸ªå‡½æ•°/æ–¹æ³•æ ‡è®°ä¸ºå¼€å‘è°ƒè¯•æ–¹æ³•çš„éœ€æ±‚ï¼šåœ¨å¼€å‘è°ƒè¯•é˜¶æ®µå¯ä»¥æ‰§è¡Œï¼Œæ­£å¼å‘å¸ƒä¹‹åå°±ä¸å¯æ‰§è¡Œã€‚è¦å®ç°è¿™ç§éœ€æ±‚ï¼Œç¬”è€…å¯ä»¥åˆ—ä¸¾ä¸‹è‡ªå·±æƒ³åˆ°çš„æ–¹æ¡ˆï¼š</p>
<ol>
<li>åœ¨å‡½æ•°/æ–¹æ³•ä¸­é€šè¿‡ <code>BuildConfig#DEBUG</code> åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼šæ­¤æ–¹æ¡ˆæœ€ç®€å•ï¼Œåœ¨ç¼–ç æœŸä¾èµ–å¼€å‘äººå‘˜æ‰‹åŠ¨å®ç°ï¼Œä½†æ˜¯ç¼–ç è¿‡ç¨‹æ¯”è¾ƒç¹çä¸”ç´¢ç„¶æ— å‘³ï¼Œ</li>
<li>ä¸ºå‡½æ•°/æ–¹æ³•å¢åŠ æŸä¸ªæ³¨è§£ï¼Œé€šè¿‡ä¿®æ”¹å‡½æ•°/æ–¹æ³•çš„å­—èŠ‚ç å¢åŠ åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰§è¡Œé€»è¾‘ï¼šæ­¤æ–¹æ¡ˆå®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦äº†è§£ä¸€äº›å­—èŠ‚ç ä¿¡æ¯ï¼Œä½†æ˜¯å®ç°åä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ä¸”ä¸€åŠ³æ°¸é€¸ã€‚</li>
</ol>
<p>ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œå…¶å®å¯ä»¥å‘ç°ï¼š<strong>ä¸ºå‡½æ•°/æ–¹æ³•å¢åŠ ä»£ç†åŠŸèƒ½</strong> å¯ä»¥å®ç° <strong>æŠŠæŸä¸ªå‡½æ•°/æ–¹æ³•æ ‡è®°ä¸ºå¼€å‘è°ƒè¯•æ–¹æ³•çš„éœ€æ±‚</strong>ã€‚</p>
<p>ç»è¿‡ä¸€ç•ªæ€æƒ³æ–—äº‰ï¼Œç¬”è€…é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œç„¶åç»“åˆ <strong>ä¸ºå‡½æ•°/æ–¹æ³•ä¹Ÿå¢åŠ ä»£ç†åŠŸèƒ½çš„æƒ³æ³•</strong> ï¼Œæ‰€ä»¥æœ€ç»ˆé€‰å‹ä¸ºï¼šæ³¨è§£ + KCP + ASMã€‚</p>
<p>åˆæ­£å¥½ç¬”è€…ä¹‹å‰å†™è¿‡å‡ ç¯‡å…³äº KCP çš„æ–‡ç« ï¼š</p>
<ol>
<li><a href="https://sunxiaodou.com/2022/05/08/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E7%AC%AC%E4%B8%80%E7%AF%87/">Kotlin-KCPçš„åº”ç”¨-ç¬¬ä¸€ç¯‡</a></li>
<li><a href="https://sunxiaodou.com/2022/05/12/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E7%AC%AC%E4%BA%8C%E7%AF%87/">Kotlin-KCPçš„åº”ç”¨-ç¬¬äºŒç¯‡</a></li>
<li><a href="https://sunxiaodou.com/2022/05/23/Kotlin/Kotlin-KCP%E7%9A%84%E5%BA%94%E7%94%A8-%E4%BF%AE%E6%94%B9SDK%E7%89%88%E6%9C%AC%E5%8F%B7/">Kotlin-KCPçš„åº”ç”¨-ä¿®æ”¹SDKç‰ˆæœ¬å·</a></li>
</ol>
<p>åœ¨ä¸Šé¢çš„ KCP æ–‡ç« ä¸­ï¼Œç¬”è€…è®°å½•äº†æ­å»º KCP å¼€å‘ç¯å¢ƒçš„è¿‡ç¨‹ï¼Œé€šè¿‡é˜…è¯»ä¸Šé¢çš„æ–‡ç« å¯ä»¥å¿«é€Ÿæ­å»ºä¸€ä¸ª KCP å¼€å‘ç¯å¢ƒã€‚</p>
<p>æœ¬æ–‡è®°å½•ä¸‹ Sword çš„é¡¹ç›®ç»“æ„åŠå‰æœŸçš„å¼€å‘ç¯å¢ƒæ­å»ºï¼Œåç»­æ–‡ç« å†åˆ†æ Sword çš„æ ¸å¿ƒä»£ç éƒ¨åˆ†ï¼Œä¸‹é¢è®©æˆ‘ä»¬å…ˆçœ‹çœ‹é¡¹ç›®ç»“æ„å§ã€‚</p>
<h2 id="é¡¹ç›®ç»“æ„"><a class="markdownIt-Anchor" href="#é¡¹ç›®ç»“æ„"></a> é¡¹ç›®ç»“æ„</h2>
<p><img data-src="/imgs/gosp/sword/00-00-project.png" alt="project" /></p>
<ul>
<li><strong>api-kotlin</strong>ï¼šAPI æ¨¡å—ï¼Œå®šä¹‰ç›¸å…³çš„æ³¨è§£ API ç±»ï¼Œ</li>
<li><strong>compiler</strong>ï¼šksp æ¨¡å—ï¼Œè¾…åŠ© Sword ç”Ÿæˆå¸¸é‡ç±»ï¼Œåç»­æ–‡ç« å†è®²ï¼Œ</li>
<li><strong>kcp</strong>ï¼škcp æ¨¡å—ï¼Œå®ç° Gradle Plugin å’Œ Kotlin Compiler Pluginã€‚</li>
</ul>
<h2 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h2>
<h3 id="proxy"><a class="markdownIt-Anchor" href="#proxy"></a> Proxy</h3>
<p>é¦–å…ˆåˆ›å»º API æ¨¡å—å¹¶å®šä¹‰ <code>Proxy</code> æ³¨è§£ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(AnnotationTarget.FUNCTION)</span></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.BINARY)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦å¯ç”¨, é»˜è®¤True</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> enable: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [InvocationHandler]å®ç°ç±»çš„å…¨é™å®šå, å®ç°ç±»å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * e.g. com.example.ProxyTestInvocationHandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> handler: String = <span class="string">&quot;&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>Proxy</code> æ³¨è§£ä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ol>
<li><strong>enable</strong>ï¼šè¡¨ç¤ºæ˜¯å¦ä¸ºå‡½æ•°å¯ç”¨ä»£ç†ï¼Œé»˜è®¤ <code>True</code>ï¼Œ</li>
<li><strong>handler</strong>ï¼šè¡¨ç¤ºä»£ç†å‡½æ•°å¤„ç†ç±»çš„<strong>å…¨é™å®šå</strong>ï¼Œ<strong>æ­¤å¤„ç†ç±»å¿…é¡»å®ç° <code>InvocationHandler</code> æ¥å£ï¼Œä¸”å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•</strong>ã€‚</li>
</ol>
<h3 id="invocationhandler"><a class="markdownIt-Anchor" href="#invocationhandler"></a> InvocationHandler</h3>
<p>å…ˆçœ‹ä¸‹ Java åŠ¨æ€ä»£ç†æ¥å£ <code>java.lang.reflect.InvocationHandler</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ä»¿ç…§ Java çš„åŠ¨æ€ä»£ç†æ¥å£å®šä¹‰æˆ‘ä»¬çš„æ¥å£ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// kt</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(className: <span class="type">String</span>, methodName: <span class="type">String</span>, args: <span class="type">Array</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸¤è€…æ˜¯ä¸æ˜¯æ¯”è¾ƒç›¸ä¼¼å‘¢ï¼Ÿä½†æ˜¯åè€…çš„æ¥å£æ–¹æ³•å‚æ•°æœ‰æ‰€ä¸åŒï¼š</p>
<ol>
<li><strong>className</strong>ï¼šè¡¨ç¤ºå½“å‰ä»£ç†æ–¹æ³•æ‰€åœ¨çš„ç±»åï¼Œ</li>
<li><strong>methodName</strong>ï¼šè¡¨ç¤ºå½“å‰ä»£ç†æ–¹æ³•çš„åç§°ï¼Œ</li>
<li><strong>args</strong>ï¼šè¡¨ç¤ºå½“å‰ä»£ç†æ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚</li>
</ol>
<p>åœ¨å®ç°æ–¹å¼ä¸Šä¹Ÿæœ‰æ‰€ä¸åŒï¼š</p>
<ol>
<li>Java åŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºå¹¶åŠ è½½ Classï¼Œç„¶åé€šè¿‡åå°„è°ƒç”¨ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œ</li>
<li>Sword å‹‰å¼ºå±äºé™æ€ä»£ç†å§ï¼Œåœ¨ç¼–è¯‘æœŸä¿®æ”¹å­—èŠ‚ç ï¼Œæ²¡æœ‰ç»è¿‡åå°„è°ƒç”¨ï¼ŒåŸºæœ¬æ²¡æœ‰æ€§èƒ½å¼€é”€ã€‚</li>
</ol>
<p>API ç›¸å…³å®šä¹‰å®Œæˆï¼Œæ¥ä¸‹æ¥å¼€å§‹ç¼–å†™ KCP å§ã€‚</p>
<h2 id="kcp"><a class="markdownIt-Anchor" href="#kcp"></a> KCP</h2>
<p>å¯¹ KCP ä¸å¤ªäº†è§£çš„è¯»è€…å¯ä»¥å…ˆçœ‹ä¸‹ä¸Šé¢åˆ—ä¸¾çš„å‡ ç¯‡æ–‡ç« ã€‚è¿™é‡Œå†è´´ä¸‹ KCP çš„æ¶æ„å›¾å§ï¼š</p>
<p><img data-src="/imgs/gosp/sword/00-01-kcp-architecture.png" alt="kcp-architecture" /></p>
<h3 id="gradle-plugin"><a class="markdownIt-Anchor" href="#gradle-plugin"></a> Gradle Plugin</h3>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SwordGradlePlugin</span> : <span class="type">KotlinCompilerPluginSupportPlugin</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(target: <span class="type">Project</span>)</span></span> = with(target) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Welcome to guodongAndroid sword kcp gradle plugin.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isApplicable</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCompilerPluginId</span><span class="params">()</span></span>: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPluginArtifact</span><span class="params">()</span></span>: SubpluginArtifact = SubpluginArtifact(</span><br><span class="line">        groupId = BuildConfig.KOTLIN_PLUGIN_GROUP,</span><br><span class="line">        artifactId = BuildConfig.KOTLIN_PLUGIN_NAME,</span><br><span class="line">        version = BuildConfig.KOTLIN_PLUGIN_VERSION,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyToCompilation</span><span class="params">(kotlinCompilation: <span class="type">KotlinCompilation</span>&lt;*&gt;)</span></span>: Provider&lt;List&lt;SubpluginOption&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> project = kotlinCompilation.target.project</span><br><span class="line">        <span class="keyword">return</span> project.provider &#123; emptyList() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹ç›®å‰çš„ Sword æ¥è¯´ï¼Œå®ƒä¸éœ€è¦ä»»ä½•å‚æ•°å’Œé…ç½®é¡¹ã€‚æ‰€ä»¥ <strong>Gradle Plugin</strong> å°±ä¸€ä¸ª <code>SwordGradlePlugin</code> ç±»ï¼Œæ¯”è¾ƒç®€å•ï¼Œåœ¨å…¶ä¸­é…ç½®ä¸‹ <em>PluginId</em> å’Œ KCP çš„ <em>SubpluginArtifact</em> å³å¯ã€‚</p>
<h3 id="kotlin-compiler-plugin"><a class="markdownIt-Anchor" href="#kotlin-compiler-plugin"></a> Kotlin Compiler Plugin</h3>
<h4 id="commandlineprocessor"><a class="markdownIt-Anchor" href="#commandlineprocessor"></a> CommandLineProcessor</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(CommandLineProcessor::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SwordCommandLineProcessor</span> : <span class="type">CommandLineProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginId: String = BuildConfig.KOTLIN_PLUGIN_ID</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pluginOptions: Collection&lt;AbstractCliOption&gt; = emptyList()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CommandLineProcessor</code> ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€é…ç½® <code>PluginId</code>ï¼Œæ²¡æœ‰ä»»ä½•å‚æ•°å’Œé…ç½®é¡¹ã€‚</p>
<h4 id="componentregistrar"><a class="markdownIt-Anchor" href="#componentregistrar"></a> ComponentRegistrar</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService(ComponentRegistrar::class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SwordComponentRegistrar</span> : <span class="type">ComponentRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerProjectComponents</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        project: <span class="type">MockProject</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        configuration: <span class="type">CompilerConfiguration</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> messageCollector =</span><br><span class="line">            configuration.<span class="keyword">get</span>(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY, MessageCollector.NONE)</span><br><span class="line"></span><br><span class="line">        messageCollector.report(</span><br><span class="line">            CompilerMessageSeverity.WARNING,</span><br><span class="line">            <span class="string">&quot;Welcome to guodongAndroid sword kcp kotlin plugin&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        ClassBuilderInterceptorExtension.registerExtension(</span><br><span class="line">            project,</span><br><span class="line">            SwordClassGenerationInterceptor(messageCollector)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ComponentRegistrar</code> çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼šé¦–å…ˆè·å– <code>MessageCollector</code> ç”¨äºæ—¥å¿—è¾“å‡ºï¼Œç„¶åæ³¨å†Œä¸€ä¸ª <code>ClassBuilder</code> æ‹¦æˆªå™¨ç”¨äºæ‹¦æˆªç±»çš„ç”Ÿæˆã€‚</p>
<h4 id="classbuilderinterceptorextension"><a class="markdownIt-Anchor" href="#classbuilderinterceptorextension"></a> ClassBuilderInterceptorExtension</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SwordClassGenerationInterceptor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> messageCollector: MessageCollector,</span><br><span class="line">) : ClassBuilderInterceptorExtension &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">interceptClassBuilderFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        interceptedFactory: <span class="type">ClassBuilderFactory</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bindingContext: <span class="type">BindingContext</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        diagnostics: <span class="type">DiagnosticSink</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: ClassBuilderFactory = <span class="keyword">object</span> : ClassBuilderFactory <span class="keyword">by</span> interceptedFactory &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newClassBuilder</span><span class="params">(origin: <span class="type">JvmDeclarationOrigin</span>)</span></span>: ClassBuilder &#123;</span><br><span class="line">            <span class="keyword">return</span> SwordClassBuilder(messageCollector, interceptedFactory.newClassBuilder(origin))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç° <code>ClassBuilderInterceptorExtension</code> æ¥å£æ–¹æ³• <code>interceptClassBuilderFactory</code>ï¼Œè¿”å›ä¸€ä¸ª <code>ClassBuilderFactory</code>ï¼Œåœ¨ <code>newClassBuilder</code> ä¸­åšæ‹¦æˆªï¼ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ <code>ClassBuilder</code> ç®—æ˜¯ Sword çš„æ ¸å¿ƒä»£ç äº†ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡åªæ˜¯è®°å½•äº† Sword çš„é¡¹ç›®ç»“æ„åŠå‰æœŸçš„å¼€å‘ç¯å¢ƒæ­å»ºè¿‡ç¨‹ï¼Œå¯ä»¥çœ‹å‡º KCP çš„å¼€å‘ç¯å¢ƒæ­å»ºæ˜¯æœ‰è¿¹å¯å¾ªï¼Œæœ‰æ¨¡æ¿å¯ä¾ï¼Œæ­¤æ¬¡çš„æ­å»ºè¿‡ç¨‹ä¸ä¹‹å‰çš„ Mask å’Œ ä¿®æ”¹ SDK ç‰ˆæœ¬å·å¤§åŒå°å¼‚ï¼Œç¬”è€…åç»­ä¼šæä¾›ä¸€ä¸ª KCP å¼€å‘ç¯å¢ƒçš„æ¨¡æ¿å·¥ç¨‹ä¾›å¤§å®¶å‚è€ƒã€‚</p>
<p>åœ¨å­¦ä¹ æˆ–å·¥ä½œä¸­æœ‰å¥½çš„æƒ³æ³•ä¸€å®šè¦åŠæ—¶è®°å½•ä¸‹æ¥ï¼Œä¸è¦ç€æ€¥å»å®ç°ä½ çš„æƒ³æ³•ï¼Œè®¤çœŸæ€è€ƒå‡ ç§å®ç°æ–¹æ¡ˆï¼Œä»”ç»†è¡¡é‡æ–¹æ¡ˆä¸­çš„åˆ©å¼Šï¼Œé€‰æ‹©ä¸€ä¸ªä½ è®¤ä¸ºå¥½çš„æ–¹æ¡ˆåå†å¼€å§‹åšå®ç°ã€‚</p>
<p><strong>å“¦ï¼Œå¯¹äº†ï¼Œæœ‰æƒ³æ³•ä¸€å®šè¦å»å®è·µï¼Œä¸è¦åªæ˜¯è®°å½•ä¸‹æ¥ï¼</strong></p>
<p>ä¸‹ç¯‡å†è§ï¼Œhappy~</p>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(äºŒ)</title>
    <url>/2022/10/11/gosp/sword/01-sword/</url>
    <content><![CDATA[<h1 id="sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½äºŒ"><a class="markdownIt-Anchor" href="#sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½äºŒ"></a> Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(äºŒ)</h1>
<h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h2>
<p>Swordï¼šä¸€ä¸ªå¯ä»¥ç»™ Kotlin å‡½æ•°å¢åŠ ä»£ç†çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŸºäº KCP å®ç°ã€‚</p>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>ç»­æ¥ <a href="https://sunxiaodou.com/2022/09/20/gosp/sword/00-sword/">ä¸Šç¯‡</a>ï¼Œåœ¨ä¸Šç¯‡æ–‡ç« ä¸­ç¬”è€…è®°å½•äº†æ­å»º Sword çš„åŸºç¡€å¼€å‘ç¯å¢ƒä»¥åŠæŠ€æœ¯é€‰å‹ä¸ºï¼šæ³¨è§£ + KCP + ASMã€‚æœ¬æ–‡ä¸»è¦è®°å½•ä½¿ç”¨ ASM çš„å®ç°è¿‡ç¨‹ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ä¸Šç¯‡æ–‡ç« æœ€åæ²¡æœ‰è®°å½•çš„ <code>ClassBuilder</code>ã€‚</p>
<h2 id="classbuilder"><a class="markdownIt-Anchor" href="#classbuilder"></a> ClassBuilder</h2>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> annotations: List&lt;FqName&gt; = listOf(</span><br><span class="line">    FqName(<span class="string">&quot;com.guodong.android.sword.api.kt.Proxy&quot;</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    origin: <span class="type">JvmDeclarationOrigin</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    access: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    desc: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    signature: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    exceptions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: MethodVisitor &#123;</span><br><span class="line">    <span class="keyword">val</span> newMethod = <span class="keyword">super</span>.newMethod(origin, access, name, desc, signature, exceptions)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> function = origin.descriptor <span class="keyword">as</span>? FunctionDescriptor ?: <span class="keyword">return</span> newMethod</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (function.isOperator ||</span><br><span class="line">        function.isInfix ||</span><br><span class="line">        function.isInline ||</span><br><span class="line">        function.isSuspend ||</span><br><span class="line">        function.isTailrec</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">return</span> newMethod</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (annotations.none &#123; function.annotations.hasAnnotation(it) &#125;) &#123;</span><br><span class="line">        <span class="keyword">return</span> newMethod</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> className = delegate.thisName</span><br><span class="line"></span><br><span class="line">    messageCollector.report(</span><br><span class="line">        CompilerMessageSeverity.WARNING,</span><br><span class="line">        <span class="string">&quot;Sword className = <span class="variable">$className</span>, methodName = <span class="variable">$name</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> realClassName = className.substring(className.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SwordAdapter(</span><br><span class="line">        Opcodes.ASM9,</span><br><span class="line">        newMethod,</span><br><span class="line">        realClassName,</span><br><span class="line">        access,</span><br><span class="line">        name,</span><br><span class="line">        desc</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>ClassBuilder</code> ä¸­ä¸»è¦è¦†å†™ <code>newMethod</code> å‡½æ•°æ‹¦æˆª Java æ–¹æ³•çš„ç”Ÿæˆï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°æè¿°ç¬¦ï¼Œå¦åˆ™ç›´æ¥è¿”å›ï¼Œ</li>
<li>è‹¥æ˜¯æ“ä½œç¬¦é‡è½½ã€ä¸­ç¼€ã€å†…è”ã€æŒ‚èµ·ä»¥åŠå°¾é€’å½’å‡½æ•°ï¼Œä¸äºˆå¤„ç†ï¼Œç›´æ¥è¿”å›ï¼Œ</li>
<li>å‡½æ•°è‹¥æ˜¯ä¸å­˜åœ¨ <code>Proxy</code> æ³¨è§£ï¼Œä¸äºˆå¤„ç†ï¼Œç›´æ¥è¿”å›ï¼Œ</li>
<li>è·å–çœŸå®çš„ç±»åï¼Œäº¤äºˆ <code>SwordAdapter</code> å¤„ç†ã€‚</li>
</ol>
<p>å¯ä»¥çœ‹å‡ºåœ¨ <code>ClassBuilder</code> ä¸­ä¸»è¦æ˜¯å®ç°äº†ä¸€äº›æ ¡éªŒé€»è¾‘ï¼Œç¬¬ 2 æ­¥ä¸­çš„è¿‡æ»¤é€»è¾‘å¯å¢åŠ é…ç½®å‚æ•°æä¾›ç»™é›†æˆæ–¹åœ¨å¤–éƒ¨çµæ´»é…ç½®ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ <code>SwordAdapter</code> æ˜¯å¦‚ä½•å¤„ç†çš„å§ã€‚</p>
<h2 id="swordadapter"><a class="markdownIt-Anchor" href="#swordadapter"></a> SwordAdapter</h2>
<p><code>SwordAdapter</code> çš„é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œç¬”è€…å…ˆæè¿°ä¸‹è‡ªå·±çš„å®ç°æ€è·¯ï¼Œç„¶åå†æŒ‰ç…§æ€è·¯ä¸€ç‚¹ç‚¹åˆ†æã€‚</p>
<ol>
<li>
<p>é¦–å…ˆé€šè¿‡ ASM åˆ¤æ–­å½“å‰å‡½æ•°æ˜¯å¦å­˜åœ¨ <code>Proxy</code> æ³¨è§£ï¼Œè‹¥å­˜åœ¨åˆ™è§£æå‡ºæ³¨è§£ä¸­çš„æ•°æ®æš‚å­˜èµ·æ¥ï¼Œå¦åˆ™ä¸äºˆè½¬æ¢ï¼Œ</p>
</li>
<li>
<p>è‹¥å­˜åœ¨<code>Proxy</code> æ³¨è§£å¹¶è§£æå‡ºæ³¨è§£ä¸­çš„æ•°æ®ï¼Œåˆ™æ ¹æ®æ³¨è§£ä¸­çš„ <code>enable</code> å­—æ®µåˆ¤æ–­æ˜¯å¦å¯ç”¨ä»£ç†ï¼Œè‹¥å¯ç”¨åˆ™è¿›è¡Œè½¬æ¢ï¼Œå¦åˆ™ä¸äºˆè½¬æ¢ï¼Œ</p>
</li>
<li>
<p>è‹¥è¿›è¡Œè½¬æ¢ï¼Œå†åˆ¤æ–­æ³¨è§£ä¸­çš„ <code>handler</code> å­—æ®µæ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯ç©ºå­—ç¬¦ä¸²åˆ™è¿›è¡Œç®€å•çš„è½¬æ¢ï¼Œå¦åˆ™è¿›è¡Œä»£ç†è½¬æ¢ï¼Œ</p>
</li>
<li>
<p>ç®€å•è½¬æ¢ï¼šæ ¹æ®å‡½æ•°è¿”å›ç±»å‹åˆ¤æ–­</p>
<ol>
<li>æ— è¿”å›å€¼ç±»å‹è¿”å› <code>void</code>ï¼Œ</li>
<li>åŸºæœ¬æ•°æ®ç±»å‹è¿”å›ï¼š<code>-1</code>ï¼Œ<code>char</code> ç±»å‹è¿”å› <code>48</code>ï¼Œ</li>
<li>å¼•ç”¨ç±»å‹è¿”å› <code>null</code>ã€‚</li>
</ol>
</li>
<li>
<p>ä»£ç†è½¬æ¢ï¼šæ›¿æ¢<code>handler</code>å­—æ®µä¸­çš„å…¨é™å®šåï¼Œè°ƒç”¨<code>InvocationHandler#invoke</code>å‡½æ•°ã€‚</p>
</li>
</ol>
<p>ä¸‹é¢çš„æµç¨‹å›¾çœ‹èµ·æ¥å¯èƒ½æ›´æ¸…æ¥šä¸€äº›ï¼š</p>
<p><img data-src="/imgs/gosp/sword/01-00-codeflow.png" alt="code flow" /></p>
<h3 id="è§£ææ³¨è§£"><a class="markdownIt-Anchor" href="#è§£ææ³¨è§£"></a> è§£ææ³¨è§£</h3>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ª <code>Proxy</code> æ³¨è§£æ•°æ®å®ä½“ç±»ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">SwordParam</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦æœ‰[Proxy]æ³¨è§£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> hasProxyAnnotation: <span class="built_in">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦å¯ç”¨, é»˜è®¤True</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> enable: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [InvocationHandler]å®ç°ç±»çš„å…¨é™å®šå, å®ç°ç±»å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * e.g. com.example.ProxyTestInvocationHandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> handler: String = <span class="string">&quot;&quot;</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸[Proxy]æ³¨è§£çš„å‚æ•°åä¸€ä¸€å¯¹åº”</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keyword">val</span> PARAM_ENABLE = <span class="string">&quot;enable&quot;</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keyword">val</span> PARAM_HANDLER = <span class="string">&quot;handler&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å®ä½“ç±»å­˜å‚¨ <code>Proxy</code> æ³¨è§£ä¸­è§£æå‡ºæ¥çš„æ•°æ®ï¼Œä¸‹é¢å°±æ˜¯è§£æ <code>Proxy</code> æ³¨è§£äº†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€äº›å¸¸é‡</span></span><br><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> PROXY_KT_DESC = <span class="string">&quot;Lcom/guodong/android/sword/api/kt/Proxy;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> KT_INVOCATION_HANDLER_OWNER =</span><br><span class="line">    <span class="string">&quot;com/guodong/android/sword/api/kt/InvocationHandler&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> INVOKE_METHOD = <span class="string">&quot;invoke&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> INVOCATION_HANDLER_INVOKE_DESC =</span><br><span class="line">    <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> proxyDesc = listOf(PROXY_KT_DESC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜æ³¨è§£æ•°æ®å®ä½“å˜é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> param = SwordParam()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦†å†™`visitAnnotation`</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visitAnnotation</span><span class="params">(descriptor: <span class="type">String</span>, visible: <span class="type">Boolean</span>)</span></span>: AnnotationVisitor &#123;</span><br><span class="line">    <span class="keyword">var</span> av = <span class="keyword">super</span>.visitAnnotation(descriptor, visible)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨`Proxy`æ³¨è§£</span></span><br><span class="line">    <span class="keyword">if</span> (proxyDesc.contains(descriptor)) &#123;</span><br><span class="line">        param.hasProxyAnnotation = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (av != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è§£æ`Proxy`æ³¨è§£</span></span><br><span class="line">            av = AnnotationAdapter(api, av, param)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> av</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£ææ³¨è§£æ•°æ®ä¸»è¦è¦†å†™ <code>visitAnnotation</code> å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ <code>Proxy</code> æ³¨è§£ï¼Œè‹¥å­˜åœ¨åˆ™è¿›è¡Œè§£æï¼Œå¦åˆ™ä¸äºˆå¤„ç†ã€‚</p>
<p>è§£æé€»è¾‘å°±åœ¨ä¸‹é¢ä»£ç çš„ <code>AnnotationAdapter</code> ä¸­äº†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">AnnotationAdapter</span>(</span><br><span class="line">    api: <span class="built_in">Int</span>,</span><br><span class="line">    annotationVisitor: AnnotationVisitor?,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> param: SwordParam</span><br><span class="line">) : AnnotationVisitor(api, annotationVisitor) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visit</span><span class="params">(name: <span class="type">String</span>, value: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (name) &#123;</span><br><span class="line">            SwordParam.PARAM_ENABLE -&gt; param.enable = (value <span class="keyword">as</span> <span class="built_in">Boolean</span>)</span><br><span class="line">            SwordParam.PARAM_HANDLER -&gt; param.handler = (value <span class="keyword">as</span> String)</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè§£æé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨ <code>visit</code> å‡½æ•°ä¸­ï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ªå‚æ•° <code>name</code> è¡¨ç¤ºæ³¨è§£ä¸­å‚æ•°çš„åç§°ï¼Œç¬¬äºŒå‚æ•° <code>value</code>è¡¨ç¤ºæ³¨è§£ä¸­å‚æ•°çš„å€¼ï¼Œ</li>
<li>é€šè¿‡æ¯”å¯¹ <code>name</code> å‚æ•°çš„åç§°æ¥è§£ææ³¨è§£ä¸­çš„æ•°æ®å¹¶å­˜å‚¨åœ¨å®ä½“ä¸­ã€‚</li>
</ol>
<p>è‡³æ­¤è§£æ <code>Proxy</code> æ³¨è§£å®Œæˆï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°æ³¨è§£ä¸­çš„æ•°æ®ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è½¬æ¢äº†ã€‚</p>
<h3 id="è½¬æ¢åˆ†æ”¯"><a class="markdownIt-Anchor" href="#è½¬æ¢åˆ†æ”¯"></a> è½¬æ¢åˆ†æ”¯</h3>
<p>å¯¹å‡½æ•°ä»£ç†åŠŸèƒ½çš„è½¬æ¢ï¼Œç¬”è€…å®ç°äº†ä¸¤ç§è½¬æ¢åˆ†æ”¯ï¼š</p>
<ol>
<li><strong>ç®€å•è½¬æ¢</strong>ï¼šæˆ–è€…ç§°ä¸ºé»˜è®¤è½¬æ¢ï¼Œå°±åƒ <code>switch</code> æœ‰ <code>default</code> åˆ†æ”¯ä¸€æ ·ï¼Œ</li>
<li><strong>ä»£ç†è½¬æ¢</strong>ï¼šçœŸæ­£çš„ä»£ç†åŠŸèƒ½å®ç°ã€‚</li>
</ol>
<p>è½¬æ¢é€»è¾‘åœ¨ <code>visitCode</code> å‡½æ•°ä¸­å¤„ç†ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è½¬æ¢åˆ†æ”¯çš„é€‰æ‹©ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">visitCode</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰`Proxy`æ³¨è§£ä¸”æ˜¯å¦å¯ç”¨ä»£ç†</span></span><br><span class="line">    <span class="keyword">if</span> (param.hasProxyAnnotation &amp;&amp; param.enable) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»‡å…¥ä¸€ä¸ª`booelan`å€¼ï¼šTrue</span></span><br><span class="line">        <span class="keyword">super</span>.visitInsn(Opcodes.ICONST_1)</span><br><span class="line">        <span class="keyword">val</span> label = Label()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»‡å…¥`if`åˆ¤æ–­è¯­å¥</span></span><br><span class="line">        <span class="keyword">super</span>.visitJumpInsn(Opcodes.IFEQ, label)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–`methodType`</span></span><br><span class="line">        <span class="keyword">val</span> methodType = Type.getMethodType(</span><br><span class="line">            methodDescriptor</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–`returnType`ï¼Œå‡½æ•°çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">        <span class="keyword">val</span> returnType = methodType.returnType</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> handler = param.handler</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­`handler`æ˜¯å¦æ˜¯ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">if</span> (handler.isNotEmpty()) &#123;</span><br><span class="line">            <span class="comment">// ä»£ç†è½¬æ¢</span></span><br><span class="line">            weaveHandler(methodType, returnType, handler)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç®€å•è½¬æ¢</span></span><br><span class="line">            weaveDefaultValue(returnType)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.visitLabel(label)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.visitCode()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>visitCode</code> å‡½æ•°çš„å‰éƒ¨åˆ†æ˜¯ä¸€äº›åˆ¤æ–­å¤„ç†ï¼š</p>
<ol>
<li>å¦‚æœæœ‰<code>Proxy</code>æ³¨è§£ä¸”å¯ç”¨äº†ä»£ç†ï¼Œåˆ™é€šè¿‡ <code>ASM</code> å…ˆç»‡å…¥ <code>if (true)</code> æ¡ä»¶åˆ¤æ–­è¯­å¥ï¼Œ</li>
<li>æ¥ä¸‹æ¥è·å–å‡½æ•°çš„ <code>methodType</code> å’Œ <code>returnType</code>ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ <code>ASM</code> çœ¼ä¸­çš„å‡½æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ï¼Œ</li>
<li>æœ€ååˆ¤æ–­ <code>handler</code> æ˜¯å¦æ˜¯ç©ºå­—ç¬¦ä¸²æ¥å†³å®šæ‰§è¡Œå“ªç§è½¬æ¢åˆ†æ”¯ã€‚</li>
</ol>
<h3 id="ç®€å•è½¬æ¢"><a class="markdownIt-Anchor" href="#ç®€å•è½¬æ¢"></a> ç®€å•è½¬æ¢</h3>
<p>ç®€å•è½¬æ¢çš„å®ç°æ˜¯æ ¹æ®å‡½æ•°è¿”å›ç±»å‹åˆ¤æ–­ï¼š</p>
<ol>
<li>æ— è¿”å›å€¼ç±»å‹è¿”å› <code>void</code>ï¼Œ</li>
<li>åŸºæœ¬æ•°æ®ç±»å‹è¿”å›ï¼š<code>-1</code>ï¼Œ<code>char</code> ç±»å‹è¿”å› <code>48</code>ï¼Œ</li>
<li>å¼•ç”¨ç±»å‹è¿”å› <code>null</code>ã€‚</li>
</ol>
<p>ä¸‹é¢æ˜¯ç®€å•è½¬æ¢çš„å®ç°ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">weaveDefaultValue</span><span class="params">(returnType: <span class="type">Type</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> sort = returnType.sort</span><br><span class="line">    <span class="keyword">when</span> &#123;</span><br><span class="line">        sort == Type.VOID -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.RETURN)</span><br><span class="line">        &#125;</span><br><span class="line">        sort == Type.CHAR -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitIntInsn(Opcodes.BIPUSH, <span class="number">48</span>)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(returnType.getOpcode(Opcodes.IRETURN))</span><br><span class="line">        &#125;</span><br><span class="line">        sort &gt;= Type.BOOLEAN &amp;&amp; sort &lt;= Type.INT -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.ICONST_M1)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(returnType.getOpcode(Opcodes.IRETURN))</span><br><span class="line">        &#125;</span><br><span class="line">        sort == Type.LONG -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitLdcInsn(-<span class="number">1L</span>)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.LRETURN)</span><br><span class="line">        &#125;</span><br><span class="line">        sort == Type.FLOAT -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitLdcInsn(-<span class="number">1f</span>)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.FRETURN)</span><br><span class="line">        &#125;</span><br><span class="line">        sort == Type.DOUBLE -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitLdcInsn(-<span class="number">1.0</span>)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.DRETURN)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.ACONST_NULL)</span><br><span class="line">            <span class="keyword">super</span>.visitInsn(Opcodes.ARETURN)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•è½¬æ¢çš„å®ç°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç¬”è€…å°±ä¸å†åˆ†æäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ä»Šå¤©çš„ä¸»è§’ï¼šä»£ç†è½¬æ¢ã€‚</p>
<h3 id="ä»£ç†è½¬æ¢"><a class="markdownIt-Anchor" href="#ä»£ç†è½¬æ¢"></a> ä»£ç†è½¬æ¢</h3>
<p>ä»£ç†è½¬æ¢çš„å®ç°é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œä»¥ä¸‹å‡ ç‚¹æ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„ï¼š</p>
<ol>
<li>åŸå§‹å‡½æ•°æ˜¯å¦æ˜¯é™æ€å‡½æ•°ï¼šéé™æ€å‡½æ•°(ä¸åŒ…æ‹¬æ„é€ å‡½æ•°)çš„ç¬¬é›¶ä½å‚æ•°å§‹ç»ˆæ˜¯ <code>this</code>ï¼Œ</li>
<li>å¦‚ä½•æ„å»º <code>InvocationHandler</code> å®ç°ç±»çš„å®ä¾‹ï¼Œ</li>
<li>å¦‚ä½•è·å– <code>InvocationHandler#invoke</code> å‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œ</li>
<li>å¦‚ä½•è°ƒç”¨ <code>InvocationHandler#invoke</code> å‡½æ•°ï¼Œ</li>
<li>è°ƒç”¨ <code>InvocationHandler#invoke</code> å‡½æ•°åçš„ç»“æœå¦‚ä½•è¿”å›ç»™åŸå§‹å‡½æ•°ã€‚</li>
</ol>
<p>è„‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img data-src="/imgs/gosp/sword/01-01-proxy-mind.png" alt="proxy mind" /></p>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®ä¸Šè¿°å‡ ç‚¹ä¾æ¬¡åˆ†æä¸‹ï¼š</p>
<h4 id="1æ˜¯å¦æ˜¯é™æ€å‡½æ•°"><a class="markdownIt-Anchor" href="#1æ˜¯å¦æ˜¯é™æ€å‡½æ•°"></a> 1.æ˜¯å¦æ˜¯é™æ€å‡½æ•°</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> argumentTypes = t.argumentTypes</span><br><span class="line"><span class="keyword">val</span> argumentSize = argumentTypes.size</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> isStaticMethod = methodAccess and Opcodes.ACC_STATIC != <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> localSize = <span class="keyword">if</span> (isStaticMethod) <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">val</span> firstSlot = localSize</span><br><span class="line"><span class="keyword">for</span> (argType <span class="keyword">in</span> argumentTypes) &#123;</span><br><span class="line">    localSize += argType.size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯é™æ€å‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªç›®çš„æ˜¯ä¸ºäº†æ‰¾åˆ°å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°çš„èµ·å§‹ä½ç½®ï¼Œä»¥åŠè®¡ç®—æ•´ä¸ªæ–¹æ³•çš„ <code>locals</code> å¤§å°ï¼Œä¸ºåç»­å­˜å‚¨ <code>InvocationHandler</code> å®ç°ç±»å®ä¾‹åšå‡†å¤‡ï¼š</p>
<ul>
<li><code>firstSlot</code> å³ä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„èµ·å§‹ä½ç½®ï¼Œåé¢ä¼šä½¿ç”¨åˆ°ï¼Œ</li>
<li><code>localSize</code> å³ä¸ºæ•´ä¸ªæ–¹æ³•çš„ <code>lcoals</code> å¤§å°ï¼Œé€šè¿‡éå†å‡½æ•°å‚æ•°å¾—åˆ°ã€‚</li>
</ul>
<h4 id="2æ„å»ºå®ç°ç±»å®ä¾‹"><a class="markdownIt-Anchor" href="#2æ„å»ºå®ç°ç±»å®ä¾‹"></a> 2.æ„å»ºå®ç°ç±»å®ä¾‹</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> realHandler = covertToClassDescriptor(handler)</span><br><span class="line"><span class="keyword">super</span>.visitTypeInsn(Opcodes.NEW, realHandler)</span><br><span class="line"><span class="keyword">super</span>.visitInsn(Opcodes.DUP)</span><br><span class="line"><span class="keyword">super</span>.visitMethodInsn(Opcodes.INVOKESPECIAL, realHandler, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">super</span>.visitVarInsn(Opcodes.ASTORE, localSize)</span><br><span class="line"><span class="keyword">super</span>.visitVarInsn(Opcodes.ALOAD, localSize)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">covertToClassDescriptor</span><span class="params">(className: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> className.replace(<span class="string">&quot;\\.&quot;</span>.toRegex(), <span class="string">&quot;/&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>é¦–å…ˆéœ€è¦æŠŠ <code>handler</code> å­—æ®µä¸­çš„å®ç°ç±»å…¨é™å®šåï¼ˆ<code>Full-Qualified Name</code>ï¼‰è½¬æ¢æˆ <code>ASM</code> é‡Œçš„ <code>InternalName</code>ï¼Œæ¯”å¦‚ï¼š<code>com.guodong.android.TestInvocationHandler</code> è½¬æ¢ä¸º <code>com/guodong/android/TestInvocationHandler</code>ï¼Œå³æŠŠ <code>.</code> æ›¿æ¢æˆ <code>/</code>ã€‚</li>
<li>ä¸Šè¿°ç‰‡æ®µä¸­çš„ç¬¬ 4 è¡Œä»£ç é€šè¿‡è°ƒç”¨å®ç°ç±»çš„æ— å‚æ„é€ æ–¹æ³•æ¥æ„å»ºå®ä¾‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ç°ç±»å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•çš„åŸå› ï¼Œ</li>
<li>åé¢ä¸¤è¡Œä»£ç æ˜¯æŠŠåˆ›å»ºå‡ºæ¥çš„å®ä¾‹å­˜å‚¨åœ¨æ–¹æ³•çš„ <code>locals</code> ä¸Šå¹¶å†æ¬¡åŠ è½½å‡ºæ¥ä»¥å¤‡åç”¨ã€‚</li>
</ol>
<h4 id="3è·å–æ‰€éœ€å‚æ•°"><a class="markdownIt-Anchor" href="#3è·å–æ‰€éœ€å‚æ•°"></a> 3.è·å–æ‰€éœ€å‚æ•°</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">super</span>.visitLdcInsn(className)</span><br><span class="line"><span class="keyword">super</span>.visitLdcInsn(methodName)</span><br><span class="line">weaveInt(argumentSize)</span><br><span class="line"><span class="keyword">super</span>.visitTypeInsn(Opcodes.ANEWARRAY, <span class="string">&quot;java/lang/Object&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (argumentTypes.isNotEmpty()) &#123;</span><br><span class="line">    weaveArgs(argumentTypes, argumentSize, firstSlot)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">// InvocationHandler</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(className: <span class="type">String</span>, methodName: <span class="type">String</span>, args: <span class="type">Array</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ç‰‡æ®µçš„æœ€åæ˜¯ <code>InvocationHandler</code> æ¥å£çš„å£°æ˜ï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œ<code>invoke</code> å‡½æ•°éœ€è¦ 3 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ol>
<li>å½“å‰çš„ç±»åï¼Œ</li>
<li>å½“å‰çš„å‡½æ•°åï¼Œ</li>
<li>å½“å‰å‡½æ•°å£°æ˜å‚æ•°çš„æ•°ç»„ã€‚</li>
</ol>
<p>ä¸‹é¢åˆ†æä¸‹è·å–å‚æ•°çš„é€»è¾‘ï¼š</p>
<ol>
<li>ä»£ç ç‰‡æ®µçš„å‰ä¸¤è¡Œä»£ç æˆ‘ä»¬ç»‡å…¥äº†å‰ä¸¤ä¸ªå‚æ•°ï¼Œ</li>
<li>ç¬¬ 3 è¡Œä»£ç æˆ‘ä»¬ç»‡å…¥å‚æ•°æ•°ç»„çš„å¤§å°ï¼Œ</li>
<li>ç¬¬ 4 è¡Œä»£ç æ„å»ºå‚æ•°æ•°ç»„å®ä¾‹ï¼Œ</li>
<li>æœ€åé¢çš„ <code>if</code> æ¡ä»¶åˆ¤æ–­é€»è¾‘æ˜¯æŠŠåŸå§‹å‡½æ•°çš„å‚æ•°æ”¾è¿›æ•°ç»„å†…ã€‚</li>
</ol>
<h4 id="4è°ƒç”¨-invoke-å‡½æ•°"><a class="markdownIt-Anchor" href="#4è°ƒç”¨-invoke-å‡½æ•°"></a> 4.è°ƒç”¨ <code>invoke</code> å‡½æ•°</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">super</span>.visitMethodInsn(</span><br><span class="line">    Opcodes.INVOKEINTERFACE,</span><br><span class="line">    KT_INVOCATION_HANDLER_OWNER,</span><br><span class="line">    INVOKE_METHOD,</span><br><span class="line">    INVOCATION_HANDLER_INVOKE_DESC,</span><br><span class="line">    <span class="literal">true</span> <span class="comment">/* isInterface */</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>invoke</code> å‡½æ•°æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡è°ƒç”¨ <code>ASM</code> çš„ <code>visitMethodInsn</code> æ–¹æ³•ä¼ å…¥æ­£ç¡®çš„å‚æ•°å³å¯ã€‚æ³¨æ„æœ€åä¸€ä¸ªå‚æ•°è¦ä¸º <code>true</code>ï¼Œå› ä¸ºæˆ‘ä»¬è°ƒç”¨çš„æ˜¯ä¸€ä¸ªæ¥å£æ–¹æ³•ã€‚</p>
<h4 id="5invokeå‡½æ•°çš„ç»“æœè¿”å›ç»™åŸå§‹å‡½æ•°"><a class="markdownIt-Anchor" href="#5invokeå‡½æ•°çš„ç»“æœè¿”å›ç»™åŸå§‹å‡½æ•°"></a> 5.<code>invoke</code>å‡½æ•°çš„ç»“æœè¿”å›ç»™åŸå§‹å‡½æ•°</h4>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> returnTypeSort = returnType.sort</span><br><span class="line"><span class="keyword">when</span> &#123;</span><br><span class="line">    returnTypeSort == Type.VOID -&gt; &#123;</span><br><span class="line">        <span class="keyword">super</span>.visitInsn(Opcodes.RETURN)</span><br><span class="line">    &#125;</span><br><span class="line">    isPrimitiveType(returnTypeSort) -&gt; &#123;</span><br><span class="line">        weavePrimitiveReturn(returnTypeSort)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> internalName = returnType.internalName</span><br><span class="line">        <span class="keyword">super</span>.visitTypeInsn(Opcodes.CHECKCAST, internalName)</span><br><span class="line">        <span class="keyword">super</span>.visitInsn(Opcodes.ARETURN)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚å‰æ‰€ç¤ºï¼Œ<code>invoke</code> å‡½æ•°çš„è¿”å›å€¼æ˜¯ <code>Any?</code> ï¼Œé‚£ä¹ˆå¦‚ä½•è¿”å›ç»™åŸå§‹å‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ ¹æ®åŸå§‹å‡½æ•°çš„è¿”å›å€¼ç±»å‹åšåˆ¤æ–­ï¼š</p>
<ol>
<li>å¦‚æœæ˜¯ <code>voidd</code> ç±»å‹ï¼Œåˆ™ç›´æ¥ <code>return</code>ï¼Œ</li>
<li>å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œéœ€è¦å…ˆå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºåŒ…è£…ç±»å‹ï¼Œå†è°ƒç”¨åŒ…è£…ç±»å‹å¯¹åº”çš„ <code>xxxValue</code> æ–¹æ³•è·å–åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæœ€åå†è¿”å›ï¼Œ</li>
<li>å¦‚æœæ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡ <code>returnType</code> è·å–è¿”å›å€¼çš„ <code>InternalName</code>ï¼Œç„¶åè¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæœ€åè¿”å›ã€‚</li>
</ol>
<p>è‡³æ­¤ï¼Œä»£ç†è½¬æ¢åˆ†æå®Œæ¯•ï¼Œhappy~</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>åœ¨æƒ³å®ç°æŸä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰å¥½å‡ ç§æ€è·¯ï¼Œå¦‚ä½•åœ¨è¿™å¥½å‡ ç§æ€è·¯ä¸­é€‰æ‹©ä¸€ä¸ªè¿›è¡Œå®ç°ï¼Œè¿™å…¶ä¸­è€ƒé‡ä¸å–èˆçš„è¿‡ç¨‹ç¬”è€…è§‰å¾—æ¯”è¾ƒæœ‰è¶£ã€‚</p>
<p>æœ¬æ–‡è®°å½•äº† <code>Sword</code> çš„å®ç°åŸç†ä¸æºç åˆ†æï¼ŒåŒæ—¶è®°å½•äº†ç¬”è€…å®ç°ä»£ç æ—¶çš„ä¸€äº›æ€è·¯ä¸æ€è€ƒï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™äº›æ€è·¯ä¸æ€è€ƒè¿œæ¯”å®ç°è¿™ä¸ªåŠŸèƒ½æ›´æœ‰æ„ä¹‰ã€‚</p>
<p>ä¸‹ç¯‡å†è§ï¼Œhappy~</p>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(ä¸‰)</title>
    <url>/2022/10/13/gosp/sword/02-sword/</url>
    <content><![CDATA[<h1 id="sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½ä¸‰"><a class="markdownIt-Anchor" href="#sword-ä¸º-kotlin-å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½ä¸‰"></a> Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(ä¸‰)</h1>
<h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h2>
<p>Swordï¼šä¸€ä¸ªå¯ä»¥ç»™ Kotlin å‡½æ•°å¢åŠ ä»£ç†çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŸºäº KCP å®ç°ã€‚</p>
<ol>
<li><a href="https://sunxiaodou.com/2022/09/20/gosp/sword/00-sword/">Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(ä¸€)</a></li>
<li><a href="https://sunxiaodou.com/2022/10/11/gosp/sword/01-sword/">Sword - ä¸º Kotlin å‡½æ•°å¢åŠ ä»£ç†åŠŸèƒ½(äºŒ)</a></li>
</ol>
<p>å‰é¢ä¸¤ç¯‡æ–‡ç« ç¬”è€…è®°å½•äº† <code>Sword</code> çš„å®ç°è¿‡ç¨‹ï¼Œæœ¬ç¯‡æ–‡ç« ç®€å•è®°å½•ä¸‹å¦‚ä½•ä½¿ç”¨ <code>Sword</code> ä»¥åŠå¦‚ä½•é€šè¿‡ <code>KSP</code> ä¸º <code>InvocationHandler</code> ç”Ÿæˆ <code>FqName</code> ç´¢å¼•ç±» <code>HandlerFqName</code>ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹ä¸‹å¦‚ä½•ä½¿ç”¨ <code>Sword</code> å§ã€‚</p>
<h2 id="åº”ç”¨"><a class="markdownIt-Anchor" href="#åº”ç”¨"></a> åº”ç”¨</h2>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// `InvocationHandler` å®ç°ç±»1</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetTextNoArgInvocationHandler</span> : <span class="type">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = GetTextNoArgInvocationHandler::<span class="keyword">class</span>.java.simpleName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(className: <span class="type">String</span>, methodName: <span class="type">String</span>, args: <span class="type">Array</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;invoke: className = <span class="variable">$className</span>, methodName = <span class="variable">$methodName</span>, args(<span class="subst">$&#123;args.size&#125;</span>) = <span class="subst">$&#123;args.joinToString()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;guodongAndroid-Debug&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// `InvocationHandler` å®ç°ç±»2</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetTextArgInvocationHandler</span> : <span class="type">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = GetTextArgInvocationHandler::<span class="keyword">class</span>.java.simpleName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(className: <span class="type">String</span>, methodName: <span class="type">String</span>, args: <span class="type">Array</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;invoke: className = <span class="variable">$className</span>, methodName = <span class="variable">$methodName</span>, args(<span class="subst">$&#123;args.size&#125;</span>) = <span class="subst">$&#123;args.joinToString()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> User(<span class="string">&quot;guodongAndroid-Debug&quot;</span>, <span class="number">18</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œç¬”è€…åˆ›å»ºäº†ä¸¤ä¸ª <code>InvocationHandler</code> å®ç°ç±»ï¼Œå¯¹åŸå§‹å‡½æ•°çš„è¿”å›å€¼è¿›è¡Œäº†æ›¿æ¢ï¼Œæ¥ä¸‹æ¥åˆ›å»ºæµ‹è¯•ç±»ï¼š</p>
<p><strong>å‘ <code>Proxy</code> æ³¨è§£ä¸­çš„ <code>handler</code> å‚æ•°æ³¨å…¥ <code>InvocationHandler</code> å®ç°ç±»çš„å…¨é™å®šå(Fully Qualified Name)ï¼Œå…¶å®ç°ç±»å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•</strong>ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Proxy(</span></span><br><span class="line"><span class="meta">        enable = BuildConfig.isDebug,</span></span><br><span class="line"><span class="meta">        // æ³¨å…¥ `InvocationHandler` å®ç°ç±»çš„å…¨é™å®šå</span></span><br><span class="line"><span class="meta">        handler = <span class="string">&quot;com.guodong.android.sword.app.GetTextNoArgInvocationHandler&quot;</span></span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getTextNoArg</span><span class="params">()</span></span> = <span class="string">&quot;guodongAndroid&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Proxy(</span></span><br><span class="line"><span class="meta">        enable = BuildConfig.isDebug,</span></span><br><span class="line"><span class="meta">        // æ³¨å…¥ `InvocationHandler` å®ç°ç±»çš„å…¨é™å®šå</span></span><br><span class="line"><span class="meta">        handler = <span class="string">&quot;com.guodong.android.sword.app.GetTextArgInvocationHandler&quot;</span></span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getTextArg</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        b: <span class="type">Byte</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        z: <span class="type">Boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        c: <span class="type">Char</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        s: <span class="type">Short</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        i: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        l: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        f: <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        d: <span class="type">Double</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        str: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        ia: <span class="type">IntArray</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        sa: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        ls: <span class="type">List</span>&lt;<span class="type">String</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        lls: <span class="type">List</span>&lt;<span class="type">List</span>&lt;<span class="type">String</span>&gt;&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        map: <span class="type">Map</span>&lt;<span class="type">String</span>, String&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">        user: <span class="type">User</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        callback: <span class="type">Callback</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: User &#123;</span><br><span class="line">        <span class="keyword">return</span> User(<span class="string">&quot;guodongAndroid-Release&quot;</span>, <span class="number">28</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬”è€…åˆ›å»ºäº†ä¸¤ä¸ªæµ‹è¯•å‡½æ•°ï¼š<code>getTextNoArg</code> å’Œ <code>getTextArg</code>ï¼Œä¸€ä¸ªå‡½æ•°æ²¡æœ‰å‚æ•°ï¼Œå¦ä¸€ä¸ªå‡½æ•°æœ‰å¤šä¸ªä¸åŒç±»å‹çš„å‚æ•°ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¸Šéƒ½æœ‰ <code>Proxy</code> æ³¨è§£ï¼Œå¹¶ä¸”æ³¨è§£çš„å‚æ•° <code>enable</code> éƒ½å¤„äºå¼€å¯çŠ¶æ€ï¼Œ<code>handler</code> å‚æ•°éƒ½æ³¨å…¥äº†å¯¹åº” <code>InvocationHandler</code> å®ç°ç±»çš„å…¨é™å®šåã€‚</p>
<p>ä¸‹é¢æ‰§è¡Œæµ‹è¯•é€»è¾‘ï¼Œåˆ†åˆ«è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> test = Test()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> textNoArg = test.getTextNoArg()</span><br><span class="line">Log.e(TAG, <span class="string">&quot;onCreate: textNoArg = <span class="subst">$&#123;textNoArg.length&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> textArg = test.getTextArg(</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">1F</span>,</span><br><span class="line">    <span class="number">1.0</span>,</span><br><span class="line">    <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    intArrayOf(),</span><br><span class="line">    Array(<span class="number">0</span>) &#123; <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">    listOf(),</span><br><span class="line">    listOf(),</span><br><span class="line">    mapOf(),</span><br><span class="line">    User(<span class="string">&quot;1&quot;</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">object</span> : Callback &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">()</span></span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(cause: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">Log.e(TAG, <span class="string">&quot;onCreate: textArg = <span class="variable">$textArg</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>åŸå§‹è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.MainActivity: onCreate: textNoArg = 14</span><br><span class="line">2.MainActivity: onCreate: textArg = User(name=guodongAndroid-Release, age=28)</span><br></pre></td></tr></table></figure>
<p>ä»£ç†è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.GetTextNoArgInvocationHandler: invoke: className = Test, methodName = getTextNoArg, args(0) = </span><br><span class="line">2.MainActivity: onCreate: textNoArg = 20</span><br><span class="line">3.GetTextArgInvocationHandler: invoke: className = Test, methodName = getTextArg, args(16) = 1, false, A, 1, 1, 1, 1.0, 1.0, test, [I@156552e7, [Ljava.lang.String;@110de94, [], [], &#123;&#125;, User(name=1, age=1), com.guodong.android.sword.app.MainActivity$onCreate$textArg$2@12780d3d</span><br><span class="line">4.onCreate: textArg = User(name=guodongAndroid-Debug, age=18)</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œ<code>Proxy</code> æ³¨è§£ç”Ÿæ•ˆäº†ï¼šè°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°åæˆåŠŸæ‰§è¡Œäº†ä»£ç†ç±»çš„ <code>invoke</code> å‡½æ•°ã€‚</p>
<p>è‡³æ­¤ï¼Œ<code>Sword</code> çš„ä½¿ç”¨å°±ç»“æŸäº†ï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒç®€å•å‘¢ï¼Ÿ</p>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬åœ¨ç»™ <code>Proxy</code> æ³¨è§£çš„ <code>handler</code> å‚æ•°æ³¨å…¥ <code>InvocationHandler</code> å®ç°ç±»çš„å…¨é™å®šåæ—¶ä½¿ç”¨çš„æ˜¯ç¡¬ç¼–ç ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†å®ç°ç±»çš„ç±»åï¼Œè€Œå¿˜è®°ä¿®æ”¹æ­¤å¤„çš„å…¨é™å®šåï¼Œä»£ç åœ¨è¿è¡Œæ—¶å°±ä¼šå‘ç”Ÿé”™è¯¯äº†ã€‚</p>
<p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…çš„ç¬¬ä¸€æƒ³æ³•æ˜¯ä½¿ç”¨  <code>handler = GetTextNoArgInvocationHandler::class.java.name</code>ï¼Œä½†æ˜¯ä¸è¡Œï¼Œ<strong>æ³¨è§£å‚æ•°å¿…é¡»æ˜¯ç¼–è¯‘æœŸå¸¸é‡</strong>ï¼Œæ­¤è·¯ä¸é€šäº†ã€‚</p>
<p>åé¢ç¬”è€…æƒ³åˆ°ä¸€ç§æ–¹æ¡ˆï¼šä¸º <code>InvocationHandler</code> çš„å®ç°ç±»ç”Ÿæˆå…¨é™å®šåç´¢å¼•ã€‚</p>
<p>æ­¤æ–¹æ¡ˆå‚è€ƒè‡ª <code>EventBus</code> ä¸º <code>Event</code> äº‹ä»¶ç”Ÿæˆ <code>EventIndex</code> ï¼Œä¸è¿‡ <code>EventBus</code> ä½¿ç”¨ <code>APT</code> æŠ€æœ¯è¿›è¡Œå®ç°ï¼Œè€Œ <code>Sword</code> é€‰æ‹©ä½¿ç”¨ <code>KSP</code> å®ç°ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹å¦‚ä½•ä¸º <code>InvocationHandler</code> çš„å®ç°ç±»ç”Ÿæˆå…¨é™å®šåç´¢å¼•å§ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹æœ€åçš„ç´¢å¼•ç±» <code>HandlerFqName</code> æ•ˆæœï¼š</p>
<h2 id="handlerfqname"><a class="markdownIt-Anchor" href="#handlerfqname"></a> HandlerFqName</h2>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The file is automatic generated by Sword, don&#x27;t modify it.</span></span><br><span class="line"><span class="keyword">package</span> com.guodong.android.sword.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.String</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The class is automatic generated by Sword, don&#x27;t modify it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [com.guodong.android.sword.api.kt.InvocationHandler]å®ç°ç±»çš„å…¨é™å®šå</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">object</span> HandlerFqName &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [com.guodong.android.sword.app.GetTextArgInvocationHandler]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">val</span> GetTextArgInvocationHandler: String =</span><br><span class="line">      <span class="string">&quot;com.guodong.android.sword.app.GetTextArgInvocationHandler&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [com.guodong.android.sword.app.GetTextNoArgInvocationHandler]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">val</span> GET_TEXT_NO_ARG: String =</span><br><span class="line">      <span class="string">&quot;com.guodong.android.sword.app.GetTextNoArgInvocationHandler&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="proxyhandler"><a class="markdownIt-Anchor" href="#proxyhandler"></a> ProxyHandler</h2>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ‡è®°[InvocationHandler]çš„å®ç°ç±», ä¸ºå…¶ç”Ÿæˆ`FqName`ç´¢å¼•ç±»`HandlerFqName`</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ ksp å®ç°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.BINARY)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">ProxyHandler</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆå­—æ®µçš„åç§°, é»˜è®¤ä¸ºç±»å</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * `paramName`å‚æ•°åç§°ä¸è¦éšæ„å˜åŠ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> paramName: String = <span class="string">&quot;&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>api-kotlin</code> æ¨¡å—ä¸­æ–°å¢ <code>ProxyHandler</code> æ³¨è§£ï¼Œæ­¤æ³¨è§£ç”¨äºæ ‡è®° <code>InvocationHandler</code> çš„å®ç°ç±»ï¼Œä¸ºå…¶ç”Ÿæˆ<code>FqName</code>ç´¢å¼•ï¼Œæ¯”å¦‚æˆ‘ä»¬æ ‡è®°åœ¨ <code>GetTextNoArgInvocationHandler</code> ç±»ä¸Šï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ProxyHandler(<span class="string">&quot;GET_TEXT_NO_ARG&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetTextNoArgInvocationHandler</span> : <span class="type">InvocationHandler</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>paramName</code> å‚æ•°å¯ä»¥æŒ‡å®šç”Ÿæˆå­—æ®µçš„åç§°ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œé»˜è®¤ç”Ÿæˆçš„å­—æ®µåç§°ä¸ºå®ç°ç±»çš„ç±»åï¼š<code>HandlerFqName.GetTextArgInvocationHandler</code>ã€‚</p>
<h2 id="ksp"><a class="markdownIt-Anchor" href="#ksp"></a> KSP</h2>
<p><a href="https://github.com/google/ksp">KSP</a> åŸºäº <code>KCP</code> å®ç°ï¼Œæä¾›äº†ä¸€ä¸ªç®€åŒ–çš„ç¼–è¯‘å™¨æ’ä»¶ APIï¼Œä¸ <code>KCP</code> é™¡å³­çš„å­¦ä¹ æ›²çº¿ç›¸æ¯”ï¼Œ<code>KSP</code> çš„å­¦ä¹ æ›²çº¿è¦å¹³æ»‘ä¸€äº›ã€‚ã€</p>
<p>å¦‚ä½•ä½¿ç”¨ <code>KSP</code> è¯»è€…å¯ä»¥å‚è€ƒ<a href="https://github.com/google/ksp">å®˜ç½‘</a>ï¼Œæœ¬æ–‡å°±ä¸è®°å½•æ­å»º <code>KSP</code> å¼€å‘ç¯å¢ƒäº†ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜ã€‚</p>
<p>ç¬”è€…å…ˆæè¿°ä¸‹è‡ªå·±çš„å®ç°æ€è·¯ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­å½“å‰æ¨¡å—æ˜¯å¦æœ‰ <code>InvocationHandler</code> æ¥å£ï¼Œå¦‚è‹¥æ²¡æœ‰ï¼Œåˆ™ä¸å¤„ç†ï¼Œ</li>
<li>å…¶æ¬¡åˆ¤æ–­å½“å‰æ¨¡å—æ˜¯å¦æœ‰ <code>ProxyHandler</code> æ³¨è§£ï¼Œå¦‚è‹¥æ²¡æœ‰ï¼Œåˆ™ä¸å¤„ç†ï¼Œ</li>
<li>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³çš„ï¼Œå†è·å–åŒ…å« <code>ProxyHandler</code> æ³¨è§£çš„æ‰€æœ‰ <code>Kotlin</code> ç¬¦å·ï¼Œ</li>
<li>å¯¹è·å–çš„ <code>Kotlin</code> ç¬¦å·è¿›è¡Œå‡ ç§æ¡ä»¶è¿‡æ»¤ï¼Œç›®çš„æ˜¯ç¡®ä¿æ­¤ç¬¦å·æ˜¯ <code>InvocationHandler</code> æ¥å£çš„å®ç°ç±»ï¼Œè¿‡æ»¤æ¡ä»¶ï¼š
<ol>
<li>åˆ¤æ–­æ˜¯å¦æ˜¯ç±»ï¼Œè€Œä¸æ˜¯æ¥å£ã€æšä¸¾ç±»ç­‰ï¼Œ</li>
<li>åˆ¤æ–­ç±»æ˜¯å¦æ˜¯å…¬å¼€ä¸”ä¸æ˜¯æŠ½è±¡ç±»ï¼Œç¡®ä¿å½“å‰ç±»å¯ä»¥è®¿é—®å¹¶ç›´æ¥å®ä¾‹åŒ–ï¼Œ</li>
<li>åˆ¤æ–­æ˜¯å¦æœ‰ä¸»æ„é€ æ–¹æ³•æˆ–ä¸»æ„é€ æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œç¡®ä¿æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œ</li>
<li>æœ€ååˆ¤æ–­å½“å‰ç±»æ˜¯å¦å®ç°äº† <code>InvocationHandler</code> æ¥å£ã€‚</li>
</ol>
</li>
<li>é€šè¿‡è¿‡æ»¤åçš„ç¬¦å·ï¼Œæ”¶é›†å¹¶å­˜å‚¨è¦ç”Ÿæˆçš„å­—æ®µåå’Œå…¨é™å®šåï¼Œ</li>
<li>æœ€åé€šè¿‡ <code>KotlinPoet</code> ç”Ÿæˆç´¢å¼•ç±»ã€‚</li>
</ol>
<p><img data-src="/imgs/gosp/sword/02-00-idea.png" alt="idea" /></p>
<p>ä¸‹é¢æ ¹æ®å®ç°æ€è·¯ä¾æ¬¡å®ç°ã€‚<br />
é¦–å…ˆå®šä¹‰ä¸€äº›å¸¸é‡ï¼Œç”¨äºåé¢ä»£ç çš„ç¼–å†™ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹åº”`ProxyHandler`æ³¨è§£é‡Œçš„`paramName`å‚æ•°åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> PARAM_NAME = <span class="string">&quot;paramName&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆç´¢å¼•ç±»çš„åŒ…åï¼Œæä¾›ç»™å¤–éƒ¨é…ç½®ï¼Œé»˜è®¤`com.guodong.android.sword`</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> PACKAGE_NAME_PARAM_NAME = <span class="string">&quot;sword.pkg&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ç´¢å¼•ç±»çš„åŒ…å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> DEFAULT_PACKAGE_NAME = <span class="string">&quot;com.guodong.android.sword&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•ç±»æ‰€åœ¨æ–‡ä»¶å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> FILE_NAME = <span class="string">&quot;HandlerFqName&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç´¢å¼•ç±»çš„ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> CLASS_NAME = <span class="string">&quot;HandlerFqName&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å®šä¹‰ä¸€ä¸ªå®ä½“ï¼Œç”¨äºå­˜å‚¨ç”Ÿæˆçš„å­—æ®µåå’Œå…¨é™å®šåï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">ProxyHandlerParam</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‚æ•°åç§°, é»˜è®¤ä¸ºç±»å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> paramName: String,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [InvocationHandler]å®ç°ç±»çš„å…¨é™å®šå</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * e.g. com.example.ProxyTestInvocationHandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> fqName: String,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä¸»è¦åˆ†æ <code>SymbolProcessor</code> çš„ <code>process(resolver: Resolver)</code> å‡½æ•°ï¼Œä¸‹é¢ä»£ç æ˜¯æ€è·¯ä¸­å‰ä¸¤æ­¥çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mInvocationHandlerName = requireNotNull(InvocationHandler::<span class="keyword">class</span>.qualifiedName)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mProxyHandlerName = requireNotNull(ProxyHandler::<span class="keyword">class</span>.qualifiedName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">process</span><span class="params">(resolver: <span class="type">Resolver</span>)</span></span>: List&lt;KSAnnotated&gt; &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰æ¨¡å—æ˜¯å¦æœ‰ `InvocationHandler` æ¥å£ï¼Œå¦‚è‹¥æ²¡æœ‰ï¼Œåˆ™ä¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">val</span> mProxyHandlerType =</span><br><span class="line">    	resolver.getClassDeclarationByName(mProxyHandlerName)?.asType(emptyList())</span><br><span class="line">    <span class="keyword">if</span> (mProxyHandlerType == <span class="literal">null</span>) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;<span class="variable">$TAG</span>: Not found `ProxyHandler`&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> emptyList()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰æ¨¡å—æ˜¯å¦æœ‰ `ProxyHandler` æ³¨è§£ï¼Œå¦‚è‹¥æ²¡æœ‰ï¼Œåˆ™ä¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">val</span> mInvocationHandlerType =</span><br><span class="line">    	resolver.getClassDeclarationByName(mInvocationHandlerName)?.asType(emptyList())</span><br><span class="line">    <span class="keyword">if</span> (mInvocationHandlerType == <span class="literal">null</span>) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;<span class="variable">$TAG</span>: Not found `InvocationHandler`&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> emptyList()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–åŒ…å« <code>ProxyHandler</code> æ³¨è§£çš„æ‰€æœ‰ <code>Kotlin</code> ç¬¦å·æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡ <code>KSP</code> æä¾›çš„ APIï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–åˆ°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> symbols = resolver.getSymbolsWithAnnotation(mProxyHandlerName)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ ¹æ®å®ç°æ€è·¯çš„ç¬¬å››æ­¥è¿‡æ»¤æˆ‘ä»¬è·å–åˆ°çš„ç¬¦å·ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> classDeclaration = symbols</span><br><span class="line">	.filter &#123; it.validate() &#125;</span><br><span class="line">	.filterIsInstance&lt;KSClassDeclaration&gt;()</span><br><span class="line">	.filter &#123; declaration -&gt;</span><br><span class="line">         <span class="comment">// Class</span></span><br><span class="line">         <span class="keyword">val</span> isClass = declaration.classKind == ClassKind.CLASS</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Public &amp;&amp; !Abstract</span></span><br><span class="line">         <span class="keyword">val</span> isPublic =</span><br><span class="line">         Modifier.PUBLIC <span class="keyword">in</span> declaration.modifiers || declaration.modifiers.isEmpty()</span><br><span class="line">         <span class="keyword">val</span> isNotAbstract = Modifier.ABSTRACT !<span class="keyword">in</span> declaration.modifiers</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æ— å‚æ„é€ æ–¹æ³•</span></span><br><span class="line">         <span class="keyword">val</span> primaryConstructor = declaration.primaryConstructor</span><br><span class="line">         <span class="keyword">val</span> hasNoArgumentConstructor =</span><br><span class="line">         primaryConstructor == <span class="literal">null</span> || primaryConstructor.parameters.isEmpty()</span><br><span class="line"></span><br><span class="line">         <span class="comment">// å®ç°`InvocationHandler`æ¥å£</span></span><br><span class="line">         <span class="keyword">val</span> isImplInvocationHandler =</span><br><span class="line">         declaration.superTypes.any &#123; ref -&gt; ref.resolve() == mInvocationHandlerType &#125;</span><br><span class="line"></span><br><span class="line">         isClass &amp;&amp; isPublic &amp;&amp; isNotAbstract &amp;&amp; hasNoArgumentConstructor &amp;&amp; isImplInvocationHandler</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡æ»¤ç¬¦å·åï¼Œå°±å¯ä»¥æ”¶é›†å¹¶å­˜å‚¨è¦ç”Ÿæˆçš„å­—æ®µåå’Œå…¨é™å®šåäº†ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> params = mutableListOf&lt;ProxyHandlerParam&gt;()</span><br><span class="line"><span class="keyword">for</span> (declaration <span class="keyword">in</span> classDeclaration) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">annotation</span> <span class="keyword">in</span> declaration.annotations) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œç¬”è€…æ²¡æœ‰åˆ¤æ–­å½“å‰`annotation`æ˜¯å¦æ˜¯`ProxyHandler`å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜</span></span><br><span class="line">        <span class="comment">// å› ä¸º`resolve()`å‡½æ•°çš„æ³¨é‡Šä¸­æè¿°è°ƒç”¨æ­¤å‡½æ•°çš„ä»£ä»·æ¯”è¾ƒæ˜‚è´µ, åº”å°½å¯èƒ½é¿å…è°ƒç”¨ï¼Œè¿™é‡Œåˆæ˜¯åœ¨éå†ä¸­è°ƒç”¨ï¼Œæ‰€ä»¥ç¬”è€…å°±æ²¡æœ‰åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»™`ProxyHandler`æ³¨è§£çš„`paramName`å‚æ•°æ¢ä¸ªå”¯ä¸€ä¸ä¼šé‡å¤çš„åç§°</span></span><br><span class="line">        <span class="comment">/*if (annotation.annotationType.resolve() != mProxyHandlerType) &#123;</span></span><br><span class="line"><span class="comment">            continue</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (argument <span class="keyword">in</span> <span class="keyword">annotation</span>.arguments) &#123;</span><br><span class="line">            <span class="keyword">val</span> name = argument.name?.asString() ?: <span class="keyword">continue</span></span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯`ProxyHandler`æ³¨è§£ä¸­çš„å‚æ•°åç§°</span></span><br><span class="line">            <span class="keyword">if</span> (name == PARAM_NAME) &#123;</span><br><span class="line">                <span class="comment">// è·å–æ³¨è§£ä¸­çš„å‚æ•°å€¼</span></span><br><span class="line">                <span class="keyword">val</span> value: String = argument.value <span class="keyword">as</span>? String ?: <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">// è·å–å½“å‰å®ç°ç±»çš„å…¨é™å®šå</span></span><br><span class="line">                <span class="keyword">val</span> fqName: String = declaration.qualifiedName?.asString() ?: <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœæ³¨è§£æ²¡æœ‰æ³¨å…¥å‚æ•°ååˆ™ä½¿ç”¨ç±»å</span></span><br><span class="line">                <span class="keyword">val</span> paramName = value.ifEmpty &#123; declaration.simpleName.asString() &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ”¶é›†å­˜å‚¨</span></span><br><span class="line">                <span class="keyword">val</span> param = ProxyHandlerParam(paramName, fqName)</span><br><span class="line">                params.add(param)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ”¶é›†æˆ‘ä»¬æ‰€éœ€çš„æ•°æ®åï¼Œæœ€åå°±å¯ä»¥ç”Ÿæˆç´¢å¼•ç±»äº†ï¼Œç¬”è€…ä½¿ç”¨ <code>KotlinPoet</code> æ¥ç”Ÿæˆç´¢å¼•ç±»ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ„å»ºç±»ä¸­çš„å…¨é™å®šåå±æ€§</span></span><br><span class="line"><span class="keyword">val</span> propertySpecs = params.map &#123; param -&gt;</span><br><span class="line">    PropertySpec.builder(param.paramName, String::<span class="keyword">class</span>)</span><br><span class="line">        .addModifiers(KModifier.CONST)</span><br><span class="line">        .initializer(<span class="string">&quot;%S&quot;</span>, param.fqName)</span><br><span class="line">        .addKdoc(<span class="string">&quot;[<span class="subst">$&#123;param.fqName&#125;</span>]&quot;</span>)</span><br><span class="line">        .build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»º`HandlerFqName`ç±»</span></span><br><span class="line"><span class="keyword">val</span> type = TypeSpec.objectBuilder(CLASS_NAME)</span><br><span class="line">    .addKdoc(<span class="string">&quot;The class is automatic generated by Sword, don&#x27;t modify it.\n\n&quot;</span>)</span><br><span class="line">    .addKdoc(<span class="string">&quot;[<span class="subst">$&#123;mInvocationHandlerName&#125;</span>]å®ç°ç±»çš„å…¨é™å®šå&quot;</span>)</span><br><span class="line">    .addProperties(propertySpecs)</span><br><span class="line">    .build()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–åŒ…å</span></span><br><span class="line"><span class="keyword">val</span> pkg = env.options[PACKAGE_NAME_PARAM_NAME]</span><br><span class="line"><span class="keyword">val</span> packageName = <span class="keyword">if</span> (pkg.isNullOrEmpty()) &#123;</span><br><span class="line">    DEFAULT_PACKAGE_NAME</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pkg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»º`HandlerFqName`æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">val</span> fileBuilder = FileSpec.builder(packageName, FILE_NAME)</span><br><span class="line">    .addFileComment(<span class="string">&quot;The file is automatic generated by Sword, don&#x27;t modify it.&quot;</span>)</span><br><span class="line">    .addType(type)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç”Ÿæˆæ–‡ä»¶çš„ä¾èµ–å…³ç³»</span></span><br><span class="line"><span class="keyword">val</span> sources =</span><br><span class="line">    classDeclaration.map &#123; it.containingFile &#125;.filterNotNull().toList().toTypedArray()</span><br><span class="line"><span class="keyword">val</span> dependencies = Dependencies(<span class="literal">true</span>, *sources)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆç´¢å¼•ç±»</span></span><br><span class="line">fileBuilder.build().writeTo(codegen, dependencies)</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œé€šè¿‡ <code>KSP</code> ç”Ÿæˆç´¢å¼•ç±»å®Œæˆã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>æœ¬æ–‡ç®€å•è®°å½•äº† <code>Sword</code> çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°çš„é—®é¢˜ï¼Œæœ€åä½¿ç”¨ <code>KSP</code> è§£å†³é—®é¢˜çš„è¿‡ç¨‹ã€‚åœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œç¬”è€…å‚è€ƒ <code>EventBus</code> çš„å®ç°ï¼Œç»“åˆé—®é¢˜æœ¬èº«çš„é€»è¾‘ï¼Œå½¢æˆè‡ªå·±çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>é€šè¿‡è§£å†³è¿™ä¸ªé—®é¢˜çš„è¿‡ç¨‹ï¼Œç¬”è€…æ„Ÿå—åˆ°å­¦ä¹ å¼€æºé¡¹ç›®çš„é­…åŠ›ï¼Œå½“æˆ‘ä»¬é‡åˆ°é—®é¢˜æ—¶ï¼Œæˆ–è®¸å¼€æºé¡¹ç›®ä¹Ÿé‡åˆ°è¿‡ç±»ä¼¼é—®é¢˜å¹¶æœ‰æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆä¾›æˆ‘ä»¬å‚è€ƒã€‚</p>
<p>æœ€è¿‘ç¬”è€…å¯¹ <code>Sword</code> çš„åŠŸèƒ½å®ç°æœ‰æ–°çš„æƒ³æ³•ï¼šé€šè¿‡ <code>Kotlin IR</code> è¿›è¡Œå®ç°ã€‚</p>
<p>ç›®å‰è¿™åªæ˜¯ä¸€ä¸ªåˆæ­¥æƒ³æ³•ï¼Œç†è®ºä¸Šå®ç°èµ·æ¥åº”è¯¥æ¯”ä½¿ç”¨ <code>ASM</code> ç®€å•ä¸€äº›å§ï¼Œå¾…ç¬”è€…å®ç°åå†è®°å½•ä¸€ä¸‹å§ã€‚</p>
<p>ä¸‹ç¯‡å†è§ï¼Œhappy~</p>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>kotlin</tag>
      </tags>
  </entry>
</search>
